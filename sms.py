"""
School Management System
Version: 2.0.3
Build Date: November 11, 2025
Organization: Gaybeck Starkids School

A comprehensive school management system with AI-powered analytics.
Features: Student/Teacher Management, Attendance, Fees, Grading, Reports, AI Insights
         Enhanced Navigation with Arrow Key Scrolling Support

Copyright (c) 2024-2025 Gaybeck Starkids School. All rights reserved.
"""

__version__ = "2.0.3"
__build_date__ = "2025-11-11"
__author__ = "Gaybeck Starkids SMS Development Team"

import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import sqlite3
from datetime import datetime, date, timedelta
import calendar
import os
import sys
import shutil
import io
import csv
try:
    from tkcalendar import DateEntry
    CALENDAR_AVAILABLE = True
except ImportError:
    CALENDAR_AVAILABLE = False
try:
    from reportlab.lib.pagesizes import letter, A4
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.units import inch
    from reportlab.lib import colors
    PDF_AVAILABLE = True
except ImportError:
    PDF_AVAILABLE = False

# Check for PIL/Pillow (for image processing and logos)
try:
    from PIL import Image, ImageTk
    PIL_AVAILABLE = True
except ImportError:
    PIL_AVAILABLE = False

# Check for camera availability (requires both cv2 and PIL)
try:
    import cv2
    import threading
    if PIL_AVAILABLE:
        CAMERA_AVAILABLE = True
    else:
        CAMERA_AVAILABLE = False
except ImportError:
    CAMERA_AVAILABLE = False

# Import real-time sync manager
try:
    from realtime_sync import RealTimeSyncManager
    REALTIME_SYNC_AVAILABLE = True
except ImportError:
    REALTIME_SYNC_AVAILABLE = False
    class RealTimeSyncManager:
        def __init__(self, *args, **kwargs):
            pass
        def log_user_activity(self, *args, **kwargs):
            pass

# AI/ML imports
try:
    import numpy as np
    import pandas as pd
    from sklearn.ensemble import RandomForestClassifier, GradientBoostingRegressor
    from sklearn.model_selection import train_test_split
    from sklearn.preprocessing import LabelEncoder
    import warnings
    warnings.filterwarnings('ignore')
    AI_AVAILABLE = True
except ImportError:
    AI_AVAILABLE = False

# ==================== AI PREDICTOR CLASS ====================

class AIPredictor:
    """Offline AI/ML predictor for school management insights"""
    
    def __init__(self, db_connection):
        self.conn = db_connection
        self.cursor = db_connection.cursor()
        
    def predict_attendance_risk(self):
        """Predict students at risk of poor attendance"""
        try:
            if not AI_AVAILABLE:
                return []
            
            # Get historical attendance data
            query = """
                SELECT s.id, s.name, s.class_id,
                       COUNT(CASE WHEN a.present = 1 THEN 1 END) as days_present,
                       COUNT(a.id) as total_days,
                       CAST(COUNT(CASE WHEN a.present = 1 THEN 1 END) AS FLOAT) / 
                       NULLIF(COUNT(a.id), 0) * 100 as attendance_rate
                FROM students s
                LEFT JOIN attendance a ON s.id = a.student_id
                WHERE s.status = 'Active'
                GROUP BY s.id
                HAVING total_days > 5
            """
            
            self.cursor.execute(query)
            results = self.cursor.fetchall()
            
            at_risk_students = []
            for row in results:
                student_id, name, class_id, days_present, total_days, attendance_rate = row
                
                # Simple rule-based prediction
                if attendance_rate < 75:
                    risk_level = 'High'
                elif attendance_rate < 85:
                    risk_level = 'Medium'
                else:
                    risk_level = 'Low'
                
                if risk_level in ['High', 'Medium']:
                    at_risk_students.append({
                        'id': student_id,
                        'name': name,
                        'attendance_rate': round(attendance_rate, 1),
                        'risk_level': risk_level,
                        'days_present': days_present,
                        'total_days': total_days
                    })
            
            # Sort by attendance rate (lowest first)
            at_risk_students.sort(key=lambda x: x['attendance_rate'])
            return at_risk_students
            
        except Exception as e:
            print(f"Attendance prediction error: {e}")
            return []
    
    def predict_fee_payment_risk(self):
        """Predict students at risk of fee payment default"""
        try:
            if not AI_AVAILABLE:
                return []
            
            # Get fee payment history
            query = """
                SELECT s.id, s.name, s.class_id,
                       COUNT(f.id) as total_fees,
                       SUM(CASE WHEN f.amount_paid >= f.amount_due THEN 1 ELSE 0 END) as paid_count,
                       SUM(f.arrears) as total_arrears,
                       AVG(CASE WHEN f.amount_due > 0 THEN 
                           (f.amount_paid * 100.0 / f.amount_due) ELSE 100 END) as avg_payment_rate
                FROM students s
                LEFT JOIN fees f ON s.id = f.student_id
                WHERE s.status = 'Active'
                GROUP BY s.id
                HAVING total_fees > 0
            """
            
            self.cursor.execute(query)
            results = self.cursor.fetchall()
            
            at_risk_students = []
            for row in results:
                student_id, name, class_id, total_fees, paid_count, total_arrears, avg_payment_rate = row
                
                total_arrears = total_arrears or 0
                avg_payment_rate = avg_payment_rate or 0
                
                # Rule-based risk assessment
                if total_arrears > 500 or avg_payment_rate < 50:
                    risk_level = 'High'
                elif total_arrears > 200 or avg_payment_rate < 75:
                    risk_level = 'Medium'
                else:
                    risk_level = 'Low'
                
                if risk_level in ['High', 'Medium']:
                    at_risk_students.append({
                        'id': student_id,
                        'name': name,
                        'arrears': round(total_arrears, 2),
                        'payment_rate': round(avg_payment_rate, 1),
                        'risk_level': risk_level
                    })
            
            # Sort by arrears (highest first)
            at_risk_students.sort(key=lambda x: x['arrears'], reverse=True)
            return at_risk_students
            
        except Exception as e:
            print(f"Fee payment prediction error: {e}")
            return []
    
    def generate_insights(self):
        """Generate AI-powered insights and recommendations"""
        insights = []
        
        try:
            # Attendance insights
            self.cursor.execute("""
                SELECT AVG(CASE WHEN present = 1 THEN 100.0 ELSE 0.0 END) as avg_attendance
                FROM attendance
                WHERE date >= date('now', '-30 days')
            """)
            result = self.cursor.fetchone()
            avg_attendance = result[0] if result and result[0] else 0
            
            if avg_attendance < 80:
                insights.append({
                    'type': 'warning',
                    'category': 'Attendance',
                    'title': 'Low Overall Attendance',
                    'message': f'School attendance is at {avg_attendance:.1f}%. Consider attendance improvement programs.',
                    'priority': 'High'
                })
            
            # Fee collection insights
            self.cursor.execute("""
                SELECT 
                    SUM(arrears) as total_arrears,
                    COUNT(DISTINCT student_id) as students_with_arrears
                FROM fees
                WHERE arrears > 0
            """)
            result = self.cursor.fetchone()
            total_arrears, students_with_arrears = result if result else (0, 0)
            
            if total_arrears and total_arrears > 1000:
                insights.append({
                    'type': 'info',
                    'category': 'Finance',
                    'title': 'Outstanding Fees',
                    'message': f'GHS {total_arrears:.2f} in arrears from {students_with_arrears} students. Consider payment plans.',
                    'priority': 'Medium'
                })
            
            # Class size insights
            self.cursor.execute("""
                SELECT c.class_name, COUNT(s.id) as student_count
                FROM classes c
                LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
                GROUP BY c.id
                HAVING student_count > 40 OR student_count < 10
            """)
            class_results = self.cursor.fetchall()
            
            for class_name, count in class_results:
                if count > 40:
                    insights.append({
                        'type': 'warning',
                        'category': 'Class Management',
                        'title': f'Overcrowded Class: {class_name}',
                        'message': f'{count} students. Consider splitting into smaller sections.',
                        'priority': 'Medium'
                    })
                elif count < 10:
                    insights.append({
                        'type': 'info',
                        'category': 'Class Management',
                        'title': f'Small Class Size: {class_name}',
                        'message': f'Only {count} students. Consider combining with another class.',
                        'priority': 'Low'
                    })
            
            # Recent trends
            self.cursor.execute("""
                SELECT COUNT(*) as new_students
                FROM students
                WHERE date_of_admission >= date('now', '-30 days')
            """)
            result = self.cursor.fetchone()
            new_students = result[0] if result else 0
            
            if new_students > 10:
                insights.append({
                    'type': 'success',
                    'category': 'Growth',
                    'title': 'Enrollment Growth',
                    'message': f'{new_students} new students admitted in the last 30 days.',
                    'priority': 'Low'
                })
            
            return insights
            
        except Exception as e:
            print(f"Insights generation error: {e}")
            return insights
    
    def get_student_performance_summary(self, student_id):
        """Get AI summary of student performance"""
        try:
            summary = {
                'attendance': 'N/A',
                'fees': 'N/A',
                'overall_status': 'Good'
            }
            
            # Attendance performance
            self.cursor.execute("""
                SELECT 
                    COUNT(CASE WHEN present = 1 THEN 1 END) * 100.0 / COUNT(*) as rate
                FROM attendance
                WHERE student_id = ?
            """, (student_id,))
            result = self.cursor.fetchone()
            if result and result[0]:
                rate = result[0]
                summary['attendance'] = f'{rate:.1f}%'
                if rate < 75:
                    summary['overall_status'] = 'Needs Attention'
            
            # Fee payment status
            self.cursor.execute("""
                SELECT SUM(arrears) as total_arrears
                FROM fees
                WHERE student_id = ?
            """, (student_id,))
            result = self.cursor.fetchone()
            if result and result[0]:
                arrears = result[0]
                summary['fees'] = f'GHS {arrears:.2f} arrears'
                if arrears > 200:
                    summary['overall_status'] = 'Needs Attention'
            else:
                summary['fees'] = 'Up to date'
            
            return summary
            
        except Exception as e:
            print(f"Performance summary error: {e}")
            return summary
    
    def generate_class_report(self, class_id):
        """Generate comprehensive AI-powered class report"""
        try:
            report = {
                'class_info': {},
                'attendance_summary': {},
                'fee_summary': {},
                'student_performance': [],
                'recommendations': []
            }
            
            # Get class information
            self.cursor.execute("""
                SELECT c.class_name, c.capacity, COUNT(s.id) as student_count,
                       t.name as teacher_name
                FROM classes c
                LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
                LEFT JOIN teachers t ON c.class_teacher_id = t.id
                WHERE c.id = ?
                GROUP BY c.id
            """, (class_id,))
            class_info = self.cursor.fetchone()
            
            if class_info:
                report['class_info'] = {
                    'name': class_info[0],
                    'capacity': class_info[1],
                    'student_count': class_info[2],
                    'teacher': class_info[3] or 'Not assigned'
                }
            
            # Attendance summary
            self.cursor.execute("""
                SELECT 
                    COUNT(DISTINCT a.student_id) as students_tracked,
                    AVG(CASE WHEN a.present = 1 THEN 100.0 ELSE 0.0 END) as avg_attendance,
                    COUNT(CASE WHEN a.present = 1 THEN 1 END) as total_present,
                    COUNT(a.id) as total_records
                FROM attendance a
                JOIN students s ON a.student_id = s.id
                WHERE s.class_id = ? AND s.status = 'Active'
                AND a.date >= date('now', '-30 days')
            """, (class_id,))
            att_result = self.cursor.fetchone()
            
            if att_result:
                report['attendance_summary'] = {
                    'students_tracked': att_result[0] or 0,
                    'average_rate': round(att_result[1] or 0, 1),
                    'total_present': att_result[2] or 0,
                    'total_records': att_result[3] or 0
                }
            
            # Fee summary
            self.cursor.execute("""
                SELECT 
                    SUM(f.amount_due) as total_due,
                    SUM(f.amount_paid) as total_paid,
                    SUM(f.arrears) as total_arrears,
                    COUNT(DISTINCT f.student_id) as students_with_fees
                FROM fees f
                JOIN students s ON f.student_id = s.id
                WHERE s.class_id = ? AND s.status = 'Active'
            """, (class_id,))
            fee_result = self.cursor.fetchone()
            
            if fee_result:
                total_due = fee_result[0] or 0
                total_paid = fee_result[1] or 0
                collection_rate = (total_paid / total_due * 100) if total_due > 0 else 0
                
                report['fee_summary'] = {
                    'total_due': round(total_due, 2),
                    'total_paid': round(total_paid, 2),
                    'total_arrears': round(fee_result[2] or 0, 2),
                    'collection_rate': round(collection_rate, 1),
                    'students_with_fees': fee_result[3] or 0
                }
            
            # Individual student performance
            self.cursor.execute("""
                SELECT s.id, s.name, s.student_id
                FROM students s
                WHERE s.class_id = ? AND s.status = 'Active'
                ORDER BY s.name
                LIMIT 20
            """, (class_id,))
            students = self.cursor.fetchall()
            
            for student in students:
                summary = self.get_student_performance_summary(student[0])
                report['student_performance'].append({
                    'id': student[0],
                    'name': student[1],
                    'student_id': student[2],
                    'attendance': summary['attendance'],
                    'fees': summary['fees'],
                    'status': summary['overall_status']
                })
            
            # Generate AI recommendations
            report['recommendations'] = self._generate_class_recommendations(report)
            
            return report
            
        except Exception as e:
            print(f"Class report generation error: {e}")
            return None
    
    def _generate_class_recommendations(self, report):
        """Generate AI recommendations based on class data"""
        recommendations = []
        
        # Attendance recommendations
        if 'attendance_summary' in report:
            avg_att = report['attendance_summary'].get('average_rate', 0)
            if avg_att < 75:
                recommendations.append({
                    'priority': 'High',
                    'category': 'Attendance',
                    'issue': f'Low class attendance at {avg_att}%',
                    'recommendation': 'Implement attendance improvement strategies: parent meetings, incentive programs, or investigate underlying issues.'
                })
            elif avg_att < 85:
                recommendations.append({
                    'priority': 'Medium',
                    'category': 'Attendance',
                    'issue': f'Moderate attendance at {avg_att}%',
                    'recommendation': 'Monitor attendance trends and provide early intervention for at-risk students.'
                })
        
        # Fee collection recommendations
        if 'fee_summary' in report:
            collection_rate = report['fee_summary'].get('collection_rate', 0)
            arrears = report['fee_summary'].get('total_arrears', 0)
            
            if collection_rate < 70:
                recommendations.append({
                    'priority': 'High',
                    'category': 'Finance',
                    'issue': f'Low fee collection rate at {collection_rate}%',
                    'recommendation': 'Urgent: Contact parents with outstanding fees. Consider payment plans or financial assistance programs.'
                })
            
            if arrears > 1000:
                recommendations.append({
                    'priority': 'Medium',
                    'category': 'Finance',
                    'issue': f'GHS {arrears:.2f} in total arrears',
                    'recommendation': 'Schedule meetings with parents of students with high arrears. Offer flexible payment options.'
                })
        
        # Class size recommendations
        if 'class_info' in report:
            count = report['class_info'].get('student_count', 0)
            capacity = report['class_info'].get('capacity', 30)
            
            if count > capacity:
                recommendations.append({
                    'priority': 'Medium',
                    'category': 'Class Management',
                    'issue': f'Class overcrowded: {count}/{capacity} students',
                    'recommendation': 'Consider splitting class or increasing capacity. Large classes may affect learning quality.'
                })
            elif count < 10:
                recommendations.append({
                    'priority': 'Low',
                    'category': 'Class Management',
                    'issue': f'Small class size: {count} students',
                    'recommendation': 'Consider combining with another class to optimize resources and improve peer learning.'
                })
        
        # Student performance recommendations
        if 'student_performance' in report:
            needs_attention = [s for s in report['student_performance'] if s['status'] == 'Needs Attention']
            if len(needs_attention) > 3:
                recommendations.append({
                    'priority': 'High',
                    'category': 'Student Support',
                    'issue': f'{len(needs_attention)} students need attention',
                    'recommendation': 'Schedule individual meetings with struggling students and their parents. Provide additional support and resources.'
                })
        
        return recommendations
    
    def generate_student_report(self, student_id):
        """Generate detailed AI-powered student report"""
        try:
            report = {
                'student_id': student_id,  # Add database ID for advanced analytics
                'student_info': {},
                'attendance_details': {},
                'fee_details': {},
                'behavior_summary': '',
                'recommendations': []
            }
            
            # Student info
            self.cursor.execute("""
                SELECT s.name, s.student_id, s.date_of_birth, s.gender,
                       c.class_name, s.date_of_admission, s.phone, s.address
                FROM students s
                LEFT JOIN classes c ON s.class_id = c.id
                WHERE s.id = ?
            """, (student_id,))
            student_info = self.cursor.fetchone()
            
            if student_info:
                report['student_info'] = {
                    'name': student_info[0],
                    'student_id': student_info[1],
                    'dob': student_info[2],
                    'gender': student_info[3],
                    'class': student_info[4] or 'Not assigned',
                    'admission_date': student_info[5],
                    'phone': student_info[6],
                    'address': student_info[7]
                }
            
            # Detailed attendance
            self.cursor.execute("""
                SELECT 
                    COUNT(*) as total_days,
                    COUNT(CASE WHEN present = 1 THEN 1 END) as days_present,
                    COUNT(CASE WHEN present = 0 THEN 1 END) as days_absent,
                    COUNT(CASE WHEN present = 1 THEN 1 END) * 100.0 / COUNT(*) as attendance_rate
                FROM attendance
                WHERE student_id = ?
            """, (student_id,))
            att_result = self.cursor.fetchone()
            
            if att_result and att_result[0] > 0:
                report['attendance_details'] = {
                    'total_days': att_result[0],
                    'days_present': att_result[1],
                    'days_absent': att_result[2],
                    'attendance_rate': round(att_result[3], 1)
                }
            
            # Fee details
            self.cursor.execute("""
                SELECT 
                    SUM(amount_due) as total_due,
                    SUM(amount_paid) as total_paid,
                    SUM(arrears) as total_arrears,
                    COUNT(*) as fee_records
                FROM fees
                WHERE student_id = ?
            """, (student_id,))
            fee_result = self.cursor.fetchone()
            
            if fee_result:
                report['fee_details'] = {
                    'total_due': round(fee_result[0] or 0, 2),
                    'total_paid': round(fee_result[1] or 0, 2),
                    'total_arrears': round(fee_result[2] or 0, 2),
                    'fee_records': fee_result[3] or 0
                }
            
            # Generate behavior summary and recommendations
            report['recommendations'] = self._generate_student_recommendations(report)
            report['behavior_summary'] = self._generate_behavior_summary(report)
            
            return report
            
        except Exception as e:
            print(f"Student report generation error: {e}")
            return None
    
    def _generate_behavior_summary(self, report):
        """Generate AI behavior summary"""
        summary_parts = []
        
        if 'attendance_details' in report and report['attendance_details']:
            rate = report['attendance_details'].get('attendance_rate', 0)
            if rate >= 95:
                summary_parts.append("Excellent attendance record demonstrating strong commitment.")
            elif rate >= 85:
                summary_parts.append("Good attendance with room for improvement.")
            elif rate >= 75:
                summary_parts.append("Attendance needs attention. Regular absences may affect learning.")
            else:
                summary_parts.append("Poor attendance is a serious concern requiring immediate intervention.")
        
        if 'fee_details' in report and report['fee_details']:
            arrears = report['fee_details'].get('total_arrears', 0)
            if arrears == 0:
                summary_parts.append("Fee payments are up to date.")
            elif arrears < 100:
                summary_parts.append("Minor fee arrears to be cleared soon.")
            else:
                summary_parts.append(f"Significant fee arrears (GHS {arrears:.2f}) require urgent attention.")
        
        return " ".join(summary_parts) if summary_parts else "Insufficient data for behavior analysis."
    
    def _generate_student_recommendations(self, report):
        """Generate personalized student recommendations"""
        recommendations = []
        
        # Attendance-based recommendations
        if 'attendance_details' in report and report['attendance_details']:
            rate = report['attendance_details'].get('attendance_rate', 0)
            if rate < 75:
                recommendations.append({
                    'priority': 'High',
                    'area': 'Attendance',
                    'recommendation': 'Schedule urgent parent meeting to discuss attendance issues. Identify barriers and create improvement plan.'
                })
            elif rate < 85:
                recommendations.append({
                    'priority': 'Medium',
                    'area': 'Attendance',
                    'recommendation': 'Monitor attendance closely and provide early intervention if pattern continues.'
                })
        
        # Fee-based recommendations
        if 'fee_details' in report and report['fee_details']:
            arrears = report['fee_details'].get('total_arrears', 0)
            if arrears > 200:
                recommendations.append({
                    'priority': 'High',
                    'area': 'Finance',
                    'recommendation': f'Contact parents about GHS {arrears:.2f} outstanding fees. Discuss payment plan options.'
                })
            elif arrears > 50:
                recommendations.append({
                    'priority': 'Medium',
                    'area': 'Finance',
                    'recommendation': 'Send payment reminder to parents. Offer assistance if financial hardship exists.'
                })
        
        return recommendations
    
    def analyze_student_trends(self, student_id, days=30):
        """Analyze student attendance and fee payment trends over time"""
        try:
            trends = {
                'attendance_trend': 'stable',
                'attendance_direction': 'neutral',
                'fee_trend': 'stable',
                'recent_absences': [],
                'trend_analysis': ''
            }
            
            # Get attendance trend
            self.cursor.execute("""
                SELECT date, present
                FROM attendance
                WHERE student_id = ? AND date >= date('now', '-' || ? || ' days')
                ORDER BY date DESC
            """, (student_id, days))
            
            attendance_records = self.cursor.fetchall()
            
            if len(attendance_records) >= 10:
                # Split into two halves for trend comparison
                mid = len(attendance_records) // 2
                recent_half = attendance_records[:mid]
                older_half = attendance_records[mid:]
                
                recent_rate = sum(1 for _, present in recent_half if present) / len(recent_half) * 100
                older_rate = sum(1 for _, present in older_half if present) / len(older_half) * 100
                
                if recent_rate > older_rate + 10:
                    trends['attendance_trend'] = 'improving'
                    trends['attendance_direction'] = 'up'
                elif recent_rate < older_rate - 10:
                    trends['attendance_trend'] = 'declining'
                    trends['attendance_direction'] = 'down'
                
                # Get recent absences
                trends['recent_absences'] = [date for date, present in attendance_records[:10] if not present]
            
            # Get fee payment trend
            self.cursor.execute("""
                SELECT month, year, arrears
                FROM fees
                WHERE student_id = ?
                ORDER BY year DESC, 
                    CASE month
                        WHEN 'January' THEN 1 WHEN 'February' THEN 2 WHEN 'March' THEN 3
                        WHEN 'April' THEN 4 WHEN 'May' THEN 5 WHEN 'June' THEN 6
                        WHEN 'July' THEN 7 WHEN 'August' THEN 8 WHEN 'September' THEN 9
                        WHEN 'October' THEN 10 WHEN 'November' THEN 11 WHEN 'December' THEN 12
                    END DESC
                LIMIT 6
            """, (student_id,))
            
            fee_records = self.cursor.fetchall()
            
            if len(fee_records) >= 4:
                recent_arrears = sum(arrears for _, _, arrears in fee_records[:2]) / 2
                older_arrears = sum(arrears for _, _, arrears in fee_records[2:4]) / 2
                
                if recent_arrears < older_arrears - 50:
                    trends['fee_trend'] = 'improving'
                elif recent_arrears > older_arrears + 50:
                    trends['fee_trend'] = 'worsening'
            
            # Generate trend analysis text
            trend_parts = []
            
            if trends['attendance_trend'] == 'improving':
                trend_parts.append("📈 Attendance is improving - positive trend!")
            elif trends['attendance_trend'] == 'declining':
                trend_parts.append("📉 Attendance is declining - requires attention")
            else:
                trend_parts.append("➝ Attendance is stable")
            
            if trends['fee_trend'] == 'improving':
                trend_parts.append("Payment situation is improving")
            elif trends['fee_trend'] == 'worsening':
                trend_parts.append("Payment arrears are increasing")
            
            trends['trend_analysis'] = ". ".join(trend_parts) + "."
            
            return trends
            
        except Exception as e:
            print(f"Trend analysis error: {e}")
            return trends
    
    def compare_student_to_class(self, student_id):
        """Compare student performance to class averages"""
        try:
            comparison = {
                'student_attendance': 0,
                'class_avg_attendance': 0,
                'student_rank': 'N/A',
                'percentile': 0,
                'comparison_text': ''
            }
            
            # Get student's class
            self.cursor.execute("SELECT class_id FROM students WHERE id = ?", (student_id,))
            result = self.cursor.fetchone()
            if not result or not result[0]:
                return comparison
            
            class_id = result[0]
            
            # Get student attendance rate
            self.cursor.execute("""
                SELECT COUNT(CASE WHEN present = 1 THEN 1 END) * 100.0 / COUNT(*)
                FROM attendance
                WHERE student_id = ?
            """, (student_id,))
            result = self.cursor.fetchone()
            student_attendance = result[0] if result and result[0] else 0
            comparison['student_attendance'] = round(student_attendance, 1)
            
            # Get class average
            self.cursor.execute("""
                SELECT AVG(att_rate) FROM (
                    SELECT student_id, COUNT(CASE WHEN present = 1 THEN 1 END) * 100.0 / COUNT(*) as att_rate
                    FROM attendance a
                    JOIN students s ON a.student_id = s.id
                    WHERE s.class_id = ?
                    GROUP BY student_id
                )
            """, (class_id,))
            result = self.cursor.fetchone()
            class_avg = result[0] if result and result[0] else 0
            comparison['class_avg_attendance'] = round(class_avg, 1)
            
            # Calculate ranking
            self.cursor.execute("""
                SELECT student_id, COUNT(CASE WHEN present = 1 THEN 1 END) * 100.0 / COUNT(*) as att_rate
                FROM attendance a
                JOIN students s ON a.student_id = s.id
                WHERE s.class_id = ?
                GROUP BY student_id
                ORDER BY att_rate DESC
            """, (class_id,))
            
            rankings = self.cursor.fetchall()
            total_students = len(rankings)
            
            for idx, (sid, rate) in enumerate(rankings, 1):
                if sid == student_id:
                    comparison['student_rank'] = f"{idx} of {total_students}"
                    comparison['percentile'] = round((total_students - idx + 1) / total_students * 100, 1)
                    break
            
            # Generate comparison text
            if student_attendance > class_avg + 10:
                comparison['comparison_text'] = f"⭐ Excellent! Student performs {student_attendance - class_avg:.1f}% above class average"
            elif student_attendance > class_avg:
                comparison['comparison_text'] = f"✓ Good! Student performs above class average"
            elif student_attendance > class_avg - 10:
                comparison['comparison_text'] = f"➝ Student performs near class average"
            else:
                comparison['comparison_text'] = f"⚠️ Attention needed! Student performs {class_avg - student_attendance:.1f}% below class average"
            
            return comparison
            
        except Exception as e:
            print(f"Comparison analysis error: {e}")
            return comparison
    
    def identify_patterns(self, student_id):
        """Identify patterns in student behavior"""
        try:
            patterns = {
                'absence_days': {},
                'frequent_absence_day': None,
                'absence_pattern': 'No clear pattern',
                'payment_pattern': 'Regular',
                'behavioral_insights': []
            }
            
            # Analyze day-of-week attendance patterns
            self.cursor.execute("""
                SELECT 
                    CASE CAST(strftime('%w', date) AS INTEGER)
                        WHEN 0 THEN 'Sunday'
                        WHEN 1 THEN 'Monday'
                        WHEN 2 THEN 'Tuesday'
                        WHEN 3 THEN 'Wednesday'
                        WHEN 4 THEN 'Thursday'
                        WHEN 5 THEN 'Friday'
                        WHEN 6 THEN 'Saturday'
                    END as day_name,
                    COUNT(CASE WHEN present = 0 THEN 1 END) as absences,
                    COUNT(*) as total
                FROM attendance
                WHERE student_id = ?
                GROUP BY CAST(strftime('%w', date) AS INTEGER)
                ORDER BY absences DESC
            """, (student_id,))
            
            day_results = self.cursor.fetchall()
            
            if day_results:
                for day, absences, total in day_results:
                    if total > 0:
                        patterns['absence_days'][day] = {
                            'count': absences,
                            'rate': round(absences / total * 100, 1)
                        }
                
                # Find most frequent absence day
                if day_results[0][1] > 2:  # At least 3 absences
                    patterns['frequent_absence_day'] = day_results[0][0]
                    patterns['absence_pattern'] = f"Frequent absences on {day_results[0][0]}s ({day_results[0][1]} times)"
            
            # Analyze payment patterns
            self.cursor.execute("""
                SELECT 
                    COUNT(CASE WHEN amount_paid >= amount_due THEN 1 END) as on_time,
                    COUNT(CASE WHEN amount_paid < amount_due AND arrears > 0 THEN 1 END) as late,
                    COUNT(*) as total
                FROM fees
                WHERE student_id = ?
            """, (student_id,))
            
            payment_result = self.cursor.fetchone()
            
            if payment_result and payment_result[2] > 0:
                on_time, late, total = payment_result
                on_time_rate = on_time / total * 100
                
                if on_time_rate >= 90:
                    patterns['payment_pattern'] = 'Excellent - Always on time'
                elif on_time_rate >= 70:
                    patterns['payment_pattern'] = 'Good - Mostly on time'
                elif on_time_rate >= 50:
                    patterns['payment_pattern'] = 'Fair - Often late'
                else:
                    patterns['payment_pattern'] = 'Poor - Frequently late'
            
            # Generate behavioral insights
            if patterns['frequent_absence_day']:
                patterns['behavioral_insights'].append({
                    'type': 'warning',
                    'insight': f"Student tends to be absent on {patterns['frequent_absence_day']}s. Investigate possible reasons."
                })
            
            # Check for consecutive absences
            self.cursor.execute("""
                SELECT date, present
                FROM attendance
                WHERE student_id = ?
                ORDER BY date DESC
                LIMIT 30
            """, (student_id,))
            
            consecutive_absences = 0
            max_consecutive = 0
            
            for date, present in self.cursor.fetchall():
                if not present:
                    consecutive_absences += 1
                    max_consecutive = max(max_consecutive, consecutive_absences)
                else:
                    consecutive_absences = 0
            
            if max_consecutive >= 3:
                patterns['behavioral_insights'].append({
                    'type': 'warning',
                    'insight': f"Student had {max_consecutive} consecutive absences recently. Monitor for chronic absenteeism."
                })
            
            if patterns['payment_pattern'].startswith('Poor'):
                patterns['behavioral_insights'].append({
                    'type': 'info',
                    'insight': 'Consistent late payments may indicate financial difficulties. Consider offering payment plan.'
                })
            
            return patterns
            
        except Exception as e:
            print(f"Pattern identification error: {e}")
            return patterns
    
    def predict_student_risk_score(self, student_id):
        """Calculate comprehensive risk score for student"""
        try:
            risk_score = {
                'overall_score': 0,
                'risk_level': 'Low',
                'risk_factors': [],
                'protective_factors': [],
                'recommendation': ''
            }
            
            score = 0
            
            # Attendance risk (0-40 points)
            self.cursor.execute("""
                SELECT COUNT(CASE WHEN present = 1 THEN 1 END) * 100.0 / COUNT(*)
                FROM attendance WHERE student_id = ?
            """, (student_id,))
            result = self.cursor.fetchone()
            attendance_rate = result[0] if result and result[0] else 100
            
            if attendance_rate < 70:
                score += 40
                risk_score['risk_factors'].append("Very low attendance rate")
            elif attendance_rate < 85:
                score += 25
                risk_score['risk_factors'].append("Below average attendance")
            elif attendance_rate >= 95:
                risk_score['protective_factors'].append("Excellent attendance record")
            
            # Fee payment risk (0-30 points)
            self.cursor.execute("""
                SELECT SUM(arrears) FROM fees WHERE student_id = ?
            """, (student_id,))
            result = self.cursor.fetchone()
            arrears = result[0] if result and result[0] else 0
            
            if arrears > 500:
                score += 30
                risk_score['risk_factors'].append("High fee arrears")
            elif arrears > 200:
                score += 20
                risk_score['risk_factors'].append("Moderate fee arrears")
            elif arrears == 0:
                risk_score['protective_factors'].append("No outstanding fees")
            
            # Trend risk (0-20 points)
            trends = self.analyze_student_trends(student_id)
            if trends['attendance_trend'] == 'declining':
                score += 20
                risk_score['risk_factors'].append("Declining attendance trend")
            elif trends['attendance_trend'] == 'improving':
                risk_score['protective_factors'].append("Improving attendance trend")
            
            if trends['fee_trend'] == 'worsening':
                score += 10
                risk_score['risk_factors'].append("Increasing payment arrears")
            
            # Pattern risk (0-10 points)
            patterns = self.identify_patterns(student_id)
            if patterns['frequent_absence_day']:
                score += 10
                risk_score['risk_factors'].append("Recurring absence pattern")
            
            # Calculate final score and level
            risk_score['overall_score'] = min(score, 100)
            
            if score >= 70:
                risk_score['risk_level'] = 'High'
                risk_score['recommendation'] = 'Urgent intervention required. Schedule immediate meeting with parents and student.'
            elif score >= 40:
                risk_score['risk_level'] = 'Medium'
                risk_score['recommendation'] = 'Monitor closely and provide support. Consider early intervention programs.'
            else:
                risk_score['risk_level'] = 'Low'
                risk_score['recommendation'] = 'Student is performing well. Continue current support level.'
            
            return risk_score
            
        except Exception as e:
            print(f"Risk score calculation error: {e}")
            return risk_score
    
    def generate_class_analytics(self, class_id):
        """Generate advanced analytics for entire class"""
        try:
            analytics = {
                'top_performers': [],
                'at_risk_students': [],
                'class_trends': {},
                'improvement_areas': [],
                'strengths': []
            }
            
            # Get top performers (top 20% by attendance)
            self.cursor.execute("""
                SELECT s.id, s.name, 
                       COUNT(CASE WHEN a.present = 1 THEN 1 END) * 100.0 / COUNT(a.id) as att_rate
                FROM students s
                LEFT JOIN attendance a ON s.id = a.student_id
                WHERE s.class_id = ? AND s.status = 'Active'
                GROUP BY s.id
                HAVING COUNT(a.id) > 0
                ORDER BY att_rate DESC
                LIMIT 5
            """, (class_id,))
            
            top_performers = self.cursor.fetchall()
            for sid, name, rate in top_performers:
                if rate >= 90:
                    analytics['top_performers'].append({
                        'id': sid,
                        'name': name,
                        'attendance_rate': round(rate, 1)
                    })
            
            # Get at-risk students
            self.cursor.execute("""
                SELECT s.id, s.name
                FROM students s
                WHERE s.class_id = ? AND s.status = 'Active'
            """, (class_id,))
            
            students = self.cursor.fetchall()
            for sid, name in students:
                risk = self.predict_student_risk_score(sid)
                if risk['risk_level'] in ['High', 'Medium']:
                    analytics['at_risk_students'].append({
                        'id': sid,
                        'name': name,
                        'risk_level': risk['risk_level'],
                        'risk_score': risk['overall_score']
                    })
            
            # Sort by risk score
            analytics['at_risk_students'].sort(key=lambda x: x['risk_score'], reverse=True)
            
            # Identify strengths and improvement areas
            self.cursor.execute("""
                SELECT AVG(CASE WHEN a.present = 1 THEN 100.0 ELSE 0.0 END) as avg_att
                FROM attendance a
                JOIN students s ON a.student_id = s.id
                WHERE s.class_id = ?
            """, (class_id,))
            result = self.cursor.fetchone()
            avg_att = result[0] if result and result[0] else 0
            
            if avg_att >= 90:
                analytics['strengths'].append("Excellent overall class attendance")
            elif avg_att < 75:
                analytics['improvement_areas'].append("Low class attendance needs urgent attention")
            
            # Fee collection analysis
            self.cursor.execute("""
                SELECT 
                    SUM(f.amount_due) as total_due,
                    SUM(f.amount_paid) as total_paid
                FROM fees f
                JOIN students s ON f.student_id = s.id
                WHERE s.class_id = ?
            """, (class_id,))
            result = self.cursor.fetchone()
            
            if result and result[0]:
                collection_rate = (result[1] / result[0] * 100) if result[0] > 0 else 0
                if collection_rate >= 90:
                    analytics['strengths'].append("Excellent fee collection rate")
                elif collection_rate < 70:
                    analytics['improvement_areas'].append("Poor fee collection needs improvement")
            
            return analytics
            
        except Exception as e:
            print(f"Class analytics error: {e}")
            return analytics

# ==================== RESPONSIVE DESIGN UTILITIES ====================

class ResponsiveManager:
    """Manages responsive design calculations for different screen sizes"""
    
    @staticmethod
    def get_screen_info():
        """Get screen dimensions"""
        root = tk.Tk()
        root.withdraw()
        screen_width = root.winfo_screenwidth()
        screen_height = root.winfo_screenheight()
        root.destroy()
        return screen_width, screen_height
    
    @staticmethod
    def calculate_window_size(base_width, base_height, min_width=None, min_height=None, 
                             max_width=None, max_height=None, scale_factor=0.8):
        """
        Calculate responsive window size based on screen dimensions
        
        Args:
            base_width: Desired width for standard screens
            base_height: Desired height for standard screens
            min_width: Minimum allowed width
            min_height: Minimum allowed height
            max_width: Maximum allowed width
            max_height: Maximum allowed height
            scale_factor: Max percentage of screen to use (default 0.8 = 80%)
        
        Returns:
            Tuple of (width, height)
        """
        root = tk.Tk()
        root.withdraw()
        screen_width = root.winfo_screenwidth()
        screen_height = root.winfo_screenheight()
        root.destroy()
        
        # Calculate maximum dimensions based on screen size
        max_avail_width = int(screen_width * scale_factor)
        max_avail_height = int(screen_height * scale_factor)
        
        # Start with base dimensions
        width = base_width
        height = base_height
        
        # Apply screen-based scaling for very large or small screens
        if screen_width < 1366:  # Small screens (laptops, tablets)
            width = int(base_width * 0.85)
            height = int(base_height * 0.85)
        elif screen_width >= 1920:  # Large screens (Full HD and above)
            width = int(base_width * 1.1)
            height = int(base_height * 1.1)
        
        # Ensure we don't exceed available screen space
        width = min(width, max_avail_width)
        height = min(height, max_avail_height)
        
        # Apply minimum constraints
        if min_width:
            width = max(width, min_width)
        if min_height:
            height = max(height, min_height)
        
        # Apply maximum constraints
        if max_width:
            width = min(width, max_width)
        if max_height:
            height = min(height, max_height)
        
        return width, height
    
    @staticmethod
    def get_font_scale():
        """Get font scale factor based on screen DPI and size"""
        root = tk.Tk()
        root.withdraw()
        screen_width = root.winfo_screenwidth()
        screen_height = root.winfo_screenheight()
        root.destroy()
        
        # Base font scale on screen resolution
        if screen_width < 1366:
            return 0.9  # Slightly smaller fonts for small screens
        elif screen_width >= 1920:
            return 1.1  # Slightly larger fonts for large screens
        else:
            return 1.0  # Standard size
    
    @staticmethod
    def scale_font_size(base_size):
        """Scale font size based on screen resolution"""
        scale = ResponsiveManager.get_font_scale()
        return int(base_size * scale)
    
    @staticmethod
    def get_padding_scale():
        """Get padding scale factor based on screen size"""
        root = tk.Tk()
        root.withdraw()
        screen_width = root.winfo_screenwidth()
        root.destroy()
        
        if screen_width < 1366:
            return 0.8  # Reduced padding for small screens
        elif screen_width >= 1920:
            return 1.2  # Increased padding for large screens
        else:
            return 1.0  # Standard padding
    
    @staticmethod
    def scale_padding(base_padding):
        """Scale padding value based on screen size"""
        scale = ResponsiveManager.get_padding_scale()
        return int(base_padding * scale)

# ==================== END RESPONSIVE DESIGN UTILITIES ====================

class ScrollableFrame(tk.Frame):
    """A scrollable frame that can be used to make any content scrollable with mouse wheel support"""
    
    def __init__(self, parent, *args, always_show_scrollbar=False, **kwargs):
        tk.Frame.__init__(self, parent, *args, **kwargs)
        self.configure(relief=tk.FLAT, bd=0)
        
        # Store configuration
        self.always_show_scrollbar = always_show_scrollbar
        
        # Get background color from kwargs or use default
        bg_color = kwargs.get('bg', 'white')
        
        # Create canvas and scrollbar with clean styling
        self.canvas = tk.Canvas(self, highlightthickness=0, bd=0, relief=tk.FLAT, bg=bg_color)
        
        # Use tk.Scrollbar instead of ttk for better visibility with custom colors
        # Determine if this is a dark theme based on background color
        is_dark_bg = bg_color in ['#2c3e50', '#34495e', '#1a1a1a', 'black']
        
        if is_dark_bg:
            # Light scrollbar for dark backgrounds
            self.scrollbar = tk.Scrollbar(self, orient="vertical", command=self.canvas.yview,
                                         bg='#34495e', troughcolor='#2c3e50', 
                                         activebackground='#3498db', highlightthickness=0,
                                         bd=1, relief=tk.FLAT, width=14)
        else:
            # Standard scrollbar for light backgrounds
            self.scrollbar = tk.Scrollbar(self, orient="vertical", command=self.canvas.yview,
                                         highlightthickness=0, bd=1, relief=tk.FLAT, width=14)
        
        self.scrollable_frame = tk.Frame(self.canvas, relief=tk.FLAT, bd=0, bg=bg_color)
        
        # Configure scrolling with overflow detection
        self.scrollable_frame.bind(
            "<Configure>",
            lambda e=None: self._check_overflow()
        )
        
        # Create window in canvas
        self.canvas_frame = self.canvas.create_window((0, 0), window=self.scrollable_frame, anchor="nw")
        self.canvas.configure(yscrollcommand=self.scrollbar.set)
        
        # Pack canvas first (scrollbar will be packed conditionally or always)
        self.canvas.pack(side="left", fill="both", expand=True)
        
        # Track if scrollbar is currently visible
        self.scrollbar_visible = False
        
        # If always show scrollbar, pack it immediately
        if self.always_show_scrollbar:
            self.scrollbar.pack(side="right", fill="y")
            self.scrollbar_visible = True
        
        # Bind mouse wheel events
        self.bind_mouse_wheel()
        
        # Bind keyboard navigation for scrolling
        self.bind_keyboard_navigation()
        
        # Bind canvas resize
        self.canvas.bind("<Configure>", self._on_canvas_configure)
    
    def _on_canvas_configure(self, event):
        """Handle canvas resize to update scrollable frame width"""
        canvas_width = event.width
        self.canvas.itemconfig(self.canvas_frame, width=canvas_width)
        # Check overflow when canvas resizes
        self.after_idle(self._check_overflow)
    
    def _check_overflow(self):
        """Check if content overflows and show/hide scrollbar accordingly"""
        self.canvas.update_idletasks()
        self.canvas.configure(scrollregion=self.canvas.bbox("all"))
        
        # If always show scrollbar, don't toggle it
        if self.always_show_scrollbar:
            return
        
        # Get canvas and content dimensions
        canvas_height = self.canvas.winfo_height()
        bbox = self.canvas.bbox("all")
        
        if bbox and len(bbox) >= 4 and canvas_height > 1:  # Ensure canvas is properly sized
            content_height = bbox[3] - bbox[1]  # bottom - top
            
            # Add small buffer to avoid unnecessary scrollbar for minor differences
            buffer = 5
            needs_scrollbar = content_height > (canvas_height - buffer)
            
            if needs_scrollbar and not self.scrollbar_visible:
                self.scrollbar.pack(side="right", fill="y")
                self.scrollbar_visible = True
                # Re-bind mouse wheel events to children after scrollbar appears
                self.after(50, lambda: self._rebind_children_mousewheel())
            elif not needs_scrollbar and self.scrollbar_visible:
                self.scrollbar.pack_forget()
                self.scrollbar_visible = False
    
    def _rebind_children_mousewheel(self):
        """Re-bind mouse wheel events to all child widgets"""
        def bind_children(widget):
            def _on_mousewheel(event):
                if self.canvas.winfo_exists() and self.scrollbar_visible:
                    self.canvas.yview_scroll(int(-1 * (event.delta / 120)), "units")
            
            widget.bind("<MouseWheel>", _on_mousewheel)  # Windows
            widget.bind("<Button-4>", lambda e: self.canvas.yview_scroll(-1, "units") if self.scrollbar_visible else None)  # Linux
            widget.bind("<Button-5>", lambda e: self.canvas.yview_scroll(1, "units") if self.scrollbar_visible else None)   # Linux
            
            for child in widget.winfo_children():
                bind_children(child)
        
        bind_children(self.scrollable_frame)
        # Also rebind keyboard navigation
        self._rebind_children_keyboard()
    
    def _rebind_children_keyboard(self):
        """Re-bind keyboard navigation to all child widgets"""
        def on_key_scroll(event):
            if not self.canvas.winfo_exists():
                return
            
            # Check if the event is from an Entry or Text widget
            if event.widget.__class__.__name__ in ['Entry', 'Text', 'Spinbox', 'Combobox']:
                return
            
            if event.keysym == 'Up':
                self.canvas.yview_scroll(-1, "units")
                return "break"
            elif event.keysym == 'Down':
                self.canvas.yview_scroll(1, "units")
                return "break"
            elif event.keysym == 'Prior':
                self.canvas.yview_scroll(-1, "pages")
                return "break"
            elif event.keysym == 'Next':
                self.canvas.yview_scroll(1, "pages")
                return "break"
            elif event.keysym == 'Home':
                self.canvas.yview_moveto(0)
                return "break"
            elif event.keysym == 'End':
                self.canvas.yview_moveto(1)
                return "break"
        
        def bind_widget(widget):
            widget.bind('<Up>', on_key_scroll, add='+')
            widget.bind('<Down>', on_key_scroll, add='+')
            widget.bind('<Prior>', on_key_scroll, add='+')
            widget.bind('<Next>', on_key_scroll, add='+')
            widget.bind('<Home>', on_key_scroll, add='+')
            widget.bind('<End>', on_key_scroll, add='+')
            
            for child in widget.winfo_children():
                bind_widget(child)
        
        bind_widget(self.scrollable_frame)
    
    def bind_mouse_wheel(self):
        """Bind mouse wheel events to canvas and all child widgets"""
        def _on_mousewheel(event):
            # Only scroll if scrollbar is visible (content overflows)
            if self.canvas.winfo_exists() and self.scrollbar_visible:
                self.canvas.yview_scroll(int(-1 * (event.delta / 120)), "units")
        
        def bind_to_mousewheel(widget):
            widget.bind("<MouseWheel>", _on_mousewheel)  # Windows
            widget.bind("<Button-4>", lambda e: self.canvas.yview_scroll(-1, "units") if self.scrollbar_visible else None)  # Linux
            widget.bind("<Button-5>", lambda e: self.canvas.yview_scroll(1, "units") if self.scrollbar_visible else None)   # Linux
        
        # Bind to main widgets
        bind_to_mousewheel(self)
        bind_to_mousewheel(self.canvas)
        bind_to_mousewheel(self.scrollable_frame)
        
        # Bind to all child widgets recursively
        def bind_children(widget):
            bind_to_mousewheel(widget)
            for child in widget.winfo_children():
                bind_children(child)
        
        # Schedule binding of children after widget creation
        self.after(100, lambda: bind_children(self.scrollable_frame))
    
    def bind_keyboard_navigation(self):
        """Bind keyboard events for scrolling without mouse"""
        def on_key_scroll(event):
            if not self.canvas.winfo_exists():
                return
            
            # Check if the event is from an Entry or Text widget (don't intercept their navigation)
            if event.widget.__class__.__name__ in ['Entry', 'Text', 'Spinbox', 'Combobox']:
                return
            
            # Arrow keys - scroll by small increments
            if event.keysym == 'Up':
                self.canvas.yview_scroll(-1, "units")
                return "break"  # Prevent default behavior
            elif event.keysym == 'Down':
                self.canvas.yview_scroll(1, "units")
                return "break"
            
            # Page Up/Down - scroll by larger increments
            elif event.keysym == 'Prior':  # Page Up
                self.canvas.yview_scroll(-1, "pages")
                return "break"
            elif event.keysym == 'Next':  # Page Down
                self.canvas.yview_scroll(1, "pages")
                return "break"
            
            # Home/End - scroll to top/bottom
            elif event.keysym == 'Home':
                self.canvas.yview_moveto(0)
                return "break"
            elif event.keysym == 'End':
                self.canvas.yview_moveto(1)
                return "break"
        
        def bind_to_widget(widget):
            """Bind keyboard events to a widget"""
            widget.bind('<Up>', on_key_scroll, add='+')
            widget.bind('<Down>', on_key_scroll, add='+')
            widget.bind('<Prior>', on_key_scroll, add='+')  # Page Up
            widget.bind('<Next>', on_key_scroll, add='+')   # Page Down
            widget.bind('<Home>', on_key_scroll, add='+')
            widget.bind('<End>', on_key_scroll, add='+')
        
        # Bind keyboard events to main widgets
        bind_to_widget(self.canvas)
        bind_to_widget(self)
        bind_to_widget(self.scrollable_frame)
        
        # Bind to all child widgets recursively
        def bind_children(widget):
            bind_to_widget(widget)
            for child in widget.winfo_children():
                bind_children(child)
        
        # Schedule binding of children after widget creation
        self.after(100, lambda: bind_children(self.scrollable_frame))
        
        # Make canvas focusable for keyboard events
        self.canvas.config(takefocus=True)
    
    def get_frame(self):
        """Return the scrollable frame for adding widgets"""
        return self.scrollable_frame
    
    def update_scrollregion(self):
        """Update the scroll region of the canvas and check for overflow"""
        self._check_overflow()

class AutocompleteEntry(tk.Entry):
    """Entry widget with autocomplete/word suggestion functionality"""
    
    def __init__(self, parent, suggestions_callback=None, textvariable=None, *args, **kwargs):
        """
        Initialize autocomplete entry
        suggestions_callback: function that returns list of suggestions based on current text
        textvariable: StringVar to use for the entry value
        """
        # Remove textvariable from kwargs if it exists
        if 'textvariable' in kwargs:
            textvariable = kwargs.pop('textvariable')
        
        tk.Entry.__init__(self, parent, *args, **kwargs)
        
        self.suggestions_callback = suggestions_callback
        self.suggestions_list = []
        self.listbox = None
        self.listbox_window = None  # Added for toplevel window
        
        # Set up textvariable properly
        if textvariable and isinstance(textvariable, tk.StringVar):
            self.var = textvariable
            self["textvariable"] = self.var
        else:
            self.var = tk.StringVar()
            self["textvariable"] = self.var
        
        # Bind events
        self.var.trace('w', self.on_text_change)
        self.bind("<Down>", self.move_down)
        self.bind("<Up>", self.move_up)
        self.bind("<Return>", self.on_enter)
        self.bind("<Escape>", self.close_listbox)
        self.bind("<FocusOut>", lambda e: self.after(200, self.close_listbox))
    
    def on_text_change(self, *args):
        """Handle text change and show suggestions"""
        text = self.var.get()
        
        # Close existing listbox if text is empty
        if not text:
            self.close_listbox()
            return
        
        # Get suggestions
        if self.suggestions_callback:
            self.suggestions_list = self.suggestions_callback(text)
        else:
            self.suggestions_list = []
        
        # Show listbox with suggestions
        if self.suggestions_list:
            self.show_suggestions()
        else:
            self.close_listbox()
    
    def show_suggestions(self):
        """Display suggestion listbox"""
        # Close any existing listbox first
        self.close_listbox()
        
        # Create a toplevel window for better positioning
        self.listbox_window = tk.Toplevel(self.master)
        self.listbox_window.wm_overrideredirect(True)  # Remove window decorations
        self.listbox_window.wm_attributes('-topmost', True)  # Always on top
        
        # Create frame for listbox with border
        list_frame = tk.Frame(self.listbox_window, relief=tk.SOLID, bd=1, bg='white')
        list_frame.pack(fill=tk.BOTH, expand=True)
        
        # Create listbox
        self.listbox = tk.Listbox(list_frame, 
                                 height=min(8, len(self.suggestions_list)),
                                 font=self['font'] if 'font' in self.keys() else ('Segoe UI', 10),
                                 relief=tk.FLAT, bd=0,
                                 selectmode=tk.SINGLE,
                                 activestyle='dotbox',
                                 selectbackground='#3498db',
                                 selectforeground='white',
                                 bg='white',
                                 highlightthickness=0)
        self.listbox.pack(fill=tk.BOTH, expand=True)
        
        # Position below entry - get absolute coordinates
        entry_x = self.winfo_rootx()
        entry_y = self.winfo_rooty() + self.winfo_height()
        entry_width = self.winfo_width()
        
        # Calculate height
        item_height = 20  # Approximate height per item
        list_height = min(8, len(self.suggestions_list)) * item_height + 4
        
        self.listbox_window.geometry(f"{entry_width}x{list_height}+{entry_x}+{entry_y}")
        
        # Populate suggestions
        for suggestion in self.suggestions_list:
            self.listbox.insert(tk.END, suggestion)
        
        # Bind selection
        self.listbox.bind("<Button-1>", self.on_listbox_click)
        self.listbox.bind("<Return>", self.on_listbox_select)
        self.listbox.bind("<Double-Button-1>", self.on_listbox_select)
    
    def move_down(self, event):
        """Move selection down in listbox"""
        if self.listbox and self.listbox.winfo_exists():
            current = self.listbox.curselection()
            if not current:
                self.listbox.selection_set(0)
                self.listbox.activate(0)
            elif current[0] < self.listbox.size() - 1:
                self.listbox.selection_clear(current)
                self.listbox.selection_set(current[0] + 1)
                self.listbox.activate(current[0] + 1)
                self.listbox.see(current[0] + 1)
            return "break"
    
    def move_up(self, event):
        """Move selection up in listbox"""
        if self.listbox and self.listbox.winfo_exists():
            current = self.listbox.curselection()
            if current and current[0] > 0:
                self.listbox.selection_clear(current)
                self.listbox.selection_set(current[0] - 1)
                self.listbox.activate(current[0] - 1)
                self.listbox.see(current[0] - 1)
            return "break"
    
    def on_enter(self, event):
        """Handle Enter key"""
        if self.listbox and self.listbox.winfo_exists():
            self.on_listbox_select(event)
            return "break"
    
    def on_listbox_click(self, event):
        """Handle listbox click"""
        self.after(100, lambda: self.on_listbox_select(event))
    
    def on_listbox_select(self, event):
        """Handle selection from listbox"""
        try:
            if self.listbox and self.listbox.winfo_exists():
                selection = self.listbox.curselection()
                if selection:
                    selected_value = self.listbox.get(selection[0])
                    self.var.set(selected_value)
                    self.close_listbox()
                    self.icursor(tk.END)
                    # Trigger any callbacks that depend on the value
                    self.event_generate('<<ComboboxSelected>>')
        except:
            self.close_listbox()
    
    def close_listbox(self, event=None):
        """Close suggestion listbox"""
        # Destroy the toplevel window first
        if hasattr(self, 'listbox_window') and self.listbox_window:
            try:
                if self.listbox_window.winfo_exists():
                    self.listbox_window.destroy()
            except:
                pass
            finally:
                self.listbox_window = None
        
        # Then destroy the listbox if it still exists
        if hasattr(self, 'listbox') and self.listbox:
            try:
                if self.listbox.winfo_exists():
                    self.listbox.destroy()
            except:
                pass
            finally:
                self.listbox = None

class LoginWindow:
    def __init__(self, root, on_success_callback):
        self.root = root
        self.on_success_callback = on_success_callback
        self.current_user = None
        
        # Initialize database connection with robust path handling
        # Try multiple locations: root, database/, and AppData
        db_paths_to_try = [
            'school_management.db',
            os.path.join('database', 'school_management.db'),
        ]
        
        # Add AppData path for installed version
        if os.name == 'nt':  # Windows
            app_data = os.getenv('APPDATA') or os.path.expanduser('~')
            app_data_db = os.path.join(app_data, 'GaybeckStarkidsSMS', 'school_management.db')
            db_paths_to_try.append(app_data_db)
        
        db_path = None
        for path in db_paths_to_try:
            if os.path.exists(path):
                try:
                    # Test if we can write to this location
                    test_conn = sqlite3.connect(path)
                    test_conn.execute("PRAGMA query_only = OFF")
                    test_conn.close()
                    db_path = path
                    break
                except:
                    continue
        
        # If no existing DB found, use AppData for installed version
        if not db_path:
            if 'Program Files' in os.path.dirname(os.path.abspath(__file__)):
                # Running from Program Files - use AppData
                if os.name == 'nt':
                    app_data = os.getenv('APPDATA') or os.path.expanduser('~')
                    db_dir = os.path.join(app_data, 'GaybeckStarkidsSMS')
                    os.makedirs(db_dir, exist_ok=True)
                    db_path = os.path.join(db_dir, 'school_management.db')
            else:
                # Running from source - use local database directory
                db_path = os.path.join('database', 'school_management.db')
                os.makedirs('database', exist_ok=True)
        
        self.db_path = db_path
        self.conn = sqlite3.connect(db_path)
        self.cursor = self.conn.cursor()
        
        self.setup_login_window()
    
    def setup_login_window(self):
        # Hide main window
        self.root.withdraw()
        
        # Create login window with responsive dimensions
        self.login_window = tk.Toplevel(self.root)
        self.login_window.title("Gaybeck Starkids Academy - Login")
        
        # Set window icon
        icon_locations = [
            'icon.ico',  # Current directory
            os.path.join(os.environ.get('APPDATA', ''), 'GaybeckStarkidsSMS', 'icon.ico'),  # AppData
            os.path.join(os.path.dirname(__file__), 'icon.ico'),  # Script directory
        ]
        
        try:
            for icon_path in icon_locations:
                if os.path.exists(icon_path):
                    try:
                        self.login_window.iconbitmap(icon_path)
                        break
                    except Exception:
                        continue
        except Exception as e:
            print(f"Could not set login window icon: {e}")
        
        # Calculate responsive window size
        login_width, login_height = ResponsiveManager.calculate_window_size(
            480, 700, min_width=400, min_height=600, max_width=600, max_height=850
        )
        
        self.login_window.geometry(f"{login_width}x{login_height}")
        self.login_window.resizable(True, True)  # Allow resizing
        self.login_window.minsize(400, 600)  # Set minimum size
        self.login_window.maxsize(600, 850)  # Set maximum size
        self.login_window.configure(bg='#f0f0f0')
        
        # Center the window
        self.center_window(self.login_window, login_width, login_height)
        
        # Prevent closing without proper login
        self.login_window.protocol("WM_DELETE_WINDOW", self.on_login_window_close)
        
        # Get responsive scaling factors
        font_scale = ResponsiveManager.get_font_scale()
        padding_scale = ResponsiveManager.get_padding_scale()
        
        # Create main frame with responsive padding
        main_padding = ResponsiveManager.scale_padding(30)
        main_frame = tk.Frame(self.login_window, bg='#f0f0f0')
        main_frame.pack(expand=True, fill='both', padx=main_padding, pady=main_padding)
        
        # Header with responsive height
        header_height = ResponsiveManager.scale_padding(80)
        header_frame = tk.Frame(main_frame, bg='#1e3a5f', height=header_height)
        header_frame.pack(fill='x', pady=(0, ResponsiveManager.scale_padding(30)))
        header_frame.pack_propagate(False)
        
        title_label = tk.Label(header_frame, text="GAYBECK STARKIDS ACADEMY", 
                              font=('Arial', ResponsiveManager.scale_font_size(16), 'bold'), 
                              fg='white', bg='#1e3a5f')
        title_label.pack(expand=True)
        
        subtitle_label = tk.Label(header_frame, text="Please login to continue", 
                                font=('Arial', ResponsiveManager.scale_font_size(10)), 
                                fg='#e6f3ff', bg='#1e3a5f')
        subtitle_label.pack(expand=True)
        
        # Login form
        form_frame = tk.Frame(main_frame, bg='white', relief='solid', bd=1)
        form_frame.pack(fill='both', expand=True, pady=(0, ResponsiveManager.scale_padding(20)))
        
        # Form content with responsive padding
        content_padding = ResponsiveManager.scale_padding(30)
        content_frame = tk.Frame(form_frame, bg='white')
        content_frame.pack(fill='both', expand=True, padx=content_padding, pady=ResponsiveManager.scale_padding(25))
        
        # Username field
        tk.Label(content_frame, text="Username:", 
                font=('Arial', ResponsiveManager.scale_font_size(11), 'bold'), 
                bg='white', fg='#333').pack(anchor='w', pady=(0, 5))
        
        self.username_var = tk.StringVar()
        username_entry = tk.Entry(content_frame, textvariable=self.username_var, 
                                 font=('Arial', ResponsiveManager.scale_font_size(11)), 
                                 width=25, relief='solid', bd=1)
        username_entry.pack(fill='x', pady=(0, 15))
        username_entry.focus()
        
        # Password field
        tk.Label(content_frame, text="Password:", 
                font=('Arial', ResponsiveManager.scale_font_size(11), 'bold'), 
                bg='white', fg='#333').pack(anchor='w', pady=(0, 5))
        
        self.password_var = tk.StringVar()
        password_entry = tk.Entry(content_frame, textvariable=self.password_var, 
                                 font=('Arial', ResponsiveManager.scale_font_size(11)), 
                                 width=25, show='*', relief='solid', bd=1)
        password_entry.pack(fill='x', pady=(0, 10))
        
        # Role selection field (compact layout)
        tk.Label(content_frame, text="Select Your Role:", 
                font=('Arial', ResponsiveManager.scale_font_size(10), 'bold'), 
                bg='white', fg='#333').pack(anchor='w', pady=(5, 3))
        
        self.login_role_var = tk.StringVar(value="admin")
        role_frame = tk.Frame(content_frame, bg='#f8f9fa', relief='solid', bd=1)
        role_frame.pack(fill='x', pady=(0, 15), padx=2)
        
        # Compact 2x2 grid layout for roles
        roles = [
            ("🔐 Admin", "admin", "#dc3545"),
            ("👨‍💼 Accountant", "accountant", "#fd7e14"), 
            ("👨‍🏫 Teacher", "teacher", "#28a745"),
            ("👥 Staff", "staff", "#17a2b8")
        ]
        
        # Create grid layout
        for i, (display_text, role_value, color) in enumerate(roles):
            row = i // 2
            col = i % 2
            
            rb = tk.Radiobutton(role_frame, text=display_text, 
                               variable=self.login_role_var, value=role_value,
                               font=('Arial', 9, 'bold'), bg='#f8f9fa', fg=color,
                               selectcolor='#ffffff', activebackground='#f8f9fa',
                               indicatoron=1, cursor='hand2')
            rb.grid(row=row, column=col, sticky='w', padx=(5, 15), pady=2)
        
        # Configure grid weights
        role_frame.grid_columnconfigure(0, weight=1)
        role_frame.grid_columnconfigure(1, weight=1)
        
        # Login button
        login_btn = tk.Button(content_frame, text="LOGIN", command=self.authenticate_user,
                             font=('Arial', 12, 'bold'), bg='#28a745', fg='white', 
                             relief='solid', bd=0, width=15, height=2, cursor='hand2')
        login_btn.pack(pady=(10, 15))
        
        # Bind Enter key to login
        self.login_window.bind('<Return>', lambda e: self.authenticate_user())
        
        # Default credentials info
        info_frame = tk.Frame(main_frame, bg='#e9ecef', relief='solid', bd=1)
        info_frame.pack(fill='x', pady=(0, 0))
        
        info_content = tk.Frame(info_frame, bg='#e9ecef')
        info_content.pack(fill='both', expand=True, padx=15, pady=10)
        
        tk.Label(info_content, text="Sample Credentials & Security:", 
                font=('Arial', 9, 'bold'), bg='#e9ecef', fg='#333').pack(anchor='w')
        
        # Credentials with proper wrapping
        cred_text = "Sample Accounts:\n• admin/admin123 (Admin)  • accountant1/account123 (Accountant)\n• teacher1/teacher123 (Teacher)  • staff1/staff123 (Staff)"
        cred_label = tk.Label(info_content, text=cred_text, font=('Arial', 8), 
                             bg='#e9ecef', fg='#666', justify='left', wraplength=420)
        cred_label.pack(anchor='w', pady=(3, 2), fill='x')
        
        # Security notice with wrapping
        security_text = "⚠️ SECURITY: You must select your exact assigned role. Login will be denied if role selection doesn't match your account."
        security_label = tk.Label(info_content, text=security_text, font=('Arial', 8), 
                                 bg='#e9ecef', fg='#d63384', justify='left', wraplength=420)
        security_label.pack(anchor='w', pady=(2, 3), fill='x')
    
    def center_window(self, window, width, height):
        """Center window on screen"""
        screen_width = window.winfo_screenwidth()
        screen_height = window.winfo_screenheight()
        x = (screen_width - width) // 2
        y = (screen_height - height) // 2
        window.geometry(f'{width}x{height}+{x}+{y}')
    
    def authenticate_user(self):
        username = self.username_var.get().strip()
        password = self.password_var.get().strip()
        selected_role = self.login_role_var.get()
        
        if not username or not password:
            messagebox.showerror("Error", "Please enter both username and password")
            return
        
        if not selected_role:
            messagebox.showerror("Error", "Please select a role to login as")
            return
        
        try:
            # Check user credentials
            self.cursor.execute('''
                SELECT id, username, full_name, role, email, permissions, is_active 
                FROM users 
                WHERE username = ? AND password = ?
            ''', (username, password))
            
            user = self.cursor.fetchone()
            
            if user and user[6]:  # Check if user exists and is active
                stored_role = user[3]
                
                # Role validation logic - users can only login with their assigned role
                role_valid = False
                
                if selected_role == stored_role:
                    # User is logging in with their assigned role
                    role_valid = True
                else:
                    # User is trying to login with a different role than assigned
                    role_names = {
                        "admin": "Administrator",
                        "accountant": "Accountant",
                        "teacher": "Teacher", 
                        "staff": "Staff"
                    }
                    
                    user_role_display = role_names.get(stored_role, stored_role)
                    selected_role_display = role_names.get(selected_role, selected_role)
                    
                    messagebox.showerror("Role Mismatch", 
                                       f"Access Denied!\n\n" +
                                       f"Your account role: {user_role_display}\n" +
                                       f"Selected login role: {selected_role_display}\n\n" +
                                       "You can only login with your assigned role.\n" +
                                       "Please select the correct role and try again.")
                    return
                
                if role_valid:
                    # Get permissions for the user's assigned role
                    permissions = []
                    if stored_role == "admin":
                        permissions = ['all_permissions']
                    else:
                        # Use stored permissions from database
                        permissions = user[5].split(',') if user[5] else []
                    
                    self.current_user = {
                        'id': user[0],
                        'username': user[1],
                        'full_name': user[2],
                        'role': stored_role,  # Use the stored role from database
                        'email': user[4],
                        'permissions': permissions,
                        'is_active': user[6]
                    }
                    
                    # Update last login
                    self.cursor.execute('''
                        UPDATE users SET last_login = CURRENT_DATE WHERE id = ?
                    ''', (user[0],))
                    self.conn.commit()
                    
                    # Close login window and show main application
                    self.login_window.destroy()
                    self.root.deiconify()  # Show main window
                    
                    # Call success callback with user info
                    self.on_success_callback(self.current_user)
                
            else:
                messagebox.showerror("Login Failed", "Invalid username or password, or account is disabled")
                self.password_var.set("")  # Clear password field
                
        except Exception as e:
            messagebox.showerror("Error", f"Login failed: {str(e)}")
    
    def on_login_window_close(self):
        """Handle login window close event"""
        if messagebox.askokcancel("Quit", "Do you want to quit the application?"):
            self.root.quit()

class SchoolManagementSystem:
    def __init__(self, root, user_info=None):
        self.root = root
        self.root.title("Gaybeck Starkids Academy - Management System")
        
        # Set window icon for title bar and taskbar
        try:
            # For Windows: Fix taskbar icon - must be done before iconbitmap
            import ctypes
            myappid = 'gaybeck.starkids.sms.2.0.3'  # Arbitrary string
            ctypes.windll.shell32.SetCurrentProcessExplicitAppUserModelID(myappid)
        except:
            pass
        
        # Get the correct path for bundled resources (PyInstaller support)
        def resource_path(relative_path):
            """Get absolute path to resource, works for dev and for PyInstaller"""
            try:
                # PyInstaller creates a temp folder and stores path in _MEIPASS
                base_path = sys._MEIPASS
            except Exception:
                base_path = os.path.abspath(".")
            return os.path.join(base_path, relative_path)
        
        # Try to set window icon
        icon_set = False
        
        # Check multiple locations for icon.ico
        icon_locations = [
            resource_path('icon.ico'),  # Current directory or PyInstaller bundle
            os.path.join(os.environ.get('APPDATA', ''), 'GaybeckStarkidsSMS', 'icon.ico'),  # AppData
            os.path.join(os.path.dirname(__file__), 'icon.ico'),  # Script directory
        ]
        
        try:
            # First try icon.ico from various locations
            for icon_path in icon_locations:
                if os.path.exists(icon_path):
                    try:
                        self.root.iconbitmap(icon_path)
                        icon_set = True
                        break
                    except Exception as e:
                        continue
                
            # Also try to set PNG for better quality
            logo_path = resource_path('logo.png')
            if os.path.exists(logo_path):
                try:
                    if PIL_AVAILABLE:
                        from PIL import Image, ImageTk
                        img = Image.open(logo_path)
                        # Resize to appropriate icon size
                        img = img.resize((48, 48), Image.Resampling.LANCZOS)
                        photo = ImageTk.PhotoImage(img)
                        self.root.iconphoto(True, photo)
                        # Keep reference to prevent garbage collection
                        self.root._icon_photo = photo
                        icon_set = True
                except Exception as e:
                    print(f"PNG icon failed: {e}")
                    
        except Exception as e:
            print(f"Could not set window icon: {e}")
        
        if not icon_set:
            print("Warning: No icon file found")
        
        # Calculate responsive window size for main window
        main_width, main_height = ResponsiveManager.calculate_window_size(
            1400, 900, min_width=1024, min_height=768, scale_factor=0.9
        )
        
        self.root.geometry(f"{main_width}x{main_height}")
        self.root.minsize(1024, 768)  # Set minimum size
        self.root.configure(bg='#f8f9fa')
        
        # Check screen size to decide on maximized state
        screen_width, screen_height = ResponsiveManager.get_screen_info()
        if screen_width >= 1920 and screen_height >= 1080:
            self.root.state('zoomed')  # Maximize on large screens
        
        # Store responsive scaling factors
        self.font_scale = ResponsiveManager.get_font_scale()
        self.padding_scale = ResponsiveManager.get_padding_scale()
        
        # Bind resize event to handle responsive adjustments
        self.root.bind('<Configure>', self.on_window_resize)
        self.last_width = main_width
        self.last_height = main_height
        
        # Store user information and permissions
        self.current_user = user_info or {
            'username': 'guest', 'full_name': 'Please Login', 'role': 'guest',
            'permissions': []
        }
        
        # Modern styling configurations
        self.root.option_add('*TCombobox*Listbox.selectBackground', '#3498db')
        self.root.option_add('*Frame.relief', 'flat')
        self.root.option_add('*Frame.bd', '0')
        
        # Initialize database
        self.init_database()
        
        # Initialize AI predictor
        if AI_AVAILABLE:
            self.ai_predictor = AIPredictor(self.conn)
        else:
            self.ai_predictor = None
        
        # Initialize real-time sync manager
        if REALTIME_SYNC_AVAILABLE:
            self.sync_manager = RealTimeSyncManager()
        else:
            self.sync_manager = None
        
        # Create main frame with modern layout
        self.main_frame = tk.Frame(self.root, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        self.main_frame.pack(fill=tk.BOTH, expand=True)
        
        # Create header
        self.create_header()
        
        # Create main content container
        self.content_container = tk.Frame(self.main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        self.content_container.pack(fill=tk.BOTH, expand=True)
        
        # Create navigation sidebar
        self.create_navigation()
        
        # Create status bar
        self.create_status_bar()
        
        # Bind global arrow key navigation for scrolling
        self.bind_global_keyboard_navigation()
        
        # Initialize dashboard variables
        self.students_present_var = tk.StringVar(value="0")
        self.feeding_fee_var = tk.StringVar(value="GHS 0.00")
        self.bus_fee_var = tk.StringVar(value="GHS 0.00")
        self.total_revenue_var = tk.StringVar(value="GHS 0.00")
        
        # Load initial dashboard data
        self.update_dashboard()
        
    def get_data_directory(self, subfolder=''):
        """
        Get the appropriate data directory for the application.
        Returns source directory if running from source, or AppData if installed.
        
        Args:
            subfolder: Optional subfolder name (e.g., 'database', 'teacher_documents')
        """
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Check if we're in the source directory (has database folder)
        source_dir = os.path.join(base_dir, 'database')
        
        if os.path.exists(source_dir) and os.path.isdir(source_dir):
            # Running from source directory
            if subfolder:
                return os.path.join(base_dir, subfolder)
            return base_dir
        else:
            # Running from installed package - use AppData
            if os.name == 'nt':  # Windows
                app_data = os.getenv('APPDATA') or os.path.expanduser('~')
                data_dir = os.path.join(app_data, 'GaybeckStarkidsSMS')
            else:  # Linux/Mac
                data_dir = os.path.expanduser('~/.gaybeck-starkids-sms')
            
            if subfolder:
                return os.path.join(data_dir, subfolder)
            return data_dir
    
    def init_database(self):
        # Try to use database in root directory first (for standalone execution)
        # Then fallback to database/ subdirectory (for source directory)
        db_path = None
        
        # Check root directory first
        if os.path.exists('school_management.db'):
            db_path = 'school_management.db'
        else:
            # Check database subdirectory
            db_subdir = os.path.join('database', 'school_management.db')
            if os.path.exists(db_subdir):
                db_path = db_subdir
            else:
                # Create in database directory if neither exists
                db_dir = self.get_data_directory('database')
                if not os.path.exists(db_dir):
                    os.makedirs(db_dir)
                db_path = os.path.join(db_dir, 'school_management.db')
        
        # Connect to SQLite database
        self.conn = sqlite3.connect(db_path)
        self.cursor = self.conn.cursor()
        
        # Enable foreign keys
        self.cursor.execute("PRAGMA foreign_keys = ON")
        
        # Create tables if they don't exist with proper relationships
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS classes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                class_name TEXT NOT NULL UNIQUE,
                class_teacher_id INTEGER,
                capacity INTEGER DEFAULT 30,
                current_students INTEGER DEFAULT 0,
                created_date DATE DEFAULT CURRENT_DATE,
                FOREIGN KEY (class_teacher_id) REFERENCES teachers (id)
            )
        ''')
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS students (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                student_id TEXT UNIQUE,
                name TEXT NOT NULL,
                date_of_birth DATE,
                gender TEXT,
                date_of_admission DATE,
                class_id INTEGER,
                previous_class_id INTEGER,
                father_name TEXT,
                mother_name TEXT,
                phone TEXT,
                address TEXT,
                parent_email TEXT,
                emergency_contact_name TEXT,
                emergency_relationship TEXT,
                emergency_phone TEXT,
                emergency_alt_phone TEXT,
                medical_allergies TEXT,
                document_path TEXT,
                transportation TEXT DEFAULT 'Walk-in',
                bus_fee REAL DEFAULT 0,
                feeding_fee_paid BOOLEAN DEFAULT 0,
                monthly_fee REAL DEFAULT 0,
                status TEXT DEFAULT 'Active',
                created_date DATE DEFAULT CURRENT_DATE,
                FOREIGN KEY (class_id) REFERENCES classes (id),
                FOREIGN KEY (previous_class_id) REFERENCES classes (id)
            )
        ''')
        
        # -- Migration: ensure student_id column exists for older databases --
        self.cursor.execute("PRAGMA table_info(students)")
        existing_columns = [row[1] for row in self.cursor.fetchall()]
        if 'student_id' not in existing_columns:
            try:
                # Add the column (SQLite allows adding simple columns)
                self.cursor.execute("ALTER TABLE students ADD COLUMN student_id TEXT")
                # Add a unique index to emulate UNIQUE constraint safely
                self.cursor.execute("CREATE UNIQUE INDEX IF NOT EXISTS idx_students_student_id ON students(student_id)")
            except Exception as e:
                # Avoid crashing on migration problems; keep running and notify
                print("Warning: could not add student_id column/index:", e)
        
        # Create teachers table FIRST before trying to ALTER it
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS teachers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                teacher_id TEXT UNIQUE,
                name TEXT NOT NULL,
                hire_date DATE,
                class_id INTEGER,
                starting_salary REAL,
                qualifications TEXT,
                skills TEXT,
                document_path TEXT,
                phone TEXT,
                email TEXT,
                photo BLOB,
                created_date DATE DEFAULT CURRENT_DATE,
                FOREIGN KEY (class_id) REFERENCES classes (id)
            )
        ''')
        
        # Add new columns to students table for enhanced functionality (migration for older databases)
        self.cursor.execute("PRAGMA table_info(students)")
        student_columns = [row[1] for row in self.cursor.fetchall()]
        
        new_student_columns = [
            ('parent_email', 'TEXT'),
            ('emergency_contact_name', 'TEXT'),
            ('emergency_relationship', 'TEXT'),
            ('emergency_phone', 'TEXT'),
            ('emergency_alt_phone', 'TEXT'),
            ('medical_allergies', 'TEXT'),
            ('document_path', 'TEXT')
        ]
        
        for col_name, col_type in new_student_columns:
            if col_name not in student_columns:
                try:
                    self.cursor.execute(f"ALTER TABLE students ADD COLUMN {col_name} {col_type}")
                except Exception as e:
                    print(f"Warning: could not add {col_name} column:", e)
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS fees (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                student_id INTEGER,
                month TEXT,
                year INTEGER,
                amount_due REAL,
                amount_paid REAL,
                arrears REAL,
                feeding_fee_paid BOOLEAN DEFAULT 0,
                bus_fee_paid BOOLEAN DEFAULT 0,
                payment_date DATE DEFAULT CURRENT_DATE,
                FOREIGN KEY (student_id) REFERENCES students (id) ON DELETE CASCADE
            )
        ''')
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS attendance (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                student_id INTEGER,
                date DATE DEFAULT CURRENT_DATE,
                present BOOLEAN DEFAULT 0,
                feeding_fee_paid BOOLEAN DEFAULT 0,
                bus_fee_paid BOOLEAN DEFAULT 0,
                FOREIGN KEY (student_id) REFERENCES students (id) ON DELETE CASCADE
            )
        ''')
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS promotions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                student_id INTEGER,
                from_class_id INTEGER,
                to_class_id INTEGER,
                promotion_date DATE,
                academic_year TEXT,
                FOREIGN KEY (student_id) REFERENCES students (id) ON DELETE CASCADE,
                FOREIGN KEY (from_class_id) REFERENCES classes (id),
                FOREIGN KEY (to_class_id) REFERENCES classes (id)
            )
        ''')
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                password TEXT NOT NULL,
                full_name TEXT NOT NULL,
                role TEXT NOT NULL DEFAULT 'viewer',
                email TEXT,
                phone TEXT,
                permissions TEXT,
                is_active BOOLEAN DEFAULT 1,
                created_date DATE DEFAULT CURRENT_DATE,
                last_login DATE
            )
        ''')
        
        # Teacher Documents Table for Multiple Document Support
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS teacher_documents (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                teacher_id INTEGER NOT NULL,
                document_path TEXT NOT NULL,
                document_name TEXT NOT NULL,
                file_size INTEGER,
                upload_date DATE DEFAULT CURRENT_DATE,
                FOREIGN KEY (teacher_id) REFERENCES teachers (id) ON DELETE CASCADE
            )
        ''')
        
        # Financial Management Tables for Income and Expense Tracking
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS financial_categories (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                category_name TEXT NOT NULL UNIQUE,
                category_type TEXT NOT NULL CHECK (category_type IN ('income', 'expense', 'Income', 'Expense')),
                description TEXT,
                is_active BOOLEAN DEFAULT 1,
                created_date DATE DEFAULT CURRENT_DATE
            )
        ''')
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS system_settings (
                key TEXT PRIMARY KEY,
                value TEXT,
                description TEXT,
                updated_date DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS financial_transactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                transaction_date DATE NOT NULL DEFAULT CURRENT_DATE,
                category_id INTEGER NOT NULL,
                transaction_type TEXT NOT NULL CHECK (transaction_type IN ('income', 'expense')),
                amount REAL NOT NULL CHECK (amount > 0),
                description TEXT NOT NULL,
                reference_number TEXT,
                payment_method TEXT DEFAULT 'Cash',
                created_by INTEGER,
                notes TEXT,
                created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (category_id) REFERENCES financial_categories (id),
                FOREIGN KEY (created_by) REFERENCES users (id)
            )
        ''')
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS budget_plans (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                plan_name TEXT NOT NULL,
                category_id INTEGER,
                budgeted_amount REAL NOT NULL CHECK (budgeted_amount > 0),
                period_type TEXT DEFAULT 'monthly' CHECK (period_type IN ('daily', 'weekly', 'monthly', 'quarterly', 'annual')),
                start_date DATE NOT NULL,
                end_date DATE NOT NULL,
                is_active BOOLEAN DEFAULT 1,
                created_date DATE DEFAULT CURRENT_DATE,
                FOREIGN KEY (category_id) REFERENCES financial_categories (id)
            )
        ''')
        
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS financial_reports (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                report_name TEXT NOT NULL,
                report_type TEXT NOT NULL,
                generated_date DATETIME DEFAULT CURRENT_TIMESTAMP,
                date_from DATE,
                date_to DATE,
                total_income REAL DEFAULT 0,
                total_expenses REAL DEFAULT 0,
                net_profit REAL DEFAULT 0,
                generated_by INTEGER,
                file_path TEXT,
                FOREIGN KEY (generated_by) REFERENCES users (id)
            )
        ''')
        
        # Grades Table for Student Academic Performance
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS grades (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                student_id INTEGER NOT NULL,
                assignment_name TEXT NOT NULL,
                subject TEXT,
                grade REAL NOT NULL CHECK (grade >= 0 AND grade <= 100),
                max_grade REAL DEFAULT 100,
                assignment_type TEXT DEFAULT 'Test',
                date_assigned DATE,
                date_submitted DATE DEFAULT CURRENT_DATE,
                teacher_id INTEGER,
                comments TEXT,
                created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (student_id) REFERENCES students (id) ON DELETE CASCADE,
                FOREIGN KEY (teacher_id) REFERENCES teachers (id)
            )
        ''')
        
        # Insert default classes if they don't exist
        default_classes = [
            ('Nursery', 20),
            ('KG 1', 25),
            ('KG 2', 25),
            ('Class 1', 30),
            ('Class 2', 30),
            ('Class 3', 30),
            ('Class 4', 30),
            ('Class 5', 30),
            ('Class 6', 30),
        ]

        for cname, cap in default_classes:
            try:
                self.cursor.execute("INSERT OR IGNORE INTO classes (class_name, capacity) VALUES (?, ?)", (cname, cap))
            except Exception:
                pass

        # Build mapping from class name to id
        self.cursor.execute("SELECT id, class_name FROM classes")
        class_rows = self.cursor.fetchall()
        class_mapping = {name: cid for cid, name in class_rows}

        # Insert sample students only if table is empty
        self.cursor.execute("SELECT COUNT(*) FROM students")
        if self.cursor.fetchone()[0] == 0:
            sample_students = [
                ('STD001', 'John Mensah', '2015-03-15', 'Male', '2023-01-10', class_mapping.get('Class 4'),
                 class_mapping.get('Class 3'), 'Kwame Mensah', 'Akua Mensah', '0241234567', 'Accra Central',
                 'Bus', 50.00, 1, 200.00),
                ('STD002', 'Abena Osei', '2016-07-22', 'Female', '2023-01-10', class_mapping.get('Class 3'),
                 class_mapping.get('Class 2'), 'Kofi Osei', 'Ama Osei', '0242345678', 'East Legon',
                 'Walk-in', 0.00, 1, 200.00),
                ('STD003', 'Kwaku Boateng', '2015-11-30', 'Male', '2023-01-10', class_mapping.get('Class 4'),
                 class_mapping.get('Class 3'), 'Yaw Boateng', 'Esi Boateng', '0243456789', 'Dansoman',
                 'Bus', 50.00, 0, 200.00),
            ]

            for student in sample_students:
                try:
                    self.cursor.execute('''
                        INSERT OR IGNORE INTO students (
                            student_id, name, date_of_birth, gender, date_of_admission,
                            class_id, previous_class_id, father_name, mother_name, phone, address,
                            transportation, bus_fee, feeding_fee_paid, monthly_fee
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ''', student)
                except Exception as e:
                    print("Warning: could not insert sample student:", e)
        
        # Create default admin user if users table is empty
        self.cursor.execute("SELECT COUNT(*) FROM users")
        if self.cursor.fetchone()[0] == 0:
            try:
                # Default admin credentials
                self.cursor.execute('''
                    INSERT INTO users (username, password, full_name, role, email, permissions)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', ('admin', 'admin123', 'System Administrator', 'admin', 'admin@school.com', 
                      'all_permissions'))
                
                # Default accountant user with financial permissions
                self.cursor.execute('''
                    INSERT INTO users (username, password, full_name, role, email, permissions)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', ('accountant1', 'account123', 'Sample Accountant', 'accountant', 'accountant@school.com',
                      'dashboard,financial_management,fees,reports'))
                
                # Default teacher user - NO PERMISSIONS by default
                self.cursor.execute('''
                    INSERT INTO users (username, password, full_name, role, email, permissions)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', ('teacher1', 'teacher123', 'Sample Teacher', 'teacher', 'teacher@school.com',
                      ''))  # No permissions - admin must assign
                      
                # Default staff user - NO PERMISSIONS by default
                self.cursor.execute('''
                    INSERT INTO users (username, password, full_name, role, email, permissions)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', ('staff1', 'staff123', 'Sample Staff', 'staff', 'staff@school.com',
                      ''))  # No permissions - admin must assign
            except Exception as e:
                print("Warning: could not insert default users:", e)
        
        # Create default financial categories if table is empty
        self.cursor.execute("SELECT COUNT(*) FROM financial_categories")
        if self.cursor.fetchone()[0] == 0:
            try:
                # Default income categories
                income_categories = [
                    ('School Fees', 'income', 'Student tuition and school fees'),
                    ('Registration Fees', 'income', 'New student registration fees'), 
                    ('Feeding Fees', 'income', 'Student meal and feeding fees'),
                    ('Transportation Fees', 'income', 'School bus transportation fees'),
                    ('Extra Curricular Fees', 'income', 'Sports, clubs and activities fees'),
                    ('Uniform Sales', 'income', 'School uniform and merchandise sales'),
                    ('Book Sales', 'income', 'Textbooks and stationery sales'),
                    ('Event Fees', 'income', 'Special events and program fees'),
                    ('Donations', 'income', 'Charitable donations and sponsorships'),
                    ('Other Income', 'income', 'Miscellaneous income sources')
                ]
                
                # Default expense categories
                expense_categories = [
                    ('Teacher Salaries', 'expense', 'Teaching staff salaries and wages'),
                    ('Support Staff Salaries', 'expense', 'Non-teaching staff salaries'),
                    ('Utilities', 'expense', 'Electricity, water, internet and phone bills'),
                    ('Office Supplies', 'expense', 'Stationery, printing and office materials'),
                    ('Maintenance & Repairs', 'expense', 'Building and equipment maintenance'),
                    ('Transport Expenses', 'expense', 'Vehicle fuel, maintenance and transport costs'),
                    ('Food & Catering', 'expense', 'Student meals and kitchen supplies'),
                    ('Educational Materials', 'expense', 'Teaching aids, books and learning resources'),
                    ('Insurance', 'expense', 'Building, vehicle and liability insurance'),
                    ('Professional Services', 'expense', 'Legal, accounting and consulting fees'),
                    ('Marketing & Advertising', 'expense', 'Promotional materials and advertising'),
                    ('Equipment Purchase', 'expense', 'Furniture, computers and equipment'),
                    ('Training & Development', 'expense', 'Staff training and professional development'),
                    ('Rent & Leases', 'expense', 'Property rent and equipment leases'),
                    ('Other Expenses', 'expense', 'Miscellaneous operating expenses')
                ]
                
                # Insert income categories
                for category_name, category_type, description in income_categories:
                    self.cursor.execute('''
                        INSERT OR IGNORE INTO financial_categories (category_name, category_type, description)
                        VALUES (?, ?, ?)
                    ''', (category_name, category_type, description))
                
                # Insert expense categories  
                for category_name, category_type, description in expense_categories:
                    self.cursor.execute('''
                        INSERT OR IGNORE INTO financial_categories (category_name, category_type, description)
                        VALUES (?, ?, ?)
                    ''', (category_name, category_type, description))
                    
            except Exception as e:
                print("Warning: could not insert default financial categories:", e)
        
        # Set default system settings if not exists
        try:
            self.cursor.execute("INSERT OR IGNORE INTO system_settings (key, value, description) VALUES (?, ?, ?)",
                              ('currency', 'GHS', 'Default system currency'))
            self.cursor.execute("INSERT OR IGNORE INTO system_settings (key, value, description) VALUES (?, ?, ?)",
                              ('school_name', 'Gaybeck Starkids Academy', 'School name'))
            self.cursor.execute("INSERT OR IGNORE INTO system_settings (key, value, description) VALUES (?, ?, ?)",
                              ('academic_year', '2024/2025', 'Current academic year'))
        except Exception as e:
            print("Warning: could not insert default system settings:", e)
        
        # Create sample teacher record matching the teacher1 login user
        self.cursor.execute("SELECT COUNT(*) FROM teachers")
        if self.cursor.fetchone()[0] == 0:
            try:
                # Get Class 3 ID for teacher assignment
                self.cursor.execute("SELECT id FROM classes WHERE class_name = ?", ('Class 3',))
                class3_result = self.cursor.fetchone()
                class3_id = class3_result[0] if class3_result else 1
                
                # Add Sample Teacher record
                self.cursor.execute('''
                    INSERT INTO teachers (name, hire_date, class_id, starting_salary, 
                                        qualifications, skills, phone, email)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ''', ('Sample Teacher', '2024-01-15', class3_id, 3500.00,
                      'B.Ed Elementary Education', 'Mathematics, English', 
                      '0241111111', 'teacher@school.com'))
            except Exception as e:
                print("Warning: could not insert sample teacher:", e)
        
        self.conn.commit()
    
    def generate_student_id(self, year=None):
        """
        Generate automatic student ID with format: STU{YEAR}{SEQUENCE}
        Example: STU202400001, STU202400002, etc.
        Ensures no duplicate IDs by continuing from the highest existing sequence.
        """
        from datetime import datetime
        
        if not year:
            year = datetime.now().year
        
        prefix = f"STU{year}"
        
        # Get the highest existing sequence for this year
        self.cursor.execute('''
            SELECT MAX(student_id) FROM students 
            WHERE student_id LIKE ?
        ''', (f"{prefix}%",))
        
        result = self.cursor.fetchone()
        max_id = result[0]
        
        if max_id:
            try:
                # Extract the numeric part (last 5 digits) and convert to int
                sequence_str = max_id[len(prefix):]
                sequence = int(sequence_str) + 1
            except (ValueError, IndexError):
                sequence = 1
        else:
            # First student for this year
            sequence = 1
        
        # Safety check - prevent overflow
        if sequence > 99999:
            raise Exception(f"Cannot generate more student IDs for year {year} (maximum 99,999 reached)")
        
        # Format: STU + YEAR + 5-digit sequence
        new_id = f"{prefix}{sequence:05d}"
        
        # Double-check this ID doesn't exist (safety measure)
        self.cursor.execute('SELECT COUNT(*) FROM students WHERE student_id = ?', (new_id,))
        if self.cursor.fetchone()[0] > 0:
            # ID exists, find next available
            sequence += 1
            while sequence <= 99999:
                new_id = f"{prefix}{sequence:05d}"
                self.cursor.execute('SELECT COUNT(*) FROM students WHERE student_id = ?', (new_id,))
                if self.cursor.fetchone()[0] == 0:
                    return new_id
                sequence += 1
            raise Exception(f"Cannot find available student ID for year {year}")
        
        return new_id
    
    # ==================== AUTOCOMPLETE SUGGESTION METHODS ====================
    
    def get_student_suggestions(self, search_text):
        """Get student name suggestions for autocomplete"""
        search_text = search_text.lower()
        try:
            # Search in student names and IDs
            self.cursor.execute('''
                SELECT DISTINCT name FROM students 
                WHERE LOWER(name) LIKE ? OR LOWER(student_id) LIKE ?
                ORDER BY name LIMIT 10
            ''', (f'%{search_text}%', f'%{search_text}%'))
            results = self.cursor.fetchall()
            return [r[0] for r in results]
        except:
            return []
    
    def get_teacher_suggestions(self, search_text):
        """Get teacher name suggestions for autocomplete"""
        search_text = search_text.lower()
        try:
            self.cursor.execute('''
                SELECT DISTINCT name FROM teachers 
                WHERE LOWER(name) LIKE ? OR LOWER(teacher_id) LIKE ?
                ORDER BY name LIMIT 10
            ''', (f'%{search_text}%', f'%{search_text}%'))
            results = self.cursor.fetchall()
            return [r[0] for r in results]
        except:
            return []
    
    def get_class_suggestions(self, search_text):
        """Get class name suggestions for autocomplete"""
        search_text = search_text.lower()
        try:
            self.cursor.execute('''
                SELECT DISTINCT class_name FROM classes 
                WHERE LOWER(class_name) LIKE ?
                ORDER BY class_name LIMIT 10
            ''', (f'%{search_text}%',))
            results = self.cursor.fetchall()
            return [r[0] for r in results]
        except:
            return []
    
    def get_user_suggestions(self, search_text):
        """Get user name suggestions for autocomplete"""
        search_text = search_text.lower()
        try:
            self.cursor.execute('''
                SELECT DISTINCT full_name FROM users 
                WHERE LOWER(full_name) LIKE ? OR LOWER(username) LIKE ?
                ORDER BY full_name LIMIT 10
            ''', (f'%{search_text}%', f'%{search_text}%'))
            results = self.cursor.fetchall()
            return [r[0] for r in results]
        except:
            return []
    
    def get_combined_suggestions(self, search_text):
        """Get combined suggestions from students, teachers, and users"""
        suggestions = []
        search_text = search_text.lower()
        
        try:
            # Get student names
            self.cursor.execute('''
                SELECT DISTINCT name FROM students 
                WHERE LOWER(name) LIKE ?
                ORDER BY name LIMIT 5
            ''', (f'%{search_text}%',))
            suggestions.extend([f"🎓 {r[0]}" for r in self.cursor.fetchall()])
            
            # Get teacher names
            self.cursor.execute('''
                SELECT DISTINCT name FROM teachers 
                WHERE LOWER(name) LIKE ?
                ORDER BY name LIMIT 5
            ''', (f'%{search_text}%',))
            suggestions.extend([f"👨‍📚 {r[0]}" for r in self.cursor.fetchall()])
            
            # Get class names
            self.cursor.execute('''
                SELECT DISTINCT class_name FROM classes 
                WHERE LOWER(class_name) LIKE ?
                ORDER BY class_name LIMIT 3
            ''', (f'%{search_text}%',))
            suggestions.extend([f"ℹ️ {r[0]}" for r in self.cursor.fetchall()])
            
        except:
            pass
        
        return suggestions[:10]  # Return top 10 combined
    
    def generate_teacher_id(self, year=None):
        """
        Generate automatic teacher ID with format: TCH{YEAR}{SEQUENCE}
        Example: TCH202400001, TCH202400002, etc.
        """
        from datetime import datetime
        
        if not year:
            year = datetime.now().year
        
        # Get the maximum sequence number for this year
        prefix = f"TCH{year}"
        self.cursor.execute('''
            SELECT teacher_id FROM teachers 
            WHERE teacher_id LIKE ? 
            ORDER BY teacher_id DESC LIMIT 1
        ''', (f"{prefix}%",))
        
        result = self.cursor.fetchone()
        
        if result:
            # Extract sequence number and increment
            last_id = result[0]
            try:
                sequence = int(last_id[8:]) + 1  # Extract last 5 digits and increment
            except (ValueError, IndexError):
                sequence = 1
        else:
            # First teacher for this year
            sequence = 1
        
        # Format: TCH + YEAR + 5-digit sequence
        return f"{prefix}{sequence:05d}"
    
    def has_permission(self, permission):
        """Check if current user has a specific permission"""
        if not self.current_user:
            return False
        
        user_role = self.current_user.get('role', '')
        
        # Admin has UNLIMITED ACCESS to EVERYTHING - no restrictions whatsoever
        if user_role == 'admin':
            return True
        
        # ALL NON-ADMIN USERS ARE RESTRICTED - Check database permissions only
        user_permissions = self.current_user.get('permissions', [])
        
        # Convert comma-separated permissions string to list if needed
        if isinstance(user_permissions, str):
            user_permissions = user_permissions.split(',') if user_permissions else []
        
        # Check if user has specific permission or all_permissions
        return (permission in user_permissions or 
                'all_permissions' in user_permissions)
    
    def create_responsive_window(self, parent, title, base_width, base_height, 
                                 min_width=None, min_height=None, 
                                 max_width=None, max_height=None):
        """
        Create a responsive window with calculated dimensions
        
        Args:
            parent: Parent window
            title: Window title
            base_width: Base width for standard screens
            base_height: Base height for standard screens
            min_width: Minimum width (optional)
            min_height: Minimum height (optional)
            max_width: Maximum width (optional)
            max_height: Maximum height (optional)
            
        Returns:
            Toplevel window instance
        """
        window = tk.Toplevel(parent)
        window.title(title)
        
        # Calculate responsive dimensions
        width, height = ResponsiveManager.calculate_window_size(
            base_width, base_height, min_width, min_height, max_width, max_height
        )
        
        window.geometry(f"{width}x{height}")
        
        # Set minimum and maximum sizes if provided
        if min_width and min_height:
            window.minsize(min_width, min_height)
        if max_width and max_height:
            window.maxsize(max_width, max_height)
        
        # Center the window
        window.update_idletasks()
        screen_width = window.winfo_screenwidth()
        screen_height = window.winfo_screenheight()
        x = (screen_width - width) // 2
        y = (screen_height - height) // 2
        window.geometry(f"{width}x{height}+{x}+{y}")
        
        return window
    
    def bind_treeview_mousewheel(self, treeview):
        """Bind mouse wheel scrolling to a treeview widget"""
        def _on_mousewheel(event):
            # Scroll the treeview
            treeview.yview_scroll(int(-1 * (event.delta / 120)), "units")
        
        def _on_mousewheel_linux_up(event):
            # Linux scroll up
            treeview.yview_scroll(-1, "units")
        
        def _on_mousewheel_linux_down(event):
            # Linux scroll down
            treeview.yview_scroll(1, "units")
        
        # Bind mouse wheel events
        treeview.bind("<MouseWheel>", _on_mousewheel)  # Windows and MacOS
        treeview.bind("<Button-4>", _on_mousewheel_linux_up)  # Linux scroll up
        treeview.bind("<Button-5>", _on_mousewheel_linux_down)  # Linux scroll down
        
        # Also bind when mouse enters the treeview area
        def _on_enter(event):
            treeview.bind_all("<MouseWheel>", _on_mousewheel)
            treeview.bind_all("<Button-4>", _on_mousewheel_linux_up)
            treeview.bind_all("<Button-5>", _on_mousewheel_linux_down)
        
        def _on_leave(event):
            treeview.unbind_all("<MouseWheel>")
            treeview.unbind_all("<Button-4>")
            treeview.unbind_all("<Button-5>")
        
        treeview.bind("<Enter>", _on_enter)
        treeview.bind("<Leave>", _on_leave)
    
    def on_window_resize(self, event):
        """Handle window resize events to maintain responsive layout"""
        # Only process resize events for the main window
        if event.widget != self.root:
            return
        
        # Get current window size
        current_width = event.width
        current_height = event.height
        
        # Only update if size changed significantly (more than 50 pixels)
        if (abs(current_width - self.last_width) > 50 or 
            abs(current_height - self.last_height) > 50):
            
            self.last_width = current_width
            self.last_height = current_height
            
            # Update any dynamic content that needs adjustment
            # This can be expanded based on specific needs
            if hasattr(self, 'content_frame') and self.content_frame.winfo_exists():
                self.content_frame.update_idletasks()
    
    def check_permission_or_show_error(self, permission, feature_name):
        """Check permission and show error if denied"""
        # Admin has unlimited access - skip all permission checks
        if self.current_user and self.current_user.get('role') == 'admin':
            return True
            
        if not self.has_permission(permission):
            messagebox.showerror("Access Denied", 
                               f"You don't have permission to access {feature_name}.\n"
                               f"Required permission: {permission}\n"
                               f"Your role: {self.current_user.get('role', 'unknown')}")
            return False
        return True
    
    def logout(self):
        """Logout current user and return to login screen"""
        if messagebox.askyesno("Logout", "Are you sure you want to logout?"):
            # Reset user info to guest state
            self.current_user = {
                'username': 'guest', 'full_name': 'Please Login', 'role': 'guest',
                'permissions': []
            }
            # Update header to show logged out state
            self.update_header_user_info()
            # Return to login screen
            self.root.withdraw()
            LoginWindow(self.root, self.on_login_success)
    
    def on_login_success(self, user_info):
        """Callback when login is successful"""
        self.current_user = user_info
        # Update window title with user info
        self.root.title(f"Gaybeck Starkids Academy - {user_info['full_name']} ({user_info['role'].title()})")
        
        # Update header user information
        self.update_header_user_info()
        
        # Recreate navigation to reflect new permissions
        if hasattr(self, 'nav_frame'):
            self.nav_frame.destroy()
        if hasattr(self, 'content_frame'):
            self.content_frame.destroy()
        
        # Recreate navigation and content frame
        self.create_navigation()
        
        # Create main content frame
        self.content_frame = tk.Frame(self.content_container, bg='#ffffff', relief=tk.FLAT, bd=0)
        self.content_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)
        
        # Special handling for teachers - show class selection first
        if user_info['role'] == 'teacher':
            self.show_teacher_class_selection()
        elif self.has_permission('dashboard'):
            self.show_dashboard()
        else:
            self.show_no_access_screen()
    
    def create_header(self):
        # Modern gradient-style header with responsive sizing
        header_height = ResponsiveManager.scale_padding(120)
        header_frame = tk.Frame(self.main_frame, bg='#1e3a5f', height=header_height)
        header_frame.pack(fill=tk.X, pady=(0, ResponsiveManager.scale_padding(15)))
        header_frame.pack_propagate(False)
        
        # Logo section (leftmost)
        logo_section = tk.Frame(header_frame, bg='#1e3a5f')
        logo_section.pack(side=tk.LEFT, fill=tk.Y, 
                         padx=(ResponsiveManager.scale_padding(20), ResponsiveManager.scale_padding(10)), 
                         pady=ResponsiveManager.scale_padding(15))
        
        # Load and display logo
        try:
            if os.path.exists('logo.png') and PIL_AVAILABLE:
                logo_img = Image.open('logo.png')
                # Resize logo to fit header (80x80 pixels)
                logo_img = logo_img.resize((80, 80), Image.Resampling.LANCZOS)
                self.header_logo = ImageTk.PhotoImage(logo_img)
                
                logo_label = tk.Label(logo_section, image=self.header_logo, bg='#1e3a5f')
                logo_label.pack()
        except Exception as e:
            print(f"Could not load header logo: {e}")
        
        # Left section with title and subtitle
        left_section = tk.Frame(header_frame, bg='#1e3a5f')
        left_section.pack(side=tk.LEFT, fill=tk.Y, 
                         padx=ResponsiveManager.scale_padding(15), 
                         pady=ResponsiveManager.scale_padding(15))
        
        title_label = tk.Label(left_section, text="Gaybeck Starkids Academy", 
                              font=('Segoe UI', ResponsiveManager.scale_font_size(28), 'bold'), 
                              bg='#1e3a5f', fg='#ffffff')
        title_label.pack(anchor=tk.W)
        
        subtitle_label = tk.Label(left_section, text="Complete School Administration Solution", 
                                 font=('Segoe UI', ResponsiveManager.scale_font_size(11)), 
                                 bg='#1e3a5f', fg='#a8c7e8')
        subtitle_label.pack(anchor=tk.W, pady=(5,0))
        
        # Center section with user info
        center_section = tk.Frame(header_frame, bg='#1e3a5f')
        center_section.pack(side=tk.LEFT, fill=tk.Y, 
                           padx=ResponsiveManager.scale_padding(50), 
                           pady=ResponsiveManager.scale_padding(15), expand=True)
        
        # User info
        self.user_info_frame = tk.Frame(center_section, bg='#2c5281', relief='solid', bd=1)
        self.user_info_frame.pack(anchor=tk.CENTER)
        
        self.user_label = tk.Label(self.user_info_frame, text=f"{self.current_user.get('full_name', 'User')}", 
                             font=('Segoe UI', ResponsiveManager.scale_font_size(12), 'bold'), 
                             bg='#2c5281', fg='#ffffff')
        self.user_label.pack(padx=ResponsiveManager.scale_padding(15), 
                           pady=(ResponsiveManager.scale_padding(8), ResponsiveManager.scale_padding(2)))
        
        # Show role with special indication for admin
        role_text = f"Role: {self.current_user.get('role', 'Unknown').title()}"
        if self.current_user.get('role') == 'admin':
            role_text += " (UNLIMITED ACCESS)"
        elif self.current_user.get('stored_role'):
            # Show both selected and stored role for non-admin users
            stored_role = self.current_user.get('stored_role', '').title()
            role_text += f" (Account: {stored_role})"
            
        self.role_label = tk.Label(self.user_info_frame, text=role_text, 
                             font=('Segoe UI', ResponsiveManager.scale_font_size(9)), 
                             bg='#2c5281', fg='#a8c7e8')
        self.role_label.pack(padx=ResponsiveManager.scale_padding(15), 
                           pady=(0, ResponsiveManager.scale_padding(8)))
        
        # Right section with date, time and logout
        right_section = tk.Frame(header_frame, bg='#1e3a5f')
        right_section.pack(side=tk.RIGHT, fill=tk.Y, padx=25, pady=15)
        
        today = datetime.now()
        date_str = today.strftime("%A, %B %d, %Y")
        time_str = today.strftime("%I:%M %p")
        
        date_label = tk.Label(right_section, text=date_str, 
                             font=('Segoe UI', 14, 'bold'), bg='#1e3a5f', fg='#ffffff')
        date_label.pack(anchor=tk.E)
        
        time_label = tk.Label(right_section, text=time_str, 
                             font=('Segoe UI', 12), bg='#1e3a5f', fg='#a8c7e8')
        time_label.pack(anchor=tk.E, pady=(2,8))
        
        # Logout button
        logout_btn = tk.Button(right_section, text="Logout", command=self.logout,
                              font=('Segoe UI', 9, 'bold'), bg='#dc3545', fg='white',
                              relief='solid', bd=0, padx=15, pady=5, cursor='hand2')
        logout_btn.pack(anchor=tk.E)
    
    def create_report_header(self, parent_frame, title, subtitle=""):
        """Create a consistent header with logo for all reports"""
        header_frame = tk.Frame(parent_frame, bg='#2c3e50')
        header_frame.pack(fill=tk.X, pady=(0, 20))
        
        # Header container with logo and text
        header_container = tk.Frame(header_frame, bg='#2c3e50')
        header_container.pack(fill=tk.X, padx=30, pady=20)
        
        # Logo on the left
        try:
            if os.path.exists('logo.png') and PIL_AVAILABLE:
                logo_img = Image.open('logo.png')
                logo_img = logo_img.resize((50, 50), Image.Resampling.LANCZOS)
                # Store as instance variable to prevent garbage collection
                if not hasattr(self, '_report_logos'):
                    self._report_logos = []
                report_logo = ImageTk.PhotoImage(logo_img)
                self._report_logos.append(report_logo)
                
                logo_label = tk.Label(header_container, image=report_logo, bg='#2c3e50')
                logo_label.image = report_logo  # Keep reference
                logo_label.pack(side=tk.LEFT, padx=(0, 15))
        except Exception as e:
            print(f"Could not load report logo: {e}")
        
        # Text content on the right
        text_frame = tk.Frame(header_container, bg='#2c3e50')
        text_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        tk.Label(text_frame, text="GAYBECK STARKIDS ACADEMY",
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#2c3e50').pack(anchor=tk.W)
        
        tk.Label(text_frame, text=title,
                font=('Segoe UI', 18, 'bold'), fg='white', bg='#2c3e50').pack(anchor=tk.W, pady=(5, 0))
        
        if subtitle:
            tk.Label(text_frame, text=subtitle,
                    font=('Segoe UI', 11), fg='#bdc3c7', bg='#2c3e50').pack(anchor=tk.W, pady=(3, 0))
        
        return header_frame
    
    def update_header_user_info(self):
        """Update the header to display current user information"""
        if hasattr(self, 'user_label') and hasattr(self, 'role_label'):
            # Update user name
            self.user_label.configure(text=f"{self.current_user.get('full_name', 'User')}")
            
            # Update role with special indication for admin
            role_text = f"Role: {self.current_user.get('role', 'Unknown').title()}"
            if self.current_user.get('role') == 'admin':
                role_text += " (UNLIMITED ACCESS)"
            elif self.current_user.get('stored_role'):
                # Show both selected and stored role for non-admin users
                stored_role = self.current_user.get('stored_role', '').title()
                role_text += f" (Account: {stored_role})"
                
            self.role_label.configure(text=role_text)
    
    def create_dashboard(self):
        dashboard_frame = tk.Frame(self.main_frame, bg='#ffffff', height=150)
        dashboard_frame.pack(fill=tk.X, pady=(0, 20))
        dashboard_frame.pack_propagate(False)
        
        # Dashboard title
        dashboard_title = tk.Label(dashboard_frame, text="Today's Overview", 
                                  font=('Arial', 16, 'bold'), bg='#ffffff')
        dashboard_title.pack(anchor=tk.W, padx=20, pady=10)
        
        # Dashboard metrics
        metrics_frame = tk.Frame(dashboard_frame, bg='#ffffff')
        metrics_frame.pack(fill=tk.X, padx=20, pady=10)
        
        # Student attendance metric
        self.students_present_var = tk.StringVar(value="0")
        student_metric = self.create_metric_card(metrics_frame, "Students Present", 
                                                self.students_present_var, 0)
        student_metric.pack(side=tk.LEFT, padx=10)
        
        # Feeding fee collected metric
        self.feeding_fee_var = tk.StringVar(value="GHS 0.00")
        feeding_metric = self.create_metric_card(metrics_frame, "Feeding Fee Collected", 
                                                self.feeding_fee_var, 1)
        feeding_metric.pack(side=tk.LEFT, padx=10)
        
        # Bus fee collected metric
        self.bus_fee_var = tk.StringVar(value="GHS 0.00")
        bus_metric = self.create_metric_card(metrics_frame, "Bus Fee Collected", 
                                            self.bus_fee_var, 2)
        bus_metric.pack(side=tk.LEFT, padx=10)
        
        # Total revenue metric
        self.total_revenue_var = tk.StringVar(value="GHS 0.00")
        total_metric = self.create_metric_card(metrics_frame, "Total Revenue", 
                                              self.total_revenue_var, 3)
        total_metric.pack(side=tk.LEFT, padx=10)
    
    def create_metric_card(self, parent, title, value_var, index):
        # Modern card design with clean styling
        colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12']
        text_colors = ['#ffffff', '#ffffff', '#ffffff', '#ffffff']
        
        # Card container with subtle shadow
        card_container = tk.Frame(parent, bg='#ffffff', relief=tk.FLAT, bd=0)
        card_container.pack_propagate(False)
        
        # Shadow effect
        shadow = tk.Frame(card_container, bg='#dee2e6', width=220, height=112, relief=tk.FLAT, bd=0)
        shadow.place(x=2, y=2)
        shadow.pack_propagate(False)
        
        # Main card
        card = tk.Frame(card_container, bg=colors[index], width=220, height=110, 
                       relief=tk.FLAT, bd=0)
        card.place(x=0, y=0)
        card.pack_propagate(False)
        
        # Card content
        content_frame = tk.Frame(card, bg=colors[index], relief=tk.FLAT, bd=0)
        content_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        title_label = tk.Label(content_frame, text=title, font=('Segoe UI', 11, 'bold'), 
                              bg=colors[index], fg=text_colors[index])
        title_label.pack(anchor=tk.W)
        
        value_label = tk.Label(content_frame, textvariable=value_var, 
                              font=('Segoe UI', 24, 'bold'), bg=colors[index], fg=text_colors[index])
        value_label.pack(anchor=tk.W, pady=(5, 0))
        
        # Add subtle hover effect
        def on_enter(e):
            shadow.place(x=4, y=4)  # Increase shadow offset
        def on_leave(e):
            shadow.place(x=2, y=2)  # Reset shadow
            
        card.bind("<Enter>", on_enter)
        card.bind("<Leave>", on_leave)
        content_frame.bind("<Enter>", on_enter)
        content_frame.bind("<Leave>", on_leave)
        
        return card_container
    
    def create_navigation(self):
        # Modern sidebar navigation with clean borders - wider for better visibility
        self.nav_frame = tk.Frame(self.content_container, bg='#2c3e50', width=320, relief=tk.FLAT, bd=0)
        self.nav_frame.pack(side=tk.LEFT, fill=tk.Y)
        self.nav_frame.pack_propagate(False)
        
        # Add subtle border separator
        border_frame = tk.Frame(self.content_container, bg='#bdc3c7', width=1)
        border_frame.pack(side=tk.LEFT, fill=tk.Y)
        
        # Navigation title
        nav_title_text = "NAVIGATION"
        if self.current_user.get('role') == 'admin':
            nav_title_text += "\n(FULL ACCESS)"
            
        nav_title = tk.Label(self.nav_frame, text=nav_title_text, 
                            font=('Segoe UI', 11, 'bold'), bg='#2c3e50', fg='#bdc3c7')
        nav_title.pack(pady=(25, 20), padx=20)
        
        # Create scrollable container for navigation buttons with always-visible scrollbar
        nav_scroll_container = ScrollableFrame(self.nav_frame, always_show_scrollbar=True, bg='#2c3e50')
        nav_scroll_container.pack(fill=tk.BOTH, expand=True, padx=0, pady=0)
        nav_buttons_container = nav_scroll_container.get_frame()
        
        # Set focus to canvas to enable keyboard scrolling
        nav_scroll_container.canvas.focus_set()
        
        # Navigation buttons with permission checks
        buttons = [
            ("📊   Dashboard", self.show_dashboard, "dashboard", True),  # Always available
            ("🏫   Class Management", self.show_class_management, "classes", "no_teacher"),  # Disabled for teachers
            ("🎓   Student Management", self.show_student_management, "students", None),
            ("👨‍🏫   Teacher Management", self.show_teacher_management, "teachers", None),
            ("💵   Fees Management", self.show_fees_management, "fees", None),
            ("📊   Financial Management", self.show_financial_management, "financial_management", None),  # Income & Expense Management
            ("✅   Attendance", self.show_attendance, "attendance", None),
            ("🧠   AI Insights", self.show_ai_insights, "ai_insights", None),  # AI predictions
            ("📈   AI Reports", self.show_ai_report_assistant, "ai_reports", None),  # AI report generator
            ("⚙️   Settings", self.show_settings, "settings", "admin")  # Admin only - System Settings
        ]
        
        self.nav_buttons = []
        for text, command, permission, special in buttons:
            # Check permissions - DEFAULT TO DENY ACCESS
            show_button = False
            
            # ADMIN GETS ABSOLUTE ACCESS TO ALL BUTTONS
            if self.current_user and self.current_user.get('role') == 'admin':
                show_button = True  # Admin sees everything, no exceptions
            elif special == "admin":
                show_button = False  # Non-admin cannot see admin-only buttons
            elif special == "no_teacher" and self.current_user and self.current_user.get('role') == 'teacher':
                show_button = False  # Teachers cannot see class management
            elif special is True and self.has_permission(permission):
                # Dashboard and other "always available" still need permission
                show_button = True
            elif self.has_permission(permission):
                # All other buttons require explicit permission
                show_button = True
            
            if show_button:
                btn_frame = tk.Frame(nav_buttons_container, bg='#2c3e50', relief=tk.FLAT, bd=0)
                btn_frame.pack(fill=tk.X, padx=15, pady=3)
                
                btn = tk.Button(btn_frame, text=text, font=('Segoe UI', 12), 
                               bg='#34495e', fg='#ecf0f1', relief=tk.FLAT, 
                               activebackground='#3498db', activeforeground='white',
                               bd=0, padx=25, pady=15, anchor='w',
                               command=lambda cmd=command, perm=permission, name=text: self.navigate_with_permission(cmd, perm, name))
                btn.pack(fill=tk.X)
                # Store command reference for later identification
                btn.command_func = command
                self.nav_buttons.append(btn)
                
                # Bind mouse wheel to scroll the navigation (propagate to parent canvas)
                def on_nav_mousewheel(event):
                    if nav_scroll_container.canvas.winfo_exists():
                        nav_scroll_container.canvas.yview_scroll(int(-1 * (event.delta / 120)), "units")
                
                btn.bind("<MouseWheel>", on_nav_mousewheel)
                btn_frame.bind("<MouseWheel>", on_nav_mousewheel)
                
                # Modern hover effects
                btn.bind("<Enter>", lambda e, b=btn: b.configure(bg='#3498db', cursor='hand2'))
                btn.bind("<Leave>", lambda e, b=btn: b.configure(bg='#34495e') if b != getattr(self, 'active_nav_btn', None) else None)
        
        # Update scroll region after all buttons are added
        nav_scroll_container.update_scrollregion()
        
        # Set dashboard as active initially if available
        if self.nav_buttons:
            self.active_nav_btn = self.nav_buttons[0]
            self.nav_buttons[0].configure(bg='#3498db')
    
    def navigate_with_permission(self, command, permission, feature_name):
        """Navigate with permission check"""
        # ADMIN HAS UNLIMITED ACCESS - ALWAYS ALLOW
        if self.current_user and self.current_user.get('role') == 'admin':
            # Admin bypasses ALL permission checks - direct access
            self.set_active_nav(command)
            return
        
        # For non-admin users, check permissions
        if permission == "dashboard" or self.has_permission(permission):
            self.set_active_nav(command)
        else:
            self.check_permission_or_show_error(permission, feature_name)
    
    def get_teacher_assigned_class(self):
        """Get the class assigned to current teacher"""
        if self.current_user.get('role') != 'teacher':
            return None
        
        try:
            # First, try to get teacher by exact full_name match
            full_name = self.current_user.get('full_name')
            self.cursor.execute('''
                SELECT class_id FROM teachers 
                WHERE name = ?
            ''', (full_name,))
            
            result = self.cursor.fetchone()
            if result and result[0]:
                return result[0]
            
            # If not found, try username-based lookup
            username = self.current_user.get('username')
            self.cursor.execute('''
                SELECT class_id FROM teachers 
                WHERE LOWER(name) LIKE ? OR LOWER(email) LIKE ?
            ''', (f'%{username}%', f'%{username}%'))
            
            result = self.cursor.fetchone()
            if result and result[0]:
                return result[0]
                
            # If still not found, check if user's username matches a teacher record
            self.cursor.execute('''
                SELECT t.class_id 
                FROM teachers t
                JOIN users u ON LOWER(t.name) = LOWER(u.full_name)
                WHERE u.username = ?
            ''', (username,))
            
            result = self.cursor.fetchone()
            return result[0] if result and result[0] else None
            
        except Exception as e:
            print(f"Error getting teacher assigned class: {e}")
            return None
    
    def is_teacher_authorized_for_student(self, student_class_id):
        """Check if teacher is authorized to manage this student"""
        if self.current_user.get('role') == 'admin':
            return True
        
        if self.current_user.get('role') == 'teacher':
            teacher_class = self.get_teacher_assigned_class()
            return teacher_class == student_class_id
        
        return False
    
    def set_active_nav(self, command):
        # Reset all buttons to inactive state
        for btn in self.nav_buttons:
            btn.configure(bg='#34495e', fg='#ecf0f1')
        
        # Find the button that matches the command
        active_btn = None
        for btn in self.nav_buttons:
            if hasattr(btn, 'command_func') and btn.command_func == command:
                active_btn = btn
                break
        
        # Set active button style
        if active_btn:
            active_btn.configure(bg='#3498db', fg='white')
            self.active_nav_btn = active_btn
        
        # Update status bar with appropriate message
        status_messages = {
            self.show_dashboard: "Dashboard - Overview",
            self.show_class_management: "Class Management - Organize Classes",
            self.show_student_management: "Student Management - Student Records",
            self.show_teacher_management: "Teacher Management - Staff Records",
            self.show_fees_management: "Fees Management - Financial Records",
            self.show_financial_management: "Financial Management - Income & Expense Tracking",
            self.show_attendance: "Attendance - Daily Tracking",
            self.show_user_management: "User Management - Account Administration",
            self.show_database_view: "Database View - Raw Data"
        }
        
        if command in status_messages and hasattr(self, 'update_status'):
            self.update_status(status_messages[command])
        
        # Execute the command
        command()
    
    def show_no_access_screen(self):
        """Show access denied screen for users without permissions"""
        self.clear_content_frame()
        
        # Create centered access denied message
        access_frame = tk.Frame(self.content_frame, bg='#ffffff')
        access_frame.pack(expand=True, fill='both')
        
        # Center container
        center_frame = tk.Frame(access_frame, bg='#ffffff')
        center_frame.pack(expand=True, fill='both')
        center_frame.grid_rowconfigure(0, weight=1)
        center_frame.grid_rowconfigure(2, weight=1)
        center_frame.grid_columnconfigure(0, weight=1)
        center_frame.grid_columnconfigure(2, weight=1)
        
        # Content container
        content_container = tk.Frame(center_frame, bg='#f8f9fa', relief='solid', bd=1)
        content_container.grid(row=1, column=1, padx=50, pady=50)
        
        # Access denied content
        icon_label = tk.Label(content_container, text="🏫", font=('Arial', 72), bg='#f8f9fa')
        icon_label.pack(pady=(30, 10))
        
        title_label = tk.Label(content_container, text="Access Restricted", 
                              font=('Segoe UI', 24, 'bold'), fg='#e74c3c', bg='#f8f9fa')
        title_label.pack(pady=(0, 10))
        
        message_label = tk.Label(content_container, 
                                text=f"Hello {self.current_user.get('full_name', 'User')},\n\n" +
                                     f"Your account ({self.current_user.get('role', 'unknown')} role) currently has no system permissions.\n" +
                                     "Please contact your administrator to request access to modules.\n\n" +
                                     "Only administrators can assign permissions to user accounts.",
                                font=('Segoe UI', 12), fg='#2c3e50', bg='#f8f9fa',
                                justify='center')
        message_label.pack(pady=(0, 20), padx=40)
        
        # Contact info
        contact_frame = tk.Frame(content_container, bg='#e9ecef', relief='solid', bd=1)
        contact_frame.pack(fill='x', padx=20, pady=(0, 30))
        
        contact_label = tk.Label(contact_frame, 
                               text="Administrator Contact: admin@school.com",
                               font=('Segoe UI', 10, 'italic'), fg='#6c757d', bg='#e9ecef')
        contact_label.pack(pady=10)
    
    def show_teacher_class_selection(self):
        """Show class selection screen for teachers"""
        self.clear_content_frame()
        
        # Create main container
        main_container = tk.Frame(self.content_frame, bg='#f8f9fa')
        main_container.pack(fill='both', expand=True, padx=30, pady=30)
        
        # Header section
        header_frame = tk.Frame(main_container, bg='#ffffff', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 20))
        
        header_content = tk.Frame(header_frame, bg='#ffffff')
        header_content.pack(fill='both', padx=30, pady=20)
        
        subtitle_label = tk.Label(header_content, 
                                 text="Select from available classes created by admin to manage classroom activities", 
                                 font=('Segoe UI', 12), fg='#6c757d', bg='#ffffff')
        subtitle_label.pack(anchor='w', pady=(5, 0))
        
        # Class selection section
        selection_frame = tk.Frame(main_container, bg='#ffffff', relief='solid', bd=1)
        selection_frame.pack(fill='both', expand=True)
        
        selection_content = tk.Frame(selection_frame, bg='#ffffff')
        selection_content.pack(fill='both', expand=True, padx=40, pady=30)
        
        # Class selection label
        class_label = tk.Label(selection_content, text="Select Your Assigned Class:", 
                              font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#ffffff')
        class_label.pack(anchor='w', pady=(0, 15))
        
        # Class dropdown
        self.selected_class = tk.StringVar()
        class_frame = tk.Frame(selection_content, bg='#ffffff')
        class_frame.pack(fill='x', pady=(0, 20))
        
        # Get available classes (you can modify this to get from database)
        classes = self.get_teacher_assigned_classes()
        
        class_dropdown = ttk.Combobox(class_frame, textvariable=self.selected_class, 
                                     values=classes, font=('Segoe UI', 12), 
                                     state='readonly', width=30)
        class_dropdown.pack(anchor='w')
        
        # Bind callback for class selection change
        class_dropdown.bind('<<ComboboxSelected>>', self.on_class_selection_changed)
        
        if classes:
            class_dropdown.current(0)  # Select first class by default
        
        # Continue button
        continue_btn = tk.Button(selection_content, text="Continue to Class Management", 
                                command=self.load_teacher_dashboard,
                                font=('Segoe UI', 12, 'bold'), bg='#28a745', fg='white',
                                relief='solid', bd=0, padx=30, pady=10, cursor='hand2')
        continue_btn.pack(anchor='w', pady=(20, 0))
        
        # Class info section
        info_frame = tk.Frame(selection_content, bg='#e9ecef', relief='solid', bd=1)
        info_frame.pack(fill='x', pady=(30, 0))
        
        info_content = tk.Frame(info_frame, bg='#e9ecef')
        info_content.pack(fill='both', padx=20, pady=15)
        
        info_label = tk.Label(info_content, text="ℹ️ Teacher Dashboard Features:", 
                             font=('Segoe UI', 12, 'bold'), fg='#495057', bg='#e9ecef')
        info_label.pack(anchor='w')
        
        features_text = """• View all students in your selected class with complete information
• Track attendance and manage student records (read-only access to financial info)
• Assign homework, tests, and lessons to students
• Grade assignments and record student performance
• Write remarks and comments for individual students
• Generate comprehensive reports and progress summaries
• Manage classroom activities (cannot create/edit classes - admin only)

Note: Classes are created and managed by administrators. Teachers can only select from existing classes."""
        
        features_label = tk.Label(info_content, text=features_text, 
                                 font=('Segoe UI', 10), fg='#6c757d', bg='#e9ecef',
                                 justify='left')
        features_label.pack(anchor='w', pady=(5, 0))
    
    def get_teacher_assigned_classes(self):
        """Get classes from the database that are assigned to the current teacher or available classes"""
        try:
            # First, try to get classes assigned to the current teacher
            teacher_username = self.current_user.get('username')
            
            # Query to get classes (either assigned to teacher or all available classes)
            self.cursor.execute('''
                SELECT c.id, c.class_name, c.capacity, c.current_students
                FROM classes c
                LEFT JOIN users u ON c.class_teacher_id = u.id
                WHERE u.username = ? OR c.class_teacher_id IS NULL
                ORDER BY c.class_name
            ''', (teacher_username,))
            
            assigned_classes = self.cursor.fetchall()
            
            if not assigned_classes:
                # If no classes assigned to teacher, get all available classes
                self.cursor.execute('''
                    SELECT id, class_name, capacity, current_students
                    FROM classes
                    ORDER BY class_name
                ''')
                assigned_classes = self.cursor.fetchall()
            
            if assigned_classes:
                # Format class names with student count info
                class_list = []
                for class_id, class_name, capacity, current_students in assigned_classes:
                    class_display = f"{class_name} ({current_students}/{capacity} students)"
                    class_list.append(class_display)
                return class_list
            else:
                # If no classes exist in database, return message
                return ["No classes available - Contact admin to create classes"]
                
        except Exception as e:
            print(f"Error fetching classes: {e}")
            # Return sample classes as fallback
            return [
                "Sample Class A (15/30 students)",
                "Sample Class B (20/30 students)",
                "Contact admin to set up actual classes"
            ]
    
    def load_teacher_dashboard(self):
        """Load the teacher dashboard with selected class"""
        if not self.selected_class.get():
            messagebox.showerror("Error", "Please select a class first!")
            return
            
        self.show_teacher_dashboard()
    
    def show_teacher_dashboard(self):
        """Show comprehensive teacher dashboard"""
        self.clear_content_frame()
        
        # Create scrollable main container
        scrollable_frame = ScrollableFrame(self.content_frame, bg='#f8f9fa')
        scrollable_frame.pack(fill='both', expand=True)
        main_frame = scrollable_frame.scrollable_frame
        
        # Dashboard header
        self.create_teacher_header(main_frame)
        
        # Main dashboard content
        content_container = tk.Frame(main_frame, bg='#f8f9fa')
        content_container.pack(fill='both', expand=True, padx=20, pady=(0, 20))
        
        # Create notebook for different sections
        self.teacher_notebook = ttk.Notebook(content_container)
        self.teacher_notebook.pack(fill='both', expand=True)
        
        # Add tabs for different functionalities
        self.create_student_management_tab()
        self.create_assignments_tab()
        self.create_grades_tab()
        self.create_reports_tab()
        
        # Load all module data for the selected class
        self.refresh_all_module_data()
    
    def refresh_all_module_data(self):
        """Refresh data for all modules when class is selected"""
        try:
            # Load data for all modules
            self.load_homework_data()
            self.load_tests_data()
            self.load_lesson_plans_data()
            self.load_projects_data()
            self.load_timetable_data()
        except Exception as e:
            print(f"Error refreshing module data: {e}")
        
    def create_teacher_header(self, parent):
        """Create teacher dashboard header"""
        header_frame = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        header_frame.pack(fill='x', padx=20, pady=20)
        
        header_content = tk.Frame(header_frame, bg='#ffffff')
        header_content.pack(fill='both', padx=30, pady=20)
        
        # Title section
        title_frame = tk.Frame(header_content, bg='#ffffff')
        title_frame.pack(fill='x', pady=(15, 0))
        
        class_name = self.selected_class.get() if hasattr(self, 'selected_class') else "Selected Class"
        title_label = tk.Label(title_frame, 
                              text=f"👨‍📚 Class Management: {class_name}", 
                              font=('Segoe UI', 18, 'bold'), fg='#2c3e50', bg='#ffffff')
        title_label.pack(side='left')
        
        # Action buttons
        btn_frame = tk.Frame(title_frame, bg='#ffffff')
        btn_frame.pack(side='right')
        
        change_class_btn = tk.Button(btn_frame, text="Change Class", 
                                    command=self.show_teacher_class_selection,
                                    font=('Segoe UI', 10), bg='#6c757d', fg='white',
                                    relief='solid', bd=0, padx=15, pady=5)
        change_class_btn.pack(side='right', padx=(10, 0))
        
        refresh_btn = tk.Button(btn_frame, text="Refresh Data", 
                               command=self.refresh_teacher_data,
                               font=('Segoe UI', 10), bg='#17a2b8', fg='white',
                               relief='solid', bd=0, padx=15, pady=5)
        refresh_btn.pack(side='right')
    
    def create_student_management_tab(self):
        """Create student management tab"""
        student_frame = ttk.Frame(self.teacher_notebook)
        self.teacher_notebook.add(student_frame, text="👥 Students & Attendance")
        
        # Create scrollable content
        scrollable_students = ScrollableFrame(student_frame, bg='#ffffff')
        scrollable_students.pack(fill='both', expand=True, padx=10, pady=10)
        students_content = scrollable_students.scrollable_frame
        
        # Students header
        header_frame = tk.Frame(students_content, bg='#e9ecef', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 15))
        
        header_label = tk.Label(header_frame, text="ℹ️ Class Students Overview", 
                               font=('Segoe UI', 14, 'bold'), fg='#495057', bg='#e9ecef')
        header_label.pack(pady=10)
        
        # Students list with detailed information
        self.create_students_list(students_content)
    
    def create_assignments_tab(self):
        """Create assignments management tab"""
        assignments_frame = ttk.Frame(self.teacher_notebook)
        self.teacher_notebook.add(assignments_frame, text="📝 Assignments & Tests")
        
        # Create scrollable content
        scrollable_assignments = ScrollableFrame(assignments_frame, bg='#ffffff')
        scrollable_assignments.pack(fill='both', expand=True, padx=10, pady=10)
        assignments_content = scrollable_assignments.scrollable_frame
        
        # Assignments management interface
        self.create_assignments_interface(assignments_content)
    
    def create_grades_tab(self):
        """Create grades management tab"""
        grades_frame = ttk.Frame(self.teacher_notebook)
        self.teacher_notebook.add(grades_frame, text="📊 Grades & Performance")
        
        # Create scrollable content
        scrollable_grades = ScrollableFrame(grades_frame, bg='#ffffff')
        scrollable_grades.pack(fill='both', expand=True, padx=10, pady=10)
        grades_content = scrollable_grades.scrollable_frame
        
        # Grades management interface
        self.create_grades_interface(grades_content)
    
    def create_reports_tab(self):
        """Create reports generation tab"""
        reports_frame = ttk.Frame(self.teacher_notebook)
        self.teacher_notebook.add(reports_frame, text="📋 Reports & Analytics")
        
        # Create scrollable content
        scrollable_reports = ScrollableFrame(reports_frame, bg='#ffffff')
        scrollable_reports.pack(fill='both', expand=True, padx=10, pady=10)
        reports_content = scrollable_reports.scrollable_frame
        
        # Reports interface
        self.create_reports_interface(reports_content)
    
    def create_students_list(self, parent):
        """Create detailed students list with information"""
        # Sample student data (in real implementation, fetch from database)
        students_data = self.get_class_students_data()
        
        for i, student in enumerate(students_data):
            # Student card
            student_card = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
            student_card.pack(fill='x', pady=5, padx=10)
            
            # Student header
            header = tk.Frame(student_card, bg='#f8f9fa')
            header.pack(fill='x')
            
            # Student basic info
            info_frame = tk.Frame(header, bg='#f8f9fa')
            info_frame.pack(side='left', fill='y', padx=15, pady=10)
            
            name_label = tk.Label(info_frame, text=f"👤 {student['name']}", 
                                 font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#f8f9fa')
            name_label.pack(anchor='w')
            
            id_label = tk.Label(info_frame, text=f"ID: {student['id']} | Age: {student['age']}", 
                               font=('Segoe UI', 10), fg='#6c757d', bg='#f8f9fa')
            id_label.pack(anchor='w')
            
            # Action buttons
            actions_frame = tk.Frame(header, bg='#f8f9fa')
            actions_frame.pack(side='right', padx=15, pady=10)
            
            # Attendance button
            attendance_btn = tk.Button(actions_frame, text="✅ Attendance", 
                                     command=lambda s=student: self.manage_student_attendance(s),
                                     font=('Segoe UI', 9), bg='#28a745', fg='white',
                                     relief='solid', bd=0, padx=10, pady=3)
            attendance_btn.pack(side='right', padx=2)
            
            # Remarks button
            remarks_btn = tk.Button(actions_frame, text="📝 Remarks", 
                                  command=lambda s=student: self.write_student_remarks(s),
                                  font=('Segoe UI', 9), bg='#17a2b8', fg='white',
                                  relief='solid', bd=0, padx=10, pady=3)
            remarks_btn.pack(side='right', padx=2)
            
            # View profile button
            profile_btn = tk.Button(actions_frame, text="👤 Profile", 
                                  command=lambda s=student: self.view_student_profile(s),
                                  font=('Segoe UI', 9), bg='#6f42c1', fg='white',
                                  relief='solid', bd=0, padx=10, pady=3)
            profile_btn.pack(side='right', padx=2)
            
            # Student details section
            details_frame = tk.Frame(student_card, bg='#ffffff')
            details_frame.pack(fill='x', padx=15, pady=(0, 15))
            
            # Academic info
            academic_frame = tk.Frame(details_frame, bg='#ffffff')
            academic_frame.pack(side='left', fill='y')
            
            tk.Label(academic_frame, text="📊 Academic Status:", 
                    font=('Segoe UI', 10, 'bold'), fg='#495057', bg='#ffffff').pack(anchor='w')
            tk.Label(academic_frame, text=f"Current Grade: {student['grade']}", 
                    font=('Segoe UI', 9), fg='#6c757d', bg='#ffffff').pack(anchor='w')
            tk.Label(academic_frame, text=f"Attendance: {student['attendance']}%", 
                    font=('Segoe UI', 9), fg='#6c757d', bg='#ffffff').pack(anchor='w')
            
            # Financial info
            financial_frame = tk.Frame(details_frame, bg='#ffffff')
            financial_frame.pack(side='right', fill='y', padx=50)
            
            tk.Label(financial_frame, text="💳 Fees Status:", 
                    font=('Segoe UI', 10, 'bold'), fg='#495057', bg='#ffffff').pack(anchor='w')
            tk.Label(financial_frame, text=f"Total Fees: GHS {student['total_fees']:.2f}", 
                    font=('Segoe UI', 9), fg='#6c757d', bg='#ffffff').pack(anchor='w')
            tk.Label(financial_frame, text=f"Paid: GHS {student['paid_fees']:.2f}", 
                    font=('Segoe UI', 9), fg='#28a745', bg='#ffffff').pack(anchor='w')
            tk.Label(financial_frame, text=f"Outstanding: GHS {student['outstanding_fees']:.2f}", 
                    font=('Segoe UI', 9), fg='#dc3545', bg='#ffffff').pack(anchor='w')
    
    def create_assignments_interface(self, parent):
        """Create comprehensive classroom management interface"""
        # Create notebook for different modules
        modules_notebook = ttk.Notebook(parent)
        modules_notebook.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Homework Module
        homework_frame = ttk.Frame(modules_notebook)
        modules_notebook.add(homework_frame, text="ℹ️ Homework")
        self.create_homework_module(homework_frame)
        
        # Tests Module
        tests_frame = ttk.Frame(modules_notebook)
        modules_notebook.add(tests_frame, text="📝 Tests")
        self.create_tests_module(tests_frame)
        
        # Lesson Plans Module
        lessons_frame = ttk.Frame(modules_notebook)
        modules_notebook.add(lessons_frame, text="📖 Lesson Plans")
        self.create_lessons_module(lessons_frame)
        
        # Projects Module
        projects_frame = ttk.Frame(modules_notebook)
        modules_notebook.add(projects_frame, text="📁 Projects")
        self.create_projects_module(projects_frame)
        
        # Class Assignments Module
        assignments_frame = ttk.Frame(modules_notebook)
        modules_notebook.add(assignments_frame, text="📋 Class Tasks")
        self.create_class_assignments_module(assignments_frame)
        
        # Timetable Module
        timetable_frame = ttk.Frame(modules_notebook)
        modules_notebook.add(timetable_frame, text="⏰ Timetable")
        self.create_timetable_module(timetable_frame)
    
    def create_grades_interface(self, parent):
        """Create grades management interface"""
        # Header
        header_frame = tk.Frame(parent, bg='#e9ecef', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 20))
        
        header_label = tk.Label(header_frame, text="📊 Grades & Performance Management", 
                               font=('Segoe UI', 14, 'bold'), fg='#495057', bg='#e9ecef')
        header_label.pack(pady=15)
        
        # Grade entry section
        entry_frame = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        entry_frame.pack(fill='x', pady=(0, 20))
        
        entry_content = tk.Frame(entry_frame, bg='#ffffff')
        entry_content.pack(fill='both', padx=20, pady=15)
        
        # Grade entry form
        form_frame = tk.Frame(entry_content, bg='#ffffff')
        form_frame.pack(fill='x')
        
        # Student selection
        tk.Label(form_frame, text="Select Student:", 
                font=('Segoe UI', 10, 'bold'), fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.grade_student_var = tk.StringVar()
        student_dropdown = ttk.Combobox(form_frame, textvariable=self.grade_student_var,
                                       values=self.get_student_names(), font=('Segoe UI', 10),
                                       state='readonly', width=30)
        student_dropdown.pack(anchor='w', pady=(5, 15))
        
        # Assignment/Test selection
        tk.Label(form_frame, text="Select Assignment/Test:", 
                font=('Segoe UI', 10, 'bold'), fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.grade_assignment_var = tk.StringVar()
        assignment_dropdown = ttk.Combobox(form_frame, textvariable=self.grade_assignment_var,
                                          values=self.get_assignments_for_grading(), font=('Segoe UI', 10),
                                          state='readonly', width=30)
        assignment_dropdown.pack(anchor='w', pady=(5, 15))
        
        # Grade input
        grade_input_frame = tk.Frame(form_frame, bg='#ffffff')
        grade_input_frame.pack(fill='x', pady=(0, 15))
        
        tk.Label(grade_input_frame, text="Grade (0-100):", 
                font=('Segoe UI', 10, 'bold'), fg='#2c3e50', bg='#ffffff').pack(side='left')
        
        self.grade_value_var = tk.StringVar()
        grade_entry = tk.Entry(grade_input_frame, textvariable=self.grade_value_var,
                              font=('Segoe UI', 10), width=10)
        grade_entry.pack(side='left', padx=(10, 0))
        
        # Submit grade button
        submit_grade_btn = tk.Button(grade_input_frame, text="Submit Grade", 
                                   command=self.submit_grade,
                                   font=('Segoe UI', 10, 'bold'), bg='#28a745', fg='white',
                                   relief='solid', bd=0, padx=15, pady=5)
        submit_grade_btn.pack(side='left', padx=(20, 0))
        
        # Grades overview
        overview_frame = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        overview_frame.pack(fill='both', expand=True)
        
        overview_header = tk.Label(overview_frame, text="📈 Class Performance Overview", 
                                  font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#f8f9fa')
        overview_header.pack(fill='x', pady=10)
        
        # Performance statistics
        self.create_performance_stats(overview_frame)
    
    def create_reports_interface(self, parent):
        """Create reports generation interface"""
        # Header
        header_frame = tk.Frame(parent, bg='#e9ecef', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 20))
        
        header_label = tk.Label(header_frame, text="📋 Reports & Analytics Generation", 
                               font=('Segoe UI', 14, 'bold'), fg='#495057', bg='#e9ecef')
        header_label.pack(pady=15)
        
        # Report types
        reports_frame = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        reports_frame.pack(fill='both', expand=True)
        
        reports_content = tk.Frame(reports_frame, bg='#ffffff')
        reports_content.pack(fill='both', padx=20, pady=20)
        
        # Available reports
        report_types = [
            {
                'title': '📊 Class Performance Report',
                'description': 'Comprehensive overview of class academic performance',
                'action': self.generate_class_performance_report
            },
            {
                'title': '👥 Student Progress Reports',
                'description': 'Individual student progress and achievement summaries',
                'action': self.generate_student_progress_reports
            },
            {
                'title': '✅ Attendance Summary',
                'description': 'Class attendance patterns and statistics',
                'action': self.generate_attendance_report
            },
            {
                'title': '💳 Fees Status Report',
                'description': 'Financial status overview for all students',
                'action': self.generate_fees_report
            },
            {
                'title': '📝 Assignment Analytics',
                'description': 'Analysis of assignment completion and performance',
                'action': self.generate_assignment_analytics
            }
        ]
        
        for report in report_types:
            report_card = tk.Frame(reports_content, bg='#f8f9fa', relief='solid', bd=1)
            report_card.pack(fill='x', pady=10)
            
            card_content = tk.Frame(report_card, bg='#f8f9fa')
            card_content.pack(fill='both', padx=20, pady=15)
            
            title_label = tk.Label(card_content, text=report['title'], 
                                  font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#f8f9fa')
            title_label.pack(anchor='w')
            
            desc_label = tk.Label(card_content, text=report['description'], 
                                 font=('Segoe UI', 10), fg='#6c757d', bg='#f8f9fa')
            desc_label.pack(anchor='w', pady=(3, 10))
            
            generate_btn = tk.Button(card_content, text="Generate Report", 
                                   command=report['action'],
                                   font=('Segoe UI', 10, 'bold'), bg='#007bff', fg='white',
                                   relief='solid', bd=0, padx=20, pady=8)
            generate_btn.pack(anchor='w')
    
    # Helper methods for teacher functionality
    def get_class_students_data(self):
        """Get actual student data from the database for the selected class"""
        if not hasattr(self, 'selected_class') or not self.selected_class.get():
            return []
        
        try:
            # Extract class name from the dropdown selection (remove student count part)
            selected_class_text = self.selected_class.get()
            if selected_class_text == "No classes available - Contact admin to create classes":
                return []
                
            # Extract just the class name (before the parentheses)
            class_name = selected_class_text.split(' (')[0]
            
            # Get class ID first
            self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
            class_result = self.cursor.fetchone()
            
            if not class_result:
                return self.get_sample_students_data()  # Fallback to sample data
            
            class_id = class_result[0]
            
            # Get students in this class with their financial information
            self.cursor.execute('''
                SELECT s.student_id, s.name, s.date_of_birth, s.gender,
                       COALESCE(f.amount_due, 0) as total_fees,
                       COALESCE(f.payment_date, '') as last_payment,
                       s.id
                FROM students s
                LEFT JOIN fees f ON s.id = f.student_id
                WHERE s.class_id = ?
                ORDER BY s.name
            ''', (class_id,))
            
            students_data = []
            students = self.cursor.fetchall()
            
            for student in students:
                student_id, name, dob, gender, total_fees, last_payment, db_student_id = student
                
                # Calculate age from date_of_birth
                age = self.calculate_age(dob) if dob else "N/A"
                
                # Calculate attendance percentage (placeholder for now)
                attendance = self.get_student_attendance_percentage(db_student_id)
                
                # Get current grade (placeholder for now)
                grade = self.get_student_current_grade(db_student_id)
                
                # Calculate financial status using Ghana Cedi
                # Get comprehensive fee information from fees table
                total_fees_due, amount_paid, outstanding_fees = self.get_student_fees_summary(db_student_id)
                
                student_data = {
                    'id': student_id or f"ST{len(students_data)+1:03d}",
                    'name': name,
                    'age': age,
                    'grade': grade,
                    'attendance': attendance,
                    'total_fees': total_fees_due,
                    'paid_fees': amount_paid,
                    'outstanding_fees': outstanding_fees,
                    'gender': gender or "N/A",
                    'db_id': db_student_id
                }
                students_data.append(student_data)
            
            # If no students found in database, return sample data
            if not students_data:
                return self.get_sample_students_data()
                
            return students_data
            
        except Exception as e:
            print(f"Error fetching student data: {e}")
            return self.get_sample_students_data()
    
    def get_student_fees_summary(self, student_db_id):
        """Get comprehensive fees summary for a student in Ghana Cedi"""
        try:
            # Get total fees from fees table
            self.cursor.execute('''
                SELECT 
                    SUM(amount_due) as total_due,
                    SUM(amount_paid) as total_paid,
                    SUM(arrears) as total_arrears
                FROM fees 
                WHERE student_id = ?
            ''', (student_db_id,))
            
            result = self.cursor.fetchone()
            
            if result and result[0] is not None:
                total_due = float(result[0] or 0)
                total_paid = float(result[1] or 0)
                arrears = float(result[2] or 0)
                
                # Calculate outstanding as due minus paid plus arrears
                outstanding = total_due - total_paid + arrears
                outstanding = max(0, outstanding)  # Don't allow negative outstanding
                
                return total_due, total_paid, outstanding
            else:
                # If no fees record, use default Ghana Cedi amounts
                default_annual_fee = 3500.0  # GHS 3,500 annual fee
                default_paid = 2800.0       # GHS 2,800 paid
                default_outstanding = 700.0  # GHS 700 outstanding
                return default_annual_fee, default_paid, default_outstanding
                
        except Exception as e:
            print(f"Error calculating fees for student {student_db_id}: {e}")
            # Return default amounts in case of error
            return 3500.0, 2800.0, 700.0
    
    def calculate_age(self, date_of_birth):
        """Calculate age from date of birth"""
        try:
            from datetime import datetime
            if isinstance(date_of_birth, str):
                birth_date = datetime.strptime(date_of_birth, '%Y-%m-%d')
            else:
                birth_date = date_of_birth
            
            today = datetime.today()
            age = today.year - birth_date.year
            
            # Check if birthday has occurred this year
            if today.month < birth_date.month or (today.month == birth_date.month and today.day < birth_date.day):
                age -= 1
                
            return age
        except:
            return "N/A"
    
    def get_student_attendance_percentage(self, student_db_id):
        """Get student attendance percentage from database"""
        try:
            # Get attendance records for the current academic year
            self.cursor.execute('''
                SELECT 
                    COUNT(*) as total_days,
                    SUM(CASE WHEN status = 'present' THEN 1 ELSE 0 END) as present_days
                FROM attendance 
                WHERE student_id = ? 
                AND date >= date('now', 'start of year')
            ''', (student_db_id,))
            
            result = self.cursor.fetchone()
            
            if result and result[0] > 0:
                total_days = result[0]
                present_days = result[1] or 0
                percentage = round((present_days / total_days) * 100, 1)
                return percentage
            else:
                # Return a reasonable default if no attendance data
                return 88.5  # Default attendance percentage
                
        except Exception as e:
            print(f"Error calculating attendance for student {student_db_id}: {e}")
            return 85.0  # Default fallback
    
    def get_student_current_grade(self, student_db_id):
        """Get student's current grade/performance level"""
        try:
            # Check if we have a grades table in the database
            self.cursor.execute("""
                SELECT AVG(score) 
                FROM grades 
                WHERE student_id = ? AND semester = 'Current'
            """, (student_db_id,))
            
            result = self.cursor.fetchone()
            if result and result[0] is not None:
                avg_score = result[0]
                # Convert score to grade
                if avg_score >= 90: return "A"
                elif avg_score >= 85: return "A-" 
                elif avg_score >= 80: return "B+"
                elif avg_score >= 75: return "B"
                elif avg_score >= 70: return "B-"
                elif avg_score >= 65: return "C+"
                else: return "C"
            else:
                # Generate realistic grade based on attendance
                attendance = self.get_student_attendance_percentage(student_db_id)
                if attendance >= 95: return "A-"
                elif attendance >= 90: return "B+"
                elif attendance >= 85: return "B"
                elif attendance >= 80: return "B-"
                elif attendance >= 75: return "C+"
                else: return "C"
                
        except Exception as e:
            print(f"Error getting grade for student {student_db_id}: {e}")
            return "B"  # Default grade
    
    def get_sample_students_data(self):
        """Get sample student data as fallback with Ghana Cedi currency"""
        return [
            {
                'id': 'ST001',
                'name': 'Kwame Asante',
                'age': 12,
                'grade': 'A-',
                'attendance': 95.0,
                'total_fees': 3500.0,  # GHS 3,500
                'paid_fees': 3200.0,   # GHS 3,200
                'outstanding_fees': 300.0,  # GHS 300
                'gender': 'Male'
            },
            {
                'id': 'ST002', 
                'name': 'Akosua Mensah',
                'age': 11,
                'grade': 'B+',
                'attendance': 88.5,
                'total_fees': 3500.0,  # GHS 3,500
                'paid_fees': 3500.0,   # GHS 3,500 (fully paid)
                'outstanding_fees': 0.0,
                'gender': 'Female'
            },
            {
                'id': 'ST003',
                'name': 'Kofi Osei',
                'age': 12,
                'grade': 'A',
                'attendance': 92.0,
                'total_fees': 3500.0,  # GHS 3,500
                'paid_fees': 2100.0,   # GHS 2,100
                'outstanding_fees': 1400.0,  # GHS 1,400
                'gender': 'Male'
            },
            {
                'id': 'ST004',
                'name': 'Ama Boateng',
                'age': 11,
                'grade': 'B-',
                'attendance': 85.0,
                'total_fees': 3500.0,  # GHS 3,500
                'paid_fees': 3300.0,   # GHS 3,300
                'outstanding_fees': 200.0,  # GHS 200
                'gender': 'Female'
            }
        ]
    
    def calculate_age(self, date_of_birth):
        """Calculate age from date of birth"""
        if not date_of_birth:
            return "N/A"
        try:
            from datetime import datetime
            if isinstance(date_of_birth, str):
                dob = datetime.strptime(date_of_birth, '%Y-%m-%d')
            else:
                dob = date_of_birth
            today = datetime.today()
            age = today.year - dob.year - ((today.month, today.day) < (dob.month, dob.day))
            return age
        except:
            return "N/A"
    
    def get_student_attendance_percentage(self, student_id):
        """Get attendance percentage for student (placeholder)"""
        # In a real system, this would calculate from attendance records
        # For now, return a placeholder value
        import random
        return random.randint(85, 98)
    
    def get_student_current_grade(self, student_id):
        """Get current grade for student (placeholder)"""
        # In a real system, this would calculate from grade records
        # For now, return a placeholder grade
        grades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C']
        import random
        return random.choice(grades)
    
    def get_student_names(self):
        """Get list of student names for dropdowns"""
        students = self.get_class_students_data()
        return [f"{student['name']} ({student['id']})" for student in students]
    
    def get_assignments_for_grading(self):
        """Get list of assignments available for grading"""
        return [
            "Mathematics Quiz #1 - Oct 2025",
            "English Essay Assignment", 
            "Science Lab Report",
            "History Project",
            "Math Homework Week 5"
        ]
    
    def refresh_teacher_data(self):
        """Refresh teacher dashboard data"""
        messagebox.showinfo("Data Refreshed", "Teacher dashboard data has been refreshed!")
        self.show_teacher_dashboard()
    
    def get_total_students(self):
        """Get total number of students"""
        try:
            self.cursor.execute('SELECT COUNT(*) FROM students')
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except Exception as e:
            print(f"Error getting total students: {e}")
            return 0
    
    def get_gender_counts(self):
        """Get count of boys and girls"""
        try:
            self.cursor.execute('SELECT gender, COUNT(*) FROM students GROUP BY gender')
            results = self.cursor.fetchall()
            boys = 0
            girls = 0
            
            for gender, count in results:
                if gender and gender.lower() in ['male', 'm', 'boy']:
                    boys = count
                elif gender and gender.lower() in ['female', 'f', 'girl']:
                    girls = count
            
            return boys, girls
        except Exception as e:
            print(f"Error getting gender counts: {e}")
            return 0, 0
    
    def get_payment_status_counts(self):
        """Get count of fee paying and scholarship students based on monthly_fee"""
        try:
            # Count scholarship students (monthly_fee = 0 or NULL)
            # Using COALESCE to handle NULL values
            self.cursor.execute('''
                SELECT COUNT(*) FROM students 
                WHERE COALESCE(monthly_fee, 0) = 0
            ''')
            scholarship_result = self.cursor.fetchone()
            scholarship = scholarship_result[0] if scholarship_result else 0
            
            # Count fee-paying students (monthly_fee > 0)
            self.cursor.execute('''
                SELECT COUNT(*) FROM students 
                WHERE COALESCE(monthly_fee, 0) > 0
            ''')
            fee_paying_result = self.cursor.fetchone()
            fee_paying = fee_paying_result[0] if fee_paying_result else 0
            
            return fee_paying, scholarship
        except Exception as e:
            print(f"Error getting payment status counts: {e}")
            import traceback
            traceback.print_exc()
            return 0, 0
    
    def get_total_classes(self):
        """Get total number of classes"""
        try:
            self.cursor.execute('SELECT COUNT(DISTINCT class_name) FROM classes')
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except Exception as e:
            print(f"Error getting total classes: {e}")
            return 0
    
    def manage_student_attendance(self, student):
        """Manage attendance for a specific student"""
        attendance_window = self.create_responsive_window(
            self.root, 
            f"Attendance - {student['name']}", 
            500, 400, 
            min_width=450, min_height=350, 
            max_width=700, max_height=600
        )
        attendance_window.configure(bg='#ffffff')
        
        # Header
        header = tk.Frame(attendance_window, bg='#28a745')
        header.pack(fill='x')
        
        tk.Label(header, text=f"✅ Attendance Management", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#28a745').pack(pady=15)
        tk.Label(header, text=f"Student: {student['name']} ({student['id']})", 
                font=('Segoe UI', 12), fg='white', bg='#28a745').pack(pady=(0, 15))
        
        # Content
        content = tk.Frame(attendance_window, bg='#ffffff')
        content.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Current attendance info
        info_frame = tk.Frame(content, bg='#f8f9fa', relief='solid', bd=1)
        info_frame.pack(fill='x', pady=(0, 20))
        
        tk.Label(info_frame, text=f"Current Attendance: {student['attendance']}%", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#f8f9fa').pack(pady=15)
        
        # Mark attendance for today
        today_frame = tk.Frame(content, bg='#ffffff')
        today_frame.pack(fill='x', pady=(0, 20))
        
        tk.Label(today_frame, text="Mark Today's Attendance:", 
                font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        attendance_var = tk.StringVar(value="present")
        
        present_rb = tk.Radiobutton(today_frame, text="✅ Present", variable=attendance_var, 
                                   value="present", font=('Segoe UI', 11), bg='#ffffff')
        present_rb.pack(anchor='w', pady=2)
        
        absent_rb = tk.Radiobutton(today_frame, text="❌ Absent", variable=attendance_var, 
                                  value="absent", font=('Segoe UI', 11), bg='#ffffff')
        absent_rb.pack(anchor='w', pady=2)
        
        late_rb = tk.Radiobutton(today_frame, text="⏱️ Late", variable=attendance_var, 
                                value="late", font=('Segoe UI', 11), bg='#ffffff')
        late_rb.pack(anchor='w', pady=2)
        
        # Save button
        save_btn = tk.Button(content, text="Save Attendance", 
                           command=lambda: self.save_attendance(student, attendance_var.get(), attendance_window),
                           font=('Segoe UI', 12, 'bold'), bg='#007bff', fg='white',
                           relief='solid', bd=0, padx=30, pady=10)
        save_btn.pack(pady=20)
    
    def write_student_remarks(self, student):
        """Write remarks for a specific student with scrollable interface"""
        remarks_window = self.create_responsive_window(
            self.root,
            f"Student Remarks - {student['name']}",
            700, 600,
            min_width=600, min_height=500,
            max_width=900, max_height=800
        )
        remarks_window.configure(bg='#ffffff')
        
        # Header
        header = tk.Frame(remarks_window, bg='#17a2b8')
        header.pack(fill='x')
        
        tk.Label(header, text=f"📝 Student Remarks & Comments", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#17a2b8').pack(pady=15)
        tk.Label(header, text=f"Student: {student['name']} ({student['id']})", 
                font=('Segoe UI', 12), fg='white', bg='#17a2b8').pack(pady=(0, 15))
        
        # Create scrollable content frame
        main_frame = tk.Frame(remarks_window, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Create canvas and scrollbar for scrolling
        canvas = tk.Canvas(main_frame, bg='#ffffff', highlightthickness=0)
        scrollbar = tk.Scrollbar(main_frame, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg='#ffffff')
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # Pack canvas and scrollbar
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # Bind mousewheel to canvas with proper cleanup
        def _on_mousewheel(event):
            try:
                canvas.yview_scroll(int(-1*(event.delta/120)), "units")
            except tk.TclError:
                pass  # Canvas was destroyed
        
        canvas.bind("<MouseWheel>", _on_mousewheel)
        
        # Cleanup on window destroy
        def cleanup_bindings():
            try:
                canvas.unbind("<MouseWheel>")
            except:
                pass
        
        remarks_window.protocol("WM_DELETE_WINDOW", lambda: [cleanup_bindings(), remarks_window.destroy()])
        
        # Load existing remarks
        existing_remarks = self.load_student_remarks(student['id'])
        
        # Remarks categories with enhanced options
        categories = [
            "Academic Performance", "Behavior & Conduct", "Attendance & Punctuality", 
            "Participation & Engagement", "Social Skills", "Learning Progress", 
            "Areas for Improvement", "Strengths & Achievements", "Parent Communication", 
            "General Comments"
        ]
        
        self.remark_texts = {}
        
        for category in categories:
            cat_frame = tk.Frame(scrollable_frame, bg='#ffffff')
            cat_frame.pack(fill='x', pady=(0, 20))
            
            tk.Label(cat_frame, text=f"{category}:", 
                    font=('Segoe UI', 11, 'bold'), fg='#2c3e50', bg='#ffffff').pack(anchor='w')
            
            # Create frame for text widget and scrollbar
            text_frame = tk.Frame(cat_frame, bg='#ffffff')
            text_frame.pack(fill='x', pady=(5, 0))
            
            text_widget = tk.Text(text_frame, height=4, font=('Segoe UI', 10), 
                                 relief='solid', bd=1, wrap='word')
            text_scrollbar = tk.Scrollbar(text_frame)
            
            text_widget.config(yscrollcommand=text_scrollbar.set)
            text_scrollbar.config(command=text_widget.yview)
            
            text_widget.pack(side='left', fill='both', expand=True)
            text_scrollbar.pack(side='right', fill='y')
            
            # Load existing remark for this category
            if category in existing_remarks:
                text_widget.insert('1.0', existing_remarks[category])
            
            self.remark_texts[category] = text_widget
        
        # Buttons frame
        buttons_frame = tk.Frame(scrollable_frame, bg='#ffffff')
        buttons_frame.pack(fill='x', pady=20)
        
        # Save button
        save_remarks_btn = tk.Button(buttons_frame, text="💾 Save Remarks", 
                                   command=lambda: self.save_remarks(student, remarks_window),
                                   font=('Segoe UI', 12, 'bold'), bg='#28a745', fg='white',
                                   relief='solid', bd=0, padx=30, pady=10)
        save_remarks_btn.pack(side='left', padx=(0, 10))
        
        # View history button
        history_btn = tk.Button(buttons_frame, text="ℹ️ View History", 
                              command=lambda: self.view_remarks_history(student),
                              font=('Segoe UI', 12, 'bold'), bg='#17a2b8', fg='white',
                              relief='solid', bd=0, padx=30, pady=10)
        history_btn.pack(side='left', padx=10)
        
        # Clear all button
        clear_btn = tk.Button(buttons_frame, text="🧹 Clear All", 
                            command=lambda: self.clear_all_remarks(),
                            font=('Segoe UI', 12, 'bold'), bg='#dc3545', fg='white',
                            relief='solid', bd=0, padx=30, pady=10)
        clear_btn.pack(side='right')
    
    def view_student_profile(self, student):
        """View complete student profile"""
        profile_window = self.create_responsive_window(
            self.root,
            f"Student Profile - {student['name']}",
            800, 600,
            min_width=700, min_height=550,
            max_width=1000, max_height=800
        )
        profile_window.configure(bg='#ffffff')
        
        # Header
        header = tk.Frame(profile_window, bg='#6f42c1')
        header.pack(fill='x')
        
        tk.Label(header, text=f"👤 Complete Student Profile", 
                font=('Segoe UI', 18, 'bold'), fg='white', bg='#6f42c1').pack(pady=15)
        
        # Create notebook for different profile sections
        notebook = ttk.Notebook(profile_window)
        notebook.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Basic info tab
        basic_frame = ttk.Frame(notebook)
        notebook.add(basic_frame, text="Basic Information")
        self.create_student_basic_info(basic_frame, student)
        
        # Academic tab
        academic_frame = ttk.Frame(notebook)
        notebook.add(academic_frame, text="Academic Records")
        self.create_student_academic_info(academic_frame, student)
        
        # Financial tab
        financial_frame = ttk.Frame(notebook)
        notebook.add(financial_frame, text="Financial Information")
        self.create_student_financial_info(financial_frame, student)
    
    def create_student_basic_info(self, parent, student):
        """Create basic student information display"""
        content = tk.Frame(parent, bg='#ffffff')
        content.pack(fill='both', expand=True, padx=20, pady=20)
        
        info_data = [
            ("Student ID", student['id']),
            ("Full Name", student['name']),
            ("Age", f"{student['age']} years"),
            ("Current Grade", student['grade']),
            ("Attendance Rate", f"{student['attendance']}%"),
            ("Class", self.selected_class.get() if hasattr(self, 'selected_class') else "N/A"),
            ("Emergency Contact", "+1 (555) 123-4567"),
            ("Parent/Guardian", "John & Jane Smith"),
            ("Address", "123 Main Street, City, State 12345")
        ]
        
        for label, value in info_data:
            row_frame = tk.Frame(content, bg='#ffffff')
            row_frame.pack(fill='x', pady=5)
            
            tk.Label(row_frame, text=f"{label}:", 
                    font=('Segoe UI', 11, 'bold'), fg='#495057', bg='#ffffff', width=20, anchor='w').pack(side='left')
            tk.Label(row_frame, text=value, 
                    font=('Segoe UI', 11), fg='#2c3e50', bg='#ffffff').pack(side='left', padx=(10, 0))
    
    def create_student_academic_info(self, parent, student):
        """Create academic information display"""
        content = tk.Frame(parent, bg='#ffffff')
        content.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Recent grades
        grades_frame = tk.Frame(content, bg='#f8f9fa', relief='solid', bd=1)
        grades_frame.pack(fill='x', pady=(0, 20))
        
        tk.Label(grades_frame, text="📊 Recent Grades & Assignments", 
                font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#f8f9fa').pack(pady=10)
        
        # Sample grades data
        grades_data = [
            ("Mathematics Quiz", "A-", "92%"),
            ("English Essay", "B+", "87%"),
            ("Science Project", "A", "95%"),
            ("History Test", "B", "83%")
        ]
        
        for assignment, grade, percentage in grades_data:
            grade_row = tk.Frame(grades_frame, bg='#f8f9fa')
            grade_row.pack(fill='x', padx=20, pady=2)
            
            tk.Label(grade_row, text=assignment, 
                    font=('Segoe UI', 10), fg='#2c3e50', bg='#f8f9fa', width=20, anchor='w').pack(side='left')
            tk.Label(grade_row, text=grade, 
                    font=('Segoe UI', 10, 'bold'), fg='#28a745', bg='#f8f9fa', width=5, anchor='center').pack(side='left')
            tk.Label(grade_row, text=percentage, 
                    font=('Segoe UI', 10), fg='#6c757d', bg='#f8f9fa').pack(side='right')
    
    def create_student_financial_info(self, parent, student):
        """Create financial information display"""
        content = tk.Frame(parent, bg='#ffffff')
        content.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Fee summary
        fee_frame = tk.Frame(content, bg='#f8f9fa', relief='solid', bd=1)
        fee_frame.pack(fill='x', pady=(0, 20))
        
        tk.Label(fee_frame, text="💳 Fee Summary", 
                font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#f8f9fa').pack(pady=10)
        
        fee_data = [
            ("Total Annual Fees", f"GHS {student['total_fees']:.2f}", "#2c3e50"),
            ("Amount Paid", f"GHS {student['paid_fees']:.2f}", "#28a745"),
            ("Outstanding Balance", f"GHS {student['outstanding_fees']:.2f}", "#dc3545"),
            ("Payment Status", "Partial Payment" if student['outstanding_fees'] > 0 else "Fully Paid", 
             "#fd7e14" if student['outstanding_fees'] > 0 else "#28a745")
        ]
        
        for label, amount, color in fee_data:
            fee_row = tk.Frame(fee_frame, bg='#f8f9fa')
            fee_row.pack(fill='x', padx=20, pady=5)
            
            tk.Label(fee_row, text=f"{label}:", 
                    font=('Segoe UI', 11, 'bold'), fg='#495057', bg='#f8f9fa', width=20, anchor='w').pack(side='left')
            tk.Label(fee_row, text=amount, 
                    font=('Segoe UI', 11, 'bold'), fg=color, bg='#f8f9fa').pack(side='right')
    
    def save_attendance(self, student, status, window):
        """Save attendance record for teacher's individual student management"""
        try:
            from datetime import date
            today = date.today().strftime('%Y-%m-%d')
            
            # Convert status to present value
            present = 1 if status == "present" else 0
            
            # Check if attendance record exists for today
            self.cursor.execute("SELECT id FROM attendance WHERE student_id = ? AND date = ?", 
                              (student['id'], today))
            existing_record = self.cursor.fetchone()
            
            if existing_record:
                # Update existing record
                self.cursor.execute("""
                    UPDATE attendance SET present = ? WHERE student_id = ? AND date = ?
                """, (present, student['id'], today))
            else:
                # Create new record
                self.cursor.execute("""
                    INSERT INTO attendance (student_id, date, present, feeding_fee_paid, bus_fee_paid) 
                    VALUES (?, ?, ?, 0, 0)
                """, (student['id'], today, present))
            
            self.conn.commit()
            
            status_text = "Present" if present else ("Late" if status == "late" else "Absent")
            messagebox.showinfo("Attendance Saved", 
                               f"Attendance marked as '{status_text}' for {student['name']} on {today}")
            window.destroy()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to save attendance: {str(e)}")
            print(f"Attendance save error: {e}")
    
    def save_remarks(self, student, window):
        """Save student remarks to database"""
        try:
            # Get current date
            from datetime import datetime
            current_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            # Save each category's remarks
            for category, text_widget in self.remark_texts.items():
                remark_text = text_widget.get("1.0", "end-1c").strip()
                if remark_text:  # Only save non-empty remarks
                    # Delete existing remark for this category and student
                    self.cursor.execute(
                        'DELETE FROM student_remarks WHERE student_id = ? AND category = ?',
                        (student['id'], category)
                    )
                    
                    # Insert new remark
                    self.cursor.execute('''
                        INSERT INTO student_remarks (student_id, teacher_id, category, remark, date_created)
                        VALUES (?, ?, ?, ?, ?)
                    ''', (student['id'], 1, category, remark_text, current_date))  # teacher_id=1 placeholder
            
            self.conn.commit()
            messagebox.showinfo("Success", 
                               f"Remarks have been saved successfully for {student['name']}")
            window.destroy()
        except Exception as e:
            messagebox.showerror("Error", f"Failed to save remarks: {str(e)}")
    
    def load_student_remarks(self, student_id):
        """Load existing remarks for a student"""
        try:
            self.cursor.execute('''
                SELECT category, remark FROM student_remarks 
                WHERE student_id = ? 
                ORDER BY date_created DESC
            ''', (student_id,))
            
            remarks = {}
            for category, remark in self.cursor.fetchall():
                if category not in remarks:  # Get most recent remark for each category
                    remarks[category] = remark
            
            return remarks
        except Exception as e:
            print(f"Error loading remarks: {e}")
            return {}
    
    def view_remarks_history(self, student):
        """View complete remarks history for a student"""
        history_window = self.create_responsive_window(
            self.root,
            f"Remarks History - {student['name']}",
            800, 600,
            min_width=700, min_height=550,
            max_width=1000, max_height=800
        )
        history_window.configure(bg='#ffffff')
        
        # Header
        header = tk.Frame(history_window, bg='#6f42c1')
        header.pack(fill='x')
        
        tk.Label(header, text=f"ℹ️ Remarks History", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#6f42c1').pack(pady=15)
        tk.Label(header, text=f"Student: {student['name']}", 
                font=('Segoe UI', 12), fg='white', bg='#6f42c1').pack(pady=(0, 15))
        
        # Create treeview for history
        tree_frame = tk.Frame(history_window, bg='#ffffff')
        tree_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        columns = ('Date', 'Category', 'Remark')
        tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=15)
        
        # Define headings
        tree.heading('Date', text='Date & Time')
        tree.heading('Category', text='Category')
        tree.heading('Remark', text='Remark')
        
        # Configure column widths
        tree.column('Date', width=150)
        tree.column('Category', width=200)
        tree.column('Remark', width=400)
        
        # Add scrollbar
        scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        
        # Pack tree and scrollbar
        tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        # Load and display history
        try:
            self.cursor.execute('''
                SELECT date_created, category, remark FROM student_remarks 
                WHERE student_id = ? 
                ORDER BY date_created DESC
            ''', (student['id'],))
            
            for row in self.cursor.fetchall():
                tree.insert('', 'end', values=row)
                
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load remarks history: {str(e)}")
    
    def clear_all_remarks(self):
        """Clear all remark text fields"""
        if messagebox.askyesno("Confirm", "Clear all remark fields? This will not delete saved remarks."):
            for text_widget in self.remark_texts.values():
                text_widget.delete("1.0", "end")
    
    # ============ CLASSROOM MANAGEMENT MODULES ============
    
    def create_homework_module(self, parent):
        """Create homework management module"""
        main_frame = tk.Frame(parent, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Header with controls
        header_frame = tk.Frame(main_frame, bg='#e9ecef', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 10))
        
        header_content = tk.Frame(header_frame, bg='#e9ecef')
        header_content.pack(fill='x', padx=15, pady=10)
        
        tk.Label(header_content, text="ℹ️ Homework Management", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#e9ecef').pack(side='left')
        
        # Add new homework button
        add_hw_btn = tk.Button(header_content, text="➕ Add Homework", 
                              command=self.add_new_homework,
                              font=('Segoe UI', 10, 'bold'), bg='#28a745', fg='white',
                              relief='solid', bd=0, padx=15, pady=5)
        add_hw_btn.pack(side='right')
        
        # Homework list with treeview
        tree_frame = tk.Frame(main_frame, bg='#ffffff')
        tree_frame.pack(fill='both', expand=True)
        
        # Create treeview
        columns = ('ID', 'Subject', 'Title', 'Assigned Date', 'Due Date', 'Status')
        self.homework_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=12)
        
        # Define headings and column widths
        for col in columns:
            self.homework_tree.heading(col, text=col)
            self.homework_tree.column(col, width=120 if col != 'Title' else 200)
        
        # Scrollbar for treeview
        hw_scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=self.homework_tree.yview)
        self.homework_tree.configure(yscrollcommand=hw_scrollbar.set)
        
        self.homework_tree.pack(side='left', fill='both', expand=True)
        hw_scrollbar.pack(side='right', fill='y')
        
        # Context menu for homework
        self.homework_tree.bind('<Button-3>', self.show_homework_context_menu)
        self.homework_tree.bind('<Double-1>', self.edit_homework)
        
        # Load homework data
        self.load_homework_data()
    
    def create_tests_module(self, parent):
        """Create tests management module"""
        main_frame = tk.Frame(parent, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#e9ecef', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 10))
        
        header_content = tk.Frame(header_frame, bg='#e9ecef')
        header_content.pack(fill='x', padx=15, pady=10)
        
        tk.Label(header_content, text="📝 Tests & Examinations", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#e9ecef').pack(side='left')
        
        # Add new test button
        add_test_btn = tk.Button(header_content, text="➕ Schedule Test", 
                                command=self.add_new_test,
                                font=('Segoe UI', 10, 'bold'), bg='#dc3545', fg='white',
                                relief='solid', bd=0, padx=15, pady=5)
        add_test_btn.pack(side='right')
        
        # Tests list with treeview
        tree_frame = tk.Frame(main_frame, bg='#ffffff')
        tree_frame.pack(fill='both', expand=True)
        
        columns = ('ID', 'Subject', 'Title', 'Test Date', 'Duration', 'Total Marks', 'Status')
        self.tests_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=12)
        
        for col in columns:
            self.tests_tree.heading(col, text=col)
            self.tests_tree.column(col, width=100 if col != 'Title' else 180)
        
        test_scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=self.tests_tree.yview)
        self.tests_tree.configure(yscrollcommand=test_scrollbar.set)
        
        self.tests_tree.pack(side='left', fill='both', expand=True)
        test_scrollbar.pack(side='right', fill='y')
        
        self.tests_tree.bind('<Button-3>', self.show_test_context_menu)
        self.tests_tree.bind('<Double-1>', self.edit_test)
        
        self.load_tests_data()
    
    def create_lessons_module(self, parent):
        """Create lesson plans management module"""
        main_frame = tk.Frame(parent, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#e9ecef', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 10))
        
        header_content = tk.Frame(header_frame, bg='#e9ecef')
        header_content.pack(fill='x', padx=15, pady=10)
        
        tk.Label(header_content, text="📚 Lesson Plans", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#e9ecef').pack(side='left')
        
        add_lesson_btn = tk.Button(header_content, text="➕ Create Lesson Plan", 
                                  command=self.add_new_lesson_plan,
                                  font=('Segoe UI', 10, 'bold'), bg='#17a2b8', fg='white',
                                  relief='solid', bd=0, padx=15, pady=5)
        add_lesson_btn.pack(side='right')
        
        # Lesson plans list
        tree_frame = tk.Frame(main_frame, bg='#ffffff')
        tree_frame.pack(fill='both', expand=True)
        
        columns = ('ID', 'Subject', 'Lesson Title', 'Date', 'Duration', 'Status')
        self.lessons_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=12)
        
        for col in columns:
            self.lessons_tree.heading(col, text=col)
            self.lessons_tree.column(col, width=120 if col != 'Lesson Title' else 200)
        
        lesson_scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=self.lessons_tree.yview)
        self.lessons_tree.configure(yscrollcommand=lesson_scrollbar.set)
        
        self.lessons_tree.pack(side='left', fill='both', expand=True)
        lesson_scrollbar.pack(side='right', fill='y')
        
        self.lessons_tree.bind('<Button-3>', self.show_lesson_context_menu)
        self.lessons_tree.bind('<Double-1>', self.edit_lesson_plan)
        
        self.load_lesson_plans_data()
    
    def create_projects_module(self, parent):
        """Create projects management module"""
        main_frame = tk.Frame(parent, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#e9ecef', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 10))
        
        header_content = tk.Frame(header_frame, bg='#e9ecef')
        header_content.pack(fill='x', padx=15, pady=10)
        
        tk.Label(header_content, text="📁 Class Projects", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#e9ecef').pack(side='left')
        
        add_project_btn = tk.Button(header_content, text="➕ Add Project", 
                                   command=self.add_new_project,
                                   font=('Segoe UI', 10, 'bold'), bg='#fd7e14', fg='white',
                                   relief='solid', bd=0, padx=15, pady=5)
        add_project_btn.pack(side='right')
        
        # Projects list
        tree_frame = tk.Frame(main_frame, bg='#ffffff')
        tree_frame.pack(fill='both', expand=True)
        
        columns = ('ID', 'Title', 'Subject', 'Start Date', 'Due Date', 'Max Participants', 'Status')
        self.projects_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=12)
        
        for col in columns:
            self.projects_tree.heading(col, text=col)
            self.projects_tree.column(col, width=120 if col != 'Title' else 180)
        
        project_scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=self.projects_tree.yview)
        self.projects_tree.configure(yscrollcommand=project_scrollbar.set)
        
        self.projects_tree.pack(side='left', fill='both', expand=True)
        project_scrollbar.pack(side='right', fill='y')
        
        self.projects_tree.bind('<Button-3>', self.show_project_context_menu)
        self.projects_tree.bind('<Double-1>', self.edit_project)
        
        self.load_projects_data()
    
    def create_class_assignments_module(self, parent):
        """Create general class assignments module"""
        main_frame = tk.Frame(parent, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Quick assignment tools
        tools_frame = tk.Frame(main_frame, bg='#e9ecef', relief='solid', bd=2, height=280)
        tools_frame.pack(fill='x', pady=(0, 15), ipady=15)
        tools_frame.pack_propagate(False)  # Maintain minimum height
        
        tools_content = tk.Frame(tools_frame, bg='#e9ecef')
        tools_content.pack(fill='both', expand=True, padx=25, pady=20)
        
        tk.Label(tools_content, text="📋 Quick Class Tasks", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#e9ecef').pack(anchor='w', pady=(0, 15))
        
        # Quick task buttons
        buttons_frame = tk.Frame(tools_content, bg='#e9ecef')
        buttons_frame.pack(fill='both', expand=True, pady=(5, 0))
        
        quick_tasks = [
            ("ℹ️ Reading Assignment", self.create_reading_task),
            ("✏️ Writing Task", self.create_writing_task),
            ("º« Math Practice", self.create_math_task),
            ("❓ Quick Quiz", self.create_quick_quiz),
            ("👥 Group Activity", self.create_group_activity),
            ("📝 Homework Reminder", self.create_homework_reminder),
            ("📢 Class Announcement", self.create_class_announcement),
            ("📖 Study Guide", self.create_study_guide),
            ("📁 Project Milestone", self.create_project_milestone)
        ]
        
        # Create buttons in rows to fit better
        row_frame = None
        for i, (task_name, task_func) in enumerate(quick_tasks):
            if i % 3 == 0:  # New row every 3 buttons
                row_frame = tk.Frame(buttons_frame, bg='#e9ecef')
                row_frame.pack(fill='x', pady=6)
            
            btn = tk.Button(row_frame, text=task_name, command=task_func,
                           font=('Segoe UI', 10, 'bold'), bg='#007bff', fg='white',
                           relief='raised', bd=2, padx=12, pady=10,
                           activebackground='#0056b3', activeforeground='white',
                           cursor='hand2', width=18)
            btn.pack(side='left', padx=6, pady=4, expand=True, fill='x')
        
        # Assignment summary
        summary_frame = tk.Frame(main_frame, bg='#ffffff', relief='solid', bd=1)
        summary_frame.pack(fill='both', expand=True)
        
        tk.Label(summary_frame, text="📊 Assignment Summary & Analytics", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#ffffff').pack(pady=15)
        
        # Create summary content
        self.create_assignment_summary(summary_frame)
    
    def create_timetable_module(self, parent):
        """Create timetable management module"""
        main_frame = tk.Frame(parent, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#e9ecef', relief='solid', bd=1)
        header_frame.pack(fill='x', pady=(0, 10))
        
        header_content = tk.Frame(header_frame, bg='#e9ecef')
        header_content.pack(fill='x', padx=15, pady=10)
        
        tk.Label(header_content, text="⏰ Class Timetable", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#e9ecef').pack(side='left')
        
        add_period_btn = tk.Button(header_content, text="➕ Add Period", 
                                  command=self.add_timetable_period,
                                  font=('Segoe UI', 10, 'bold'), bg='#6f42c1', fg='white',
                                  relief='solid', bd=0, padx=15, pady=5)
        add_period_btn.pack(side='right')
        
        # Timetable grid
        timetable_frame = tk.Frame(main_frame, bg='#ffffff')
        timetable_frame.pack(fill='both', expand=True)
        
        # Create timetable grid
        self.create_timetable_grid(timetable_frame)
    
    # ============ MODULE IMPLEMENTATION METHODS ============
    
    def add_new_homework(self):
        """Add new homework assignment"""
        if not hasattr(self, 'selected_class') or not self.selected_class.get():
            messagebox.showerror("Error", "Please select a class first")
            return
        
        hw_window = self.create_responsive_window(
            self.root,
            "Add New Homework",
            600, 500,
            min_width=550, min_height=450,
            max_width=800, max_height=700
        )
        hw_window.configure(bg='#ffffff')
        
        # Header
        header = tk.Frame(hw_window, bg='#28a745')
        header.pack(fill='x')
        
        tk.Label(header, text="ℹ️ Add New Homework Assignment", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#28a745').pack(pady=15)
        
        # Create scrollable content frame
        main_frame = tk.Frame(hw_window, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Create canvas and scrollbar for scrolling
        canvas = tk.Canvas(main_frame, bg='#ffffff', highlightthickness=0)
        scrollbar = tk.Scrollbar(main_frame, orient="vertical", command=canvas.yview)
        content = tk.Frame(canvas, bg='#ffffff')
        
        content.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=content, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # Pack canvas and scrollbar
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # Subject
        tk.Label(content, text="Subject:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        subject_var = tk.StringVar()
        subject_entry = tk.Entry(content, textvariable=subject_var, font=('Segoe UI', 11), width=60)
        subject_entry.pack(anchor='w', pady=(5, 15), fill='x')
        
        # Title
        tk.Label(content, text="Assignment Title:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        title_var = tk.StringVar()
        title_entry = tk.Entry(content, textvariable=title_var, font=('Segoe UI', 11), width=60)
        title_entry.pack(anchor='w', pady=(5, 15), fill='x')
        
        # Description
        tk.Label(content, text="Description:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        desc_text = tk.Text(content, height=8, font=('Segoe UI', 11), wrap='word', width=80)
        desc_text.pack(fill='both', pady=(5, 15), expand=True)
        
        # Due date
        tk.Label(content, text="Due Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        due_entry = DateEntry(content, width=25, background='#3498db',
                             foreground='white', borderwidth=2, font=('Segoe UI', 11))
        due_entry.pack(anchor='w', pady=(5, 20))
        
        # Save button
        def save_homework():
            if not all([subject_var.get(), title_var.get()]):
                messagebox.showerror("Error", "Please fill in all required fields")
                return
            
            try:
                from datetime import datetime
                class_name = self.selected_class.get().split(' (')[0]
                
                # Get class ID
                self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
                class_result = self.cursor.fetchone()
                if not class_result:
                    messagebox.showerror("Error", "Class not found")
                    return
                
                class_id = class_result[0]
                assigned_date = datetime.now().strftime("%Y-%m-%d")
                
                # Insert homework
                self.cursor.execute('''
                    INSERT INTO homework (class_id, subject, title, description, assigned_date, due_date, status)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                ''', (class_id, subject_var.get(), title_var.get(), 
                     desc_text.get("1.0", "end-1c"), assigned_date, due_entry.get_date().strftime('%Y-%m-%d'), 'active'))
                
                self.conn.commit()
                messagebox.showinfo("Success", "Homework assignment added successfully!")
                hw_window.destroy()
                self.load_homework_data()
                
            except Exception as e:
                messagebox.showerror("Error", f"Failed to save homework: {str(e)}")
        
        save_btn = tk.Button(content, text="💾 Save Homework", command=save_homework,
                            font=('Segoe UI', 12, 'bold'), bg='#28a745', fg='white',
                            relief='solid', bd=0, padx=30, pady=10)
        save_btn.pack(pady=10)
    
    def load_homework_data(self):
        """Load homework data into treeview"""
        if not hasattr(self, 'homework_tree'):
            return
            
        # Clear existing data
        for item in self.homework_tree.get_children():
            self.homework_tree.delete(item)
        
        try:
            if hasattr(self, 'selected_class') and self.selected_class.get():
                class_name = self.selected_class.get().split(' (')[0]
                
                # Get homework for selected class
                self.cursor.execute('''
                    SELECT h.id, h.subject, h.title, h.assigned_date, h.due_date, h.status
                    FROM homework h
                    JOIN classes c ON h.class_id = c.id
                    WHERE c.class_name = ?
                    ORDER BY h.due_date DESC
                ''', (class_name,))
                
                for row in self.cursor.fetchall():
                    self.homework_tree.insert('', 'end', values=row)
                    
        except Exception as e:
            print(f"Error loading homework data: {e}")
    
    def add_new_test(self):
        """Add new test/examination"""
        if not hasattr(self, 'selected_class') or not self.selected_class.get():
            messagebox.showerror("Error", "Please select a class first")
            return
        
        test_window = self.create_responsive_window(
            self.root,
            "Schedule New Test",
            600, 550,
            min_width=550, min_height=500,
            max_width=800, max_height=750
        )
        test_window.configure(bg='#ffffff')
        
        # Header
        header = tk.Frame(test_window, bg='#dc3545')
        header.pack(fill='x')
        
        tk.Label(header, text="📝 Schedule New Test", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#dc3545').pack(pady=15)
        
        # Create scrollable content frame
        main_frame = tk.Frame(test_window, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Create canvas and scrollbar for scrolling
        canvas = tk.Canvas(main_frame, bg='#ffffff', highlightthickness=0)
        scrollbar = tk.Scrollbar(main_frame, orient="vertical", command=canvas.yview)
        content = tk.Frame(canvas, bg='#ffffff')
        
        content.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=content, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # Pack canvas and scrollbar
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # Form fields
        non_date_fields = [
            ("Subject:", tk.StringVar()),
            ("Test Title:", tk.StringVar()),
            ("Duration (minutes):", tk.StringVar()),
            ("Total Marks:", tk.StringVar())
        ]
        
        field_vars = {}
        for label, var in non_date_fields:
            tk.Label(content, text=label, font=('Segoe UI', 10, 'bold'), 
                    fg='#2c3e50', bg='#ffffff').pack(anchor='w')
            entry = tk.Entry(content, textvariable=var, font=('Segoe UI', 11), width=60)
            entry.pack(anchor='w', pady=(5, 15), fill='x')
            field_vars[label] = var
        
        # Test Date field with DateEntry
        tk.Label(content, text="Test Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        test_date_entry = DateEntry(content, width=25, background='#dc3545',
                                   foreground='white', borderwidth=2, font=('Segoe UI', 11))
        test_date_entry.pack(anchor='w', pady=(5, 15))
        
        # Description
        tk.Label(content, text="Test Description:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        desc_text = tk.Text(content, height=6, font=('Segoe UI', 11), wrap='word', width=80)
        desc_text.pack(fill='both', pady=(5, 20), expand=True)
        
        # Save function
        def save_test():
            try:
                class_name = self.selected_class.get().split(' (')[0]
                
                # Get class ID
                self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
                class_result = self.cursor.fetchone()
                if not class_result:
                    messagebox.showerror("Error", "Class not found")
                    return
                
                class_id = class_result[0]
                
                # Insert test
                self.cursor.execute('''
                    INSERT INTO tests (class_id, subject, title, description, test_date, 
                                     duration_minutes, total_marks, status)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ''', (class_id, field_vars["Subject:"].get(), field_vars["Test Title:"].get(),
                     desc_text.get("1.0", "end-1c"), test_date_entry.get_date().strftime('%Y-%m-%d'),
                     int(field_vars["Duration (minutes):"].get() or 60),
                     int(field_vars["Total Marks:"].get() or 100), 'scheduled'))
                
                self.conn.commit()
                messagebox.showinfo("Success", "Test scheduled successfully!")
                test_window.destroy()
                self.load_tests_data()
                
            except Exception as e:
                messagebox.showerror("Error", f"Failed to schedule test: {str(e)}")
        
        save_btn = tk.Button(content, text="📝 Schedule Test", command=save_test,
                            font=('Segoe UI', 12, 'bold'), bg='#dc3545', fg='white',
                            relief='solid', bd=0, padx=30, pady=10)
        save_btn.pack(pady=10)
    
    def load_tests_data(self):
        """Load tests data into treeview"""
        if not hasattr(self, 'tests_tree'):
            return
            
        for item in self.tests_tree.get_children():
            self.tests_tree.delete(item)
        
        try:
            if hasattr(self, 'selected_class') and self.selected_class.get():
                class_name = self.selected_class.get().split(' (')[0]
                
                self.cursor.execute('''
                    SELECT t.id, t.subject, t.title, t.test_date, t.duration_minutes, t.total_marks, t.status
                    FROM tests t
                    JOIN classes c ON t.class_id = c.id
                    WHERE c.class_name = ?
                    ORDER BY t.test_date DESC
                ''', (class_name,))
                
                for row in self.cursor.fetchall():
                    self.tests_tree.insert('', 'end', values=row)
                    
        except Exception as e:
            print(f"Error loading tests data: {e}")
    
    def add_new_lesson_plan(self):
        """Create new lesson plan"""
        lesson_window = self.create_responsive_window(
            self.root,
            "Create Lesson Plan",
            700, 600,
            min_width=650, min_height=550,
            max_width=900, max_height=800
        )
        lesson_window.configure(bg='#ffffff')
        
        # Header
        header = tk.Frame(lesson_window, bg='#17a2b8')
        header.pack(fill='x')
        
        tk.Label(header, text="📚 Create Lesson Plan", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#17a2b8').pack(pady=15)
        
        # Create scrollable content
        main_frame = tk.Frame(lesson_window, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        canvas = tk.Canvas(main_frame, bg='#ffffff', highlightthickness=0)
        scrollbar = tk.Scrollbar(main_frame, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg='#ffffff')
        
        scrollable_frame.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # Lesson plan form
        lesson_vars = {}
        
        # Basic info
        non_date_fields = [
            ("Subject:", tk.StringVar()),
            ("Lesson Title:", tk.StringVar()),
            ("Duration (minutes):", tk.StringVar())
        ]
        
        for label, var in non_date_fields:
            tk.Label(scrollable_frame, text=label, font=('Segoe UI', 10, 'bold'), 
                    fg='#2c3e50', bg='#ffffff').pack(anchor='w', pady=(10, 0))
            entry = tk.Entry(scrollable_frame, textvariable=var, font=('Segoe UI', 11), width=70)
            entry.pack(anchor='w', pady=(5, 0), fill='x', padx=(0, 20))
            lesson_vars[label] = var
        
        # Date field with DateEntry
        tk.Label(scrollable_frame, text="Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w', pady=(10, 0))
        lesson_date_entry = DateEntry(scrollable_frame, width=25, background='#17a2b8',
                                     foreground='white', borderwidth=2, font=('Segoe UI', 11))
        lesson_date_entry.pack(anchor='w', pady=(5, 0))
        
        # Text areas
        text_fields = ["Objectives:", "Content:", "Activities:", "Materials:", "Assessment:"]
        lesson_texts = {}
        
        for field in text_fields:
            tk.Label(scrollable_frame, text=field, font=('Segoe UI', 10, 'bold'), 
                    fg='#2c3e50', bg='#ffffff').pack(anchor='w', pady=(15, 5))
            text_widget = tk.Text(scrollable_frame, height=4, font=('Segoe UI', 10), wrap='word')
            text_widget.pack(fill='x', pady=(0, 10))
            lesson_texts[field] = text_widget
        
        # Save function
        def save_lesson_plan():
            try:
                class_name = self.selected_class.get().split(' (')[0] if hasattr(self, 'selected_class') else ""
                
                if not class_name:
                    messagebox.showerror("Error", "Please select a class first")
                    return
                
                # Get class ID
                self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
                class_result = self.cursor.fetchone()
                if not class_result:
                    messagebox.showerror("Error", "Class not found")
                    return
                
                class_id = class_result[0]
                
                # Insert lesson plan
                self.cursor.execute('''
                    INSERT INTO lesson_plans (class_id, subject, lesson_title, objectives, 
                                            content, activities, materials, assessment, 
                                            lesson_date, duration_minutes, status)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (class_id, lesson_vars["Subject:"].get(), lesson_vars["Lesson Title:"].get(),
                     lesson_texts["Objectives:"].get("1.0", "end-1c"),
                     lesson_texts["Content:"].get("1.0", "end-1c"),
                     lesson_texts["Activities:"].get("1.0", "end-1c"),
                     lesson_texts["Materials:"].get("1.0", "end-1c"),
                     lesson_texts["Assessment:"].get("1.0", "end-1c"),
                     lesson_date_entry.get_date().strftime('%Y-%m-%d'),
                     int(lesson_vars["Duration (minutes):"].get() or 40), 'planned'))
                
                self.conn.commit()
                messagebox.showinfo("Success", "Lesson plan created successfully!")
                lesson_window.destroy()
                self.load_lesson_plans_data()
                
            except Exception as e:
                messagebox.showerror("Error", f"Failed to save lesson plan: {str(e)}")
        
        # Save button
        save_btn = tk.Button(scrollable_frame, text="📚 Save Lesson Plan", command=save_lesson_plan,
                            font=('Segoe UI', 12, 'bold'), bg='#17a2b8', fg='white',
                            relief='solid', bd=0, padx=30, pady=10)
        save_btn.pack(pady=20)
    
    def load_lesson_plans_data(self):
        """Load lesson plans data"""
        if not hasattr(self, 'lessons_tree'):
            return
            
        for item in self.lessons_tree.get_children():
            self.lessons_tree.delete(item)
        
        try:
            if hasattr(self, 'selected_class') and self.selected_class.get():
                class_name = self.selected_class.get().split(' (')[0]
                
                self.cursor.execute('''
                    SELECT l.id, l.subject, l.lesson_title, l.lesson_date, l.duration_minutes, l.status
                    FROM lesson_plans l
                    JOIN classes c ON l.class_id = c.id
                    WHERE c.class_name = ?
                    ORDER BY l.lesson_date DESC
                ''', (class_name,))
                
                for row in self.cursor.fetchall():
                    self.lessons_tree.insert('', 'end', values=row)
                    
        except Exception as e:
            print(f"Error loading lesson plans: {e}")
    
    def add_new_project(self):
        """Add new class project"""
        project_window = self.create_responsive_window(
            self.root,
            "Add Class Project",
            600, 500,
            min_width=550, min_height=450,
            max_width=800, max_height=700
        )
        project_window.configure(bg='#ffffff')
        
        # Center window
        project_window.update_idletasks()
        x = (project_window.winfo_screenwidth() // 2) - 300
        y = (project_window.winfo_screenheight() // 2) - 250
        project_window.geometry(f"600x500+{x}+{y}")
        
        # Header
        header = tk.Frame(project_window, bg='#fd7e14')
        header.pack(fill='x')
        
        tk.Label(header, text="📁 Add Class Project", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#fd7e14').pack(pady=15)
        
        # Create scrollable content frame
        main_frame = tk.Frame(project_window, bg='#ffffff')
        main_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Create canvas and scrollbar for scrolling
        canvas = tk.Canvas(main_frame, bg='#ffffff', highlightthickness=0)
        scrollbar = tk.Scrollbar(main_frame, orient="vertical", command=canvas.yview)
        content = tk.Frame(canvas, bg='#ffffff')
        
        content.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=content, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # Pack canvas and scrollbar
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # Project fields
        project_vars = {}
        non_date_fields = [
            ("Project Title:", tk.StringVar()),
            ("Subject:", tk.StringVar()),
            ("Maximum Participants:", tk.StringVar())
        ]
        
        for label, var in non_date_fields:
            tk.Label(content, text=label, font=('Segoe UI', 10, 'bold'), 
                    fg='#2c3e50', bg='#ffffff').pack(anchor='w')
            entry = tk.Entry(content, textvariable=var, font=('Segoe UI', 11), width=60)
            entry.pack(anchor='w', pady=(5, 15), fill='x')
            project_vars[label] = var
        
        # Start Date field with DateEntry
        tk.Label(content, text="Start Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        start_date_entry = DateEntry(content, width=25, background='#fd7e14',
                                    foreground='white', borderwidth=2, font=('Segoe UI', 11))
        start_date_entry.pack(anchor='w', pady=(5, 15))
        
        # Due Date field with DateEntry
        tk.Label(content, text="Due Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        due_date_entry = DateEntry(content, width=25, background='#fd7e14',
                                  foreground='white', borderwidth=2, font=('Segoe UI', 11))
        due_date_entry.pack(anchor='w', pady=(5, 15))
        
        # Description
        tk.Label(content, text="Project Description:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        desc_text = tk.Text(content, height=8, font=('Segoe UI', 11), wrap='word', width=80)
        desc_text.pack(fill='both', pady=(5, 20), expand=True)
        
        # Save function
        def save_project():
            try:
                class_name = self.selected_class.get().split(' (')[0] if hasattr(self, 'selected_class') else ""
                
                if not class_name:
                    messagebox.showerror("Error", "Please select a class first")
                    return
                
                # Get class ID
                self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
                class_result = self.cursor.fetchone()
                if not class_result:
                    messagebox.showerror("Error", "Class not found")
                    return
                
                class_id = class_result[0]
                
                # Insert project
                self.cursor.execute('''
                    INSERT INTO projects (class_id, title, description, subject, 
                                        start_date, due_date, max_participants, status)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ''', (class_id, project_vars["Project Title:"].get(),
                     desc_text.get("1.0", "end-1c"), project_vars["Subject:"].get(),
                     start_date_entry.get_date().strftime('%Y-%m-%d'),
                     due_date_entry.get_date().strftime('%Y-%m-%d'),
                     int(project_vars["Maximum Participants:"].get() or 1), 'active'))
                
                self.conn.commit()
                messagebox.showinfo("Success", "Project added successfully!")
                project_window.destroy()
                self.load_projects_data()
                
            except Exception as e:
                messagebox.showerror("Error", f"Failed to save project: {str(e)}")
        
        save_btn = tk.Button(content, text="📁 Save Project", command=save_project,
                            font=('Segoe UI', 12, 'bold'), bg='#fd7e14', fg='white',
                            relief='solid', bd=0, padx=30, pady=10)
        save_btn.pack(pady=10)
    
    def load_projects_data(self):
        """Load projects data"""
        if not hasattr(self, 'projects_tree'):
            return
            
        for item in self.projects_tree.get_children():
            self.projects_tree.delete(item)
        
        try:
            if hasattr(self, 'selected_class') and self.selected_class.get():
                class_name = self.selected_class.get().split(' (')[0]
                
                self.cursor.execute('''
                    SELECT p.id, p.title, p.subject, p.start_date, p.due_date, p.max_participants, p.status
                    FROM projects p
                    JOIN classes c ON p.class_id = c.id
                    WHERE c.class_name = ?
                    ORDER BY p.start_date DESC
                ''', (class_name,))
                
                for row in self.cursor.fetchall():
                    self.projects_tree.insert('', 'end', values=row)
                    
        except Exception as e:
            print(f"Error loading projects: {e}")
    
    def create_timetable_grid(self, parent):
        """Create weekly timetable grid"""
        # Days and time slots
        days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']
        time_slots = ['08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00', 
                     '12:00-13:00', '13:00-14:00', '14:00-15:00', '15:00-16:00']
        
        # Create grid frame
        grid_frame = tk.Frame(parent, bg='#ffffff')
        grid_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Create header row
        header_frame = tk.Frame(grid_frame, bg='#f8f9fa')
        header_frame.pack(fill='x')
        
        # Empty cell for time column
        tk.Label(header_frame, text="Time", font=('Segoe UI', 10, 'bold'),
                bg='#e9ecef', relief='solid', bd=1, width=12, height=2).pack(side='left')
        
        # Day headers
        for day in days:
            tk.Label(header_frame, text=day, font=('Segoe UI', 10, 'bold'),
                    bg='#e9ecef', relief='solid', bd=1, width=15, height=2).pack(side='left')
        
        # Create time slot rows
        self.timetable_cells = {}
        for time_slot in time_slots:
            row_frame = tk.Frame(grid_frame, bg='#ffffff')
            row_frame.pack(fill='x')
            
            # Time label
            tk.Label(row_frame, text=time_slot, font=('Segoe UI', 9),
                    bg='#f8f9fa', relief='solid', bd=1, width=12, height=3).pack(side='left')
            
            # Day cells
            for day in days:
                cell = tk.Button(row_frame, text="Free", font=('Segoe UI', 9),
                               bg='#ffffff', relief='solid', bd=1, width=15, height=3,
                               command=lambda d=day, t=time_slot: self.edit_timetable_cell(d, t))
                cell.pack(side='left')
                self.timetable_cells[f"{day}_{time_slot}"] = cell
        
        # Load timetable data
        self.load_timetable_data()
    
    def edit_timetable_cell(self, day, time_slot):
        """Edit timetable cell"""
        # Create popup for editing
        edit_window = tk.Toplevel(self.root)
        edit_window.title(f"Edit {day} {time_slot}")
        edit_window.geometry("400x300")
        edit_window.configure(bg='#ffffff')
        
        # Center window
        edit_window.update_idletasks()
        x = (edit_window.winfo_screenwidth() // 2) - 200
        y = (edit_window.winfo_screenheight() // 2) - 150
        edit_window.geometry(f"400x300+{x}+{y}")
        
        content = tk.Frame(edit_window, bg='#ffffff')
        content.pack(fill='both', expand=True, padx=20, pady=20)
        
        tk.Label(content, text=f"Edit {day} {time_slot}", 
                font=('Segoe UI', 14, 'bold'), fg='#2c3e50', bg='#ffffff').pack(pady=(0, 20))
        
        # Subject entry
        tk.Label(content, text="Subject:", font=('Segoe UI', 10, 'bold')).pack(anchor='w')
        subject_var = tk.StringVar()
        subject_entry = tk.Entry(content, textvariable=subject_var, font=('Segoe UI', 11), width=50)
        subject_entry.pack(anchor='w', pady=(5, 15), fill='x')
        
        # Room entry
        tk.Label(content, text="Room:", font=('Segoe UI', 10, 'bold')).pack(anchor='w')
        room_var = tk.StringVar()
        room_entry = tk.Entry(content, textvariable=room_var, font=('Segoe UI', 11), width=50)
        room_entry.pack(anchor='w', pady=(5, 20), fill='x')
        
        # Save function
        def save_timetable_entry():
            try:
                class_name = self.selected_class.get().split(' (')[0] if hasattr(self, 'selected_class') else ""
                
                if not class_name:
                    messagebox.showerror("Error", "Please select a class first")
                    return
                
                # Get class ID
                self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
                class_result = self.cursor.fetchone()
                if not class_result:
                    messagebox.showerror("Error", "Class not found")
                    return
                
                class_id = class_result[0]
                start_time, end_time = time_slot.split('-')
                
                # Delete existing entry
                self.cursor.execute('''
                    DELETE FROM timetable 
                    WHERE class_id = ? AND day_of_week = ? AND start_time = ?
                ''', (class_id, day, start_time))
                
                # Insert new entry if subject is provided
                if subject_var.get().strip():
                    self.cursor.execute('''
                        INSERT INTO timetable (class_id, day_of_week, start_time, end_time, subject, room)
                        VALUES (?, ?, ?, ?, ?, ?)
                    ''', (class_id, day, start_time, end_time, 
                         subject_var.get(), room_var.get()))
                
                self.conn.commit()
                edit_window.destroy()
                self.load_timetable_data()
                
            except Exception as e:
                messagebox.showerror("Error", f"Failed to save timetable entry: {str(e)}")
        
        save_btn = tk.Button(content, text="Save", command=save_timetable_entry,
                            font=('Segoe UI', 11, 'bold'), bg='#007bff', fg='white',
                            relief='solid', bd=0, padx=20, pady=8)
        save_btn.pack(pady=10)
        
        # Load existing data
        try:
            if hasattr(self, 'selected_class') and self.selected_class.get():
                class_name = self.selected_class.get().split(' (')[0]
                start_time = time_slot.split('-')[0]
                
                self.cursor.execute('''
                    SELECT t.subject, t.room
                    FROM timetable t
                    JOIN classes c ON t.class_id = c.id
                    WHERE c.class_name = ? AND t.day_of_week = ? AND t.start_time = ?
                ''', (class_name, day, start_time))
                
                result = self.cursor.fetchone()
                if result:
                    subject_var.set(result[0])
                    room_var.set(result[1] or "")
        except Exception as e:
            print(f"Error loading timetable data: {e}")
    
    def load_timetable_data(self):
        """Load timetable data into grid"""
        if not hasattr(self, 'timetable_cells'):
            return
        
        # Reset all cells
        for cell in self.timetable_cells.values():
            cell.config(text="Free", bg='#ffffff')
        
        try:
            if hasattr(self, 'selected_class') and self.selected_class.get():
                class_name = self.selected_class.get().split(' (')[0]
                
                self.cursor.execute('''
                    SELECT t.day_of_week, t.start_time, t.end_time, t.subject, t.room
                    FROM timetable t
                    JOIN classes c ON t.class_id = c.id
                    WHERE c.class_name = ?
                ''', (class_name,))
                
                for day, start_time, end_time, subject, room in self.cursor.fetchall():
                    time_slot = f"{start_time}-{end_time}"
                    cell_key = f"{day}_{time_slot}"
                    
                    if cell_key in self.timetable_cells:
                        display_text = subject
                        if room:
                            display_text += f"\n({room})"
                        
                        self.timetable_cells[cell_key].config(
                            text=display_text, 
                            bg='#e3f2fd'
                        )
                        
        except Exception as e:
            print(f"Error loading timetable: {e}")
    
    # Quick task creation methods
    def create_reading_task(self):
        """Create reading assignment task"""
        self.create_quick_task("Reading Assignment", "ℹ️")
    
    def create_writing_task(self):
        """Create writing task"""
        self.create_quick_task("Writing Task", "✏️")
    
    def create_math_task(self):
        """Create math practice task"""
        self.create_quick_task("Math Practice", "º«")
    
    def create_quick_quiz(self):
        """Create quick quiz/assessment"""
        self.create_quick_task("Quick Quiz", "❓")
    
    def create_group_activity(self):
        """Create group activity task"""
        self.create_quick_task("Group Activity", "👥")
    
    def create_homework_reminder(self):
        """Create homework reminder"""
        self.create_quick_task("Homework Reminder", "📝")
    
    def create_class_announcement(self):
        """Create class announcement"""
        self.create_quick_task("Class Announcement", "📢")
    
    def create_study_guide(self):
        """Create study guide task"""
        self.create_quick_task("Study Guide", "📖")
    
    def create_project_milestone(self):
        """Create project milestone"""
        self.create_quick_task("Project Milestone", "📁")
    
    def create_research_task(self):
        """Create research task"""
        self.create_quick_task("Research Task", "🔬")
    
    def create_creative_task(self):
        """Create creative project"""
        self.create_quick_task("Creative Project", "🎨")
    
    def create_quick_task(self, task_type, icon):
        """Create a quick task with minimal form"""
        if not hasattr(self, 'selected_class') or not self.selected_class.get():
            messagebox.showerror("Error", "Please select a class first")
            return
        
        # Create quick task window
        quick_window = self.create_responsive_window(
            self.root,
            f"Quick {task_type}",
            600, 650,
            min_width=550, min_height=600,
            max_width=800, max_height=850
        )
        quick_window.configure(bg='#ffffff')
        
        # Header
        header = tk.Frame(quick_window, bg='#28a745')
        header.pack(fill='x')
        
        tk.Label(header, text=f"{icon} Quick {task_type}", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#28a745').pack(pady=15)
        
        # Content frame with scrollbar
        content_canvas = tk.Canvas(quick_window, bg='#ffffff')
        content_scrollbar = ttk.Scrollbar(quick_window, orient='vertical', command=content_canvas.yview)
        content_canvas.configure(yscrollcommand=content_scrollbar.set)
        
        content = tk.Frame(content_canvas, bg='#ffffff')
        content_canvas.create_window((0, 0), window=content, anchor='nw')
        
        content_canvas.pack(side='left', fill='both', expand=True, padx=20, pady=20)
        content_scrollbar.pack(side='right', fill='y', pady=20)
        
        # Update scroll region when content changes
        def configure_scroll(event=None):
            content_canvas.configure(scrollregion=content_canvas.bbox('all'))
        content.bind('<Configure>', configure_scroll)
        
        # Pre-filled templates based on task type
        templates = self.get_quick_task_templates(task_type)
        
        # Template selection
        tk.Label(content, text="Choose Template:", font=('Segoe UI', 10, 'bold'),
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        template_var = tk.StringVar(value=list(templates.keys())[0])
        template_combo = ttk.Combobox(content, textvariable=template_var,
                                     values=list(templates.keys()), state='readonly', width=50)
        template_combo.pack(anchor='w', pady=(5, 15), fill='x')
        
        # Title field
        tk.Label(content, text="Title:", font=('Segoe UI', 10, 'bold'),
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        title_var = tk.StringVar()
        title_entry = tk.Entry(content, textvariable=title_var, font=('Segoe UI', 11), width=60)
        title_entry.pack(anchor='w', pady=(5, 15), fill='x')
        
        # Due date (for assignments)
        if task_type in ["Reading Assignment", "Writing Task", "Math Practice"]:
            tk.Label(content, text="Due Date:", font=('Segoe UI', 10, 'bold'),
                    fg='#2c3e50', bg='#ffffff').pack(anchor='w')
            
            if CALENDAR_AVAILABLE:
                due_date_entry = DateEntry(content, width=25, background='#28a745',
                                          foreground='white', borderwidth=2, font=('Segoe UI', 11))
                due_date_entry.pack(anchor='w', pady=(5, 15))
            else:
                # Fallback to regular entry if DateEntry is not available
                due_date_entry = tk.Entry(content, width=25, font=('Segoe UI', 11))
                due_date_entry.insert(0, datetime.now().strftime("%Y-%m-%d"))
                due_date_entry.pack(anchor='w', pady=(5, 15))
        
        # Description field
        tk.Label(content, text="Description:", font=('Segoe UI', 10, 'bold'),
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        desc_text = tk.Text(content, height=6, font=('Segoe UI', 10), wrap='word')
        desc_text.pack(fill='both', pady=(5, 15), expand=True)
        
        # Auto-fill template on selection
        def update_template(*args):
            selected_template = template_var.get()
            if selected_template in templates:
                template_data = templates[selected_template]
                title_var.set(template_data.get('title', ''))
                desc_text.delete('1.0', 'end')
                desc_text.insert('1.0', template_data.get('description', ''))
        
        template_var.trace('w', update_template)
        update_template()  # Initial load
        
        # Buttons
        button_frame = tk.Frame(content, bg='#ffffff')
        button_frame.pack(fill='x', pady=(10, 0))
        
        def save_quick_task():
            try:
                class_name = self.selected_class.get().split(' (')[0]
                
                # Get class ID
                self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
                class_result = self.cursor.fetchone()
                if not class_result:
                    messagebox.showerror("Error", "Class not found")
                    return
                
                class_id = class_result[0]
                
                from datetime import datetime, date
                assigned_date = datetime.now().strftime("%Y-%m-%d")
                
                if task_type in ["Reading Assignment", "Writing Task", "Math Practice"]:
                    # Save as homework
                    due_date = due_date_entry.get_date().strftime('%Y-%m-%d')
                    self.cursor.execute('''
                        INSERT INTO homework (class_id, subject, title, description, assigned_date, due_date, status)
                        VALUES (?, ?, ?, ?, ?, ?, ?)
                    ''', (class_id, task_type, title_var.get(), desc_text.get("1.0", "end-1c"),
                         assigned_date, due_date, 'active'))
                else:
                    # Save as announcement/note
                    self.cursor.execute('''
                        INSERT INTO lesson_plans (class_id, subject, lesson_title, objectives, 
                                                content, activities, materials, assessment, 
                                                lesson_date, duration_minutes, status)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ''', (class_id, task_type, title_var.get(), 'Quick task created',
                         desc_text.get("1.0", "end-1c"), 'Immediate', 'None', 'Completion',
                         assigned_date, 15, 'planned'))
                
                self.conn.commit()
                messagebox.showinfo("Success", f"{task_type} created successfully!")
                quick_window.destroy()
                
                # Refresh relevant data
                if hasattr(self, 'homework_tree') and task_type in ["Reading Assignment", "Writing Task", "Math Practice"]:
                    self.load_homework_data()
                if hasattr(self, 'lesson_tree'):
                    self.load_lesson_plans_data()
                    
                # Refresh assignment summary
                if hasattr(self, 'cards_frame'):
                    self.refresh_assignment_summary()
                
            except Exception as e:
                messagebox.showerror("Error", f"Failed to save task: {str(e)}")
        
        cancel_btn = tk.Button(button_frame, text="Cancel", 
                              command=quick_window.destroy,
                              font=('Segoe UI', 10), bg='#6c757d', fg='white',
                              relief='solid', bd=0, padx=20, pady=8)
        cancel_btn.pack(side='right', padx=(10, 0))
        
        save_btn = tk.Button(button_frame, text="Create Task", 
                            command=save_quick_task,
                            font=('Segoe UI', 10, 'bold'), bg='#28a745', fg='white',
                            relief='solid', bd=0, padx=20, pady=8)
        save_btn.pack(side='right')
        
    def get_quick_task_templates(self, task_type):
        """Get predefined templates for quick tasks"""
        templates = {
            "Reading Assignment": {
                "Basic Reading": {
                    "title": "Daily Reading Assignment",
                    "description": "Read pages ___ to ___ from the textbook.\n\nFocus on:\n- Main ideas and themes\n- New vocabulary words\n- Character development\n\nPrepare to discuss key points in class."
                },
                "Chapter Review": {
                    "title": "Chapter Review Reading",
                    "description": "Complete reading of Chapter ___.\n\nTasks:\n1. Read the entire chapter\n2. Write a brief summary (150-200 words)\n3. Note any questions for class discussion\n4. Complete chapter review questions"
                },
                "Research Reading": {
                    "title": "Research Article Reading",
                    "description": "Read the assigned research article/document.\n\nAnalyze:\n- Author's main argument\n- Supporting evidence\n- Conclusions drawn\n\nPrepare a one-page response."
                }
            },
            "Writing Task": {
                "Essay Assignment": {
                    "title": "Short Essay Assignment",
                    "description": "Write a 300-500 word essay on the given topic.\n\nRequirements:\n- Clear introduction and conclusion\n- At least 3 supporting paragraphs\n- Proper grammar and spelling\n- Citations if using sources"
                },
                "Creative Writing": {
                    "title": "Creative Writing Exercise",
                    "description": "Creative writing assignment:\n\nInstructions:\n- Choose your preferred format (story, poem, script)\n- Minimum 250 words\n- Use vivid descriptions\n- Include dialogue if appropriate"
                },
                "Summary Writing": {
                    "title": "Summary Assignment",
                    "description": "Write a summary of today's lesson/reading.\n\nInclude:\n- Key concepts learned\n- Important examples\n- Your understanding of the material\n- Any remaining questions"
                }
            },
            "Math Practice": {
                "Problem Set": {
                    "title": "Math Practice Problems",
                    "description": "Complete the assigned problem set.\n\nInstructions:\n- Show all work clearly\n- Box your final answers\n- Check your solutions\n- Ask questions about difficult problems"
                },
                "Review Exercises": {
                    "title": "Chapter Review Exercises",
                    "description": "Practice problems for chapter review.\n\nComplete:\n- Even-numbered problems from pages ___\n- Word problems on page ___\n- Check answers using provided solutions"
                },
                "Application Problems": {
                    "title": "Real-World Math Applications",
                    "description": "Solve real-world application problems.\n\nFocus on:\n- Understanding the problem context\n- Setting up equations correctly\n- Interpreting results\n- Explaining your reasoning"
                }
            },
            "Quick Quiz": {
                "Pop Quiz": {
                    "title": "Pop Quiz - Chapter Review",
                    "description": "Short quiz on recent material.\n\nTopics covered:\n- Key concepts from this week\n- Vocabulary terms\n- Application problems\n\nFormat: 5-10 questions, 15 minutes"
                },
                "Exit Ticket": {
                    "title": "Exit Ticket Assessment",
                    "description": "Quick assessment before leaving class.\n\nQuestions:\n1. What was the main concept today?\n2. What questions do you still have?\n3. Rate your understanding (1-5 scale)"
                },
                "Review Quiz": {
                    "title": "Weekly Review Quiz",
                    "description": "Review quiz covering this week's material.\n\nPreparation:\n- Review notes and homework\n- Practice similar problems\n- Ask questions about unclear concepts"
                }
            },
            "Group Activity": {
                "Team Project": {
                    "title": "Collaborative Team Project",
                    "description": "Work in groups of 3-4 students.\n\nAssignment:\n- Divide tasks among team members\n- Research assigned topic\n- Prepare group presentation\n- Submit individual reflection"
                },
                "Peer Review": {
                    "title": "Peer Review Activity",
                    "description": "Partner with a classmate for peer review.\n\nProcess:\n1. Exchange work with partner\n2. Provide constructive feedback\n3. Discuss suggestions\n4. Revise based on feedback"
                },
                "Discussion Group": {
                    "title": "Small Group Discussion",
                    "description": "Discuss assigned topic in small groups.\n\nGuidelines:\n- Everyone participates\n- Stay on topic\n- Take turns sharing ideas\n- Prepare group summary for class"
                }
            },
            "Homework Reminder": {
                "Assignment Due": {
                    "title": "Homework Due Tomorrow",
                    "description": "Reminder: Assignment due next class.\n\nDon't forget:\n- Complete all required parts\n- Show your work clearly\n- Review before submitting\n- Ask questions if needed"
                },
                "Project Deadline": {
                    "title": "Project Deadline Approaching",
                    "description": "Project deadline reminder.\n\nFinal checklist:\n- All sections completed\n- Proper formatting applied\n- Sources cited correctly\n- Proofread for errors"
                },
                "Test Preparation": {
                    "title": "Test Preparation Reminder",
                    "description": "Test coming up - time to prepare!\n\nStudy suggestions:\n- Review all notes and homework\n- Practice sample problems\n- Form study groups\n- Get plenty of rest"
                }
            },
            "Class Announcement": {
                "Schedule Change": {
                    "title": "Important Schedule Update",
                    "description": "Class schedule change notification.\n\nDetails:\n- Date affected: ___\n- Time change: ___\n- Location change: ___\n- What to bring: ___"
                },
                "Special Event": {
                    "title": "Special Classroom Event",
                    "description": "Announcement about upcoming special event.\n\nEvent details:\n- Date and time\n- Location\n- Purpose\n- What students need to do"
                },
                "General Notice": {
                    "title": "Important Class Notice",
                    "description": "General class announcement.\n\nPlease note:\n- Important information for all students\n- Action required (if any)\n- Deadline (if applicable)\n- Contact for questions"
                }
            },
            "Study Guide": {
                "Test Prep Guide": {
                    "title": "Test Preparation Study Guide",
                    "description": "Study guide for upcoming test.\n\nKey topics to review:\n1. [Topic 1] - Pages ___\n2. [Topic 2] - Pages ___\n3. [Topic 3] - Pages ___\n\nPractice problems: ___"
                },
                "Chapter Summary": {
                    "title": "Chapter Study Summary",
                    "description": "Study guide for chapter review.\n\nMain concepts:\n- Key definitions\n- Important formulas\n- Sample problems\n- Review questions"
                },
                "Exam Checklist": {
                    "title": "Final Exam Study Checklist",
                    "description": "Comprehensive study checklist.\n\nWhat to review:\n☑️ All chapter summaries\n☑️ Homework problems\n☑️ Quiz corrections\n☑️ Class notes\n☑️ Practice tests"
                }
            },
            "Project Milestone": {
                "Progress Check": {
                    "title": "Project Progress Checkpoint",
                    "description": "Check progress on ongoing project.\n\nMilestone requirements:\n- Show current progress\n- Identify challenges\n- Plan next steps\n- Get feedback"
                },
                "Draft Submission": {
                    "title": "Project Draft Due",
                    "description": "Submit draft version of project.\n\nDraft should include:\n- Introduction completed\n- Main sections outlined\n- Sources gathered\n- Initial analysis"
                },
                "Peer Presentation": {
                    "title": "Project Peer Presentation",
                    "description": "Present project progress to peers.\n\nPresentation format:\n- 5-minute overview\n- Key findings so far\n- Questions for feedback\n- Next steps planned"
                }
            }
        }
        
        # For other task types, provide general templates
        if task_type not in templates:
            templates[task_type] = {
                "Standard Template": {
                    "title": f"{task_type} Activity",
                    "description": f"Complete the {task_type.lower()} as assigned.\n\nInstructions will be provided in class.\n\nDue date as specified."
                }
            }
        
        return templates[task_type]
    
    def create_assignment_summary(self, parent):
        """Create assignment summary and analytics with real-time data"""
        summary_content = tk.Frame(parent, bg='#ffffff')
        summary_content.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Auto-refresh controls
        refresh_frame = tk.Frame(summary_content, bg='#ffffff')
        refresh_frame.pack(fill='x', pady=(0, 10))
        
        tk.Label(refresh_frame, text="📈 Real-Time Assignment Analytics", 
                font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#ffffff').pack(side='left')
        
        refresh_btn = tk.Button(refresh_frame, text="🔄 Refresh Data", 
                               command=self.refresh_assignment_summary,
                               font=('Segoe UI', 9), bg='#007bff', fg='white',
                               relief='solid', bd=0, padx=10, pady=5)
        refresh_btn.pack(side='right')
        
        # Countdown timer display
        self.countdown_label = tk.Label(refresh_frame, text="Next refresh: 30s", 
                                       font=('Segoe UI', 8), fg='#007bff', bg='#ffffff')
        self.countdown_label.pack(side='right', padx=(0, 10))
        
        auto_refresh_var = tk.BooleanVar(value=True)
        auto_refresh_cb = tk.Checkbutton(refresh_frame, text="Auto-refresh", 
                                        variable=auto_refresh_var, 
                                        command=lambda: self.toggle_auto_refresh(auto_refresh_var.get()),
                                        font=('Segoe UI', 9), bg='#ffffff')
        auto_refresh_cb.pack(side='right', padx=(0, 10))
        
        # Initialize countdown
        self.countdown_seconds = 30
        self.countdown_active = True
        
        # Summary cards frame
        self.cards_frame = tk.Frame(summary_content, bg='#ffffff')
        self.cards_frame.pack(fill='x', pady=(0, 20))
        
        # Detailed analytics section
        analytics_frame = tk.Frame(summary_content, bg='#f8f9fa', relief='solid', bd=1)
        analytics_frame.pack(fill='both', expand=True, pady=(0, 20))
        
        tk.Label(analytics_frame, text="📊 📊 📊 Detailed Analytics", 
                font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#f8f9fa').pack(pady=(10, 5))
        
        # Analytics content frame (scrollable)
        analytics_canvas = tk.Canvas(analytics_frame, bg='#f8f9fa', highlightthickness=0, height=200)
        analytics_scrollbar = tk.Scrollbar(analytics_frame, orient="vertical", command=analytics_canvas.yview)
        self.analytics_content = tk.Frame(analytics_canvas, bg='#f8f9fa')
        
        self.analytics_content.bind(
            "<Configure>",
            lambda e: analytics_canvas.configure(scrollregion=analytics_canvas.bbox("all"))
        )
        
        analytics_canvas.create_window((0, 0), window=self.analytics_content, anchor="nw")
        analytics_canvas.configure(yscrollcommand=analytics_scrollbar.set)
        
        analytics_canvas.pack(side="left", fill="both", expand=True, padx=10, pady=10)
        analytics_scrollbar.pack(side="right", fill="y", pady=10)
        
        # Store reference for updates
        self.summary_content_frame = summary_content
        self.auto_refresh_enabled = True
        
        # Initial data load
        self.refresh_assignment_summary()
        
        # Start auto-refresh
        self.schedule_auto_refresh()
    
    def get_real_time_summary_data(self):
        """Fetch real-time summary data from database"""
        try:
            summary_data = []
            
            # Get current class for teacher
            if hasattr(self, 'selected_class') and self.selected_class.get():
                class_name = self.selected_class.get().split(' (')[0]
                
                # Get class ID
                self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
                class_result = self.cursor.fetchone()
                
                if class_result:
                    class_id = class_result[0]
                    
                    # Active Homework count
                    self.cursor.execute('''
                        SELECT COUNT(*) FROM homework 
                        WHERE class_id = ? AND status = 'active'
                    ''', (class_id,))
                    homework_count = self.cursor.fetchone()[0]
                    
                    # Upcoming Tests count (next 30 days)
                    self.cursor.execute('''
                        SELECT COUNT(*) FROM tests 
                        WHERE class_id = ? AND status = 'scheduled' 
                        AND test_date >= date('now') AND test_date <= date('now', '+30 days')
                    ''', (class_id,))
                    test_count = self.cursor.fetchone()[0]
                    
                    # Active Lesson Plans count (current month)
                    self.cursor.execute('''
                        SELECT COUNT(*) FROM lesson_plans 
                        WHERE class_id = ? AND status = 'planned'
                        AND strftime('%Y-%m', lesson_date) = strftime('%Y-%m', 'now')
                    ''', (class_id,))
                    lesson_count = self.cursor.fetchone()[0]
                    
                    # Active Projects count
                    self.cursor.execute('''
                        SELECT COUNT(*) FROM projects 
                        WHERE class_id = ? AND status = 'active'
                    ''', (class_id,))
                    project_count = self.cursor.fetchone()[0]
                    
                    # Overdue assignments count
                    self.cursor.execute('''
                        SELECT COUNT(*) FROM homework 
                        WHERE class_id = ? AND status = 'active' 
                        AND due_date < date('now')
                    ''', (class_id,))
                    overdue_count = self.cursor.fetchone()[0]
                    
                    # Students attendance rate (current month)
                    self.cursor.execute('''
                        SELECT 
                            COUNT(CASE WHEN a.present = 1 THEN 1 END) * 100.0 / COUNT(*) as attendance_rate
                        FROM attendance a
                        JOIN students s ON a.student_id = s.id
                        WHERE s.class_id = ? 
                        AND strftime('%Y-%m', a.date) = strftime('%Y-%m', 'now')
                    ''', (class_id,))
                    attendance_result = self.cursor.fetchone()
                    attendance_rate = round(attendance_result[0] if attendance_result[0] else 0, 1)
                    
                    summary_data = [
                        ("Active Homework", str(homework_count), "#28a745"),
                        ("Upcoming Tests", str(test_count), "#dc3545"),
                        ("Lesson Plans", str(lesson_count), "#17a2b8"),
                        ("Active Projects", str(project_count), "#fd7e14"),
                        ("Overdue Tasks", str(overdue_count), "#6f42c1"),
                        ("Attendance Rate", f"{attendance_rate}%", "#20c997")
                    ]
                else:
                    summary_data = [("No Class Selected", "0", "#6c757d")]
            else:
                summary_data = [("Select a Class", "0", "#6c757d")]
                
            return summary_data
            
        except Exception as e:
            print(f"Error fetching summary data: {e}")
            return [("Error Loading", "0", "#dc3545")]
    
    def refresh_assignment_summary(self):
        """Refresh the assignment summary with real-time data"""
        try:
            # Clear existing cards
            for widget in self.cards_frame.winfo_children():
                widget.destroy()
            
            # Get real-time data
            summary_data = self.get_real_time_summary_data()
            
            # Create updated cards
            for title, count, color in summary_data:
                card = tk.Frame(self.cards_frame, bg=color, relief='solid', bd=1)
                card.pack(side='left', fill='y', padx=5, ipadx=20, ipady=15)
                
                count_label = tk.Label(card, text=count, font=('Segoe UI', 24, 'bold'), 
                                     fg='white', bg=color)
                count_label.pack()
                
                title_label = tk.Label(card, text=title, font=('Segoe UI', 10), 
                                     fg='white', bg=color)
                title_label.pack()
            
            # Update detailed analytics
            self.refresh_detailed_analytics()
            
            # Add last updated timestamp
            from datetime import datetime
            timestamp = datetime.now().strftime("%H:%M:%S")
            
            # Update or create timestamp label
            if hasattr(self, 'timestamp_label'):
                self.timestamp_label.destroy()
            
            self.timestamp_label = tk.Label(self.summary_content_frame, 
                                          text=f"Last updated: {timestamp}", 
                                          font=('Segoe UI', 8), fg='#6c757d', bg='#ffffff')
            self.timestamp_label.pack(anchor='e', padx=20)
            
        except Exception as e:
            print(f"Error refreshing summary: {e}")
    
    def toggle_auto_refresh(self, enabled):
        """Toggle auto-refresh functionality"""
        self.auto_refresh_enabled = enabled
        self.countdown_active = enabled
        if enabled:
            self.schedule_auto_refresh()
        else:
            # Update countdown display when disabled
            if hasattr(self, 'countdown_label'):
                self.countdown_label.config(text="Auto-refresh disabled")
    
    def schedule_auto_refresh(self):
        """Schedule automatic refresh of summary data with countdown"""
        if hasattr(self, 'auto_refresh_enabled') and self.auto_refresh_enabled:
            # Reset countdown
            self.countdown_seconds = 30
            self.countdown_active = True
            # Start countdown timer
            self.update_countdown()
            # Schedule next refresh in 30 seconds
            self.root.after(30000, self.auto_refresh_callback)
    
    def auto_refresh_callback(self):
        """Callback for automatic refresh"""
        if hasattr(self, 'auto_refresh_enabled') and self.auto_refresh_enabled:
            self.refresh_assignment_summary()
            self.schedule_auto_refresh()
    
    def update_countdown(self):
        """Update countdown timer display"""
        if hasattr(self, 'countdown_active') and self.countdown_active and hasattr(self, 'countdown_label'):
            if self.countdown_seconds > 0:
                self.countdown_label.config(text=f"Next refresh: {self.countdown_seconds}s")
                self.countdown_seconds -= 1
                # Schedule next countdown update in 1 second
                self.root.after(1000, self.update_countdown)
            else:
                self.countdown_label.config(text="Refreshing...")
        elif hasattr(self, 'countdown_label') and not getattr(self, 'countdown_active', False):
            self.countdown_label.config(text="Auto-refresh disabled")
    
    def refresh_detailed_analytics(self):
        """Refresh detailed analytics section with real-time data"""
        try:
            # Clear existing analytics
            for widget in self.analytics_content.winfo_children():
                widget.destroy()
            
            if hasattr(self, 'selected_class') and self.selected_class.get():
                class_name = self.selected_class.get().split(' (')[0]
                
                # Get class ID
                self.cursor.execute('SELECT id FROM classes WHERE class_name = ?', (class_name,))
                class_result = self.cursor.fetchone()
                
                if class_result:
                    class_id = class_result[0]
                    
                    # Assignment completion rates
                    completion_frame = tk.Frame(self.analytics_content, bg='#ffffff', relief='solid', bd=1)
                    completion_frame.pack(fill='x', padx=10, pady=5)
                    
                    tk.Label(completion_frame, text="📈 Assignment Completion Trends", 
                            font=('Segoe UI', 11, 'bold'), fg='#2c3e50', bg='#ffffff').pack(pady=5)
                    
                    # Recent homework completion
                    self.cursor.execute('''
                        SELECT 
                            h.title,
                            h.due_date,
                            COUNT(CASE WHEN h.due_date >= date('now') THEN 1 END) as pending,
                            COUNT(CASE WHEN h.due_date < date('now') THEN 1 END) as overdue
                        FROM homework h
                        WHERE h.class_id = ? AND h.status = 'active'
                        GROUP BY h.id, h.title, h.due_date
                        ORDER BY h.due_date DESC
                        LIMIT 5
                    ''', (class_id,))
                    
                    homework_data = self.cursor.fetchall()
                    
                    for hw in homework_data:
                        title, due_date, pending, overdue = hw
                        status_color = "#28a745" if pending > 0 else "#dc3545"
                        status_text = "Pending" if pending > 0 else "Overdue"
                        
                        hw_row = tk.Frame(completion_frame, bg='#f8f9fa')
                        hw_row.pack(fill='x', padx=10, pady=2)
                        
                        tk.Label(hw_row, text=f"• {title[:30]}{'...' if len(title) > 30 else ''}", 
                                font=('Segoe UI', 9), bg='#f8f9fa').pack(side='left')
                        tk.Label(hw_row, text=f"Due: {due_date}", 
                                font=('Segoe UI', 8), fg='#6c757d', bg='#f8f9fa').pack(side='left', padx=(10, 0))
                        tk.Label(hw_row, text=status_text, 
                                font=('Segoe UI', 8, 'bold'), fg=status_color, bg='#f8f9fa').pack(side='right')
                    
                    # Student performance metrics
                    performance_frame = tk.Frame(self.analytics_content, bg='#ffffff', relief='solid', bd=1)
                    performance_frame.pack(fill='x', padx=10, pady=5)
                    
                    tk.Label(performance_frame, text="👥 Student Performance Metrics", 
                            font=('Segoe UI', 11, 'bold'), fg='#2c3e50', bg='#ffffff').pack(pady=5)
                    
                    # Attendance statistics
                    self.cursor.execute('''
                        SELECT 
                            AVG(CASE WHEN a.present = 1 THEN 100.0 ELSE 0.0 END) as avg_attendance,
                            COUNT(DISTINCT a.student_id) as total_students,
                            COUNT(DISTINCT a.date) as total_days
                        FROM attendance a
                        JOIN students s ON a.student_id = s.id
                        WHERE s.class_id = ? 
                        AND strftime('%Y-%m', a.date) = strftime('%Y-%m', 'now')
                    ''', (class_id,))
                    
                    perf_result = self.cursor.fetchone()
                    if perf_result:
                        avg_attendance, total_students, total_days = perf_result
                        avg_attendance = round(avg_attendance or 0, 1)
                        
                        perf_row = tk.Frame(performance_frame, bg='#f8f9fa')
                        perf_row.pack(fill='x', padx=10, pady=2)
                        
                        tk.Label(perf_row, text=f"Average Attendance: {avg_attendance}%", 
                                font=('Segoe UI', 9), bg='#f8f9fa').pack(side='left')
                        tk.Label(perf_row, text=f"Students: {total_students or 0}", 
                                font=('Segoe UI', 9), bg='#f8f9fa').pack(side='right')
                    
                    # Recent activity feed
                    activity_frame = tk.Frame(self.analytics_content, bg='#ffffff', relief='solid', bd=1)
                    activity_frame.pack(fill='x', padx=10, pady=5)
                    
                    tk.Label(activity_frame, text="📝 Recent Activity", 
                            font=('Segoe UI', 11, 'bold'), fg='#2c3e50', bg='#ffffff').pack(pady=5)
                    
                    # Get recent activities (homework, tests, projects)
                    activities = []
                    
                    # Recent homework
                    self.cursor.execute('''
                        SELECT 'Homework' as type, title, assigned_date as date
                        FROM homework WHERE class_id = ?
                        ORDER BY assigned_date DESC LIMIT 3
                    ''', (class_id,))
                    activities.extend(self.cursor.fetchall())
                    
                    # Recent tests
                    self.cursor.execute('''
                        SELECT 'Test' as type, title, test_date as date
                        FROM tests WHERE class_id = ?
                        ORDER BY test_date DESC LIMIT 3
                    ''', (class_id,))
                    activities.extend(self.cursor.fetchall())
                    
                    # Sort by date
                    activities.sort(key=lambda x: x[2], reverse=True)
                    
                    for activity_type, title, date in activities[:6]:
                        activity_row = tk.Frame(activity_frame, bg='#f8f9fa')
                        activity_row.pack(fill='x', padx=10, pady=2)
                        
                        icon = "ℹ️" if activity_type == "Homework" else "📝"
                        tk.Label(activity_row, text=f"{icon} {activity_type}: {title[:25]}{'...' if len(title) > 25 else ''}", 
                                font=('Segoe UI', 9), bg='#f8f9fa').pack(side='left')
                        tk.Label(activity_row, text=date, 
                                font=('Segoe UI', 8), fg='#6c757d', bg='#f8f9fa').pack(side='right')
                else:
                    tk.Label(self.analytics_content, text="No class data available", 
                            font=('Segoe UI', 10), fg='#6c757d', bg='#f8f9fa').pack(pady=20)
            else:
                tk.Label(self.analytics_content, text="Please select a class to view analytics", 
                        font=('Segoe UI', 10), fg='#6c757d', bg='#f8f9fa').pack(pady=20)
                
        except Exception as e:
            print(f"Error refreshing detailed analytics: {e}")
            tk.Label(self.analytics_content, text=f"Error loading analytics: {str(e)}", 
                    font=('Segoe UI', 9), fg='#dc3545', bg='#f8f9fa').pack(pady=10)
    
    def on_class_selection_changed(self, event=None):
        """Handle class selection change to refresh assignment summary"""
        try:
            # Refresh assignment summary when class changes
            if hasattr(self, 'cards_frame'):
                self.refresh_assignment_summary()
            
            # Also refresh other data displays that depend on class selection
            if hasattr(self, 'homework_tree'):
                self.load_homework_data()
            if hasattr(self, 'test_tree'):
                self.load_test_data()
            if hasattr(self, 'lesson_tree'):
                self.load_lesson_plans_data()
            if hasattr(self, 'project_tree'):
                self.load_project_data()
                
        except Exception as e:
            print(f"Error refreshing data on class change: {e}")
    
    # Context menu methods (placeholders)
    def show_homework_context_menu(self, event):
        """Show context menu for homework"""
        pass
    
    def edit_homework(self, event):
        """Edit selected homework"""
        pass
    
    def show_test_context_menu(self, event):
        """Show context menu for test"""
        pass
    
    def edit_test(self, event):
        """Edit selected test"""
        pass
    
    def show_lesson_context_menu(self, event):
        """Show context menu for lesson"""
        pass
    
    def edit_lesson_plan(self, event):
        """Edit selected lesson plan"""
        pass
    
    def show_project_context_menu(self, event):
        """Show context menu for project"""
        pass
    
    def edit_project(self, event):
        """Edit selected project"""
        pass
    
    def add_timetable_period(self):
        """Add new timetable period"""
        messagebox.showinfo("Timetable", "Click on any time slot in the timetable grid to add/edit a period")
    
    # Placeholder methods for assignment and grading functionality
    def create_new_assignment(self):
        messagebox.showinfo("Feature", "Create new assignment feature - Coming soon!")
    
    def quick_create_assignment(self, assignment_type):
        messagebox.showinfo("Feature", f"Quick create {assignment_type} - Coming soon!")
    
    def create_assignments_list(self, parent):
        tk.Label(parent, text="📋 Assignment list will be displayed here", 
                font=('Segoe UI', 12), fg='#6c757d', bg='#ffffff').pack(pady=50)
    
    def submit_grade(self):
        """Submit and save student grade to database"""
        try:
            # Validate inputs
            student_name_with_id = self.grade_student_var.get().strip()
            assignment_name = self.grade_assignment_var.get().strip()
            grade_value = self.grade_value_var.get().strip()
            
            if not student_name_with_id:
                messagebox.showwarning("Missing Input", "Please select a student")
                return
            
            if not assignment_name:
                messagebox.showwarning("Missing Input", "Please select an assignment/test")
                return
            
            if not grade_value:
                messagebox.showwarning("Missing Input", "Please enter a grade")
                return
            
            # Validate grade is numeric
            try:
                grade = float(grade_value)
                if grade < 0 or grade > 100:
                    messagebox.showwarning("Invalid Grade", "Grade must be between 0 and 100")
                    return
            except ValueError:
                messagebox.showwarning("Invalid Grade", "Grade must be a valid number")
                return
            
            # Extract student name from "Name (ID)" format
            if '(' in student_name_with_id and ')' in student_name_with_id:
                student_name = student_name_with_id.split('(')[0].strip()
            else:
                student_name = student_name_with_id
            
            # Get student ID from name
            self.cursor.execute("SELECT id FROM students WHERE name = ?", (student_name,))
            student_result = self.cursor.fetchone()
            
            if not student_result:
                messagebox.showerror("Error", f"Student not found: {student_name}")
                return
            
            student_id = student_result[0]
            
            # Get teacher ID if logged in as teacher
            teacher_id = None
            if self.current_user.get('role') == 'teacher':
                self.cursor.execute("SELECT id FROM teachers WHERE name = ?", (self.current_user.get('full_name'),))
                teacher_result = self.cursor.fetchone()
                if teacher_result:
                    teacher_id = teacher_result[0]
            
            # Insert grade into database
            self.cursor.execute('''
                INSERT INTO grades (student_id, assignment_name, grade, teacher_id, date_submitted)
                VALUES (?, ?, ?, ?, DATE('now'))
            ''', (student_id, assignment_name, grade, teacher_id))
            
            self.conn.commit()
            
            messagebox.showinfo("Success", f"Grade {grade}% submitted successfully for {student_name}!")
            
            # Clear inputs
            self.grade_student_var.set('')
            self.grade_assignment_var.set('')
            self.grade_value_var.set('')
            
            # Refresh grades display if it exists
            if hasattr(self, 'refresh_grades_display'):
                self.refresh_grades_display()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to submit grade: {str(e)}")
    
    def create_performance_stats(self, parent):
        """Display grades list and performance statistics"""
        # Create container for grades list
        grades_container = tk.Frame(parent, bg='#ffffff')
        grades_container.pack(fill='both', expand=True, padx=20, pady=10)
        
        # Header with refresh button
        header_frame = tk.Frame(grades_container, bg='#ffffff')
        header_frame.pack(fill='x', pady=(0, 10))
        
        tk.Label(header_frame, text="📊 Recent Grades", 
                font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#ffffff').pack(side='left')
        
        refresh_btn = tk.Button(header_frame, text="🔄 Refresh", 
                               command=self.refresh_grades_display,
                               font=('Segoe UI', 9, 'bold'), bg='#3498db', fg='white',
                               relief='flat', bd=0, padx=10, pady=5, cursor='hand2')
        refresh_btn.pack(side='right')
        
        # Create treeview for grades
        tree_frame = tk.Frame(grades_container, bg='#ffffff')
        tree_frame.pack(fill='both', expand=True)
        
        # Scrollbars
        vsb = tk.Scrollbar(tree_frame, orient="vertical")
        hsb = tk.Scrollbar(tree_frame, orient="horizontal")
        
        # Treeview
        self.grades_tree = ttk.Treeview(tree_frame, 
                                       columns=('Student', 'Assignment', 'Grade', 'Date', 'Teacher'),
                                       show='headings',
                                       yscrollcommand=vsb.set,
                                       xscrollcommand=hsb.set,
                                       height=10)
        
        vsb.config(command=self.grades_tree.yview)
        hsb.config(command=self.grades_tree.xview)
        
        # Column headings
        self.grades_tree.heading('Student', text='Student Name')
        self.grades_tree.heading('Assignment', text='Assignment/Test')
        self.grades_tree.heading('Grade', text='Grade (%)')
        self.grades_tree.heading('Date', text='Date Submitted')
        self.grades_tree.heading('Teacher', text='Teacher')
        
        # Column widths
        self.grades_tree.column('Student', width=200)
        self.grades_tree.column('Assignment', width=200)
        self.grades_tree.column('Grade', width=100)
        self.grades_tree.column('Date', width=120)
        self.grades_tree.column('Teacher', width=150)
        
        # Grid layout
        self.grades_tree.grid(row=0, column=0, sticky='nsew')
        vsb.grid(row=0, column=1, sticky='ns')
        hsb.grid(row=1, column=0, sticky='ew')
        
        tree_frame.grid_rowconfigure(0, weight=1)
        tree_frame.grid_columnconfigure(0, weight=1)
        
        # Load grades
        self.refresh_grades_display()
        
    def refresh_grades_display(self):
        """Refresh the grades display with latest data"""
        if not hasattr(self, 'grades_tree'):
            return
            
        # Clear existing items
        for item in self.grades_tree.get_children():
            self.grades_tree.delete(item)
        
        try:
            # Get grades data
            query = '''
                SELECT s.name, g.assignment_name, g.grade, g.date_submitted, t.name
                FROM grades g
                JOIN students s ON g.student_id = s.id
                LEFT JOIN teachers t ON g.teacher_id = t.id
                ORDER BY g.date_submitted DESC, g.id DESC
                LIMIT 100
            '''
            
            # Filter by teacher's class if logged in as teacher
            if self.current_user.get('role') == 'teacher':
                class_id = self.get_teacher_assigned_class()
                if class_id:
                    query = '''
                        SELECT s.name, g.assignment_name, g.grade, g.date_submitted, t.name
                        FROM grades g
                        JOIN students s ON g.student_id = s.id
                        LEFT JOIN teachers t ON g.teacher_id = t.id
                        WHERE s.class_id = ?
                        ORDER BY g.date_submitted DESC, g.id DESC
                        LIMIT 100
                    '''
                    self.cursor.execute(query, (class_id,))
                else:
                    self.cursor.execute(query)
            else:
                self.cursor.execute(query)
            
            grades = self.cursor.fetchall()
            
            # Insert into treeview
            for grade in grades:
                student_name, assignment, grade_value, date_submitted, teacher_name = grade
                teacher_name = teacher_name or 'N/A'
                
                # Color code by grade
                self.grades_tree.insert('', 'end', values=(
                    student_name,
                    assignment,
                    f"{grade_value:.1f}",
                    date_submitted,
                    teacher_name
                ), tags=('grade',))
            
            # Configure tag colors based on grade
            self.grades_tree.tag_configure('grade', font=('Segoe UI', 10))
            
        except Exception as e:
            print(f"Error refreshing grades: {e}")
    
    # Report generation methods
    def generate_class_performance_report(self):
        """Generate class performance report - redirects to AI report system"""
        if AI_AVAILABLE and self.ai_predictor:
            # Use AI report system
            self.generate_class_report_ui()
        else:
            # Show simple report window
            self.show_simple_class_report()
    
    def show_simple_class_report(self):
        """Show a simple class report without AI"""
        # Get class ID
        class_id = None
        if self.current_user.get('role') == 'teacher':
            class_id = self.get_teacher_assigned_class()
            if not class_id:
                messagebox.showwarning("No Class", "You are not assigned to any class")
                return
        else:
            class_id = self.select_class_dialog()
            if not class_id:
                return
        
        # Create report window
        window = tk.Toplevel(self.root)
        window.title("Class Performance Report")
        window.geometry("800x600")
        window.transient(self.root)
        
        # Scrollable frame
        scroll_frame = ScrollableFrame(window, bg='white')
        scroll_frame.pack(fill=tk.BOTH, expand=True)
        content = scroll_frame.scrollable_frame
        
        # Header with logo
        self.create_report_header(content, "📊 Class Performance Report")
        
        # Get class info
        self.cursor.execute("""
            SELECT c.class_name, c.capacity, COUNT(s.id), t.name
            FROM classes c
            LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
            LEFT JOIN teachers t ON c.class_teacher_id = t.id
            WHERE c.id = ?
            GROUP BY c.id
        """, (class_id,))
        class_info = self.cursor.fetchone()
        
        if class_info:
            # Class Info
            info_frame = tk.LabelFrame(content, text="Class Information", 
                                      font=('Segoe UI', 12, 'bold'), bg='white')
            info_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            info_text = f"""
Class Name: {class_info[0]}
Teacher: {class_info[3] or 'Not assigned'}
Students: {class_info[2]} / {class_info[1]}
"""
            tk.Label(info_frame, text=info_text, font=('Segoe UI', 11), 
                    bg='white', justify=tk.LEFT).pack(padx=15, pady=15, anchor='w')
            
            # Attendance Stats
            self.cursor.execute("""
                SELECT 
                    AVG(CASE WHEN a.present = 1 THEN 100.0 ELSE 0.0 END) as avg_rate,
                    COUNT(DISTINCT a.student_id) as students
                FROM attendance a
                JOIN students s ON a.student_id = s.id
                WHERE s.class_id = ? AND a.date >= date('now', '-30 days')
            """, (class_id,))
            att_stats = self.cursor.fetchone()
            
            if att_stats:
                att_frame = tk.LabelFrame(content, text="Attendance (Last 30 Days)", 
                                         font=('Segoe UI', 12, 'bold'), bg='white')
                att_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
                
                att_text = f"""
Average Attendance Rate: {att_stats[0]:.1f}%
Students Tracked: {att_stats[1]}
"""
                tk.Label(att_frame, text=att_text, font=('Segoe UI', 11), 
                        bg='white', justify=tk.LEFT).pack(padx=15, pady=15, anchor='w')
            
            # Fee Stats
            self.cursor.execute("""
                SELECT 
                    SUM(f.amount_due) as total_due,
                    SUM(f.amount_paid) as total_paid,
                    SUM(f.arrears) as total_arrears
                FROM fees f
                JOIN students s ON f.student_id = s.id
                WHERE s.class_id = ?
            """, (class_id,))
            fee_stats = self.cursor.fetchone()
            
            if fee_stats and fee_stats[0]:
                fee_frame = tk.LabelFrame(content, text="Fee Collection", 
                                         font=('Segoe UI', 12, 'bold'), bg='white')
                fee_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
                
                total_due = fee_stats[0] or 0
                total_paid = fee_stats[1] or 0
                rate = (total_paid / total_due * 100) if total_due > 0 else 0
                
                fee_text = f"""
Total Due: GHS {total_due:.2f}
Total Paid: GHS {total_paid:.2f}
Total Arrears: GHS {fee_stats[2] or 0:.2f}
Collection Rate: {rate:.1f}%
"""
                tk.Label(fee_frame, text=fee_text, font=('Segoe UI', 11), 
                        bg='white', justify=tk.LEFT).pack(padx=15, pady=15, anchor='w')
        
        # Close button
        tk.Button(content, text="Close", command=window.destroy,
                 font=('Segoe UI', 11, 'bold'), bg='#95a5a6', fg='white',
                 padx=20, pady=10).pack(pady=20)
    
    def generate_student_progress_reports(self):
        """Generate individual student progress reports"""
        if AI_AVAILABLE and self.ai_predictor:
            # Use AI report system
            self.generate_student_report_ui()
        else:
            messagebox.showinfo("Feature", 
                              "Please use the AI Reports menu for detailed student reports.\n\n"
                              "Navigate to: 📊 AI Reports → Individual Student Report")
    
    def generate_attendance_report(self):
        """Generate attendance summary report"""
        # Create report window
        window = tk.Toplevel(self.root)
        window.title("Attendance Summary Report")
        window.geometry("900x600")
        window.transient(self.root)
        
        # Scrollable frame
        scroll_frame = ScrollableFrame(window, bg='white')
        scroll_frame.pack(fill=tk.BOTH, expand=True)
        content = scroll_frame.scrollable_frame
        
        # Header with logo
        self.create_report_header(content, "✅ Attendance Summary Report", "Last 30 Days")
        
        # Get attendance data by class
        query = """
            SELECT c.class_name,
                   COUNT(DISTINCT s.id) as total_students,
                   AVG(CASE WHEN a.present = 1 THEN 100.0 ELSE 0.0 END) as avg_attendance
            FROM classes c
            LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
            LEFT JOIN attendance a ON s.id = a.student_id AND a.date >= date('now', '-30 days')
            GROUP BY c.id, c.class_name
            HAVING total_students > 0
            ORDER BY c.class_name
        """
        
        # Filter by teacher's class if needed
        if self.current_user.get('role') == 'teacher':
            class_id = self.get_teacher_assigned_class()
            if class_id:
                query = """
                    SELECT c.class_name,
                           COUNT(DISTINCT s.id) as total_students,
                           AVG(CASE WHEN a.present = 1 THEN 100.0 ELSE 0.0 END) as avg_attendance
                    FROM classes c
                    LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
                    LEFT JOIN attendance a ON s.id = a.student_id AND a.date >= date('now', '-30 days')
                    WHERE c.id = ?
                    GROUP BY c.id, c.class_name
                """
                self.cursor.execute(query, (class_id,))
            else:
                self.cursor.execute(query)
        else:
            self.cursor.execute(query)
        
        classes_data = self.cursor.fetchall()
        
        # Display data
        for class_name, student_count, avg_att in classes_data:
            class_frame = tk.LabelFrame(content, text=class_name, 
                                       font=('Segoe UI', 12, 'bold'), bg='white')
            class_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            avg_att = avg_att or 0
            color = '#27ae60' if avg_att >= 90 else '#f39c12' if avg_att >= 75 else '#e74c3c'
            
            stats_text = f"""
Total Students: {student_count}
Average Attendance: {avg_att:.1f}%
"""
            tk.Label(class_frame, text=stats_text, font=('Segoe UI', 11), 
                    bg='white', fg=color, justify=tk.LEFT).pack(padx=15, pady=15, anchor='w')
        
        # Close button
        tk.Button(content, text="Close", command=window.destroy,
                 font=('Segoe UI', 11, 'bold'), bg='#95a5a6', fg='white',
                 padx=20, pady=10).pack(pady=20)
    
    def generate_fees_report(self):
        """Generate fees status report"""
        # Create report window
        window = tk.Toplevel(self.root)
        window.title("Fees Status Report")
        window.geometry("900x600")
        window.transient(self.root)
        
        # Scrollable frame
        scroll_frame = ScrollableFrame(window, bg='white')
        scroll_frame.pack(fill=tk.BOTH, expand=True)
        content = scroll_frame.scrollable_frame
        
        # Header with logo
        self.create_report_header(content, "💳 Fees Status Report")
        
        # Get fee data by class
        query = """
            SELECT c.class_name,
                   COUNT(DISTINCT s.id) as total_students,
                   SUM(f.amount_due) as total_due,
                   SUM(f.amount_paid) as total_paid,
                   SUM(f.arrears) as total_arrears
            FROM classes c
            LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
            LEFT JOIN fees f ON s.id = f.student_id
            GROUP BY c.id, c.class_name
            HAVING total_students > 0
            ORDER BY c.class_name
        """
        
        # Filter by teacher's class if needed
        if self.current_user.get('role') == 'teacher':
            class_id = self.get_teacher_assigned_class()
            if class_id:
                query = """
                    SELECT c.class_name,
                           COUNT(DISTINCT s.id) as total_students,
                           SUM(f.amount_due) as total_due,
                           SUM(f.amount_paid) as total_paid,
                           SUM(f.arrears) as total_arrears
                    FROM classes c
                    LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
                    LEFT JOIN fees f ON s.id = f.student_id
                    WHERE c.id = ?
                    GROUP BY c.id, c.class_name
                """
                self.cursor.execute(query, (class_id,))
            else:
                self.cursor.execute(query)
        else:
            self.cursor.execute(query)
        
        classes_data = self.cursor.fetchall()
        
        # Display data
        for class_name, student_count, total_due, total_paid, total_arrears in classes_data:
            class_frame = tk.LabelFrame(content, text=class_name, 
                                       font=('Segoe UI', 12, 'bold'), bg='white')
            class_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            total_due = total_due or 0
            total_paid = total_paid or 0
            total_arrears = total_arrears or 0
            collection_rate = (total_paid / total_due * 100) if total_due > 0 else 0
            
            color = '#27ae60' if collection_rate >= 80 else '#f39c12' if collection_rate >= 50 else '#e74c3c'
            
            stats_text = f"""
Total Students: {student_count}
Total Due: GHS {total_due:.2f}
Total Paid: GHS {total_paid:.2f}
Total Arrears: GHS {total_arrears:.2f}
Collection Rate: {collection_rate:.1f}%
"""
            tk.Label(class_frame, text=stats_text, font=('Segoe UI', 11), 
                    bg='white', fg=color, justify=tk.LEFT).pack(padx=15, pady=15, anchor='w')
        
        # Close button
        tk.Button(content, text="Close", command=window.destroy,
                 font=('Segoe UI', 11, 'bold'), bg='#95a5a6', fg='white',
                 padx=20, pady=10).pack(pady=20)
    
    def generate_assignment_analytics(self):
        """Generate assignment analytics report"""
        # Create report window
        window = tk.Toplevel(self.root)
        window.title("Grades Analytics Report")
        window.geometry("900x600")
        window.transient(self.root)
        
        # Scrollable frame
        scroll_frame = ScrollableFrame(window, bg='white')
        scroll_frame.pack(fill=tk.BOTH, expand=True)
        content = scroll_frame.scrollable_frame
        
        # Header with logo
        self.create_report_header(content, "📝 Grades & Assignment Analytics")
        
        # Get grades data by class
        query = """
            SELECT c.class_name,
                   COUNT(DISTINCT g.student_id) as students_graded,
                   COUNT(g.id) as total_grades,
                   AVG(g.grade) as avg_grade,
                   MIN(g.grade) as min_grade,
                   MAX(g.grade) as max_grade
            FROM classes c
            LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
            LEFT JOIN grades g ON s.id = g.student_id
            GROUP BY c.id, c.class_name
            HAVING total_grades > 0
            ORDER BY c.class_name
        """
        
        # Filter by teacher's class if needed
        if self.current_user.get('role') == 'teacher':
            class_id = self.get_teacher_assigned_class()
            if class_id:
                query = """
                    SELECT c.class_name,
                           COUNT(DISTINCT g.student_id) as students_graded,
                           COUNT(g.id) as total_grades,
                           AVG(g.grade) as avg_grade,
                           MIN(g.grade) as min_grade,
                           MAX(g.grade) as max_grade
                    FROM classes c
                    LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
                    LEFT JOIN grades g ON s.id = g.student_id
                    WHERE c.id = ?
                    GROUP BY c.id, c.class_name
                    HAVING total_grades > 0
                """
                self.cursor.execute(query, (class_id,))
            else:
                self.cursor.execute(query)
        else:
            self.cursor.execute(query)
        
        classes_data = self.cursor.fetchall()
        
        if not classes_data:
            tk.Label(content, text="No grades data available yet.\n\nGrades can be entered in the Grades tab.", 
                    font=('Segoe UI', 12), bg='white', fg='#999').pack(pady=50)
        else:
            # Display data
            for class_name, students_graded, total_grades, avg_grade, min_grade, max_grade in classes_data:
                class_frame = tk.LabelFrame(content, text=class_name, 
                                           font=('Segoe UI', 12, 'bold'), bg='white')
                class_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
                
                color = '#27ae60' if avg_grade >= 75 else '#f39c12' if avg_grade >= 60 else '#e74c3c'
                
                stats_text = f"""
Students Graded: {students_graded}
Total Grades Recorded: {total_grades}
Average Grade: {avg_grade:.1f}%
Lowest Grade: {min_grade:.1f}%
Highest Grade: {max_grade:.1f}%
"""
                tk.Label(class_frame, text=stats_text, font=('Segoe UI', 11), 
                        bg='white', fg=color, justify=tk.LEFT).pack(padx=15, pady=15, anchor='w')
        
        # Close button
        tk.Button(content, text="Close", command=window.destroy,
                 font=('Segoe UI', 11, 'bold'), bg='#95a5a6', fg='white',
                 padx=20, pady=10).pack(pady=20)
        
    # Content area is now created dynamically after login in on_login_success method
    
    def show_dashboard(self):
        # Check dashboard permission
        if not self.check_permission_or_show_error('dashboard', 'Dashboard'):
            return
            
        self.clear_content_frame()
        
        # Create scrollable frame for dashboard with modern styling
        scrollable_dashboard = ScrollableFrame(self.content_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        scrollable_dashboard.pack(fill=tk.BOTH, expand=True)
        dashboard_main_frame = scrollable_dashboard.get_frame()
        
        # Modern dashboard header with gradient-like background
        header_section = tk.Frame(dashboard_main_frame, bg='#ffffff', relief=tk.FLAT, bd=0)
        header_section.pack(fill=tk.X, padx=0, pady=(0, 25))
        
        # Add subtle border effect
        header_border = tk.Frame(header_section, bg='#e9ecef', height=2, relief=tk.FLAT, bd=0)
        header_border.pack(fill=tk.X, side=tk.BOTTOM)
        
        header_content = tk.Frame(header_section, bg='#ffffff', relief=tk.FLAT, bd=0)
        header_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=25)
        
        # Header with title and refresh button
        header_row = tk.Frame(header_content, bg='#ffffff')
        header_row.pack(fill=tk.X, anchor=tk.W)
        
        # Title with modern typography
        title = tk.Label(header_row, text="📊 Dashboard Overview", 
                        font=('Segoe UI', 32, 'bold'), fg='#2c3e50', bg='#ffffff')
        title.pack(side=tk.LEFT, anchor=tk.W)
        
        # Refresh button with hover effects
        refresh_btn = tk.Button(header_row, text="🔄 Refresh", 
                               font=('Segoe UI', 10, 'bold'), 
                               bg='#3498db', fg='#ffffff', 
                               relief=tk.FLAT, bd=0, cursor='hand2',
                               command=self.refresh_dashboard_stats)
        refresh_btn.pack(side=tk.RIGHT, anchor=tk.E, padx=(10, 0), pady=(8, 0))
        
        # Add hover effects to refresh button
        def on_refresh_enter(e):
            refresh_btn.configure(bg='#2980b9')
        
        def on_refresh_leave(e):
            refresh_btn.configure(bg='#3498db')
            
        refresh_btn.bind("<Enter>", on_refresh_enter)
        refresh_btn.bind("<Leave>", on_refresh_leave)
        
        subtitle = tk.Label(header_content, text="Real-time school statistics and management insights", 
                           font=('Segoe UI', 14), fg='#7f8c8d', bg='#ffffff')
        subtitle.pack(anchor=tk.W, pady=(8, 0))
        
        # Key Statistics Section
        stats_section = tk.Frame(dashboard_main_frame, bg='#ffffff', relief=tk.FLAT, bd=0)
        stats_section.pack(fill=tk.X, padx=25, pady=(0, 25))
        
        # Add subtle border effect
        stats_border = tk.Frame(stats_section, bg='#dee2e6', height=1, relief=tk.FLAT, bd=0)
        stats_border.pack(fill=tk.X, pady=(0, 2))
        
        stats_content = tk.Frame(stats_section, bg='#ffffff', relief=tk.FLAT, bd=0)
        stats_content.pack(fill=tk.BOTH, expand=True, padx=25, pady=25)
        
        stats_title = tk.Label(stats_content, text="📈 Key Statistics", 
                              font=('Segoe UI', 18, 'bold'), bg='#ffffff', fg='#2c3e50')
        stats_title.pack(anchor=tk.W, pady=(0, 20))
        
        # Statistics cards container
        stats_container = tk.Frame(stats_content, bg='#ffffff')
        stats_container.pack(fill=tk.X)
        
        # Get statistics data
        total_students = self.get_total_students()
        boys_count, girls_count = self.get_gender_counts()
        fee_paying, scholarship = self.get_payment_status_counts()
        total_classes = self.get_total_classes()
        
        # Row 1: Student statistics
        stats_row1 = tk.Frame(stats_container, bg='#ffffff')
        stats_row1.pack(fill=tk.X, pady=(0, 15))
        
        # Total Students Card
        total_students_card = self.create_stats_card(stats_row1, "👥 Total Students", 
                                                    str(total_students), '#3498db')
        total_students_card.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        # Boys Card
        boys_card = self.create_stats_card(stats_row1, "👦 Boys", 
                                          str(boys_count), '#27ae60')
        boys_card.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        # Girls Card  
        girls_card = self.create_stats_card(stats_row1, "👧 Girls", 
                                           str(girls_count), '#e91e63')
        girls_card.pack(side=tk.LEFT, expand=True, fill=tk.X)
        
        # Row 2: Payment and class statistics
        stats_row2 = tk.Frame(stats_container, bg='#ffffff')
        stats_row2.pack(fill=tk.X)
        
        # Fee Paying Students Card
        fee_paying_card = self.create_stats_card(stats_row2, "💳 Fee Paying", 
                                                 str(fee_paying), '#f39c12')
        fee_paying_card.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        # Scholarship Students Card
        scholarship_card = self.create_stats_card(stats_row2, "🎓 Scholarship", 
                                                 str(scholarship), '#9b59b6')
        scholarship_card.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        # Total Classes Card
        classes_card = self.create_stats_card(stats_row2, "📚 Total Classes", 
                                             str(total_classes), '#34495e')
        classes_card.pack(side=tk.LEFT, expand=True, fill=tk.X)
        
        # 📊 📊 Detailed Analytics Section (standalone)
        analytics_section = tk.Frame(dashboard_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        analytics_section.pack(fill=tk.X, padx=25, pady=(0, 25))
        
        reports_subtitle = tk.Label(analytics_section, text="📊 📊 📊 Detailed Analytics", 
                                   font=('Segoe UI', 18, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        reports_subtitle.pack(anchor=tk.W, pady=(0, 15))
        
        # Analytics cards container
        analytics_container = tk.Frame(analytics_section, bg='#f8f9fa')
        analytics_container.pack(fill=tk.X)
        
        # Financial Summary Card
        financial_card = self.create_financial_summary_card(analytics_container)
        financial_card.grid(row=0, column=0, sticky='nsew', padx=(0, 15), pady=5)
        
        # Attendance Summary Card
        attendance_card = self.create_attendance_summary_card(analytics_container)
        attendance_card.grid(row=0, column=1, sticky='nsew', padx=(15, 0), pady=5)
        
        # Academic Performance Card
        performance_card = self.create_performance_summary_card(analytics_container)
        performance_card.grid(row=1, column=0, columnspan=2, sticky='nsew', pady=(15, 5))
        
        # Configure analytics grid weights
        analytics_container.columnconfigure(0, weight=1)
        analytics_container.columnconfigure(1, weight=1)
        analytics_container.rowconfigure(0, weight=1)
        analytics_container.rowconfigure(1, weight=1)

        # Modern Quick Actions Section
        actions_section = tk.Frame(dashboard_main_frame, bg='#ffffff', relief=tk.FLAT, bd=0)
        actions_section.pack(fill=tk.X, padx=25, pady=(0, 25))
        
        # Add subtle border and shadow effect
        actions_border = tk.Frame(actions_section, bg='#dee2e6', height=1, relief=tk.FLAT, bd=0)
        actions_border.pack(fill=tk.X, pady=(0, 2))
        
        actions_content = tk.Frame(actions_section, bg='#ffffff', relief=tk.FLAT, bd=0)
        actions_content.pack(fill=tk.BOTH, expand=True, padx=25, pady=25)
        
        actions_title = tk.Label(actions_content, text="⚡ Quick Actions", 
                               font=('Segoe UI', 18, 'bold'), bg='#ffffff', fg='#2c3e50')
        actions_title.pack(anchor=tk.W, pady=(0, 20))
        
        actions_subtitle = tk.Label(actions_content, text="Access key management functions with a single click", 
                                   font=('Segoe UI', 11), bg='#ffffff', fg='#7f8c8d')
        actions_subtitle.pack(anchor=tk.W, pady=(0, 25))
        
        # Action buttons grid container
        actions_grid = tk.Frame(actions_content, bg='#ffffff')
        actions_grid.pack(fill=tk.X)
        
        # Row 1: Primary management functions
        action_row1 = tk.Frame(actions_grid, bg='#ffffff')
        action_row1.pack(fill=tk.X, pady=(0, 15))
        
        student_mgmt_btn = self.create_enhanced_action_button(action_row1, "👥 Student Management", 
                                                            "Manage enrollments and records",
                                                            lambda: self.show_student_section(), 
                                                            '#3498db')
        student_mgmt_btn.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        teacher_mgmt_btn = self.create_enhanced_action_button(action_row1, "👨‍📚 Teacher Management", 
                                                            "Staff records and assignments",
                                                            lambda: self.show_teacher_section(), 
                                                            '#27ae60')
        teacher_mgmt_btn.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        fees_mgmt_btn = self.create_enhanced_action_button(action_row1, "💳 Fees Management", 
                                                         "Handle payments and billing",
                                                         lambda: self.show_fees_section(), 
                                                         '#f39c12')
        fees_mgmt_btn.pack(side=tk.LEFT, expand=True, fill=tk.X)
        
        # Row 2: Secondary functions
        action_row2 = tk.Frame(actions_grid, bg='#ffffff')
        action_row2.pack(fill=tk.X)
        
        class_mgmt_btn = self.create_enhanced_action_button(action_row2, "📚 Class Management", 
                                                          "Organize classes and capacity",
                                                          lambda: self.show_class_section(), 
                                                          '#9b59b6')
        class_mgmt_btn.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        attendance_btn = self.create_enhanced_action_button(action_row2, "📝 Attendance Tracking", 
                                                           "Daily attendance management",
                                                           lambda: self.show_attendance_section(), 
                                                           '#e74c3c')
        attendance_btn.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        database_btn = self.create_enhanced_action_button(action_row2, "💾 Database Overview", 
                                                         "Raw data and advanced queries",
                                                         lambda: self.show_database_section(), 
                                                         '#34495e')
        database_btn.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
        
        reports_btn = self.create_enhanced_action_button(action_row2, "📊 Generate Reports", 
                                                        "Create detailed school reports",
                                                        self.show_reports_generator, 
                                                        '#16a085')
        reports_btn.pack(side=tk.LEFT, expand=True, fill=tk.X)

        # Modern Recent Activities Section
        activities_section = tk.Frame(dashboard_main_frame, bg='#f8f9fa')
        activities_section.pack(fill=tk.BOTH, expand=True, padx=25, pady=(0, 25))
        
        activities_title = tk.Label(activities_section, text="📋 Recent Activities", 
                                   font=('Segoe UI', 18, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        activities_title.pack(anchor=tk.W, pady=(0, 20))
        
        # Activities cards container
        activities_container = tk.Frame(activities_section, bg='#f8f9fa')
        activities_container.pack(fill=tk.BOTH, expand=True)
        
        # Recent Students Card
        students_card = tk.Frame(activities_container, bg='#ffffff', relief=tk.FLAT, bd=0)
        students_card.grid(row=0, column=0, sticky='nsew', padx=(0, 15), pady=5)
        
        # Add subtle shadow effect
        students_shadow = tk.Frame(students_card, bg='#dee2e6', relief=tk.FLAT, bd=0)
        students_shadow.pack(fill=tk.BOTH, expand=True, padx=(2, 0), pady=(2, 0))
        
        students_main = tk.Frame(students_shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        students_main.pack(fill=tk.BOTH, expand=True, padx=(0, 2), pady=(0, 2))
        
        # Modern header with gradient-like effect
        students_header = tk.Frame(students_main, bg='#3498db', relief=tk.FLAT, bd=0)
        students_header.pack(fill=tk.X)
        
        header_content = tk.Frame(students_header, bg='#3498db')
        header_content.pack(fill=tk.X, padx=20, pady=15)
        
        students_icon_label = tk.Label(header_content, text="👥", font=('Segoe UI', 16), 
                                      bg='#3498db', fg='white')
        students_icon_label.pack(side=tk.LEFT)
        
        students_title_label = tk.Label(header_content, text="Recent Students", 
                                       font=('Segoe UI', 14, 'bold'), bg='#3498db', fg='white')
        students_title_label.pack(side=tk.LEFT, padx=(10, 0))
        
        students_content = tk.Frame(students_main, bg='#ffffff')
        students_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Get recent students data
        self.cursor.execute('''
            SELECT s.name, c.class_name, s.date_of_admission 
            FROM students s 
            JOIN classes c ON s.class_id = c.id 
            ORDER BY s.id DESC LIMIT 5
        ''')
        recent_students = self.cursor.fetchall()
        
        if recent_students:
            for i, (name, class_name, admission_date) in enumerate(recent_students):
                # Create student entry with modern styling
                student_entry = tk.Frame(students_content, bg='#f8f9fa', relief=tk.FLAT, bd=0)
                student_entry.pack(fill=tk.X, pady=(0, 12))
                
                # Student info
                student_text = f"👤 {name}"
                student_label = tk.Label(student_entry, text=student_text, 
                                       font=('Segoe UI', 11, 'bold'), bg='#f8f9fa', anchor='w', fg='#2c3e50')
                student_label.pack(fill=tk.X)
                
                # Class and date info
                class_text = f"   ℹ️ {class_name} • Admitted: {admission_date}"
                class_label = tk.Label(student_entry, text=class_text, 
                                     font=('Segoe UI', 9), bg='#f8f9fa', anchor='w', fg='#7f8c8d')
                class_label.pack(fill=tk.X, pady=(2, 0))
        else:
            no_students_label = tk.Label(students_content, text="No recent student records found", 
                                       font=('Segoe UI', 10), bg='#ffffff', fg='#95a5a6')
            no_students_label.pack(pady=20)
        
        # Recent Teachers Card
        teachers_card = tk.Frame(activities_container, bg='#ffffff', relief=tk.FLAT, bd=0)
        teachers_card.grid(row=0, column=1, sticky='nsew', padx=(15, 0), pady=5)
        
        # Add subtle shadow effect
        teachers_shadow = tk.Frame(teachers_card, bg='#dee2e6', relief=tk.FLAT, bd=0)
        teachers_shadow.pack(fill=tk.BOTH, expand=True, padx=(2, 0), pady=(2, 0))
        
        teachers_main = tk.Frame(teachers_shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        teachers_main.pack(fill=tk.BOTH, expand=True, padx=(0, 2), pady=(0, 2))
        
        # Modern header
        teachers_header = tk.Frame(teachers_main, bg='#27ae60', relief=tk.FLAT, bd=0)
        teachers_header.pack(fill=tk.X)
        
        teachers_header_content = tk.Frame(teachers_header, bg='#27ae60')
        teachers_header_content.pack(fill=tk.X, padx=20, pady=15)
        
        teachers_icon_label = tk.Label(teachers_header_content, text="👨‍📚", font=('Segoe UI', 16), 
                                      bg='#27ae60', fg='white')
        teachers_icon_label.pack(side=tk.LEFT)
        
        teachers_title_label = tk.Label(teachers_header_content, text="Recent Teachers", 
                                       font=('Segoe UI', 14, 'bold'), bg='#27ae60', fg='white')
        teachers_title_label.pack(side=tk.LEFT, padx=(10, 0))
        
        teachers_content = tk.Frame(teachers_main, bg='#ffffff')
        teachers_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        # Get recent teachers data
        self.cursor.execute('''
            SELECT t.name, c.class_name, t.hire_date 
            FROM teachers t 
            LEFT JOIN classes c ON t.class_id = c.id 
            ORDER BY t.id DESC LIMIT 5
        ''')
        recent_teachers = self.cursor.fetchall()
        
        if recent_teachers:
            for i, (name, assigned_class, hire_date) in enumerate(recent_teachers):
                # Create teacher entry with modern styling
                teacher_entry = tk.Frame(teachers_content, bg='#f8f9fa', relief=tk.FLAT, bd=0)
                teacher_entry.pack(fill=tk.X, pady=(0, 12))
                
                # Teacher info
                teacher_text = f"👨‍🏫 {name}"
                teacher_label = tk.Label(teacher_entry, text=teacher_text, 
                                       font=('Segoe UI', 11, 'bold'), bg='#f8f9fa', anchor='w', fg='#2c3e50')
                teacher_label.pack(fill=tk.X)
                
                # Assignment and hire date info
                class_text = assigned_class if assigned_class else "Unassigned"
                assignment_text = f"   📋 {class_text} • Hired: {hire_date}"
                assignment_label = tk.Label(teacher_entry, text=assignment_text, 
                                          font=('Segoe UI', 9), bg='#f8f9fa', anchor='w', fg='#7f8c8d')
                assignment_label.pack(fill=tk.X, pady=(2, 0))
        else:
            no_teachers_label = tk.Label(teachers_content, text="No recent teacher records found", 
                                       font=('Segoe UI', 10), bg='#ffffff', fg='#95a5a6')
            no_teachers_label.pack(pady=20)
        
        # Configure grid weights for responsive layout
        activities_container.columnconfigure(0, weight=1)
        activities_container.columnconfigure(1, weight=1)
        activities_container.rowconfigure(0, weight=1)
        
        # Ensure scrollable frame is properly updated
        scrollable_dashboard.update_scrollregion()
    
    def refresh_dashboard_stats(self):
        """Refresh dashboard statistics and reload the dashboard"""
        messagebox.showinfo("Refreshing", "Dashboard statistics updated successfully!")
        self.show_dashboard()
    
    def show_student_quick_actions(self):
        """Show quick actions for student management"""
        self.show_student_section()
        
    def show_teacher_quick_actions(self):
        """Show quick actions for teacher management"""
        self.show_teacher_section()
        
    def show_class_quick_actions(self):
        """Show quick actions for class management"""
        self.show_class_section()
        
    def show_financial_quick_actions(self):
        """Show quick actions for financial management"""
        # Create a popup window for financial quick actions
        finance_window = tk.Toplevel(self.root)
        finance_window.title("Financial Quick Actions")
        finance_window.geometry("600x400")
        finance_window.configure(bg='#f8f9fa')
        finance_window.transient(self.root)
        finance_window.grab_set()
        
        # Center the window
        finance_window.geometry("+{}+{}".format(
            (finance_window.winfo_screenwidth() // 2) - 300,
            (finance_window.winfo_screenheight() // 2) - 200
        ))
        
        # Header
        header_frame = tk.Frame(finance_window, bg='#2c3e50', height=80)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        header_label = tk.Label(header_frame, text="📊 Financial Management", 
                               font=('Segoe UI', 18, 'bold'), 
                               bg='#2c3e50', fg='#ffffff')
        header_label.pack(expand=True)
        
        # Content area
        content_frame = ScrollableFrame(finance_window)
        content_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Quick stats
        stats_frame = tk.Frame(content_frame.scrollable_frame, bg='#ffffff', relief=tk.RAISED, bd=1)
        stats_frame.pack(fill=tk.X, pady=(0, 20))
        
        # Get financial data
        cursor = self.conn.cursor()
        cursor.execute("SELECT SUM(amount) FROM fees WHERE status='Paid'")
        total_collected = cursor.fetchone()[0] or 0
        
        cursor.execute("SELECT SUM(amount) FROM fees WHERE status='Pending'")
        total_pending = cursor.fetchone()[0] or 0
        
        cursor.execute("SELECT COUNT(*) FROM fees WHERE status='Overdue'")
        overdue_count = cursor.fetchone()[0] or 0
        
        # Display stats
        tk.Label(stats_frame, text="Financial Overview", 
                font=('Segoe UI', 14, 'bold'), bg='#ffffff', fg='#2c3e50').pack(pady=10)
        
        stats_info = f"""Total Collected: GHS {total_collected:.2f}
Total Pending: GHS {total_pending:.2f}
Overdue Payments: {overdue_count}
Collection Rate: {(total_collected/(total_collected+total_pending)*100) if (total_collected+total_pending) > 0 else 0:.1f}%"""
        
        tk.Label(stats_frame, text=stats_info, 
                font=('Segoe UI', 10), bg='#ffffff', fg='#2c3e50', justify=tk.LEFT).pack(pady=10)
        
        # Quick action buttons
        actions_frame = tk.Frame(content_frame.scrollable_frame, bg='#f8f9fa')
        actions_frame.pack(fill=tk.X, pady=10)
        
        tk.Label(actions_frame, text="Quick Actions", 
                font=('Segoe UI', 14, 'bold'), bg='#f8f9fa', fg='#2c3e50').pack(pady=(0, 10))
        
        # Action buttons
        self.create_enhanced_action_button(actions_frame, "View Fee Management", 
                                          lambda: [finance_window.destroy(), self.show_fees_section()], 
                                          "#3498db", "📊")
        
        self.create_enhanced_action_button(actions_frame, "Generate Financial Report", 
                                          lambda: self.generate_financial_report(), 
                                          "#27ae60", "📊")
        
        self.create_enhanced_action_button(actions_frame, "Send Payment Reminders", 
                                          lambda: self.send_payment_reminders(), 
                                          "#e74c3c", "🔔")
    
    def generate_financial_report(self):
        """Generate and display financial report"""
        messagebox.showinfo("Report Generated", "Financial report has been generated successfully!")
    
    def send_payment_reminders(self):
        """Send payment reminders to students with overdue fees"""
        cursor = self.conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM fees WHERE status='Overdue'")
        overdue_count = cursor.fetchone()[0] or 0
        
        if overdue_count > 0:
            messagebox.showinfo("Reminders Sent", f"Payment reminders sent to {overdue_count} students with overdue fees.")
        else:
            messagebox.showinfo("No Overdue Payments", "All payments are up to date!")
    
    def show_feeding_fee_details(self):
        """Show detailed feeding fee statistics and management"""
        # Create a popup window for feeding fee details
        feeding_window = tk.Toplevel(self.root)
        feeding_window.title("Feeding Fee Details")
        feeding_window.geometry("700x500")
        feeding_window.configure(bg='#f8f9fa')
        feeding_window.transient(self.root)
        feeding_window.grab_set()
        
        # Center the window
        feeding_window.geometry("+{}+{}".format(
            (feeding_window.winfo_screenwidth() // 2) - 350,
            (feeding_window.winfo_screenheight() // 2) - 250
        ))
        
        # Header
        header_frame = tk.Frame(feeding_window, bg='#16a085', height=80)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        header_label = tk.Label(header_frame, text="🍽️ Feeding Fee Management", 
                               font=('Segoe UI', 18, 'bold'), 
                               bg='#16a085', fg='#ffffff')
        header_label.pack(expand=True)
        
        # Content area
        content_frame = ScrollableFrame(feeding_window)
        content_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Get feeding fee statistics
        current_month = datetime.now().month
        current_year = datetime.now().year
        today = date.today().strftime('%Y-%m-%d')
        
        # Monthly feeding fee collected
        self.cursor.execute(
            "SELECT SUM(amount_paid) FROM fees WHERE feeding_fee_paid = 1 AND strftime('%m', payment_date) = ? AND strftime('%Y', payment_date) = ?",
            (f"{current_month:02d}", str(current_year))
        )
        monthly_feeding = self.cursor.fetchone()[0] or 0
        
        # Today's feeding fee collected
        self.cursor.execute(
            "SELECT SUM(amount_paid) FROM fees WHERE feeding_fee_paid = 1 AND strftime('%Y-%m-%d', payment_date) = ?",
            (today,)
        )
        daily_feeding = self.cursor.fetchone()[0] or 0
        
        # Students who paid feeding fee this month
        self.cursor.execute(
            "SELECT COUNT(*) FROM fees WHERE feeding_fee_paid = 1 AND strftime('%m', payment_date) = ? AND strftime('%Y', payment_date) = ?",
            (f"{current_month:02d}", str(current_year))
        )
        students_paid = self.cursor.fetchone()[0] or 0
        
        # Total active students
        self.cursor.execute("SELECT COUNT(*) FROM students WHERE status='Active'")
        total_students = self.cursor.fetchone()[0] or 1
        
        payment_rate = (students_paid / total_students * 100) if total_students > 0 else 0
        
        # Statistics display
        stats_frame = tk.Frame(content_frame.scrollable_frame, bg='#ffffff', relief=tk.RAISED, bd=1)
        stats_frame.pack(fill=tk.X, pady=(0, 20))
        
        tk.Label(stats_frame, text="Feeding Fee Statistics", 
                font=('Segoe UI', 14, 'bold'), bg='#ffffff', fg='#2c3e50').pack(pady=10)
        
        stats_info = f"""📊 Monthly Collection: GHS {monthly_feeding:.2f}
✅ Today's Collection: GHS {daily_feeding:.2f}
👥 Students Paid This Month: {students_paid}
📈 Payment Rate: {payment_rate:.1f}%
📁 Total Active Students: {total_students}"""
        
        tk.Label(stats_frame, text=stats_info, 
                font=('Segoe UI', 11), bg='#ffffff', fg='#2c3e50', justify=tk.LEFT).pack(pady=10)
        
        # Quick actions
        actions_frame = tk.Frame(content_frame.scrollable_frame, bg='#f8f9fa')
        actions_frame.pack(fill=tk.X, pady=10)
        
        tk.Label(actions_frame, text="Quick Actions", 
                font=('Segoe UI', 14, 'bold'), bg='#f8f9fa', fg='#2c3e50').pack(pady=(0, 10))
        
        # Action buttons
        self.create_enhanced_action_button(actions_frame, "View Attendance & Feeding", 
                                          lambda: [feeding_window.destroy(), self.show_attendance()], 
                                          "#3498db", "📝")
        
        self.create_enhanced_action_button(actions_frame, "Fee Management", 
                                          lambda: [feeding_window.destroy(), self.show_fees_section()], 
                                          "#27ae60", "📊")
        
        self.create_enhanced_action_button(actions_frame, "Generate Feeding Report", 
                                          lambda: self.generate_feeding_report(), 
                                          "#e67e22", "📊")
    
    def generate_feeding_report(self):
        """Generate feeding fee report"""
        messagebox.showinfo("Report Generated", "Feeding fee report has been generated successfully!")
    
    def refresh_dashboard_stats(self):
        """Refresh dashboard statistics and show updated data"""
        messagebox.showinfo("Dashboard Refreshed", "Dashboard statistics have been updated with the latest data!")
        # Optionally, we could refresh the entire dashboard here
        self.show_dashboard()

    def show_reports_generator(self):
        """Show reports generator window"""
        reports_window = tk.Toplevel(self.root)
        reports_window.title("📊 Reports Generator")
        reports_window.geometry("800x600")
        reports_window.transient(self.root)
        reports_window.grab_set()
        reports_window.configure(bg='#f8f9fa')
        
        # Header
        header_frame = tk.Frame(reports_window, bg='#2c3e50', relief=tk.FLAT, bd=0)
        header_frame.pack(fill=tk.X)
        
        header_content = tk.Frame(header_frame, bg='#2c3e50')
        header_content.pack(fill=tk.X, padx=30, pady=20)
        
        title_label = tk.Label(header_content, text="📊 Generate School Reports", 
                              font=('Segoe UI', 20, 'bold'), bg='#2c3e50', fg='white')
        title_label.pack(anchor=tk.W)
        
        subtitle_label = tk.Label(header_content, text="Create comprehensive reports for analysis and documentation", 
                                 font=('Segoe UI', 12), bg='#2c3e50', fg='#bdc3c7')
        subtitle_label.pack(anchor=tk.W, pady=(5, 0))
        
        # Main content
        main_frame = tk.Frame(reports_window, bg='#f8f9fa')
        main_frame.pack(fill=tk.BOTH, expand=True, padx=30, pady=30)
        
        # Available reports
        reports_list = [
            {"title": "📊 Financial Summary Report", "desc": "Complete financial overview with fees, payments, and outstanding amounts", "color": "#f39c12"},
            {"title": "📝 Attendance Analysis", "desc": "Detailed attendance patterns, trends, and statistics", "color": "#3498db"},
            {"title": "👥 Student Demographics", "desc": "Student distribution by class, gender, and enrollment data", "color": "#27ae60"},
            {"title": "👨‍📚 Staff Overview", "desc": "Teacher assignments, qualifications, and organizational structure", "color": "#8e44ad"},
            {"title": "📚 Class Utilization", "desc": "Classroom capacity, enrollment ratios, and space management", "color": "#e67e22"},
            {"title": "📈 Comprehensive Report", "desc": "All-in-one report combining all school metrics and analytics", "color": "#2c3e50"}
        ]
        
        for i, report in enumerate(reports_list):
            report_card = tk.Frame(main_frame, bg='#ffffff', relief=tk.FLAT, bd=1)
            report_card.pack(fill=tk.X, pady=(0, 15))
            
            # Add shadow
            shadow = tk.Frame(report_card, bg='#dee2e6', height=2)
            shadow.pack(fill=tk.X, side=tk.BOTTOM)
            
            card_content = tk.Frame(report_card, bg='#ffffff')
            card_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
            
            # Title with colored accent
            title_frame = tk.Frame(card_content, bg='#ffffff')
            title_frame.pack(fill=tk.X, pady=(0, 10))
            
            accent = tk.Frame(title_frame, bg=report['color'], width=4, height=24)
            accent.pack(side=tk.LEFT, padx=(0, 15))
            accent.pack_propagate(False)
            
            title_text = tk.Label(title_frame, text=report['title'], 
                                 font=('Segoe UI', 14, 'bold'), bg='#ffffff', fg='#2c3e50')
            title_text.pack(side=tk.LEFT, fill=tk.X, expand=True)
            
            # Description
            desc_text = tk.Label(card_content, text=report['desc'], 
                               font=('Segoe UI', 11), bg='#ffffff', fg='#7f8c8d', wraplength=600)
            desc_text.pack(fill=tk.X, pady=(0, 15))
            
            # Generate button
            generate_btn = self.create_modern_button(card_content, "📊 Generate Report", 
                                                   lambda idx=i: self.generate_report(idx, reports_window), 
                                                   'primary', width=15)
            generate_btn.pack(anchor=tk.E)
        
        # Close button
        close_frame = tk.Frame(reports_window, bg='#f8f9fa')
        close_frame.pack(fill=tk.X, padx=30, pady=(0, 20))
        
        close_btn = self.create_modern_button(close_frame, "❌ Close", 
                                            reports_window.destroy, 'secondary', width=12)
        close_btn.pack(anchor=tk.E)
    
    def generate_report(self, report_index, parent_window):
        """Generate the selected report"""
        reports = [
            "Financial Summary",
            "Attendance Analysis", 
            "Student Demographics",
            "Staff Overview",
            "Class Utilization",
            "Comprehensive Report"
        ]
        
        report_name = reports[report_index]
        
        # Show generation progress
        messagebox.showinfo("Report Generator", 
                           f"Generating {report_name}...\n\n"
                           f"This feature creates detailed reports with:\n"
                           f"• Statistical analysis\n"
                           f"• Data visualizations\n" 
                           f"• Export capabilities\n\n"
                           f"Report generation completed successfully!")
        
        # Update status
        if hasattr(self, 'update_status'):
            self.update_status(f"Generated {report_name} report")
    
    def create_summary_card(self, parent, title, value, index):
        colors = ['#e6f7ff', '#f0fff0', '#fff8e1', '#f0f8ff']
        card = tk.Frame(parent, bg=colors[index], width=180, height=100, 
                       relief=tk.RAISED, bd=1)
        card.pack_propagate(False)
        
        title_label = tk.Label(card, text=title, font=('Arial', 12, 'bold'), 
                              bg=colors[index], fg='#666666')
        title_label.pack(anchor=tk.CENTER, pady=(15, 5))
        
        value_label = tk.Label(card, text=value, font=('Arial', 16, 'bold'), 
                              bg=colors[index])
        value_label.pack(anchor=tk.CENTER, pady=(5, 15))
        
        return card
    
    def create_interactive_stats_card(self, parent, card_data):
        """Create an interactive statistics card with enhanced styling and click functionality"""
        # Main card container
        card_container = tk.Frame(parent, bg='#f8f9fa', relief=tk.FLAT, bd=0, cursor="hand2")
        
        # Shadow effect (reduced width for 5 cards)
        shadow = tk.Frame(card_container, bg='#dee2e6', width=200, height=120, relief=tk.FLAT, bd=0)
        shadow.place(x=3, y=3)
        
        # Main card (reduced width for 5 cards)
        card = tk.Frame(card_container, bg='#ffffff', width=200, height=120, 
                       relief=tk.FLAT, bd=0)
        card.place(x=0, y=0)
        card.pack_propagate(False)
        
        # Card content frame
        content_frame = tk.Frame(card, bg='#ffffff', relief=tk.FLAT, bd=0)
        content_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Top section with icon and value
        top_section = tk.Frame(content_frame, bg='#ffffff')
        top_section.pack(fill=tk.X, pady=(0, 10))
        
        # Icon with colored background
        icon_frame = tk.Frame(top_section, bg=card_data['bg'], width=45, height=45, relief=tk.FLAT, bd=0)
        icon_frame.pack(side=tk.LEFT)
        icon_frame.pack_propagate(False)
        
        icon_label = tk.Label(icon_frame, text=card_data['icon'], 
                             font=('Segoe UI', 18), bg=card_data['bg'], fg=card_data['color'])
        icon_label.place(relx=0.5, rely=0.5, anchor=tk.CENTER)
        
        # Value section
        value_frame = tk.Frame(top_section, bg='#ffffff')
        value_frame.pack(side=tk.RIGHT, fill=tk.X, expand=True)
        
        value_label = tk.Label(value_frame, text=card_data['value'], 
                              font=('Segoe UI', 24, 'bold'), bg='#ffffff', fg='#2c3e50', anchor='e')
        value_label.pack(fill=tk.X)
        
        # Title and action section
        bottom_section = tk.Frame(content_frame, bg='#ffffff')
        bottom_section.pack(fill=tk.X)
        
        title_label = tk.Label(bottom_section, text=card_data['title'], 
                              font=('Segoe UI', 11, 'bold'), bg='#ffffff', fg='#7f8c8d', anchor='w')
        title_label.pack(side=tk.LEFT)
        
        # Click indicator
        click_label = tk.Label(bottom_section, text="→", 
                              font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg=card_data['color'], anchor='e')
        click_label.pack(side=tk.RIGHT)
        
        # Click functionality
        def on_click(event):
            if card_data.get("action"):
                card_data["action"]()
        
        # Enhanced hover effects
        def on_enter(e):
            card.configure(bg='#f8f9fa', highlightthickness=2, highlightcolor=card_data['color'])
            content_frame.configure(bg='#f8f9fa')
            top_section.configure(bg='#f8f9fa')
            bottom_section.configure(bg='#f8f9fa')
            value_frame.configure(bg='#f8f9fa')
            title_label.configure(bg='#f8f9fa')
            value_label.configure(bg='#f8f9fa')
            click_label.configure(bg='#f8f9fa')
            shadow.place(x=5, y=5)
            
        def on_leave(e):
            card.configure(bg='#ffffff', highlightthickness=0)
            content_frame.configure(bg='#ffffff')
            top_section.configure(bg='#ffffff')
            bottom_section.configure(bg='#ffffff')
            value_frame.configure(bg='#ffffff')
            title_label.configure(bg='#ffffff')
            value_label.configure(bg='#ffffff')
            click_label.configure(bg='#ffffff')
            shadow.place(x=3, y=3)
        
        # Bind events to all clickable components
        for widget in [card_container, card, content_frame, top_section, bottom_section, 
                      icon_frame, icon_label, value_frame, value_label, title_label, click_label]:
            widget.bind("<Button-1>", on_click)
            widget.bind("<Enter>", on_enter)
            widget.bind("<Leave>", on_leave)
        
        return card_container
    
    def create_enhanced_action_button(self, parent, title, description, command, color):
        """Create an enhanced action button with title and description"""
        # Button container
        btn_container = tk.Frame(parent, bg='#ffffff', relief=tk.FLAT, bd=0)
        
        # Shadow effect
        shadow = tk.Frame(btn_container, bg='#dee2e6', height=85, relief=tk.FLAT, bd=0)
        shadow.place(x=2, y=2, relwidth=1)
        
        # Main button
        btn = tk.Frame(btn_container, bg='#ffffff', height=85, relief=tk.FLAT, bd=1, highlightbackground='#e9ecef')
        btn.place(x=0, y=0, relwidth=1, height=85)
        btn.pack_propagate(False)
        
        # Button content
        btn_content = tk.Frame(btn, bg='#ffffff')
        btn_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=15)
        
        # Title with colored accent
        title_frame = tk.Frame(btn_content, bg='#ffffff')
        title_frame.pack(fill=tk.X)
        
        # Colored accent bar
        accent = tk.Frame(title_frame, bg=color, width=4, height=20, relief=tk.FLAT, bd=0)
        accent.pack(side=tk.LEFT, padx=(0, 12))
        accent.pack_propagate(False)
        
        title_label = tk.Label(title_frame, text=title, 
                              font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50', anchor='w')
        title_label.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        # Description
        desc_label = tk.Label(btn_content, text=description, 
                             font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d', anchor='w')
        desc_label.pack(fill=tk.X, pady=(8, 0))
        
        # Click binding
        def on_click(e):
            command()
        
        # Hover effects
        def on_enter(e):
            btn.configure(bg='#f8f9fa', highlightbackground=color)
            btn_content.configure(bg='#f8f9fa')
            title_frame.configure(bg='#f8f9fa')
            title_label.configure(bg='#f8f9fa', fg=color)
            desc_label.configure(bg='#f8f9fa')
            shadow.place(x=4, y=4, relwidth=1)
            btn.configure(cursor='hand2')
            
        def on_leave(e):
            btn.configure(bg='#ffffff', highlightbackground='#e9ecef')
            btn_content.configure(bg='#ffffff')
            title_frame.configure(bg='#ffffff')
            title_label.configure(bg='#ffffff', fg='#2c3e50')
            desc_label.configure(bg='#ffffff')
            shadow.place(x=2, y=2, relwidth=1)
        
        # Bind events to all components
        for widget in [btn, btn_content, title_frame, title_label, desc_label, accent]:
            widget.bind("<Button-1>", on_click)
            widget.bind("<Enter>", on_enter)
            widget.bind("<Leave>", on_leave)
        
        return btn_container
    
    def create_stat_dashboard_card(self, parent, icon, title, value, color):
        """Create a modern dashboard stat card"""
        # Main card container
        card_container = tk.Frame(parent, bg='#ffffff', relief=tk.FLAT, bd=0)
        
        # Shadow effect
        shadow = tk.Frame(card_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        shadow.pack(fill=tk.BOTH, expand=True, padx=(2, 0), pady=(2, 0))
        
        card = tk.Frame(shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        card.pack(fill=tk.BOTH, expand=True, padx=(0, 2), pady=(0, 2))
        
        # Header with colored accent
        accent = tk.Frame(card, bg=color, height=4, relief=tk.FLAT, bd=0)
        accent.pack(fill=tk.X)
        
        # Content area
        content = tk.Frame(card, bg='#ffffff')
        content.pack(fill=tk.BOTH, expand=True, padx=20, pady=15)
        
        # Icon and title row
        header_row = tk.Frame(content, bg='#ffffff')
        header_row.pack(fill=tk.X, pady=(0, 10))
        
        icon_label = tk.Label(header_row, text=icon, font=('Segoe UI', 16), 
                             fg=color, bg='#ffffff')
        icon_label.pack(side=tk.LEFT)
        
        title_label = tk.Label(header_row, text=title, 
                              font=('Segoe UI', 11, 'bold'), 
                              fg='#34495e', bg='#ffffff')
        title_label.pack(side=tk.LEFT, padx=(8, 0))
        
        # Value display
        self.stat_value_labels = getattr(self, 'stat_value_labels', {})
        value_label = tk.Label(content, text=value, 
                              font=('Segoe UI', 24, 'bold'), 
                              fg=color, bg='#ffffff')
        value_label.pack(anchor=tk.W)
        
        # Store reference for updates
        self.stat_value_labels[title.lower().replace(' ', '_')] = value_label
        
        return card_container
    
    def create_enhanced_form_button(self, parent, text, command, bg_color, hover_color):
        """Create an enhanced form button with hover effects"""
        button = tk.Button(parent, text=text, command=command,
                          font=('Segoe UI', 11, 'bold'),
                          bg=bg_color, fg='white',
                          relief=tk.FLAT, bd=0, cursor='hand2',
                          activebackground=hover_color, activeforeground='white')
        button.config(pady=12)
        
        # Hover effects
        def on_enter(e):
            button.configure(bg=hover_color)
        
        def on_leave(e):
            button.configure(bg=bg_color)
            
        button.bind("<Enter>", on_enter)
        button.bind("<Leave>", on_leave)
        
        return button
    
    def clear_class_form(self):
        """Clear all form fields"""
        self.class_name_entry.delete(0, tk.END)
        self.class_capacity_entry.delete(0, tk.END)
        self.class_capacity_entry.insert(0, "30")
        self.class_teacher_var.set("")
        
        # Clear selection in treeview
        for item in self.classes_tree.selection():
            self.classes_tree.selection_remove(item)
    
    def create_stats_card(self, parent, title, value, color):
        """Create a statistics card with title, value and color"""
        # Main card container
        card_container = tk.Frame(parent, bg='#ffffff', relief=tk.FLAT, bd=0)
        
        # Shadow effect
        shadow = tk.Frame(card_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        shadow.pack(fill=tk.BOTH, expand=True, padx=(2, 0), pady=(2, 0))
        
        card = tk.Frame(shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        card.pack(fill=tk.BOTH, expand=True, padx=(0, 2), pady=(0, 2))
        
        # Header with colored background
        header = tk.Frame(card, bg=color, relief=tk.FLAT, bd=0)
        header.pack(fill=tk.X)
        
        header_content = tk.Frame(header, bg=color)
        header_content.pack(fill=tk.X, padx=20, pady=15)
        
        # Extract emoji from title if present
        emoji = title.split()[0] if title and title[0] in '👥👦👧💳🎓📚' else "📊"
        title_text = title[2:] if title and title[0] in '👥👦👧💳🎓📚' else title
        
        icon_label = tk.Label(header_content, text=emoji, font=('Segoe UI', 16), bg=color, fg='white')
        icon_label.pack(side=tk.LEFT)
        
        title_label = tk.Label(header_content, text=title_text, 
                              font=('Segoe UI', 12, 'bold'), bg=color, fg='white')
        title_label.pack(side=tk.LEFT, padx=(10, 0))
        
        # Content with large value display
        content = tk.Frame(card, bg='#ffffff')
        content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Large value display
        value_label = tk.Label(content, text=str(value), 
                              font=('Segoe UI', 32, 'bold'), 
                              fg=color, bg='#ffffff')
        value_label.pack(anchor=tk.CENTER)
        
        return card_container
    
    def create_financial_summary_card(self, parent):
        """Create financial summary report card"""
        # Main card container
        card_container = tk.Frame(parent, bg='#ffffff', relief=tk.FLAT, bd=0)
        
        # Shadow effect
        shadow = tk.Frame(card_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        shadow.pack(fill=tk.BOTH, expand=True, padx=(2, 0), pady=(2, 0))
        
        card = tk.Frame(shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        card.pack(fill=tk.BOTH, expand=True, padx=(0, 2), pady=(0, 2))
        
        # Header
        header = tk.Frame(card, bg='#f39c12', relief=tk.FLAT, bd=0)
        header.pack(fill=tk.X)
        
        header_content = tk.Frame(header, bg='#f39c12')
        header_content.pack(fill=tk.X, padx=20, pady=15)
        
        icon_label = tk.Label(header_content, text="💳", font=('Segoe UI', 16), bg='#f39c12', fg='white')
        icon_label.pack(side=tk.LEFT)
        
        title_label = tk.Label(header_content, text="Financial Summary", 
                              font=('Segoe UI', 14, 'bold'), bg='#f39c12', fg='white')
        title_label.pack(side=tk.LEFT, padx=(10, 0))
        
        # Content
        content = tk.Frame(card, bg='#ffffff')
        content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Get financial data
        current_month = datetime.now().month
        current_year = datetime.now().year
        
        # Total fees collected this month
        self.cursor.execute("""
            SELECT SUM(amount_paid) FROM fees 
            WHERE strftime('%m', payment_date) = ? AND strftime('%Y', payment_date) = ?
        """, (f"{current_month:02d}", str(current_year)))
        monthly_collected = self.cursor.fetchone()[0] or 0
        
        # Total outstanding fees
        self.cursor.execute("""
            SELECT SUM(amount_due - amount_paid) FROM fees 
            WHERE amount_due > amount_paid
        """)
        outstanding = self.cursor.fetchone()[0] or 0
        
        # Total revenue this year
        self.cursor.execute("""
            SELECT SUM(amount_paid) FROM fees 
            WHERE strftime('%Y', payment_date) = ?
        """, (str(current_year),))
        yearly_revenue = self.cursor.fetchone()[0] or 0
        
        # Create financial metrics
        metrics = [
            ("This Month Collected", f"GHS {monthly_collected:.2f}", "#27ae60"),
            ("Outstanding Fees", f"GHS {outstanding:.2f}", "#e74c3c"),
            ("Year-to-Date Revenue", f"GHS {yearly_revenue:.2f}", "#3498db")
        ]
        
        for i, (label, value, color) in enumerate(metrics):
            metric_frame = tk.Frame(content, bg='#f8f9fa', relief=tk.FLAT, bd=0)
            metric_frame.pack(fill=tk.X, pady=(0, 8))
            
            metric_content = tk.Frame(metric_frame, bg='#f8f9fa')
            metric_content.pack(fill=tk.X, padx=15, pady=10)
            
            label_text = tk.Label(metric_content, text=label, 
                                 font=('Segoe UI', 10), bg='#f8f9fa', fg='#7f8c8d', anchor='w')
            label_text.pack(fill=tk.X)
            
            value_text = tk.Label(metric_content, text=value, 
                                 font=('Segoe UI', 14, 'bold'), bg='#f8f9fa', fg=color, anchor='w')
            value_text.pack(fill=tk.X, pady=(2, 0))
        
        return card_container
    
    def create_attendance_summary_card(self, parent):
        """Create attendance summary report card"""
        # Main card container
        card_container = tk.Frame(parent, bg='#ffffff', relief=tk.FLAT, bd=0)
        
        # Shadow effect
        shadow = tk.Frame(card_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        shadow.pack(fill=tk.BOTH, expand=True, padx=(2, 0), pady=(2, 0))
        
        card = tk.Frame(shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        card.pack(fill=tk.BOTH, expand=True, padx=(0, 2), pady=(0, 2))
        
        # Header
        header = tk.Frame(card, bg='#3498db', relief=tk.FLAT, bd=0)
        header.pack(fill=tk.X)
        
        header_content = tk.Frame(header, bg='#3498db')
        header_content.pack(fill=tk.X, padx=20, pady=15)
        
        icon_label = tk.Label(header_content, text="📝", font=('Segoe UI', 16), bg='#3498db', fg='white')
        icon_label.pack(side=tk.LEFT)
        
        title_label = tk.Label(header_content, text="Attendance Summary", 
                              font=('Segoe UI', 14, 'bold'), bg='#3498db', fg='white')
        title_label.pack(side=tk.LEFT, padx=(10, 0))
        
        # Content
        content = tk.Frame(card, bg='#ffffff')
        content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Get attendance data
        today = date.today().strftime('%Y-%m-%d')
        
        # Today's attendance
        self.cursor.execute("""
            SELECT COUNT(*) FROM attendance 
            WHERE date = ? AND present = 1
        """, (today,))
        today_present = self.cursor.fetchone()[0] or 0
        
        # Total students
        self.cursor.execute("SELECT COUNT(*) FROM students WHERE status = 'Active'")
        total_students = self.cursor.fetchone()[0] or 1  # Avoid division by zero
        
        today_rate = (today_present / total_students * 100) if total_students > 0 else 0
        
        # Weekly average
        week_ago = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
        self.cursor.execute("""
            SELECT AVG(daily_present) FROM (
                SELECT COUNT(*) as daily_present FROM attendance 
                WHERE date >= ? AND date <= ? AND present = 1
                GROUP BY date
            )
        """, (week_ago, today))
        weekly_avg_result = self.cursor.fetchone()[0]
        weekly_avg = weekly_avg_result if weekly_avg_result else 0
        weekly_rate = (weekly_avg / total_students * 100) if total_students > 0 else 0
        
        # Create attendance metrics
        metrics = [
            ("Today's Attendance", f"{today_present}/{total_students} ({today_rate:.1f}%)", "#27ae60" if today_rate >= 80 else "#e74c3c"),
            ("Weekly Average", f"{weekly_avg:.0f}/{total_students} ({weekly_rate:.1f}%)", "#3498db"),
            ("Total Active Students", str(total_students), "#2c3e50")
        ]
        
        for i, (label, value, color) in enumerate(metrics):
            metric_frame = tk.Frame(content, bg='#f8f9fa', relief=tk.FLAT, bd=0)
            metric_frame.pack(fill=tk.X, pady=(0, 8))
            
            metric_content = tk.Frame(metric_frame, bg='#f8f9fa')
            metric_content.pack(fill=tk.X, padx=15, pady=10)
            
            label_text = tk.Label(metric_content, text=label, 
                                 font=('Segoe UI', 10), bg='#f8f9fa', fg='#7f8c8d', anchor='w')
            label_text.pack(fill=tk.X)
            
            value_text = tk.Label(metric_content, text=value, 
                                 font=('Segoe UI', 14, 'bold'), bg='#f8f9fa', fg=color, anchor='w')
            value_text.pack(fill=tk.X, pady=(2, 0))
        
        return card_container
    
    def create_performance_summary_card(self, parent):
        """Create academic performance summary report card"""
        # Main card container
        card_container = tk.Frame(parent, bg='#ffffff', relief=tk.FLAT, bd=0)
        
        # Shadow effect
        shadow = tk.Frame(card_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        shadow.pack(fill=tk.BOTH, expand=True, padx=(2, 0), pady=(2, 0))
        
        card = tk.Frame(shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        card.pack(fill=tk.BOTH, expand=True, padx=(0, 2), pady=(0, 2))
        
        # Header
        header = tk.Frame(card, bg='#8e44ad', relief=tk.FLAT, bd=0)
        header.pack(fill=tk.X)
        
        header_content = tk.Frame(header, bg='#8e44ad')
        header_content.pack(fill=tk.X, padx=20, pady=15)
        
        icon_label = tk.Label(header_content, text="📈", font=('Segoe UI', 16), bg='#8e44ad', fg='white')
        icon_label.pack(side=tk.LEFT)
        
        title_label = tk.Label(header_content, text="School Performance Overview", 
                              font=('Segoe UI', 14, 'bold'), bg='#8e44ad', fg='white')
        title_label.pack(side=tk.LEFT, padx=(10, 0))
        
        # Content
        content = tk.Frame(card, bg='#ffffff')
        content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Get performance data
        # Class utilization
        self.cursor.execute("""
            SELECT 
                SUM(capacity) as total_capacity,
                COUNT(s.id) as enrolled_students
            FROM classes c
            LEFT JOIN students s ON c.id = s.class_id AND s.status = 'Active'
        """)
        capacity_data = self.cursor.fetchone()
        total_capacity = capacity_data[0] or 0
        enrolled = capacity_data[1] or 0
        utilization = (enrolled / total_capacity * 100) if total_capacity > 0 else 0
        
        # Teacher-student ratio
        self.cursor.execute("SELECT COUNT(*) FROM teachers")
        total_teachers = self.cursor.fetchone()[0] or 1  # Avoid division by zero
        teacher_ratio = enrolled / total_teachers if total_teachers > 0 else 0
        
        # Recent enrollments (last 30 days)
        thirty_days_ago = (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d')
        self.cursor.execute("""
            SELECT COUNT(*) FROM students 
            WHERE date_of_admission >= ?
        """, (thirty_days_ago,))
        recent_enrollments = self.cursor.fetchone()[0] or 0
        
        # Classes with teachers assigned
        self.cursor.execute("""
            SELECT COUNT(*) FROM classes 
            WHERE class_teacher_id IS NOT NULL
        """)
        classes_with_teachers = self.cursor.fetchone()[0] or 0
        
        self.cursor.execute("SELECT COUNT(*) FROM classes")
        total_classes = self.cursor.fetchone()[0] or 1
        teacher_coverage = (classes_with_teachers / total_classes * 100) if total_classes > 0 else 0
        
        # Create performance grid
        performance_grid = tk.Frame(content, bg='#ffffff')
        performance_grid.pack(fill=tk.X)
        
        # Left column metrics
        left_column = tk.Frame(performance_grid, bg='#ffffff')
        left_column.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 15))
        
        left_metrics = [
            ("Class Utilization", f"{utilization:.1f}% ({enrolled}/{total_capacity})", "#3498db"),
            ("Recent Enrollments (30 days)", str(recent_enrollments), "#27ae60")
        ]
        
        for label, value, color in left_metrics:
            metric_frame = tk.Frame(left_column, bg='#f8f9fa', relief=tk.FLAT, bd=0)
            metric_frame.pack(fill=tk.X, pady=(0, 12))
            
            metric_content = tk.Frame(metric_frame, bg='#f8f9fa')
            metric_content.pack(fill=tk.X, padx=15, pady=12)
            
            label_text = tk.Label(metric_content, text=label, 
                                 font=('Segoe UI', 10), bg='#f8f9fa', fg='#7f8c8d', anchor='w')
            label_text.pack(fill=tk.X)
            
            value_text = tk.Label(metric_content, text=value, 
                                 font=('Segoe UI', 14, 'bold'), bg='#f8f9fa', fg=color, anchor='w')
            value_text.pack(fill=tk.X, pady=(4, 0))
        
        # Right column metrics
        right_column = tk.Frame(performance_grid, bg='#ffffff')
        right_column.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(15, 0))
        
        right_metrics = [
            ("Teacher-Student Ratio", f"1:{teacher_ratio:.1f}", "#e67e22"),
            ("Classes with Teachers", f"{teacher_coverage:.1f}% ({classes_with_teachers}/{total_classes})", "#9b59b6")
        ]
        
        for label, value, color in right_metrics:
            metric_frame = tk.Frame(right_column, bg='#f8f9fa', relief=tk.FLAT, bd=0)
            metric_frame.pack(fill=tk.X, pady=(0, 12))
            
            metric_content = tk.Frame(metric_frame, bg='#f8f9fa')
            metric_content.pack(fill=tk.X, padx=15, pady=12)
            
            label_text = tk.Label(metric_content, text=label, 
                                 font=('Segoe UI', 10), bg='#f8f9fa', fg='#7f8c8d', anchor='w')
            label_text.pack(fill=tk.X)
            
            value_text = tk.Label(metric_content, text=value, 
                                 font=('Segoe UI', 14, 'bold'), bg='#f8f9fa', fg=color, anchor='w')
            value_text.pack(fill=tk.X, pady=(4, 0))
        
        return card_container
    
    def create_modern_button(self, parent, text, command, style='primary', **kwargs):
        """Create a modern styled button with consistent design"""
        styles = {
            'primary': {'bg': '#3498db', 'fg': 'white', 'active_bg': '#2980b9'},
            'success': {'bg': '#27ae60', 'fg': 'white', 'active_bg': '#229954'},
            'danger': {'bg': '#e74c3c', 'fg': 'white', 'active_bg': '#c0392b'},
            'warning': {'bg': '#f39c12', 'fg': 'white', 'active_bg': '#e67e22'},
            'secondary': {'bg': '#6c757d', 'fg': 'white', 'active_bg': '#5a6268'}
        }
        
        style_config = styles.get(style, styles['primary'])
        
        btn = tk.Button(parent, text=text, command=command,
                       font=('Segoe UI', 10, 'bold'),
                       bg=style_config['bg'], 
                       fg=style_config['fg'],
                       activebackground=style_config['active_bg'],
                       activeforeground='white',
                       relief=tk.FLAT,
                       bd=0,
                       padx=20, pady=12,
                       cursor='hand2',
                       highlightthickness=0,
                       **kwargs)
        
        # Hover effects
        def on_enter(e):
            btn.configure(bg=style_config['active_bg'])
        def on_leave(e):
            btn.configure(bg=style_config['bg'])
            
        btn.bind("<Enter>", on_enter)
        btn.bind("<Leave>", on_leave)
        
        return btn
    
    def create_status_bar(self):
        # Modern status bar at bottom with clean borders
        # Add top border line
        border_frame = tk.Frame(self.main_frame, bg='#bdc3c7', height=1, relief=tk.FLAT, bd=0)
        border_frame.pack(fill=tk.X, side=tk.BOTTOM)
        
        status_frame = tk.Frame(self.main_frame, bg='#34495e', height=32, relief=tk.FLAT, bd=0)
        status_frame.pack(fill=tk.X, side=tk.BOTTOM)
        status_frame.pack_propagate(False)
        
        # Status text
        self.status_var = tk.StringVar(value="Ready - Gaybeck Starkids Academy")
        status_label = tk.Label(status_frame, textvariable=self.status_var, 
                               font=('Segoe UI', 10), bg='#34495e', fg='#ecf0f1')
        status_label.pack(side=tk.LEFT, padx=15, pady=5)
        
        # Current time display
        self.time_var = tk.StringVar()
        time_label = tk.Label(status_frame, textvariable=self.time_var,
                             font=('Segoe UI', 10), bg='#34495e', fg='#bdc3c7')
        time_label.pack(side=tk.RIGHT, padx=15, pady=5)
        
        # Update time every second
        self.update_time()
    
    def update_time(self):
        current_time = datetime.now().strftime("%I:%M:%S %p")
        self.time_var.set(current_time)
        self.root.after(1000, self.update_time)
    
    def update_status(self, message):
        """Update status bar message"""
        self.status_var.set(message)
        # Auto clear after 3 seconds
        self.root.after(3000, lambda: self.status_var.set("Ready"))
    
    def bind_global_keyboard_navigation(self):
        """Bind global keyboard shortcuts for scrolling across the app"""
        def find_scrollable_canvas(widget):
            """Recursively find ScrollableFrame canvas in widget tree"""
            if hasattr(widget, 'canvas') and hasattr(widget, 'scrollbar'):
                # This is a ScrollableFrame
                return widget.canvas
            
            # Check in content_frame children
            if hasattr(self, 'content_frame') and self.content_frame.winfo_exists():
                for child in self.content_frame.winfo_children():
                    if hasattr(child, 'canvas') and hasattr(child, 'scrollbar'):
                        return child.canvas
            
            return None
        
        def on_global_key_scroll(event):
            # Don't intercept if typing in Entry, Text, or similar widgets
            focused = self.root.focus_get()
            if focused and focused.__class__.__name__ in ['Entry', 'Text', 'Spinbox', 'Combobox']:
                return
            
            # Find active scrollable canvas
            canvas = find_scrollable_canvas(event.widget)
            if not canvas or not canvas.winfo_exists():
                return
            
            # Scroll based on key
            if event.keysym == 'Up':
                canvas.yview_scroll(-1, "units")
                return "break"
            elif event.keysym == 'Down':
                canvas.yview_scroll(1, "units")
                return "break"
            elif event.keysym == 'Prior':  # Page Up
                canvas.yview_scroll(-1, "pages")
                return "break"
            elif event.keysym == 'Next':  # Page Down
                canvas.yview_scroll(1, "pages")
                return "break"
            elif event.keysym == 'Home':
                canvas.yview_moveto(0)
                return "break"
            elif event.keysym == 'End':
                canvas.yview_moveto(1)
                return "break"
        
        # Bind to root window for global effect
        self.root.bind('<Up>', on_global_key_scroll, add='+')
        self.root.bind('<Down>', on_global_key_scroll, add='+')
        self.root.bind('<Prior>', on_global_key_scroll, add='+')  # Page Up
        self.root.bind('<Next>', on_global_key_scroll, add='+')   # Page Down
        self.root.bind('<Home>', on_global_key_scroll, add='+')
        self.root.bind('<End>', on_global_key_scroll, add='+')

    def show_student_management(self):
        self.clear_content_frame()
        
        # Create scrollable frame for student management
        scrollable_student = ScrollableFrame(self.content_frame, bg='#ffffff')
        scrollable_student.pack(fill=tk.BOTH, expand=True)
        student_main_frame = scrollable_student.get_frame()
        
        # Modern student header
        header_section = tk.Frame(student_main_frame, relief=tk.FLAT, bd=0)
        header_section.pack(fill=tk.X, padx=0, pady=(0, 25))
        
        title = tk.Label(header_section, text="🎓 Student Management",
                         font=('Segoe UI', 28, 'bold'), fg='#2c3e50')
        title.pack(anchor=tk.W)
        
        # Role-based subtitle
        if self.current_user.get('role') == 'admin':
            subtitle_text = "Manage student records, enrollment, and academic information (Full Access)"
        elif self.current_user.get('role') == 'teacher':
            teacher_class_id = self.get_teacher_assigned_class()
            if teacher_class_id:
                self.cursor.execute("SELECT class_name FROM classes WHERE id = ?", (teacher_class_id,))
                class_result = self.cursor.fetchone()
                class_name = class_result[0] if class_result else "Unknown Class"
                subtitle_text = f"Manage students from your assigned class: {class_name}"
            else:
                subtitle_text = "No class assigned to your account"
        else:
            subtitle_text = "View student information (Limited Access)"
            
        subtitle = tk.Label(header_section, text=subtitle_text,
                           font=('Segoe UI', 14), fg='#7f8c8d')
        subtitle.pack(anchor=tk.W, pady=(5, 0))

        # Statistics Panel
        stats_section = tk.Frame(student_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        stats_section.pack(fill=tk.X, padx=0, pady=(0, 20))
        
        stats_inner = tk.Frame(stats_section, bg='#f8f9fa')
        stats_inner.pack(fill=tk.X, padx=25, pady=20)
        
        stats_title = tk.Label(stats_inner, text="📊 Student Statistics", 
                              font=('Segoe UI', 16, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        stats_title.pack(anchor=tk.W, pady=(0, 15))
        
        # Statistics grid
        stats_grid = tk.Frame(stats_inner, bg='#f8f9fa')
        stats_grid.pack(fill=tk.X)
        
        # Initialize and display student statistics
        self.total_students_stat = tk.Label(stats_grid, text="Total Students: 0",
                                           font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#27ae60')
        self.total_students_stat.pack(side=tk.LEFT, padx=(0, 30))
        
        self.active_classes_stat = tk.Label(stats_grid, text="Active Classes: 0",
                                           font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#3498db')
        self.active_classes_stat.pack(side=tk.LEFT, padx=(0, 30))
        
        # Update statistics
        self.update_student_statistics()

        # Control panel with modern styling
        control_panel = tk.Frame(student_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        control_panel.pack(fill=tk.X, padx=0, pady=(0, 20))
        
        control_inner = tk.Frame(control_panel, bg='#f8f9fa')
        control_inner.pack(fill=tk.X, padx=25, pady=20)
        
        # Search section
        search_section = tk.Frame(control_inner, bg='#f8f9fa')
        search_section.pack(fill=tk.X, pady=(0, 15))
        
        search_label = tk.Label(search_section, text="🔍 Quick Search:", 
                               font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        search_label.pack(side=tk.LEFT)
        
        self.search_var = tk.StringVar()
        search_entry = AutocompleteEntry(search_section, textvariable=self.search_var, width=25, 
                               font=('Segoe UI', 11),
                               suggestions_callback=self.get_student_suggestions)
        search_entry.pack(side=tk.LEFT, padx=(10, 15))
        
        search_btn = self.create_modern_button(search_section, "🔍 Search & Filter", 
                                             self.search_and_filter_students, 'primary', width=15)
        search_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        details_btn = self.create_modern_button(search_section, "📋 View Details", 
                                              self.show_student_details, 'success', width=15)
        details_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        clear_btn = self.create_modern_button(search_section, "🔄 Clear Search", 
                                            self.clear_student_search, 'secondary', width=12)
        clear_btn.pack(side=tk.LEFT)
        
        # Button section
        buttons_section = tk.Frame(control_inner, bg='#f8f9fa')
        buttons_section.pack(fill=tk.X)
        
        # Left side buttons
        left_buttons = tk.Frame(buttons_section, bg='#f8f9fa')
        left_buttons.pack(side=tk.LEFT)

        # Enhanced data section
        data_section = tk.Frame(student_main_frame, bg='#ffffff', relief=tk.FLAT, bd=0)
        data_section.pack(fill=tk.BOTH, expand=True, padx=25, pady=0)
        
        # Create tabbed interface with modern styling
        notebook = ttk.Notebook(data_section)
        notebook.pack(fill=tk.BOTH, expand=True, pady=(0, 20))

        # Student Form Tab
        form_tab = ttk.Frame(notebook)
        notebook.add(form_tab, text="📝 Add/Edit Student")
        
        # Form container with modern styling
        form_container = ScrollableFrame(form_tab, bg='#f8f9fa')
        form_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        form_frame = form_container.get_frame()
        
        # ========== SECTION 1: PERSONAL INFORMATION ==========
        personal_section = tk.LabelFrame(form_frame, text="👤 Personal Information", 
                                        font=('Segoe UI', 12, 'bold'), fg='#2c3e50', 
                                        bg='#f8f9fa', relief=tk.FLAT, bd=1)
        personal_section.pack(fill=tk.X, padx=20, pady=(20, 15))
        
        personal_grid = tk.Frame(personal_section, bg='#f8f9fa')
        personal_grid.pack(fill=tk.X, padx=15, pady=15)
        
        # Personal Row 1: Student ID and Full Name
        personal_row1 = tk.Frame(personal_grid, bg='#f8f9fa')
        personal_row1.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(personal_row1, text="Student ID:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.student_id = tk.Entry(personal_row1, width=25, font=('Segoe UI', 11), 
                                  relief=tk.SOLID, bd=1, state='readonly', 
                                  fg='#7f8c8d', bg='#ecf0f1')
        self.student_id.pack(side=tk.LEFT, padx=(10, 10))
        
        # Auto-generate button for Student ID
        auto_id_btn = tk.Button(personal_row1, text="🔄 Auto", 
                                font=('Segoe UI', 9, 'bold'),
                                bg='#3498db', fg='white', relief=tk.FLAT,
                                cursor='hand2', padx=8, pady=2,
                                command=self.auto_generate_student_id)
        auto_id_btn.pack(side=tk.LEFT, padx=(0, 20))
        
        tk.Label(personal_row1, text="Full Name:*", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.student_name = tk.Entry(personal_row1, width=40, font=('Segoe UI', 11), 
                                   relief=tk.SOLID, bd=1)
        self.student_name.pack(side=tk.LEFT, padx=(10, 0))
        
        # Personal Row 2: Date of Birth and Gender
        personal_row2 = tk.Frame(personal_grid, bg='#f8f9fa')
        personal_row2.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(personal_row2, text="Date of Birth:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.date_of_birth = DateEntry(personal_row2, width=15, background='#3498db',
                                      foreground='white', borderwidth=1, year=2010,
                                      font=('Segoe UI', 10))
        self.date_of_birth.pack(side=tk.LEFT, padx=(10, 40))
        
        tk.Label(personal_row2, text="Gender:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.gender = tk.StringVar(value="Male")
        gender_frame = tk.Frame(personal_row2, bg='#f8f9fa')
        gender_frame.pack(side=tk.LEFT, padx=(10, 0))
        
        male_radio = tk.Radiobutton(gender_frame, text="♂️ Male", variable=self.gender, 
                                   value="Male", bg='#f8f9fa', font=('Segoe UI', 10))
        male_radio.pack(side=tk.LEFT, padx=(0, 20))
        female_radio = tk.Radiobutton(gender_frame, text="♀️ Female", variable=self.gender, 
                                     value="Female", bg='#f8f9fa', font=('Segoe UI', 10))
        female_radio.pack(side=tk.LEFT)
        
        # ========== SECTION 2: ACADEMIC INFORMATION ==========
        academic_section = tk.LabelFrame(form_frame, text="🎓 Academic Information", 
                                        font=('Segoe UI', 12, 'bold'), fg='#2c3e50', 
                                        bg='#f8f9fa', relief=tk.FLAT, bd=1)
        academic_section.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        academic_grid = tk.Frame(academic_section, bg='#f8f9fa')
        academic_grid.pack(fill=tk.X, padx=15, pady=15)
        
        # Academic Row 1: Admission Date and Current Class
        academic_row1 = tk.Frame(academic_grid, bg='#f8f9fa')
        academic_row1.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(academic_row1, text="Date of Admission:*", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.date_of_admission = DateEntry(academic_row1, width=15, background='#3498db',
                                          foreground='white', borderwidth=1, 
                                          date_pattern='y-mm-dd', font=('Segoe UI', 10))
        self.date_of_admission.pack(side=tk.LEFT, padx=(10, 40))
        
        tk.Label(academic_row1, text="Current Class:*", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        
        self.cursor.execute("SELECT id, class_name FROM classes")
        classes = self.cursor.fetchall()
        self.class_dict = {class_name: class_id for class_id, class_name in classes}
        class_names = [class_name for class_id, class_name in classes]
        
        self.current_class = tk.StringVar()
        current_class_dropdown = ttk.Combobox(academic_row1, textvariable=self.current_class, 
                                             values=class_names, state="readonly", width=25,
                                             font=('Segoe UI', 11))
        current_class_dropdown.pack(side=tk.LEFT, padx=(10, 0))
        
        # ========== SECTION 3: PARENT & CONTACT INFORMATION ==========
        contact_section = tk.LabelFrame(form_frame, text="👨‍👩‍👧 Parent & Contact Information", 
                                       font=('Segoe UI', 12, 'bold'), fg='#2c3e50', 
                                       bg='#f8f9fa', relief=tk.FLAT, bd=1)
        contact_section.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        contact_grid = tk.Frame(contact_section, bg='#f8f9fa')
        contact_grid.pack(fill=tk.X, padx=15, pady=15)
        
        # Contact Row 1: Father's and Mother's Names
        contact_row1 = tk.Frame(contact_grid, bg='#f8f9fa')
        contact_row1.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(contact_row1, text="Father's Name:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.father_name = tk.Entry(contact_row1, width=30, font=('Segoe UI', 11), 
                                   relief=tk.SOLID, bd=1)
        self.father_name.pack(side=tk.LEFT, padx=(10, 40))
        
        tk.Label(contact_row1, text="Mother's Name:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.mother_name = tk.Entry(contact_row1, width=30, font=('Segoe UI', 11), 
                                   relief=tk.SOLID, bd=1)
        self.mother_name.pack(side=tk.LEFT, padx=(10, 0))
        
        # Contact Row 2: Phone and Email
        contact_row2 = tk.Frame(contact_grid, bg='#f8f9fa')
        contact_row2.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(contact_row2, text="Phone Number:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.phone = tk.Entry(contact_row2, width=25, font=('Segoe UI', 11), 
                             relief=tk.SOLID, bd=1)
        self.phone.pack(side=tk.LEFT, padx=(10, 40))
        
        tk.Label(contact_row2, text="Email Address:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.parent_email = tk.Entry(contact_row2, width=40, font=('Segoe UI', 11), 
                                    relief=tk.SOLID, bd=1)
        self.parent_email.pack(side=tk.LEFT, padx=(10, 0))
        
        # Contact Row 3: Home Address
        contact_row3 = tk.Frame(contact_grid, bg='#f8f9fa')
        contact_row3.pack(fill=tk.X, pady=(0, 5))
        
        tk.Label(contact_row3, text="Home Address:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(anchor=tk.W, pady=(0, 8))
        
        address_text_frame = tk.Frame(contact_row3, bg='#f8f9fa')
        address_text_frame.pack(fill=tk.X)
        
        self.address_text = tk.Text(address_text_frame, height=4, width=100, 
                                   font=('Segoe UI', 11), wrap=tk.WORD, 
                                   relief=tk.SOLID, bd=1)
        address_scrollbar = tk.Scrollbar(address_text_frame, orient=tk.VERTICAL, 
                                        command=self.address_text.yview)
        self.address_text.configure(yscrollcommand=address_scrollbar.set)
        
        self.address_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        address_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # Add placeholder text for address
        placeholder_address = "Enter complete home address including street, city, region..."
        self.address_text.insert('1.0', placeholder_address)
        self.address_text.config(fg='#95a5a6')
        
        def on_address_focus_in(event):
            if self.address_text.get('1.0', 'end-1c') == placeholder_address:
                self.address_text.delete('1.0', tk.END)
                self.address_text.config(fg='#2c3e50')
        
        def on_address_focus_out(event):
            if self.address_text.get('1.0', 'end-1c').strip() == '':
                self.address_text.insert('1.0', placeholder_address)
                self.address_text.config(fg='#95a5a6')
        
        self.address_text.bind('<FocusIn>', on_address_focus_in)
        self.address_text.bind('<FocusOut>', on_address_focus_out)
        
        # ========== SECTION 4: FEE & TRANSPORTATION INFORMATION ==========
        fee_section = tk.LabelFrame(form_frame, text="💵 Fee & Transportation Information", 
                                   font=('Segoe UI', 12, 'bold'), fg='#2c3e50', 
                                   bg='#f8f9fa', relief=tk.FLAT, bd=1)
        fee_section.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        fee_grid = tk.Frame(fee_section, bg='#f8f9fa')
        fee_grid.pack(fill=tk.X, padx=15, pady=15)
        
        # Fee Row 1: Monthly Fee and Feeding Fee
        fee_row1 = tk.Frame(fee_grid, bg='#f8f9fa')
        fee_row1.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(fee_row1, text="Monthly Fee (GHS):", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.monthly_fee = tk.Entry(fee_row1, width=15, font=('Segoe UI', 11), 
                                   relief=tk.SOLID, bd=1)
        self.monthly_fee.pack(side=tk.LEFT, padx=(10, 40))
        self.monthly_fee.insert(0, "0.00")
        
        tk.Label(fee_row1, text="Feeding Fee Paid:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.feeding_fee_paid = tk.BooleanVar()
        feeding_check = tk.Checkbutton(fee_row1, variable=self.feeding_fee_paid, 
                                      bg='#f8f9fa', text="✅ Yes", font=('Segoe UI', 10))
        feeding_check.pack(side=tk.LEFT, padx=(10, 0))
        
        # Fee Row 2: Transportation Options
        fee_row2 = tk.Frame(fee_grid, bg='#f8f9fa')
        fee_row2.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(fee_row2, text="Transportation Mode:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.transportation = tk.StringVar(value="Walk-in")
        transport_frame = tk.Frame(fee_row2, bg='#f8f9fa')
        transport_frame.pack(side=tk.LEFT, padx=(10, 40))
        
        walkin_radio = tk.Radiobutton(transport_frame, text="🚶 Walk-in", 
                                     variable=self.transportation, value="Walk-in", 
                                     bg='#f8f9fa', font=('Segoe UI', 10))
        walkin_radio.pack(side=tk.LEFT, padx=(0, 15))
        
        bus_radio = tk.Radiobutton(transport_frame, text="🚌 Bus", 
                                  variable=self.transportation, value="Bus", 
                                  bg='#f8f9fa', font=('Segoe UI', 10))
        bus_radio.pack(side=tk.LEFT)
        
        tk.Label(fee_row2, text="Bus Fee (GHS):", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.bus_fee = tk.Entry(fee_row2, width=15, font=('Segoe UI', 11), 
                               relief=tk.SOLID, bd=1)
        self.bus_fee.pack(side=tk.LEFT, padx=(10, 0))
        self.bus_fee.insert(0, "0.00")

        # ========== SECTION 5: STUDENT STATUS ==========
        status_section = tk.LabelFrame(form_frame, text="📊 Student Status", 
                                      font=('Segoe UI', 12, 'bold'), fg='#2c3e50', 
                                      bg='#f8f9fa', relief=tk.FLAT, bd=1)
        status_section.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        status_grid = tk.Frame(status_section, bg='#f8f9fa')
        status_grid.pack(fill=tk.X, padx=15, pady=15)
        
        tk.Label(status_grid, text="Current Status:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.student_status = tk.StringVar(value="Active")
        status_frame = tk.Frame(status_grid, bg='#f8f9fa')
        status_frame.pack(side=tk.LEFT, padx=(10, 0))
        
        active_radio = tk.Radiobutton(status_frame, text="✅ Active", 
                                     variable=self.student_status, value="Active", 
                                     bg='#f8f9fa', font=('Segoe UI', 10), fg='#27ae60')
        active_radio.pack(side=tk.LEFT, padx=(0, 20))
        
        inactive_radio = tk.Radiobutton(status_frame, text="❌ Inactive", 
                                       variable=self.student_status, value="Inactive", 
                                       bg='#f8f9fa', font=('Segoe UI', 10), fg='#e74c3c')
        inactive_radio.pack(side=tk.LEFT, padx=(0, 20))
        
        suspended_radio = tk.Radiobutton(status_frame, text="⚠️ Suspended", 
                                        variable=self.student_status, value="Suspended", 
                                        bg='#f8f9fa', font=('Segoe UI', 10), fg='#f39c12')
        suspended_radio.pack(side=tk.LEFT)

        # ========== SECTION 6: EMERGENCY CONTACT INFORMATION ==========
        emergency_section = tk.LabelFrame(form_frame, text="🆘 Emergency Contact Information", 
                                         font=('Segoe UI', 12, 'bold'), fg='#2c3e50', 
                                         bg='#f8f9fa', relief=tk.FLAT, bd=1)
        emergency_section.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        emergency_grid = tk.Frame(emergency_section, bg='#f8f9fa')
        emergency_grid.pack(fill=tk.X, padx=15, pady=15)
        
        # Emergency Row 1: Contact Name and Relationship
        emerg_row1 = tk.Frame(emergency_grid, bg='#f8f9fa')
        emerg_row1.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(emerg_row1, text="Emergency Contact Name:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.emergency_contact_name = tk.Entry(emerg_row1, width=25, font=('Segoe UI', 11), 
                                              relief=tk.SOLID, bd=1)
        self.emergency_contact_name.pack(side=tk.LEFT, padx=(10, 40))
        
        tk.Label(emerg_row1, text="Relationship:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.emergency_relationship = tk.StringVar()
        relationship_dropdown = ttk.Combobox(emerg_row1, textvariable=self.emergency_relationship, 
                                           values=["Parent", "Guardian", "Relative", "Family Friend", "Other"], 
                                           state="readonly", width=18, font=('Segoe UI', 10))
        relationship_dropdown.pack(side=tk.LEFT, padx=(10, 0))
        
        # Emergency Row 2: Contact Phone Numbers
        emerg_row2 = tk.Frame(emergency_grid, bg='#f8f9fa')
        emerg_row2.pack(fill=tk.X, pady=(0, 5))
        
        tk.Label(emerg_row2, text="Primary Phone:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.emergency_phone = tk.Entry(emerg_row2, width=18, font=('Segoe UI', 11), 
                                       relief=tk.SOLID, bd=1)
        self.emergency_phone.pack(side=tk.LEFT, padx=(10, 40))
        
        tk.Label(emerg_row2, text="Alternative Phone:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.emergency_alt_phone = tk.Entry(emerg_row2, width=18, font=('Segoe UI', 11), 
                                           relief=tk.SOLID, bd=1)
        self.emergency_alt_phone.pack(side=tk.LEFT, padx=(10, 0))

        # ========== SECTION 6: MEDICAL & HEALTH INFORMATION ==========
        medical_section = tk.LabelFrame(form_frame, text="🏥 Medical & Health Information", 
                                       font=('Segoe UI', 12, 'bold'), fg='#2c3e50', 
                                       bg='#f8f9fa', relief=tk.FLAT, bd=1)
        medical_section.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        medical_grid = tk.Frame(medical_section, bg='#f8f9fa')
        medical_grid.pack(fill=tk.X, padx=15, pady=15)
        
        # Medical Information
        med_row1 = tk.Frame(medical_grid, bg='#f8f9fa')
        med_row1.pack(fill=tk.X, pady=(0, 5))
        
        tk.Label(med_row1, text="Medical Conditions & Allergies:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(anchor=tk.W, pady=(0, 8))
        
        allergies_text_frame = tk.Frame(med_row1, bg='#f8f9fa')
        allergies_text_frame.pack(fill=tk.X)
        
        self.allergies_text = tk.Text(allergies_text_frame, height=3, width=80, 
                                     font=('Segoe UI', 10), wrap=tk.WORD, 
                                     relief=tk.SOLID, bd=1)
        allergies_scrollbar = tk.Scrollbar(allergies_text_frame, orient=tk.VERTICAL, 
                                          command=self.allergies_text.yview)
        self.allergies_text.configure(yscrollcommand=allergies_scrollbar.set)
        
        self.allergies_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        allergies_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # Add placeholder for allergies
        placeholder_allergies = "List any known allergies, medications, or medical conditions (e.g., asthma, diabetes, food allergies, medications being taken...)"
        self.allergies_text.insert('1.0', placeholder_allergies)
        self.allergies_text.config(fg='#95a5a6')
        
        def on_allergies_focus_in(event):
            if self.allergies_text.get('1.0', 'end-1c') == placeholder_allergies:
                self.allergies_text.delete('1.0', tk.END)
                self.allergies_text.config(fg='#2c3e50')
        
        def on_allergies_focus_out(event):
            if self.allergies_text.get('1.0', 'end-1c').strip() == '':
                self.allergies_text.insert('1.0', placeholder_allergies)
                self.allergies_text.config(fg='#95a5a6')
        
        self.allergies_text.bind('<FocusIn>', on_allergies_focus_in)
        self.allergies_text.bind('<FocusOut>', on_allergies_focus_out)

        # ========== SECTION 7: DOCUMENT MANAGEMENT ==========
        doc_section = tk.LabelFrame(form_frame, text="📄 Document Management", 
                                   font=('Segoe UI', 12, 'bold'), fg='#2c3e50', 
                                   bg='#f8f9fa', relief=tk.FLAT, bd=1)
        doc_section.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        doc_grid = tk.Frame(doc_section, bg='#f8f9fa')
        doc_grid.pack(fill=tk.X, padx=15, pady=15)
        
        # Document upload section
        upload_row = tk.Frame(doc_grid, bg='#f8f9fa')
        upload_row.pack(fill=tk.X, pady=(0, 8))
        
        tk.Label(upload_row, text="Upload Important Documents:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#34495e').pack(anchor=tk.W, pady=(0, 8))
        
        # Document types info
        doc_info = tk.Label(upload_row, text="Accepted: Birth Certificate, Medical Records, Previous School Records, Photos (PDF, DOC, Images)", 
                           font=('Segoe UI', 9, 'italic'), bg='#f8f9fa', fg='#7f8c8d')
        doc_info.pack(anchor=tk.W, pady=(0, 10))
        
        upload_frame = tk.Frame(upload_row, bg='#f8f9fa')
        upload_frame.pack(fill=tk.X)
        
        self.student_file_path_var = tk.StringVar()
        self.student_file_entry = tk.Entry(upload_frame, textvariable=self.student_file_path_var, 
                                          width=60, font=('Segoe UI', 10), state='readonly',
                                          relief=tk.SOLID, bd=1)
        self.student_file_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 15))
        
        upload_btn = tk.Button(upload_frame, text="📂 Browse Files", 
                              font=('Segoe UI', 10, 'bold'), 
                              bg='#3498db', fg='#ffffff', 
                              relief=tk.FLAT, bd=0, cursor='hand2',
                              command=self.browse_student_document,
                              padx=15, pady=8)
        upload_btn.pack(side=tk.RIGHT)
        
        # Add hover effects to upload button
        def on_upload_enter(e):
            upload_btn.configure(bg='#2980b9')
        
        def on_upload_leave(e):
            upload_btn.configure(bg='#3498db')
            
        upload_btn.bind("<Enter>", on_upload_enter)
        upload_btn.bind("<Leave>", on_upload_leave)
        
        # File status display
        self.student_file_info = tk.Label(upload_row, text="📊 No file selected", 
                                         font=('Segoe UI', 10), 
                                         bg='#f8f9fa', fg='#7f8c8d')
        self.student_file_info.pack(anchor=tk.W, pady=(8, 0))
        
        # ========== ACTION BUTTONS SECTION ==========
        button_section = tk.LabelFrame(form_frame, text="⚡ Actions", 
                                      font=('Segoe UI', 11, 'bold'), fg='#2c3e50', 
                                      bg='#f8f9fa', relief=tk.FLAT, bd=1)
        button_section.pack(fill=tk.X, padx=20, pady=(0, 20))
        
        button_container = tk.Frame(button_section, bg='#f8f9fa')
        button_container.pack(anchor=tk.CENTER, pady=15)
        
        add_btn = self.create_modern_button(button_container, "➕ Add Student", 
                                          self.add_student, 'success', width=18)
        add_btn.pack(side=tk.LEFT, padx=(0, 15))
        
        update_btn = self.create_modern_button(button_container, "🔄 Update Student", 
                                             self.update_student, 'primary', width=18)
        update_btn.pack(side=tk.LEFT, padx=(0, 15))
        
        delete_btn = self.create_modern_button(button_container, "🗑️ Delete Student", 
                                             self.delete_student, 'danger', width=18)
        delete_btn.pack(side=tk.LEFT, padx=(0, 15))
        
        status_btn = self.create_modern_button(button_container, "📊 Change Status", 
                                             self.change_student_status, 'warning', width=18)
        status_btn.pack(side=tk.LEFT, padx=(0, 15))
        
        clear_btn = self.create_modern_button(button_container, "🧹 Clear Form", 
                                            self.clear_student_form, 'secondary', width=15)
        clear_btn.pack(side=tk.LEFT)
        
        # Students List Tab
        list_tab = ttk.Frame(notebook)
        notebook.add(list_tab, text="👥 Students List")
        
        # List container with modern styling
        list_container = ScrollableFrame(list_tab, bg='#ffffff')
        list_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        list_frame = list_container.get_frame()
        
        # List header
        list_header = tk.Frame(list_frame, bg='#ffffff')
        list_header.pack(fill=tk.X, padx=20, pady=(20, 15))
        
        list_title = tk.Label(list_header, text="📋 All Students", 
                             font=('Segoe UI', 16, 'bold'), fg='#2c3e50', bg='#ffffff')
        list_title.pack(anchor=tk.W)
        
        # Filter section
        filter_frame = tk.Frame(list_frame, bg='#f8f9fa', relief=tk.FLAT, bd=1)
        filter_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        filter_content = tk.Frame(filter_frame, bg='#f8f9fa')
        filter_content.pack(fill=tk.X, padx=15, pady=10)
        
        tk.Label(filter_content, text="🔍 Filter by Class:", 
                font=('Segoe UI', 10, 'bold'), bg='#f8f9fa', fg='#2c3e50').pack(side=tk.LEFT, padx=(0, 10))
        
        # Get all classes for filter
        self.cursor.execute("SELECT id, class_name FROM classes ORDER BY class_name")
        classes = self.cursor.fetchall()
        class_options = ["All Classes"] + [c[1] for c in classes]
        
        self.student_class_filter_var = tk.StringVar(value="All Classes")
        student_class_filter = ttk.Combobox(filter_content, textvariable=self.student_class_filter_var, 
                                           values=class_options, state="readonly", width=20)
        student_class_filter.pack(side=tk.LEFT, padx=(0, 15))
        student_class_filter.bind('<<ComboboxSelected>>', lambda e: self.load_students())
        
        # Enhanced treeview with modern styling
        tree_frame = tk.Frame(list_frame, bg='#ffffff')
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 20))
        
        # Treeview for students with enhanced columns
        columns = ('ID', 'Student ID', 'Name', 'Class', 'Gender', 'Admission Date', 'Phone', 'Status')
        self.students_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=15)
        
        # Configure column headers and widths
        column_config = {
            'ID': {'width': 60, 'anchor': 'center'},
            'Student ID': {'width': 100, 'anchor': 'center'},
            'Name': {'width': 150, 'anchor': 'w'},
            'Class': {'width': 100, 'anchor': 'center'},
            'Gender': {'width': 80, 'anchor': 'center'},
            'Admission Date': {'width': 120, 'anchor': 'center'},
            'Phone': {'width': 120, 'anchor': 'center'},
            'Status': {'width': 100, 'anchor': 'center'}
        }
        
        for col, config in column_config.items():
            self.students_tree.heading(col, text=col, anchor='w')
            self.students_tree.column(col, width=config['width'], anchor=config['anchor'])
        
        # Scrollbars with grid layout for proper display
        v_scroll = ttk.Scrollbar(tree_frame, orient=tk.VERTICAL, command=self.students_tree.yview)
        h_scroll = ttk.Scrollbar(tree_frame, orient=tk.HORIZONTAL, command=self.students_tree.xview)
        self.students_tree.configure(yscrollcommand=v_scroll.set, xscrollcommand=h_scroll.set)
        
        # Grid layout for treeview and scrollbars
        self.students_tree.grid(row=0, column=0, sticky='nsew')
        v_scroll.grid(row=0, column=1, sticky='ns')
        h_scroll.grid(row=1, column=0, sticky='ew')
        
        tree_frame.grid_rowconfigure(0, weight=1)
        tree_frame.grid_columnconfigure(0, weight=1)
        
        # Bind selection event and double-click for editing
        self.students_tree.bind('<<TreeviewSelect>>', self.on_student_select)
        self.students_tree.bind('<Double-1>', self.on_student_double_click)
        
        # Enable mouse wheel scrolling
        self.bind_treeview_mousewheel(self.students_tree)
        
        # Load students data
        self.load_students()

    def show_student_details(self):
        search_term = self.search_var.get().strip()
        if not search_term:
            messagebox.showinfo("Search", "Please enter a student name or ID")
            return
        
        # Search for student in database
        self.cursor.execute('''
            SELECT s.id, s.student_id, s.name, c.class_name, s.gender, s.date_of_birth,
                   s.date_of_admission, s.father_name, s.mother_name, s.phone, s.address,
                   s.transportation, s.bus_fee, s.monthly_fee, s.feeding_fee_paid, s.status
            FROM students s 
            JOIN classes c ON s.class_id = c.id
            WHERE s.name LIKE ? OR s.student_id LIKE ?
        ''', (f'%{search_term}%', f'%{search_term}%'))
        
        student = self.cursor.fetchone()
        
        if not student:
            messagebox.showinfo("Search", "No student found matching your search")
            return
        
        # Open detailed view window
        self.open_student_detail_window(student)
    
    def search_and_filter_students(self):
        """Filter the student list to show only records matching the search term"""
        search_term = self.search_var.get().strip()
        
        # Clear existing data
        for item in self.students_tree.get_children():
            self.students_tree.delete(item)
        
        if not search_term:
            # If no search term, load all students
            self.load_students()
            return
        
        # Build query based on user role
        if self.current_user.get('role') == 'teacher':
            # Teacher sees only students from their assigned class
            teacher_class_id = self.get_teacher_assigned_class()
            if teacher_class_id:
                query = '''
                    SELECT s.id, s.student_id, s.name, c.class_name, s.gender, 
                           s.date_of_admission, s.phone, s.status
                    FROM students s 
                    LEFT JOIN classes c ON s.class_id = c.id
                    WHERE s.class_id = ? AND (s.name LIKE ? OR s.student_id LIKE ? OR c.class_name LIKE ?)
                    ORDER BY s.name
                '''
                params = (teacher_class_id, f'%{search_term}%', f'%{search_term}%', f'%{search_term}%')
            else:
                # Teacher not assigned to any class
                messagebox.showinfo("Search Results", "You are not assigned to any class")
                return
        else:
            # Admin and other roles see all students
            query = '''
                SELECT s.id, s.student_id, s.name, c.class_name, s.gender, 
                       s.date_of_admission, s.phone, s.status
                FROM students s 
                LEFT JOIN classes c ON s.class_id = c.id
                WHERE s.name LIKE ? OR s.student_id LIKE ? OR c.class_name LIKE ?
                ORDER BY s.name
            '''
            params = (f'%{search_term}%', f'%{search_term}%', f'%{search_term}%')
        
        # Search for students matching the term
        self.cursor.execute(query, params)
        students = self.cursor.fetchall()
        
        if not students:
            messagebox.showinfo("Search Results", f"No students found matching '{search_term}'")
            self.update_status(f"No students found for '{search_term}'")
            return
        
        # Display filtered results
        for student in students:
            formatted_student = (
                student[0],  # ID
                student[1] or "N/A",  # Student ID
                student[2],  # Name
                student[3] or "No Class",  # Class name
                student[4],  # Gender
                student[5],  # Admission date
                student[6] or "N/A",  # Phone
                "✅ Active" if student[7] == "Active" else "❌ Inactive"  # Status with icons
            )
            self.students_tree.insert('', tk.END, values=formatted_student)
        
        # Update status
        self.update_status(f"Found {len(students)} student(s) matching '{search_term}'")
        
        # Update statistics for filtered results
        self.update_filtered_student_statistics(len(students))
    
    def clear_student_search(self):
        """Clear the search field and reload all students"""
        self.search_var.set("")
        self.load_students()
        self.update_student_statistics()
        self.update_status("Showing all students")
    
    def update_filtered_student_statistics(self, filtered_count):
        """Update statistics for filtered results"""
        # Get total count for comparison
        self.cursor.execute("SELECT COUNT(*) FROM students")
        total_students = self.cursor.fetchone()[0]
        
        # Update labels if they exist
        if hasattr(self, 'total_students_stat'):
            self.total_students_stat.config(
                text=f"Showing: {filtered_count} of {total_students} students",
                fg='#e67e22'  # Orange color to indicate filtered view
            )
    
    def open_student_detail_window(self, student_data):
        # Create detail window
        detail_window = tk.Toplevel(self.root)
        detail_window.title(f"Student Details - {student_data[2]}")
        detail_window.geometry("800x700")
        detail_window.transient(self.root)
        detail_window.grab_set()
        detail_window.configure(bg='#f0f8ff')
        
        # Main frame with scrollbar
        main_frame = tk.Frame(detail_window, bg='#f0f8ff')
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#2c3e50', relief=tk.RAISED, bd=2)
        header_frame.pack(fill=tk.X, pady=(0, 20))
        
        title_label = tk.Label(header_frame, text="STUDENT INFORMATION RECORD", 
                              font=('Arial', 16, 'bold'), fg='white', bg='#2c3e50')
        title_label.pack(pady=10)
        
        # Content frame with scroll capability
        canvas = tk.Canvas(main_frame, bg='#ffffff')
        scrollbar = ttk.Scrollbar(main_frame, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg='#ffffff')
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # Student details using simple labels
        row = 0
        
        # Personal Information Section
        tk.Label(scrollable_frame, text="PERSONAL INFORMATION", 
                font=('Arial', 14, 'bold'), bg='#3498db', fg='white', relief=tk.RAISED).grid(
                row=row, column=0, columnspan=2, sticky='ew', padx=10, pady=10)
        row += 1
        
        personal_info = [
            ("Student ID:", student_data[1] or "N/A"),
            ("Full Name:", student_data[2]),
            ("Gender:", student_data[4]),
            ("Date of Birth:", student_data[5] or "N/A"),
            ("Status:", student_data[15])
        ]
        
        for label, value in personal_info:
            tk.Label(scrollable_frame, text=label, font=('Arial', 10, 'bold'), 
                    bg='#ffffff', anchor='w').grid(row=row, column=0, sticky='w', padx=10, pady=2)
            tk.Label(scrollable_frame, text=str(value), font=('Arial', 10), 
                    bg='#ffffff', anchor='w').grid(row=row, column=1, sticky='w', padx=10, pady=2)
            row += 1
        
        # Academic Information Section
        tk.Label(scrollable_frame, text="ACADEMIC INFORMATION", 
                font=('Arial', 14, 'bold'), bg='#27ae60', fg='white', relief=tk.RAISED).grid(
                row=row, column=0, columnspan=2, sticky='ew', padx=10, pady=(20, 10))
        row += 1
        
        academic_info = [
            ("Current Class:", student_data[3]),
            ("Date of Admission:", student_data[6])
        ]
        
        for label, value in academic_info:
            tk.Label(scrollable_frame, text=label, font=('Arial', 10, 'bold'), 
                    bg='#ffffff', anchor='w').grid(row=row, column=0, sticky='w', padx=10, pady=2)
            tk.Label(scrollable_frame, text=str(value), font=('Arial', 10), 
                    bg='#ffffff', anchor='w').grid(row=row, column=1, sticky='w', padx=10, pady=2)
            row += 1
        
        # Parent Information Section
        tk.Label(scrollable_frame, text="PARENT/GUARDIAN INFORMATION", 
                font=('Arial', 14, 'bold'), bg='#f39c12', fg='white', relief=tk.RAISED).grid(
                row=row, column=0, columnspan=2, sticky='ew', padx=10, pady=(20, 10))
        row += 1
        
        parent_info = [
            ("Father's Name:", student_data[7] or "N/A"),
            ("Mother's Name:", student_data[8] or "N/A"),
            ("Phone Number:", student_data[9] or "N/A"),
            ("Address:", student_data[10] or "N/A")
        ]
        
        for label, value in parent_info:
            tk.Label(scrollable_frame, text=label, font=('Arial', 10, 'bold'), 
                    bg='#ffffff', anchor='w').grid(row=row, column=0, sticky='w', padx=10, pady=2)
            tk.Label(scrollable_frame, text=str(value), font=('Arial', 10), 
                    bg='#ffffff', anchor='w').grid(row=row, column=1, sticky='w', padx=10, pady=2)
            row += 1
        
        # Fee Information Section
        tk.Label(scrollable_frame, text="FEE INFORMATION", 
                font=('Arial', 14, 'bold'), bg='#e74c3c', fg='white', relief=tk.RAISED).grid(
                row=row, column=0, columnspan=2, sticky='ew', padx=10, pady=(20, 10))
        row += 1
        
        feeding_status = "Yes" if student_data[14] else "No"
        fee_info = [
            ("Transportation:", student_data[11]),
            ("Bus Fee (GHS):", f"{student_data[12]:.2f}" if student_data[12] else "0.00"),
            ("Monthly Fee (GHS):", f"{student_data[13]:.2f}" if student_data[13] else "0.00"),
            ("Feeding Fee Paid:", feeding_status)
        ]
        
        for label, value in fee_info:
            tk.Label(scrollable_frame, text=label, font=('Arial', 10, 'bold'), 
                    bg='#ffffff', anchor='w').grid(row=row, column=0, sticky='w', padx=10, pady=2)
            tk.Label(scrollable_frame, text=str(value), font=('Arial', 10), 
                    bg='#ffffff', anchor='w').grid(row=row, column=1, sticky='w', padx=10, pady=2)
            row += 1
        
        # Configure grid weights
        scrollable_frame.grid_columnconfigure(0, weight=1)
        scrollable_frame.grid_columnconfigure(1, weight=2)
        
        # Buttons frame - Fixed at bottom
        button_frame = tk.Frame(detail_window, bg='#f0f8ff')
        button_frame.pack(fill=tk.X, side=tk.BOTTOM, padx=20, pady=10)
        
        # Export to PDF button
        pdf_button = tk.Button(button_frame, text="Export to PDF", 
                              command=lambda: self.export_student_pdf_simple(student_data),
                              bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),
                              width=15, height=2)
        pdf_button.pack(side=tk.LEFT, padx=5)
        
        # Close button
        close_button = tk.Button(button_frame, text="Close", 
                               command=detail_window.destroy,
                               bg='#7f8c8d', fg='white', font=('Arial', 12),
                               width=10, height=2)
        close_button.pack(side=tk.RIGHT, padx=5)

    def export_student_pdf(self, student_data):
        """Export student information to PDF"""
        if not PDF_AVAILABLE:
            messagebox.showwarning("PDF Not Available", 
                                  "PDF export requires the reportlab library.\n\n"
                                  "Please install it using: pip install reportlab")
            return
        
        # For now, use the simplified version
        self.export_student_pdf_simple(student_data)

    def export_student_pdf_simple(self, student_data):
        """Simplified PDF export function with better error handling"""
        try:
            from reportlab.lib.pagesizes import A4
            from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
            from reportlab.lib.styles import getSampleStyleSheet
            from reportlab.lib.units import inch
            from reportlab.lib import colors
            
            # Get save location
            filename = filedialog.asksaveasfilename(
                defaultextension=".pdf",
                filetypes=[("PDF files", "*.pdf")],
                title="Save Student Report As",
                initialfile=f"Student_Report_{student_data[2].replace(' ', '_')}.pdf"
            )
            
            if not filename:
                return
            
            # Create simple PDF document
            doc = SimpleDocTemplate(filename, pagesize=A4)
            story = []
            styles = getSampleStyleSheet()
            
            # Title
            story.append(Paragraph("STUDENT INFORMATION RECORD", styles['Title']))
            story.append(Spacer(1, 20))
            
            # Student Information
            story.append(Paragraph("Student Details", styles['Heading2']))
            
            # Create simple table with student data
            data = [
                ['Field', 'Value'],
                ['Student ID', student_data[1] or "N/A"],
                ['Full Name', student_data[2]],
                ['Gender', student_data[4]],
                ['Current Status', student_data[15]]
            ]
            
            table = Table(data, colWidths=[2*inch, 4*inch])
            table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 12),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
                ('GRID', (0, 0), (-1, -1), 1, colors.black)
            ]))
            
            story.append(table)
            
            # Build PDF
            doc.build(story)
            messagebox.showinfo("Success", f"Student report saved successfully!\n\nFile: {filename}")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate PDF: {str(e)}")

    def browse_student_document(self):
        """Browse and select document file for student"""
        filetypes = (
            ('PDF files', '*.pdf'),
            ('Word documents', '*.doc *.docx'),
            ('Image files', '*.jpg *.jpeg *.png *.gif'),
            ('All files', '*.*')
        )
        
        filename = filedialog.askopenfilename(
            title='Select Student Document',
            initialdir='/',
            filetypes=filetypes
        )
        
        if filename:
            # Create documents directory if it doesn't exist
            docs_dir = os.path.join(os.path.dirname(__file__), 'student_documents')
            if not os.path.exists(docs_dir):
                os.makedirs(docs_dir)
            
            # Copy file to documents directory with unique name
            file_extension = os.path.splitext(filename)[1]
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            new_filename = f"student_doc_{timestamp}{file_extension}"
            new_path = os.path.join(docs_dir, new_filename)
            
            try:
                shutil.copy2(filename, new_path)
                self.student_file_path_var.set(new_path)
                
                # Update file info display
                file_size = os.path.getsize(new_path)
                size_mb = file_size / (1024 * 1024)
                file_info = f"✓ {os.path.basename(filename)} ({size_mb:.2f} MB)"
                self.student_file_info.configure(text=file_info, fg='#27ae60')
                
            except Exception as e:
                messagebox.showerror("Error", f"Failed to copy file: {str(e)}")
                self.student_file_path_var.set("")
                self.student_file_info.configure(text="Error uploading file", fg='#e74c3c')
    
    def auto_generate_student_id(self):
        """Auto-generate student ID and populate the field"""
        try:
            # Get year of admission if date is set
            year = None
            try:
                admission_date = self.date_of_admission.get_date()
                year = admission_date.year
            except:
                pass
            
            # Generate new ID
            new_id = self.generate_student_id(year)
            
            # Update the field (temporarily enable it)
            self.student_id.config(state='normal')
            self.student_id.delete(0, tk.END)
            self.student_id.insert(0, new_id)
            self.student_id.config(state='readonly')
            
            messagebox.showinfo("ID Generated", f"New Student ID: {new_id}")
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate ID: {str(e)}")

    def add_student(self):
        # Check permissions
        if not self.check_permission_or_show_error('students', 'Add Student'):
            return
            
        # Get all form values
        student_id = self.student_id.get().strip()
        name = self.student_name.get()
        
        # Handle DateEntry widgets
        date_of_birth = self.date_of_birth.get_date().strftime('%Y-%m-%d')
            
        gender = self.gender.get()
        
        date_of_admission = self.date_of_admission.get_date().strftime('%Y-%m-%d')
            
        current_class_name = self.current_class.get()
        father_name = self.father_name.get()
        mother_name = self.mother_name.get()
        phone = self.phone.get()
        address = self.address_text.get('1.0', 'end-1c').strip()
        transportation = self.transportation.get()
        bus_fee = float(self.bus_fee.get()) if self.bus_fee.get() else 0.0
        monthly_fee = float(self.monthly_fee.get()) if self.monthly_fee.get() else 0.0
        feeding_fee_paid = 1 if self.feeding_fee_paid.get() else 0
        student_status = self.student_status.get()
        
        if not name or not date_of_admission or not current_class_name:
            messagebox.showerror("Error", "Please fill in all required fields (*)")
            return
        
        # Auto-generate Student ID if empty
        if not student_id:
            try:
                year = self.date_of_admission.get_date().year
                student_id = self.generate_student_id(year)
                
                # Update the display
                self.student_id.config(state='normal')
                self.student_id.delete(0, tk.END)
                self.student_id.insert(0, student_id)
                self.student_id.config(state='readonly')
            except Exception as e:
                messagebox.showerror("Error", f"Failed to generate Student ID: {str(e)}")
                return
        
        # Get class ID
        class_id = self.class_dict.get(current_class_name)
        if not class_id:
            messagebox.showerror("Error", "Invalid class selected")
            return
        
        try:
            self.cursor.execute('''
                INSERT INTO students (
                    student_id, name, date_of_birth, gender, date_of_admission, 
                    class_id, father_name, mother_name, phone, address,
                    transportation, bus_fee, monthly_fee, feeding_fee_paid, status
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                student_id, name, date_of_birth, gender, date_of_admission,
                class_id, father_name, mother_name, phone, address,
                transportation, bus_fee, monthly_fee, feeding_fee_paid, student_status
            ))
            
            # Update class student count
            self.cursor.execute('''
                UPDATE classes SET current_students = current_students + 1 
                WHERE id = ?
            ''', (class_id,))
            
            self.conn.commit()
            messagebox.showinfo("Success", "Student added successfully")
            self.load_students()
            self.clear_student_form()
            self.update_dashboard()
        except Exception as e:
            messagebox.showerror("Error", f"Failed to add student: {str(e)}")
    
    def update_student(self):
        # Check permissions
        if not self.check_permission_or_show_error('students', 'Update Student'):
            return
            
        selected = self.students_tree.selection()
        if not selected:
            messagebox.showerror("Error", "Please select a student to update")
            return
        
        student_db_id = self.students_tree.item(selected[0])['values'][0]
        
        # For teachers, check if student is from their assigned class
        if self.current_user.get('role') == 'teacher':
            self.cursor.execute("SELECT class_id FROM students WHERE id = ?", (student_db_id,))
            student_class_result = self.cursor.fetchone()
            if student_class_result and not self.is_teacher_authorized_for_student(student_class_result[0]):
                messagebox.showerror("Access Denied", "You can only manage students from your assigned class")
                return
        old_class_id = None
        
        # Get old class ID for updating counts
        self.cursor.execute("SELECT class_id FROM students WHERE id = ?", (student_db_id,))
        old_class_result = self.cursor.fetchone()
        if old_class_result:
            old_class_id = old_class_result[0]
        
        # Get all form values
        student_id = self.student_id.get()
        name = self.student_name.get()
        
        # Handle DateEntry widgets
        date_of_birth = self.date_of_birth.get_date().strftime('%Y-%m-%d')
            
        gender = self.gender.get()
        
        date_of_admission = self.date_of_admission.get_date().strftime('%Y-%m-%d')
            
        current_class_name = self.current_class.get()
        father_name = self.father_name.get()
        mother_name = self.mother_name.get()
        phone = self.phone.get()
        address = self.address_text.get('1.0', 'end-1c').strip()
        transportation = self.transportation.get()
        bus_fee = float(self.bus_fee.get()) if self.bus_fee.get() else 0.0
        monthly_fee = float(self.monthly_fee.get()) if self.monthly_fee.get() else 0.0
        feeding_fee_paid = 1 if self.feeding_fee_paid.get() else 0
        student_status = self.student_status.get()
        
        if not name or not date_of_admission or not current_class_name:
            messagebox.showerror("Error", "Please fill in all required fields (*)")
            return
        
        # Get new class ID
        new_class_id = self.class_dict.get(current_class_name)
        if not new_class_id:
            messagebox.showerror("Error", "Invalid class selected")
            return
        
        try:
            self.cursor.execute('''
                UPDATE students SET
                    student_id = ?, name = ?, date_of_birth = ?, gender = ?, 
                    date_of_admission = ?, class_id = ?, father_name = ?, 
                    mother_name = ?, phone = ?, address = ?, transportation = ?,
                    bus_fee = ?, monthly_fee = ?, feeding_fee_paid = ?, status = ?
                WHERE id = ?
            ''', (
                student_id, name, date_of_birth, gender, date_of_admission,
                new_class_id, father_name, mother_name, phone, address,
                transportation, bus_fee, monthly_fee, feeding_fee_paid, student_status, student_db_id
            ))
            
            # Update class student counts if class changed
            if old_class_id and old_class_id != new_class_id:
                self.cursor.execute('''
                    UPDATE classes SET current_students = current_students - 1 
                    WHERE id = ?
                ''', (old_class_id,))
                self.cursor.execute('''
                    UPDATE classes SET current_students = current_students + 1 
                    WHERE id = ?
                ''', (new_class_id,))
            
            self.conn.commit()
            messagebox.showinfo("Success", "Student updated successfully")
            self.load_students()
        except Exception as e:
            messagebox.showerror("Error", f"Failed to update student: {str(e)}")

    def delete_student(self):
        """Delete selected student from database"""
        # Check permissions
        if not self.check_permission_or_show_error('students', 'Delete Student'):
            return
        
        selected = self.students_tree.selection()
        if not selected:
            messagebox.showerror("Error", "Please select a student to delete")
            return
        
        student_db_id = self.students_tree.item(selected[0])['values'][0]
        
        # Get student information for confirmation
        self.cursor.execute('''
            SELECT s.id, s.student_id, s.name, s.class_id, c.class_name
            FROM students s 
            LEFT JOIN classes c ON s.class_id = c.id 
            WHERE s.id = ?
        ''', (student_db_id,))
        
        student_data = self.cursor.fetchone()
        
        if not student_data:
            messagebox.showerror("Error", "Student not found")
            return
        
        # For teachers, check if student is from their assigned class
        if self.current_user.get('role') == 'teacher':
            if student_data[3] and not self.is_teacher_authorized_for_student(student_data[3]):
                messagebox.showerror("Access Denied", "You can only delete students from your assigned class")
                return
        
        # Confirmation dialog with detailed info
        student_id, student_name, class_name = student_data[1], student_data[2], student_data[4]
        
        confirmation = messagebox.askyesno(
            "Confirm Delete",
            f"Are you sure you want to delete this student?\n\n"
            f"Student ID: {student_id}\n"
            f"Name: {student_name}\n"
            f"Class: {class_name or 'Not assigned'}\n\n"
            f"This action cannot be undone!"
        )
        
        if not confirmation:
            return
        
        try:
            # Get class ID for updating counts
            class_id = student_data[3]
            
            # Delete related records first (attendance, grades, fees, etc.)
            self.cursor.execute("DELETE FROM attendance WHERE student_id = ?", (student_db_id,))
            self.cursor.execute("DELETE FROM grades WHERE student_id = ?", (student_db_id,))
            self.cursor.execute("DELETE FROM fees WHERE student_id = ?", (student_db_id,))
            
            # Delete the student
            self.cursor.execute("DELETE FROM students WHERE id = ?", (student_db_id,))
            
            # Update class student count
            if class_id:
                self.cursor.execute('''
                    UPDATE classes SET current_students = current_students - 1 
                    WHERE id = ? AND current_students > 0
                ''', (class_id,))
            
            self.conn.commit()
            messagebox.showinfo("Success", f"Student '{student_name}' has been deleted successfully")
            
            # Reload student list and clear form
            self.load_students()
            self.clear_student_form()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to delete student: {str(e)}")

    def change_student_status(self):
        """Change the status of a selected student"""
        # Check permissions
        if not self.check_permission_or_show_error('students', 'Update Student'):
            return
        
        selected = self.students_tree.selection()
        if not selected:
            messagebox.showerror("Error", "Please select a student to change status")
            return
        
        student_db_id = self.students_tree.item(selected[0])['values'][0]
        
        # Get current student info
        self.cursor.execute('''
            SELECT s.id, s.student_id, s.name, s.status
            FROM students s 
            WHERE s.id = ?
        ''', (student_db_id,))
        
        student_data = self.cursor.fetchone()
        
        if not student_data:
            messagebox.showerror("Error", "Student not found")
            return
        
        # For teachers, check if student is from their assigned class
        if self.current_user.get('role') == 'teacher':
            self.cursor.execute("SELECT class_id FROM students WHERE id = ?", (student_db_id,))
            student_class_result = self.cursor.fetchone()
            if student_class_result and not self.is_teacher_authorized_for_student(student_class_result[0]):
                messagebox.showerror("Access Denied", "You can only manage students from your assigned class")
                return
        
        student_id, student_name, current_status = student_data[1], student_data[2], student_data[3]
        
        # Create status change window
        status_window = tk.Toplevel(self.root)
        status_window.title("Change Student Status")
        status_window.geometry("400x250")
        status_window.resizable(False, False)
        
        # Center window
        status_window.update_idletasks()
        x = (status_window.winfo_screenwidth() // 2) - (400 // 2)
        y = (status_window.winfo_screenheight() // 2) - (250 // 2)
        status_window.geometry(f"+{x}+{y}")
        
        # Header
        header_frame = tk.Frame(status_window, bg='#3498db', height=50)
        header_frame.pack(fill=tk.X)
        
        tk.Label(header_frame, text=f"Change Status: {student_name} ({student_id})", 
                font=('Segoe UI', 12, 'bold'), bg='#3498db', fg='white').pack(pady=10)
        
        # Current status display
        content_frame = tk.Frame(status_window, bg='#f8f9fa')
        content_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        tk.Label(content_frame, text="Current Status:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#2c3e50').pack(anchor=tk.W, pady=(0, 5))
        
        current_status_label = tk.Label(content_frame, text=f"● {current_status}", 
                                       font=('Segoe UI', 11, 'bold'), 
                                       fg='#27ae60' if current_status == 'Active' else '#e74c3c' if current_status == 'Inactive' else '#f39c12',
                                       bg='#f8f9fa')
        current_status_label.pack(anchor=tk.W, pady=(0, 20))
        
        # New status selection
        tk.Label(content_frame, text="Select New Status:", font=('Segoe UI', 11, 'bold'), 
                bg='#f8f9fa', fg='#2c3e50').pack(anchor=tk.W, pady=(0, 10))
        
        new_status_var = tk.StringVar(value=current_status)
        
        status_options = [
            ("✅ Active", "Active", "#27ae60"),
            ("❌ Inactive", "Inactive", "#e74c3c"),
            ("⚠️ Suspended", "Suspended", "#f39c12")
        ]
        
        for text, value, color in status_options:
            rb = tk.Radiobutton(content_frame, text=text, variable=new_status_var, value=value,
                              font=('Segoe UI', 10), bg='#f8f9fa', fg=color, activebackground='#f8f9fa')
            rb.pack(anchor=tk.W, pady=5)
        
        # Buttons frame
        button_frame = tk.Frame(status_window, bg='#ffffff', relief=tk.RAISED, bd=1)
        button_frame.pack(fill=tk.X, side=tk.BOTTOM)
        
        def save_status():
            new_status = new_status_var.get()
            if new_status != current_status:
                try:
                    self.cursor.execute("UPDATE students SET status = ? WHERE id = ?", 
                                       (new_status, student_db_id))
                    self.conn.commit()
                    messagebox.showinfo("Success", f"Student status changed to '{new_status}'")
                    self.load_students()
                    self.clear_student_form()
                    status_window.destroy()
                except Exception as e:
                    messagebox.showerror("Error", f"Failed to update status: {str(e)}")
            else:
                messagebox.showinfo("Info", "Status is already set to this value")
                status_window.destroy()
        
        def cancel():
            status_window.destroy()
        
        save_btn = tk.Button(button_frame, text="✓ Save", command=save_status,
                            font=('Segoe UI', 10, 'bold'), bg='#27ae60', fg='white',
                            relief=tk.FLAT, bd=0, padx=20, pady=8)
        save_btn.pack(side=tk.LEFT, padx=10, pady=10)
        
        cancel_btn = tk.Button(button_frame, text="✕ Cancel", command=cancel,
                              font=('Segoe UI', 10, 'bold'), bg='#95a5a6', fg='white',
                              relief=tk.FLAT, bd=0, padx=20, pady=8)
        cancel_btn.pack(side=tk.LEFT)

    def on_student_select(self, event):
        selected = self.students_tree.selection()
        if selected:
            # Get student ID from selection
            student_db_id = self.students_tree.item(selected[0])['values'][0]
            
            # Fetch complete student data with class name and all fields
            self.cursor.execute('''
                SELECT s.student_id, s.name, s.date_of_birth, s.gender, s.date_of_admission,
                       c.class_name, s.father_name, s.mother_name, s.phone, s.address,
                       s.transportation, s.bus_fee, s.monthly_fee, s.feeding_fee_paid, s.status,
                       s.emergency_contact_name, s.emergency_relationship, s.emergency_phone,
                       s.emergency_alt_phone, s.medical_conditions, s.parent_email
                FROM students s 
                JOIN classes c ON s.class_id = c.id 
                WHERE s.id = ?
            ''', (student_db_id,))
            
            student_data = self.cursor.fetchone()
            
            if student_data:
                # Clear form and populate with student data
                self.clear_student_form()
                
                self.student_id.insert(0, student_data[0] or "")
                self.student_name.insert(0, student_data[1])
                
                # Handle DateEntry for date of birth
                if student_data[2]:
                    try:
                        dob = datetime.strptime(student_data[2], '%Y-%m-%d').date()
                        self.date_of_birth.set_date(dob)
                    except:
                        pass
                
                self.gender.set(student_data[3] or "Male")
                
                # Handle DateEntry for date of admission
                if student_data[4]:
                    try:
                        doa = datetime.strptime(student_data[4], '%Y-%m-%d').date()
                        self.date_of_admission.set_date(doa)
                    except:
                        pass
                
                self.current_class.set(student_data[5])
                self.father_name.insert(0, student_data[6] or "")
                self.mother_name.insert(0, student_data[7] or "")
                self.phone.insert(0, student_data[8] or "")
                self.parent_email.insert(0, student_data[20] or "")
                
                self.address_text.delete('1.0', tk.END)
                self.address_text.insert('1.0', student_data[9] or "")
                self.address_text.config(fg='#2c3e50')
                
                self.transportation.set(student_data[10] or "Walk-in")
                self.bus_fee.delete(0, tk.END)
                self.bus_fee.insert(0, str(student_data[11] or "0.00"))
                self.monthly_fee.delete(0, tk.END)
                self.monthly_fee.insert(0, str(student_data[12] or "0.00"))
                self.feeding_fee_paid.set(student_data[13] or False)
                self.student_status.set(student_data[14] or "Active")
                
                # Load emergency contact information
                self.emergency_contact_name.delete(0, tk.END)
                self.emergency_contact_name.insert(0, student_data[15] or "")
                self.emergency_relationship.set(student_data[16] or "")
                self.emergency_phone.delete(0, tk.END)
                self.emergency_phone.insert(0, student_data[17] or "")
                self.emergency_alt_phone.delete(0, tk.END)
                self.emergency_alt_phone.insert(0, student_data[18] or "")
                
                # Load medical/allergies information
                self.allergies_text.delete('1.0', tk.END)
                if student_data[19]:
                    self.allergies_text.insert('1.0', student_data[19])
                    self.allergies_text.config(fg='#2c3e50')
                else:
                    self.allergies_text.insert('1.0', "List any known allergies, medications, or medical conditions (e.g., asthma, diabetes, food allergies, medications being taken...)")
                    self.allergies_text.config(fg='#95a5a6')
    
    def on_student_double_click(self, event):
        """Handle double-click on student to open dedicated edit window"""
        selected = self.students_tree.selection()
        if selected:
            # Get student ID from selection
            student_db_id = self.students_tree.item(selected[0])['values'][0]
            
            # Open student edit window
            self.open_student_edit_window(student_db_id)
    
    def open_student_edit_window(self, student_db_id):
        """Open a dedicated window for editing student details"""
        try:
            # Fetch student data
            self.cursor.execute('''
                SELECT s.id, s.student_id, s.name, s.date_of_birth, s.gender, s.date_of_admission,
                       c.class_name, s.class_id, s.father_name, s.mother_name, s.phone, s.address,
                       s.transportation, s.bus_fee, s.monthly_fee, s.feeding_fee_paid, s.status,
                       s.emergency_contact_name, s.emergency_relationship, s.emergency_phone,
                       s.emergency_alt_phone, s.medical_allergies, s.parent_email
                FROM students s 
                LEFT JOIN classes c ON s.class_id = c.id 
                WHERE s.id = ?
            ''', (student_db_id,))
            
            student_data = self.cursor.fetchone()
            if not student_data:
                messagebox.showerror("Error", "Student not found")
                return
            
            # Create edit window
            edit_window = tk.Toplevel(self.root)
            edit_window.title(f"Edit Student - {student_data[2]}")
            edit_window.geometry("900x750")
            edit_window.configure(bg='#f8f9fa')
            
            # Make window modal
            edit_window.transient(self.root)
            edit_window.grab_set()
            
            # Header
            header = tk.Frame(edit_window, bg='#2c3e50', height=60)
            header.pack(fill=tk.X)
            header.pack_propagate(False)
            
            header_content = tk.Frame(header, bg='#2c3e50')
            header_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)
            
            tk.Label(header_content, text=f"✏️ Edit Student: {student_data[2]}", 
                    font=('Segoe UI', 16, 'bold'), fg='white', bg='#2c3e50').pack(anchor='w')
            tk.Label(header_content, text=f"ID: {student_data[1]}", 
                    font=('Segoe UI', 10), fg='#bdc3c7', bg='#2c3e50').pack(anchor='w', pady=(2, 0))
            
            # Scrollable content
            scrollable = ScrollableFrame(edit_window, bg='#f8f9fa')
            scrollable.pack(fill=tk.BOTH, expand=True, padx=0, pady=0)
            content = scrollable.get_frame()
            
            # Content frame with padding
            content_inner = tk.Frame(content, bg='#f8f9fa')
            content_inner.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
            
            # Store student ID for later use
            student_edit_vars = {
                'student_id': student_db_id,
                'student_name': tk.StringVar(value=student_data[2] or ""),
                'date_of_birth': tk.StringVar(value=student_data[3] or ""),
                'gender': tk.StringVar(value=student_data[4] or "Male"),
                'date_of_admission': tk.StringVar(value=student_data[5] or ""),
                'class_id': student_data[7],
                'father_name': tk.StringVar(value=student_data[8] or ""),
                'mother_name': tk.StringVar(value=student_data[9] or ""),
                'phone': tk.StringVar(value=student_data[10] or ""),
                'address': tk.StringVar(value=student_data[11] or ""),
                'transportation': tk.StringVar(value=student_data[12] or "Walk-in"),
                'bus_fee': tk.StringVar(value=str(student_data[13] or "0.00")),
                'monthly_fee': tk.StringVar(value=str(student_data[14] or "0.00")),
                'feeding_fee_paid': tk.BooleanVar(value=bool(student_data[15])),
                'status': tk.StringVar(value=student_data[16] or "Active"),
                'emergency_contact_name': tk.StringVar(value=student_data[17] or ""),
                'emergency_relationship': tk.StringVar(value=student_data[18] or ""),
                'emergency_phone': tk.StringVar(value=student_data[19] or ""),
                'emergency_alt_phone': tk.StringVar(value=student_data[20] or ""),
                'allergies': tk.StringVar(value=student_data[21] or ""),
                'parent_email': tk.StringVar(value=student_data[22] or "")
            }
            
            # Create sections
            sections = [
                ("👤 Personal Information", [
                    ("Full Name", 'student_name', 'entry'),
                    ("Date of Birth", 'date_of_birth', 'entry'),
                    ("Gender", 'gender', 'combo', ['Male', 'Female', 'Other']),
                    ("Date of Admission", 'date_of_admission', 'entry'),
                ]),
                ("👨‍👩‍👧 Family Information", [
                    ("Father's Name", 'father_name', 'entry'),
                    ("Mother's Name", 'mother_name', 'entry'),
                    ("Parent Email", 'parent_email', 'entry'),
                    ("Phone", 'phone', 'entry'),
                ]),
                ("🏠 Address & Transportation", [
                    ("Address", 'address', 'text'),
                    ("Transportation", 'transportation', 'combo', ['Walk-in', 'Bus']),
                    ("Bus Fee (₦)", 'bus_fee', 'entry'),
                ]),
                ("💳 Fees", [
                    ("Monthly Fee (₦)", 'monthly_fee', 'entry'),
                    ("Feeding Fee Paid", 'feeding_fee_paid', 'check'),
                ]),
                ("🆘 Emergency Contact", [
                    ("Contact Name", 'emergency_contact_name', 'entry'),
                    ("Relationship", 'emergency_relationship', 'entry'),
                    ("Phone", 'emergency_phone', 'entry'),
                    ("Alt Phone", 'emergency_alt_phone', 'entry'),
                ]),
                ("⚕️ Medical Information", [
                    ("Allergies/Medical Info", 'allergies', 'text'),
                ]),
                ("📊 Status", [
                    ("Student Status", 'status', 'combo', ['Active', 'Inactive']),
                ])
            ]
            
            for section_title, fields in sections:
                section_frame = tk.LabelFrame(content_inner, text=section_title, 
                                             font=('Segoe UI', 11, 'bold'), bg='white',
                                             fg='#2c3e50', relief=tk.RAISED, bd=1)
                section_frame.pack(fill=tk.X, pady=(0, 15))
                
                section_content = tk.Frame(section_frame, bg='white')
                section_content.pack(fill=tk.BOTH, expand=True, padx=12, pady=12)
                
                for field_info in fields:
                    field_name = field_info[0]
                    var_name = field_info[1]
                    field_type = field_info[2]
                    
                    field_frame = tk.Frame(section_content, bg='white')
                    field_frame.pack(fill=tk.X, pady=(0, 10))
                    
                    tk.Label(field_frame, text=field_name, font=('Segoe UI', 10, 'bold'),
                            fg='#34495e', bg='white').pack(anchor='w')
                    
                    if field_type == 'entry':
                        entry = tk.Entry(field_frame, textvariable=student_edit_vars[var_name],
                                       font=('Segoe UI', 10), relief=tk.SOLID, bd=1)
                        entry.pack(anchor='w', fill=tk.X, pady=(3, 0))
                    
                    elif field_type == 'combo':
                        options = field_info[3]
                        combo = ttk.Combobox(field_frame, textvariable=student_edit_vars[var_name],
                                           values=options, font=('Segoe UI', 10), state='readonly')
                        combo.pack(anchor='w', fill=tk.X, pady=(3, 0))
                    
                    elif field_type == 'text':
                        text = tk.Text(field_frame, height=4, width=40, 
                                      font=('Segoe UI', 10), relief=tk.SOLID, bd=1)
                        text.pack(fill=tk.X, pady=(3, 0))
                        text.insert('1.0', student_edit_vars[var_name].get())
                        student_edit_vars[var_name + '_widget'] = text
                    
                    elif field_type == 'check':
                        check = tk.Checkbutton(field_frame, variable=student_edit_vars[var_name],
                                             bg='white', fg='#2c3e50', font=('Segoe UI', 10))
                        check.pack(anchor='w', pady=(3, 0))
            
            # Button frame
            button_frame = tk.Frame(edit_window, bg='#f8f9fa')
            button_frame.pack(fill=tk.X, padx=20, pady=15)
            
            def save_changes():
                """Save changes to student record"""
                try:
                    # Get all field values, including text widgets
                    address_value = student_edit_vars['address'].get()
                    allergies_value = student_edit_vars['allergies'].get()
                    
                    # Check if we have text widgets and get their values
                    if 'address_widget' in student_edit_vars:
                        address_value = student_edit_vars['address_widget'].get('1.0', tk.END).strip()
                    
                    if 'allergies_widget' in student_edit_vars:
                        allergies_value = student_edit_vars['allergies_widget'].get('1.0', tk.END).strip()
                    
                    # Update database with proper error handling
                    try:
                        self.cursor.execute('''
                            UPDATE students SET
                                name = ?, date_of_birth = ?, gender = ?, date_of_admission = ?,
                                father_name = ?, mother_name = ?, phone = ?, address = ?,
                                transportation = ?, bus_fee = ?, monthly_fee = ?, feeding_fee_paid = ?,
                                status = ?, emergency_contact_name = ?, emergency_relationship = ?,
                                emergency_phone = ?, emergency_alt_phone = ?, medical_allergies = ?,
                                parent_email = ?
                            WHERE id = ?
                        ''', (
                            student_edit_vars['student_name'].get(),
                            student_edit_vars['date_of_birth'].get(),
                            student_edit_vars['gender'].get(),
                            student_edit_vars['date_of_admission'].get(),
                            student_edit_vars['father_name'].get(),
                            student_edit_vars['mother_name'].get(),
                            student_edit_vars['phone'].get(),
                            address_value,
                            student_edit_vars['transportation'].get(),
                            float(student_edit_vars['bus_fee'].get() or 0),
                            float(student_edit_vars['monthly_fee'].get() or 0),
                            1 if student_edit_vars['feeding_fee_paid'].get() else 0,
                            student_edit_vars['status'].get(),
                            student_edit_vars['emergency_contact_name'].get(),
                            student_edit_vars['emergency_relationship'].get(),
                            student_edit_vars['emergency_phone'].get(),
                            student_edit_vars['emergency_alt_phone'].get(),
                            allergies_value,
                            student_edit_vars['parent_email'].get(),
                            student_edit_vars['student_id']
                        ))
                        
                        self.connection.commit()
                        messagebox.showinfo("Success", "Student information updated successfully!")
                        self.load_students()
                        edit_window.destroy()
                    except Exception as db_error:
                        self.connection.rollback()
                        messagebox.showerror("Database Error", f"Failed to update database: {str(db_error)}")
                    
                except Exception as e:
                    messagebox.showerror("Error", f"Failed to save changes: {str(e)}")
            
            save_btn = tk.Button(button_frame, text="💾 Save Changes", command=save_changes,
                               font=('Segoe UI', 11, 'bold'), bg='#27ae60', fg='white',
                               relief=tk.FLAT, bd=0, padx=20, pady=10, cursor='hand2')
            save_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            close_btn = tk.Button(button_frame, text="❌ Cancel", command=edit_window.destroy,
                                font=('Segoe UI', 11, 'bold'), bg='#e74c3c', fg='white',
                                relief=tk.FLAT, bd=0, padx=20, pady=10, cursor='hand2')
            close_btn.pack(side=tk.LEFT)
            
            # Center window on parent
            edit_window.update_idletasks()
            x = self.root.winfo_x() + (self.root.winfo_width() - edit_window.winfo_width()) // 2
            y = self.root.winfo_y() + (self.root.winfo_height() - edit_window.winfo_height()) // 2
            edit_window.geometry(f"+{x}+{y}")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to open edit window: {str(e)}")
    
    def clear_student_form(self):
        # Clear student ID (need to temporarily enable it since it's readonly)
        self.student_id.config(state='normal')
        self.student_id.delete(0, tk.END)
        self.student_id.config(state='readonly')
        
        self.student_name.delete(0, tk.END)
        
        # Handle DateEntry for date of birth
        self.date_of_birth.set_date(datetime(2010, 1, 1).date())
            
        self.gender.set("Male")
        
        # Handle DateEntry for date of admission
        self.date_of_admission.set_date(date.today())
        
        self.current_class.set('')
        self.father_name.delete(0, tk.END)
        self.mother_name.delete(0, tk.END)
        self.phone.delete(0, tk.END)
        self.parent_email.delete(0, tk.END)
        
        self.address_text.delete('1.0', tk.END)
        self.address_text.insert('1.0', "Enter complete home address including street, city, region...")
        self.address_text.config(fg='#95a5a6')
        
        self.transportation.set("Walk-in")
        self.bus_fee.delete(0, tk.END)
        self.bus_fee.insert(0, "0.00")
        self.monthly_fee.delete(0, tk.END)
        self.monthly_fee.insert(0, "0.00")
        self.feeding_fee_paid.set(False)
        self.student_status.set("Active")
        
        # Clear emergency contact information
        self.emergency_contact_name.delete(0, tk.END)
        self.emergency_relationship.set('')
        self.emergency_phone.delete(0, tk.END)
        self.emergency_alt_phone.delete(0, tk.END)
        
        # Clear medical/allergies information
        self.allergies_text.delete('1.0', tk.END)
        self.allergies_text.insert('1.0', "List any known allergies, medications, or medical conditions (e.g., asthma, diabetes, food allergies, medications being taken...)")
        self.allergies_text.config(fg='#95a5a6')
        
        # Clear document upload
        self.student_file_path_var.set('')
        self.student_file_info.config(text="📊 No file selected")
    
    def update_student_statistics(self):
        """Update the student statistics display in real-time"""
        try:
            # Calculate total students
            self.cursor.execute("SELECT COUNT(*) FROM students")
            total_students = self.cursor.fetchone()[0]
            
            # Calculate active classes
            self.cursor.execute("SELECT COUNT(DISTINCT class_id) FROM students WHERE class_id IS NOT NULL")
            active_classes = self.cursor.fetchone()[0]
            
            # Update labels if they exist
            if hasattr(self, 'total_students_stat'):
                self.total_students_stat.config(text=f"Total Students: {total_students}")
                self.active_classes_stat.config(text=f"Active Classes: {active_classes}")
                
        except Exception as e:
            print(f"Error updating student statistics: {e}")
    
    def load_students(self):
        try:
            # Clear existing data
            for item in self.students_tree.get_children():
                self.students_tree.delete(item)
            
            # Get class filter value
            class_filter = getattr(self, 'student_class_filter_var', None)
            selected_class = class_filter.get() if class_filter else "All Classes"
            
            # Build query based on user role and class filter
            if self.current_user.get('role') == 'admin':
                # Admin sees all students or filtered by class
                if selected_class != "All Classes":
                    query = '''
                        SELECT s.id, s.student_id, s.name, c.class_name, s.gender, 
                               s.date_of_admission, s.phone, s.status, s.class_id, s.monthly_fee
                        FROM students s 
                        LEFT JOIN classes c ON s.class_id = c.id
                        WHERE c.class_name = ?
                        ORDER BY s.name
                    '''
                    params = (selected_class,)
                else:
                    query = '''
                        SELECT s.id, s.student_id, s.name, c.class_name, s.gender, 
                               s.date_of_admission, s.phone, s.status, s.class_id, s.monthly_fee
                        FROM students s 
                        LEFT JOIN classes c ON s.class_id = c.id
                        ORDER BY s.name
                    '''
                    params = ()
            elif self.current_user.get('role') == 'teacher':
                # Teacher sees only students from their assigned class
                teacher_class_id = self.get_teacher_assigned_class()
                if teacher_class_id:
                    query = '''
                        SELECT s.id, s.student_id, s.name, c.class_name, s.gender, 
                               s.date_of_admission, s.phone, s.status, s.class_id, s.monthly_fee
                        FROM students s 
                        LEFT JOIN classes c ON s.class_id = c.id
                        WHERE s.class_id = ?
                        ORDER BY s.name
                    '''
                    params = (teacher_class_id,)
                else:
                    # Teacher not assigned to any class
                    self.students_tree.insert('', tk.END, values=("", "", "No students assigned", "", "", "", "", ""))
                    return
            else:
                # Staff and other roles see limited student info (with optional class filter)
                if selected_class != "All Classes":
                    query = '''
                        SELECT s.id, s.student_id, s.name, c.class_name, s.gender, 
                               s.date_of_admission, s.phone, s.status, s.class_id, s.monthly_fee
                        FROM students s 
                        LEFT JOIN classes c ON s.class_id = c.id
                        WHERE c.class_name = ?
                        ORDER BY s.name
                    '''
                    params = (selected_class,)
                else:
                    query = '''
                        SELECT s.id, s.student_id, s.name, c.class_name, s.gender, 
                               s.date_of_admission, s.phone, s.status, s.class_id, s.monthly_fee
                        FROM students s 
                        LEFT JOIN classes c ON s.class_id = c.id
                        ORDER BY s.name
                    '''
                    params = ()
            
            # Load students from database
            self.cursor.execute(query, params)
            students = self.cursor.fetchall()
            
            for student in students:
                # Check if student is on scholarship (monthly_fee = 0 or None)
                monthly_fee = student[9] if len(student) > 9 else None
                
                # Convert to float for comparison, handle various types
                try:
                    if monthly_fee is None:
                        is_scholarship = True
                    else:
                        monthly_fee_float = float(monthly_fee) if monthly_fee else 0.0
                        is_scholarship = monthly_fee_float == 0.0
                except (ValueError, TypeError):
                    is_scholarship = False
                
                scholarship_indicator = "🎓 SCHOLARSHIP" if is_scholarship else ""
                
                # Format the data for display
                formatted_student = (
                    student[0],  # ID
                    student[1] or "N/A",  # Student ID
                    f"{student[2]} {scholarship_indicator}".strip(),  # Name with scholarship indicator
                    student[3] or "No Class",  # Class name
                    student[4],  # Gender
                    student[5],  # Admission date
                    student[6] or "N/A",  # Phone
                    "✅ Active" if student[7] == "Active" else "❌ Inactive"  # Status with icons
                )
                self.students_tree.insert('', tk.END, values=formatted_student)
            
            # Update statistics after loading
            self.update_student_statistics()
            
        except Exception as e:
            print(f"Error loading students: {e}")
            import traceback
            traceback.print_exc()
    
    def load_promotions(self):
        # Clear existing data
        for item in self.promotions_tree.get_children():
            self.promotions_tree.delete(item)
        
        # Load promotions from database with class names
        self.cursor.execute('''
            SELECT p.id, s.name, fc.class_name, tc.class_name, p.promotion_date, p.academic_year
            FROM promotions p
            JOIN students s ON p.student_id = s.id
            JOIN classes fc ON p.from_class_id = fc.id
            JOIN classes tc ON p.to_class_id = tc.id
            ORDER BY p.promotion_date DESC
        ''')
        promotions = self.cursor.fetchall()
        
        for promo in promotions:
            self.promotions_tree.insert('', tk.END, values=promo)

    def clear_content_frame(self):
        for widget in self.content_frame.winfo_children():
            widget.destroy()

    # --- Full implementations for Class Management, Teacher Management, Attendance, Database View ---
    def show_class_management(self):
        self.clear_content_frame()
        
        # Create main container with gradient background
        main_container = tk.Frame(self.content_frame, bg='#f8f9fa')
        main_container.pack(fill=tk.BOTH, expand=True)
        
        # Create scrollable frame for class management
        scrollable_class = ScrollableFrame(main_container, bg='#f8f9fa')
        scrollable_class.pack(fill=tk.BOTH, expand=True)
        class_main_frame = scrollable_class.get_frame()
        
        # Hero Header Section with Modern Design
        hero_section = tk.Frame(class_main_frame, bg='#ffffff', relief=tk.FLAT, bd=0)
        hero_section.pack(fill=tk.X, padx=0, pady=0)
        
        # Gradient-like header background
        header_bg = tk.Frame(hero_section, bg='#3498db', relief=tk.FLAT, bd=0)
        header_bg.pack(fill=tk.X)
        
        header_content = tk.Frame(header_bg, bg='#3498db')
        header_content.pack(fill=tk.X, padx=40, pady=30)
        
        # Main title with icon
        title_frame = tk.Frame(header_content, bg='#3498db')
        title_frame.pack(fill=tk.X)
        
        icon_label = tk.Label(title_frame, text="📚", font=('Segoe UI', 40), bg='#3498db', fg='white')
        icon_label.pack(side=tk.LEFT, padx=(0, 15))
        
        title_text_frame = tk.Frame(title_frame, bg='#3498db')
        title_text_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        title = tk.Label(title_text_frame, text="🏫 Class Management Center",
                         font=('Segoe UI', 32, 'bold'), fg='white', bg='#3498db')
        title.pack(anchor=tk.W)
        
        subtitle = tk.Label(title_text_frame, text="Comprehensive classroom organization and teacher management",
                           font=('Segoe UI', 14), fg='#ecf0f1', bg='#3498db')
        subtitle.pack(anchor=tk.W, pady=(5, 0))

        # Quick Stats Dashboard - Modern Card Layout
        stats_dashboard = tk.Frame(class_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        stats_dashboard.pack(fill=tk.X, padx=30, pady=(25, 30))
        
        stats_title_frame = tk.Frame(stats_dashboard, bg='#f8f9fa')
        stats_title_frame.pack(fill=tk.X, pady=(0, 20))
        
        stats_title = tk.Label(stats_title_frame, text="📊 Quick Overview", 
                              font=('Segoe UI', 20, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        stats_title.pack(anchor=tk.W)
        
        # Stats cards container
        stats_cards_container = tk.Frame(stats_dashboard, bg='#f8f9fa')
        stats_cards_container.pack(fill=tk.X)
        
        # Individual stat cards with modern design
        self.total_classes_card = self.create_stat_dashboard_card(stats_cards_container, "📚", "Total Classes", "0", '#8e44ad')
        self.total_classes_card.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 15))
        
        self.total_capacity_card = self.create_stat_dashboard_card(stats_cards_container, "👥", "Total Capacity", "0", '#16a085')
        self.total_capacity_card.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 15))
        
        self.enrollment_card = self.create_stat_dashboard_card(stats_cards_container, "📊", "Enrollment", "0", '#e67e22')
        self.enrollment_card.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        # Update statistics
        self.update_class_statistics()

        # Main Content Area with Side-by-Side Layout
        content_area = tk.Frame(class_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        content_area.pack(fill=tk.BOTH, expand=True, padx=30, pady=(0, 30))
        
        # Left Panel: Class Form (20% width)
        left_panel = tk.Frame(content_area, bg='#ffffff', relief=tk.FLAT, bd=0)
        left_panel.pack(side=tk.LEFT, fill=tk.BOTH, expand=False, padx=(0, 15))
        left_panel.config(width=250)  # Fixed width for form panel
        
        # Form container with modern styling
        form_container = tk.Frame(left_panel, bg='#ffffff', relief=tk.FLAT, bd=0)
        form_container.pack(fill=tk.BOTH, expand=True)
        
        # Add subtle shadow effect to form container
        form_shadow = tk.Frame(form_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        form_shadow.pack(fill=tk.BOTH, expand=True, padx=(2, 0), pady=(2, 0))
        
        form_content_wrapper = tk.Frame(form_shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        form_content_wrapper.pack(fill=tk.BOTH, expand=True, padx=(0, 2), pady=(0, 2))
        
        # Modern form header
        form_header = tk.Frame(form_content_wrapper, bg='#2ecc71', relief=tk.FLAT, bd=0)
        form_header.pack(fill=tk.X)
        
        form_header_content = tk.Frame(form_header, bg='#2ecc71')
        form_header_content.pack(fill=tk.X, padx=15, pady=15)
        
        form_title = tk.Label(form_header_content, text="📝 Form",
                             font=('Segoe UI', 14, 'bold'), fg='white', bg='#2ecc71')
        form_title.pack(anchor=tk.W)
        
        form_subtitle = tk.Label(form_header_content, text="Add/Edit Classes",
                                font=('Segoe UI', 9), fg='#d5f4e6', bg='#2ecc71')
        form_subtitle.pack(anchor=tk.W, pady=(3, 0))
        
        # Scrollable form content
        form_scroll_container = ScrollableFrame(form_content_wrapper, bg='#ffffff')
        form_scroll_container.pack(fill=tk.BOTH, expand=True)
        form_content = form_scroll_container.get_frame()
        
        # Form fields with modern styling
        fields_container = tk.Frame(form_content, bg='#ffffff')
        fields_container.pack(fill=tk.BOTH, expand=True)
        
        # Class Name Field
        name_section = tk.Frame(fields_container, bg='#ffffff')
        name_section.pack(fill=tk.X, pady=(15, 10), padx=15)
        
        name_label = tk.Label(name_section, text="📝 Class Name", 
                             font=('Segoe UI', 10, 'bold'), bg='#ffffff', fg='#2c3e50')
        name_label.pack(anchor=tk.W, pady=(0, 3))
        
        name_desc = tk.Label(name_section, text="e.g., Grade 1A", 
                            font=('Segoe UI', 8), bg='#ffffff', fg='#7f8c8d')
        name_desc.pack(anchor=tk.W, pady=(0, 5))
        
        self.class_name_entry = tk.Entry(name_section, font=('Segoe UI', 10), relief=tk.FLAT, bd=1,
                                        bg='#f8f9fa', fg='#2c3e50', insertbackground='#3498db')
        self.class_name_entry.pack(fill=tk.X, ipady=6)
        self.class_name_entry.config(highlightthickness=1, highlightcolor='#3498db')
        
        # Capacity Field
        capacity_section = tk.Frame(fields_container, bg='#ffffff')
        capacity_section.pack(fill=tk.X, pady=(0, 10), padx=15)
        
        capacity_label = tk.Label(capacity_section, text="👥 Capacity", 
                                 font=('Segoe UI', 10, 'bold'), bg='#ffffff', fg='#2c3e50')
        capacity_label.pack(anchor=tk.W, pady=(0, 3))
        
        capacity_desc = tk.Label(capacity_section, text="Max students", 
                                font=('Segoe UI', 8), bg='#ffffff', fg='#7f8c8d')
        capacity_desc.pack(anchor=tk.W, pady=(0, 5))
        
        self.class_capacity_entry = tk.Entry(capacity_section, font=('Segoe UI', 10), relief=tk.FLAT, bd=1,
                                           bg='#f8f9fa', fg='#2c3e50', insertbackground='#3498db')
        self.class_capacity_entry.pack(fill=tk.X, ipady=6)
        self.class_capacity_entry.config(highlightthickness=1, highlightcolor='#3498db')
        self.class_capacity_entry.insert(0, "30")
        
        # Teacher Assignment Field
        teacher_section = tk.Frame(fields_container, bg='#ffffff')
        teacher_section.pack(fill=tk.X, pady=(0, 15), padx=15)
        
        teacher_label = tk.Label(teacher_section, text="👨‍📚 Teacher", 
                                font=('Segoe UI', 10, 'bold'), bg='#ffffff', fg='#2c3e50')
        teacher_label.pack(anchor=tk.W, pady=(0, 3))
        
        teacher_desc = tk.Label(teacher_section, text="Assign teacher", 
                               font=('Segoe UI', 8), bg='#ffffff', fg='#7f8c8d')
        teacher_desc.pack(anchor=tk.W, pady=(0, 5))
        
        # Get teachers data
        self.cursor.execute("SELECT id, name FROM teachers")
        teachers = self.cursor.fetchall()
        teacher_names = ["None"] + [t[1] for t in teachers]
        self.class_teacher_var = tk.StringVar()
        
        teacher_combo_frame = tk.Frame(teacher_section, bg='#f8f9fa', relief=tk.FLAT, bd=1)
        teacher_combo_frame.pack(fill=tk.X, ipady=2)
        teacher_combo_frame.config(highlightthickness=1, highlightcolor='#3498db')
        
        self.class_teacher_cb = ttk.Combobox(teacher_combo_frame, textvariable=self.class_teacher_var, 
                                           values=teacher_names, state="readonly", font=('Segoe UI', 9))
        self.class_teacher_cb.pack(fill=tk.X, padx=5, pady=3)

        # Action Buttons with Compact Styling
        buttons_frame = tk.Frame(fields_container, bg='#ffffff')
        buttons_frame.pack(fill=tk.X, pady=(5, 15), padx=15)
        
        # Add button
        add_btn = self.create_enhanced_form_button(buttons_frame, "➕ Add", 
                                                  self.add_class, '#27ae60', '#2ecc71')
        add_btn.pack(fill=tk.X, pady=(0, 5))
        
        # Update and Delete buttons side by side
        button_row = tk.Frame(buttons_frame, bg='#ffffff')
        button_row.pack(fill=tk.X, pady=(0, 5))
        
        update_btn = self.create_enhanced_form_button(button_row, "🔄 Update", 
                                                     self.update_class, '#2980b9', '#3498db')
        update_btn.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 3))
        
        delete_btn = self.create_enhanced_form_button(button_row, "🧹 Delete", 
                                                     self.delete_class, '#c0392b', '#e74c3c')
        delete_btn.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(3, 0))
        
        # Clear form button
        clear_btn = self.create_enhanced_form_button(buttons_frame, "🔄 Clear", 
                                                    self.clear_class_form, '#7f8c8d', '#95a5a6')
        clear_btn.pack(fill=tk.X)

        # Right Panel: Classes Directory (80% width)
        right_panel = tk.Frame(content_area, bg='#ffffff', relief=tk.FLAT, bd=0)
        right_panel.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        
        # Add subtle shadow effect
        right_shadow = tk.Frame(right_panel, bg='#dee2e6', relief=tk.FLAT, bd=0)
        right_shadow.pack(fill=tk.BOTH, expand=True, padx=(3, 0), pady=(3, 0))
        
        right_content = tk.Frame(right_shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        right_content.pack(fill=tk.BOTH, expand=True, padx=(0, 3), pady=(0, 3))
        
        # List header
        list_header = tk.Frame(right_content, bg='#9b59b6', relief=tk.FLAT, bd=0)
        list_header.pack(fill=tk.X)
        
        list_header_content = tk.Frame(list_header, bg='#9b59b6')
        list_header_content.pack(fill=tk.X, padx=25, pady=20)
        
        list_title = tk.Label(list_header_content, text="📚 Classes Directory",
                             font=('Segoe UI', 18, 'bold'), fg='white', bg='#9b59b6')
        list_title.pack(anchor=tk.W)
        
        list_subtitle = tk.Label(list_header_content, text="View and manage all class records",
                                font=('Segoe UI', 11), fg='#e8d5f0', bg='#9b59b6')
        list_subtitle.pack(anchor=tk.W, pady=(5, 0))
        
        # Enhanced treeview with better styling
        tree_container = tk.Frame(right_content, bg='#ffffff')
        tree_container.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)

        cols = ('ID', 'Class Name', 'Teacher', 'Capacity', 'Enrolled', 'Usage %', 'Status')
        self.classes_tree = ttk.Treeview(tree_container, columns=cols, show='headings', height=15)
        
        # Configure columns with better spacing
        column_config = {
            'ID': {'width': 50, 'anchor': 'center'},
            'Class Name': {'width': 120, 'anchor': 'w'},
            'Teacher': {'width': 140, 'anchor': 'w'},
            'Capacity': {'width': 70, 'anchor': 'center'},
            'Enrolled': {'width': 70, 'anchor': 'center'},
            'Usage %': {'width': 80, 'anchor': 'center'},
            'Status': {'width': 100, 'anchor': 'center'}
        }
        
        for col, config in column_config.items():
            self.classes_tree.heading(col, text=col, anchor='center')
            self.classes_tree.column(col, width=config['width'], anchor=config['anchor'])
        
        # Scrollbars
        tree_scroll_y = ttk.Scrollbar(tree_container, orient=tk.VERTICAL, command=self.classes_tree.yview)
        tree_scroll_x = ttk.Scrollbar(tree_container, orient=tk.HORIZONTAL, command=self.classes_tree.xview)
        self.classes_tree.configure(yscrollcommand=tree_scroll_y.set, xscrollcommand=tree_scroll_x.set)
        
        # Pack tree and scrollbars
        self.classes_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        tree_scroll_y.pack(side=tk.RIGHT, fill=tk.Y)
        tree_scroll_x.pack(side=tk.BOTTOM, fill=tk.X)
        
        # Bind selection event
        self.classes_tree.bind('<<TreeviewSelect>>', self.on_class_select)
        
        # Enable mouse wheel scrolling
        self.bind_treeview_mousewheel(self.classes_tree)

        # Load classes data
        self.load_classes()

    def update_class_statistics(self):
        """Update the class statistics display in real-time"""
        try:
            # Calculate total classes
            self.cursor.execute("SELECT COUNT(*) FROM classes")
            total_classes = self.cursor.fetchone()[0]
            
            # Calculate total capacity
            self.cursor.execute("SELECT SUM(capacity) FROM classes")
            result = self.cursor.fetchone()[0]
            total_capacity = result if result else 0
            
            # Calculate current enrollment
            self.cursor.execute("SELECT COUNT(*) FROM students WHERE class_id IS NOT NULL")
            current_enrollment = self.cursor.fetchone()[0]
            
            # Update new dashboard cards if they exist
            if hasattr(self, 'stat_value_labels') and self.stat_value_labels:
                if 'total_classes' in self.stat_value_labels:
                    self.stat_value_labels['total_classes'].config(text=str(total_classes))
                if 'total_capacity' in self.stat_value_labels:
                    self.stat_value_labels['total_capacity'].config(text=str(total_capacity))
                if 'enrollment' in self.stat_value_labels:
                    self.stat_value_labels['enrollment'].config(text=str(current_enrollment))
            
            # Update old labels if they still exist (backward compatibility)
            if hasattr(self, 'total_classes_stat'):
                self.total_classes_stat.config(text=f"Total Classes: {total_classes}")
                self.total_capacity_stat.config(text=f"Total Capacity: {total_capacity}")
                self.enrollment_stat.config(text=f"Current Enrollment: {current_enrollment}")
                
        except Exception as e:
            print(f"Error updating class statistics: {e}")

    def load_classes(self):
        # Clear existing data
        for i in self.classes_tree.get_children():
            self.classes_tree.delete(i)
            
        # Load classes with enhanced formatting
        self.cursor.execute('''
            SELECT cl.id, cl.class_name, t.name, cl.capacity, 
                   (SELECT COUNT(*) FROM students WHERE class_id = cl.id) as current_students
            FROM classes cl
            LEFT JOIN teachers t ON cl.class_teacher_id = t.id
            ORDER BY cl.class_name
        ''')
        
        for class_data in self.cursor.fetchall():
            # Calculate utilization percentage
            capacity = class_data[3] or 0
            current = class_data[4] or 0
            utilization = f"{(current/capacity*100):.1f}%" if capacity > 0 else "0%"
            
            # Determine status based on utilization
            if current == 0:
                status = "📭 Empty"
            elif current >= capacity:
                status = "ƒí Full" 
            elif current/capacity >= 0.8:
                status = "ƒá Near Full"
            else:
                status = "ƒó Available"
            
            # Format the data for display
            formatted_class = (
                class_data[0],  # ID
                class_data[1],  # Class name
                class_data[2] or "No Teacher Assigned",  # Teacher name
                capacity,  # Capacity
                current,  # Current students
                utilization,  # Utilization percentage
                status  # Status with icon
            )
            self.classes_tree.insert('', tk.END, values=formatted_class)
            
        # Update statistics after loading
        self.update_class_statistics()

    def on_class_select(self, event):
        sel = self.classes_tree.selection()
        if not sel:
            return
        vals = self.classes_tree.item(sel[0])['values']
        self.class_name_entry.delete(0, tk.END); self.class_name_entry.insert(0, vals[1])
        self.class_capacity_entry.delete(0, tk.END); self.class_capacity_entry.insert(0, vals[3])
        teacher_name = vals[2] or ''
        self.class_teacher_var.set(teacher_name)

    def add_class(self):
        name = self.class_name_entry.get().strip()
        cap = self.class_capacity_entry.get().strip() or "30"
        teacher_name = self.class_teacher_var.get()
        if not name:
            messagebox.showerror("Error","Enter class name")
            return
        teacher_id = None
        if teacher_name:
            self.cursor.execute("SELECT id FROM teachers WHERE name = ?", (teacher_name,))
            r = self.cursor.fetchone()
            teacher_id = r[0] if r else None
        try:
            self.cursor.execute("INSERT INTO classes (class_name, capacity) VALUES (?, ?)", (name, int(cap)))
            if teacher_id:
                cid = self.cursor.lastrowid
                self.cursor.execute("UPDATE classes SET class_teacher_id = ? WHERE id = ?", (teacher_id, cid))
            self.conn.commit()
            self.load_classes()
            messagebox.showinfo("Success","Class added")
        except Exception as e:
            messagebox.showerror("Error", str(e))

    def update_class(self):
        sel = self.classes_tree.selection()
        if not sel:
            messagebox.showerror("Error","Select a class to update")
            return
        cid = self.classes_tree.item(sel[0])['values'][0]
        name = self.class_name_entry.get().strip()
        cap = self.class_capacity_entry.get().strip() or "30"
        teacher_name = self.class_teacher_var.get()
        teacher_id = None
        if teacher_name:
            self.cursor.execute("SELECT id FROM teachers WHERE name = ?", (teacher_name,))
            r = self.cursor.fetchone(); teacher_id = r[0] if r else None
        try:
            self.cursor.execute("UPDATE classes SET class_name = ?, capacity = ?, class_teacher_id = ? WHERE id = ?",
                                (name, int(cap), teacher_id, cid))
            self.conn.commit()
            self.load_classes()
            messagebox.showinfo("Success","Class updated")
        except Exception as e:
            messagebox.showerror("Error", str(e))

    def delete_class(self):
        sel = self.classes_tree.selection()
        if not sel:
            messagebox.showerror("Error","Select a class to delete")
            return
        cid = self.classes_tree.item(sel[0])['values'][0]
        if messagebox.askyesno("Confirm","Delete selected class?"):
            try:
                self.cursor.execute("DELETE FROM classes WHERE id = ?", (cid,))
                self.conn.commit()
                self.load_classes()
                messagebox.showinfo("Success","Class deleted")
            except Exception as e:
                messagebox.showerror("Error", str(e))

    def show_teacher_management(self):
        self.clear_content_frame()
        
        # Create main container with gradient background
        main_container = tk.Frame(self.content_frame, bg='#f8f9fa')
        main_container.pack(fill=tk.BOTH, expand=True)
        
        # Create scrollable frame for teacher management
        scrollable_teacher = ScrollableFrame(main_container, bg='#f8f9fa')
        scrollable_teacher.pack(fill=tk.BOTH, expand=True)
        teacher_main_frame = scrollable_teacher.get_frame()
        
        # Hero Header Section with Modern Design
        hero_section = tk.Frame(teacher_main_frame, bg='#ffffff', relief=tk.FLAT, bd=0)
        hero_section.pack(fill=tk.X, padx=0, pady=0)
        
        # Gradient-like header background - Orange theme for teachers
        header_bg = tk.Frame(hero_section, bg='#e67e22', relief=tk.FLAT, bd=0)
        header_bg.pack(fill=tk.X)
        
        header_content = tk.Frame(header_bg, bg='#e67e22')
        header_content.pack(fill=tk.X, padx=40, pady=30)
        
        # Main title with icon
        title_frame = tk.Frame(header_content, bg='#e67e22')
        title_frame.pack(fill=tk.X)
        
        icon_label = tk.Label(title_frame, text="📚", font=('Segoe UI', 40), bg='#e67e22', fg='white')
        icon_label.pack(side=tk.LEFT, padx=(0, 15))
        
        title_text_frame = tk.Frame(title_frame, bg='#e67e22')
        title_text_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        title = tk.Label(title_text_frame, text="Teacher Management Hub",
                         font=('Segoe UI', 32, 'bold'), fg='white', bg='#e67e22')
        title.pack(anchor=tk.W)
        
        subtitle = tk.Label(title_text_frame, text="Comprehensive staff management and professional development tracking",
                           font=('Segoe UI', 14), fg='#f39c12', bg='#e67e22')
        subtitle.pack(anchor=tk.W, pady=(5, 0))

        # Quick Stats Dashboard - Modern Card Layout
        stats_dashboard = tk.Frame(teacher_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        stats_dashboard.pack(fill=tk.X, padx=30, pady=(25, 30))
        
        stats_title_frame = tk.Frame(stats_dashboard, bg='#f8f9fa')
        stats_title_frame.pack(fill=tk.X, pady=(0, 20))
        
        stats_title = tk.Label(stats_title_frame, text="📊 Staff Overview", 
                              font=('Segoe UI', 20, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        stats_title.pack(anchor=tk.W)
        
        # Stats cards container
        stats_cards_container = tk.Frame(stats_dashboard, bg='#f8f9fa')
        stats_cards_container.pack(fill=tk.X)
        
        # Individual stat cards with modern design
        self.total_teachers_card = self.create_stat_dashboard_card(stats_cards_container, "👥", "Total Teachers", "0", '#e74c3c')
        self.total_teachers_card.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 15))
        
        self.assigned_teachers_card = self.create_stat_dashboard_card(stats_cards_container, "📚", "Assigned Classes", "0", '#9b59b6')
        self.assigned_teachers_card.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 15))
        
        self.avg_salary_card = self.create_stat_dashboard_card(stats_cards_container, "💳", "Avg Salary", "0", '#f39c12')
        self.avg_salary_card.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        # Update statistics
        self.update_teacher_statistics()

        # Main Content Area with Modern Tabbed Layout
        content_area = tk.Frame(teacher_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        content_area.pack(fill=tk.BOTH, expand=True, padx=30, pady=(0, 30))
        
        # Create modern tabbed interface
        notebook = ttk.Notebook(content_area)
        notebook.pack(fill=tk.BOTH, expand=True, pady=(0, 20))

        # Teacher Form Tab with Modern Design
        form_tab = ttk.Frame(notebook)
        notebook.add(form_tab, text="📝 Teacher Information Form")
        
        # Form container with modern styling
        form_container = tk.Frame(form_tab, bg='#ffffff', relief=tk.FLAT, bd=0)
        form_container.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Add subtle shadow effect to form container
        form_shadow = tk.Frame(form_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        form_shadow.pack(fill=tk.BOTH, expand=True, padx=(3, 0), pady=(3, 0))
        
        form_content_wrapper = tk.Frame(form_shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        form_content_wrapper.pack(fill=tk.BOTH, expand=True, padx=(0, 3), pady=(0, 3))
        
        # Modern form header
        form_header = tk.Frame(form_content_wrapper, bg='#e67e22', relief=tk.FLAT, bd=0)
        form_header.pack(fill=tk.X)
        
        form_header_content = tk.Frame(form_header, bg='#e67e22')
        form_header_content.pack(fill=tk.X, padx=25, pady=20)
        
        form_title = tk.Label(form_header_content, text="📝 Teacher Information Form",
                             font=('Segoe UI', 18, 'bold'), fg='white', bg='#e67e22')
        form_title.pack(anchor=tk.W)
        
        form_subtitle = tk.Label(form_header_content, text="Add new staff or update existing teacher profiles",
                                font=('Segoe UI', 11), fg='#f39c12', bg='#e67e22')
        form_subtitle.pack(anchor=tk.W, pady=(5, 0))
        
        # Scrollable form content
        form_scroll_container = ScrollableFrame(form_content_wrapper, bg='#ffffff')
        form_scroll_container.pack(fill=tk.BOTH, expand=True)
        teacher_form = form_scroll_container.get_frame()

        # Form content with improved spacing and modern design
        form_content = tk.Frame(teacher_form, bg='#ffffff')
        form_content.pack(fill=tk.BOTH, expand=True)
        
        # Full Name Field
        name_section = tk.Frame(form_content, bg='#ffffff')
        name_section.pack(fill=tk.X, pady=(30, 25), padx=40)
        
        name_label = tk.Label(name_section, text="👤 Full Name", 
                             font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        name_label.pack(anchor=tk.W, pady=(0, 5))
        
        name_desc = tk.Label(name_section, text="Enter the teacher's complete name (First Middle Last)", 
                            font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        name_desc.pack(anchor=tk.W, pady=(0, 8))
        
        self.teacher_name_entry = tk.Entry(name_section, font=('Segoe UI', 12), relief=tk.FLAT, bd=1,
                                          bg='#f8f9fa', fg='#2c3e50', insertbackground='#e67e22')
        self.teacher_name_entry.pack(fill=tk.X, ipady=8)
        self.teacher_name_entry.config(highlightthickness=1, highlightcolor='#e67e22')
        
        # Hire Date Field
        hire_section = tk.Frame(form_content, bg='#ffffff')
        hire_section.pack(fill=tk.X, pady=(0, 25), padx=40)
        
        hire_label = tk.Label(hire_section, text="✅ Hire Date", 
                             font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        hire_label.pack(anchor=tk.W, pady=(0, 5))
        
        hire_desc = tk.Label(hire_section, text="Date when the teacher joined the school", 
                            font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        hire_desc.pack(anchor=tk.W, pady=(0, 8))
        
        self.teacher_hire_entry = DateEntry(hire_section, width=30, background='#e67e22',
                                          foreground='white', borderwidth=0, 
                                          date_pattern='y-mm-dd', font=('Segoe UI', 11))
        self.teacher_hire_entry.pack(fill=tk.X, ipady=8)
        
        # Salary Field
        salary_section = tk.Frame(form_content, bg='#ffffff')
        salary_section.pack(fill=tk.X, pady=(0, 20), padx=40)
        
        salary_label = tk.Label(salary_section, text="💳 Monthly Salary (GHS)", 
                               font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        salary_label.pack(anchor=tk.W, pady=(0, 5))
        
        salary_desc = tk.Label(salary_section, text="Monthly salary in Ghana Cedis (e.g., 2500)", 
                              font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        salary_desc.pack(anchor=tk.W, pady=(0, 8))
        
        self.teacher_salary_entry = tk.Entry(salary_section, font=('Segoe UI', 12), relief=tk.FLAT, bd=1,
                                           bg='#f8f9fa', fg='#2c3e50', insertbackground='#e67e22')
        self.teacher_salary_entry.pack(fill=tk.X, ipady=8)
        self.teacher_salary_entry.config(highlightthickness=1, highlightcolor='#e67e22')
        
        # Class Assignment Field
        class_section = tk.Frame(form_content, bg='#ffffff')
        class_section.pack(fill=tk.X, pady=(0, 25), padx=40)
        
        class_label = tk.Label(class_section, text="📚 Assign Class", 
                              font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        class_label.pack(anchor=tk.W, pady=(0, 5))
        
        class_desc = tk.Label(class_section, text="Select a class for the teacher to manage", 
                             font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        class_desc.pack(anchor=tk.W, pady=(0, 8))
        
        # Get classes data
        self.cursor.execute("SELECT id, class_name FROM classes")
        classes = self.cursor.fetchall()
        class_names = ["None"] + [c[1] for c in classes]
        self.teacher_class_var = tk.StringVar()
        
        class_combo_frame = tk.Frame(class_section, bg='#f8f9fa', relief=tk.FLAT, bd=1)
        class_combo_frame.pack(fill=tk.X, ipady=4)
        class_combo_frame.config(highlightthickness=1, highlightcolor='#e67e22')
        
        self.teacher_class_cb = ttk.Combobox(class_combo_frame, textvariable=self.teacher_class_var, 
                                           values=class_names, state="readonly", font=('Segoe UI', 11))
        self.teacher_class_cb.pack(fill=tk.X, padx=8, pady=4)
        
        # Phone Number Field
        phone_section = tk.Frame(form_content, bg='#ffffff')
        phone_section.pack(fill=tk.X, pady=(0, 25), padx=40)
        
        phone_label = tk.Label(phone_section, text="📞 Phone Number", 
                              font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        phone_label.pack(anchor=tk.W, pady=(0, 5))
        
        phone_desc = tk.Label(phone_section, text="Contact phone number (e.g., +233 24 123 4567)", 
                             font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        phone_desc.pack(anchor=tk.W, pady=(0, 8))
        
        self.teacher_phone_entry = tk.Entry(phone_section, font=('Segoe UI', 12), relief=tk.FLAT, bd=1,
                                          bg='#f8f9fa', fg='#2c3e50', insertbackground='#e67e22')
        self.teacher_phone_entry.pack(fill=tk.X, ipady=8)
        self.teacher_phone_entry.config(highlightthickness=1, highlightcolor='#e67e22')
        
        # Email Address Field
        email_section = tk.Frame(form_content, bg='#ffffff')
        email_section.pack(fill=tk.X, pady=(0, 25), padx=40)
        
        email_label = tk.Label(email_section, text="📧 Email Address", 
                              font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        email_label.pack(anchor=tk.W, pady=(0, 5))
        
        email_desc = tk.Label(email_section, text="Professional email address for communication", 
                             font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        email_desc.pack(anchor=tk.W, pady=(0, 8))
        
        self.teacher_email_entry = tk.Entry(email_section, font=('Segoe UI', 12), relief=tk.FLAT, bd=1,
                                          bg='#f8f9fa', fg='#2c3e50', insertbackground='#e67e22')
        self.teacher_email_entry.pack(fill=tk.X, ipady=8)
        self.teacher_email_entry.config(highlightthickness=1, highlightcolor='#e67e22')

        # Qualifications Field
        qual_section = tk.Frame(form_content, bg='#ffffff')
        qual_section.pack(fill=tk.X, pady=(0, 30), padx=40)
        
        qual_label = tk.Label(qual_section, text="🎓 Educational Qualifications", 
                             font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        qual_label.pack(anchor=tk.W, pady=(0, 5))
        
        qual_desc = tk.Label(qual_section, text="List educational qualifications, degrees, and certifications", 
                            font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        qual_desc.pack(anchor=tk.W, pady=(0, 8))
        
        qual_text_frame = tk.Frame(qual_section, bg='#f8f9fa', relief=tk.FLAT, bd=1)
        qual_text_frame.pack(fill=tk.X, ipady=4)
        qual_text_frame.config(highlightthickness=1, highlightcolor='#e67e22')
        
        self.teacher_qualifications_text = tk.Text(qual_text_frame, height=4, 
                                                  font=('Segoe UI', 11), wrap=tk.WORD, 
                                                  relief=tk.FLAT, bd=0, bg='#f8f9fa', fg='#2c3e50')
        qual_scrollbar = tk.Scrollbar(qual_text_frame, orient=tk.VERTICAL, 
                                     command=self.teacher_qualifications_text.yview)
        self.teacher_qualifications_text.configure(yscrollcommand=qual_scrollbar.set)
        
        self.teacher_qualifications_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=8, pady=4)
        qual_scrollbar.pack(side=tk.RIGHT, fill=tk.Y, pady=4)
        
        # Add placeholder text
        placeholder_qual = "e.g., Bachelor of Education, Master's in Mathematics, Teaching Certificate..."
        self.teacher_qualifications_text.insert('1.0', placeholder_qual)
        self.teacher_qualifications_text.config(fg='#95a5a6')
        
        def on_qual_focus_in(event):
            if self.teacher_qualifications_text.get('1.0', 'end-1c') == placeholder_qual:
                self.teacher_qualifications_text.delete('1.0', tk.END)
                self.teacher_qualifications_text.config(fg='#2c3e50')
        
        def on_qual_focus_out(event):
            if self.teacher_qualifications_text.get('1.0', 'end-1c').strip() == '':
                self.teacher_qualifications_text.insert('1.0', placeholder_qual)
                self.teacher_qualifications_text.config(fg='#95a5a6')
        
        self.teacher_qualifications_text.bind('<FocusIn>', on_qual_focus_in)
        self.teacher_qualifications_text.bind('<FocusOut>', on_qual_focus_out)
        
        # Skills Field
        skills_section = tk.Frame(form_content, bg='#ffffff')
        skills_section.pack(fill=tk.X, pady=(0, 25), padx=40)
        
        skills_label = tk.Label(skills_section, text="💡 Additional Skills", 
                               font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        skills_label.pack(anchor=tk.W, pady=(0, 5))
        
        skills_desc = tk.Label(skills_section, text="Optional: Special skills, languages, certifications", 
                              font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        skills_desc.pack(anchor=tk.W, pady=(0, 8))
        
        skills_text_frame = tk.Frame(skills_section, bg='#f8f9fa', relief=tk.FLAT, bd=1)
        skills_text_frame.pack(fill=tk.X, ipady=4)
        skills_text_frame.config(highlightthickness=1, highlightcolor='#e67e22')
        
        self.teacher_skills_text = tk.Text(skills_text_frame, height=3, 
                                          font=('Segoe UI', 11), wrap=tk.WORD, 
                                          relief=tk.FLAT, bd=0, bg='#f8f9fa', fg='#2c3e50')
        skills_scrollbar = tk.Scrollbar(skills_text_frame, orient=tk.VERTICAL, 
                                       command=self.teacher_skills_text.yview)
        self.teacher_skills_text.configure(yscrollcommand=skills_scrollbar.set)
        
        self.teacher_skills_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=8, pady=4)
        skills_scrollbar.pack(side=tk.RIGHT, fill=tk.Y, pady=4)
        
        # Add placeholder text for skills
        placeholder_skills = "e.g., Computer literacy, French language, Sports coaching, Music..."
        self.teacher_skills_text.insert('1.0', placeholder_skills)
        self.teacher_skills_text.config(fg='#95a5a6')
        
        def on_skills_focus_in(event):
            if self.teacher_skills_text.get('1.0', 'end-1c') == placeholder_skills:
                self.teacher_skills_text.delete('1.0', tk.END)
                self.teacher_skills_text.config(fg='#2c3e50')
        
        def on_skills_focus_out(event):
            if self.teacher_skills_text.get('1.0', 'end-1c').strip() == '':
                self.teacher_skills_text.insert('1.0', placeholder_skills)
                self.teacher_skills_text.config(fg='#95a5a6')
        
        self.teacher_skills_text.bind('<FocusIn>', on_skills_focus_in)
        self.teacher_skills_text.bind('<FocusOut>', on_skills_focus_out)

        # Photo and Document Upload Section
        upload_section = tk.Frame(form_content, bg='#ffffff')
        upload_section.pack(fill=tk.X, pady=(0, 25), padx=40)
        
        upload_label = tk.Label(upload_section, text="📸 Photo & Documents", 
                               font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50')
        upload_label.pack(anchor=tk.W, pady=(0, 5))
        
        upload_desc = tk.Label(upload_section, text="Upload profile photo and supporting documents", 
                              font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d')
        upload_desc.pack(anchor=tk.W, pady=(0, 15))
        
        # Photo section
        photo_section = tk.Frame(upload_section, bg='#ffffff')
        photo_section.pack(fill=tk.X, pady=(0, 15))
        
        # Photo display area
        photo_display_frame = tk.Frame(photo_section, bg='#f8f9fa', relief=tk.SOLID, bd=1)
        photo_display_frame.pack(side=tk.LEFT, padx=(0, 15))
        
        self.teacher_photo_label = tk.Label(photo_display_frame, text="📸\nNo Photo", 
                                           font=('Segoe UI', 10), bg='#f8f9fa', fg='#7f8c8d',
                                           width=12, height=8, relief=tk.FLAT)
        self.teacher_photo_label.pack(padx=5, pady=5)
        
        # Photo buttons
        photo_buttons_frame = tk.Frame(photo_section, bg='#ffffff')
        photo_buttons_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        
        photo_upload_btn = self.create_enhanced_form_button(photo_buttons_frame, "📂 Browse Photo", 
                                                           self.browse_teacher_photo, '#3498db', '#2980b9')
        photo_upload_btn.pack(fill=tk.X, pady=(0, 5))
        
        if CAMERA_AVAILABLE:
            photo_capture_btn = self.create_enhanced_form_button(photo_buttons_frame, "📷 Capture Photo", 
                                                               self.capture_teacher_photo, '#9b59b6', '#8e44ad')
            photo_capture_btn.pack(fill=tk.X, pady=(0, 5))
        
        photo_clear_btn = self.create_enhanced_form_button(photo_buttons_frame, "🧹 Clear Photo", 
                                                          self.clear_teacher_photo, '#e74c3c', '#c0392b')
        photo_clear_btn.pack(fill=tk.X)
        
        # Documents section
        docs_section = tk.Frame(upload_section, bg='#ffffff')
        docs_section.pack(fill=tk.X, pady=(15, 0))
        
        docs_label = tk.Label(docs_section, text="📊 Supporting Documents:", 
                             font=('Segoe UI', 10, 'bold'), bg='#ffffff', fg='#2c3e50')
        docs_label.pack(anchor=tk.W, pady=(0, 8))
        
        # Document upload buttons
        docs_buttons_frame = tk.Frame(docs_section, bg='#ffffff')
        docs_buttons_frame.pack(fill=tk.X, pady=(0, 10))
        
        add_doc_btn = self.create_enhanced_form_button(docs_buttons_frame, "📂 Add Document", 
                                                      self.add_teacher_document, '#f39c12', '#e67e22')
        add_doc_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        clear_docs_btn = self.create_enhanced_form_button(docs_buttons_frame, "🧹 Clear All", 
                                                         self.clear_teacher_documents, '#e74c3c', '#c0392b')
        clear_docs_btn.pack(side=tk.LEFT)
        
        # Documents list display
        docs_list_frame = tk.Frame(docs_section, bg='#f8f9fa', relief=tk.SOLID, bd=1)
        docs_list_frame.pack(fill=tk.X, pady=(0, 10))
        
        # Create scrollable frame for documents list
        docs_scroll_frame = tk.Frame(docs_list_frame, bg='#f8f9fa')
        docs_scroll_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # Documents list header
        docs_header = tk.Label(docs_scroll_frame, text="📎 Uploaded Documents:", 
                              font=('Segoe UI', 9, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        docs_header.pack(anchor=tk.W, pady=(0, 5))
        
        # Container for document items
        self.teacher_docs_container = tk.Frame(docs_scroll_frame, bg='#f8f9fa')
        self.teacher_docs_container.pack(fill=tk.X)
        
        # Initialize document storage
        self.teacher_documents = []  # List to store document paths
        
        # No documents message (initially shown)
        self.no_docs_label = tk.Label(self.teacher_docs_container, text="No documents uploaded", 
                                     font=('Segoe UI', 9, 'italic'), bg='#f8f9fa', fg='#7f8c8d')
        self.no_docs_label.pack(anchor=tk.W)

        # Action Buttons with Enhanced Styling
        buttons_frame = tk.Frame(form_content, bg='#ffffff')
        buttons_frame.pack(fill=tk.X, pady=(25, 30), padx=40)
        
        # Button row 1
        button_row1 = tk.Frame(buttons_frame, bg='#ffffff')
        button_row1.pack(fill=tk.X, pady=(0, 10))
        
        add_btn = self.create_enhanced_form_button(button_row1, "➕ Add New Teacher", 
                                                  self.add_teacher, '#27ae60', '#2ecc71')
        add_btn.pack(fill=tk.X)
        
        # Button row 2
        button_row2 = tk.Frame(buttons_frame, bg='#ffffff')
        button_row2.pack(fill=tk.X, pady=(0, 10))
        
        update_btn = self.create_enhanced_form_button(button_row2, "🔄 Update Selected", 
                                                     self.update_teacher, '#e67e22', '#f39c12')
        update_btn.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 5))
        
        delete_btn = self.create_enhanced_form_button(button_row2, "🧹 Delete Selected", 
                                                     self.delete_teacher, '#c0392b', '#e74c3c')
        delete_btn.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(5, 0))
        
        # Clear form button
        clear_btn = self.create_enhanced_form_button(buttons_frame, "🔄 Clear Form", 
                                                    self.clear_teacher_form, '#7f8c8d', '#95a5a6')
        clear_btn.pack(fill=tk.X, pady=(10, 0))

        # Teachers List Tab with Modern Design
        list_tab = ttk.Frame(notebook)
        notebook.add(list_tab, text="👥 Staff Directory")
        
        # List container with modern styling
        list_container = tk.Frame(list_tab, bg='#ffffff', relief=tk.FLAT, bd=0)
        list_container.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Add subtle shadow effect
        list_shadow = tk.Frame(list_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        list_shadow.pack(fill=tk.BOTH, expand=True, padx=(3, 0), pady=(3, 0))
        
        list_content = tk.Frame(list_shadow, bg='#ffffff', relief=tk.FLAT, bd=0)
        list_content.pack(fill=tk.BOTH, expand=True, padx=(0, 3), pady=(0, 3))
        
        # Modern list header
        list_header = tk.Frame(list_content, bg='#9b59b6', relief=tk.FLAT, bd=0)
        list_header.pack(fill=tk.X)
        
        list_header_content = tk.Frame(list_header, bg='#9b59b6')
        list_header_content.pack(fill=tk.X, padx=25, pady=20)
        
        list_title = tk.Label(list_header_content, text="👥 Staff Directory",
                             font=('Segoe UI', 18, 'bold'), fg='white', bg='#9b59b6')
        list_title.pack(anchor=tk.W)
        
        list_subtitle = tk.Label(list_header_content, text="View and manage all teacher records",
                                font=('Segoe UI', 11), fg='#e8d5f0', bg='#9b59b6')
        list_subtitle.pack(anchor=tk.W, pady=(5, 0))
        
        # Enhanced treeview with better styling
        tree_container = tk.Frame(list_content, bg='#ffffff')
        tree_container.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)

        cols = ('ID', 'Teacher Name', 'Assigned Class', 'Hire Date', 'Salary (GHS)', 'Phone', 'Email', 'Status')
        self.teachers_tree = ttk.Treeview(tree_container, columns=cols, show='headings', height=15)
        
        # Configure columns with better spacing
        column_config = {
            'ID': {'width': 50, 'anchor': 'center'},
            'Teacher Name': {'width': 150, 'anchor': 'w'},
            'Assigned Class': {'width': 120, 'anchor': 'center'},
            'Hire Date': {'width': 100, 'anchor': 'center'},
            'Salary (GHS)': {'width': 100, 'anchor': 'e'},
            'Phone': {'width': 120, 'anchor': 'center'},
            'Email': {'width': 180, 'anchor': 'w'},
            'Status': {'width': 100, 'anchor': 'center'}
        }
        
        for col, config in column_config.items():
            self.teachers_tree.heading(col, text=col, anchor='center')
            self.teachers_tree.column(col, width=config['width'], anchor=config['anchor'])
        
        # Scrollbars
        tree_scroll_y = ttk.Scrollbar(tree_container, orient=tk.VERTICAL, command=self.teachers_tree.yview)
        tree_scroll_x = ttk.Scrollbar(tree_container, orient=tk.HORIZONTAL, command=self.teachers_tree.xview)
        self.teachers_tree.configure(yscrollcommand=tree_scroll_y.set, xscrollcommand=tree_scroll_x.set)
        
        # Pack tree and scrollbars
        self.teachers_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        tree_scroll_y.pack(side=tk.RIGHT, fill=tk.Y)
        tree_scroll_x.pack(side=tk.BOTTOM, fill=tk.X)
        
        # Bind selection event
        self.teachers_tree.bind('<<TreeviewSelect>>', self.on_teacher_select)
        
        # Enable mouse wheel scrolling
        self.bind_treeview_mousewheel(self.teachers_tree)
        
        # Load teachers data
        self.load_teachers()

    def update_teacher_statistics(self):
        """Update the teacher statistics display in real-time"""
        try:
            # Calculate total teachers
            self.cursor.execute("SELECT COUNT(*) FROM teachers")
            total_teachers = self.cursor.fetchone()[0]
            
            # Calculate teachers with class assignments
            self.cursor.execute("SELECT COUNT(*) FROM teachers WHERE class_id IS NOT NULL")
            assigned_teachers = self.cursor.fetchone()[0]
            
            # Calculate average salary
            self.cursor.execute("SELECT AVG(starting_salary) FROM teachers WHERE starting_salary IS NOT NULL")
            avg_salary_result = self.cursor.fetchone()[0]
            avg_salary = int(avg_salary_result) if avg_salary_result else 0
            
            # Update new dashboard cards if they exist
            if hasattr(self, 'stat_value_labels') and self.stat_value_labels:
                if 'total_teachers' in self.stat_value_labels:
                    self.stat_value_labels['total_teachers'].config(text=str(total_teachers))
                if 'assigned_classes' in self.stat_value_labels:
                    self.stat_value_labels['assigned_classes'].config(text=str(assigned_teachers))
                if 'avg_salary' in self.stat_value_labels:
                    self.stat_value_labels['avg_salary'].config(text=f"₡{avg_salary:,}")
            
            # Update old labels if they still exist (backward compatibility)
            if hasattr(self, 'total_teachers_stat'):
                self.total_teachers_stat.config(text=f"Total Teachers: {total_teachers}")
                self.assigned_teachers_stat.config(text=f"Assigned Classes: {assigned_teachers}")
                
        except Exception as e:
            print(f"Error updating teacher statistics: {e}")
    
    def clear_teacher_form(self):
        """Clear all teacher form fields"""
        self.teacher_name_entry.delete(0, tk.END)
        self.teacher_salary_entry.delete(0, tk.END)
        self.teacher_phone_entry.delete(0, tk.END)
        self.teacher_email_entry.delete(0, tk.END)
        self.teacher_class_var.set("")
        
        # Clear text areas
        self.teacher_qualifications_text.delete('1.0', tk.END)
        self.teacher_qualifications_text.insert('1.0', "e.g., Bachelor of Education, Master's in Mathematics, Teaching Certificate...")
        self.teacher_qualifications_text.config(fg='#95a5a6')
        
        self.teacher_skills_text.delete('1.0', tk.END) 
        self.teacher_skills_text.insert('1.0', "e.g., Computer literacy, French language, Sports coaching, Music...")
        self.teacher_skills_text.config(fg='#95a5a6')
        
        # Clear photo and document fields
        self.clear_teacher_photo()
        self.teacher_file_path_var.set("")
        self.teacher_file_info.configure(text="No file selected", fg='#7f8c8d')
        
        # Reset hire date
        if hasattr(self, 'teacher_hire_entry'):
            if not CALENDAR_AVAILABLE:
                self.teacher_hire_entry.delete(0, tk.END)
                self.teacher_hire_entry.insert(0, date.today().strftime("%Y-%m-%d"))
        
        # Clear selection in treeview
        for item in self.teachers_tree.selection():
            self.teachers_tree.selection_remove(item)
    
    def browse_teacher_photo(self):
        """Browse and select a photo file for teacher profile"""
        try:
            file_path = filedialog.askopenfilename(
                title="Select Teacher Photo",
                filetypes=[
                    ("Image files", "*.jpg *.jpeg *.png *.gif *.bmp"),
                    ("JPEG files", "*.jpg *.jpeg"),
                    ("PNG files", "*.png"),
                    ("All files", "*.*")
                ]
            )
            
            if file_path:
                # Load and display the image
                self.load_teacher_photo(file_path)
                
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load photo: {str(e)}")
    
    def load_teacher_photo(self, file_path):
        """Load and display a photo in the teacher form"""
        if not CAMERA_AVAILABLE:
            messagebox.showwarning("Feature Unavailable", 
                                 "Photo functionality requires PIL (Pillow) library.\n"
                                 "Please install it with: pip install Pillow")
            return
            
        try:
            # Open and resize the image
            image = Image.open(file_path)
            # Resize to fit the display area (120x160 pixels)
            image = image.resize((120, 160), Image.Resampling.LANCZOS)
            
            # Convert to PhotoImage
            photo = ImageTk.PhotoImage(image)
            
            # Update the photo label
            self.teacher_photo_label.configure(image=photo, text="")
            self.teacher_photo_label.image = photo  # Keep a reference
            
            # Store the file path for saving
            self.teacher_photo_path = file_path
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load photo: {str(e)}")
    
    def capture_teacher_photo(self):
        """Capture a photo using the camera"""
        if not CAMERA_AVAILABLE:
            messagebox.showerror("Error", "Camera functionality not available. Please install OpenCV.")
            return
            
        try:
            # Create a new window for photo capture
            capture_window = tk.Toplevel(self.root)
            capture_window.title("Capture Teacher Photo")
            capture_window.geometry("640x520")
            capture_window.configure(bg='#ffffff')
            capture_window.resizable(False, False)
            
            # Make window modal
            capture_window.transient(self.root)
            capture_window.grab_set()
            
            # Header
            header_frame = tk.Frame(capture_window, bg='#e67e22', height=60)
            header_frame.pack(fill=tk.X)
            header_frame.pack_propagate(False)
            
            header_title = tk.Label(header_frame, text="📷 Photo Capture", 
                                   font=('Segoe UI', 16, 'bold'), fg='white', bg='#e67e22')
            header_title.pack(expand=True)
            
            # Camera preview frame
            preview_frame = tk.Frame(capture_window, bg='#f8f9fa')
            preview_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
            
            # Camera label
            camera_label = tk.Label(preview_frame, text="📷 Initializing camera...", 
                                   font=('Segoe UI', 14), bg='#f8f9fa', fg='#7f8c8d')
            camera_label.pack(expand=True)
            
            # Control buttons frame
            controls_frame = tk.Frame(capture_window, bg='#ffffff', height=80)
            controls_frame.pack(fill=tk.X, padx=20, pady=(0, 20))
            controls_frame.pack_propagate(False)
            
            # Start camera capture in a separate thread
            def start_camera():
                try:
                    cap = cv2.VideoCapture(0)
                    if not cap.isOpened():
                        camera_label.configure(text="❌ Camera not found")
                        return
                    
                    camera_label.configure(text="")
                    
                    def update_frame():
                        if hasattr(capture_window, 'camera_active') and capture_window.camera_active:
                            ret, frame = cap.read()
                            if ret:
                                # Convert from BGR to RGB
                                frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                                # Resize frame to fit preview
                                frame = cv2.resize(frame, (480, 360))
                                
                                # Convert to PIL Image and then to PhotoImage
                                image = Image.fromarray(frame)
                                photo = ImageTk.PhotoImage(image)
                                
                                # Update the camera label
                                camera_label.configure(image=photo)
                                camera_label.image = photo
                                
                                # Schedule next update
                                capture_window.after(30, update_frame)
                    
                    capture_window.camera_active = True
                    capture_window.camera = cap
                    update_frame()
                    
                except Exception as e:
                    camera_label.configure(text=f"❌ Camera error: {str(e)}")
            
            # Capture button
            def capture_photo():
                try:
                    if hasattr(capture_window, 'camera') and capture_window.camera.isOpened():
                        ret, frame = capture_window.camera.read()
                        if ret:
                            # Save the captured image
                            os.makedirs("teacher_photos", exist_ok=True)
                            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                            photo_path = f"teacher_photos/teacher_{timestamp}.jpg"
                            cv2.imwrite(photo_path, frame)
                            
                            # Load the captured photo in the form
                            self.load_teacher_photo(photo_path)
                            
                            # Close the capture window
                            close_camera()
                            
                            messagebox.showinfo("Success", "Photo captured successfully!")
                        
                except Exception as e:
                    messagebox.showerror("Error", f"Failed to capture photo: {str(e)}")
            
            def close_camera():
                try:
                    capture_window.camera_active = False
                    if hasattr(capture_window, 'camera'):
                        capture_window.camera.release()
                    capture_window.destroy()
                except:
                    pass
            
            # Control buttons
            capture_btn = self.create_enhanced_form_button(controls_frame, "📷 Capture", 
                                                          capture_photo, '#27ae60', '#2ecc71')
            capture_btn.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 10))
            
            cancel_btn = self.create_enhanced_form_button(controls_frame, "❌ Cancel", 
                                                         close_camera, '#e74c3c', '#c0392b')
            cancel_btn.pack(side=tk.RIGHT, fill=tk.X, expand=True, padx=(10, 0))
            
            # Handle window closing
            capture_window.protocol("WM_DELETE_WINDOW", close_camera)
            
            # Start camera in a separate thread
            threading.Thread(target=start_camera, daemon=True).start()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to start camera: {str(e)}")
    
    def clear_teacher_photo(self):
        """Clear the teacher photo"""
        self.teacher_photo_label.configure(image="", text="📸\nNo Photo")
        if hasattr(self, 'teacher_photo_path'):
            delattr(self, 'teacher_photo_path')
        # Remove the image reference
        self.teacher_photo_label.image = None
    
    def browse_teacher_document(self):
        """Browse and select documents for teacher"""
        try:
            file_path = filedialog.askopenfilename(
                title="Select Teacher Documents",
                filetypes=[
                    ("PDF files", "*.pdf"),
                    ("Word documents", "*.doc *.docx"),
                    ("Image files", "*.jpg *.jpeg *.png"),
                    ("All files", "*.*")
                ]
            )
            
            if file_path:
                self.teacher_file_path_var.set(file_path)
                file_name = os.path.basename(file_path)
                file_size = os.path.getsize(file_path)
                size_mb = file_size / (1024 * 1024)
                self.teacher_file_info.configure(
                    text=f"📊 {file_name} ({size_mb:.1f} MB)",
                    fg='#27ae60'
                )
                
        except Exception as e:
            messagebox.showerror("Error", f"Failed to select document: {str(e)}")

    def load_teachers(self):
        # Clear existing data
        for i in self.teachers_tree.get_children(): 
            self.teachers_tree.delete(i)
            
        # Load teachers from database with enhanced formatting
        self.cursor.execute('''
            SELECT t.id, t.name, c.class_name, t.hire_date, t.starting_salary, t.phone, t.email
            FROM teachers t
            LEFT JOIN classes c ON t.class_id = c.id
            ORDER BY t.name
        ''')
        
        for teacher in self.cursor.fetchall():
            # Format the data for display
            formatted_teacher = (
                teacher[0],  # ID
                teacher[1],  # Name
                teacher[2] or "No Class Assigned",  # Class name
                teacher[3],  # Hire date
                f"GHS {teacher[4]:.2f}" if teacher[4] else "Not Set",  # Formatted salary
                teacher[5] or "N/A",  # Phone
                teacher[6] or "N/A",  # Email
                "✅ Active"  # Status (assuming all are active for now)
            )
            self.teachers_tree.insert('', tk.END, values=formatted_teacher)
            
        # Update statistics after loading
        self.update_teacher_statistics()

    def on_teacher_select(self, event):
        sel = self.teachers_tree.selection()
        if not sel: return
        
        # Get teacher ID and fetch full details
        teacher_id = self.teachers_tree.item(sel[0])['values'][0]
        
        self.cursor.execute("""
            SELECT t.*, c.class_name 
            FROM teachers t 
            LEFT JOIN classes c ON t.class_id = c.id 
            WHERE t.id = ?
        """, (teacher_id,))
        
        teacher_data = self.cursor.fetchone()
        if not teacher_data:
            return
            
        # Populate form fields
        self.teacher_name_entry.delete(0, tk.END)
        self.teacher_name_entry.insert(0, teacher_data[2] or '')  # name
        
        # Handle hire date
        hire_date = teacher_data[3] or date.today().strftime("%Y-%m-%d")
        try:
            hire_date_obj = datetime.strptime(hire_date, "%Y-%m-%d").date()
            self.teacher_hire_entry.set_date(hire_date_obj)
        except:
            self.teacher_hire_entry.set_date(date.today())
        
        # Set class
        self.teacher_class_var.set(teacher_data[12] if teacher_data[12] else "None")
        
        # Set salary (remove "GHS" prefix if present)
        salary_str = str(teacher_data[5] or 0)
        if salary_str.startswith("GHS "):
            salary_str = salary_str[4:]
        self.teacher_salary_entry.delete(0, tk.END)
        self.teacher_salary_entry.insert(0, salary_str)
        
        # Set phone and email
        self.teacher_phone_entry.delete(0, tk.END)
        self.teacher_phone_entry.insert(0, teacher_data[9] or '')  # phone
        
        self.teacher_email_entry.delete(0, tk.END)
        self.teacher_email_entry.insert(0, teacher_data[10] or '')  # email
        
        # Load qualifications
        qualifications = teacher_data[6] or ''  # qualifications
        self.teacher_qualifications_text.delete('1.0', tk.END)
        if qualifications:
            self.teacher_qualifications_text.insert('1.0', qualifications)
            self.teacher_qualifications_text.config(fg='#2c3e50')
        else:
            placeholder_qual = "Enter educational qualifications (e.g., Bachelor of Education, Master's in Mathematics, Teaching Certificate, etc.)"
            self.teacher_qualifications_text.insert('1.0', placeholder_qual)
            self.teacher_qualifications_text.config(fg='#95a5a6')
        
        # Load skills
        skills = teacher_data[7] or ''  # skills
        self.teacher_skills_text.delete('1.0', tk.END)
        if skills:
            self.teacher_skills_text.insert('1.0', skills)
            self.teacher_skills_text.config(fg='#2c3e50')
        else:
            placeholder_skills = "Enter additional skills (e.g., Computer literacy, Language proficiency, Sports coaching, Music, etc.)"
            self.teacher_skills_text.insert('1.0', placeholder_skills)
            self.teacher_skills_text.config(fg='#95a5a6')
        
        # Load multiple documents from teacher_documents table
        self.cursor.execute("SELECT document_path FROM teacher_documents WHERE teacher_id = ?", (teacher_id,))
        documents = self.cursor.fetchall()
        
        # Initialize documents list and update display
        if hasattr(self, 'teacher_documents'):
            self.teacher_documents.clear()
        else:
            self.teacher_documents = []
            
        for doc in documents:
            doc_path = doc[0]
            if doc_path and os.path.exists(doc_path):
                self.teacher_documents.append(doc_path)
        
        # Update documents display
        if hasattr(self, 'update_teacher_documents_display'):
            self.update_teacher_documents_display()
        
        # Load photo data
        photo_data = teacher_data[11] if len(teacher_data) > 11 else None  # photo (BLOB)
        if photo_data and CAMERA_AVAILABLE:
            try:
                # Convert BLOB to PIL Image
                image = Image.open(io.BytesIO(photo_data))
                # Resize for display
                image = image.resize((120, 120), Image.Resampling.LANCZOS)
                photo = ImageTk.PhotoImage(image)
                
                # Update photo label
                self.teacher_photo_label.configure(image=photo, text="")
                self.teacher_photo_label.image = photo  # Keep a reference
                
                # Store original photo data
                self.teacher_photo_data = photo_data
                
            except Exception as e:
                print(f"Error loading photo: {e}")
                self.clear_teacher_photo()
        else:
            self.clear_teacher_photo()

    def add_teacher_document(self):
        """Add a document to the teacher's document list"""
        filetypes = (
            ('PDF files', '*.pdf'),
            ('Word documents', '*.doc *.docx'),
            ('Image files', '*.jpg *.jpeg *.png *.gif'),
            ('Text files', '*.txt'),
            ('All files', '*.*')
        )
        
        filenames = filedialog.askopenfilenames(
            title='Select Documents (multiple files allowed)',
            initialdir='/',
            filetypes=filetypes
        )
        
        if filenames:
            # Create documents directory if it doesn't exist
            docs_dir = self.get_data_directory('teacher_documents')
            if not os.path.exists(docs_dir):
                os.makedirs(docs_dir)
            
            for filename in filenames:
                # Copy file to documents directory with unique name
                file_extension = os.path.splitext(filename)[1]
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S_%f')[:-3]  # Include milliseconds
                original_name = os.path.splitext(os.path.basename(filename))[0]
                new_filename = f"teacher_doc_{timestamp}_{original_name}{file_extension}"
                new_path = os.path.join(docs_dir, new_filename)
                
                try:
                    shutil.copy2(filename, new_path)
                    
                    # Add to documents list if not already present
                    if new_path not in self.teacher_documents:
                        self.teacher_documents.append(new_path)
                    
                except Exception as e:
                    messagebox.showerror("Error", f"Failed to copy {os.path.basename(filename)}: {str(e)}")
                    continue
            
            # Update the documents display
            self.update_teacher_documents_display()
    
    def clear_teacher_documents(self):
        """Clear all teacher documents"""
        if self.teacher_documents and messagebox.askyesno("Confirm", "Remove all documents from the list?"):
            self.teacher_documents.clear()
            self.update_teacher_documents_display()
    
    def remove_teacher_document(self, doc_path):
        """Remove a specific document from the list"""
        if doc_path in self.teacher_documents:
            self.teacher_documents.remove(doc_path)
            self.update_teacher_documents_display()
    
    def update_teacher_documents_display(self):
        """Update the display of uploaded documents"""
        # Clear existing document widgets
        for widget in self.teacher_docs_container.winfo_children():
            widget.destroy()
        
        if not self.teacher_documents:
            # Show no documents message
            self.no_docs_label = tk.Label(self.teacher_docs_container, text="No documents uploaded", 
                                         font=('Segoe UI', 9, 'italic'), bg='#f8f9fa', fg='#7f8c8d')
            self.no_docs_label.pack(anchor=tk.W)
        else:
            # Display each document
            for i, doc_path in enumerate(self.teacher_documents):
                doc_frame = tk.Frame(self.teacher_docs_container, bg='#ffffff', relief=tk.SOLID, bd=1)
                doc_frame.pack(fill=tk.X, pady=(0, 5))
                
                # Document info frame
                info_frame = tk.Frame(doc_frame, bg='#ffffff')
                info_frame.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=8, pady=5)
                
                # Document name and size
                doc_name = os.path.basename(doc_path)
                if len(doc_name) > 40:
                    display_name = doc_name[:37] + "..."
                else:
                    display_name = doc_name
                
                name_label = tk.Label(info_frame, text=f"📊 {display_name}", 
                                     font=('Segoe UI', 9, 'bold'), bg='#ffffff', fg='#2c3e50')
                name_label.pack(anchor=tk.W)
                
                # File size and status
                try:
                    if os.path.exists(doc_path):
                        file_size = os.path.getsize(doc_path)
                        size_mb = file_size / (1024 * 1024)
                        status_text = f"✅ {size_mb:.2f} MB"
                        status_color = '#27ae60'
                    else:
                        status_text = "❌ File not found"
                        status_color = '#e74c3c'
                except:
                    status_text = "❓ Unknown"
                    status_color = '#f39c12'
                
                status_label = tk.Label(info_frame, text=status_text, 
                                       font=('Segoe UI', 8), bg='#ffffff', fg=status_color)
                status_label.pack(anchor=tk.W)
                
                # Remove button
                remove_btn = tk.Button(doc_frame, text="🧹", font=('Segoe UI', 10), 
                                      bg='#e74c3c', fg='white', relief=tk.FLAT, bd=0,
                                      width=3, command=lambda dp=doc_path: self.remove_teacher_document(dp))
                remove_btn.pack(side=tk.RIGHT, padx=5, pady=5)
                
                # Hover effects for remove button
                def on_enter(e, btn=remove_btn):
                    btn.config(bg='#c0392b')
                def on_leave(e, btn=remove_btn):
                    btn.config(bg='#e74c3c')
                
                remove_btn.bind("<Enter>", on_enter)
                remove_btn.bind("<Leave>", on_leave)
    
    def browse_teacher_document(self):
        """Legacy method - redirects to add_teacher_document for compatibility"""
        self.add_teacher_document()

    def add_teacher(self):
        name = self.teacher_name_entry.get().strip()
        
        # Handle DateEntry for hire date
        hire = self.teacher_hire_entry.get_date().strftime('%Y-%m-%d')
            
        class_name = self.teacher_class_var.get().strip()
        salary = self.teacher_salary_entry.get().strip() or 0
        phone = self.teacher_phone_entry.get().strip()
        email = self.teacher_email_entry.get().strip()
        
        # Get qualifications and skills
        qualifications = self.teacher_qualifications_text.get('1.0', 'end-1c').strip()
        placeholder_qual = "Enter educational qualifications (e.g., Bachelor of Education, Master's in Mathematics, Teaching Certificate, etc.)"
        if qualifications == placeholder_qual:
            qualifications = ""
            
        skills = self.teacher_skills_text.get('1.0', 'end-1c').strip()
        placeholder_skills = "Enter additional skills (e.g., Computer literacy, Language proficiency, Sports coaching, Music, etc.)"
        if skills == placeholder_skills:
            skills = ""
            
        document_path = self.teacher_file_path_var.get().strip()
        
        # Get photo data
        photo_data = None
        if hasattr(self, 'teacher_photo_data') and self.teacher_photo_data:
            photo_data = self.teacher_photo_data
        
        class_id = None
        if class_name:
            self.cursor.execute("SELECT id FROM classes WHERE class_name = ?", (class_name,))
            r = self.cursor.fetchone(); class_id = r[0] if r else None
            
        if not name:
            messagebox.showerror("Error","Enter teacher name")
            return
            
        if not qualifications:
            messagebox.showerror("Error", "Please enter educational qualifications")
            return
            
        try:
            # Insert teacher without document_path (will be handled separately)
            self.cursor.execute("""INSERT INTO teachers 
                               (name, hire_date, class_id, starting_salary, qualifications, 
                                skills, phone, email, photo) 
                               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                                (name, hire, class_id, float(salary), qualifications, 
                                 skills, phone, email, photo_data))
            
            # Get the newly inserted teacher ID
            teacher_id = self.cursor.lastrowid
            
            # Insert multiple documents
            for doc_path in getattr(self, 'teacher_documents', []):
                if os.path.exists(doc_path):
                    doc_name = os.path.basename(doc_path)
                    file_size = os.path.getsize(doc_path)
                    self.cursor.execute("""INSERT INTO teacher_documents 
                                         (teacher_id, document_path, document_name, file_size) 
                                         VALUES (?, ?, ?, ?)""",
                                        (teacher_id, doc_path, doc_name, file_size))
            
            self.conn.commit()
            self.clear_teacher_form()
            self.load_teachers()
            messagebox.showinfo("Success", "Teacher added successfully!")
        except Exception as e:
            messagebox.showerror("Error", str(e))

    def update_teacher(self):
        sel = self.teachers_tree.selection()
        if not sel: 
            messagebox.showerror("Error","Select teacher")
            return
            
        tid = self.teachers_tree.item(sel[0])['values'][0]
        name = self.teacher_name_entry.get().strip()
        
        # Handle DateEntry for hire date
        hire = self.teacher_hire_entry.get_date().strftime('%Y-%m-%d')
            
        class_name = self.teacher_class_var.get().strip()
        salary = self.teacher_salary_entry.get().strip() or 0
        phone = self.teacher_phone_entry.get().strip()
        email = self.teacher_email_entry.get().strip()
        
        # Get qualifications and skills
        qualifications = self.teacher_qualifications_text.get('1.0', 'end-1c').strip()
        placeholder_qual = "Enter educational qualifications (e.g., Bachelor of Education, Master's in Mathematics, Teaching Certificate, etc.)"
        if qualifications == placeholder_qual:
            qualifications = ""
            
        skills = self.teacher_skills_text.get('1.0', 'end-1c').strip()
        placeholder_skills = "Enter additional skills (e.g., Computer literacy, Language proficiency, Sports coaching, Music, etc.)"
        if skills == placeholder_skills:
            skills = ""
            
        document_path = self.teacher_file_path_var.get().strip()
        
        # Get photo data
        photo_data = None
        if hasattr(self, 'teacher_photo_data') and self.teacher_photo_data:
            photo_data = self.teacher_photo_data
        
        class_id = None
        if class_name and class_name != "None":
            self.cursor.execute("SELECT id FROM classes WHERE class_name = ?", (class_name,))
            r = self.cursor.fetchone()
            class_id = r[0] if r else None
            
        if not qualifications:
            messagebox.showerror("Error", "Please enter educational qualifications")
            return
            
        try:
            # Update teacher information (without document_path)
            if photo_data:
                self.cursor.execute("""UPDATE teachers SET 
                                   name=?, hire_date=?, class_id=?, starting_salary=?, 
                                   qualifications=?, skills=?, phone=?, email=?, photo=? 
                                   WHERE id=?""",
                                    (name, hire, class_id, float(salary), qualifications, 
                                     skills, phone, email, photo_data, tid))
            else:
                self.cursor.execute("""UPDATE teachers SET 
                                   name=?, hire_date=?, class_id=?, starting_salary=?, 
                                   qualifications=?, skills=?, phone=?, email=? 
                                   WHERE id=?""",
                                    (name, hire, class_id, float(salary), qualifications, 
                                     skills, phone, email, tid))
            
            # Update documents - first delete existing ones
            self.cursor.execute("DELETE FROM teacher_documents WHERE teacher_id = ?", (tid,))
            
            # Insert current documents
            for doc_path in getattr(self, 'teacher_documents', []):
                if os.path.exists(doc_path):
                    doc_name = os.path.basename(doc_path)
                    file_size = os.path.getsize(doc_path)
                    self.cursor.execute("""INSERT INTO teacher_documents 
                                         (teacher_id, document_path, document_name, file_size) 
                                         VALUES (?, ?, ?, ?)""",
                                        (tid, doc_path, doc_name, file_size))
            
            self.conn.commit()
            self.load_teachers()
            messagebox.showinfo("Success", "Teacher updated successfully!")
        except Exception as e:
            messagebox.showerror("Error", str(e))
    
    def clear_teacher_form(self):
        """Clear all teacher form fields"""
        self.teacher_name_entry.delete(0, tk.END)
        
        self.teacher_hire_entry.set_date(date.today())
            
        self.teacher_salary_entry.delete(0, tk.END)
        self.teacher_class_var.set("")
        self.teacher_phone_entry.delete(0, tk.END)
        self.teacher_email_entry.delete(0, tk.END)
        
        # Clear qualifications text area
        self.teacher_qualifications_text.delete('1.0', tk.END)
        placeholder_qual = "Enter educational qualifications (e.g., Bachelor of Education, Master's in Mathematics, Teaching Certificate, etc.)"
        self.teacher_qualifications_text.insert('1.0', placeholder_qual)
        self.teacher_qualifications_text.config(fg='#95a5a6')
        
        # Clear skills text area
        self.teacher_skills_text.delete('1.0', tk.END)
        placeholder_skills = "Enter additional skills (e.g., Computer literacy, Language proficiency, Sports coaching, Music, etc.)"
        self.teacher_skills_text.insert('1.0', placeholder_skills)
        self.teacher_skills_text.config(fg='#95a5a6')
        
        # Clear documents list
        if hasattr(self, 'teacher_documents'):
            self.teacher_documents.clear()
            self.update_teacher_documents_display()
        
        # Clear photo
        if hasattr(self, 'clear_teacher_photo'):
            self.clear_teacher_photo()

    def delete_teacher(self):
        sel = self.teachers_tree.selection()
        if not sel: messagebox.showerror("Error","Select teacher"); return
        tid = self.teachers_tree.item(sel[0])['values'][0]
        if messagebox.askyesno("Confirm","Delete selected teacher?"):
            try:
                self.cursor.execute("DELETE FROM teachers WHERE id = ?", (tid,))
                self.conn.commit(); self.load_teachers(); messagebox.showinfo("Success","Teacher deleted")
            except Exception as e:
                messagebox.showerror("Error", str(e))

    def generate_teacher_profile(self):
        """Generate a comprehensive teacher profile for printing"""
        sel = self.teachers_tree.selection()
        if not sel:
            messagebox.showerror("Error", "Please select a teacher to generate profile")
            return
            
        teacher_id = self.teachers_tree.item(sel[0])['values'][0]
        
        try:
            # Get teacher details
            self.cursor.execute("""
                SELECT t.*, c.class_name 
                FROM teachers t
                LEFT JOIN classes c ON t.class_id = c.id
                WHERE t.id = ?
            """, (teacher_id,))
            
            teacher_data = self.cursor.fetchone()
            if not teacher_data:
                messagebox.showerror("Error", "Teacher not found")
                return
            
            # Create profile window
            profile_window = tk.Toplevel(self.root)
            profile_window.title("Teacher Profile - Print Preview")
            profile_window.geometry("800x1000")
            profile_window.configure(bg='#ffffff')
            profile_window.resizable(True, True)
            
            # Make window modal
            profile_window.grab_set()
            profile_window.transient(self.root)
            
            # Center the window
            profile_window.geometry("+{}+{}".format(
                int(profile_window.winfo_screenwidth()/2 - 400),
                int(profile_window.winfo_screenheight()/2 - 500)
            ))
            
            # Create scrollable frame for the profile
            profile_scroll = ScrollableFrame(profile_window, bg='#ffffff')
            profile_scroll.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
            profile_frame = profile_scroll.get_frame()
            
            # Profile header with school info
            header_frame = tk.Frame(profile_frame, bg='#ffffff', relief=tk.SOLID, bd=2)
            header_frame.pack(fill=tk.X, pady=(0, 20))
            
            # School header
            school_header = tk.Frame(header_frame, bg='#2c3e50')
            school_header.pack(fill=tk.X)
            
            # Header container with logo and text
            header_container = tk.Frame(school_header, bg='#2c3e50')
            header_container.pack(fill=tk.X, padx=20, pady=15)
            
            # Logo on the left
            try:
                if os.path.exists('logo.png') and PIL_AVAILABLE:
                    logo_img = Image.open('logo.png')
                    logo_img = logo_img.resize((60, 60), Image.Resampling.LANCZOS)
                    self.report_logo = ImageTk.PhotoImage(logo_img)
                    
                    logo_label = tk.Label(header_container, image=self.report_logo, bg='#2c3e50')
                    logo_label.pack(side=tk.LEFT, padx=(0, 15))
            except Exception as e:
                print(f"Could not load report logo: {e}")
            
            # School info on the right
            school_info = tk.Frame(header_container, bg='#2c3e50')
            school_info.pack(side=tk.LEFT, fill=tk.X, expand=True)
            
            school_title = tk.Label(school_info, text="GAYBECK STARKIDS ACADEMY",
                                   font=('Segoe UI', 18, 'bold'), fg='white', bg='#2c3e50')
            school_title.pack(anchor=tk.W)
            
            profile_title = tk.Label(school_info, text="TEACHER PROFILE REPORT",
                                    font=('Segoe UI', 14, 'bold'), fg='#ecf0f1', bg='#2c3e50')
            profile_title.pack(pady=(5, 0))
            
            # Teacher photo and basic info section
            basic_info_frame = tk.Frame(header_frame, bg='#ffffff')
            basic_info_frame.pack(fill=tk.X, padx=20, pady=20)
            
            # Left side - Photo
            photo_frame = tk.Frame(basic_info_frame, bg='#f8f9fa', relief=tk.SOLID, bd=1)
            photo_frame.pack(side=tk.LEFT, padx=(0, 20))
            
            # Display photo if available
            if teacher_data[10] and CAMERA_AVAILABLE:  # photo column
                try:
                    photo_data = teacher_data[10]
                    image = Image.open(io.BytesIO(photo_data))
                    image = image.resize((150, 150), Image.Resampling.LANCZOS)
                    photo = ImageTk.PhotoImage(image)
                    
                    photo_label = tk.Label(photo_frame, image=photo, bg='#f8f9fa')
                    photo_label.image = photo  # Keep reference
                    photo_label.pack(padx=15, pady=15)
                except Exception as e:
                    # Placeholder photo
                    placeholder_label = tk.Label(photo_frame, text="📸\nNo Photo\nAvailable",
                                                font=('Segoe UI', 12), fg='#7f8c8d', bg='#f8f9fa',
                                                justify=tk.CENTER)
                    placeholder_label.pack(padx=50, pady=50)
            else:
                # Placeholder photo
                placeholder_label = tk.Label(photo_frame, text="📸\nNo Photo\nAvailable",
                                            font=('Segoe UI', 12), fg='#7f8c8d', bg='#f8f9fa',
                                            justify=tk.CENTER)
                placeholder_label.pack(padx=50, pady=50)
            
            # Right side - Basic information
            info_frame = tk.Frame(basic_info_frame, bg='#ffffff')
            info_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
            
            # Teacher name
            name_label = tk.Label(info_frame, text=f"Name: {teacher_data[1] or 'N/A'}",
                                 font=('Segoe UI', 16, 'bold'), fg='#2c3e50', bg='#ffffff', anchor='w')
            name_label.pack(fill=tk.X, pady=(0, 10))
            
            # Employee ID
            id_label = tk.Label(info_frame, text=f"Employee ID: T{teacher_data[0]:04d}",
                               font=('Segoe UI', 12), fg='#34495e', bg='#ffffff', anchor='w')
            id_label.pack(fill=tk.X, pady=(0, 5))
            
            # Hire date
            hire_date = teacher_data[2] or 'N/A'
            hire_label = tk.Label(info_frame, text=f"Hire Date: {hire_date}",
                                 font=('Segoe UI', 12), fg='#34495e', bg='#ffffff', anchor='w')
            hire_label.pack(fill=tk.X, pady=(0, 5))
            
            # Class assigned
            class_name = teacher_data[11] or 'No class assigned'
            class_label = tk.Label(info_frame, text=f"Assigned Class: {class_name}",
                                  font=('Segoe UI', 12), fg='#34495e', bg='#ffffff', anchor='w')
            class_label.pack(fill=tk.X, pady=(0, 5))
            
            # Salary
            salary = f"GH┬ó {teacher_data[4]:,.2f}" if teacher_data[4] else 'Not specified'
            salary_label = tk.Label(info_frame, text=f"Starting Salary: {salary}",
                                   font=('Segoe UI', 12), fg='#34495e', bg='#ffffff', anchor='w')
            salary_label.pack(fill=tk.X, pady=(0, 5))
            
            # Contact information section
            contact_section = tk.Frame(profile_frame, bg='#ffffff', relief=tk.SOLID, bd=1)
            contact_section.pack(fill=tk.X, pady=(0, 20))
            
            contact_header = tk.Label(contact_section, text="📞 Contact Information",
                                     font=('Segoe UI', 14, 'bold'), fg='#ffffff', bg='#3498db')
            contact_header.pack(fill=tk.X, padx=0, pady=0, ipady=10)
            
            contact_content = tk.Frame(contact_section, bg='#ffffff')
            contact_content.pack(fill=tk.X, padx=20, pady=15)
            
            phone_info = tk.Label(contact_content, text=f"Phone: {teacher_data[8] or 'Not provided'}",
                                 font=('Segoe UI', 12), fg='#2c3e50', bg='#ffffff', anchor='w')
            phone_info.pack(fill=tk.X, pady=(0, 8))
            
            email_info = tk.Label(contact_content, text=f"Email: {teacher_data[9] or 'Not provided'}",
                                 font=('Segoe UI', 12), fg='#2c3e50', bg='#ffffff', anchor='w')
            email_info.pack(fill=tk.X)
            
            # Qualifications section
            qual_section = tk.Frame(profile_frame, bg='#ffffff', relief=tk.SOLID, bd=1)
            qual_section.pack(fill=tk.X, pady=(0, 20))
            
            qual_header = tk.Label(qual_section, text="🎓 Educational Qualifications",
                                  font=('Segoe UI', 14, 'bold'), fg='#ffffff', bg='#9b59b6')
            qual_header.pack(fill=tk.X, padx=0, pady=0, ipady=10)
            
            qual_content = tk.Frame(qual_section, bg='#ffffff')
            qual_content.pack(fill=tk.X, padx=20, pady=15)
            
            qualifications = teacher_data[5] or 'No qualifications listed'
            qual_text = tk.Text(qual_content, height=4, font=('Segoe UI', 11), 
                               bg='#f8f9fa', fg='#2c3e50', wrap=tk.WORD, relief=tk.FLAT, bd=0)
            qual_text.pack(fill=tk.X, pady=(0, 10))
            qual_text.insert('1.0', qualifications)
            qual_text.config(state='disabled')
            
            # Skills section
            skills_section = tk.Frame(profile_frame, bg='#ffffff', relief=tk.SOLID, bd=1)
            skills_section.pack(fill=tk.X, pady=(0, 20))
            
            skills_header = tk.Label(skills_section, text="💡 Additional Skills & Competencies",
                                    font=('Segoe UI', 14, 'bold'), fg='#ffffff', bg='#e67e22')
            skills_header.pack(fill=tk.X, padx=0, pady=0, ipady=10)
            
            skills_content = tk.Frame(skills_section, bg='#ffffff')
            skills_content.pack(fill=tk.X, padx=20, pady=15)
            
            skills = teacher_data[6] or 'No additional skills listed'
            skills_text = tk.Text(skills_content, height=3, font=('Segoe UI', 11),
                                 bg='#f8f9fa', fg='#2c3e50', wrap=tk.WORD, relief=tk.FLAT, bd=0)
            skills_text.pack(fill=tk.X, pady=(0, 10))
            skills_text.insert('1.0', skills)
            skills_text.config(state='disabled')
            
            # Footer with generation info
            footer_frame = tk.Frame(profile_frame, bg='#ecf0f1', relief=tk.SOLID, bd=1)
            footer_frame.pack(fill=tk.X, pady=(20, 0))
            
            footer_content = tk.Frame(footer_frame, bg='#ecf0f1')
            footer_content.pack(fill=tk.X, padx=20, pady=15)
            
            from datetime import datetime
            generation_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            footer_text = tk.Label(footer_content, 
                                  text=f"Profile generated on: {generation_time} | Gaybeck Starkids Academy",
                                  font=('Segoe UI', 10), fg='#7f8c8d', bg='#ecf0f1', anchor='w')
            footer_text.pack(fill=tk.X)
            
            # Print button frame
            button_frame = tk.Frame(profile_window, bg='#ffffff')
            button_frame.pack(fill=tk.X, padx=20, pady=(10, 20))
            
            print_btn = tk.Button(button_frame, text="🖨️ Print Profile", 
                                 font=('Segoe UI', 12, 'bold'), bg='#27ae60', fg='white',
                                 relief=tk.FLAT, bd=0, pady=10,
                                 command=lambda: self.print_teacher_profile(profile_frame))
            print_btn.pack(side=tk.LEFT, padx=(0, 10), fill=tk.X, expand=True)
            
            close_btn = tk.Button(button_frame, text="❌ Close", 
                                 font=('Segoe UI', 12, 'bold'), bg='#95a5a6', fg='white',
                                 relief=tk.FLAT, bd=0, pady=10,
                                 command=profile_window.destroy)
            close_btn.pack(side=tk.LEFT, fill=tk.X, expand=True)
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate profile: {str(e)}")
    
    def print_teacher_profile(self, profile_frame):
        """Print the teacher profile"""
        try:
            # Create a temporary window for printing
            print_window = tk.Toplevel()
            print_window.withdraw()  # Hide the window
            
            # Configure for printing
            print_window.configure(bg='white')
            
            # You can implement actual printing here using libraries like:
            # - win32print (Windows)
            # - reportlab for PDF generation
            # - or system print dialog
            
            # For now, show a message
            messagebox.showinfo("Print", 
                               "Profile ready for printing!\n\n"
                               "You can:\n"
                               "• Use Ctrl+P to print this window\n"
                               "• Take a screenshot\n"
                               "• Copy the content to a document\n\n"
                               "For advanced printing features, consider adding a PDF export option.")
            
            print_window.destroy()
            
        except Exception as e:
            messagebox.showerror("Print Error", f"Failed to print profile: {str(e)}")

    def show_attendance(self):
        self.clear_content_frame()
        
        # Create scrollable frame for attendance
        scrollable_attendance = ScrollableFrame(self.content_frame, bg='#ffffff')
        scrollable_attendance.pack(fill=tk.BOTH, expand=True)
        attendance_main_frame = scrollable_attendance.get_frame()
        
        # Modern attendance header
        header_section = tk.Frame(attendance_main_frame, relief=tk.FLAT, bd=0)
        header_section.pack(fill=tk.X, padx=0, pady=(0, 25))
        
        title = tk.Label(header_section, text="📝 Attendance Management",
                         font=('Segoe UI', 28, 'bold'), fg='#2c3e50')
        title.pack(anchor=tk.W)
        
        subtitle = tk.Label(header_section, text="Track daily student attendance and manage records",
                           font=('Segoe UI', 14), fg='#7f8c8d')
        subtitle.pack(anchor=tk.W, pady=(5, 0))

        # Control panel with modern styling
        control_panel = tk.Frame(attendance_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        control_panel.pack(fill=tk.X, padx=0, pady=(0, 20))
        
        # Inner control container for better spacing
        control_inner = tk.Frame(control_panel, bg='#f8f9fa')
        control_inner.pack(fill=tk.X, padx=25, pady=20)
        
        # Date selection section
        date_section = tk.Frame(control_inner, bg='#f8f9fa')
        date_section.pack(fill=tk.X, pady=(0, 15))
        
        date_label = tk.Label(date_section, text="✅ Select Date:", 
                             font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        date_label.pack(side=tk.LEFT)
        
        if CALENDAR_AVAILABLE:
            self.att_date_entry = DateEntry(date_section, width=12, background='#3498db',
                                           foreground='white', borderwidth=0, date_pattern='y-mm-dd',
                                           font=('Segoe UI', 11))
        else:
            self.att_date_entry = tk.Entry(date_section, width=15, font=('Segoe UI', 11))
            self.att_date_entry.insert(0, date.today().strftime("%Y-%m-%d"))
        self.att_date_entry.pack(side=tk.LEFT, padx=(10, 20))
        
        # Current date display
        current_date = datetime.now().strftime("%A, %B %d, %Y")
        current_label = tk.Label(date_section, text=f"Today: {current_date}",
                               font=('Segoe UI', 10), bg='#f8f9fa', fg='#7f8c8d')
        current_label.pack(side=tk.RIGHT)
        
        # Search section for attendance
        search_section = tk.Frame(control_inner, bg='#f8f9fa')
        search_section.pack(fill=tk.X, pady=(0, 15))
        
        search_label = tk.Label(search_section, text="🔍 Search Student:", 
                               font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        search_label.pack(side=tk.LEFT)
        
        self.att_search_var = tk.StringVar()
        search_entry = AutocompleteEntry(search_section, textvariable=self.att_search_var, width=25, 
                               font=('Segoe UI', 11),
                               suggestions_callback=self.get_student_suggestions)
        search_entry.pack(side=tk.LEFT, padx=(10, 15))
        
        search_att_btn = self.create_modern_button(search_section, "🔍 Filter Student", 
                                                  self.search_attendance_student, 'primary', width=15)
        search_att_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        clear_att_btn = self.create_modern_button(search_section, "🔄 Show All", 
                                                 self.clear_attendance_search, 'secondary', width=12)
        clear_att_btn.pack(side=tk.LEFT)
        
        # Action buttons section
        buttons_section = tk.Frame(control_inner, bg='#f8f9fa')
        buttons_section.pack(fill=tk.X)
        
        # Left side buttons
        left_buttons = tk.Frame(buttons_section, bg='#f8f9fa')
        left_buttons.pack(side=tk.LEFT)
        
        load_btn = self.create_modern_button(left_buttons, "🔄 Load Attendance", 
                                           self.load_attendance, 'primary', width=15)
        load_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        present_btn = self.create_modern_button(left_buttons, "✅ Mark Present", 
                                              lambda: self.toggle_selected_attendance(True), 'success', width=15)
        present_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        absent_btn = self.create_modern_button(left_buttons, "❌ Mark Absent", 
                                             lambda: self.toggle_selected_attendance(False), 'danger', width=15)
        absent_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        # Right side buttons
        right_buttons = tk.Frame(buttons_section, bg='#f8f9fa')
        right_buttons.pack(side=tk.RIGHT)
        
        save_btn = self.create_modern_button(right_buttons, "💾 Save Changes", 
                                           self.save_bulk_attendance, 'warning', width=15)
        save_btn.pack(side=tk.LEFT)

        # Attendance data section
        data_section = tk.Frame(attendance_main_frame, bg='#ffffff')
        data_section.pack(fill=tk.BOTH, expand=True, padx=0)
        
        # Table header
        table_header = tk.Frame(data_section, bg='#ffffff')
        table_header.pack(fill=tk.X, pady=(0, 15))
        
        header_content = tk.Frame(table_header, bg='#34495e', relief=tk.FLAT)
        header_content.pack(fill=tk.X)
        
        tk.Label(header_content, text="👥 Student Attendance Records", 
                font=('Segoe UI', 16, 'bold'), bg='#34495e', fg='white', pady=15).pack()
        
        # Statistics panel
        stats_panel = tk.Frame(data_section, bg='#ecf0f1', relief=tk.FLAT, bd=0)
        stats_panel.pack(fill=tk.X, pady=(0, 15))
        
        stats_inner = tk.Frame(stats_panel, bg='#ecf0f1')
        stats_inner.pack(fill=tk.X, padx=20, pady=15)
        
        # Statistics labels that will be updated
        self.total_students_label = tk.Label(stats_inner, text="Total Students: 0", 
                                           font=('Segoe UI', 11, 'bold'), bg='#ecf0f1', fg='#2c3e50')
        self.total_students_label.pack(side=tk.LEFT, padx=(0, 30))
        
        self.present_count_label = tk.Label(stats_inner, text="Present: 0", 
                                          font=('Segoe UI', 11, 'bold'), bg='#ecf0f1', fg='#27ae60')
        self.present_count_label.pack(side=tk.LEFT, padx=(0, 30))
        
        self.absent_count_label = tk.Label(stats_inner, text="Absent: 0", 
                                         font=('Segoe UI', 11, 'bold'), bg='#ecf0f1', fg='#e74c3c')
        self.absent_count_label.pack(side=tk.LEFT, padx=(0, 30))
        
        self.attendance_rate_label = tk.Label(stats_inner, text="Attendance Rate: 0%", 
                                            font=('Segoe UI', 11, 'bold'), bg='#ecf0f1', fg='#3498db')
        self.attendance_rate_label.pack(side=tk.RIGHT)
        
        # Modern table container
        table_container = tk.Frame(data_section, bg='#ffffff', relief=tk.FLAT, bd=0)
        table_container.pack(fill=tk.BOTH, expand=True)
        
        # Enhanced treeview with better styling
        cols = ('ID', 'Student ID', 'Name', 'Present', 'Feeding Paid', 'Bus Paid')
        self.att_tree = ttk.Treeview(table_container, columns=cols, show='headings', height=18)
        
        # Configure column widths and headings
        column_configs = {
            'ID': {'width': 60, 'minwidth': 50},
            'Student ID': {'width': 120, 'minwidth': 80},
            'Name': {'width': 200, 'minwidth': 150},
            'Present': {'width': 100, 'minwidth': 80},
            'Feeding Paid': {'width': 120, 'minwidth': 100},
            'Bus Paid': {'width': 100, 'minwidth': 80}
        }
        
        for col in cols:
            self.att_tree.heading(col, text=col, anchor=tk.CENTER)
            config = column_configs.get(col, {'width': 120, 'minwidth': 80})
            # Align text to the left for better readability
            self.att_tree.column(col, width=config['width'], minwidth=config['minwidth'], anchor=tk.W)
        
        # Configure tags for colored attendance status
        self.att_tree.tag_configure('present', foreground='#27ae60')  # Green
        self.att_tree.tag_configure('absent', foreground='#e74c3c')   # Red
        
        # Scrollbars with grid layout
        v_scrollbar = ttk.Scrollbar(table_container, orient=tk.VERTICAL, command=self.att_tree.yview)
        h_scrollbar = ttk.Scrollbar(table_container, orient=tk.HORIZONTAL, command=self.att_tree.xview)
        self.att_tree.configure(yscrollcommand=v_scrollbar.set, xscrollcommand=h_scrollbar.set)
        
        # Grid layout for better scrollbar positioning
        self.att_tree.grid(row=0, column=0, sticky='nsew')
        v_scrollbar.grid(row=0, column=1, sticky='ns')
        h_scrollbar.grid(row=1, column=0, sticky='ew')
        
        table_container.grid_rowconfigure(0, weight=1)
        table_container.grid_columnconfigure(0, weight=1)
        
        # Instructions panel
        instructions_panel = tk.Frame(attendance_main_frame, bg='#e8f6ff', relief=tk.FLAT, bd=0)
        instructions_panel.pack(fill=tk.X, pady=(15, 0))
        
        instructions_inner = tk.Frame(instructions_panel, bg='#e8f6ff')
        instructions_inner.pack(fill=tk.X, padx=20, pady=15)
        
        tk.Label(instructions_inner, text="💡 Instructions:", 
                font=('Segoe UI', 11, 'bold'), bg='#e8f6ff', fg='#2c3e50').pack(anchor=tk.W)
        
        instructions_text = "Select one or more students and use the Mark Present/Absent buttons. Click Submit Attendance to save all changes."
        tk.Label(instructions_inner, text=instructions_text, 
                font=('Segoe UI', 10), bg='#e8f6ff', fg='#34495e', wraplength=800).pack(anchor=tk.W, pady=(5, 0))

        # Submit section with prominent button
        submit_section = tk.Frame(attendance_main_frame, bg='#ffffff', relief=tk.FLAT, bd=0)
        submit_section.pack(fill=tk.X, pady=(20, 0))
        
        # Center the submit button
        submit_container = tk.Frame(submit_section, bg='#ffffff')
        submit_container.pack(anchor=tk.CENTER, pady=15)
        
        # Large, prominent submit button
        submit_btn = tk.Button(submit_container, 
                              text="📋 SUBMIT ATTENDANCE", 
                              command=self.submit_attendance_form,
                              font=('Segoe UI', 14, 'bold'), 
                              bg='#28a745', 
                              fg='white',
                              relief='solid', 
                              bd=0, 
                              padx=40, 
                              pady=15, 
                              cursor='hand2')
        submit_btn.pack(side=tk.LEFT, padx=(0, 15))
        
        # Add hover effects
        def on_submit_enter(e):
            submit_btn.configure(bg='#218838')
        def on_submit_leave(e):
            submit_btn.configure(bg='#28a745')
            
        submit_btn.bind("<Enter>", on_submit_enter)
        submit_btn.bind("<Leave>", on_submit_leave)
        
        # Reset button next to submit
        reset_btn = tk.Button(submit_container, 
                             text="🔄 RESET FORM", 
                             command=self.reset_attendance_form,
                             font=('Segoe UI', 12, 'bold'), 
                             bg='#6c757d', 
                             fg='white',
                             relief='solid', 
                             bd=0, 
                             padx=30, 
                             pady=15, 
                             cursor='hand2')
        reset_btn.pack(side=tk.LEFT)
        
        # Add hover effects for reset button
        def on_reset_enter(e):
            reset_btn.configure(bg='#545b62')
        def on_reset_leave(e):
            reset_btn.configure(bg='#6c757d')
            
        reset_btn.bind("<Enter>", on_reset_enter)
        reset_btn.bind("<Leave>", on_reset_leave)

        self.load_attendance()
        
        # Ensure scrollable frame is properly updated
        scrollable_attendance.update_scrollregion()

    def load_attendance(self):
        for i in self.att_tree.get_children(): 
            self.att_tree.delete(i)
            
        if CALENDAR_AVAILABLE and hasattr(self.att_date_entry, 'get_date'):
            d = self.att_date_entry.get_date().strftime('%Y-%m-%d')
        else:
            d = self.att_date_entry.get().strip() or date.today().strftime("%Y-%m-%d")
            
        # Get students based on role
        if self.current_user.get('role') == 'admin':
            # Admin sees all active students
            self.cursor.execute("SELECT id, student_id, name FROM students WHERE status='Active' ORDER BY name")
            students = self.cursor.fetchall()
        elif self.current_user.get('role') == 'teacher':
            # Teacher sees only students from their assigned class
            teacher_class_id = self.get_teacher_assigned_class()
            if teacher_class_id:
                self.cursor.execute('''
                    SELECT id, student_id, name FROM students 
                    WHERE status='Active' AND class_id = ? 
                    ORDER BY name
                ''', (teacher_class_id,))
                students = self.cursor.fetchall()
            else:
                students = []
        else:
            # Staff sees all students (for now)
            self.cursor.execute("SELECT id, student_id, name FROM students WHERE status='Active' ORDER BY name")
            students = self.cursor.fetchall()
        
        # Counters for statistics
        total_students = len(students)
        present_count = 0
        
        # Populate attendance rows using existing attendance records if any
        for s in students:
            self.cursor.execute("SELECT present, feeding_fee_paid, bus_fee_paid FROM attendance WHERE student_id = ? AND date = ?", (s[0], d))
            ar = self.cursor.fetchone()
            
            is_present = ar and ar[0]
            # Simple attendance display
              
            present = '✓ Present' if is_present else '❌ Absent'
            
            feeding = 'Paid' if ar and ar[1] else 'Not Paid'
            
            bus = 'Paid' if ar and ar[2] else 'Not Paid'
            
            if is_present:
                present_count += 1
                
            # Insert with enhanced formatting and color tags
            tag = 'present' if is_present else 'absent'
            item = self.att_tree.insert('', tk.END, values=(s[0], s[1] or 'N/A', s[2], present, feeding, bus), tags=(tag,))
        
        # Update statistics
        absent_count = total_students - present_count
        attendance_rate = (present_count / total_students * 100) if total_students > 0 else 0
        
        # Update labels if they exist
        if hasattr(self, 'total_students_label'):
            self.total_students_label.config(text=f"Total Students: {total_students}")
            self.present_count_label.config(text=f"Present: {present_count}")
            self.absent_count_label.config(text=f"Absent: {absent_count}")
            self.attendance_rate_label.config(text=f"Attendance Rate: {attendance_rate:.1f}%")
        
        # Update status bar if available
        if hasattr(self, 'update_status'):
            self.update_status(f"Loaded attendance for {d} - {present_count}/{total_students} students present")
            
        # Get all active students
        self.cursor.execute("SELECT id, student_id, name FROM students WHERE status='Active' ORDER BY name")
        students = self.cursor.fetchall()
        
        # Counters for statistics
        total_students = len(students)
        present_count = 0
        
        # Populate attendance rows using existing attendance records if any
        for s in students:
            self.cursor.execute("SELECT present, feeding_fee_paid, bus_fee_paid FROM attendance WHERE student_id = ? AND date = ?", (s[0], d))
            ar = self.cursor.fetchone()
            
            is_present = ar and ar[0]
            # Simple attendance display
              
            present = '✓ Present' if is_present else '❌ Absent'
            
            feeding = 'Paid' if ar and ar[1] else 'Not Paid'
            
            bus = 'Paid' if ar and ar[2] else 'Not Paid'
            
            if is_present:
                present_count += 1
                
            # Insert with enhanced formatting and color tags
            tag = 'present' if is_present else 'absent'
            item = self.att_tree.insert('', tk.END, values=(s[0], s[1] or 'N/A', s[2], present, feeding, bus), tags=(tag,))
            
            # Color coding for better visual distinction
            if is_present:
                self.att_tree.set(item, 'Present', '✓ Present')
            else:
                self.att_tree.set(item, 'Present', '❌ Absent')
        
        # Update statistics
        absent_count = total_students - present_count
        attendance_rate = (present_count / total_students * 100) if total_students > 0 else 0
        
        self.total_students_label.config(text=f"Total Students: {total_students}")
        self.present_count_label.config(text=f"Present: {present_count}")
        self.absent_count_label.config(text=f"Absent: {absent_count}")
        self.attendance_rate_label.config(text=f"Attendance Rate: {attendance_rate:.1f}%")
        
        # Update status bar
        if hasattr(self, 'update_status'):
            self.update_status(f"Loaded attendance for {d} - {present_count}/{total_students} students present")

    def toggle_selected_attendance(self, present_flag):
        sel = self.att_tree.selection()
        if not sel:
            messagebox.showwarning("⚠️ No Selection", 
                                 "Please select one or more student rows first.\n\n"
                                 "💡 Tip: Click on a student name to select, or hold Ctrl to select multiple students.")
            return
            
        # Update selected students
        updated_students = []
        for s in sel:
            vals = list(self.att_tree.item(s)['values'])
            student_name = vals[2]  # Student name is in column 2
            vals[3] = '✓ Present' if present_flag else '❌ Absent'
            # Apply color tags for visual distinction
            tag = 'present' if present_flag else 'absent'
            self.att_tree.item(s, values=vals, tags=(tag,))
            updated_students.append(student_name)
        
        # Show confirmation and update statistics
        action = "marked present" if present_flag else "marked absent"
        count = len(updated_students)
        
        if hasattr(self, 'update_status'):
            self.update_status(f"{count} student(s) {action}")
        
        # Recalculate statistics after change
        self.update_attendance_statistics()
    
    def update_attendance_statistics(self):
        """Update the attendance statistics display in real-time"""
        if not hasattr(self, 'att_tree'):
            return
            
        total_students = len(list(self.att_tree.get_children()))
        present_count = 0
        
        # Count present students
        for item in self.att_tree.get_children():
            present_value = str(self.att_tree.item(item)['values'][3])
            if '✅' in present_value or 'Present' in present_value:
                present_count += 1
        
        absent_count = total_students - present_count
        attendance_rate = (present_count / total_students * 100) if total_students > 0 else 0
        
        # Update labels if they exist
        if hasattr(self, 'total_students_label'):
            self.total_students_label.config(text=f"Total Students: {total_students}")
            self.present_count_label.config(text=f"Present: {present_count}")
            self.absent_count_label.config(text=f"Absent: {absent_count}")
            self.attendance_rate_label.config(text=f"Attendance Rate: {attendance_rate:.1f}%")

    def save_bulk_attendance(self):
        if CALENDAR_AVAILABLE and hasattr(self.att_date_entry, 'get_date'):
            d = self.att_date_entry.get_date().strftime('%Y-%m-%d')
        else:
            d = self.att_date_entry.get().strip() or date.today().strftime("%Y-%m-%d")
        try:
            for item in self.att_tree.get_children():
                vals = self.att_tree.item(item)['values']
                student_db_id = vals[0]
                # Handle enhanced UI format with emojis
                present_status = str(vals[3])
                present = 1 if ('✅' in present_status or 'Present' in present_status) else 0
                
                # Handle feeding and bus fees with enhanced format
                feeding_status = str(vals[4]) if len(vals) > 4 else 'No'
                feeding = 1 if ('✅' in feeding_status or 'Yes' in feeding_status) else 0
                
                bus_status = str(vals[5]) if len(vals) > 5 else 'No'
                bus = 1 if ('✅' in bus_status or 'Yes' in bus_status) else 0
                # upsert attendance row
                self.cursor.execute("SELECT id FROM attendance WHERE student_id = ? AND date = ?", (student_db_id, d))
                r = self.cursor.fetchone()
                if r:
                    self.cursor.execute("UPDATE attendance SET present=?, feeding_fee_paid=?, bus_fee_paid=? WHERE id=?",
                                        (present, feeding, bus, r[0]))
                else:
                    self.cursor.execute("INSERT INTO attendance (student_id, date, present, feeding_fee_paid, bus_fee_paid) VALUES (?, ?, ?, ?, ?)",
                                        (student_db_id, d, present, feeding, bus))
            self.conn.commit()
            
            # Enhanced success feedback
            present_count = sum(1 for item in self.att_tree.get_children() 
                              if '✅' in str(self.att_tree.item(item)['values'][3]))
            total_count = len(list(self.att_tree.get_children()))
            
            messagebox.showinfo("✅ Success", 
                               f"Attendance saved successfully!\n\n"
                               f"📊 Summary:\n"
                               f"• Total Students: {total_count}\n"
                               f"• Present: {present_count}\n"
                               f"• Absent: {total_count - present_count}\n"
                               f"• Date: {d}")
            
            # Update status bar
            if hasattr(self, 'update_status'):
                self.update_status(f"Attendance saved for {d} - {present_count}/{total_count} students present")
                
            # Refresh the display
            self.load_attendance()
            self.update_dashboard()
        except Exception as e:
            messagebox.showerror("❌ Error", f"Failed to save attendance:\n{str(e)}")
            if hasattr(self, 'update_status'):
                self.update_status("Error saving attendance")

    def search_attendance_student(self):
        """Filter attendance list to show only the searched student"""
        search_term = self.att_search_var.get().strip()
        
        if not search_term:
            messagebox.showinfo("Search", "Please enter a student name or ID to search")
            return
        
        # Clear existing data
        for item in self.att_tree.get_children():
            self.att_tree.delete(item)
        
        if CALENDAR_AVAILABLE and hasattr(self.att_date_entry, 'get_date'):
            d = self.att_date_entry.get_date().strftime('%Y-%m-%d')
        else:
            d = self.att_date_entry.get().strip() or date.today().strftime("%Y-%m-%d")
        
        # Build query based on user role
        if self.current_user.get('role') == 'teacher':
            # Teacher sees only students from their assigned class
            teacher_class_id = self.get_teacher_assigned_class()
            if teacher_class_id:
                query = """
                    SELECT id, student_id, name 
                    FROM students 
                    WHERE status='Active' AND class_id = ? AND (name LIKE ? OR student_id LIKE ?)
                    ORDER BY name
                """
                params = (teacher_class_id, f'%{search_term}%', f'%{search_term}%')
            else:
                messagebox.showinfo("Search Results", "You are not assigned to any class")
                return
        else:
            # Admin and other roles see all students
            query = """
                SELECT id, student_id, name 
                FROM students 
                WHERE status='Active' AND (name LIKE ? OR student_id LIKE ?)
                ORDER BY name
            """
            params = (f'%{search_term}%', f'%{search_term}%')
        
        # Search for matching students
        self.cursor.execute(query, params)
        students = self.cursor.fetchall()
        
        if not students:
            messagebox.showinfo("Search Results", f"No active students found matching '{search_term}'")
            self.update_status(f"No students found for '{search_term}'")
            return
        
        # Display filtered results
        present_count = 0
        
        for s in students:
            self.cursor.execute("SELECT present, feeding_fee_paid, bus_fee_paid FROM attendance WHERE student_id = ? AND date = ?", (s[0], d))
            ar = self.cursor.fetchone()
            
            is_present = ar and ar[0]
            # Simple attendance display
              
            present = '✓ Present' if is_present else '❌ Absent'
            
            feeding = 'Paid' if ar and ar[1] else 'Not Paid'
            
            bus = 'Paid' if ar and ar[2] else 'Not Paid'
            
            if is_present:
                present_count += 1
                
            # Insert with enhanced formatting
            self.att_tree.insert('', tk.END, values=(s[0], s[1] or 'N/A', s[2], present, feeding, bus))
        
        # Update statistics for filtered results
        total_students = len(students)
        absent_count = total_students - present_count
        attendance_rate = (present_count / total_students * 100) if total_students > 0 else 0
        
        # Update labels with filtered indication
        if hasattr(self, 'total_students_label'):
            self.total_students_label.config(text=f"Filtered: {total_students} student(s)")
            self.present_count_label.config(text=f"Present: {present_count}")
            self.absent_count_label.config(text=f"Absent: {absent_count}")
            self.attendance_rate_label.config(text=f"Attendance Rate: {attendance_rate:.1f}%")
        
        # Update status
        self.update_status(f"Found {len(students)} student(s) matching '{search_term}' for {d}")

    def clear_attendance_search(self):
        """Clear the attendance search field and reload all students"""
        self.att_search_var.set("")
        self.load_attendance()
        self.update_status("Showing all students")
    
    def submit_attendance_form(self):
        """Submit the attendance form with validation and confirmation"""
        try:
            # Get the selected date
            if CALENDAR_AVAILABLE and hasattr(self.att_date_entry, 'get_date'):
                selected_date = self.att_date_entry.get_date().strftime('%Y-%m-%d')
            else:
                selected_date = self.att_date_entry.get().strip() or date.today().strftime("%Y-%m-%d")
            
            # Validate that there are students to submit
            if not self.att_tree.get_children():
                messagebox.showwarning("⚠️ No Data", 
                                     "No attendance data to submit. Please load students first.")
                return
            
            # Count attendance statistics for confirmation
            total_students = len(list(self.att_tree.get_children()))
            present_count = 0
            absent_count = 0
            
            for item in self.att_tree.get_children():
                vals = self.att_tree.item(item)['values']
                present_status = str(vals[3])
                if '✅' in present_status or 'Present' in present_status:
                    present_count += 1
                else:
                    absent_count += 1
            
            # Show confirmation dialog with summary
            confirm_message = (f"📋 SUBMIT ATTENDANCE CONFIRMATION\n\n"
                              f"✅ Date: {selected_date}\n"
                              f"👥 Total Students: {total_students}\n"
                              f"✅ Present: {present_count}\n"
                              f"❌ Absent: {absent_count}\n"
                              f"📊 Attendance Rate: {(present_count/total_students*100):.1f}%\n\n"
                              f"Do you want to submit this attendance record?")
            
            if messagebox.askyesno("Confirm Submission", confirm_message):
                # Call the existing save function
                self.save_bulk_attendance()
                
                # Additional success actions
                if hasattr(self, 'update_status'):
                    self.update_status(f"✅ Attendance submitted successfully for {selected_date}")
                
                # Update dashboard if it exists
                if hasattr(self, 'update_dashboard'):
                    self.update_dashboard()
                
                # Show completion message
                messagebox.showinfo("✅ Submission Complete", 
                                   f"Attendance has been successfully submitted!\n\n"
                                   f"✅ Date: {selected_date}\n"
                                   f"✅ Present: {present_count} students\n"
                                   f"❌ Absent: {absent_count} students")
        
        except Exception as e:
            messagebox.showerror("❌ Submission Error", 
                               f"Failed to submit attendance:\n\n{str(e)}")
            if hasattr(self, 'update_status'):
                self.update_status("❌ Error submitting attendance")
    
    def reset_attendance_form(self):
        """Reset the attendance form to default state"""
        if messagebox.askyesno("🔄 Reset Form", 
                              "Are you sure you want to reset the attendance form?\n\n"
                              "This will reload all student data and clear any unsaved changes."):
            try:
                # Clear search if any
                if hasattr(self, 'att_search_var'):
                    self.att_search_var.set('')
                
                # Reset date to today
                today_str = date.today().strftime("%Y-%m-%d")
                if CALENDAR_AVAILABLE and hasattr(self.att_date_entry, 'set_date'):
                    self.att_date_entry.set_date(date.today())
                elif hasattr(self.att_date_entry, 'delete') and hasattr(self.att_date_entry, 'insert'):
                    self.att_date_entry.delete(0, tk.END)
                    self.att_date_entry.insert(0, today_str)
                
                # Reload attendance data
                self.load_attendance()
                
                # Update status
                if hasattr(self, 'update_status'):
                    self.update_status("🔄 Attendance form reset to default state")
                
                messagebox.showinfo("✅ Form Reset", 
                                   f"Attendance form has been reset.\n\n"
                                   f"✅ Date reset to: {today_str}\n"
                                   f"📋 All student data reloaded")
            
            except Exception as e:
                messagebox.showerror("❌ Reset Error", 
                                   f"Failed to reset form:\n\n{str(e)}")
                if hasattr(self, 'update_status'):
                    self.update_status("❌ Error resetting attendance form")

    def show_database_view(self):
        self.clear_content_frame()
        
        # Create scrollable frame for database view
        scrollable_database = ScrollableFrame(self.content_frame, bg='#ffffff')
        scrollable_database.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        database_main_frame = scrollable_database.get_frame()
        
        title = tk.Label(database_main_frame, text="Database View",
                         font=('Arial', 18, 'bold'))
        title.pack(anchor=tk.W, padx=20, pady=10)

        top = tk.Frame(database_main_frame, bg='#ffffff'); top.pack(fill=tk.X, padx=20)
        tk.Label(top, text="Table:", bg='#ffffff').pack(side=tk.LEFT)
        self.cursor.execute("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name")
        tables = [r[0] for r in self.cursor.fetchall()]
        self.db_table_var = tk.StringVar()
        self.db_table_cb = ttk.Combobox(top, textvariable=self.db_table_var, values=tables, state="readonly", width=30)
        self.db_table_cb.pack(side=tk.LEFT, padx=5)
        tk.Button(top, text="Load", command=self.load_db_table, bg='#0066cc', fg='white').pack(side=tk.LEFT, padx=5)

        self.db_tree_frame = tk.Frame(database_main_frame, bg='#ffffff'); self.db_tree_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)
        
        # Ensure scrollable frame is properly updated
        scrollable_database.update_scrollregion()

    def load_db_table(self):
        for w in self.db_tree_frame.winfo_children(): w.destroy()
        table = self.db_table_var.get()
        if not table:
            messagebox.showerror("Error","Select a table"); return
        try:
            self.cursor.execute(f"PRAGMA table_info({table})")
            cols = [c[1] for c in self.cursor.fetchall()]
            tree = ttk.Treeview(self.db_tree_frame, columns=cols, show='headings')
            for c in cols:
                tree.heading(c, text=c); tree.column(c, width=120)
            vs = ttk.Scrollbar(self.db_tree_frame, orient=tk.VERTICAL, command=tree.yview)
            tree.configure(yscrollcommand=vs.set)
            tree.pack(fill=tk.BOTH, expand=True, side=tk.LEFT); vs.pack(side=tk.LEFT, fill=tk.Y)
            self.cursor.execute(f"SELECT * FROM {table} LIMIT 500")
            for r in self.cursor.fetchall():
                tree.insert('', tk.END, values=r)
        except Exception as e:
            messagebox.showerror("Error", str(e))

    # --- Dashboard updater (missing previously) ---
    def update_dashboard(self):
        try:
            today = date.today().strftime("%Y-%m-%d")
            # Students present today
            self.cursor.execute("SELECT COUNT(*) FROM attendance WHERE date = ? AND present = 1", (today,))
            present = self.cursor.fetchone()[0] or 0
            self.students_present_var.set(str(present))
            # Feeding fee collected today (sum amount_paid where feeding flag set)
            self.cursor.execute("SELECT SUM(amount_paid) FROM fees WHERE feeding_fee_paid = 1 AND strftime('%Y-%m-%d', payment_date) = ?", (today,))
            feeding = self.cursor.fetchone()[0] or 0.0
            self.feeding_fee_var.set(f"GHS {feeding:.2f}")
            # Bus fee collected today
            self.cursor.execute("SELECT SUM(amount_paid) FROM fees WHERE bus_fee_paid = 1 AND strftime('%Y-%m-%d', payment_date) = ?", (today,))
            bus = self.cursor.fetchone()[0] or 0.0
            self.bus_fee_var.set(f"GHS {bus:.2f}")
            # Total revenue today
            self.cursor.execute("SELECT SUM(amount_paid) FROM fees WHERE strftime('%Y-%m-%d', payment_date) = ?", (today,))
            total = self.cursor.fetchone()[0] or 0.0
            self.total_revenue_var.set(f"GHS {total:.2f}")
        except Exception as e:
            # Do not crash the UI; show warning in console
            print("Warning updating dashboard:", e)

    # --- User Management (Admin Only) ---
    def show_user_management(self):
        """Show user management interface for admins"""
        # Admin has unlimited access - but still check for safety
        if self.current_user.get('role') != 'admin':
            messagebox.showerror("Access Denied", "Only administrators can access User Management.")
            return
            
        self.clear_content_frame()
        
        # Create scrollable frame for user management
        scrollable_users = ScrollableFrame(self.content_frame, bg='#ffffff')
        scrollable_users.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        users_main_frame = scrollable_users.get_frame()
        
        # Title and header
        header_frame = tk.Frame(users_main_frame, bg='#2c3e50', height=60)
        header_frame.pack(fill='x', padx=10, pady=(10, 0))
        header_frame.pack_propagate(False)
        
        title_label = tk.Label(header_frame, text="👤 User Management", 
                              font=('Segoe UI', 16, 'bold'), 
                              bg='#2c3e50', fg='white')
        title_label.pack(side='left', padx=20, pady=15)
        
        # Add refresh button
        refresh_btn = tk.Button(header_frame, text="🔄 Refresh", 
                               command=self.load_users_data,
                               bg='#3498db', fg='white', font=('Segoe UI', 10, 'bold'),
                               relief='flat', padx=15, pady=5, cursor='hand2')
        refresh_btn.pack(side='right', padx=20, pady=15)
        
        # Main content notebook for tabs
        notebook = ttk.Notebook(users_main_frame)
        notebook.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # Tab 1: User List
        users_tab = tk.Frame(notebook, bg='#ffffff')
        notebook.add(users_tab, text="👥 Users List")
        
        # Users list frame
        list_frame = tk.Frame(users_tab, bg='#ffffff')
        list_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # Search frame
        search_frame = tk.Frame(list_frame, bg='#ffffff')
        search_frame.pack(fill='x', pady=(0, 10))
        
        tk.Label(search_frame, text="🔍 Search Users:", font=('Segoe UI', 10, 'bold'), 
                bg='#ffffff').pack(side='left', padx=(0, 5))
        
        self.users_search_var = tk.StringVar()
        users_search_entry = AutocompleteEntry(search_frame, textvariable=self.users_search_var,
                                     font=('Segoe UI', 10), width=30, relief='solid', bd=1,
                                     suggestions_callback=self.get_user_suggestions)
        users_search_entry.pack(side='left', padx=(0, 5))
        users_search_entry.var.trace('w', lambda *args: self.filter_users())
        
        # Users TreeView
        users_tree_frame = tk.Frame(list_frame, bg='#ffffff')
        users_tree_frame.pack(fill=tk.BOTH, expand=True)
        
        # Users TreeView with scrollbar
        self.users_tree = ttk.Treeview(users_tree_frame, 
                                      columns=('ID', 'Username', 'Full Name', 'Role', 'Email', 'Status', 'Last Login'),
                                      show='headings', height=15)
        
        # Configure columns
        self.users_tree.heading('#1', text='ID')
        self.users_tree.heading('#2', text='Username')
        self.users_tree.heading('#3', text='Full Name')
        self.users_tree.heading('#4', text='Role')
        self.users_tree.heading('#5', text='Email')
        self.users_tree.heading('#6', text='Status')
        self.users_tree.heading('#7', text='Last Login')
        
        self.users_tree.column('#1', width=50, minwidth=50)
        self.users_tree.column('#2', width=120, minwidth=100)
        self.users_tree.column('#3', width=180, minwidth=150)
        self.users_tree.column('#4', width=80, minwidth=80)
        self.users_tree.column('#5', width=200, minwidth=180)
        self.users_tree.column('#6', width=80, minwidth=80)
        self.users_tree.column('#7', width=120, minwidth=100)
        
        users_scrollbar = ttk.Scrollbar(users_tree_frame, orient='vertical', command=self.users_tree.yview)
        self.users_tree.configure(yscrollcommand=users_scrollbar.set)
        
        self.users_tree.pack(side='left', fill=tk.BOTH, expand=True)
        users_scrollbar.pack(side='right', fill='y')
        
        # Users action buttons
        users_btn_frame = tk.Frame(list_frame, bg='#ffffff')
        users_btn_frame.pack(fill='x', pady=(10, 0))
        
        edit_user_btn = tk.Button(users_btn_frame, text="🔄 Edit User", 
                                 command=self.edit_selected_user,
                                 bg='#f39c12', fg='white', font=('Segoe UI', 10, 'bold'),
                                 relief='flat', padx=15, pady=8, cursor='hand2')
        edit_user_btn.pack(side='left', padx=(0, 5))
        
        change_role_btn = tk.Button(users_btn_frame, text="🔄 Change Role", 
                                   command=self.change_user_role,
                                   bg='#9b59b6', fg='white', font=('Segoe UI', 10, 'bold'),
                                   relief='flat', padx=15, pady=8, cursor='hand2')
        change_role_btn.pack(side='left', padx=5)
        
        toggle_status_btn = tk.Button(users_btn_frame, text="🔄 Activate/Deactivate", 
                                     command=self.toggle_user_status,
                                     bg='#e67e22', fg='white', font=('Segoe UI', 10, 'bold'),
                                     relief='flat', padx=15, pady=8, cursor='hand2')
        toggle_status_btn.pack(side='left', padx=5)
        
        delete_user_btn = tk.Button(users_btn_frame, text="🧹 Delete User", 
                                   command=self.delete_selected_user,
                                   bg='#c0392b', fg='white', font=('Segoe UI', 10, 'bold'),
                                   relief='flat', padx=15, pady=8, cursor='hand2')
        delete_user_btn.pack(side='left', padx=5)
        
        # Tab 2: Add/Edit User Form
        form_tab = tk.Frame(notebook, bg='#ffffff')
        notebook.add(form_tab, text="📝 Add/Edit User")
        
        # User form
        self.create_user_form(form_tab)
        
        # Tab 3: User Activity Report
        activity_tab = tk.Frame(notebook, bg='#ffffff')
        notebook.add(activity_tab, text="📊 Activity Report")
        
        # Create activity report
        self.create_user_activity_report(activity_tab)
        
        # Load initial data
        self.load_users_data()
        
        # Bind double-click to edit
        self.users_tree.bind('<Double-1>', lambda e: self.edit_selected_user())
        
        # Ensure scrollable frame is properly updated
        scrollable_users.update_scrollregion()
    
    def create_user_form(self, parent):
        """Create user add/edit form"""
        form_frame = tk.Frame(parent, bg='#ffffff')
        form_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Form title
        form_title = tk.Label(form_frame, text="Add/Edit User Account", 
                             font=('Segoe UI', 14, 'bold'), bg='#ffffff', fg='#2c3e50')
        form_title.pack(anchor='w', pady=(0, 20))
        
        # Create form fields in a grid
        fields_frame = tk.Frame(form_frame, bg='#ffffff')
        fields_frame.pack(fill='x', pady=(0, 20))
        
        # Username field
        tk.Label(fields_frame, text="Username:", font=('Segoe UI', 10, 'bold'), 
                bg='#ffffff', fg='#2c3e50').grid(row=0, column=0, sticky='w', pady=(0, 5))
        self.user_username_var = tk.StringVar()
        username_entry = tk.Entry(fields_frame, textvariable=self.user_username_var,
                                 font=('Segoe UI', 10), width=25, relief='solid', bd=1)
        username_entry.grid(row=0, column=1, sticky='w', padx=(10, 0), pady=(0, 10))
        
        # Full Name field
        tk.Label(fields_frame, text="Full Name:", font=('Segoe UI', 10, 'bold'), 
                bg='#ffffff', fg='#2c3e50').grid(row=1, column=0, sticky='w', pady=(0, 5))
        self.user_fullname_var = tk.StringVar()
        fullname_entry = tk.Entry(fields_frame, textvariable=self.user_fullname_var,
                                 font=('Segoe UI', 10), width=25, relief='solid', bd=1)
        fullname_entry.grid(row=1, column=1, sticky='w', padx=(10, 0), pady=(0, 10))
        
        # Email field
        tk.Label(fields_frame, text="Email:", font=('Segoe UI', 10, 'bold'), 
                bg='#ffffff', fg='#2c3e50').grid(row=2, column=0, sticky='w', pady=(0, 5))
        self.user_email_var = tk.StringVar()
        email_entry = tk.Entry(fields_frame, textvariable=self.user_email_var,
                              font=('Segoe UI', 10), width=25, relief='solid', bd=1)
        email_entry.grid(row=2, column=1, sticky='w', padx=(10, 0), pady=(0, 10))
        
        # Password field
        tk.Label(fields_frame, text="Password:", font=('Segoe UI', 10, 'bold'), 
                bg='#ffffff', fg='#2c3e50').grid(row=3, column=0, sticky='w', pady=(0, 5))
        self.user_password_var = tk.StringVar()
        password_entry = tk.Entry(fields_frame, textvariable=self.user_password_var,
                                 font=('Segoe UI', 10), width=25, relief='solid', bd=1, show='*')
        password_entry.grid(row=3, column=1, sticky='w', padx=(10, 0), pady=(0, 10))
        
        # Role field
        tk.Label(fields_frame, text="Role:", font=('Segoe UI', 10, 'bold'), 
                bg='#ffffff', fg='#2c3e50').grid(row=0, column=2, sticky='w', padx=(40, 0), pady=(0, 5))
        self.user_role_var = tk.StringVar()
        role_cb = ttk.Combobox(fields_frame, textvariable=self.user_role_var,
                              values=['admin', 'teacher', 'staff', 'viewer'],
                              state='readonly', width=22)
        role_cb.grid(row=0, column=3, sticky='w', padx=(10, 0), pady=(0, 10))
        
        # Status field
        tk.Label(fields_frame, text="Status:", font=('Segoe UI', 10, 'bold'), 
                bg='#ffffff', fg='#2c3e50').grid(row=1, column=2, sticky='w', padx=(40, 0), pady=(0, 5))
        self.user_status_var = tk.BooleanVar(value=True)
        status_frame = tk.Frame(fields_frame, bg='#ffffff')
        status_frame.grid(row=1, column=3, sticky='w', padx=(10, 0), pady=(0, 10))
        
        active_radio = tk.Radiobutton(status_frame, text="✅ Active", variable=self.user_status_var, 
                                     value=True, bg='#ffffff', font=('Segoe UI', 9))
        active_radio.pack(side='left')
        inactive_radio = tk.Radiobutton(status_frame, text="❌ Inactive", variable=self.user_status_var, 
                                       value=False, bg='#ffffff', font=('Segoe UI', 9))
        inactive_radio.pack(side='left', padx=(10, 0))
        
        # Permissions field
        tk.Label(fields_frame, text="Permissions:", font=('Segoe UI', 10, 'bold'), 
                bg='#ffffff', fg='#2c3e50').grid(row=2, column=2, sticky='nw', padx=(40, 0), pady=(0, 5))
        
        permissions_frame = tk.Frame(fields_frame, bg='#ffffff')
        permissions_frame.grid(row=2, column=3, rowspan=2, sticky='w', padx=(10, 0), pady=(0, 10))
        
        # Permission checkboxes with descriptions
        self.permission_vars = {}
        permissions_list = [
            ('dashboard', 'Dashboard Access'),
            ('students', 'Student Management'),
            ('teachers', 'Teacher Management'),
            ('classes', 'Class Management'),
            ('attendance', 'Attendance Tracking'),
            ('fees', 'Fees Management'),
            ('users', 'User Management'),
            ('database', 'Database View')
        ]
        
        # Add "Select All" and "Clear All" buttons
        control_frame = tk.Frame(permissions_frame, bg='#ffffff')
        control_frame.grid(row=0, column=0, columnspan=3, sticky='w', pady=(0, 5))
        
        tk.Button(control_frame, text="Select All", command=self.select_all_permissions,
                 bg='#28a745', fg='white', font=('Segoe UI', 8), relief='flat', 
                 padx=10, pady=2).pack(side='left', padx=(0, 5))
        
        tk.Button(control_frame, text="Clear All", command=self.clear_all_permissions,
                 bg='#dc3545', fg='white', font=('Segoe UI', 8), relief='flat',
                 padx=10, pady=2).pack(side='left')
        
        # Role-based permission templates
        template_frame = tk.Frame(permissions_frame, bg='#ffffff')
        template_frame.grid(row=0, column=2, sticky='w', padx=(20, 0))
        
        tk.Label(template_frame, text="Quick Templates:", font=('Segoe UI', 9, 'bold'),
                bg='#ffffff', fg='#2c3e50').pack(anchor='w')
        
        tk.Button(template_frame, text="Teacher Role", command=self.apply_teacher_template,
                 bg='#17a2b8', fg='white', font=('Segoe UI', 8), relief='flat',
                 padx=8, pady=1).pack(fill='x', pady=1)
        
        tk.Button(template_frame, text="Staff Role", command=self.apply_staff_template,
                 bg='#6c757d', fg='white', font=('Segoe UI', 8), relief='flat',
                 padx=8, pady=1).pack(fill='x', pady=1)
        
        tk.Button(template_frame, text="Viewer Role", command=self.apply_viewer_template,
                 bg='#6f42c1', fg='white', font=('Segoe UI', 8), relief='flat',
                 padx=8, pady=1).pack(fill='x', pady=1)
        
        # Permission checkboxes
        for i, (perm, desc) in enumerate(permissions_list):
            self.permission_vars[perm] = tk.BooleanVar()
            cb = tk.Checkbutton(permissions_frame, text=desc, 
                               variable=self.permission_vars[perm],
                               bg='#ffffff', font=('Segoe UI', 9))
            cb.grid(row=(i//2) + 1, column=i%2, sticky='w', padx=(0, 15), pady=2)
        
        # Form action buttons
        btn_frame = tk.Frame(form_frame, bg='#ffffff')
        btn_frame.pack(fill='x', pady=(20, 0))
        
        save_btn = tk.Button(btn_frame, text="💾 Save User", 
                            command=self.save_user,
                            bg='#27ae60', fg='white', font=('Segoe UI', 12, 'bold'),
                            relief='flat', padx=20, pady=10, cursor='hand2')
        save_btn.pack(side='left', padx=(0, 10))
        
        clear_btn = tk.Button(btn_frame, text="🧹 Clear Form", 
                             command=self.clear_user_form,
                             bg='#95a5a6', fg='white', font=('Segoe UI', 12, 'bold'),
                             relief='flat', padx=20, pady=10, cursor='hand2')
        clear_btn.pack(side='left')
        
        # Store editing user ID
        self.editing_user_id = None
    
    def select_all_permissions(self):
        """Select all permission checkboxes"""
        for var in self.permission_vars.values():
            var.set(True)
    
    def clear_all_permissions(self):
        """Clear all permission checkboxes"""
        for var in self.permission_vars.values():
            var.set(False)
    
    def apply_teacher_template(self):
        """Apply teacher role permissions"""
        self.clear_all_permissions()
        teacher_perms = ['dashboard', 'students', 'classes', 'attendance']
        for perm in teacher_perms:
            if perm in self.permission_vars:
                self.permission_vars[perm].set(True)
        self.user_role_var.set('teacher')
    
    def apply_staff_template(self):
        """Apply staff role permissions"""
        self.clear_all_permissions()
        staff_perms = ['dashboard', 'students', 'attendance']
        for perm in staff_perms:
            if perm in self.permission_vars:
                self.permission_vars[perm].set(True)
        self.user_role_var.set('staff')
    
    def apply_viewer_template(self):
        """Apply viewer role permissions"""
        self.clear_all_permissions()
        viewer_perms = ['dashboard']  # Very limited access
        for perm in viewer_perms:
            if perm in self.permission_vars:
                self.permission_vars[perm].set(True)
        self.user_role_var.set('viewer')
    
    def create_user_activity_report(self, parent):
        """Create comprehensive user activity report"""
        report_frame = tk.Frame(parent, bg='#ffffff')
        report_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Report title and controls
        header_frame = tk.Frame(report_frame, bg='#ffffff')
        header_frame.pack(fill='x', pady=(0, 20))
        
        tk.Label(header_frame, text="📊 User Activity Analysis", 
                font=('Segoe UI', 16, 'bold'), bg='#ffffff', fg='#2c3e50').pack(side='left')
        
        # Refresh button
        refresh_btn = tk.Button(header_frame, text="🔄 Refresh Data", 
                               command=self.refresh_activity_report,
                               bg='#3498db', fg='white', font=('Segoe UI', 10, 'bold'),
                               relief='flat', padx=15, pady=5, cursor='hand2')
        refresh_btn.pack(side='right', padx=(10, 0))
        
        # Export button
        export_btn = tk.Button(header_frame, text="📥 Export Report", 
                              command=self.export_activity_report,
                              bg='#27ae60', fg='white', font=('Segoe UI', 10, 'bold'),
                              relief='flat', padx=15, pady=5, cursor='hand2')
        export_btn.pack(side='right')
        
        # Summary cards container
        summary_container = tk.Frame(report_frame, bg='#ffffff')
        summary_container.pack(fill='x', pady=(0, 20))
        
        # Summary cards (4 cards in a row)
        self.activity_summary_cards = []
        
        # Card 1: Total Users
        card1 = self.create_activity_card(summary_container, "👥 Total Users", "0", "#3498db")
        card1.pack(side='left', padx=(0, 10), expand=True, fill='both')
        self.activity_summary_cards.append(card1)
        
        # Card 2: Active Users
        card2 = self.create_activity_card(summary_container, "✅ Active Users", "0", "#27ae60")
        card2.pack(side='left', padx=(0, 10), expand=True, fill='both')
        self.activity_summary_cards.append(card2)
        
        # Card 3: Recent Logins (Today)
        card3 = self.create_activity_card(summary_container, "📱 Today's Logins", "0", "#f39c12")
        card3.pack(side='left', padx=(0, 10), expand=True, fill='both')
        self.activity_summary_cards.append(card3)
        
        # Card 4: Inactive Users
        card4 = self.create_activity_card(summary_container, "⚠️ Inactive Users", "0", "#e74c3c")
        card4.pack(side='left', expand=True, fill='both')
        self.activity_summary_cards.append(card4)
        
        # Create notebook for different views
        activity_notebook = ttk.Notebook(report_frame)
        activity_notebook.pack(fill=tk.BOTH, expand=True)
        
        # Tab 1: Login Activity
        login_tab = tk.Frame(activity_notebook, bg='#ffffff')
        activity_notebook.add(login_tab, text="📱 Login Activity")
        
        # Login activity table
        login_frame = tk.Frame(login_tab, bg='#ffffff')
        login_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        tk.Label(login_frame, text="Recent Login History", 
                font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50').pack(anchor='w', pady=(0, 10))
        
        # Login activity treeview
        login_tree_frame = tk.Frame(login_frame, bg='#ffffff')
        login_tree_frame.pack(fill=tk.BOTH, expand=True)
        
        self.login_activity_tree = ttk.Treeview(login_tree_frame,
                                                columns=('User', 'Role', 'Last Login', 'Days Since', 'Status'),
                                                show='headings', height=12)
        
        self.login_activity_tree.heading('User', text='Username')
        self.login_activity_tree.heading('Role', text='Role')
        self.login_activity_tree.heading('Last Login', text='Last Login')
        self.login_activity_tree.heading('Days Since', text='Days Since Login')
        self.login_activity_tree.heading('Status', text='Activity Status')
        
        self.login_activity_tree.column('User', width=150)
        self.login_activity_tree.column('Role', width=100)
        self.login_activity_tree.column('Last Login', width=180)
        self.login_activity_tree.column('Days Since', width=120)
        self.login_activity_tree.column('Status', width=150)
        
        login_scrollbar = ttk.Scrollbar(login_tree_frame, orient='vertical', 
                                       command=self.login_activity_tree.yview)
        self.login_activity_tree.configure(yscrollcommand=login_scrollbar.set)
        
        self.login_activity_tree.pack(side='left', fill=tk.BOTH, expand=True)
        login_scrollbar.pack(side='right', fill='y')
        
        # Tab 2: Role Distribution
        role_tab = tk.Frame(activity_notebook, bg='#ffffff')
        activity_notebook.add(role_tab, text="👥 Role Distribution")
        
        # Role distribution content
        role_frame = tk.Frame(role_tab, bg='#ffffff')
        role_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        tk.Label(role_frame, text="User Distribution by Role", 
                font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50').pack(anchor='w', pady=(0, 10))
        
        # Role statistics frame
        self.role_stats_frame = tk.Frame(role_frame, bg='#ffffff')
        self.role_stats_frame.pack(fill=tk.BOTH, expand=True)
        
        # Tab 3: Permission Analysis
        perm_tab = tk.Frame(activity_notebook, bg='#ffffff')
        activity_notebook.add(perm_tab, text="🔐 Permissions")
        
        # Permission analysis content
        perm_frame = tk.Frame(perm_tab, bg='#ffffff')
        perm_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        tk.Label(perm_frame, text="Permission Distribution Analysis", 
                font=('Segoe UI', 12, 'bold'), bg='#ffffff', fg='#2c3e50').pack(anchor='w', pady=(0, 10))
        
        # Permissions treeview
        perm_tree_frame = tk.Frame(perm_frame, bg='#ffffff')
        perm_tree_frame.pack(fill=tk.BOTH, expand=True)
        
        self.perm_activity_tree = ttk.Treeview(perm_tree_frame,
                                               columns=('Permission', 'Users', 'Percentage'),
                                               show='headings', height=12)
        
        self.perm_activity_tree.heading('Permission', text='Permission')
        self.perm_activity_tree.heading('Users', text='Users with Access')
        self.perm_activity_tree.heading('Percentage', text='% of Users')
        
        self.perm_activity_tree.column('Permission', width=300)
        self.perm_activity_tree.column('Users', width=150)
        self.perm_activity_tree.column('Percentage', width=150)
        
        perm_scrollbar = ttk.Scrollbar(perm_tree_frame, orient='vertical', 
                                      command=self.perm_activity_tree.yview)
        self.perm_activity_tree.configure(yscrollcommand=perm_scrollbar.set)
        
        self.perm_activity_tree.pack(side='left', fill=tk.BOTH, expand=True)
        perm_scrollbar.pack(side='right', fill='y')
        
        # Load initial activity data
        self.refresh_activity_report()
    
    def create_activity_card(self, parent, title, value, color):
        """Create a summary card for activity metrics"""
        card = tk.Frame(parent, bg=color, relief='raised', bd=2)
        
        # Title
        title_label = tk.Label(card, text=title, font=('Segoe UI', 11, 'bold'), 
                              bg=color, fg='white')
        title_label.pack(pady=(15, 5))
        
        # Value
        value_label = tk.Label(card, text=value, font=('Segoe UI', 28, 'bold'), 
                              bg=color, fg='white')
        value_label.pack(pady=(5, 15))
        
        # Store reference to value label for updates
        card.value_label = value_label
        
        return card
    
    def refresh_activity_report(self):
        """Refresh all activity report data"""
        try:
            # Update summary cards
            self.update_activity_summary()
            
            # Update login activity
            self.update_login_activity()
            
            # Update role distribution
            self.update_role_distribution()
            
            # Update permission analysis
            self.update_permission_analysis()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to refresh activity report: {e}")
    
    def update_activity_summary(self):
        """Update activity summary cards"""
        try:
            # Total users
            total_users = self.cursor.execute('SELECT COUNT(*) FROM users').fetchone()[0]
            
            # Active users
            active_users = self.cursor.execute(
                'SELECT COUNT(*) FROM users WHERE is_active = 1').fetchone()[0]
            
            # Today's logins
            today = date.today().strftime('%Y-%m-%d')
            todays_logins = self.cursor.execute(
                'SELECT COUNT(*) FROM users WHERE DATE(last_login) = ?', (today,)).fetchone()[0]
            
            # Inactive users
            inactive_users = total_users - active_users
            
            # Update card values
            if len(self.activity_summary_cards) >= 4:
                self.activity_summary_cards[0].value_label.config(text=str(total_users))
                self.activity_summary_cards[1].value_label.config(text=str(active_users))
                self.activity_summary_cards[2].value_label.config(text=str(todays_logins))
                self.activity_summary_cards[3].value_label.config(text=str(inactive_users))
                
        except Exception as e:
            print(f"Error updating activity summary: {e}")
    
    def update_login_activity(self):
        """Update login activity table"""
        try:
            # Clear existing data
            for item in self.login_activity_tree.get_children():
                self.login_activity_tree.delete(item)
            
            # Fetch login data
            self.cursor.execute('''
                SELECT username, role, last_login, is_active
                FROM users
                ORDER BY last_login DESC NULLS LAST
            ''')
            
            users = self.cursor.fetchall()
            today = datetime.now()
            
            for user in users:
                username, role, last_login, is_active = user
                
                # Calculate days since login
                if last_login:
                    try:
                        login_date = datetime.strptime(last_login, '%Y-%m-%d %H:%M:%S')
                        days_since = (today - login_date).days
                        
                        # Determine activity status
                        if days_since == 0:
                            status = "ƒó Active Today"
                        elif days_since <= 7:
                            status = "ƒí Active This Week"
                        elif days_since <= 30:
                            status = "ƒá Active This Month"
                        else:
                            status = "📭 Inactive"
                        
                        days_text = f"{days_since} day{'s' if days_since != 1 else ''} ago"
                        
                    except:
                        days_since = 999
                        days_text = "Unknown"
                        status = "❓ Unknown"
                else:
                    days_text = "Never"
                    status = "🚫 Never Logged In"
                    last_login = "Never"
                
                # Add account status
                if not is_active:
                    status = "❌ Disabled"
                
                self.login_activity_tree.insert('', 'end', values=(
                    username, role.capitalize(), last_login, days_text, status
                ))
                
        except Exception as e:
            print(f"Error updating login activity: {e}")
    
    def update_role_distribution(self):
        """Update role distribution visualization"""
        try:
            # Clear existing widgets
            for widget in self.role_stats_frame.winfo_children():
                widget.destroy()
            
            # Get role counts
            self.cursor.execute('''
                SELECT role, COUNT(*) as count
                FROM users
                GROUP BY role
                ORDER BY count DESC
            ''')
            
            role_data = self.cursor.fetchall()
            total_users = sum(count for _, count in role_data)
            
            if total_users == 0:
                tk.Label(self.role_stats_frame, text="No users found", 
                        font=('Segoe UI', 12), bg='#ffffff', fg='#7f8c8d').pack(pady=50)
                return
            
            # Define role colors
            role_colors = {
                'admin': '#e74c3c',
                'teacher': '#3498db',
                'staff': '#f39c12',
                'viewer': '#9b59b6'
            }
            
            # Create role cards
            for role, count in role_data:
                percentage = (count / total_users) * 100
                color = role_colors.get(role, '#95a5a6')
                
                role_card = tk.Frame(self.role_stats_frame, bg='#ffffff', relief='solid', bd=1)
                role_card.pack(fill='x', pady=5, padx=10)
                
                # Left side - Role info
                info_frame = tk.Frame(role_card, bg='#ffffff')
                info_frame.pack(side='left', fill='y', padx=15, pady=10)
                
                tk.Label(info_frame, text=role.upper(), font=('Segoe UI', 14, 'bold'),
                        bg='#ffffff', fg=color).pack(anchor='w')
                tk.Label(info_frame, text=f"{count} user{'s' if count != 1 else ''} ({percentage:.1f}%)",
                        font=('Segoe UI', 10), bg='#ffffff', fg='#7f8c8d').pack(anchor='w')
                
                # Right side - Progress bar
                bar_frame = tk.Frame(role_card, bg='#ffffff')
                bar_frame.pack(side='left', fill='both', expand=True, padx=15, pady=10)
                
                # Progress bar container
                bar_container = tk.Frame(bar_frame, bg='#ecf0f1', height=30)
                bar_container.pack(fill='x')
                bar_container.pack_propagate(False)
                
                # Progress bar fill
                bar_width = int((percentage / 100) * 400)  # Max width 400px
                bar_fill = tk.Frame(bar_container, bg=color, width=bar_width, height=30)
                bar_fill.pack(side='left', fill='y')
                
        except Exception as e:
            print(f"Error updating role distribution: {e}")
    
    def update_permission_analysis(self):
        """Update permission analysis"""
        try:
            # Clear existing data
            for item in self.perm_activity_tree.get_children():
                self.perm_activity_tree.delete(item)
            
            # Get total users
            total_users = self.cursor.execute('SELECT COUNT(*) FROM users').fetchone()[0]
            
            if total_users == 0:
                return
            
            # Define permissions to analyze
            permissions_list = [
                ('dashboard', 'Dashboard Access'),
                ('students', 'Student Management'),
                ('teachers', 'Teacher Management'),
                ('classes', 'Class Management'),
                ('attendance', 'Attendance Tracking'),
                ('fees', 'Fees Management'),
                ('users', 'User Management'),
                ('database', 'Database View')
            ]
            
            # Count users with each permission
            for perm_key, perm_name in permissions_list:
                # Count users where permission includes this key
                self.cursor.execute('''
                    SELECT COUNT(*)
                    FROM users
                    WHERE permissions LIKE ?
                ''', (f'%{perm_key}%',))
                
                count = self.cursor.fetchone()[0]
                percentage = (count / total_users) * 100
                
                self.perm_activity_tree.insert('', 'end', values=(
                    perm_name,
                    f"{count} / {total_users}",
                    f"{percentage:.1f}%"
                ))
                
        except Exception as e:
            print(f"Error updating permission analysis: {e}")
    
    def export_activity_report(self):
        """Export activity report to CSV"""
        try:
            from tkinter import filedialog
            
            # Ask for save location
            filename = filedialog.asksaveasfilename(
                defaultextension=".csv",
                filetypes=[("CSV files", "*.csv"), ("All files", "*.*")],
                initialfile=f"user_activity_report_{date.today()}.csv"
            )
            
            if not filename:
                return
            
            with open(filename, 'w', newline='', encoding='utf-8') as f:
                import csv
                writer = csv.writer(f)
                
                # Write header
                writer.writerow(['User Activity Report'])
                writer.writerow(['Generated:', datetime.now().strftime('%Y-%m-%d %H:%M:%S')])
                writer.writerow([])
                
                # Write summary
                writer.writerow(['Summary'])
                total = self.cursor.execute('SELECT COUNT(*) FROM users').fetchone()[0]
                active = self.cursor.execute('SELECT COUNT(*) FROM users WHERE is_active = 1').fetchone()[0]
                writer.writerow(['Total Users', total])
                writer.writerow(['Active Users', active])
                writer.writerow(['Inactive Users', total - active])
                writer.writerow([])
                
                # Write user details
                writer.writerow(['User Details'])
                writer.writerow(['Username', 'Role', 'Last Login', 'Status'])
                
                self.cursor.execute('''
                    SELECT username, role, last_login, is_active
                    FROM users
                    ORDER BY username
                ''')
                
                for user in self.cursor.fetchall():
                    username, role, last_login, is_active = user
                    status = 'Active' if is_active else 'Inactive'
                    writer.writerow([username, role, last_login or 'Never', status])
            
            messagebox.showinfo("Success", f"Activity report exported successfully to:\n{filename}")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to export activity report: {e}")
    
    def load_users_data(self):
        """Load all users data into the tree"""
        try:
            # Clear existing data
            for item in self.users_tree.get_children():
                self.users_tree.delete(item)
            
            # Fetch users data
            self.cursor.execute('''
                SELECT id, username, full_name, role, email, is_active, last_login, created_date
                FROM users
                ORDER BY created_date DESC
            ''')
            
            users = self.cursor.fetchall()
            
            for user in users:
                user_id, username, full_name, role, email, is_active, last_login, created_date = user
                
                # Format status
                status = "Active" if is_active else "Inactive"
                
                # Format last login
                if last_login:
                    try:
                        login_date = datetime.strptime(last_login, '%Y-%m-%d').strftime('%Y-%m-%d')
                    except:
                        login_date = str(last_login)
                else:
                    login_date = "Never"
                
                # Insert into tree
                self.users_tree.insert('', 'end', values=(
                    user_id, username, full_name or 'N/A', role.title(), 
                    email or 'N/A', status, login_date
                ))
            
            self.update_status(f"Loaded {len(users)} users")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load users data: {str(e)}")
    
    def filter_users(self):
        """Filter users based on search criteria"""
        search_term = self.users_search_var.get().lower()
        
        # Clear existing data
        for item in self.users_tree.get_children():
            self.users_tree.delete(item)
        
        if not search_term:
            self.load_users_data()
            return
        
        try:
            # Search in username, full_name, email, and role
            self.cursor.execute('''
                SELECT id, username, full_name, role, email, is_active, last_login, created_date
                FROM users
                WHERE LOWER(username) LIKE ? OR LOWER(full_name) LIKE ? 
                   OR LOWER(email) LIKE ? OR LOWER(role) LIKE ?
                ORDER BY created_date DESC
            ''', (f'%{search_term}%', f'%{search_term}%', f'%{search_term}%', f'%{search_term}%'))
            
            users = self.cursor.fetchall()
            
            for user in users:
                user_id, username, full_name, role, email, is_active, last_login, created_date = user
                
                status = "Active" if is_active else "Inactive"
                
                if last_login:
                    try:
                        login_date = datetime.strptime(last_login, '%Y-%m-%d').strftime('%Y-%m-%d')
                    except:
                        login_date = str(last_login)
                else:
                    login_date = "Never"
                
                self.users_tree.insert('', 'end', values=(
                    user_id, username, full_name or 'N/A', role.title(), 
                    email or 'N/A', status, login_date
                ))
            
            self.update_status(f"Found {len(users)} users matching '{search_term}'")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to search users: {str(e)}")
    
    def clear_user_form(self):
        """Clear the user form"""
        self.user_username_var.set("")
        self.user_fullname_var.set("")
        self.user_email_var.set("")
        self.user_password_var.set("")
        self.user_role_var.set("")
        self.user_status_var.set(True)
        
        # Clear permissions
        for var in self.permission_vars.values():
            var.set(False)
        
        self.editing_user_id = None
        self.update_status("Form cleared")
    
    def save_user(self):
        """Save or update user"""
        # Validate input
        username = self.user_username_var.get().strip()
        full_name = self.user_fullname_var.get().strip()
        email = self.user_email_var.get().strip()
        password = self.user_password_var.get().strip()
        role = self.user_role_var.get()
        is_active = self.user_status_var.get()
        
        if not username or not full_name or not role:
            messagebox.showerror("Error", "Username, Full Name, and Role are required!")
            return
        
        if not self.editing_user_id and not password:
            messagebox.showerror("Error", "Password is required for new users!")
            return
        
        # Validate email format (basic)
        if email and '@' not in email:
            messagebox.showerror("Error", "Please enter a valid email address!")
            return
        
        # Get permissions
        permissions = []
        for perm, var in self.permission_vars.items():
            if var.get():
                permissions.append(perm)
        
        # Admin gets all permissions automatically
        if role == 'admin':
            permissions = ['all_permissions']
        
        permissions_str = ','.join(permissions)
        
        try:
            if self.editing_user_id:
                # Update existing user
                if password:  # Update password only if provided
                    self.cursor.execute('''
                        UPDATE users SET username=?, full_name=?, email=?, password=?, 
                               role=?, is_active=?, permissions=?
                        WHERE id=?
                    ''', (username, full_name, email, password, role, is_active, 
                          permissions_str, self.editing_user_id))
                else:  # Don't update password
                    self.cursor.execute('''
                        UPDATE users SET username=?, full_name=?, email=?, 
                               role=?, is_active=?, permissions=?
                        WHERE id=?
                    ''', (username, full_name, email, role, is_active, 
                          permissions_str, self.editing_user_id))
                
                self.conn.commit()
                self.update_status(f"User '{username}' updated successfully")
                
            else:
                # Check if username already exists
                self.cursor.execute("SELECT COUNT(*) FROM users WHERE username=?", (username,))
                if self.cursor.fetchone()[0] > 0:
                    messagebox.showerror("Error", f"Username '{username}' already exists!")
                    return
                
                # Create new user
                self.cursor.execute('''
                    INSERT INTO users (username, password, full_name, role, email, 
                                     permissions, is_active, created_date)
                    VALUES (?, ?, ?, ?, ?, ?, ?, DATE('now'))
                ''', (username, password, full_name, role, email, permissions_str, is_active))
                
                self.conn.commit()
                self.update_status(f"User '{username}' created successfully")
            
            # Refresh users list and clear form
            self.load_users_data()
            self.clear_user_form()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to save user: {str(e)}")
    
    def edit_selected_user(self):
        """Edit the selected user"""
        selection = self.users_tree.selection()
        if not selection:
            messagebox.showwarning("Warning", "Please select a user to edit!")
            return
        
        # Get user data
        values = self.users_tree.item(selection[0])['values']
        user_id = values[0]
        
        try:
            # Fetch full user data
            self.cursor.execute('''
                SELECT id, username, full_name, role, email, permissions, is_active
                FROM users WHERE id=?
            ''', (user_id,))
            
            user = self.cursor.fetchone()
            if not user:
                messagebox.showerror("Error", "User not found!")
                return
            
            # Populate form
            self.editing_user_id = user[0]
            self.user_username_var.set(user[1])
            self.user_fullname_var.set(user[2] or "")
            self.user_role_var.set(user[3])
            self.user_email_var.set(user[4] or "")
            self.user_password_var.set("")  # Don't show existing password
            self.user_status_var.set(bool(user[6]))
            
            # Set permissions
            user_permissions = user[5].split(',') if user[5] else []
            for perm, var in self.permission_vars.items():
                var.set(perm in user_permissions or 'all_permissions' in user_permissions)
            
            self.update_status(f"Editing user: {user[1]}")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load user data: {str(e)}")
    
    def change_user_role(self):
        """Change the role of the selected user"""
        selection = self.users_tree.selection()
        if not selection:
            messagebox.showwarning("Warning", "Please select a user to change role!")
            return
        
        values = self.users_tree.item(selection[0])['values']
        user_id = values[0]
        username = values[1]
        current_role = values[3]
        
        # Don't allow changing the current user's role
        if username == self.current_user.get('username'):
            messagebox.showerror("Error", "You cannot change your own role!")
            return
        
        # Don't allow changing the main admin role
        if username == 'admin':
            messagebox.showerror("Error", "The main admin account role cannot be changed!")
            return
        
        # Create role change dialog
        role_dialog = tk.Toplevel(self.root)
        role_dialog.title("Change User Role")
        role_dialog.geometry("400x300")
        role_dialog.configure(bg='#ffffff')
        role_dialog.transient(self.root)
        role_dialog.grab_set()
        
        # Center the dialog
        role_dialog.update_idletasks()
        x = (role_dialog.winfo_screenwidth() // 2) - (400 // 2)
        y = (role_dialog.winfo_screenheight() // 2) - (300 // 2)
        role_dialog.geometry(f"400x300+{x}+{y}")
        
        # Dialog content
        content_frame = tk.Frame(role_dialog, bg='#ffffff')
        content_frame.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        # Title
        tk.Label(content_frame, text="Change User Role", 
                font=('Segoe UI', 16, 'bold'), bg='#ffffff', fg='#2c3e50').pack(pady=(0, 10))
        
        # User info
        info_frame = tk.Frame(content_frame, bg='#f8f9fa', relief=tk.SOLID, bd=1)
        info_frame.pack(fill=tk.X, pady=(0, 20))
        
        tk.Label(info_frame, text=f"User: {username}", 
                font=('Segoe UI', 11), bg='#f8f9fa', fg='#34495e').pack(anchor='w', padx=15, pady=5)
        tk.Label(info_frame, text=f"Current Role: {current_role.title()}", 
                font=('Segoe UI', 11, 'bold'), bg='#f8f9fa', fg='#e74c3c').pack(anchor='w', padx=15, pady=5)
        
        # New role selection
        tk.Label(content_frame, text="Select New Role:", 
                font=('Segoe UI', 11, 'bold'), bg='#ffffff', fg='#2c3e50').pack(anchor='w', pady=(0, 10))
        
        new_role_var = tk.StringVar(value=current_role)
        
        roles = [
            ('admin', 'Administrator - Full system access'),
            ('accountant', 'Accountant - Financial management'),
            ('teacher', 'Teacher - Class and student management'),
            ('staff', 'Staff - Limited access'),
            ('viewer', 'Viewer - Read-only access')
        ]
        
        for role, description in roles:
            rb = tk.Radiobutton(content_frame, text=f"{role.title()}", 
                              variable=new_role_var, value=role,
                              font=('Segoe UI', 10, 'bold'), bg='#ffffff',
                              activebackground='#ffffff', cursor='hand2')
            rb.pack(anchor='w', pady=2)
            
            tk.Label(content_frame, text=f"   {description}", 
                    font=('Segoe UI', 9), bg='#ffffff', fg='#7f8c8d').pack(anchor='w', padx=(20, 0))
        
        # Buttons
        btn_frame = tk.Frame(content_frame, bg='#ffffff')
        btn_frame.pack(side=tk.BOTTOM, fill=tk.X, pady=(20, 0))
        
        def save_role_change():
            new_role = new_role_var.get()
            if new_role == current_role:
                messagebox.showinfo("No Change", "The role hasn't changed.")
                role_dialog.destroy()
                return
            
            if messagebox.askyesno("Confirm", 
                                  f"Change role of '{username}' from '{current_role}' to '{new_role}'?\n\n"
                                  "This will affect their permissions and access level."):
                try:
                    self.cursor.execute("UPDATE users SET role=? WHERE id=?", (new_role, user_id))
                    self.conn.commit()
                    self.load_users_data()
                    self.update_status(f"User '{username}' role changed to '{new_role}'")
                    messagebox.showinfo("Success", f"Role changed successfully to '{new_role}'!")
                    role_dialog.destroy()
                    
                except Exception as e:
                    messagebox.showerror("Error", f"Failed to change role: {str(e)}")
        
        tk.Button(btn_frame, text="Save Changes", command=save_role_change,
                 bg='#27ae60', fg='white', font=('Segoe UI', 10, 'bold'),
                 relief='flat', padx=20, pady=8, cursor='hand2').pack(side=tk.LEFT, padx=(0, 10))
        
        tk.Button(btn_frame, text="Cancel", command=role_dialog.destroy,
                 bg='#95a5a6', fg='white', font=('Segoe UI', 10, 'bold'),
                 relief='flat', padx=20, pady=8, cursor='hand2').pack(side=tk.LEFT)
    
    def toggle_user_status(self):
        """Toggle active/inactive status of selected user"""
        selection = self.users_tree.selection()
        if not selection:
            messagebox.showwarning("Warning", "Please select a user to toggle status!")
            return
        
        values = self.users_tree.item(selection[0])['values']
        user_id = values[0]
        username = values[1]
        current_status = values[5]
        
        # Don't allow disabling the current user
        if username == self.current_user.get('username'):
            messagebox.showerror("Error", "You cannot disable your own account!")
            return
        
        # Don't allow disabling the main admin
        if username == 'admin':
            messagebox.showerror("Error", "The main admin account cannot be disabled!")
            return
        
        new_status = not (current_status == "Active")
        status_text = "activate" if new_status else "deactivate"
        
        # More detailed confirmation message
        if new_status:
            confirm_msg = (f"Activate user '{username}'?\n\n"
                          f"This will allow the user to login and access the system.")
        else:
            confirm_msg = (f"Deactivate user '{username}'?\n\n"
                          f"⚠️ WARNING: This will:\n"
                          f"• Prevent the user from logging in\n"
                          f"• Immediately revoke all system access\n"
                          f"• Maintain user data for future reactivation\n\n"
                          f"The user account can be reactivated later.")
        
        if messagebox.askyesno("Confirm Status Change", confirm_msg):
            try:
                self.cursor.execute("UPDATE users SET is_active=? WHERE id=?", (new_status, user_id))
                self.conn.commit()
                self.load_users_data()
                
                # Show success message with instructions
                if new_status:
                    messagebox.showinfo("User Activated", 
                                       f"✅ User '{username}' has been activated.\n\n"
                                       f"The user can now login to the system.")
                else:
                    messagebox.showinfo("User Deactivated", 
                                       f"🔄 User '{username}' has been deactivated.\n\n"
                                       f"The user cannot login until reactivated.\n"
                                       f"All user data has been preserved.")
                
                self.update_status(f"User '{username}' {status_text}d successfully")
                
            except Exception as e:
                messagebox.showerror("Error", f"Failed to update user status: {str(e)}")
    
    def delete_selected_user(self):
        """Delete the selected user"""
        selection = self.users_tree.selection()
        if not selection:
            messagebox.showwarning("Warning", "Please select a user to delete!")
            return
        
        values = self.users_tree.item(selection[0])['values']
        user_id = values[0]
        username = values[1]
        user_role = values[3]
        
        # Don't allow deleting the current user
        if username == self.current_user.get('username'):
            messagebox.showerror("Error", "You cannot delete your own account!")
            return
        
        # Don't allow deleting the main admin
        if username == 'admin':
            messagebox.showerror("Error", "The main admin account cannot be deleted!")
            return
        
        # Enhanced confirmation with more details
        confirm_msg = (f"⚠️ PERMANENT DELETION WARNING ⚠️\n\n"
                      f"You are about to delete:\n"
                      f"• Username: {username}\n"
                      f"• Role: {user_role.title()}\n\n"
                      f"This action will:\n"
                      f"• Permanently remove the user account\n"
                      f"• Delete all login credentials\n"
                      f"• Remove all permissions\n"
                      f"• Cannot be undone\n\n"
                      f"💡 Alternative: Consider deactivating the user instead\n"
                      f"   (preserves data for future reactivation)\n\n"
                      f"Are you absolutely sure you want to DELETE this user?")
        
        if messagebox.askyesno("Confirm Permanent Deletion", confirm_msg):
            # Second confirmation for safety
            if messagebox.askyesno("Final Confirmation", 
                                  f"This is your final confirmation.\n\n"
                                  f"Permanently delete user '{username}'?"):
                try:
                    self.cursor.execute("DELETE FROM users WHERE id=?", (user_id,))
                    self.conn.commit()
                    self.load_users_data()
                    
                    messagebox.showinfo("User Deleted", 
                                       f"🧹 User '{username}' has been permanently deleted.\n\n"
                                       f"The account cannot be recovered.")
                    
                    self.update_status(f"User '{username}' deleted successfully")
                    
                except Exception as e:
                    messagebox.showerror("Error", f"Failed to delete user: {str(e)}")

    # --- Simple Fees Management view (minimal implementation) ---
    def show_fees_management(self):
        self.clear_content_frame()
        
        # Create scrollable frame for fees management
        scrollable_fees = ScrollableFrame(self.content_frame, bg='#ffffff')
        scrollable_fees.pack(fill=tk.BOTH, expand=True)
        fees_main_frame = scrollable_fees.get_frame()
        
        # Modern fees header
        header_section = tk.Frame(fees_main_frame, relief=tk.FLAT, bd=0)
        header_section.pack(fill=tk.X, padx=0, pady=(0, 25))
        
        title = tk.Label(header_section, text="💵 Fee Management",
                         font=('Segoe UI', 28, 'bold'), fg='#2c3e50')
        title.pack(anchor=tk.W)
        
        subtitle = tk.Label(header_section, text="Track student payments, manage fee records, and generate financial reports",
                           font=('Segoe UI', 14), fg='#7f8c8d')
        subtitle.pack(anchor=tk.W, pady=(5, 0))

        # Statistics Panel
        stats_section = tk.Frame(fees_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        stats_section.pack(fill=tk.X, padx=0, pady=(0, 20))
        
        stats_inner = tk.Frame(stats_section, bg='#f8f9fa')
        stats_inner.pack(fill=tk.X, padx=25, pady=20)
        
        stats_title = tk.Label(stats_inner, text="📊 Financial Statistics", 
                              font=('Segoe UI', 16, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        stats_title.pack(anchor=tk.W, pady=(0, 15))
        
        # Statistics grid
        stats_grid = tk.Frame(stats_inner, bg='#f8f9fa')
        stats_grid.pack(fill=tk.X)
        
        # Initialize fee statistics
        self.total_fees_stat = tk.Label(stats_grid, text="Total Collected: GHS 0.00",
                                       font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#27ae60')
        self.total_fees_stat.pack(side=tk.LEFT, padx=(0, 30))
        
        self.pending_fees_stat = tk.Label(stats_grid, text="Pending: GHS 0.00",
                                         font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#e74c3c')
        self.pending_fees_stat.pack(side=tk.LEFT, padx=(0, 30))
        
        self.monthly_total_stat = tk.Label(stats_grid, text="This Month: GHS 0.00",
                                          font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#3498db')
        self.monthly_total_stat.pack(side=tk.LEFT)
        
        # Update statistics
        self.update_fee_statistics()

        # Control panel with modern styling
        control_panel = tk.Frame(fees_main_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        control_panel.pack(fill=tk.X, padx=0, pady=(0, 20))
        
        control_inner = tk.Frame(control_panel, bg='#f8f9fa')
        control_inner.pack(fill=tk.X, padx=25, pady=20)
        
        # Search section
        search_section = tk.Frame(control_inner, bg='#f8f9fa')
        search_section.pack(fill=tk.X, pady=(0, 15))
        
        search_label = tk.Label(search_section, text="🔍 Fee Search:", 
                               font=('Segoe UI', 12, 'bold'), bg='#f8f9fa', fg='#2c3e50')
        search_label.pack(side=tk.LEFT)
        
        # Row 1: Main search controls
        search_row1 = tk.Frame(search_section, bg='#f8f9fa')
        search_row1.pack(fill=tk.X, pady=(10, 5))
        
        tk.Label(search_row1, text="Student Name/ID:", font=('Segoe UI', 11), bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.fee_search_var = tk.StringVar()
        self.fee_search_entry = AutocompleteEntry(search_row1, textvariable=self.fee_search_var, width=20, 
                                        font=('Segoe UI', 11),
                                        suggestions_callback=self.get_student_suggestions)
        self.fee_search_entry.pack(side=tk.LEFT, padx=(10, 30))
        
        tk.Label(search_row1, text="Month:", font=('Segoe UI', 11), bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.fee_search_month_var = tk.StringVar()
        months_list = ["All"] + [calendar.month_name[m] for m in range(1, 13)]
        self.fee_search_month_cb = ttk.Combobox(search_row1, textvariable=self.fee_search_month_var, 
                                               values=months_list, state="readonly", width=12,
                                               font=('Segoe UI', 10))
        self.fee_search_month_cb.pack(side=tk.LEFT, padx=(10, 30))
        self.fee_search_month_cb.set("All")
        
        tk.Label(search_row1, text="Year:", font=('Segoe UI', 11), bg='#f8f9fa', fg='#34495e').pack(side=tk.LEFT)
        self.fee_search_year_var = tk.StringVar()
        self.fee_search_year_entry = tk.Entry(search_row1, textvariable=self.fee_search_year_var, width=8, 
                                             font=('Segoe UI', 11))
        self.fee_search_year_entry.pack(side=tk.LEFT, padx=(10, 0))
        
        # Button section
        buttons_section = tk.Frame(control_inner, bg='#f8f9fa')
        buttons_section.pack(fill=tk.X)
        
        # Left side buttons
        left_buttons = tk.Frame(buttons_section, bg='#f8f9fa')
        left_buttons.pack(side=tk.LEFT)
        
        search_btn = self.create_modern_button(left_buttons, "🔍 Search Student Fees", self.search_student_fees, 'primary', width=18)
        search_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        show_all_btn = self.create_modern_button(left_buttons, "📋 Show All Fees", self.load_fees, 'success', width=12)
        show_all_btn.pack(side=tk.LEFT, padx=(0, 10))
        
        clear_btn = self.create_modern_button(left_buttons, "🔄 Clear Search", self.clear_fee_search, 'secondary', width=12)
        clear_btn.pack(side=tk.LEFT)

        # Main frame with left form and right list
        frame = tk.Frame(fees_main_frame, bg='#ffffff')
        frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

        # Left: Create scrollable form container with clean styling
        form_container = tk.Frame(frame, bg='#f8f9fa', relief=tk.FLAT, bd=0, width=400)
        form_container.pack(side=tk.LEFT, fill=tk.Y, padx=(0,15), pady=5)
        form_container.pack_propagate(False)
        
        # Add border effect
        border_frame = tk.Frame(form_container, bg='#dee2e6', relief=tk.FLAT, bd=0)
        border_frame.pack(fill=tk.BOTH, expand=True)
        
        inner_container = tk.Frame(border_frame, bg='#f8f9fa', relief=tk.FLAT, bd=0)
        inner_container.pack(fill=tk.BOTH, expand=True, padx=2, pady=2)
        
        # Create scrollable frame for the form
        scrollable_form = ScrollableFrame(inner_container, bg='#f8f9fa')
        scrollable_form.pack(fill=tk.BOTH, expand=True)
        form = scrollable_form.get_frame()

        # Form header with transparent background
        header_frame = tk.Frame(form, relief=tk.FLAT, bd=0)
        header_frame.pack(fill=tk.X, padx=10, pady=(10,15))
        tk.Label(header_frame, text="Record Fee Payment", font=('Arial', 14, 'bold')).pack()

        # Student selector with better layout
        student_frame = tk.Frame(form, bg='#f9f9f9')
        student_frame.pack(fill=tk.X, padx=10, pady=5)
        tk.Label(student_frame, text="Student:", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        self.cursor.execute("SELECT id, student_id, name FROM students WHERE status='Active' ORDER BY name")
        students = self.cursor.fetchall()
        student_display = [f"{r[0]} - {r[2]} ({r[1] or ''})" for r in students]
        self._fee_student_map = {f"{r[0]} - {r[2]} ({r[1] or ''})": r[0] for r in students}
        self.fee_student_var = tk.StringVar()
        self.fee_student_cb = ttk.Combobox(student_frame, textvariable=self.fee_student_var, values=student_display, state="readonly", width=35)
        self.fee_student_cb.pack(anchor=tk.W, pady=(2,5))
        self.fee_student_cb.bind('<<ComboboxSelected>>', self.calculate_amount_due)

        # Month and Year in same row
        date_frame = tk.Frame(form, bg='#f9f9f9')
        date_frame.pack(fill=tk.X, padx=10, pady=5)
        
        # Month section
        month_frame = tk.Frame(date_frame, bg='#f9f9f9')
        month_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
        tk.Label(month_frame, text="Month:", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        months = [calendar.month_name[m] for m in range(1,13)]
        self.fee_month_var = tk.StringVar()
        self.fee_month_cb = ttk.Combobox(month_frame, textvariable=self.fee_month_var, values=months, state="readonly", width=15)
        self.fee_month_cb.pack(anchor=tk.W, pady=(2,0))
        self.fee_month_cb.set(calendar.month_name[date.today().month])

        # Year section
        year_frame = tk.Frame(date_frame, bg='#f9f9f9')
        year_frame.pack(side=tk.LEFT, padx=(20,0))
        tk.Label(year_frame, text="Year:", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        self.fee_year_var = tk.StringVar(value=str(date.today().year))
        self.fee_year_entry = tk.Entry(year_frame, textvariable=self.fee_year_var, width=8)
        self.fee_year_entry.pack(anchor=tk.W, pady=(2,0))

        # Amount section with better spacing
        amount_frame = tk.Frame(form, bg='#f9f9f9')
        amount_frame.pack(fill=tk.X, padx=10, pady=10)
        
        # Amount Due
        due_frame = tk.Frame(amount_frame, bg='#f9f9f9')
        due_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
        tk.Label(due_frame, text="Amount Due (GHS):", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        self.fee_amount_due = tk.Entry(due_frame, width=15)
        self.fee_amount_due.pack(anchor=tk.W, pady=(2,0))
        self.fee_amount_due.insert(0, "0.00")

        # Amount Paid
        paid_frame = tk.Frame(amount_frame, bg='#f9f9f9')
        paid_frame.pack(side=tk.LEFT, padx=(20,0))
        tk.Label(paid_frame, text="Amount Paid (GHS):", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        self.fee_amount_paid = tk.Entry(paid_frame, width=15)
        self.fee_amount_paid.pack(anchor=tk.W, pady=(2,0))
        self.fee_amount_paid.insert(0, "0.00")

        # Fee Type and Payment Mode section
        fee_details_frame = tk.Frame(form, bg='#f9f9f9')
        fee_details_frame.pack(fill=tk.X, padx=10, pady=10)
        
        # Fee Type section
        fee_type_frame = tk.Frame(fee_details_frame, bg='#f9f9f9')
        fee_type_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
        tk.Label(fee_type_frame, text="Fee Type:", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        fee_types = ["Tuition", "Feeding", "Bus"]
        self.fee_type_var = tk.StringVar()
        self.fee_type_cb = ttk.Combobox(fee_type_frame, textvariable=self.fee_type_var, values=fee_types, state="readonly", width=15)
        self.fee_type_cb.pack(anchor=tk.W, pady=(2,0))
        self.fee_type_cb.set("Tuition")
        
        # Payment Mode section
        payment_mode_frame = tk.Frame(fee_details_frame, bg='#f9f9f9')
        payment_mode_frame.pack(side=tk.LEFT, padx=(20,0))
        tk.Label(payment_mode_frame, text="Payment Mode:", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        payment_modes = ["Cash", "MoMo", "Bank"]
        self.payment_mode_var = tk.StringVar()
        self.payment_mode_cb = ttk.Combobox(payment_mode_frame, textvariable=self.payment_mode_var, values=payment_modes, state="readonly", width=15)
        self.payment_mode_cb.pack(anchor=tk.W, pady=(2,0))
        self.payment_mode_cb.set("Cash")
        
        # Checkboxes section (legacy fields for backward compatibility)
        checkbox_frame = tk.Frame(form, bg='#f9f9f9')
        checkbox_frame.pack(fill=tk.X, padx=10, pady=10)
        tk.Label(checkbox_frame, text="Additional Fees:", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        
        checkbox_options = tk.Frame(checkbox_frame, bg='#f9f9f9')
        checkbox_options.pack(fill=tk.X, pady=(5,0))
        
        self.fee_feeding_var = tk.BooleanVar()
        self.fee_bus_var = tk.BooleanVar()
        tk.Checkbutton(checkbox_options, text="Feeding Fee Paid", variable=self.fee_feeding_var, bg='#f9f9f9').pack(side=tk.LEFT, padx=(0,15))
        tk.Checkbutton(checkbox_options, text="Bus Fee Paid", variable=self.fee_bus_var, bg='#f9f9f9').pack(side=tk.LEFT)

        # Payment date section
        payment_date_frame = tk.Frame(form, bg='#f9f9f9')
        payment_date_frame.pack(fill=tk.X, padx=10, pady=10)
        tk.Label(payment_date_frame, text="Payment Date:", bg='#f9f9f9', font=('Arial', 10, 'bold')).pack(anchor=tk.W)
        if CALENDAR_AVAILABLE:
            self.fee_payment_date = DateEntry(payment_date_frame, width=18, background='darkblue',
                                            foreground='white', borderwidth=2, date_pattern='y-mm-dd')
        else:
            self.fee_payment_date = tk.Entry(payment_date_frame, width=20)
            self.fee_payment_date.insert(0, date.today().strftime("%Y-%m-%d"))
        self.fee_payment_date.pack(anchor=tk.W, pady=(2,0))

        # Modern buttons section
        btns_container = tk.Frame(form, bg='#f9f9f9')
        btns_container.pack(fill=tk.X, padx=10, pady=20)
        
        btns = tk.Frame(btns_container, bg='#f9f9f9')
        btns.pack()
        
        add_btn = self.create_modern_button(btns, "💾 Add Payment", self.add_fee, 'primary', width=15)
        add_btn.grid(row=0, column=0, padx=5, pady=3)
        
        update_btn = self.create_modern_button(btns, "📱 Update Payment", self.update_fee, 'success', width=15)
        update_btn.grid(row=0, column=1, padx=5, pady=3)
        
        delete_btn = self.create_modern_button(btns, "🧹 Delete Payment", self.delete_fee, 'danger', width=15)
        delete_btn.grid(row=1, column=0, columnspan=2, padx=5, pady=3)
        
        # Add some bottom padding
        tk.Frame(form, bg='#f9f9f9', height=20).pack()

        # Right: tree list with better layout
        right = tk.Frame(frame, bg='#ffffff')
        right.pack(fill=tk.BOTH, expand=True)

        # Modern tree header with transparent background
        tree_header = tk.Frame(right, relief=tk.FLAT, bd=0)
        tree_header.pack(fill=tk.X, pady=(0,15))
        
        header_content = tk.Frame(tree_header, bg='#34495e', relief=tk.FLAT)
        header_content.pack(fill=tk.X)
        
        tk.Label(header_content, text="📊 Fee Records Database", 
                font=('Segoe UI', 14, 'bold'), bg='#34495e', fg='white', pady=12).pack()
        
        # Filter section for fees
        fee_filter_frame = tk.Frame(right, bg='#f8f9fa', relief=tk.FLAT, bd=1)
        fee_filter_frame.pack(fill=tk.X, padx=10, pady=(0, 10))
        
        fee_filter_content = tk.Frame(fee_filter_frame, bg='#f8f9fa')
        fee_filter_content.pack(fill=tk.X, padx=15, pady=10)
        
        tk.Label(fee_filter_content, text="🔍 Filter by Class:", 
                font=('Segoe UI', 10, 'bold'), bg='#f8f9fa', fg='#2c3e50').pack(side=tk.LEFT, padx=(0, 10))
        
        # Get all classes for filter
        self.cursor.execute("SELECT id, class_name FROM classes ORDER BY class_name")
        classes = self.cursor.fetchall()
        class_options = ["All Classes"] + [c[1] for c in classes]
        
        self.fee_class_filter_var = tk.StringVar(value="All Classes")
        fee_class_filter = ttk.Combobox(fee_filter_content, textvariable=self.fee_class_filter_var, 
                                       values=class_options, state="readonly", width=20)
        fee_class_filter.pack(side=tk.LEFT, padx=(0, 15))
        fee_class_filter.bind('<<ComboboxSelected>>', lambda e: self.load_fees())

        # Tree container with scrollbars
        tree_container = tk.Frame(right, bg='#ffffff')
        tree_container.pack(fill=tk.BOTH, expand=True)

        cols = ('ID', 'Student', 'Month', 'Year', 'Fee Type', 'Amount Due', 'Amount Paid', 'Arrears', 'Payment Mode', 'Feeding', 'Bus', 'Payment Date')
        self.fees_tree = ttk.Treeview(tree_container, columns=cols, show='headings', height=18)
        
        # Set column widths for better display
        column_widths = {
            'ID': 50, 'Student': 140, 'Month': 70, 'Year': 50, 'Fee Type': 80,
            'Amount Due': 90, 'Amount Paid': 90, 'Arrears': 70, 'Payment Mode': 90,
            'Feeding': 60, 'Bus': 60, 'Payment Date': 100
        }
        
        for c in cols:
            self.fees_tree.heading(c, text=c)
            self.fees_tree.column(c, width=column_widths.get(c, 100), minwidth=50)
            
        # Scrollbars
        vs = ttk.Scrollbar(tree_container, orient=tk.VERTICAL, command=self.fees_tree.yview)
        hs = ttk.Scrollbar(tree_container, orient=tk.HORIZONTAL, command=self.fees_tree.xview)
        self.fees_tree.configure(yscrollcommand=vs.set, xscrollcommand=hs.set)
        
        # Grid layout for better scrollbar positioning
        self.fees_tree.grid(row=0, column=0, sticky='nsew')
        vs.grid(row=0, column=1, sticky='ns')
        hs.grid(row=1, column=0, sticky='ew')
        
        tree_container.grid_rowconfigure(0, weight=1)
        tree_container.grid_columnconfigure(0, weight=1)
        
        self.fees_tree.bind('<<TreeviewSelect>>', self.on_fee_select)
        
        # Enable mouse wheel scrolling
        self.bind_treeview_mousewheel(self.fees_tree)

        # Load fees
        self.load_fees()
        
        # Update scroll regions for both scrollable frames
        scrollable_form.update_scrollregion()
        scrollable_fees.update_scrollregion()

    def load_fees(self):
        # Clear existing data
        for item in self.fees_tree.get_children():
            self.fees_tree.delete(item)
        
        # Get class filter value
        class_filter = getattr(self, 'fee_class_filter_var', None)
        selected_class = class_filter.get() if class_filter else "All Classes"
        
        # Build query based on user role and class filter
        if self.current_user.get('role') == 'teacher':
            # Teacher sees only students from their assigned class
            teacher_class_id = self.get_teacher_assigned_class()
            if teacher_class_id:
                query = '''
                    SELECT f.id, s.name, f.month, f.year, f.fee_type, f.amount_due, f.amount_paid, f.arrears, 
                           f.payment_mode, f.feeding_fee_paid, f.bus_fee_paid, f.payment_date
                    FROM fees f 
                    JOIN students s ON f.student_id = s.id
                    WHERE s.class_id = ?
                    ORDER BY f.year DESC, f.month DESC, f.id DESC
                '''
                params = (teacher_class_id,)
            else:
                # Teacher not assigned to any class
                return
        elif selected_class != "All Classes":
            # Admin/staff with class filter
            query = '''
                SELECT f.id, s.name, f.month, f.year, f.fee_type, f.amount_due, f.amount_paid, f.arrears, 
                       f.payment_mode, f.feeding_fee_paid, f.bus_fee_paid, f.payment_date
                FROM fees f 
                JOIN students s ON f.student_id = s.id
                JOIN classes c ON s.class_id = c.id
                WHERE c.class_name = ?
                ORDER BY f.year DESC, f.month DESC, f.id DESC
            '''
            params = (selected_class,)
        else:
            # Admin/staff without filter - see all
            query = '''
                SELECT f.id, s.name, f.month, f.year, f.fee_type, f.amount_due, f.amount_paid, f.arrears, 
                       f.payment_mode, f.feeding_fee_paid, f.bus_fee_paid, f.payment_date
                FROM fees f 
                JOIN students s ON f.student_id = s.id
                ORDER BY f.year DESC, f.month DESC, f.id DESC
            '''
            params = ()
        
        # Load fees from database with student names, fee type and payment mode
        self.cursor.execute(query, params)
        fees = self.cursor.fetchall()
        
        for fee in fees:
            # Convert boolean values to readable text
            feeding_status = "Yes" if fee[9] else "No"
            bus_status = "Yes" if fee[10] else "No"
            fee_type = fee[4] or "Tuition"
            payment_mode = fee[8] or "Cash"
            
            # Format the row for display
            # Columns: ID, Student, Month, Year, Fee Type, Amount Due, Amount Paid, Arrears, Payment Mode, Feeding, Bus, Payment Date
            display_row = (fee[0], fee[1], fee[2], fee[3], fee_type, fee[5], fee[6], fee[7], 
                          payment_mode, feeding_status, bus_status, fee[11])
            self.fees_tree.insert('', tk.END, values=display_row)

    def update_fee_statistics(self):
        """Update the fee statistics display in real-time"""
        try:
            # Calculate total collected fees
            self.cursor.execute("SELECT SUM(amount_paid) FROM fees WHERE amount_paid > 0")
            result = self.cursor.fetchone()[0]
            total_collected = result if result else 0
            
            # Calculate pending fees (assuming monthly fee from students table)
            self.cursor.execute("""
                SELECT SUM(s.monthly_fee) 
                FROM students s 
                WHERE s.monthly_fee IS NOT NULL AND s.status = 'Active'
            """)
            result = self.cursor.fetchone()[0] 
            total_expected = result if result else 0
            pending_fees = total_expected - total_collected if total_expected > total_collected else 0
            
            # Calculate this month's collections
            current_month = datetime.now().strftime('%Y-%m')
            self.cursor.execute("""
                SELECT SUM(amount_paid) FROM fees 
                WHERE strftime('%Y-%m', payment_date) = ?
            """, (current_month,))
            result = self.cursor.fetchone()[0]
            monthly_total = result if result else 0
            
            # Update labels if they exist
            if hasattr(self, 'total_fees_stat'):
                self.total_fees_stat.config(text=f"Total Collected: GHS {total_collected:.2f}")
                self.pending_fees_stat.config(text=f"Pending: GHS {pending_fees:.2f}")
                self.monthly_total_stat.config(text=f"This Month: GHS {monthly_total:.2f}")
                
        except Exception as e:
            print(f"Error updating fee statistics: {e}")
    
    def search_student_fees(self):
        """Search and display all fee records for a specific student"""
        search_term = self.fee_search_var.get().strip()
        if not search_term:
            messagebox.showinfo("Search", "Please enter a student name or ID to search")
            return
        
        # Clear existing data
        for item in self.fees_tree.get_children():
            self.fees_tree.delete(item)
        
        # Build search query based on user role
        if self.current_user.get('role') == 'teacher':
            # Teacher sees only students from their assigned class
            teacher_class_id = self.get_teacher_assigned_class()
            if teacher_class_id:
                search_query = '''
                    SELECT f.id, s.name, f.month, f.year, f.amount_due, f.amount_paid, f.arrears, 
                           f.feeding_fee_paid, f.bus_fee_paid, f.payment_date
                    FROM fees f 
                    JOIN students s ON f.student_id = s.id
                    WHERE s.class_id = ? AND (s.name LIKE ? OR s.student_id LIKE ?)
                '''
                search_params = [teacher_class_id, f'%{search_term}%', f'%{search_term}%']
            else:
                messagebox.showinfo("Search Results", "You are not assigned to any class")
                return
        else:
            # Admin and other roles see all students
            search_query = '''
                SELECT f.id, s.name, f.month, f.year, f.amount_due, f.amount_paid, f.arrears, 
                       f.feeding_fee_paid, f.bus_fee_paid, f.payment_date
                FROM fees f 
                JOIN students s ON f.student_id = s.id
                WHERE (s.name LIKE ? OR s.student_id LIKE ?)
            '''
            search_params = [f'%{search_term}%', f'%{search_term}%']
        
        # Add optional month filter
        search_month = self.fee_search_month_var.get()
        if search_month and search_month != "All":
            search_query += " AND f.month = ?"
            search_params.append(search_month)
        
        # Add optional year filter
        search_year = self.fee_search_year_var.get().strip()
        if search_year:
            try:
                year_int = int(search_year)
                search_query += " AND f.year = ?"
                search_params.append(year_int)
            except ValueError:
                pass
        
        search_query += " ORDER BY f.year DESC, f.month DESC, f.id DESC"
        
        # Execute search
        self.cursor.execute(search_query, search_params)
        fees = self.cursor.fetchall()
        
        if not fees:
            messagebox.showinfo("Search Results", f"No fee records found for '{search_term}'")
            return
        
        # Display results
        total_due = 0
        total_paid = 0
        total_arrears = 0
        
        for fee in fees:
            # Convert boolean values to readable text
            feeding_status = "Yes" if fee[7] else "No"
            bus_status = "Yes" if fee[8] else "No"
            
            # Format the row for display
            display_row = (fee[0], fee[1], fee[2], fee[3], fee[4], fee[5], fee[6], 
                          feeding_status, bus_status, fee[9])
            self.fees_tree.insert('', tk.END, values=display_row)
            
            # Calculate totals
            total_due += fee[4] or 0
            total_paid += fee[5] or 0
            total_arrears += fee[6] or 0
        
        # Show summary message
        summary_msg = f"""Search Results for '{search_term}':

Found {len(fees)} fee record(s)

Financial Summary:
• Total Amount Due: GHS {total_due:.2f}
• Total Amount Paid: GHS {total_paid:.2f}
• Total Arrears: GHS {total_arrears:.2f}
• Balance: GHS {(total_due - total_paid):.2f}"""
        
        messagebox.showinfo("Search Results", summary_msg)
        # Update status bar
        self.update_status(f"Found {len(fees)} fee record(s) for '{search_term}'")
    
    def clear_fee_search(self):
        """Clear search fields and reload all fees"""
        self.fee_search_var.set("")
        self.fee_search_month_var.set("All")
        self.fee_search_year_var.set("")
        self.load_fees()
        self.update_status("Showing all fee records")

    def calculate_amount_due(self, event=None):
        """Automatically calculate and populate amount due based on student's arrears and monthly fee"""
        student_display = self.fee_student_var.get()
        student_id = self._fee_student_map.get(student_display)
        
        if not student_id:
            return
        
        try:
            # Get the student's monthly fee
            self.cursor.execute("SELECT monthly_fee FROM students WHERE id = ?", (student_id,))
            result = self.cursor.fetchone()
            monthly_fee = result[0] if result and result[0] else 0.0
            
            # Get the student's total arrears from previous months
            self.cursor.execute("""
                SELECT COALESCE(SUM(arrears), 0) 
                FROM fees 
                WHERE student_id = ?
            """, (student_id,))
            result = self.cursor.fetchone()
            total_arrears = result[0] if result else 0.0
            
            # Calculate amount due: arrears + current month's fee
            amount_due = total_arrears + monthly_fee
            
            # Update the amount due field
            self.fee_amount_due.delete(0, tk.END)
            self.fee_amount_due.insert(0, f"{amount_due:.2f}")
            
        except Exception as e:
            print(f"Error calculating amount due: {e}")

    def add_fee(self):
        student_display = self.fee_student_var.get()
        student_id = self._fee_student_map.get(student_display)
        if not student_id:
            messagebox.showerror("Error", "Select a student")
            return
        month = self.fee_month_var.get()
        year = int(self.fee_year_var.get() or date.today().year)
        fee_type = self.fee_type_var.get() or "Tuition"
        payment_mode = self.payment_mode_var.get() or "Cash"
        try:
            amount_due = float(self.fee_amount_due.get() or 0.0)
            amount_paid = float(self.fee_amount_paid.get() or 0.0)
        except ValueError:
            messagebox.showerror("Error", "Invalid amount")
            return
        arrears = max(0.0, amount_due - amount_paid)
        feeding = 1 if self.fee_feeding_var.get() else 0
        bus = 1 if self.fee_bus_var.get() else 0
        
        # Handle DateEntry for payment date
        payment_date = self.fee_payment_date.get_date().strftime('%Y-%m-%d')

        try:
            self.cursor.execute('''
                INSERT INTO fees (student_id, month, year, amount_due, amount_paid, arrears, feeding_fee_paid, bus_fee_paid, payment_date, fee_type, payment_mode)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (student_id, month, year, amount_due, amount_paid, arrears, feeding, bus, payment_date, fee_type, payment_mode))
            fee_id = self.cursor.lastrowid
            self.conn.commit()
            
            # Create corresponding financial transaction if payment was made
            if amount_paid > 0:
                self.create_financial_transaction_for_fee_payment(
                    student_id, amount_paid, payment_date, fee_id
                )
            
            messagebox.showinfo("Success", "Payment recorded and financial transaction created")
            self.load_fees()
            self.update_dashboard()
        except Exception as e:
            messagebox.showerror("Error", str(e))

    def update_fee(self):
        sel = self.fees_tree.selection()
        if not sel:
            messagebox.showerror("Error", "Select a fee record to update")
            return
        fee_id = self.fees_tree.item(sel[0])['values'][0]
        student_display = self.fee_student_var.get()
        student_id = self._fee_student_map.get(student_display)
        if not student_id:
            messagebox.showerror("Error", "Select a student")
            return
        month = self.fee_month_var.get()
        fee_type = self.fee_type_var.get() or "Tuition"
        payment_mode = self.payment_mode_var.get() or "Cash"
        try:
            year = int(self.fee_year_var.get() or date.today().year)
            amount_due = float(self.fee_amount_due.get() or 0.0)
            amount_paid = float(self.fee_amount_paid.get() or 0.0)
        except ValueError:
            messagebox.showerror("Error", "Invalid numeric value")
            return
        arrears = max(0.0, amount_due - amount_paid)
        feeding = 1 if self.fee_feeding_var.get() else 0
        bus = 1 if self.fee_bus_var.get() else 0
        
        # Handle DateEntry for payment date
        payment_date = self.fee_payment_date.get_date().strftime('%Y-%m-%d')

        try:
            # Get the current amount_paid for comparison
            self.cursor.execute("SELECT amount_paid FROM fees WHERE id = ?", (fee_id,))
            old_amount_result = self.cursor.fetchone()
            old_amount_paid = old_amount_result[0] if old_amount_result else 0.0
            
            # Update the fee record
            self.cursor.execute('''
                UPDATE fees SET student_id=?, month=?, year=?, amount_due=?, amount_paid=?, arrears=?, feeding_fee_paid=?, bus_fee_paid=?, payment_date=?, fee_type=?, payment_mode=?
                WHERE id = ?
            ''', (student_id, month, year, amount_due, amount_paid, arrears, feeding, bus, payment_date, fee_type, payment_mode, fee_id))
            self.conn.commit()
            
            # Update corresponding financial transaction if payment amount changed
            if old_amount_paid != amount_paid:
                self.update_financial_transaction_for_fee_payment(
                    fee_id, old_amount_paid, amount_paid, payment_date, student_id
                )
            
            messagebox.showinfo("Success", "Payment and financial records updated")
            self.load_fees()
            self.update_dashboard()
        except Exception as e:
            messagebox.showerror("Error", str(e))

    def delete_fee(self):
        sel = self.fees_tree.selection()
        if not sel:
            messagebox.showerror("Error", "Select a fee record to delete")
            return
        fee_id = self.fees_tree.item(sel[0])['values'][0]
        if not messagebox.askyesno("Confirm", "Delete selected fee record?"):
            return
        try:
            # Delete corresponding financial transaction first
            self.cursor.execute("""
                DELETE FROM financial_transactions 
                WHERE reference_number = ? AND transaction_type = 'income'
            """, (f"FEE-{fee_id}",))
            
            # Delete the fee record
            self.cursor.execute("DELETE FROM fees WHERE id = ?", (fee_id,))
            self.conn.commit()
            
            # Log the sync activity
            if hasattr(self, 'sync_manager') and self.sync_manager:
                self.sync_manager.log_activity(
                    'fee_deletion_sync',
                    f"Deleted fee {fee_id} and corresponding financial transaction",
                    {'fee_id': fee_id}
                )
            
            messagebox.showinfo("Success", "Payment and financial records deleted")
            self.load_fees()
            self.update_dashboard()
        except Exception as e:
            messagebox.showerror("Error", str(e))

    def on_fee_select(self, event):
        sel = self.fees_tree.selection()
        if not sel:
            return
        vals = self.fees_tree.item(sel[0])['values']
        # vals => (id, student_name, month, year, fee_type, amount_due, amount_paid, arrears, payment_mode, feeding, bus, payment_date)
        fee_id, student_name = vals[0], vals[1]
        # try to match student display key by searching map values
        inv_map = {v:k for k,v in getattr(self, "_fee_student_map", {}).items()}
        student_display = inv_map.get(student_name) or next((k for k,v in getattr(self,"_fee_student_map",{}).items() if str(v) in str(student_name)), "")
        # fallback: use first matching entry that contains student name
        if not student_display:
            for k in getattr(self, "_fee_student_map", {}):
                if student_name in k:
                    student_display = k
                    break
        self.fee_student_var.set(student_display)
        self.fee_month_var.set(vals[2])
        self.fee_year_var.set(str(vals[3]))
        self.fee_type_var.set(vals[4] or "Tuition")
        self.fee_amount_due.delete(0, tk.END); self.fee_amount_due.insert(0, str(vals[5]))
        self.fee_amount_paid.delete(0, tk.END); self.fee_amount_paid.insert(0, str(vals[6]))
        self.payment_mode_var.set(vals[8] or "Cash")
        self.fee_feeding_var.set(True if vals[9] in (1, '1', 'Yes', True) else False)
        self.fee_bus_var.set(True if vals[10] in (1, '1', 'Yes', True) else False)
        
        # Handle DateEntry for payment date
        if vals[11]:
            try:
                payment_date = datetime.strptime(str(vals[11]), '%Y-%m-%d').date()
                self.fee_payment_date.set_date(payment_date)
            except:
                self.fee_payment_date.set_date(date.today())
        else:
            self.fee_payment_date.set_date(date.today())

    # ============ FEE-FINANCIAL SYNCHRONIZATION HELPERS ============
    
    def create_financial_transaction_for_fee_payment(self, student_id, amount_paid, payment_date, fee_id, description_prefix="School Fee Payment"):
        """
        Creates a financial transaction entry when a fee payment is made.
        This ensures fee payments are reflected in financial reports.
        """
        if amount_paid <= 0:
            return  # No payment to record
            
        try:
            # Get the "School Fees" category ID
            self.cursor.execute("SELECT id FROM financial_categories WHERE category_name = 'School Fees'")
            category_result = self.cursor.fetchone()
            if not category_result:
                print("Warning: 'School Fees' category not found. Creating it...")
                self.cursor.execute("""
                    INSERT INTO financial_categories (category_name, category_type, description)
                    VALUES ('School Fees', 'income', 'Student tuition and school fees')
                """)
                self.conn.commit()
                category_id = self.cursor.lastrowid
            else:
                category_id = category_result[0]
            
            # Get student name for description
            self.cursor.execute("SELECT name FROM students WHERE id = ?", (student_id,))
            student_result = self.cursor.fetchone()
            student_name = student_result[0] if student_result else f"Student ID {student_id}"
            
            # Create description
            description = f"{description_prefix} - {student_name} (Fee ID: {fee_id})"
            
            # Get current user ID
            created_by = self.current_user.get('id', 1) if self.current_user else 1
            
            # Insert financial transaction
            self.cursor.execute('''
                INSERT INTO financial_transactions (
                    transaction_date, category_id, transaction_type, amount, description,
                    reference_number, payment_method, created_by, notes
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                payment_date,
                category_id,
                'income',
                amount_paid,
                description,
                f"FEE-{fee_id}",
                'Cash',
                created_by,
                f"Automatically created from fee payment system"
            ))
            
            self.conn.commit()
            print(f"Financial transaction created for fee payment: {amount_paid} for {student_name}")
            
            # Log the sync activity if sync manager is available
            if hasattr(self, 'sync_manager') and self.sync_manager:
                self.sync_manager.log_activity(
                    'fee_payment_sync',
                    f"Created financial transaction for fee payment: {amount_paid} for {student_name}",
                    {'fee_id': fee_id, 'transaction_amount': amount_paid, 'student_id': student_id}
                )
                
        except Exception as e:
            print(f"Error creating financial transaction for fee payment: {e}")
            # Don't raise the exception to avoid breaking the fee payment process
            
    def update_financial_transaction_for_fee_payment(self, fee_id, old_amount_paid, new_amount_paid, payment_date, student_id):
        """
        Updates or creates financial transaction when fee payment amount changes.
        """
        try:
            # Find existing financial transaction for this fee
            self.cursor.execute("""
                SELECT id, amount FROM financial_transactions 
                WHERE reference_number = ? AND transaction_type = 'income'
            """, (f"FEE-{fee_id}",))
            existing_transaction = self.cursor.fetchone()
            
            if existing_transaction:
                transaction_id, current_amount = existing_transaction
                if new_amount_paid <= 0:
                    # Delete the transaction if no payment
                    self.cursor.execute("DELETE FROM financial_transactions WHERE id = ?", (transaction_id,))
                    print(f"Deleted financial transaction for fee {fee_id} (payment reduced to 0)")
                else:
                    # Update the transaction amount and date
                    self.cursor.execute("""
                        UPDATE financial_transactions 
                        SET amount = ?, transaction_date = ?
                        WHERE id = ?
                    """, (new_amount_paid, payment_date, transaction_id))
                    print(f"Updated financial transaction for fee {fee_id}: {current_amount} -> {new_amount_paid}")
            else:
                # No existing transaction, create new one if there's a payment
                if new_amount_paid > 0:
                    self.create_financial_transaction_for_fee_payment(
                        student_id, new_amount_paid, payment_date, fee_id, "Updated School Fee Payment"
                    )
            
            self.conn.commit()
            
            # Log the sync activity
            if hasattr(self, 'sync_manager') and self.sync_manager:
                self.sync_manager.log_activity(
                    'fee_payment_update_sync',
                    f"Updated financial transaction for fee {fee_id}: {old_amount_paid} -> {new_amount_paid}",
                    {'fee_id': fee_id, 'old_amount': old_amount_paid, 'new_amount': new_amount_paid}
                )
                
        except Exception as e:
            print(f"Error updating financial transaction for fee payment: {e}")

    # ============ FINANCIAL MANAGEMENT SYSTEM ============
    
    def show_financial_management(self):
        """Main Financial Management Interface for Income and Expense Tracking"""
        if not self.check_permission_or_show_error('financial_management', 'Financial Management'):
            return
            
        self.clear_content_frame()
        
        # Create scrollable frame for financial management
        scrollable_financial = ScrollableFrame(self.content_frame, bg='#f8f9fa')
        scrollable_financial.pack(fill=tk.BOTH, expand=True)
        main_frame = scrollable_financial.get_frame()
        
        # Modern financial management header
        header_section = tk.Frame(main_frame, bg='#ffffff', relief=tk.FLAT, bd=0)
        header_section.pack(fill=tk.X, padx=0, pady=(0, 25))
        
        # Add subtle border effect
        header_border = tk.Frame(header_section, bg='#e9ecef', height=2, relief=tk.FLAT, bd=0)
        header_border.pack(fill=tk.X, side=tk.BOTTOM)
        
        header_content = tk.Frame(header_section, bg='#ffffff')
        header_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=25)
        
        # Header with title and dashboard button
        header_row = tk.Frame(header_content, bg='#ffffff')
        header_row.pack(fill=tk.X)
        
        title = tk.Label(header_row, text="📊 Financial Management System", 
                        font=('Segoe UI', 28, 'bold'), fg='#2c3e50', bg='#ffffff')
        title.pack(side=tk.LEFT, anchor=tk.W)
        
        # Dashboard button
        dashboard_btn = tk.Button(header_row, text="📈 Financial Dashboard", 
                                 command=self.show_financial_dashboard,
                                 font=('Segoe UI', 11, 'bold'), bg='#17a2b8', fg='white',
                                 relief=tk.FLAT, bd=0, padx=20, pady=8, cursor='hand2')
        dashboard_btn.pack(side=tk.RIGHT, padx=(10, 0))
        
        subtitle = tk.Label(header_content, text="Comprehensive Income and Expense Management for School Operations", 
                           font=('Segoe UI', 14), fg='#7f8c8d', bg='#ffffff')
        subtitle.pack(anchor=tk.W, pady=(8, 0))
        
        # Create notebook for different financial modules
        self.financial_notebook = ttk.Notebook(main_frame, style='Modern.TNotebook')
        self.financial_notebook.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 20))
        
        # Add tabs for different functionalities
        self.create_transaction_management_tab()
        self.create_category_management_tab()
        self.create_financial_reports_tab()
        self.create_budget_planning_tab()
        self.create_financial_analytics_tab()
        
        # Load initial data
        self.refresh_financial_data()
    
    def create_transaction_management_tab(self):
        """Create transaction recording and management tab"""
        transaction_frame = ttk.Frame(self.financial_notebook)
        self.financial_notebook.add(transaction_frame, text="💳 Transactions")
        
        # Create main container with two panels
        main_container = tk.Frame(transaction_frame, bg='#f8f9fa')
        main_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # Left Panel - Transaction Entry Form (wider to accommodate all fields)
        left_panel = tk.Frame(main_container, bg='#ffffff', relief='solid', bd=1, width=450)
        left_panel.pack(side=tk.LEFT, fill=tk.Y, padx=(0, 10), pady=5)
        left_panel.pack_propagate(False)
        
        # Form header
        form_header = tk.Frame(left_panel, bg='#28a745')
        form_header.pack(fill=tk.X)
        
        tk.Label(form_header, text="📝 Record New Transaction", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#28a745').pack(pady=15)
        
        # Scrollable form content with adequate padding
        scrollable_form = ScrollableFrame(left_panel, bg='#ffffff')
        scrollable_form.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        form = scrollable_form.get_frame()
        
        # Transaction Type Selection
        type_frame = tk.Frame(form, bg='#ffffff')
        type_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(type_frame, text="Transaction Type:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.transaction_type_var = tk.StringVar(value="income")
        self.selected_transaction_id = None  # For tracking transaction being edited
        type_selection_frame = tk.Frame(type_frame, bg='#ffffff')
        type_selection_frame.pack(fill=tk.X, pady=(5, 0))
        
        income_rb = tk.Radiobutton(type_selection_frame, text="💳 Income", 
                                  variable=self.transaction_type_var, value="income",
                                  font=('Segoe UI', 10), bg='#ffffff', fg='#27ae60',
                                  command=self.on_transaction_type_change)
        income_rb.pack(side=tk.LEFT, padx=(0, 20))
        
        expense_rb = tk.Radiobutton(type_selection_frame, text="💸 Expense", 
                                   variable=self.transaction_type_var, value="expense",
                                   font=('Segoe UI', 10), bg='#ffffff', fg='#e74c3c',
                                   command=self.on_transaction_type_change)
        expense_rb.pack(side=tk.LEFT)
        
        # Category Selection
        category_frame = tk.Frame(form, bg='#ffffff')
        category_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(category_frame, text="Category:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.transaction_category_var = tk.StringVar()
        self.category_dropdown = ttk.Combobox(category_frame, textvariable=self.transaction_category_var,
                                            font=('Segoe UI', 10), state='readonly', width=30)
        self.category_dropdown.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Amount Entry
        amount_frame = tk.Frame(form, bg='#ffffff')
        amount_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(amount_frame, text="Amount (GHS):", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.transaction_amount_var = tk.StringVar()
        amount_entry = tk.Entry(amount_frame, textvariable=self.transaction_amount_var,
                               font=('Segoe UI', 10), width=30)
        amount_entry.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Description
        desc_frame = tk.Frame(form, bg='#ffffff')
        desc_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(desc_frame, text="Description:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.transaction_description = tk.Text(desc_frame, height=3, font=('Segoe UI', 10), 
                                             wrap='word', width=30)
        self.transaction_description.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Reference Number
        ref_frame = tk.Frame(form, bg='#ffffff')
        ref_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(ref_frame, text="Reference Number:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.transaction_reference_var = tk.StringVar()
        ref_entry = tk.Entry(ref_frame, textvariable=self.transaction_reference_var,
                            font=('Segoe UI', 10), width=30)
        ref_entry.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Payment Method
        payment_frame = tk.Frame(form, bg='#ffffff')
        payment_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(payment_frame, text="Payment Method:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.payment_method_var = tk.StringVar(value="Cash")
        payment_methods = ["Cash", "Bank Transfer", "Check", "Mobile Money", "Credit Card", "Other"]
        payment_dropdown = ttk.Combobox(payment_frame, textvariable=self.payment_method_var,
                                       values=payment_methods, font=('Segoe UI', 10), 
                                       state='readonly', width=28)
        payment_dropdown.pack(anchor='w', pady=(5, 0))
        
        # Transaction Date
        date_frame = tk.Frame(form, bg='#ffffff')
        date_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(date_frame, text="Transaction Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.transaction_date = DateEntry(date_frame, width=25, background='#28a745',
                                        foreground='white', borderwidth=2, font=('Segoe UI', 10))
        self.transaction_date.pack(anchor='w', pady=(5, 0))
        
        # Notes
        notes_frame = tk.Frame(form, bg='#ffffff')
        notes_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(notes_frame, text="Additional Notes:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.transaction_notes = tk.Text(notes_frame, height=3, font=('Segoe UI', 10), 
                                       wrap='word', width=30)
        self.transaction_notes.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Action buttons
        buttons_frame = tk.Frame(form, bg='#ffffff')
        buttons_frame.pack(fill=tk.X, pady=(15, 20))  # Added bottom padding
        
        save_btn = tk.Button(buttons_frame, text="💾 Save Transaction", 
                           command=self.save_transaction,
                           font=('Segoe UI', 10, 'bold'), bg='#28a745', fg='white',
                           relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        save_btn.pack(fill=tk.X, pady=(0, 8))
        
        update_btn = tk.Button(buttons_frame, text="🔄 Update Transaction", 
                             command=self.update_transaction,
                             font=('Segoe UI', 10, 'bold'), bg='#3498db', fg='white',
                             relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        update_btn.pack(fill=tk.X, pady=(0, 8))
        
        delete_btn = tk.Button(buttons_frame, text="🧹 Delete Transaction", 
                             command=self.delete_transaction,
                             font=('Segoe UI', 10, 'bold'), bg='#e74c3c', fg='white',
                             relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        delete_btn.pack(fill=tk.X, pady=(0, 8))
        
        clear_btn = tk.Button(buttons_frame, text="🔄 Clear Form", 
                            command=self.clear_transaction_form,
                            font=('Segoe UI', 10, 'bold'), bg='#95a5a6', fg='white',
                            relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        clear_btn.pack(fill=tk.X)
        
        # Update scroll region after all form elements are added
        scrollable_form.update_scrollregion()
        
        # Right Panel - Transactions List
        right_panel = tk.Frame(main_container, bg='#ffffff', relief='solid', bd=1)
        right_panel.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, pady=5)
        
        # List header with filter controls
        list_header = tk.Frame(right_panel, bg='#34495e')
        list_header.pack(fill=tk.X)
        
        header_content = tk.Frame(list_header, bg='#34495e')
        header_content.pack(fill=tk.X, padx=15, pady=15)
        
        tk.Label(header_content, text="📊 Transaction Records", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#34495e').pack(side=tk.LEFT)
        
        # Filter controls
        filter_frame = tk.Frame(header_content, bg='#34495e')
        filter_frame.pack(side=tk.RIGHT)
        
        tk.Label(filter_frame, text="Filter:", font=('Segoe UI', 10, 'bold'), 
                fg='white', bg='#34495e').pack(side=tk.LEFT, padx=(0, 5))
        
        self.transaction_filter_var = tk.StringVar(value="All")
        filter_values = ["All", "Income", "Expense", "Today", "This Week", "This Month"]
        filter_dropdown = ttk.Combobox(filter_frame, textvariable=self.transaction_filter_var,
                                     values=filter_values, font=('Segoe UI', 9), 
                                     state='readonly', width=12)
        filter_dropdown.pack(side=tk.LEFT, padx=(0, 10))
        filter_dropdown.bind('<<ComboboxSelected>>', self.filter_transactions)
        
        refresh_btn = tk.Button(filter_frame, text="🔄", command=self.load_transactions,
                              font=('Segoe UI', 9, 'bold'), bg='#3498db', fg='white',
                              relief='flat', bd=0, padx=8, pady=2, cursor='hand2')
        refresh_btn.pack(side=tk.LEFT)
        
        # Transactions treeview
        tree_frame = tk.Frame(right_panel, bg='#ffffff')
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        columns = ('ID', 'Date', 'Type', 'Category', 'Amount', 'Description', 'Payment Method', 'Reference')
        self.transactions_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=15)
        
        # Define column headings and widths
        column_widths = {
            'ID': 50, 'Date': 80, 'Type': 70, 'Category': 120, 
            'Amount': 100, 'Description': 150, 'Payment Method': 100, 'Reference': 100
        }
        
        for col in columns:
            self.transactions_tree.heading(col, text=col)
            self.transactions_tree.column(col, width=column_widths.get(col, 100), minwidth=50)
        
        # Scrollbars for treeview
        v_scrollbar = ttk.Scrollbar(tree_frame, orient=tk.VERTICAL, command=self.transactions_tree.yview)
        h_scrollbar = ttk.Scrollbar(tree_frame, orient=tk.HORIZONTAL, command=self.transactions_tree.xview)
        self.transactions_tree.configure(yscrollcommand=v_scrollbar.set, xscrollcommand=h_scrollbar.set)
        
        self.transactions_tree.grid(row=0, column=0, sticky='nsew')
        v_scrollbar.grid(row=0, column=1, sticky='ns')
        h_scrollbar.grid(row=1, column=0, sticky='ew')
        
        tree_frame.grid_rowconfigure(0, weight=1)
        tree_frame.grid_columnconfigure(0, weight=1)
        
        # Bind transaction selection
        self.transactions_tree.bind('<<TreeviewSelect>>', self.on_transaction_select)
        self.transactions_tree.bind('<Double-1>', self.edit_selected_transaction)
        
        # Enable mouse wheel scrolling on treeview
        self.bind_treeview_mousewheel(self.transactions_tree)
        
        # Load initial data
        self.load_transaction_categories()
        self.load_transactions()
    
    def create_category_management_tab(self):
        """Create category management tab"""
        category_frame = ttk.Frame(self.financial_notebook)
        self.financial_notebook.add(category_frame, text="📋 Categories")
        
        # Create main container
        main_container = tk.Frame(category_frame, bg='#f8f9fa')
        main_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # Two-panel layout
        # Left Panel - Category Form
        left_panel = tk.Frame(main_container, bg='#ffffff', relief='solid', bd=1, width=350)
        left_panel.pack(side=tk.LEFT, fill=tk.Y, padx=(0, 10), pady=5)
        left_panel.pack_propagate(False)
        
        # Form header
        form_header = tk.Frame(left_panel, bg='#6f42c1')
        form_header.pack(fill=tk.X)
        
        tk.Label(form_header, text="📋 Create/Edit Category", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#6f42c1').pack(pady=15)
        
        # Scrollable form content
        scrollable_form = ScrollableFrame(left_panel, bg='#ffffff')
        scrollable_form.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
        form = scrollable_form.get_frame()
        
        # Category Name
        name_frame = tk.Frame(form, bg='#ffffff')
        name_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(name_frame, text="Category Name:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.category_name_var = tk.StringVar()
        self.selected_category_id = None  # For tracking category being edited
        category_name_entry = tk.Entry(name_frame, textvariable=self.category_name_var,
                                     font=('Segoe UI', 10), width=30)
        category_name_entry.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Category Type
        type_frame = tk.Frame(form, bg='#ffffff')
        type_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(type_frame, text="Category Type:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.category_type_var = tk.StringVar(value="income")
        type_selection_frame = tk.Frame(type_frame, bg='#ffffff')
        type_selection_frame.pack(fill=tk.X, pady=(5, 0))
        
        income_cat_rb = tk.Radiobutton(type_selection_frame, text="💳 Income", 
                                     variable=self.category_type_var, value="income",
                                     font=('Segoe UI', 10), bg='#ffffff', fg='#27ae60')
        income_cat_rb.pack(side=tk.LEFT, padx=(0, 20))
        
        expense_cat_rb = tk.Radiobutton(type_selection_frame, text="💸 Expense", 
                                      variable=self.category_type_var, value="expense",
                                      font=('Segoe UI', 10), bg='#ffffff', fg='#e74c3c')
        expense_cat_rb.pack(side=tk.LEFT)
        
        # Description
        desc_frame = tk.Frame(form, bg='#ffffff')
        desc_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(desc_frame, text="Description:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.category_description = tk.Text(desc_frame, height=4, font=('Segoe UI', 10), 
                                          wrap='word', width=30)
        self.category_description.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Action buttons
        buttons_frame = tk.Frame(form, bg='#ffffff')
        buttons_frame.pack(fill=tk.X, pady=(15, 0))
        
        save_cat_btn = tk.Button(buttons_frame, text="💾 Save Category", 
                               command=self.save_category,
                               font=('Segoe UI', 10, 'bold'), bg='#27ae60', fg='white',
                               relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        save_cat_btn.pack(fill=tk.X, pady=(0, 8))
        
        update_cat_btn = tk.Button(buttons_frame, text="🔄 Update Category", 
                                 command=self.update_category,
                                 font=('Segoe UI', 10, 'bold'), bg='#3498db', fg='white',
                                 relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        update_cat_btn.pack(fill=tk.X, pady=(0, 8))
        
        delete_cat_btn = tk.Button(buttons_frame, text="🧹 Delete Category", 
                                 command=self.delete_category,
                                 font=('Segoe UI', 10, 'bold'), bg='#e74c3c', fg='white',
                                 relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        delete_cat_btn.pack(fill=tk.X, pady=(0, 8))
        
        clear_cat_btn = tk.Button(buttons_frame, text="🔄 Clear Form", 
                                command=self.clear_category_form,
                                font=('Segoe UI', 10, 'bold'), bg='#95a5a6', fg='white',
                                relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        clear_cat_btn.pack(fill=tk.X)
        
        # Right Panel - Categories List
        right_panel = tk.Frame(main_container, bg='#ffffff', relief='solid', bd=1)
        right_panel.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, pady=5)
        
        # List header
        list_header = tk.Frame(right_panel, bg='#6f42c1')
        list_header.pack(fill=tk.X)
        
        tk.Label(list_header, text="💰 Financial Categories", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#6f42c1').pack(pady=15)
        
        # Categories treeview
        tree_frame = tk.Frame(right_panel, bg='#ffffff')
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        cat_columns = ('ID', 'Name', 'Type', 'Description', 'Status')
        self.categories_tree = ttk.Treeview(tree_frame, columns=cat_columns, 
                                           show='headings', height=12)
        
        # Configure columns
        column_widths = {'ID': 40, 'Name': 120, 'Type': 80, 'Description': 200, 'Status': 80}
        
        for col in cat_columns:
            self.categories_tree.heading(col, text=col)
            self.categories_tree.column(col, width=column_widths.get(col, 100))
        
        # Scrollbars
        cat_v_scrollbar = ttk.Scrollbar(tree_frame, orient=tk.VERTICAL, 
                                       command=self.categories_tree.yview)
        cat_h_scrollbar = ttk.Scrollbar(tree_frame, orient=tk.HORIZONTAL, 
                                       command=self.categories_tree.xview)
        self.categories_tree.configure(yscrollcommand=cat_v_scrollbar.set,
                                      xscrollcommand=cat_h_scrollbar.set)
        
        self.categories_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        cat_v_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        cat_h_scrollbar.pack(side=tk.BOTTOM, fill=tk.X)
        
        # Bind category selection
        self.categories_tree.bind('<<TreeviewSelect>>', self.on_category_select)
        
        # Enable mouse wheel scrolling
        self.bind_treeview_mousewheel(self.categories_tree)
        
        # Load categories
        self.load_categories()
    
    def create_financial_reports_tab(self):
        """Create financial reports and analytics tab"""
        reports_frame = ttk.Frame(self.financial_notebook)
        self.financial_notebook.add(reports_frame, text="📊 Reports")
        
        # Create scrollable content
        scrollable_reports = ScrollableFrame(reports_frame, bg='#f8f9fa')
        scrollable_reports.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        reports_content = scrollable_reports.get_frame()
        
        # Reports header
        header_frame = tk.Frame(reports_content, bg='#ffffff', relief='solid', bd=1)
        header_frame.pack(fill=tk.X, pady=(0, 25))
        
        header_content = tk.Frame(header_frame, bg='#e67e22')
        header_content.pack(fill=tk.X, padx=20, pady=15)
        
        tk.Label(header_content, text="📊 Financial Reports & Analytics", 
                font=('Segoe UI', 18, 'bold'), fg='white', bg='#e67e22').pack()
        
        # Quick stats cards
        stats_container = tk.Frame(reports_content, bg='#f8f9fa')
        stats_container.pack(fill=tk.X, pady=(0, 25))
        
        # Create financial summary cards
        self.create_financial_summary_cards(stats_container)
        
        # Report generation section
        report_gen_frame = tk.Frame(reports_content, bg='#ffffff', relief='solid', bd=1)
        report_gen_frame.pack(fill=tk.X, pady=(0, 25))
        
        gen_header = tk.Frame(report_gen_frame, bg='#34495e')
        gen_header.pack(fill=tk.X)
        
        tk.Label(gen_header, text="📁 Generate Custom Reports", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#34495e').pack(pady=12)
        
        # Report parameters
        params_frame = tk.Frame(report_gen_frame, bg='#ffffff')
        params_frame.pack(fill=tk.X, padx=30, pady=20)
        
        # Date range selection
        date_range_frame = tk.Frame(params_frame, bg='#ffffff')
        date_range_frame.pack(fill=tk.X, pady=(0, 15))
        
        tk.Label(date_range_frame, text="Report Period:", font=('Segoe UI', 12, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        period_selection = tk.Frame(date_range_frame, bg='#ffffff')
        period_selection.pack(fill=tk.X, pady=(10, 0))
        
        # From date
        from_frame = tk.Frame(period_selection, bg='#ffffff')
        from_frame.pack(side=tk.LEFT, padx=(0, 30))
        
        tk.Label(from_frame, text="From Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#495057', bg='#ffffff').pack(anchor='w')
        
        # Set to first day of current month
        first_day = date.today().replace(day=1)
        self.report_from_date = DateEntry(from_frame, width=12, background='#e67e22',
                                        foreground='white', borderwidth=2, font=('Segoe UI', 10))
        self.report_from_date.set_date(first_day)
        self.report_from_date.pack(anchor='w', pady=(2, 0))
        
        # To date  
        to_frame = tk.Frame(period_selection, bg='#ffffff')
        to_frame.pack(side=tk.LEFT, padx=(0, 30))
        
        tk.Label(to_frame, text="To Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#495057', bg='#ffffff').pack(anchor='w')
        
        self.report_to_date = DateEntry(to_frame, width=12, background='#e67e22',
                                       foreground='white', borderwidth=2, font=('Segoe UI', 10))
        self.report_to_date.pack(anchor='w', pady=(2, 0))
        
        # Quick period buttons
        quick_periods_frame = tk.Frame(period_selection, bg='#ffffff')
        quick_periods_frame.pack(side=tk.LEFT)
        
        tk.Label(quick_periods_frame, text="Quick Select:", font=('Segoe UI', 10, 'bold'), 
                fg='#495057', bg='#ffffff').pack(anchor='w')
        
        quick_buttons_row = tk.Frame(quick_periods_frame, bg='#ffffff')
        quick_buttons_row.pack(anchor='w', pady=(2, 0))
        
        period_buttons = [
            ("Today", self.set_today_period),
            ("This Week", self.set_week_period), 
            ("This Month", self.set_month_period),
            ("This Year", self.set_year_period)
        ]
        
        for text, command in period_buttons:
            btn = tk.Button(quick_buttons_row, text=text, command=command,
                          font=('Segoe UI', 8), bg='#95a5a6', fg='white',
                          relief='solid', bd=0, padx=8, pady=3, cursor='hand2')
            btn.pack(side=tk.LEFT, padx=(0, 5))
        
        # Report type selection
        report_type_frame = tk.Frame(params_frame, bg='#ffffff')
        report_type_frame.pack(fill=tk.X, pady=(15, 20))
        
        tk.Label(report_type_frame, text="Report Types:", font=('Segoe UI', 12, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        # Report generation buttons with grid layout
        reports_grid = tk.Frame(report_type_frame, bg='#ffffff')
        reports_grid.pack(fill=tk.X, pady=(15, 0))
        
        # Configure grid weights for equal distribution
        reports_grid.columnconfigure(0, weight=1)
        reports_grid.columnconfigure(1, weight=1)
        
        report_buttons = [
            ("📊 Income & Expense Summary", self.generate_income_expense_report, '#27ae60'),
            ("💳 Income Analysis", self.generate_income_analysis, '#3498db'),
            ("💸 Expense Analysis", self.generate_expense_analysis, '#e74c3c'),
            ("📈 Profit & Loss Statement", self.generate_profit_loss_report, '#9b59b6'),
            ("📋 Category Breakdown", self.generate_category_report, '#f39c12'),
            ("📊 Cash Flow Report", self.generate_cashflow_report, '#16a085')
        ]
        
        # Create buttons in organized grid (2 columns, 3 rows)
        for i, (text, command, color) in enumerate(report_buttons):
            row = i // 2
            col = i % 2
            
            btn = tk.Button(reports_grid, text=text, command=command,
                          font=('Segoe UI', 10, 'bold'), bg=color, fg='white',
                          relief='solid', bd=0, pady=12, cursor='hand2')
            btn.grid(row=row, column=col, sticky='ew', padx=5, pady=5)
    
    def create_budget_planning_tab(self):
        """Create budget planning and tracking tab"""
        budget_frame = ttk.Frame(self.financial_notebook)
        self.financial_notebook.add(budget_frame, text="💡 Budget Planning")
        
        # Create main container
        main_container = tk.Frame(budget_frame, bg='#f8f9fa')
        main_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # Two-panel layout
        # Left Panel - Budget Form
        left_panel = tk.Frame(main_container, bg='#ffffff', relief='solid', bd=1, width=350)
        left_panel.pack(side=tk.LEFT, fill=tk.Y, padx=(0, 10), pady=5)
        left_panel.pack_propagate(False)
        
        # Form header
        form_header = tk.Frame(left_panel, bg='#8e44ad')
        form_header.pack(fill=tk.X)
        
        tk.Label(form_header, text="💡 Create/Edit Budget", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#8e44ad').pack(pady=15)
        
        # Scrollable form content
        scrollable_form = ScrollableFrame(left_panel, bg='#ffffff')
        scrollable_form.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
        form = scrollable_form.get_frame()
        
        # Budget Name
        name_frame = tk.Frame(form, bg='#ffffff')
        name_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(name_frame, text="Budget Name:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.budget_name_var = tk.StringVar()
        budget_name_entry = tk.Entry(name_frame, textvariable=self.budget_name_var,
                                     font=('Segoe UI', 10), width=30)
        budget_name_entry.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Category Selection
        category_frame = tk.Frame(form, bg='#ffffff')
        category_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(category_frame, text="Category:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.budget_category_var = tk.StringVar()
        self.budget_category_dropdown = ttk.Combobox(category_frame, textvariable=self.budget_category_var,
                                                    font=('Segoe UI', 10), state='readonly', width=28)
        self.budget_category_dropdown.pack(anchor='w', pady=(5, 0), fill='x')
        self.load_budget_categories()
        
        # Budgeted Amount
        amount_frame = tk.Frame(form, bg='#ffffff')
        amount_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(amount_frame, text="Budgeted Amount (GHS):", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.budget_amount_var = tk.StringVar()
        budget_amount_entry = tk.Entry(amount_frame, textvariable=self.budget_amount_var,
                                      font=('Segoe UI', 10), width=30)
        budget_amount_entry.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Period Type
        period_frame = tk.Frame(form, bg='#ffffff')
        period_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(period_frame, text="Period Type:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.budget_period_var = tk.StringVar(value="monthly")
        period_types = ["monthly", "quarterly", "yearly"]
        period_dropdown = ttk.Combobox(period_frame, textvariable=self.budget_period_var,
                                      values=period_types, font=('Segoe UI', 10), 
                                      state='readonly', width=28)
        period_dropdown.pack(anchor='w', pady=(5, 0), fill='x')
        
        # Start Date
        start_date_frame = tk.Frame(form, bg='#ffffff')
        start_date_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(start_date_frame, text="Start Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        self.budget_start_date = DateEntry(start_date_frame, width=25, background='#8e44ad',
                                          foreground='white', borderwidth=2, font=('Segoe UI', 10))
        self.budget_start_date.pack(anchor='w', pady=(5, 0))
        
        # End Date
        end_date_frame = tk.Frame(form, bg='#ffffff')
        end_date_frame.pack(fill=tk.X, pady=(0, 12))
        
        tk.Label(end_date_frame, text="End Date:", font=('Segoe UI', 10, 'bold'), 
                fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        if CALENDAR_AVAILABLE:
            # Set to end of month
            end_of_month = date.today().replace(day=28) + timedelta(days=4)
            end_of_month = end_of_month - timedelta(days=end_of_month.day)
        self.budget_end_date = DateEntry(end_date_frame, width=25, background='#8e44ad',
                                        foreground='white', borderwidth=2, font=('Segoe UI', 10))
        self.budget_end_date.set_date(end_of_month)
        self.budget_end_date.pack(anchor='w', pady=(5, 0))
        
        # Action buttons
        buttons_frame = tk.Frame(form, bg='#ffffff')
        buttons_frame.pack(fill=tk.X, pady=(15, 0))
        
        save_btn = tk.Button(buttons_frame, text="💾 Save Budget", 
                            command=self.save_budget,
                            font=('Segoe UI', 10, 'bold'), bg='#27ae60', fg='white',
                            relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        save_btn.pack(fill=tk.X, pady=(0, 8))
        
        update_btn = tk.Button(buttons_frame, text="🔄 Update Budget", 
                              command=self.update_budget,
                              font=('Segoe UI', 10, 'bold'), bg='#3498db', fg='white',
                              relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        update_btn.pack(fill=tk.X, pady=(0, 8))
        
        delete_btn = tk.Button(buttons_frame, text="🧹 Delete Budget", 
                              command=self.delete_budget,
                              font=('Segoe UI', 10, 'bold'), bg='#e74c3c', fg='white',
                              relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        delete_btn.pack(fill=tk.X, pady=(0, 8))
        
        clear_btn = tk.Button(buttons_frame, text="🔄 Clear Form", 
                             command=self.clear_budget_form,
                             font=('Segoe UI', 10, 'bold'), bg='#95a5a6', fg='white',
                             relief='solid', bd=0, padx=15, pady=8, cursor='hand2')
        clear_btn.pack(fill=tk.X)
        
        # Right Panel - Budget List and Analysis
        right_panel = tk.Frame(main_container, bg='#ffffff', relief='solid', bd=1)
        right_panel.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, pady=5)
        
        # List header
        list_header = tk.Frame(right_panel, bg='#8e44ad')
        list_header.pack(fill=tk.X)
        
        tk.Label(list_header, text="💰 Budget Plans & Tracking", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#8e44ad').pack(pady=15)
        
        # Budget overview cards
        self.create_budget_overview_cards(right_panel)
        
        # Budgets treeview
        tree_frame = tk.Frame(right_panel, bg='#ffffff')
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        columns = ('ID', 'Name', 'Category', 'Budgeted', 'Spent', 'Remaining', 'Period', 'Status')
        self.budget_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=12)
        
        # Configure columns
        column_widths = {'ID': 40, 'Name': 120, 'Category': 120, 'Budgeted': 90, 
                        'Spent': 90, 'Remaining': 90, 'Period': 100, 'Status': 80}
        
        for col in columns:
            self.budget_tree.heading(col, text=col)
            self.budget_tree.column(col, width=column_widths.get(col, 100))
        
        # Scrollbars
        tree_scroll_y = ttk.Scrollbar(tree_frame, orient=tk.VERTICAL, command=self.budget_tree.yview)
        tree_scroll_x = ttk.Scrollbar(tree_frame, orient=tk.HORIZONTAL, command=self.budget_tree.xview)
        self.budget_tree.configure(yscrollcommand=tree_scroll_y.set, xscrollcommand=tree_scroll_x.set)
        
        self.budget_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        tree_scroll_y.pack(side=tk.RIGHT, fill=tk.Y)
        tree_scroll_x.pack(side=tk.BOTTOM, fill=tk.X)
        
        # Bind selection
        self.budget_tree.bind('<<TreeviewSelect>>', self.on_budget_select)
        
        # Enable mouse wheel scrolling
        self.bind_treeview_mousewheel(self.budget_tree)
        
        # Load budgets
        self.load_budgets()
        self.selected_budget_id = None
    
    # ============ FINANCIAL MANAGEMENT HELPER METHODS ============
    
    def on_transaction_type_change(self):
        """Update category dropdown when transaction type changes"""
        self.load_transaction_categories()
    
    def load_transaction_categories(self):
        """Load categories based on selected transaction type"""
        transaction_type = self.transaction_type_var.get()
        
        try:
            self.cursor.execute('''
                SELECT id, category_name FROM financial_categories 
                WHERE category_type = ? AND is_active = 1
                ORDER BY category_name
            ''', (transaction_type,))
            
            categories = self.cursor.fetchall()
            category_list = [f"{cat[0]} - {cat[1]}" for cat in categories]
            
            self.category_dropdown.configure(values=category_list)
            if category_list:
                self.category_dropdown.current(0)
                
        except Exception as e:
            print(f"Error loading categories: {e}")
    
    def save_transaction(self):
        """Save new financial transaction"""
        try:
            # Validate required fields
            if not all([
                self.transaction_category_var.get(),
                self.transaction_amount_var.get(),
                self.transaction_description.get("1.0", "end-1c").strip()
            ]):
                messagebox.showerror("Error", "Please fill in all required fields")
                return
            
            # Extract category ID
            category_text = self.transaction_category_var.get()
            category_id = int(category_text.split(' - ')[0]) if ' - ' in category_text else None
            
            if not category_id:
                messagebox.showerror("Error", "Please select a valid category")
                return
            
            # Validate amount
            try:
                amount = float(self.transaction_amount_var.get())
                if amount <= 0:
                    raise ValueError()
            except ValueError:
                messagebox.showerror("Error", "Please enter a valid amount greater than 0")
                return
            
            # Get transaction date
            transaction_date = self.transaction_date.get_date().strftime('%Y-%m-%d')
            
            # Get current user ID
            created_by = self.current_user.get('id', 1) if self.current_user else 1
            
            # Insert transaction
            self.cursor.execute('''
                INSERT INTO financial_transactions (
                    transaction_date, category_id, transaction_type, amount, description,
                    reference_number, payment_method, created_by, notes
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                transaction_date,
                category_id,
                self.transaction_type_var.get(),
                amount,
                self.transaction_description.get("1.0", "end-1c").strip(),
                self.transaction_reference_var.get().strip() or None,
                self.payment_method_var.get(),
                created_by,
                self.transaction_notes.get("1.0", "end-1c").strip() or None
            ))
            
            self.conn.commit()
            
            messagebox.showinfo("Success", 
                               f"{self.transaction_type_var.get().title()} transaction recorded successfully!")
            
            # Clear form and refresh data
            self.clear_transaction_form()
            self.load_transactions()
            self.refresh_financial_stats()
            
            # Update main dashboard
            if hasattr(self, 'update_dashboard'):
                self.update_dashboard()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to save transaction: {str(e)}")
    
    def update_transaction(self):
        """Update selected transaction"""
        if not hasattr(self, 'selected_transaction_id') or not self.selected_transaction_id:
            messagebox.showerror("Error", "Please select a transaction to update from the list")
            return
            
        try:
            # Validate required fields
            if not all([
                self.transaction_category_var.get(),
                self.transaction_amount_var.get(),
                self.transaction_description.get("1.0", "end-1c").strip()
            ]):
                messagebox.showerror("Error", "Please fill in all required fields")
                return
            
            # Extract category ID
            category_text = self.transaction_category_var.get()
            category_id = int(category_text.split(' - ')[0]) if ' - ' in category_text else None
            
            if not category_id:
                messagebox.showerror("Error", "Please select a valid category")
                return
            
            # Validate amount
            try:
                amount = float(self.transaction_amount_var.get())
                if amount <= 0:
                    raise ValueError()
            except ValueError:
                messagebox.showerror("Error", "Please enter a valid amount greater than 0")
                return
            
            # Get transaction date
            if CALENDAR_AVAILABLE and hasattr(self.transaction_date, 'get_date'):
                transaction_date = self.transaction_date.get_date().strftime('%Y-%m-%d')
            else:
                transaction_date = self.transaction_date.get() or date.today().strftime('%Y-%m-%d')
            
            # Update transaction
            self.cursor.execute('''
                UPDATE financial_transactions SET
                    transaction_date = ?, category_id = ?, transaction_type = ?, amount = ?,
                    description = ?, reference_number = ?, payment_method = ?, notes = ?
                WHERE id = ?
            ''', (
                transaction_date,
                category_id,
                self.transaction_type_var.get(),
                amount,
                self.transaction_description.get("1.0", "end-1c").strip(),
                self.transaction_reference_var.get().strip() or None,
                self.payment_method_var.get(),
                self.transaction_notes.get("1.0", "end-1c").strip() or None,
                self.selected_transaction_id
            ))
            
            self.conn.commit()
            
            messagebox.showinfo("Success", "Transaction updated successfully!")
            
            # Clear form and refresh data
            self.clear_transaction_form()
            self.load_transactions()
            self.refresh_financial_stats()
            self.selected_transaction_id = None
            
            # Update main dashboard
            if hasattr(self, 'update_dashboard'):
                self.update_dashboard()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to update transaction: {str(e)}")
    
    def delete_transaction(self):
        """Delete selected transaction"""
        if not hasattr(self, 'selected_transaction_id') or not self.selected_transaction_id:
            messagebox.showerror("Error", "Please select a transaction to delete by double-clicking it first")
            return
        
        try:
            # Get transaction details for confirmation
            self.cursor.execute('''
                SELECT ft.transaction_type, ft.amount, ft.description, fc.category_name
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.id = ?
            ''', (self.selected_transaction_id,))
            
            transaction = self.cursor.fetchone()
            if not transaction:
                messagebox.showerror("Error", "Transaction not found")
                return
            
            # Confirmation dialog
            confirm_msg = f"Are you sure you want to delete this transaction?\n\n"
            confirm_msg += f"Type: {transaction[0].title()}\n"
            confirm_msg += f"Amount: GHS {transaction[1]:.2f}\n"
            confirm_msg += f"Category: {transaction[3]}\n"
            confirm_msg += f"Description: {transaction[2][:50]}..."
            
            if not messagebox.askyesno("Confirm Deletion", confirm_msg):
                return
            
            # Delete the transaction
            self.cursor.execute('DELETE FROM financial_transactions WHERE id = ?', 
                              (self.selected_transaction_id,))
            self.conn.commit()
            
            messagebox.showinfo("Success", "Transaction deleted successfully!")
            
            # Clear form and refresh data
            self.clear_transaction_form()
            self.load_transactions()
            self.refresh_financial_stats()
            self.selected_transaction_id = None
            
            # Update main dashboard
            if hasattr(self, 'update_dashboard'):
                self.update_dashboard()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to delete transaction: {str(e)}")
    
    def clear_transaction_form(self):
        """Clear all transaction form fields"""
        self.transaction_amount_var.set("")
        self.transaction_description.delete("1.0", tk.END)
        self.transaction_reference_var.set("")
        self.transaction_notes.delete("1.0", tk.END)
        
        # Reset date to today
        if CALENDAR_AVAILABLE and hasattr(self.transaction_date, 'set_date'):
            self.transaction_date.set_date(date.today())
        else:
            self.transaction_date.delete(0, tk.END)
            self.transaction_date.insert(0, date.today().strftime('%Y-%m-%d'))
        
        # Reset to first category
        if hasattr(self, 'category_dropdown') and self.category_dropdown['values']:
            self.category_dropdown.current(0)
    
    def load_transactions(self):
        """Load and display all financial transactions"""
        if not hasattr(self, 'transactions_tree'):
            return
            
        # Clear existing data
        for item in self.transactions_tree.get_children():
            self.transactions_tree.delete(item)
        
        try:
            # Load transactions with category names
            self.cursor.execute('''
                SELECT ft.id, ft.transaction_date, ft.transaction_type, fc.category_name,
                       ft.amount, ft.description, ft.payment_method, ft.reference_number
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                ORDER BY ft.transaction_date DESC, ft.id DESC
                LIMIT 100
            ''')
            
            transactions = self.cursor.fetchall()
            
            for transaction in transactions:
                # Format amount with currency
                formatted_amount = f"GHS {transaction[4]:.2f}"
                
                # Color code by transaction type
                display_row = (
                    transaction[0],  # ID
                    transaction[1],  # Date
                    transaction[2].title(),  # Type
                    transaction[3],  # Category
                    formatted_amount,  # Amount
                    transaction[5][:50] + '...' if len(transaction[5]) > 50 else transaction[5],  # Description
                    transaction[6],  # Payment Method
                    transaction[7] or ''  # Reference
                )
                
                item = self.transactions_tree.insert('', tk.END, values=display_row)
                
                # Color code rows by transaction type
                if transaction[2] == 'income':
                    self.transactions_tree.set(item, 'Type', '💳 Income')
                else:
                    self.transactions_tree.set(item, 'Type', '💸 Expense')
                    
        except Exception as e:
            print(f"Error loading transactions: {e}")
    
    def filter_transactions(self, event=None):
        """Filter transactions based on selected criteria"""
        filter_value = self.transaction_filter_var.get()
        
        # Clear existing data
        for item in self.transactions_tree.get_children():
            self.transactions_tree.delete(item)
        
        try:
            query = '''
                SELECT ft.id, ft.transaction_date, ft.transaction_type, fc.category_name,
                       ft.amount, ft.description, ft.payment_method, ft.reference_number
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
            '''
            
            params = []
            
            if filter_value == "Income":
                query += " WHERE ft.transaction_type = ?"
                params.append("income")
            elif filter_value == "Expense":
                query += " WHERE ft.transaction_type = ?"
                params.append("expense")
            elif filter_value == "Today":
                query += " WHERE DATE(ft.transaction_date) = DATE('now')"
            elif filter_value == "This Week":
                query += " WHERE DATE(ft.transaction_date) >= DATE('now', '-7 days')"
            elif filter_value == "This Month":
                query += " WHERE strftime('%Y-%m', ft.transaction_date) = strftime('%Y-%m', 'now')"
            
            query += " ORDER BY ft.transaction_date DESC, ft.id DESC LIMIT 100"
            
            self.cursor.execute(query, params)
            transactions = self.cursor.fetchall()
            
            for transaction in transactions:
                formatted_amount = f"GHS {transaction[4]:.2f}"
                
                display_row = (
                    transaction[0],
                    transaction[1],
                    transaction[2].title(),
                    transaction[3],
                    formatted_amount,
                    transaction[5][:50] + '...' if len(transaction[5]) > 50 else transaction[5],
                    transaction[6],
                    transaction[7] or ''
                )
                
                item = self.transactions_tree.insert('', tk.END, values=display_row)
                
                if transaction[2] == 'income':
                    self.transactions_tree.set(item, 'Type', '💳 Income')
                else:
                    self.transactions_tree.set(item, 'Type', '💸 Expense')
                    
        except Exception as e:
            print(f"Error filtering transactions: {e}")
    
    def on_transaction_select(self, event):
        """Handle transaction selection"""
        selection = self.transactions_tree.selection()
        if selection:
            # You can populate form fields with selected transaction data
            pass
    
    def edit_selected_transaction(self, event):
        """Edit selected transaction on double-click"""
        selection = self.transactions_tree.selection()
        if not selection:
            return
            
        try:
            # Get transaction data from treeview
            transaction_data = self.transactions_tree.item(selection[0])['values']
            transaction_id = transaction_data[0]
            
            # Fetch complete transaction details from database
            self.cursor.execute('''
                SELECT ft.id, ft.transaction_date, ft.transaction_type, ft.category_id,
                       ft.amount, ft.description, ft.payment_method, ft.reference_number,
                       ft.notes, fc.category_name
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.id = ?
            ''', (transaction_id,))
            
            transaction = self.cursor.fetchone()
            if not transaction:
                messagebox.showerror("Error", "Transaction not found")
                return
            
            # Store selected transaction ID for updating
            self.selected_transaction_id = transaction_id
            
            # Populate form with transaction data
            self.transaction_type_var.set(transaction[2])
            
            # Set category
            category_text = f"{transaction[3]} - {transaction[9]}"
            self.transaction_category_var.set(category_text)
            
            # Set amount
            self.transaction_amount_var.set(str(transaction[4]))
            
            # Set description
            self.transaction_description.delete("1.0", tk.END)
            self.transaction_description.insert("1.0", transaction[5])
            
            # Set payment method
            self.payment_method_var.set(transaction[6])
            
            # Set reference number
            self.transaction_reference_var.set(transaction[7] or "")
            
            # Set notes
            self.transaction_notes.delete("1.0", tk.END)
            if transaction[8]:
                self.transaction_notes.insert("1.0", transaction[8])
            
            # Set date
            if CALENDAR_AVAILABLE and hasattr(self.transaction_date, 'set_date'):
                from datetime import datetime
                date_obj = datetime.strptime(transaction[1], '%Y-%m-%d').date()
                self.transaction_date.set_date(date_obj)
            else:
                self.transaction_date.delete(0, tk.END)
                self.transaction_date.insert(0, transaction[1])
            
            messagebox.showinfo("Edit Mode", "Transaction loaded for editing. Make changes and click 'Update'.")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load transaction for editing: {str(e)}")
    
    def create_financial_analytics_tab(self):
        """Create financial analytics and insights tab with advanced analytics"""
        analytics_frame = ttk.Frame(self.financial_notebook)
        self.financial_notebook.add(analytics_frame, text="📊 Analytics & Insights")
        
        # Create scrollable main container
        scrollable_container = ScrollableFrame(analytics_frame, bg='#f8f9fa')
        scrollable_container.pack(fill=tk.BOTH, expand=True)
        main = scrollable_container.get_frame()
        
        # Header
        header = tk.Frame(main, bg='#2c3e50', relief=tk.FLAT, bd=0)
        header.pack(fill=tk.X, padx=0, pady=(0, 20))
        
        header_content = tk.Frame(header, bg='#2c3e50')
        header_content.pack(fill=tk.BOTH, expand=True, padx=25, pady=20)
        
        tk.Label(header_content, text="📊 Financial Analytics & Insights", 
                font=('Segoe UI', 20, 'bold'), fg='white', bg='#2c3e50').pack(anchor='w')
        tk.Label(header_content, text="Real-time financial analysis, trends, and recommendations",
                font=('Segoe UI', 11), fg='#bdc3c7', bg='#2c3e50').pack(anchor='w', pady=(5, 0))
        
        # Content area
        content = tk.Frame(main, bg='#f8f9fa')
        content.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 20))
        
        # Section 1: Key Financial Metrics
        metrics_frame = tk.LabelFrame(content, text="📈 Key Financial Metrics", 
                                     font=('Segoe UI', 12, 'bold'), bg='white', fg='#2c3e50',
                                     relief=tk.RAISED, bd=1)
        metrics_frame.pack(fill=tk.X, pady=(0, 15))
        
        metrics_content = tk.Frame(metrics_frame, bg='white')
        metrics_content.pack(fill=tk.X, padx=20, pady=20)
        
        # Create 4-column metric display
        metric_cols = tk.Frame(metrics_content, bg='white')
        metric_cols.pack(fill=tk.X)
        
        # Total Income
        self.create_metric_card(metric_cols, "💰 Total Income", "₦0.00", 
                               side=tk.LEFT, padx=(0, 10))
        # Total Expenses
        self.create_metric_card(metric_cols, "📉 Total Expenses", "₦0.00", 
                               side=tk.LEFT, padx=(0, 10))
        # Net Balance
        self.create_metric_card(metric_cols, "⚖️ Net Balance", "₦0.00", 
                               side=tk.LEFT, padx=(0, 10))
        # Budget Status
        self.create_metric_card(metric_cols, "📊 Budget Status", "On Track", 
                               side=tk.LEFT)
        
        # Section 2: Category Breakdown
        breakdown_frame = tk.LabelFrame(content, text="🔍 Category Breakdown Analysis", 
                                       font=('Segoe UI', 12, 'bold'), bg='white', fg='#2c3e50',
                                       relief=tk.RAISED, bd=1)
        breakdown_frame.pack(fill=tk.X, pady=(0, 15))
        
        breakdown_content = tk.Frame(breakdown_frame, bg='white')
        breakdown_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Category analysis table
        breakdown_cols = ('Category', 'Count', 'Total Amount', '% of Total', 'Trend')
        self.analytics_tree = ttk.Treeview(breakdown_content, columns=breakdown_cols, 
                                          show='headings', height=8)
        
        for col in breakdown_cols:
            self.analytics_tree.heading(col, text=col)
            self.analytics_tree.column(col, width=120 if col != 'Category' else 150)
        
        scrollbar = ttk.Scrollbar(breakdown_content, orient=tk.VERTICAL, 
                                 command=self.analytics_tree.yview)
        self.analytics_tree.configure(yscrollcommand=scrollbar.set)
        
        self.analytics_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # Section 3: Trends and Recommendations
        trends_frame = tk.LabelFrame(content, text="📈 Trends & Recommendations", 
                                    font=('Segoe UI', 12, 'bold'), bg='white', fg='#2c3e50',
                                    relief=tk.RAISED, bd=1)
        trends_frame.pack(fill=tk.BOTH, expand=True)
        
        trends_content = tk.Frame(trends_frame, bg='white')
        trends_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Trends text area
        self.trends_text = tk.Text(trends_content, height=8, width=60, 
                                  font=('Segoe UI', 10), bg='#f8f9fa', 
                                  relief=tk.SOLID, bd=1, wrap=tk.WORD)
        self.trends_text.pack(fill=tk.BOTH, expand=True)
        self.trends_text.insert('1.0', 'Loading financial insights...')
        self.trends_text.config(state=tk.DISABLED)
        
        # Refresh button
        refresh_btn = tk.Button(trends_content, text="🔄 Refresh Analytics", 
                              command=self.refresh_financial_analytics,
                              font=('Segoe UI', 10, 'bold'), bg='#3498db', fg='white',
                              relief=tk.FLAT, bd=0, padx=20, pady=8, cursor='hand2')
        refresh_btn.pack(pady=(10, 0))
        
        # Load initial analytics data
        self.refresh_financial_analytics()
    
    def create_metric_card(self, parent, title, value, side=tk.LEFT, padx=(0, 0)):
        """Create a metric card for displaying financial data"""
        card = tk.Frame(parent, bg='#ecf0f1', relief=tk.RAISED, bd=1)
        card.pack(side=side, fill=tk.BOTH, expand=True, padx=padx, pady=5)
        
        card_content = tk.Frame(card, bg='#ecf0f1')
        card_content.pack(fill=tk.BOTH, expand=True, padx=12, pady=12)
        
        tk.Label(card_content, text=title, font=('Segoe UI', 10, 'bold'), 
                fg='#34495e', bg='#ecf0f1').pack(anchor='w')
        tk.Label(card_content, text=value, font=('Segoe UI', 16, 'bold'), 
                fg='#27ae60', bg='#ecf0f1').pack(anchor='w', pady=(3, 0))
    
    def refresh_financial_analytics(self):
        """Refresh financial analytics data"""
        try:
            # Calculate total income, expenses, and net balance
            self.cursor.execute("SELECT SUM(amount) FROM transactions WHERE type='Income'")
            income_result = self.cursor.fetchone()
            total_income = income_result[0] if income_result[0] else 0
            
            self.cursor.execute("SELECT SUM(amount) FROM transactions WHERE type='Expense'")
            expense_result = self.cursor.fetchone()
            total_expenses = expense_result[0] if expense_result[0] else 0
            
            net_balance = total_income - total_expenses
            
            # Get category breakdown
            self.cursor.execute('''
                SELECT c.category_name, COUNT(t.id) as count, SUM(t.amount) as total
                FROM transactions t
                JOIN transaction_categories c ON t.category_id = c.id
                GROUP BY c.category_name
                ORDER BY total DESC
            ''')
            categories = self.cursor.fetchall()
            
            # Update analytics tree
            for item in self.analytics_tree.get_children():
                self.analytics_tree.delete(item)
            
            for cat_name, count, total in categories:
                percentage = (total / total_income * 100) if total_income > 0 else 0
                trend = "↑" if count > 0 else "→"
                self.analytics_tree.insert('', tk.END, 
                                          values=(cat_name, count, f"₦{total:.2f}", 
                                                 f"{percentage:.1f}%", trend))
            
            # Generate insights and recommendations
            insights = self._generate_financial_insights(total_income, total_expenses, 
                                                        net_balance, categories)
            
            self.trends_text.config(state=tk.NORMAL)
            self.trends_text.delete('1.0', tk.END)
            self.trends_text.insert('1.0', insights)
            self.trends_text.config(state=tk.DISABLED)
            
        except Exception as e:
            print(f"Error refreshing analytics: {e}")
    
    def _generate_financial_insights(self, income, expenses, balance, categories):
        """Generate financial insights and recommendations"""
        insights = f"""
📊 FINANCIAL SUMMARY
{'='*50}

💰 Total Income:        ₦{income:,.2f}
📉 Total Expenses:      ₦{expenses:,.2f}
⚖️  Net Balance:        ₦{balance:,.2f}

📈 TRENDS & ANALYSIS
{'='*50}

"""
        if balance > 0:
            insights += f"✓ Positive Balance: Your school has a surplus of ₦{balance:,.2f}\n"
            insights += "  Action: Consider allocating surplus to reserves or improvements.\n\n"
        else:
            insights += f"⚠ Deficit Alert: Your school has a deficit of ₦{abs(balance):,.2f}\n"
            insights += "  Action: Review expenses and consider increasing revenue sources.\n\n"
        
        if len(categories) > 0:
            highest_expense = categories[0]
            insights += f"📌 Highest Expense Category: {highest_expense[0]}\n"
            insights += f"   Amount: ₦{highest_expense[2]:,.2f} ({highest_expense[1]} transactions)\n"
            insights += "   Consider reviewing this category for cost optimization.\n\n"
        
        expense_ratio = (expenses / income * 100) if income > 0 else 0
        insights += f"📊 Expense Ratio: {expense_ratio:.1f}%\n"
        if expense_ratio > 80:
            insights += "  ⚠ High! Consider reducing expenses.\n"
        elif expense_ratio < 50:
            insights += "  ✓ Good! Expenses are well managed.\n"
        else:
            insights += "  → Acceptable expense level.\n"
        
        return insights
    
    def refresh_financial_data(self):
        """Refresh all financial management data"""
        try:
            self.load_transaction_categories()
            self.load_transactions()
            self.load_categories()
            self.refresh_financial_stats()
        except Exception as e:
            print(f"Error refreshing financial data: {e}")
    
    def refresh_financial_stats(self):
        """Refresh financial statistics"""
        try:
            # Refresh transaction list if it exists
            if hasattr(self, 'transactions_tree'):
                self.load_transactions()
            
            # Refresh categories if they exist
            if hasattr(self, 'categories_tree'):
                self.load_categories()
            
            # Refresh main dashboard if it exists
            if hasattr(self, 'update_dashboard'):
                self.update_dashboard()
                
            # If financial dashboard is open, show a refresh message
            # The actual financial dashboard data updates when it's opened/refreshed manually
            
        except Exception as e:
            print(f"Error refreshing financial stats: {e}")
    
    # ============ CATEGORY MANAGEMENT METHODS ============
    
    def load_categories(self):
        """Load and display financial categories"""
        if not hasattr(self, 'categories_tree'):
            return
            
        # Clear existing data
        for item in self.categories_tree.get_children():
            self.categories_tree.delete(item)
        
        try:
            self.cursor.execute('''
                SELECT id, category_name, category_type, description, is_active
                FROM financial_categories
                ORDER BY category_type, category_name
            ''')
            
            categories = self.cursor.fetchall()
            
            for category in categories:
                status = "Active" if category[4] else "Inactive"
                display_row = (
                    category[0],
                    category[1],
                    category[2].title(),
                    category[3][:50] + '...' if len(category[3]) > 50 else category[3],
                    status
                )
                self.categories_tree.insert('', tk.END, values=display_row)
                
        except Exception as e:
            print(f"Error loading categories: {e}")
    
    def save_category(self):
        """Save new financial category"""
        try:
            category_name = self.category_name_var.get().strip()
            category_type = self.category_type_var.get()
            description = self.category_description.get("1.0", "end-1c").strip()
            
            if not category_name:
                messagebox.showerror("Error", "Please enter a category name")
                return
            
            # Check for duplicate category name
            self.cursor.execute('''
                SELECT COUNT(*) FROM financial_categories 
                WHERE LOWER(category_name) = LOWER(?) AND category_type = ?
            ''', (category_name, category_type))
            
            if self.cursor.fetchone()[0] > 0:
                messagebox.showerror("Error", f"A {category_type} category with this name already exists")
                return
            
            # Insert new category
            self.cursor.execute('''
                INSERT INTO financial_categories (category_name, category_type, description)
                VALUES (?, ?, ?)
            ''', (category_name, category_type, description))
            
            self.conn.commit()
            
            messagebox.showinfo("Success", f"{category_type.title()} category '{category_name}' created successfully!")
            
            # Clear form and refresh data
            self.clear_category_form()
            self.load_categories()
            self.load_transaction_categories()
            
            # Update main dashboard
            if hasattr(self, 'update_dashboard'):
                self.update_dashboard()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to save category: {str(e)}")
    
    def edit_selected_category(self, event):
        """Edit selected category on double-click"""
        selection = self.categories_tree.selection()
        if not selection:
            return
            
        try:
            # Get category data from treeview
            category_data = self.categories_tree.item(selection[0])['values']
            category_id = category_data[0]
            
            # Fetch complete category details from database
            self.cursor.execute('''
                SELECT id, category_name, category_type, description
                FROM financial_categories
                WHERE id = ?
            ''', (category_id,))
            
            category = self.cursor.fetchone()
            if not category:
                messagebox.showerror("Error", "Category not found")
                return
            
            # Store selected category ID for updating
            self.selected_category_id = category_id
            
            # Populate form with category data
            self.category_name_var.set(category[1])
            self.category_type_var.set(category[2])
            
            # Set description
            self.category_description.delete("1.0", tk.END)
            if category[3]:
                self.category_description.insert("1.0", category[3])
            
            messagebox.showinfo("Edit Mode", "Category loaded for editing. Make changes and click 'Update'.")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load category for editing: {str(e)}")
    
    def update_category(self):
        """Update selected category"""
        if not hasattr(self, 'selected_category_id') or not self.selected_category_id:
            messagebox.showerror("Error", "Please select a category to update by double-clicking it first")
            return
            
        try:
            category_name = self.category_name_var.get().strip()
            category_type = self.category_type_var.get()
            description = self.category_description.get("1.0", "end-1c").strip()
            
            if not category_name:
                messagebox.showerror("Error", "Please enter a category name")
                return
            
            # Check for duplicate category name (excluding current category)
            self.cursor.execute('''
                SELECT COUNT(*) FROM financial_categories 
                WHERE LOWER(category_name) = LOWER(?) AND category_type = ? AND id != ?
            ''', (category_name, category_type, self.selected_category_id))
            
            if self.cursor.fetchone()[0] > 0:
                messagebox.showerror("Error", f"A {category_type} category with this name already exists")
                return
            
            # Update category
            self.cursor.execute('''
                UPDATE financial_categories SET
                    category_name = ?, category_type = ?, description = ?
                WHERE id = ?
            ''', (category_name, category_type, description, self.selected_category_id))
            
            self.conn.commit()
            
            messagebox.showinfo("Success", f"Category '{category_name}' updated successfully!")
            
            # Clear form and refresh data
            self.clear_category_form()
            self.load_categories()
            self.load_transaction_categories()
            self.selected_category_id = None
            
            # Update main dashboard
            if hasattr(self, 'update_dashboard'):
                self.update_dashboard()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to update category: {str(e)}")
    
    def delete_category(self):
        """Delete selected category with validation"""
        selection = self.categories_tree.selection()
        if not selection:
            messagebox.showerror("Error", "Please select a category to delete")
            return
        
        try:
            category_data = self.categories_tree.item(selection[0])['values']
            category_id = category_data[0]
            category_name = category_data[1]
            
            # Check if category is used in transactions
            self.cursor.execute('''
                SELECT COUNT(*) FROM financial_transactions WHERE category_id = ?
            ''', (category_id,))
            
            transaction_count = self.cursor.fetchone()[0]
            
            if transaction_count > 0:
                messagebox.showerror("Cannot Delete", 
                                   f"This category is used in {transaction_count} transaction(s).\n"
                                   "You cannot delete a category that has transactions.\n\n"
                                   "To delete this category, you must first delete or "
                                   "reassign all transactions using it.")
                return
            
            # Confirmation dialog
            if messagebox.askyesno("Confirm Delete", 
                                 f"Are you sure you want to delete the category '{category_name}'?\n"
                                 "This action cannot be undone!"):
                
                self.cursor.execute("DELETE FROM financial_categories WHERE id = ?", (category_id,))
                self.conn.commit()
                
                messagebox.showinfo("Success", f"Category '{category_name}' deleted successfully!")
                
                # Clear form and refresh data
                self.clear_category_form()
                self.load_categories()
                self.load_transaction_categories()
                self.selected_category_id = None
                
                # Update main dashboard
                if hasattr(self, 'update_dashboard'):
                    self.update_dashboard()
        
        except Exception as e:
            messagebox.showerror("Error", f"Failed to delete category: {str(e)}")
    
    def clear_category_form(self):
        """Clear category form fields"""
        self.category_name_var.set("")
        self.category_type_var.set("income")
        self.category_description.delete("1.0", tk.END)
    
    def on_category_select(self, event):
        """Handle category selection for editing"""
        selection = self.categories_tree.selection()
        if selection:
            category_data = self.categories_tree.item(selection[0])['values']
            
            # Populate form with selected category data
            self.category_name_var.set(category_data[1])
            self.category_type_var.set(category_data[2].lower())
            
            # Get full description from database
            try:
                self.cursor.execute("SELECT description FROM financial_categories WHERE id = ?", 
                                  (category_data[0],))
                result = self.cursor.fetchone()
                if result:
                    self.category_description.delete("1.0", tk.END)
                    self.category_description.insert("1.0", result[0] or "")
            except Exception as e:
                print(f"Error loading category description: {e}")
    
    # ============ FINANCIAL DASHBOARD METHODS ============
    
    def show_financial_dashboard(self):
        """Show comprehensive financial dashboard with analytics"""
        dashboard_window = self.create_responsive_window(
            self.root,
            "Financial Dashboard & Analytics",
            1200, 800,
            min_width=900, min_height=700,
            max_width=1600, max_height=1000
        )
        dashboard_window.configure(bg='#f8f9fa')
        
        # Create scrollable dashboard content
        scrollable_dash = ScrollableFrame(dashboard_window, bg='#f8f9fa')
        scrollable_dash.pack(fill=tk.BOTH, expand=True)
        dash_content = scrollable_dash.get_frame()
        
        # Dashboard header
        header_frame = tk.Frame(dash_content, bg='#2c3e50')
        header_frame.pack(fill=tk.X, pady=(0, 20))
        
        header_content = tk.Frame(header_frame, bg='#2c3e50')
        header_content.pack(fill=tk.X, padx=30, pady=20)
        
        # Title and refresh button
        title_row = tk.Frame(header_content, bg='#2c3e50')
        title_row.pack(fill=tk.X)
        
        tk.Label(title_row, text="📊 Financial Dashboard & Analytics", 
                font=('Segoe UI', 24, 'bold'), fg='white', bg='#2c3e50').pack(side=tk.LEFT)
        
        refresh_dash_btn = tk.Button(title_row, text="🔄 Refresh Data", 
                                   command=lambda: self.refresh_dashboard_data(dash_content),
                                   font=('Segoe UI', 10, 'bold'), bg='#3498db', fg='white',
                                   relief='flat', bd=0, padx=15, pady=8, cursor='hand2')
        refresh_dash_btn.pack(side=tk.RIGHT)
        
        tk.Label(header_content, text="Real-time financial insights and comprehensive reporting", 
                font=('Segoe UI', 12), fg='#bdc3c7', bg='#2c3e50').pack(anchor='w', pady=(8, 0))
        
        # Create dashboard sections
        self.create_financial_overview_section(dash_content)
        self.create_period_comparison_section(dash_content)
        self.create_category_analysis_section(dash_content)
        self.create_recent_activities_section(dash_content)
    
    def create_financial_overview_section(self, parent):
        """Create financial overview with key metrics"""
        overview_section = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        overview_section.pack(fill=tk.X, padx=20, pady=(0, 20))
        
        # Section header
        section_header = tk.Frame(overview_section, bg='#34495e')
        section_header.pack(fill=tk.X)
        
        tk.Label(section_header, text="📊 Financial Overview", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#34495e').pack(pady=12)
        
        # Metrics container
        metrics_container = tk.Frame(overview_section, bg='#ffffff')
        metrics_container.pack(fill=tk.X, padx=30, pady=25)
        
        # Calculate financial metrics
        try:
            # Current month totals
            current_month = date.today().strftime('%Y-%m')
            
            # Monthly income
            self.cursor.execute('''
                SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                WHERE transaction_type = 'income' 
                AND strftime('%Y-%m', transaction_date) = ?
            ''', (current_month,))
            monthly_income = self.cursor.fetchone()[0]
            
            # Monthly expenses
            self.cursor.execute('''
                SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                WHERE transaction_type = 'expense' 
                AND strftime('%Y-%m', transaction_date) = ?
            ''', (current_month,))
            monthly_expense = self.cursor.fetchone()[0]
            
            # Monthly net profit
            monthly_profit = monthly_income - monthly_expense
            
            # Total income (all time)
            self.cursor.execute('''
                SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                WHERE transaction_type = 'income'
            ''')
            total_income = self.cursor.fetchone()[0]
            
            # Total expenses (all time)  
            self.cursor.execute('''
                SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                WHERE transaction_type = 'expense'
            ''')
            total_expense = self.cursor.fetchone()[0]
            
            # Total net profit
            total_profit = total_income - total_expense
            
            # Create metric cards
            metrics_data = [
                {
                    'title': 'Monthly Income',
                    'value': f'GHS {monthly_income:.2f}',
                    'icon': '💳',
                    'color': '#27ae60',
                    'bg': '#d5f4e6'
                },
                {
                    'title': 'Monthly Expenses', 
                    'value': f'GHS {monthly_expense:.2f}',
                    'icon': '💸',
                    'color': '#e74c3c',
                    'bg': '#ffeaea'
                },
                {
                    'title': 'Monthly Profit',
                    'value': f'GHS {monthly_profit:.2f}',
                    'icon': '📈' if monthly_profit >= 0 else '📉',
                    'color': '#27ae60' if monthly_profit >= 0 else '#e74c3c',
                    'bg': '#d5f4e6' if monthly_profit >= 0 else '#ffeaea'
                },
                {
                    'title': 'Total Income',
                    'value': f'GHS {total_income:.2f}',
                    'icon': '📈',
                    'color': '#3498db',
                    'bg': '#ebf3fd'
                },
                {
                    'title': 'Total Expenses',
                    'value': f'GHS {total_expense:.2f}',
                    'icon': '📊',
                    'color': '#f39c12',
                    'bg': '#fef9e7'
                },
                {
                    'title': 'Net Profit',
                    'value': f'GHS {total_profit:.2f}',
                    'icon': '✅' if total_profit >= 0 else '⚠️',
                    'color': '#8e44ad' if total_profit >= 0 else '#e67e22',
                    'bg': '#f4ecf7' if total_profit >= 0 else '#fef5e7'
                }
            ]
            
            # Create cards in 2 rows of 3
            row1 = tk.Frame(metrics_container, bg='#ffffff')
            row1.pack(fill=tk.X, pady=(0, 15))
            
            row2 = tk.Frame(metrics_container, bg='#ffffff')
            row2.pack(fill=tk.X)
            
            for i, metric_data in enumerate(metrics_data):
                parent_row = row1 if i < 3 else row2
                
                metric_card = self.create_dashboard_metric_card(parent_row, metric_data)
                metric_card.pack(side=tk.LEFT, padx=(0, 15) if i % 3 < 2 else 0, expand=True, fill=tk.X)
                
        except Exception as e:
            print(f"Error creating financial overview: {e}")
            error_label = tk.Label(metrics_container, text="Error loading financial data", 
                                 font=('Segoe UI', 12), fg='#e74c3c', bg='#ffffff')
            error_label.pack(pady=50)
    
    def create_dashboard_metric_card(self, parent, metric_data):
        """Create a metric card for the dashboard"""
        card_container = tk.Frame(parent, bg='#ffffff')
        
        # Card background with border
        card = tk.Frame(card_container, bg=metric_data['bg'], relief='solid', bd=1, height=120)
        card.pack(fill=tk.BOTH, expand=True)
        card.pack_propagate(False)
        
        # Card content
        content = tk.Frame(card, bg=metric_data['bg'])
        content.pack(fill=tk.BOTH, expand=True, padx=20, pady=15)
        
        # Icon and title row
        top_row = tk.Frame(content, bg=metric_data['bg'])
        top_row.pack(fill=tk.X)
        
        icon_label = tk.Label(top_row, text=metric_data['icon'], font=('Segoe UI', 20), 
                             bg=metric_data['bg'])
        icon_label.pack(side=tk.LEFT)
        
        title_label = tk.Label(top_row, text=metric_data['title'], 
                              font=('Segoe UI', 10, 'bold'), fg='#495057', bg=metric_data['bg'])
        title_label.pack(side=tk.RIGHT, anchor='e')
        
        # Value
        value_label = tk.Label(content, text=metric_data['value'], 
                              font=('Segoe UI', 18, 'bold'), fg=metric_data['color'], bg=metric_data['bg'])
        value_label.pack(expand=True)
        
        return card_container
    
    def create_period_comparison_section(self, parent):
        """Create period comparison charts"""
        comparison_section = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        comparison_section.pack(fill=tk.X, padx=20, pady=(0, 20))
        
        # Section header
        section_header = tk.Frame(comparison_section, bg='#8e44ad')
        section_header.pack(fill=tk.X)
        
        tk.Label(section_header, text="📈 Period Comparison", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#8e44ad').pack(pady=12)
        
        # Comparison content
        comparison_content = tk.Frame(comparison_section, bg='#ffffff')
        comparison_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=25)
        
        # Period selection
        period_frame = tk.Frame(comparison_content, bg='#ffffff')
        period_frame.pack(fill=tk.X, pady=(0, 20))
        
        tk.Label(period_frame, text="Select comparison periods:", 
                font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#ffffff').pack(anchor='w')
        
        # Quick comparison buttons
        quick_comparisons = tk.Frame(period_frame, bg='#ffffff')
        quick_comparisons.pack(anchor='w', pady=(10, 0))
        
        comparison_buttons = [
            ("This Month vs Last Month", self.show_monthly_comparison),
            ("This Quarter vs Last Quarter", self.show_quarterly_comparison),
            ("This Year vs Last Year", self.show_yearly_comparison),
            ("Weekly Trends", self.show_weekly_trends)
        ]
        
        for text, command in comparison_buttons:
            btn = tk.Button(quick_comparisons, text=text, command=command,
                          font=('Segoe UI', 9, 'bold'), bg='#9b59b6', fg='white',
                          relief='solid', bd=0, padx=12, pady=6, cursor='hand2')
            btn.pack(side=tk.LEFT, padx=(0, 10))
        
        # Comparison results area
        self.comparison_results_frame = tk.Frame(comparison_content, bg='#f8f9fa', relief='solid', bd=1)
        self.comparison_results_frame.pack(fill=tk.BOTH, expand=True, pady=(10, 0))
        
        # Default message
        tk.Label(self.comparison_results_frame, text="Select a comparison period above to view detailed analysis", 
                font=('Segoe UI', 12), fg='#7f8c8d', bg='#f8f9fa').pack(expand=True)
    
    def create_category_analysis_section(self, parent):
        """Create category-wise analysis"""
        analysis_section = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        analysis_section.pack(fill=tk.X, padx=20, pady=(0, 20))
        
        # Section header
        section_header = tk.Frame(analysis_section, bg='#e67e22')
        section_header.pack(fill=tk.X)
        
        tk.Label(section_header, text="📊 Category Analysis", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#e67e22').pack(pady=12)
        
        # Analysis content
        analysis_content = tk.Frame(analysis_section, bg='#ffffff')
        analysis_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=25)
        
        # Two column layout
        columns_frame = tk.Frame(analysis_content, bg='#ffffff')
        columns_frame.pack(fill=tk.BOTH, expand=True)
        
        # Left column - Income categories
        income_column = tk.Frame(columns_frame, bg='#ffffff')
        income_column.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 15))
        
        tk.Label(income_column, text="💳 Top Income Categories", 
                font=('Segoe UI', 14, 'bold'), fg='#27ae60', bg='#ffffff').pack(anchor='w', pady=(0, 15))
        
        self.create_category_breakdown_list(income_column, 'income')
        
        # Right column - Expense categories
        expense_column = tk.Frame(columns_frame, bg='#ffffff')
        expense_column.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)
        
        tk.Label(expense_column, text="💸 Top Expense Categories", 
                font=('Segoe UI', 14, 'bold'), fg='#e74c3c', bg='#ffffff').pack(anchor='w', pady=(0, 15))
        
        self.create_category_breakdown_list(expense_column, 'expense')
    
    def create_category_breakdown_list(self, parent, transaction_type):
        """Create category breakdown list for income or expense"""
        try:
            # Get current month category totals
            current_month = date.today().strftime('%Y-%m')
            
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = ? 
                AND strftime('%Y-%m', ft.transaction_date) = ?
                GROUP BY fc.id, fc.category_name
                ORDER BY total DESC
                LIMIT 10
            ''', (transaction_type, current_month))
            
            categories = self.cursor.fetchall()
            
            if categories:
                # Create scrollable list
                list_frame = tk.Frame(parent, bg='#f8f9fa', relief='solid', bd=1, height=300)
                list_frame.pack(fill=tk.X)
                list_frame.pack_propagate(False)
                
                scrollable_list = ScrollableFrame(list_frame, bg='#f8f9fa')
                scrollable_list.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
                list_content = scrollable_list.get_frame()
                
                for i, (category_name, total) in enumerate(categories):
                    # Category item
                    item_frame = tk.Frame(list_content, bg='#ffffff', relief='solid', bd=1)
                    item_frame.pack(fill=tk.X, pady=2)
                    
                    item_content = tk.Frame(item_frame, bg='#ffffff')
                    item_content.pack(fill=tk.X, padx=15, pady=10)
                    
                    # Rank and category name
                    rank_label = tk.Label(item_content, text=f"#{i+1}", 
                                        font=('Segoe UI', 10, 'bold'), 
                                        fg='#95a5a6', bg='#ffffff', width=5)
                    rank_label.pack(side=tk.LEFT)
                    
                    name_label = tk.Label(item_content, text=category_name, 
                                        font=('Segoe UI', 11), fg='#2c3e50', bg='#ffffff')
                    name_label.pack(side=tk.LEFT, padx=(5, 0))
                    
                    # Amount
                    amount_color = '#27ae60' if transaction_type == 'income' else '#e74c3c'
                    amount_label = tk.Label(item_content, text=f"GHS {total:.2f}", 
                                          font=('Segoe UI', 11, 'bold'), 
                                          fg=amount_color, bg='#ffffff')
                    amount_label.pack(side=tk.RIGHT)
            else:
                no_data_label = tk.Label(parent, text=f"No {transaction_type} data for current month", 
                                       font=('Segoe UI', 10), fg='#95a5a6', bg='#ffffff')
                no_data_label.pack(pady=50)
                
        except Exception as e:
            print(f"Error creating category breakdown: {e}")
    
    def create_recent_activities_section(self, parent):
        """Create recent financial activities section"""
        activities_section = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        activities_section.pack(fill=tk.BOTH, expand=True, padx=20)
        
        # Section header
        section_header = tk.Frame(activities_section, bg='#16a085')
        section_header.pack(fill=tk.X)
        
        tk.Label(section_header, text="⏰ Recent Financial Activities", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#16a085').pack(pady=12)
        
        # Activities content
        activities_content = tk.Frame(activities_section, bg='#ffffff')
        activities_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=25)
        
        # Recent transactions
        try:
            self.cursor.execute('''
                SELECT ft.transaction_date, ft.transaction_type, fc.category_name, 
                       ft.amount, ft.description, ft.created_date
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                ORDER BY ft.created_date DESC
                LIMIT 15
            ''')
            
            recent_transactions = self.cursor.fetchall()
            
            if recent_transactions:
                # Create transactions list
                trans_frame = tk.Frame(activities_content, bg='#f8f9fa', relief='solid', bd=1, height=400)
                trans_frame.pack(fill=tk.BOTH, expand=True)
                trans_frame.pack_propagate(False)
                
                scrollable_trans = ScrollableFrame(trans_frame, bg='#f8f9fa')
                scrollable_trans.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
                trans_content = scrollable_trans.get_frame()
                
                for transaction in recent_transactions:
                    # Transaction item
                    trans_item = tk.Frame(trans_content, bg='#ffffff', relief='solid', bd=1)
                    trans_item.pack(fill=tk.X, pady=3)
                    
                    trans_item_content = tk.Frame(trans_item, bg='#ffffff')
                    trans_item_content.pack(fill=tk.X, padx=20, pady=12)
                    
                    # Transaction type icon and info
                    type_icon = '💳' if transaction[1] == 'income' else '💸'
                    type_color = '#27ae60' if transaction[1] == 'income' else '#e74c3c'
                    
                    icon_label = tk.Label(trans_item_content, text=type_icon, 
                                        font=('Segoe UI', 16), bg='#ffffff')
                    icon_label.pack(side=tk.LEFT, padx=(0, 15))
                    
                    # Transaction details
                    details_frame = tk.Frame(trans_item_content, bg='#ffffff')
                    details_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
                    
                    # Category and description
                    category_desc = tk.Label(details_frame, 
                                           text=f"{transaction[2]} • {transaction[4][:50]}{'...' if len(transaction[4]) > 50 else ''}", 
                                           font=('Segoe UI', 11, 'bold'), fg='#2c3e50', bg='#ffffff')
                    category_desc.pack(anchor='w')
                    
                    # Date and time
                    date_time = tk.Label(details_frame, text=f"✅ {transaction[0]} • ⏱️ {transaction[5][:10]}", 
                                       font=('Segoe UI', 9), fg='#7f8c8d', bg='#ffffff')
                    date_time.pack(anchor='w', pady=(2, 0))
                    
                    # Amount
                    amount_label = tk.Label(trans_item_content, text=f"GHS {transaction[3]:.2f}", 
                                          font=('Segoe UI', 14, 'bold'), fg=type_color, bg='#ffffff')
                    amount_label.pack(side=tk.RIGHT)
            else:
                no_activities_label = tk.Label(activities_content, text="No recent financial activities", 
                                             font=('Segoe UI', 12), fg='#95a5a6', bg='#ffffff')
                no_activities_label.pack(expand=True)
                
        except Exception as e:
            print(f"Error loading recent activities: {e}")
    
    # ============ FINANCIAL REPORTING METHODS ============
    
    def create_financial_summary_cards(self, parent):
        """Create financial summary cards for reports tab"""
        cards_container = tk.Frame(parent, bg='#f8f9fa')
        cards_container.pack(fill=tk.X, pady=(0, 20))
        
        # Calculate current statistics
        try:
            # Today's transactions
            today = date.today().strftime('%Y-%m-%d')
            
            self.cursor.execute('''
                SELECT 
                    SUM(CASE WHEN transaction_type = 'income' THEN amount ELSE 0 END) as today_income,
                    SUM(CASE WHEN transaction_type = 'expense' THEN amount ELSE 0 END) as today_expense,
                    COUNT(*) as today_transactions
                FROM financial_transactions 
                WHERE DATE(transaction_date) = ?
            ''', (today,))
            
            today_stats = self.cursor.fetchone()
            today_income = today_stats[0] or 0
            today_expense = today_stats[1] or 0
            today_transactions = today_stats[2]
            
            # This week's transactions
            week_start = (date.today() - timedelta(days=date.today().weekday())).strftime('%Y-%m-%d')
            
            self.cursor.execute('''
                SELECT 
                    SUM(CASE WHEN transaction_type = 'income' THEN amount ELSE 0 END) as week_income,
                    SUM(CASE WHEN transaction_type = 'expense' THEN amount ELSE 0 END) as week_expense
                FROM financial_transactions 
                WHERE DATE(transaction_date) >= ?
            ''', (week_start,))
            
            week_stats = self.cursor.fetchone()
            week_income = week_stats[0] or 0
            week_expense = week_stats[1] or 0
            
            # Summary cards data
            summary_cards_data = [
                {
                    'title': "Today's Income",
                    'value': f'GHS {today_income:.2f}',
                    'subtitle': f'{today_transactions} transactions',
                    'color': '#27ae60',
                    'bg': '#d5f4e6'
                },
                {
                    'title': "Today's Expenses", 
                    'value': f'GHS {today_expense:.2f}',
                    'subtitle': f'Net: GHS {(today_income - today_expense):.2f}',
                    'color': '#e74c3c',
                    'bg': '#ffeaea'
                },
                {
                    'title': "Weekly Income",
                    'value': f'GHS {week_income:.2f}',
                    'subtitle': 'This week total',
                    'color': '#3498db',
                    'bg': '#ebf3fd'
                },
                {
                    'title': "Weekly Expenses",
                    'value': f'GHS {week_expense:.2f}',
                    'subtitle': f'Net: GHS {(week_income - week_expense):.2f}',
                    'color': '#f39c12',
                    'bg': '#fef9e7'
                }
            ]
            
            # Create cards
            cards_row = tk.Frame(cards_container, bg='#f8f9fa')
            cards_row.pack(fill=tk.X)
            
            for card_data in summary_cards_data:
                card = self.create_summary_card(cards_row, card_data)
                card.pack(side=tk.LEFT, padx=(0, 15), expand=True, fill=tk.X)
                
        except Exception as e:
            print(f"Error creating financial summary cards: {e}")
    
    def create_summary_card(self, parent, card_data):
        """Create a summary card widget"""
        card_container = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        
        # Card with colored background
        card = tk.Frame(card_container, bg=card_data['bg'], height=100)
        card.pack(fill=tk.BOTH, expand=True, padx=2, pady=2)
        card.pack_propagate(False)
        
        # Card content
        content = tk.Frame(card, bg=card_data['bg'])
        content.pack(fill=tk.BOTH, expand=True, padx=15, pady=10)
        
        # Title
        title_label = tk.Label(content, text=card_data['title'], 
                              font=('Segoe UI', 10, 'bold'), fg='#495057', bg=card_data['bg'])
        title_label.pack(anchor='w')
        
        # Value
        value_label = tk.Label(content, text=card_data['value'], 
                              font=('Segoe UI', 16, 'bold'), fg=card_data['color'], bg=card_data['bg'])
        value_label.pack(expand=True)
        
        # Subtitle
        subtitle_label = tk.Label(content, text=card_data['subtitle'], 
                                 font=('Segoe UI', 8), fg='#6c757d', bg=card_data['bg'])
        subtitle_label.pack(anchor='w')
        
        return card_container
    
    def create_budget_overview_cards(self, parent):
        """Create budget overview cards"""
        # Placeholder for budget overview
        placeholder_frame = tk.Frame(parent, bg='#f8f9fa', height=120)
        placeholder_frame.pack(fill=tk.X)
        placeholder_frame.pack_propagate(False)
        
        tk.Label(placeholder_frame, text="Budget overview cards will be displayed here", 
                font=('Segoe UI', 12), fg='#7f8c8d', bg='#f8f9fa').pack(expand=True)
    
    # ============ BUDGET MANAGEMENT METHODS ============
    
    def save_budget(self):
        """Save a new budget or update existing one"""
        try:
            # Get form values
            budget_name = self.budget_name_var.get().strip()
            category = self.budget_category_var.get()
            amount_str = self.budget_amount_var.get().strip()
            period_type = self.budget_period_var.get()
            
            # Validation
            if not budget_name:
                messagebox.showwarning("Validation Error", "Please enter a budget name")
                return
            
            if not category or category == "Select Category":
                messagebox.showwarning("Validation Error", "Please select a category")
                return
            
            try:
                amount = float(amount_str)
                if amount <= 0:
                    raise ValueError()
            except ValueError:
                messagebox.showwarning("Validation Error", "Please enter a valid positive amount")
                return
            
            # Get dates
            start_date = self.budget_start_date.get_date()
            end_date = self.budget_end_date.get_date()
            
            if end_date < start_date:
                messagebox.showwarning("Validation Error", "End date must be after start date")
                return
            
            # Get category_id from category name
            cursor = self.conn.execute('''
                SELECT id FROM financial_categories 
                WHERE category_name = ? AND category_type = 'expense'
            ''', (category,))
            
            category_row = cursor.fetchone()
            if not category_row:
                messagebox.showerror("Error", f"Category '{category}' not found")
                return
            
            category_id = category_row[0]
            
            # Check if updating existing budget
            if hasattr(self, 'selected_budget_id') and self.selected_budget_id:
                # Update existing
                self.conn.execute('''
                    UPDATE budget_plans 
                    SET plan_name = ?, category_id = ?, budgeted_amount = ?, 
                        period_type = ?, start_date = ?, end_date = ?
                    WHERE id = ?
                ''', (budget_name, category_id, amount, period_type, start_date, end_date, self.selected_budget_id))
                action = "updated"
            else:
                # Insert new
                self.conn.execute('''
                    INSERT INTO budget_plans (plan_name, category_id, budgeted_amount, period_type, start_date, end_date, is_active, created_date)
                    VALUES (?, ?, ?, ?, ?, ?, 1, ?)
                ''', (budget_name, category_id, amount, period_type, start_date, end_date, date.today()))
                action = "created"
            
            self.conn.commit()
            messagebox.showinfo("Success", f"Budget {action} successfully!")
            
            # Refresh list and clear form
            self.load_budgets()
            self.clear_budget_form()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to save budget: {e}")
    
    def update_budget(self):
        """Prepare selected budget for update"""
        if not hasattr(self, 'selected_budget_id') or not self.selected_budget_id:
            messagebox.showwarning("No Selection", "Please select a budget to update")
            return
        
        # The form is already populated from on_budget_select
        # Just call save_budget which will handle the update
        self.save_budget()
    
    def delete_budget(self):
        """Delete selected budget"""
        if not hasattr(self, 'selected_budget_id') or not self.selected_budget_id:
            messagebox.showwarning("No Selection", "Please select a budget to delete")
            return
        
        # Confirm deletion
        result = messagebox.askyesno("Confirm Delete", 
                                     "Are you sure you want to delete this budget?")
        if not result:
            return
        
        try:
            self.conn.execute('DELETE FROM budget_plans WHERE id = ?', (self.selected_budget_id,))
            self.conn.commit()
            messagebox.showinfo("Success", "Budget deleted successfully!")
            
            # Refresh list and clear form
            self.load_budgets()
            self.clear_budget_form()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to delete budget: {e}")
    
    def clear_budget_form(self):
        """Clear budget form fields"""
        self.budget_name_var.set("")
        self.budget_category_var.set("Select Category")
        self.budget_amount_var.set("")
        self.budget_period_var.set("monthly")
        
        # Reset dates to current month
        today = date.today()
        start_of_month = today.replace(day=1)
        
        self.budget_start_date.set_date(start_of_month)
        self.budget_end_date.set_date(today)
        
        # Clear selection
        self.selected_budget_id = None
        
        # Clear treeview selection
        if hasattr(self, 'budget_tree'):
            for item in self.budget_tree.selection():
                self.budget_tree.selection_remove(item)
    
    def load_budget_categories(self):
        """Load financial categories for budget dropdown"""
        try:
            cursor = self.conn.execute('''
                SELECT DISTINCT category_name 
                FROM financial_categories 
                WHERE category_type = 'expense'
                ORDER BY category_name
            ''')
            categories = [row[0] for row in cursor.fetchall()]
            
            # Add default option
            categories.insert(0, "Select Category")
            
            # Update dropdown values
            if hasattr(self, 'budget_category_dropdown'):
                self.budget_category_dropdown['values'] = categories
                self.budget_category_var.set("Select Category")
            
            return categories
            
        except Exception as e:
            print(f"Error loading categories: {e}")
            default_categories = ["Select Category", "Salaries", "Utilities", "Supplies", "Other"]
            if hasattr(self, 'budget_category_dropdown'):
                self.budget_category_dropdown['values'] = default_categories
                self.budget_category_var.set("Select Category")
            return default_categories
    
    def load_budgets(self):
        """Load budgets into treeview with spent amount calculation"""
        try:
            # Clear existing items
            for item in self.budget_tree.get_children():
                self.budget_tree.delete(item)
            
            # Get all budgets with category names
            cursor = self.conn.execute('''
                SELECT bp.id, bp.plan_name, fc.category_name, bp.budgeted_amount, 
                       bp.period_type, bp.start_date, bp.end_date
                FROM budget_plans bp
                JOIN financial_categories fc ON bp.category_id = fc.id
                WHERE bp.is_active = 1
                ORDER BY bp.start_date DESC, bp.plan_name
            ''')
            
            budgets = cursor.fetchall()
            
            for budget in budgets:
                budget_id, name, category, budgeted, period, start_date, end_date = budget
                
                # Calculate spent amount for this budget's category and date range
                spent_cursor = self.conn.execute('''
                    SELECT COALESCE(SUM(ft.amount), 0)
                    FROM financial_transactions ft
                    JOIN financial_categories fc ON ft.category_id = fc.id
                    WHERE fc.category_name = ? 
                    AND ft.transaction_type = 'expense'
                    AND ft.transaction_date BETWEEN ? AND ?
                ''', (category, start_date, end_date))
                
                spent = spent_cursor.fetchone()[0]
                remaining = budgeted - spent
                
                # Calculate status
                if spent > budgeted:
                    status = "Over Budget"
                    status_color = "#e74c3c"  # Red
                elif spent >= budgeted * 0.9:
                    status = "Near Limit"
                    status_color = "#f39c12"  # Orange
                else:
                    status = "On Track"
                    status_color = "#27ae60"  # Green
                
                # Format values
                budgeted_fmt = f"GHS {budgeted:,.2f}"
                spent_fmt = f"GHS {spent:,.2f}"
                remaining_fmt = f"GHS {remaining:,.2f}"
                period_fmt = period.capitalize()
                
                # Insert into treeview
                item = self.budget_tree.insert('', 'end', values=(
                    budget_id,
                    name,
                    category,
                    budgeted_fmt,
                    spent_fmt,
                    remaining_fmt,
                    period_fmt,
                    status
                ))
                
                # Color code the status
                self.budget_tree.tag_configure(status, foreground=status_color)
                self.budget_tree.item(item, tags=(status,))
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load budgets: {e}")
    
    def on_budget_select(self, event):
        """Handle budget selection from treeview"""
        selection = self.budget_tree.selection()
        if not selection:
            return
        
        # Get selected budget data
        item = selection[0]
        values = self.budget_tree.item(item, 'values')
        
        if not values:
            return
        
        budget_id = values[0]
        
        # Load full budget details from database
        try:
            cursor = self.conn.execute('''
                SELECT bp.plan_name, fc.category_name, bp.budgeted_amount, 
                       bp.period_type, bp.start_date, bp.end_date
                FROM budget_plans bp
                JOIN financial_categories fc ON bp.category_id = fc.id
                WHERE bp.id = ?
            ''', (budget_id,))
            
            budget = cursor.fetchone()
            if not budget:
                return
            
            name, category, amount, period, start_date, end_date = budget
            
            # Populate form
            self.budget_name_var.set(name)
            self.budget_category_var.set(category)
            self.budget_amount_var.set(str(amount))
            self.budget_period_var.set(period)
            
            # Parse and set dates
            start = datetime.strptime(start_date, '%Y-%m-%d').date()
            end = datetime.strptime(end_date, '%Y-%m-%d').date()
            
            self.budget_start_date.set_date(start)
            self.budget_end_date.set_date(end)
            
            # Store selected ID for updates
            self.selected_budget_id = budget_id
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to load budget details: {e}")
    
    # ============ PERIOD SETTING METHODS ============
    
    def set_today_period(self):
        """Set report period to today"""
        today = date.today()
        self.report_from_date.set_date(today)
        self.report_to_date.set_date(today)
    
    def set_week_period(self):
        """Set report period to this week"""
        today = date.today()
        start_of_week = today - timedelta(days=today.weekday())
        
        self.report_from_date.set_date(start_of_week)
        self.report_to_date.set_date(today)
    
    def set_month_period(self):
        """Set report period to this month"""
        today = date.today()
        start_of_month = today.replace(day=1)
        
        self.report_from_date.set_date(start_of_month)
        self.report_to_date.set_date(today)
    
    def set_year_period(self):
        """Set report period to this year"""
        today = date.today()
        start_of_year = today.replace(month=1, day=1)
        
        self.report_from_date.set_date(start_of_year)
        self.report_to_date.set_date(today)
    
    # ============ REPORT GENERATION METHODS ============
    
    def generate_income_expense_report(self):
        """Generate comprehensive income and expense report"""
        try:
            # Get date range
            if CALENDAR_AVAILABLE:
                from_date = self.report_from_date.get_date().strftime('%Y-%m-%d')
                to_date = self.report_to_date.get_date().strftime('%Y-%m-%d')
            else:
                from_date = self.report_from_date.get()
                to_date = self.report_to_date.get()
            
            # Create report window
            report_window = tk.Toplevel(self.root)
            report_window.title(f"Income & Expense Report ({from_date} to {to_date})")
            report_window.geometry("800x600")
            report_window.configure(bg='#ffffff')
            
            # Center window
            report_window.update_idletasks()
            x = (report_window.winfo_screenwidth() // 2) - 400
            y = (report_window.winfo_screenheight() // 2) - 300
            report_window.geometry(f"800x600+{x}+{y}")
            
            # Report content
            scrollable_report = ScrollableFrame(report_window, bg='#ffffff')
            scrollable_report.pack(fill=tk.BOTH, expand=True)
            report_content = scrollable_report.get_frame()
            
            # Report header with logo
            self.create_report_header(report_content, "📊 Income & Expense Report", 
                                     f"Period: {from_date} to {to_date}")
            
            # Calculate totals for the period
            self.cursor.execute('''
                SELECT 
                    SUM(CASE WHEN transaction_type = 'income' THEN amount ELSE 0 END) as total_income,
                    SUM(CASE WHEN transaction_type = 'expense' THEN amount ELSE 0 END) as total_expense,
                    COUNT(CASE WHEN transaction_type = 'income' THEN 1 END) as income_count,
                    COUNT(CASE WHEN transaction_type = 'expense' THEN 1 END) as expense_count
                FROM financial_transactions 
                WHERE DATE(transaction_date) BETWEEN ? AND ?
            ''', (from_date, to_date))
            
            totals = self.cursor.fetchone()
            total_income = totals[0] or 0
            total_expense = totals[1] or 0
            income_count = totals[2]
            expense_count = totals[3]
            net_profit = total_income - total_expense
            
            # Summary section
            summary_frame = tk.Frame(report_content, bg='#f8f9fa', relief='solid', bd=1)
            summary_frame.pack(fill=tk.X, padx=20, pady=(0, 20))
            
            summary_header = tk.Frame(summary_frame, bg='#34495e')
            summary_header.pack(fill=tk.X)
            
            tk.Label(summary_header, text="📈 Financial Summary", 
                    font=('Segoe UI', 14, 'bold'), fg='white', bg='#34495e').pack(pady=10)
            
            summary_content = tk.Frame(summary_frame, bg='#f8f9fa')
            summary_content.pack(fill=tk.X, padx=30, pady=20)
            
            # Summary stats
            summary_stats = [
                ("Total Income", f"GHS {total_income:.2f}", f"({income_count} transactions)", '#27ae60'),
                ("Total Expenses", f"GHS {total_expense:.2f}", f"({expense_count} transactions)", '#e74c3c'),
                ("Net Profit/Loss", f"GHS {net_profit:.2f}", "Income - Expenses", '#27ae60' if net_profit >= 0 else '#e74c3c')
            ]
            
            for label, value, note, color in summary_stats:
                stat_row = tk.Frame(summary_content, bg='#f8f9fa')
                stat_row.pack(fill=tk.X, pady=5)
                
                tk.Label(stat_row, text=f"{label}:", font=('Segoe UI', 11, 'bold'), 
                        fg='#2c3e50', bg='#f8f9fa', width=20, anchor='w').pack(side=tk.LEFT)
                tk.Label(stat_row, text=value, font=('Segoe UI', 11, 'bold'), 
                        fg=color, bg='#f8f9fa', width=15, anchor='e').pack(side=tk.LEFT, padx=(10, 0))
                tk.Label(stat_row, text=note, font=('Segoe UI', 9), 
                        fg='#7f8c8d', bg='#f8f9fa').pack(side=tk.LEFT, padx=(10, 0))
            
            # Detailed transactions section
            details_frame = tk.Frame(report_content, bg='#ffffff', relief='solid', bd=1)
            details_frame.pack(fill=tk.BOTH, expand=True, padx=20)
            
            details_header = tk.Frame(details_frame, bg='#3498db')
            details_header.pack(fill=tk.X)
            
            tk.Label(details_header, text="📋 Transaction Details", 
                    font=('Segoe UI', 14, 'bold'), fg='white', bg='#3498db').pack(pady=10)
            
            # Transactions treeview
            tree_frame = tk.Frame(details_frame, bg='#ffffff')
            tree_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
            
            columns = ('Date', 'Type', 'Category', 'Amount', 'Description', 'Payment Method')
            report_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=15)
            
            # Configure columns
            column_widths = {'Date': 80, 'Type': 70, 'Category': 120, 'Amount': 100, 
                           'Description': 200, 'Payment Method': 100}
            
            for col in columns:
                report_tree.heading(col, text=col)
                report_tree.column(col, width=column_widths.get(col, 100))
            
            # Load transaction data
            self.cursor.execute('''
                SELECT ft.transaction_date, ft.transaction_type, fc.category_name, 
                       ft.amount, ft.description, ft.payment_method
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE DATE(ft.transaction_date) BETWEEN ? AND ?
                ORDER BY ft.transaction_date DESC, ft.id DESC
            ''', (from_date, to_date))
            
            transactions = self.cursor.fetchall()
            
            for transaction in transactions:
                type_display = '💳 Income' if transaction[1] == 'income' else '💸 Expense'
                amount_display = f"GHS {transaction[3]:.2f}"
                description_short = transaction[4][:30] + '...' if len(transaction[4]) > 30 else transaction[4]
                
                report_tree.insert('', tk.END, values=(
                    transaction[0], type_display, transaction[2], 
                    amount_display, description_short, transaction[5]
                ))
            
            # Add scrollbar
            tree_scrollbar = ttk.Scrollbar(tree_frame, orient=tk.VERTICAL, command=report_tree.yview)
            report_tree.configure(yscrollcommand=tree_scrollbar.set)
            
            report_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            tree_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
            
            # Report footer with export options
            footer_frame = tk.Frame(report_content, bg='#ecf0f1')
            footer_frame.pack(fill=tk.X, pady=(20, 0))
            
            footer_content = tk.Frame(footer_frame, bg='#ecf0f1')
            footer_content.pack(fill=tk.X, padx=30, pady=15)
            
            tk.Label(footer_content, text="💾 Export Options:", 
                    font=('Segoe UI', 12, 'bold'), fg='#2c3e50', bg='#ecf0f1').pack(side=tk.LEFT)
            
            # Export buttons (placeholder functionality)
            export_pdf_btn = tk.Button(footer_content, text="📊 Export to PDF", 
                                     command=lambda: self.export_report_pdf(from_date, to_date, 'income_expense'),
                                     font=('Segoe UI', 10, 'bold'), bg='#e74c3c', fg='white',
                                     relief='solid', bd=0, padx=15, pady=5, cursor='hand2')
            export_pdf_btn.pack(side=tk.RIGHT, padx=(10, 0))
            
            export_csv_btn = tk.Button(footer_content, text="📊 Export to CSV", 
                                     command=lambda: self.export_report_csv(from_date, to_date, 'income_expense'),
                                     font=('Segoe UI', 10, 'bold'), bg='#27ae60', fg='white',
                                     relief='solid', bd=0, padx=15, pady=5, cursor='hand2')
            export_csv_btn.pack(side=tk.RIGHT, padx=(10, 0))
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate report: {str(e)}")
    
    def generate_income_analysis(self):
        """Generate detailed income analysis report"""
        try:
            # Get date range
            if CALENDAR_AVAILABLE:
                from_date = self.report_from_date.get_date().strftime('%Y-%m-%d')
                to_date = self.report_to_date.get_date().strftime('%Y-%m-%d')
            else:
                from_date = self.report_from_date.get()
                to_date = self.report_to_date.get()
            
            # Create report window
            report_window = tk.Toplevel(self.root)
            report_window.title("Income Analysis Report")
            report_window.geometry("1000x700")
            report_window.configure(bg='#f8f9fa')
            
            # Header
            header_frame = tk.Frame(report_window, bg='#27ae60')
            header_frame.pack(fill=tk.X, pady=(0, 20))
            
            header_content = tk.Frame(header_frame, bg='#27ae60')
            header_content.pack(fill=tk.BOTH, padx=30, pady=15)
            
            tk.Label(header_content, text="💳 Income Analysis Report", 
                    font=('Segoe UI', 18, 'bold'), fg='white', bg='#27ae60').pack(anchor='w')
            tk.Label(header_content, text=f"Period: {from_date} to {to_date}", 
                    font=('Segoe UI', 11), fg='#d5f4e6', bg='#27ae60').pack(anchor='w', pady=(5, 0))
            
            # Create scrollable content
            scrollable_frame = ScrollableFrame(report_window, bg='#f8f9fa')
            scrollable_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 10))
            content = scrollable_frame.get_frame()
            
            # Income summary
            self.create_income_summary_section(content)
            self.create_income_by_category_section(content)
            self.create_income_trends_section(content)
            
            # Export buttons
            export_frame = tk.Frame(report_window, bg='#f8f9fa')
            export_frame.pack(fill=tk.X, padx=20, pady=(0, 20))
            
            button_container = tk.Frame(export_frame, bg='#f8f9fa')
            button_container.pack()
            
            csv_btn = tk.Button(button_container, text="📊 Export as CSV", 
                               command=lambda: self.export_report_csv(from_date, to_date, 'income_analysis'),
                               font=('Segoe UI', 11, 'bold'), bg='#27ae60', fg='white',
                               relief='solid', bd=0, padx=25, pady=12, cursor='hand2')
            csv_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            if PDF_AVAILABLE:
                pdf_btn = tk.Button(button_container, text="📊 Export as PDF", 
                                   command=lambda: self.export_report_pdf(from_date, to_date, 'income_analysis'),
                                   font=('Segoe UI', 11, 'bold'), bg='#e74c3c', fg='white',
                                   relief='solid', bd=0, padx=25, pady=12, cursor='hand2')
                pdf_btn.pack(side=tk.LEFT)
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate income analysis: {str(e)}")
    
    def create_income_summary_section(self, parent):
        """Create income summary section"""
        section = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        section.pack(fill=tk.X, pady=(0, 15))
        
        # Section header
        header = tk.Frame(section, bg='#27ae60')
        header.pack(fill=tk.X)
        tk.Label(header, text="📊 Income Summary", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#27ae60').pack(pady=10)
        
        # Summary metrics
        metrics_frame = tk.Frame(section, bg='#ffffff')
        metrics_frame.pack(fill=tk.X, padx=20, pady=20)
        
        try:
            # Current month income
            current_month = date.today().strftime('%Y-%m')
            self.cursor.execute('''
                SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                WHERE transaction_type = 'income' 
                AND strftime('%Y-%m', transaction_date) = ?
            ''', (current_month,))
            monthly_income = self.cursor.fetchone()[0]
            
            # Previous month income
            from datetime import datetime, timedelta
            prev_month_date = (datetime.now().replace(day=1) - timedelta(days=1))
            prev_month = prev_month_date.strftime('%Y-%m')
            self.cursor.execute('''
                SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                WHERE transaction_type = 'income' 
                AND strftime('%Y-%m', transaction_date) = ?
            ''', (prev_month,))
            prev_monthly_income = self.cursor.fetchone()[0]
            
            # Total income
            self.cursor.execute('''
                SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                WHERE transaction_type = 'income'
            ''')
            total_income = self.cursor.fetchone()[0]
            
            # Create metric cards
            metric_data = [
                ("This Month", f"GHS {monthly_income:.2f}", "#27ae60"),
                ("Previous Month", f"GHS {prev_monthly_income:.2f}", "#3498db"),
                ("Total Income", f"GHS {total_income:.2f}", "#8e44ad")
            ]
            
            for i, (title, value, color) in enumerate(metric_data):
                card = tk.Frame(metrics_frame, bg=color, relief='solid', bd=1)
                card.grid(row=0, column=i, sticky='ew', padx=10, pady=5)
                metrics_frame.columnconfigure(i, weight=1)
                
                tk.Label(card, text=title, font=('Segoe UI', 10, 'bold'), 
                        fg='white', bg=color).pack(pady=(10, 5))
                tk.Label(card, text=value, font=('Segoe UI', 14, 'bold'), 
                        fg='white', bg=color).pack(pady=(0, 10))
                        
        except Exception as e:
            tk.Label(metrics_frame, text=f"Error loading income summary: {str(e)}", 
                    fg='red', bg='#ffffff').pack()
    
    def create_income_by_category_section(self, parent):
        """Create income by category section"""
        section = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        section.pack(fill=tk.X, pady=(0, 15))
        
        # Section header
        header = tk.Frame(section, bg='#3498db')
        header.pack(fill=tk.X)
        tk.Label(header, text="📋 Income by Category", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#3498db').pack(pady=10)
        
        # Category breakdown
        tree_frame = tk.Frame(section, bg='#ffffff')
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        columns = ('Category', 'Amount', 'Percentage', 'Transactions')
        tree = ttk.Treeview(tree_frame, columns=columns, show='headings', height=8)
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=150)
        
        try:
            # Get income by category
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total_amount, COUNT(ft.id) as transaction_count
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'income'
                GROUP BY fc.id, fc.category_name
                ORDER BY total_amount DESC
            ''')
            
            category_data = self.cursor.fetchall()
            total_income = sum(row[1] for row in category_data)
            
            for category_name, amount, count in category_data:
                percentage = (amount / total_income * 100) if total_income > 0 else 0
                tree.insert('', 'end', values=(
                    category_name, 
                    f"GHS {amount:.2f}", 
                    f"{percentage:.1f}%", 
                    count
                ))
                
        except Exception as e:
            tree.insert('', 'end', values=("Error", str(e), "", ""))
        
        tree.pack(fill=tk.BOTH, expand=True)
    
    def create_income_trends_section(self, parent):
        """Create income trends section"""
        section = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        section.pack(fill=tk.X, pady=(0, 15))
        
        # Section header
        header = tk.Frame(section, bg='#8e44ad')
        header.pack(fill=tk.X)
        tk.Label(header, text="📈 Income Trends (Last 6 Months)", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#8e44ad').pack(pady=10)
        
        # Trends data
        trends_frame = tk.Frame(section, bg='#ffffff')
        trends_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        try:
            # Get last 6 months income data
            months_data = []
            for i in range(5, -1, -1):
                from datetime import datetime, timedelta
                target_date = datetime.now() - timedelta(days=30*i)
                month_str = target_date.strftime('%Y-%m')
                month_name = target_date.strftime('%B %Y')
                
                self.cursor.execute('''
                    SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                    WHERE transaction_type = 'income' 
                    AND strftime('%Y-%m', transaction_date) = ?
                ''', (month_str,))
                
                amount = self.cursor.fetchone()[0]
                months_data.append((month_name, amount))
            
            # Create simple bar chart representation
            max_amount = max(amount for _, amount in months_data) if months_data else 1
            
            for month_name, amount in months_data:
                row = tk.Frame(trends_frame, bg='#ffffff')
                row.pack(fill=tk.X, pady=2)
                
                tk.Label(row, text=f"{month_name}:", width=15, anchor='w',
                        font=('Segoe UI', 10), bg='#ffffff').pack(side=tk.LEFT)
                
                # Simple bar representation
                bar_width = int((amount / max_amount * 300)) if max_amount > 0 else 0
                bar_frame = tk.Frame(row, bg='#27ae60', height=20, width=bar_width)
                bar_frame.pack(side=tk.LEFT, padx=(10, 5))
                bar_frame.pack_propagate(False)
                
                tk.Label(row, text=f"GHS {amount:.2f}", 
                        font=('Segoe UI', 10, 'bold'), bg='#ffffff').pack(side=tk.LEFT)
                        
        except Exception as e:
            tk.Label(trends_frame, text=f"Error loading trends: {str(e)}", 
                    fg='red', bg='#ffffff').pack()
    
    def generate_expense_analysis(self):
        """Generate detailed expense analysis report with charts and insights"""
        try:
            # Get date range
            if CALENDAR_AVAILABLE:
                from_date = self.report_from_date.get_date().strftime('%Y-%m-%d')
                to_date = self.report_to_date.get_date().strftime('%Y-%m-%d')
            else:
                from_date = self.report_from_date.get()
                to_date = self.report_to_date.get()
            
            # Create analysis window
            analysis_window = tk.Toplevel(self.root)
            analysis_window.title("Expense Analysis Report")
            analysis_window.geometry("1200x800")
            analysis_window.configure(bg='#f8f9fa')
            
            # Header
            header_frame = tk.Frame(analysis_window, bg='#e74c3c')
            header_frame.pack(fill=tk.X, pady=(0, 20))
            
            header_content = tk.Frame(header_frame, bg='#e74c3c')
            header_content.pack(fill=tk.BOTH, padx=30, pady=20)
            
            tk.Label(header_content, text="💸 Expense Analysis Report", 
                    font=('Segoe UI', 24, 'bold'), fg='white', bg='#e74c3c').pack(anchor='w')
            tk.Label(header_content, text=f"Period: {from_date} to {to_date}", 
                    font=('Segoe UI', 12), fg='#fadbd8', bg='#e74c3c').pack(anchor='w', pady=(5, 0))
            
            # Create scrollable content
            scrollable_frame = ScrollableFrame(analysis_window, bg='#f8f9fa')
            scrollable_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 20))
            content = scrollable_frame.get_frame()
            
            # Get expense data
            self.cursor.execute('''
                SELECT 
                    SUM(amount) as total_expenses,
                    COUNT(*) as transaction_count,
                    AVG(amount) as avg_expense
                FROM financial_transactions
                WHERE transaction_type = 'expense'
                AND transaction_date BETWEEN ? AND ?
            ''', (from_date, to_date))
            
            total_expenses, transaction_count, avg_expense = self.cursor.fetchone()
            total_expenses = total_expenses or 0
            transaction_count = transaction_count or 0
            avg_expense = avg_expense or 0
            
            # Summary Cards
            summary_container = tk.Frame(content, bg='#f8f9fa')
            summary_container.pack(fill=tk.X, pady=(0, 20))
            
            # Total Expenses Card
            total_card = self.create_analysis_card(summary_container, "💸 Total Expenses", 
                                                   f"GHS {total_expenses:,.2f}", '#e74c3c')
            total_card.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 10))
            
            # Transaction Count Card
            count_card = self.create_analysis_card(summary_container, "📝 Transactions", 
                                                   str(transaction_count), '#3498db')
            count_card.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 10))
            
            # Average Expense Card
            avg_card = self.create_analysis_card(summary_container, "📊 Average Expense", 
                                                 f"GHS {avg_expense:,.2f}", '#9b59b6')
            avg_card.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            
            # Expense by Category
            category_frame = tk.Frame(content, bg='#ffffff', relief='solid', bd=1)
            category_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 20))
            
            cat_header = tk.Frame(category_frame, bg='#34495e')
            cat_header.pack(fill=tk.X)
            
            tk.Label(cat_header, text="📊 Expense Breakdown by Category", 
                    font=('Segoe UI', 16, 'bold'), fg='white', bg='#34495e').pack(pady=15)
            
            cat_content = tk.Frame(category_frame, bg='#ffffff')
            cat_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
            
            # Get category breakdown
            self.cursor.execute('''
                SELECT 
                    fc.category_name,
                    SUM(ft.amount) as category_total,
                    COUNT(ft.id) as category_count,
                    AVG(ft.amount) as category_avg
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'expense'
                AND ft.transaction_date BETWEEN ? AND ?
                GROUP BY fc.id, fc.category_name
                ORDER BY category_total DESC
            ''', (from_date, to_date))
            
            categories = self.cursor.fetchall()
            
            if categories:
                # Create table header
                header_row = tk.Frame(cat_content, bg='#ecf0f1', relief='solid', bd=1)
                header_row.pack(fill=tk.X, pady=(0, 5))
                
                tk.Label(header_row, text="Category", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=25, anchor='w').pack(side=tk.LEFT, padx=10, pady=8)
                tk.Label(header_row, text="Total", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=15, anchor='e').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="Count", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=10, anchor='center').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="Average", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=15, anchor='e').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="% of Total", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=12, anchor='center').pack(side=tk.LEFT, padx=5, pady=8)
                
                # Category rows
                for idx, (cat_name, cat_total, cat_count, cat_avg) in enumerate(categories):
                    percentage = (cat_total / total_expenses * 100) if total_expenses > 0 else 0
                    
                    row_bg = '#ffffff' if idx % 2 == 0 else '#f8f9fa'
                    row_frame = tk.Frame(cat_content, bg=row_bg, relief='solid', bd=1)
                    row_frame.pack(fill=tk.X, pady=1)
                    
                    tk.Label(row_frame, text=cat_name, font=('Segoe UI', 10), 
                            bg=row_bg, width=25, anchor='w').pack(side=tk.LEFT, padx=10, pady=8)
                    tk.Label(row_frame, text=f"GHS {cat_total:,.2f}", font=('Segoe UI', 10, 'bold'), 
                            fg='#e74c3c', bg=row_bg, width=15, anchor='e').pack(side=tk.LEFT, padx=5, pady=8)
                    tk.Label(row_frame, text=str(cat_count), font=('Segoe UI', 10), 
                            bg=row_bg, width=10, anchor='center').pack(side=tk.LEFT, padx=5, pady=8)
                    tk.Label(row_frame, text=f"GHS {cat_avg:,.2f}", font=('Segoe UI', 10), 
                            bg=row_bg, width=15, anchor='e').pack(side=tk.LEFT, padx=5, pady=8)
                    
                    # Percentage bar
                    pct_frame = tk.Frame(row_frame, bg=row_bg, width=150)
                    pct_frame.pack(side=tk.LEFT, padx=10, pady=4)
                    pct_frame.pack_propagate(False)
                    
                    bar_width = int(percentage * 1.2)  # Scale for visual
                    if bar_width > 0:
                        bar = tk.Frame(pct_frame, bg='#e74c3c', width=bar_width, height=20)
                        bar.pack(side=tk.LEFT)
                    
                    tk.Label(pct_frame, text=f"{percentage:.1f}%", font=('Segoe UI', 9, 'bold'), 
                            bg=row_bg).pack(side=tk.LEFT, padx=5)
            else:
                tk.Label(cat_content, text="No expense data found for the selected period.", 
                        font=('Segoe UI', 12), fg='#7f8c8d', bg='#ffffff').pack(pady=30)
            
            # Monthly Trend Analysis
            trend_frame = tk.Frame(content, bg='#ffffff', relief='solid', bd=1)
            trend_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 20))
            
            trend_header = tk.Frame(trend_frame, bg='#16a085')
            trend_header.pack(fill=tk.X)
            
            tk.Label(trend_header, text="📈 Monthly Expense Trend", 
                    font=('Segoe UI', 16, 'bold'), fg='white', bg='#16a085').pack(pady=15)
            
            trend_content = tk.Frame(trend_frame, bg='#ffffff')
            trend_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
            
            # Get monthly breakdown
            self.cursor.execute('''
                SELECT 
                    strftime('%Y-%m', transaction_date) as month,
                    SUM(amount) as monthly_total,
                    COUNT(*) as monthly_count
                FROM financial_transactions
                WHERE transaction_type = 'expense'
                AND transaction_date BETWEEN ? AND ?
                GROUP BY month
                ORDER BY month
            ''', (from_date, to_date))
            
            monthly_data = self.cursor.fetchall()
            
            if monthly_data:
                # Create table
                header_row = tk.Frame(trend_content, bg='#ecf0f1', relief='solid', bd=1)
                header_row.pack(fill=tk.X, pady=(0, 5))
                
                tk.Label(header_row, text="Month", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=20, anchor='w').pack(side=tk.LEFT, padx=10, pady=8)
                tk.Label(header_row, text="Total Expenses", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=20, anchor='e').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="Transactions", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=15, anchor='center').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="Trend", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=30, anchor='center').pack(side=tk.LEFT, padx=5, pady=8)
                
                max_monthly = max([m[1] for m in monthly_data]) if monthly_data else 1
                
                for idx, (month, monthly_total, monthly_count) in enumerate(monthly_data):
                    row_bg = '#ffffff' if idx % 2 == 0 else '#f8f9fa'
                    row_frame = tk.Frame(trend_content, bg=row_bg, relief='solid', bd=1)
                    row_frame.pack(fill=tk.X, pady=1)
                    
                    # Format month
                    from datetime import datetime
                    month_formatted = datetime.strptime(month, '%Y-%m').strftime('%B %Y')
                    
                    tk.Label(row_frame, text=month_formatted, font=('Segoe UI', 10), 
                            bg=row_bg, width=20, anchor='w').pack(side=tk.LEFT, padx=10, pady=8)
                    tk.Label(row_frame, text=f"GHS {monthly_total:,.2f}", font=('Segoe UI', 10, 'bold'), 
                            fg='#e74c3c', bg=row_bg, width=20, anchor='e').pack(side=tk.LEFT, padx=5, pady=8)
                    tk.Label(row_frame, text=str(monthly_count), font=('Segoe UI', 10), 
                            bg=row_bg, width=15, anchor='center').pack(side=tk.LEFT, padx=5, pady=8)
                    
                    # Visual bar
                    bar_container = tk.Frame(row_frame, bg=row_bg, width=300)
                    bar_container.pack(side=tk.LEFT, padx=10, pady=4)
                    bar_container.pack_propagate(False)
                    
                    bar_width = int((monthly_total / max_monthly) * 250) if max_monthly > 0 else 0
                    if bar_width > 0:
                        bar = tk.Frame(bar_container, bg='#3498db', width=bar_width, height=20)
                        bar.pack(side=tk.LEFT)
            
            # Top Expenses
            top_frame = tk.Frame(content, bg='#ffffff', relief='solid', bd=1)
            top_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 20))
            
            top_header = tk.Frame(top_frame, bg='#c0392b')
            top_header.pack(fill=tk.X)
            
            tk.Label(top_header, text="📊 Top 10 Largest Expenses", 
                    font=('Segoe UI', 16, 'bold'), fg='white', bg='#c0392b').pack(pady=15)
            
            top_content = tk.Frame(top_frame, bg='#ffffff')
            top_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
            
            # Get top expenses
            self.cursor.execute('''
                SELECT 
                    ft.transaction_date,
                    fc.category_name,
                    ft.description,
                    ft.amount,
                    ft.payment_method
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'expense'
                AND ft.transaction_date BETWEEN ? AND ?
                ORDER BY ft.amount DESC
                LIMIT 10
            ''', (from_date, to_date))
            
            top_expenses = self.cursor.fetchall()
            
            if top_expenses:
                # Create table
                header_row = tk.Frame(top_content, bg='#ecf0f1', relief='solid', bd=1)
                header_row.pack(fill=tk.X, pady=(0, 5))
                
                tk.Label(header_row, text="Date", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=12, anchor='w').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="Category", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=18, anchor='w').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="Description", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=35, anchor='w').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="Amount", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=15, anchor='e').pack(side=tk.LEFT, padx=5, pady=8)
                tk.Label(header_row, text="Method", font=('Segoe UI', 11, 'bold'), 
                        bg='#ecf0f1', width=12, anchor='center').pack(side=tk.LEFT, padx=5, pady=8)
                
                for idx, (trans_date, category, description, amount, method) in enumerate(top_expenses):
                    row_bg = '#ffffff' if idx % 2 == 0 else '#f8f9fa'
                    row_frame = tk.Frame(top_content, bg=row_bg, relief='solid', bd=1)
                    row_frame.pack(fill=tk.X, pady=1)
                    
                    tk.Label(row_frame, text=trans_date, font=('Segoe UI', 10), 
                            bg=row_bg, width=12, anchor='w').pack(side=tk.LEFT, padx=5, pady=8)
                    tk.Label(row_frame, text=category, font=('Segoe UI', 10), 
                            bg=row_bg, width=18, anchor='w').pack(side=tk.LEFT, padx=5, pady=8)
                    
                    # Truncate description if too long
                    desc_display = description[:40] + "..." if len(description) > 40 else description
                    tk.Label(row_frame, text=desc_display, font=('Segoe UI', 10), 
                            bg=row_bg, width=35, anchor='w').pack(side=tk.LEFT, padx=5, pady=8)
                    
                    tk.Label(row_frame, text=f"GHS {amount:,.2f}", font=('Segoe UI', 10, 'bold'), 
                            fg='#e74c3c', bg=row_bg, width=15, anchor='e').pack(side=tk.LEFT, padx=5, pady=8)
                    tk.Label(row_frame, text=method or "N/A", font=('Segoe UI', 10), 
                            bg=row_bg, width=12, anchor='center').pack(side=tk.LEFT, padx=5, pady=8)
            
            # Export button
            export_frame = tk.Frame(content, bg='#f8f9fa')
            export_frame.pack(fill=tk.X, pady=(10, 0))
            
            export_btn = tk.Button(export_frame, text="📊 Export to PDF", 
                                   command=lambda: self.export_expense_analysis_pdf(from_date, to_date),
                                   font=('Segoe UI', 12, 'bold'), bg='#27ae60', fg='white',
                                   relief='solid', bd=0, padx=30, pady=12, cursor='hand2')
            export_btn.pack()
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate expense analysis: {str(e)}")
    
    def create_analysis_card(self, parent, title, value, color):
        """Create a summary card for analysis"""
        card = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        
        card_header = tk.Frame(card, bg=color)
        card_header.pack(fill=tk.X)
        
        tk.Label(card_header, text=title, font=('Segoe UI', 12, 'bold'), 
                fg='white', bg=color).pack(pady=10)
        
        tk.Label(card, text=value, font=('Segoe UI', 20, 'bold'), 
                fg=color, bg='#ffffff').pack(pady=20)
        
        return card
    
    def export_expense_analysis_pdf(self, from_date, to_date):
        """Export expense analysis to PDF"""
        messagebox.showinfo("Export", "PDF export feature coming soon!\nYou can use the print function to save as PDF.")
    
    def generate_profit_loss_report(self):
        """Generate profit and loss statement"""
        try:
            # Get date range
            if CALENDAR_AVAILABLE:
                from_date = self.report_from_date.get_date().strftime('%Y-%m-%d')
                to_date = self.report_to_date.get_date().strftime('%Y-%m-%d')
            else:
                from_date = self.report_from_date.get()
                to_date = self.report_to_date.get()
            
            # Store date range for export functions
            self.current_pl_from_date = from_date
            self.current_pl_to_date = to_date
            
            # Create report window
            report_window = tk.Toplevel(self.root)
            report_window.title("Profit & Loss Statement")
            report_window.geometry("1000x800")
            report_window.configure(bg='#f8f9fa')
            
            # Header
            header_frame = tk.Frame(report_window, bg='#2c3e50')
            header_frame.pack(fill=tk.X, pady=(0, 20))
            
            header_content = tk.Frame(header_frame, bg='#2c3e50')
            header_content.pack(fill=tk.BOTH, padx=30, pady=20)
            
            tk.Label(header_content, text="📈 Profit & Loss Statement", 
                    font=('Segoe UI', 24, 'bold'), fg='white', bg='#2c3e50').pack(anchor='w')
            tk.Label(header_content, text=f"Period: {from_date} to {to_date}", 
                    font=('Segoe UI', 12), fg='#bdc3c7', bg='#2c3e50').pack(anchor='w', pady=(5, 0))
            
            # Create scrollable content
            scrollable_frame = ScrollableFrame(report_window, bg='#f8f9fa')
            scrollable_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 10))
            content = scrollable_frame.get_frame()
            
            # P&L Statement
            self.create_pl_statement(content, from_date, to_date)
            
            # Export buttons at the bottom
            export_frame = tk.Frame(report_window, bg='#f8f9fa')
            export_frame.pack(fill=tk.X, padx=20, pady=(0, 20))
            
            button_container = tk.Frame(export_frame, bg='#f8f9fa')
            button_container.pack()
            
            csv_btn = tk.Button(button_container, text="📊 Export as CSV", 
                               command=lambda: self.export_pl_as_csv(from_date, to_date),
                               font=('Segoe UI', 11, 'bold'), bg='#27ae60', fg='white',
                               relief='solid', bd=0, padx=25, pady=12, cursor='hand2')
            csv_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            if PDF_AVAILABLE:
                pdf_btn = tk.Button(button_container, text="📊 Export as PDF", 
                                   command=lambda: self.export_pl_as_pdf(from_date, to_date),
                                   font=('Segoe UI', 11, 'bold'), bg='#e74c3c', fg='white',
                                   relief='solid', bd=0, padx=25, pady=12, cursor='hand2')
                pdf_btn.pack(side=tk.LEFT)
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate P&L statement: {str(e)}")
    
    def create_pl_statement(self, parent, from_date, to_date):
        """Create complete P&L statement"""
        statement_frame = tk.Frame(parent, bg='#ffffff', relief='solid', bd=2)
        statement_frame.pack(fill=tk.X, pady=(0, 15))
        
        # Title
        title_frame = tk.Frame(statement_frame, bg='#2c3e50')
        title_frame.pack(fill=tk.X)
        tk.Label(title_frame, text="PROFIT & LOSS STATEMENT", 
                font=('Segoe UI', 16, 'bold'), fg='white', bg='#2c3e50').pack(pady=15)
        
        # Period display
        period_frame = tk.Frame(statement_frame, bg='#ecf0f1')
        period_frame.pack(fill=tk.X, padx=20, pady=10)
        
        tk.Label(period_frame, text=f"Reporting Period: {from_date} to {to_date}", 
                font=('Segoe UI', 12, 'bold'), bg='#ecf0f1').pack()
        
        # Main P&L content
        pl_content = tk.Frame(statement_frame, bg='#ffffff')
        pl_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        try:
            # REVENUE SECTION
            revenue_frame = tk.Frame(pl_content, bg='#ffffff')
            revenue_frame.pack(fill=tk.X, pady=(0, 10))
            
            tk.Label(revenue_frame, text="REVENUE", font=('Segoe UI', 14, 'bold'), 
                    fg='#2c3e50', bg='#ffffff').pack(anchor='w')
            
            # Get income by category for the date range
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total_amount
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'income'
                AND ft.transaction_date BETWEEN ? AND ?
                GROUP BY fc.id, fc.category_name
                ORDER BY total_amount DESC
            ''', (from_date, to_date))
            
            income_categories = self.cursor.fetchall()
            total_revenue = 0
            
            if income_categories:
                for category_name, amount in income_categories:
                    total_revenue += amount
                    revenue_row = tk.Frame(revenue_frame, bg='#ffffff')
                    revenue_row.pack(fill=tk.X, padx=20, pady=2)
                    
                    tk.Label(revenue_row, text=f"  {category_name}", 
                            font=('Segoe UI', 10), bg='#ffffff').pack(side=tk.LEFT)
                    tk.Label(revenue_row, text=f"GHS {amount:,.2f}", 
                            font=('Segoe UI', 10), bg='#ffffff').pack(side=tk.RIGHT)
            else:
                no_income_label = tk.Frame(revenue_frame, bg='#f8f9fa')
                no_income_label.pack(fill=tk.X, padx=20, pady=5)
                tk.Label(no_income_label, text="  No income recorded for this period", 
                        font=('Segoe UI', 10), fg='#7f8c8d', bg='#f8f9fa').pack(anchor='w')
            
            # Total Revenue
            total_rev_frame = tk.Frame(revenue_frame, bg='#27ae60')
            total_rev_frame.pack(fill=tk.X, padx=10, pady=10)
            
            tk.Label(total_rev_frame, text="Total Revenue", 
                    font=('Segoe UI', 12, 'bold'), fg='white', bg='#27ae60').pack(side=tk.LEFT, padx=10, pady=10)
            tk.Label(total_rev_frame, text=f"GHS {total_revenue:,.2f}", 
                    font=('Segoe UI', 12, 'bold'), fg='white', bg='#27ae60').pack(side=tk.RIGHT, padx=10, pady=10)
            
            # EXPENSES SECTION
            expenses_frame = tk.Frame(pl_content, bg='#ffffff')
            expenses_frame.pack(fill=tk.X, pady=(20, 10))
            
            tk.Label(expenses_frame, text="EXPENSES", font=('Segoe UI', 14, 'bold'), 
                    fg='#2c3e50', bg='#ffffff').pack(anchor='w')
            
            # Get expenses by category for the date range
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total_amount
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'expense'
                AND ft.transaction_date BETWEEN ? AND ?
                GROUP BY fc.id, fc.category_name
                ORDER BY total_amount DESC
            ''', (from_date, to_date))
            
            expense_categories = self.cursor.fetchall()
            total_expenses = 0
            
            if expense_categories:
                for category_name, amount in expense_categories:
                    total_expenses += amount
                    expense_row = tk.Frame(expenses_frame, bg='#ffffff')
                    expense_row.pack(fill=tk.X, padx=20, pady=2)
                    
                    tk.Label(expense_row, text=f"  {category_name}", 
                            font=('Segoe UI', 10), bg='#ffffff').pack(side=tk.LEFT)
                    tk.Label(expense_row, text=f"GHS {amount:,.2f}", 
                            font=('Segoe UI', 10), bg='#ffffff').pack(side=tk.RIGHT)
            else:
                no_expense_label = tk.Frame(expenses_frame, bg='#f8f9fa')
                no_expense_label.pack(fill=tk.X, padx=20, pady=5)
                tk.Label(no_expense_label, text="  No expenses recorded for this period", 
                        font=('Segoe UI', 10), fg='#7f8c8d', bg='#f8f9fa').pack(anchor='w')
            
            # Total Expenses
            total_exp_frame = tk.Frame(expenses_frame, bg='#e74c3c')
            total_exp_frame.pack(fill=tk.X, padx=10, pady=10)
            
            tk.Label(total_exp_frame, text="Total Expenses", 
                    font=('Segoe UI', 12, 'bold'), fg='white', bg='#e74c3c').pack(side=tk.LEFT, padx=10, pady=10)
            tk.Label(total_exp_frame, text=f"GHS {total_expenses:,.2f}", 
                    font=('Segoe UI', 12, 'bold'), fg='white', bg='#e74c3c').pack(side=tk.RIGHT, padx=10, pady=10)
            
            # Separator
            separator = tk.Frame(pl_content, bg='#dee2e6', height=2)
            separator.pack(fill=tk.X, pady=15)
            
            # NET PROFIT/LOSS
            net_profit = total_revenue - total_expenses
            profit_color = '#27ae60' if net_profit >= 0 else '#e74c3c'
            profit_text = "NET PROFIT" if net_profit >= 0 else "NET LOSS"
            
            profit_frame = tk.Frame(pl_content, bg='#ffffff')
            profit_frame.pack(fill=tk.X, pady=(10, 0))
            
            net_frame = tk.Frame(profit_frame, bg=profit_color, relief='solid', bd=2)
            net_frame.pack(fill=tk.X, padx=10, pady=5)
            
            tk.Label(net_frame, text=profit_text, 
                    font=('Segoe UI', 16, 'bold'), fg='white', bg=profit_color).pack(side=tk.LEFT, padx=15, pady=15)
            tk.Label(net_frame, text=f"GHS {abs(net_profit):,.2f}", 
                    font=('Segoe UI', 16, 'bold'), fg='white', bg=profit_color).pack(side=tk.RIGHT, padx=15, pady=15)
            
            # Financial Metrics
            metrics_frame = tk.Frame(pl_content, bg='#ffffff')
            metrics_frame.pack(fill=tk.X, pady=(15, 0))
            
            # Profit margin
            margin = (net_profit / total_revenue * 100) if total_revenue > 0 else 0
            margin_frame = tk.Frame(metrics_frame, bg='#95a5a6')
            margin_frame.pack(fill=tk.X, padx=10, pady=5)
            
            tk.Label(margin_frame, text="Profit Margin", 
                    font=('Segoe UI', 12, 'bold'), fg='white', bg='#95a5a6').pack(side=tk.LEFT, padx=10, pady=8)
            tk.Label(margin_frame, text=f"{margin:.2f}%", 
                    font=('Segoe UI', 12, 'bold'), fg='white', bg='#95a5a6').pack(side=tk.RIGHT, padx=10, pady=8)
            
            # Additional metrics row
            additional_metrics = tk.Frame(metrics_frame, bg='#ffffff')
            additional_metrics.pack(fill=tk.X, pady=(10, 0))
            
            # Operating ratio
            operating_ratio = (total_expenses / total_revenue * 100) if total_revenue > 0 else 0
            ratio_frame = tk.Frame(additional_metrics, bg='#34495e')
            ratio_frame.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(10, 5), pady=5)
            
            tk.Label(ratio_frame, text="Operating Ratio", 
                    font=('Segoe UI', 10, 'bold'), fg='white', bg='#34495e').pack(side=tk.LEFT, padx=10, pady=6)
            tk.Label(ratio_frame, text=f"{operating_ratio:.2f}%", 
                    font=('Segoe UI', 10, 'bold'), fg='white', bg='#34495e').pack(side=tk.RIGHT, padx=10, pady=6)
            
            # Transaction count
            self.cursor.execute('''
                SELECT COUNT(*) FROM financial_transactions
                WHERE transaction_date BETWEEN ? AND ?
            ''', (from_date, to_date))
            total_transactions = self.cursor.fetchone()[0]
            
            trans_frame = tk.Frame(additional_metrics, bg='#16a085')
            trans_frame.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(5, 10), pady=5)
            
            tk.Label(trans_frame, text="Total Transactions", 
                    font=('Segoe UI', 10, 'bold'), fg='white', bg='#16a085').pack(side=tk.LEFT, padx=10, pady=6)
            tk.Label(trans_frame, text=str(total_transactions), 
                    font=('Segoe UI', 10, 'bold'), fg='white', bg='#16a085').pack(side=tk.RIGHT, padx=10, pady=6)
            
            # Summary note
            note_frame = tk.Frame(pl_content, bg='#fff3cd', relief='solid', bd=1)
            note_frame.pack(fill=tk.X, padx=10, pady=20)
            
            note_text = f"📊 This statement reflects all financial transactions recorded between {from_date} and {to_date}."
            tk.Label(note_frame, text=note_text, 
                    font=('Segoe UI', 9), fg='#856404', bg='#fff3cd', wraplength=800).pack(padx=15, pady=10)
            
        except Exception as e:
            error_frame = tk.Frame(pl_content, bg='#f8d7da', relief='solid', bd=1)
            error_frame.pack(fill=tk.X, padx=10, pady=10)
            tk.Label(error_frame, text=f"❌ Error generating P&L statement: {str(e)}", 
                    font=('Segoe UI', 10), fg='#721c24', bg='#f8d7da').pack(padx=15, pady=10)
    
    def export_pl_as_csv(self, from_date, to_date):
        """Export Profit & Loss statement as CSV"""
        try:
            # Ask user for file location
            file_path = filedialog.asksaveasfilename(
                defaultextension='.csv',
                filetypes=[('CSV files', '*.csv'), ('All files', '*.*')],
                initialfile=f'Profit_Loss_Statement_{from_date}_to_{to_date}.csv'
            )
            
            if not file_path:
                return
            
            # Get P&L data
            # Revenue data
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total_amount
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'income'
                AND ft.transaction_date BETWEEN ? AND ?
                GROUP BY fc.id, fc.category_name
                ORDER BY total_amount DESC
            ''', (from_date, to_date))
            income_categories = self.cursor.fetchall()
            
            # Expense data
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total_amount
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'expense'
                AND ft.transaction_date BETWEEN ? AND ?
                GROUP BY fc.id, fc.category_name
                ORDER BY total_amount DESC
            ''', (from_date, to_date))
            expense_categories = self.cursor.fetchall()
            
            # Calculate totals
            total_revenue = sum(amount for _, amount in income_categories)
            total_expenses = sum(amount for _, amount in expense_categories)
            net_profit = total_revenue - total_expenses
            
            # Write to CSV
            with open(file_path, 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.writer(csvfile)
                
                # Header
                writer.writerow(['PROFIT & LOSS STATEMENT'])
                writer.writerow([f'Period: {from_date} to {to_date}'])
                writer.writerow([f'Generated: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}'])
                writer.writerow([])
                
                # Revenue Section
                writer.writerow(['REVENUE'])
                writer.writerow(['Category', 'Amount (GHS)'])
                for category_name, amount in income_categories:
                    writer.writerow([category_name, f'{amount:.2f}'])
                writer.writerow([])
                writer.writerow(['Total Revenue', f'{total_revenue:.2f}'])
                writer.writerow([])
                
                # Expenses Section
                writer.writerow(['EXPENSES'])
                writer.writerow(['Category', 'Amount (GHS)'])
                for category_name, amount in expense_categories:
                    writer.writerow([category_name, f'{amount:.2f}'])
                writer.writerow([])
                writer.writerow(['Total Expenses', f'{total_expenses:.2f}'])
                writer.writerow([])
                
                # Net Profit/Loss
                profit_label = 'NET PROFIT' if net_profit >= 0 else 'NET LOSS'
                writer.writerow([profit_label, f'{abs(net_profit):.2f}'])
                writer.writerow([])
                
                # Additional Metrics
                margin = (net_profit / total_revenue * 100) if total_revenue > 0 else 0
                operating_ratio = (total_expenses / total_revenue * 100) if total_revenue > 0 else 0
                
                writer.writerow(['FINANCIAL METRICS'])
                writer.writerow(['Metric', 'Value'])
                writer.writerow(['Profit Margin', f'{margin:.2f}%'])
                writer.writerow(['Operating Ratio', f'{operating_ratio:.2f}%'])
                writer.writerow(['Revenue', f'{total_revenue:.2f}'])
                writer.writerow(['Expenses', f'{total_expenses:.2f}'])
                writer.writerow([profit_label, f'{abs(net_profit):.2f}'])
            
            messagebox.showinfo("Success", f"P&L Statement exported successfully to:\n{file_path}")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to export CSV: {str(e)}")
    
    def export_pl_as_pdf(self, from_date, to_date):
        """Export Profit & Loss statement as PDF"""
        try:
            if not PDF_AVAILABLE:
                messagebox.showerror("Error", "PDF export requires reportlab library.\nInstall it using: pip install reportlab")
                return
            
            # Ask user for file location
            file_path = filedialog.asksaveasfilename(
                defaultextension='.pdf',
                filetypes=[('PDF files', '*.pdf'), ('All files', '*.*')],
                initialfile=f'Profit_Loss_Statement_{from_date}_to_{to_date}.pdf'
            )
            
            if not file_path:
                return
            
            # Get P&L data
            # Revenue data
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total_amount
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'income'
                AND ft.transaction_date BETWEEN ? AND ?
                GROUP BY fc.id, fc.category_name
                ORDER BY total_amount DESC
            ''', (from_date, to_date))
            income_categories = self.cursor.fetchall()
            
            # Expense data
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total_amount
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'expense'
                AND ft.transaction_date BETWEEN ? AND ?
                GROUP BY fc.id, fc.category_name
                ORDER BY total_amount DESC
            ''', (from_date, to_date))
            expense_categories = self.cursor.fetchall()
            
            # Calculate totals
            total_revenue = sum(amount for _, amount in income_categories)
            total_expenses = sum(amount for _, amount in expense_categories)
            net_profit = total_revenue - total_expenses
            
            # Create PDF
            doc = SimpleDocTemplate(file_path, pagesize=letter)
            elements = []
            styles = getSampleStyleSheet()
            
            # Custom styles
            title_style = ParagraphStyle(
                'CustomTitle',
                parent=styles['Heading1'],
                fontSize=24,
                textColor=colors.HexColor('#2c3e50'),
                spaceAfter=30,
                alignment=1  # Center
            )
            
            heading_style = ParagraphStyle(
                'CustomHeading',
                parent=styles['Heading2'],
                fontSize=16,
                textColor=colors.HexColor('#34495e'),
                spaceAfter=12
            )
            
            # Title
            elements.append(Paragraph("PROFIT & LOSS STATEMENT", title_style))
            elements.append(Paragraph(f"Period: {from_date} to {to_date}", styles['Normal']))
            elements.append(Paragraph(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", styles['Normal']))
            elements.append(Spacer(1, 20))
            
            # Revenue Section
            elements.append(Paragraph("REVENUE", heading_style))
            
            revenue_data = [['Category', 'Amount (GHS)']]
            for category_name, amount in income_categories:
                revenue_data.append([category_name, f'{amount:,.2f}'])
            revenue_data.append(['', ''])
            revenue_data.append(['Total Revenue', f'{total_revenue:,.2f}'])
            
            revenue_table = Table(revenue_data, colWidths=[4*inch, 2*inch])
            revenue_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#27ae60')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('ALIGN', (1, 0), (1, -1), 'RIGHT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 12),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, -1), (-1, -1), colors.HexColor('#d5f4e6')),
                ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
                ('GRID', (0, 0), (-1, -2), 1, colors.grey),
                ('BOX', (0, 0), (-1, -1), 2, colors.HexColor('#27ae60')),
            ]))
            elements.append(revenue_table)
            elements.append(Spacer(1, 20))
            
            # Expenses Section
            elements.append(Paragraph("EXPENSES", heading_style))
            
            expense_data = [['Category', 'Amount (GHS)']]
            for category_name, amount in expense_categories:
                expense_data.append([category_name, f'{amount:,.2f}'])
            expense_data.append(['', ''])
            expense_data.append(['Total Expenses', f'{total_expenses:,.2f}'])
            
            expense_table = Table(expense_data, colWidths=[4*inch, 2*inch])
            expense_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#e74c3c')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('ALIGN', (1, 0), (1, -1), 'RIGHT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 12),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, -1), (-1, -1), colors.HexColor('#fadbd8')),
                ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
                ('GRID', (0, 0), (-1, -2), 1, colors.grey),
                ('BOX', (0, 0), (-1, -1), 2, colors.HexColor('#e74c3c')),
            ]))
            elements.append(expense_table)
            elements.append(Spacer(1, 30))
            
            # Net Profit/Loss
            profit_label = 'NET PROFIT' if net_profit >= 0 else 'NET LOSS'
            profit_color = colors.HexColor('#27ae60') if net_profit >= 0 else colors.HexColor('#e74c3c')
            
            profit_data = [[profit_label, f'GHS {abs(net_profit):,.2f}']]
            profit_table = Table(profit_data, colWidths=[4*inch, 2*inch])
            profit_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, -1), profit_color),
                ('TEXTCOLOR', (0, 0), (-1, -1), colors.whitesmoke),
                ('ALIGN', (0, 0), (0, -1), 'LEFT'),
                ('ALIGN', (1, 0), (1, -1), 'RIGHT'),
                ('FONTNAME', (0, 0), (-1, -1), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, -1), 14),
                ('PADDING', (0, 0), (-1, -1), 12),
                ('BOX', (0, 0), (-1, -1), 2, profit_color),
            ]))
            elements.append(profit_table)
            elements.append(Spacer(1, 20))
            
            # Financial Metrics
            margin = (net_profit / total_revenue * 100) if total_revenue > 0 else 0
            operating_ratio = (total_expenses / total_revenue * 100) if total_revenue > 0 else 0
            
            elements.append(Paragraph("FINANCIAL METRICS", heading_style))
            metrics_data = [
                ['Metric', 'Value'],
                ['Profit Margin', f'{margin:.2f}%'],
                ['Operating Ratio', f'{operating_ratio:.2f}%'],
            ]
            
            metrics_table = Table(metrics_data, colWidths=[4*inch, 2*inch])
            metrics_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#95a5a6')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('ALIGN', (1, 0), (1, -1), 'RIGHT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 11),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 10),
                ('GRID', (0, 0), (-1, -1), 1, colors.grey),
                ('BOX', (0, 0), (-1, -1), 2, colors.HexColor('#95a5a6')),
            ]))
            elements.append(metrics_table)
            
            # Build PDF
            doc.build(elements)
            
            messagebox.showinfo("Success", f"P&L Statement exported successfully to:\n{file_path}")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to export PDF: {str(e)}")
    
    def generate_category_report(self):
        """Generate category breakdown report"""
        try:
            # Get date range
            if CALENDAR_AVAILABLE:
                from_date = self.report_from_date.get_date().strftime('%Y-%m-%d')
                to_date = self.report_to_date.get_date().strftime('%Y-%m-%d')
            else:
                from_date = self.report_from_date.get()
                to_date = self.report_to_date.get()
            
            # Create report window
            report_window = tk.Toplevel(self.root)
            report_window.title("Category Breakdown Report")
            report_window.geometry("1000x700")
            report_window.configure(bg='#f8f9fa')
            
            # Header
            header_frame = tk.Frame(report_window, bg='#9b59b6')
            header_frame.pack(fill=tk.X, pady=(0, 20))
            
            header_content = tk.Frame(header_frame, bg='#9b59b6')
            header_content.pack(fill=tk.BOTH, padx=30, pady=15)
            
            tk.Label(header_content, text="📊 Category Breakdown Report", 
                    font=('Segoe UI', 18, 'bold'), fg='white', bg='#9b59b6').pack(anchor='w')
            tk.Label(header_content, text=f"Period: {from_date} to {to_date}", 
                    font=('Segoe UI', 11), fg='#e8d5f0', bg='#9b59b6').pack(anchor='w', pady=(5, 0))
            
            # Create scrollable content
            scrollable_frame = ScrollableFrame(report_window, bg='#f8f9fa')
            scrollable_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 10))
            content = scrollable_frame.get_frame()
            
            # Category analysis
            self.create_category_breakdown_content(content)
            
            # Export buttons
            export_frame = tk.Frame(report_window, bg='#f8f9fa')
            export_frame.pack(fill=tk.X, padx=20, pady=(0, 20))
            
            button_container = tk.Frame(export_frame, bg='#f8f9fa')
            button_container.pack()
            
            csv_btn = tk.Button(button_container, text="📊 Export as CSV", 
                               command=lambda: self.export_report_csv(from_date, to_date, 'category'),
                               font=('Segoe UI', 11, 'bold'), bg='#27ae60', fg='white',
                               relief='solid', bd=0, padx=25, pady=12, cursor='hand2')
            csv_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            if PDF_AVAILABLE:
                pdf_btn = tk.Button(button_container, text="📊 Export as PDF", 
                                   command=lambda: self.export_report_pdf(from_date, to_date, 'category'),
                                   font=('Segoe UI', 11, 'bold'), bg='#e74c3c', fg='white',
                                   relief='solid', bd=0, padx=25, pady=12, cursor='hand2')
                pdf_btn.pack(side=tk.LEFT)
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate category report: {str(e)}")
    
    def create_category_breakdown_content(self, parent):
        """Create detailed category breakdown"""
        # Income Categories
        income_frame = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        income_frame.pack(fill=tk.X, pady=(0, 15))
        
        header = tk.Frame(income_frame, bg='#27ae60')
        header.pack(fill=tk.X)
        tk.Label(header, text="💳 Income Categories", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#27ae60').pack(pady=10)
        
        income_tree_frame = tk.Frame(income_frame, bg='#ffffff')
        income_tree_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        columns = ('Category', 'Total Amount', 'Transactions', 'Avg Transaction', 'Last Date')
        income_tree = ttk.Treeview(income_tree_frame, columns=columns, show='headings', height=6)
        
        for col in columns:
            income_tree.heading(col, text=col)
            income_tree.column(col, width=150)
        
        try:
            self.cursor.execute('''
                SELECT fc.category_name, SUM(ft.amount) as total_amount, COUNT(ft.id) as transaction_count,
                       AVG(ft.amount) as avg_amount, MAX(ft.transaction_date) as last_date
                FROM financial_transactions ft
                JOIN financial_categories fc ON ft.category_id = fc.id
                WHERE ft.transaction_type = 'income'
                GROUP BY fc.id, fc.category_name
                ORDER BY total_amount DESC
            ''')
            
            for category_name, total, count, avg, last_date in self.cursor.fetchall():
                income_tree.insert('', 'end', values=(
                    category_name, 
                    f"GHS {total:.2f}", 
                    count,
                    f"GHS {avg:.2f}",
                    last_date or "N/A"
                ))
        except Exception as e:
            income_tree.insert('', 'end', values=("Error", str(e), "", "", ""))
        
        income_tree.pack(fill=tk.BOTH, expand=True)
    
    def generate_cashflow_report(self):
        """Generate cash flow report"""
        try:
            # Get date range
            if CALENDAR_AVAILABLE:
                from_date = self.report_from_date.get_date().strftime('%Y-%m-%d')
                to_date = self.report_to_date.get_date().strftime('%Y-%m-%d')
            else:
                from_date = self.report_from_date.get()
                to_date = self.report_to_date.get()
            
            # Create report window
            report_window = tk.Toplevel(self.root)
            report_window.title("Cash Flow Report")
            report_window.geometry("900x600")
            report_window.configure(bg='#f8f9fa')
            
            # Header
            header_frame = tk.Frame(report_window, bg='#16a085')
            header_frame.pack(fill=tk.X, pady=(0, 20))
            
            header_content = tk.Frame(header_frame, bg='#16a085')
            header_content.pack(fill=tk.BOTH, padx=30, pady=15)
            
            tk.Label(header_content, text="📊 Cash Flow Report", 
                    font=('Segoe UI', 18, 'bold'), fg='white', bg='#16a085').pack(anchor='w')
            tk.Label(header_content, text=f"Period: {from_date} to {to_date}", 
                    font=('Segoe UI', 11), fg='#a7efe1', bg='#16a085').pack(anchor='w', pady=(5, 0))
            
            # Create scrollable content
            scrollable_frame = ScrollableFrame(report_window, bg='#f8f9fa')
            scrollable_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 10))
            content = scrollable_frame.get_frame()
            
            # Cash flow analysis
            self.create_cashflow_analysis(content)
            
            # Export buttons
            export_frame = tk.Frame(report_window, bg='#f8f9fa')
            export_frame.pack(fill=tk.X, padx=20, pady=(0, 20))
            
            button_container = tk.Frame(export_frame, bg='#f8f9fa')
            button_container.pack()
            
            csv_btn = tk.Button(button_container, text="📊 Export as CSV", 
                               command=lambda: self.export_report_csv(from_date, to_date, 'cashflow'),
                               font=('Segoe UI', 11, 'bold'), bg='#27ae60', fg='white',
                               relief='solid', bd=0, padx=25, pady=12, cursor='hand2')
            csv_btn.pack(side=tk.LEFT, padx=(0, 10))
            
            if PDF_AVAILABLE:
                pdf_btn = tk.Button(button_container, text="📊 Export as PDF", 
                                   command=lambda: self.export_report_pdf(from_date, to_date, 'cashflow'),
                                   font=('Segoe UI', 11, 'bold'), bg='#e74c3c', fg='white',
                                   relief='solid', bd=0, padx=25, pady=12, cursor='hand2')
                pdf_btn.pack(side=tk.LEFT)
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to generate cash flow report: {str(e)}")
    
    def create_cashflow_analysis(self, parent):
        """Create cash flow analysis"""
        # Monthly cash flow
        monthly_frame = tk.Frame(parent, bg='#ffffff', relief='solid', bd=1)
        monthly_frame.pack(fill=tk.X, pady=(0, 15))
        
        header = tk.Frame(monthly_frame, bg='#16a085')
        header.pack(fill=tk.X)
        tk.Label(header, text="📊 Monthly Cash Flow (Last 6 Months)", 
                font=('Segoe UI', 14, 'bold'), fg='white', bg='#16a085').pack(pady=10)
        
        flow_content = tk.Frame(monthly_frame, bg='#ffffff')
        flow_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        try:
            # Create table headers
            headers_frame = tk.Frame(flow_content, bg='#ecf0f1')
            headers_frame.pack(fill=tk.X, pady=(0, 5))
            
            tk.Label(headers_frame, text="Month", width=15, font=('Segoe UI', 10, 'bold'),
                    bg='#ecf0f1').grid(row=0, column=0, padx=5, pady=5)
            tk.Label(headers_frame, text="Income", width=12, font=('Segoe UI', 10, 'bold'),
                    bg='#ecf0f1').grid(row=0, column=1, padx=5, pady=5)
            tk.Label(headers_frame, text="Expenses", width=12, font=('Segoe UI', 10, 'bold'),
                    bg='#ecf0f1').grid(row=0, column=2, padx=5, pady=5)
            tk.Label(headers_frame, text="Net Flow", width=12, font=('Segoe UI', 10, 'bold'),
                    bg='#ecf0f1').grid(row=0, column=3, padx=5, pady=5)
            
            # Get last 6 months data
            for i in range(5, -1, -1):
                from datetime import datetime, timedelta
                target_date = datetime.now() - timedelta(days=30*i)
                month_str = target_date.strftime('%Y-%m')
                month_name = target_date.strftime('%B %Y')
                
                # Get income for month
                self.cursor.execute('''
                    SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                    WHERE transaction_type = 'income' 
                    AND strftime('%Y-%m', transaction_date) = ?
                ''', (month_str,))
                monthly_income = self.cursor.fetchone()[0]
                
                # Get expenses for month
                self.cursor.execute('''
                    SELECT COALESCE(SUM(amount), 0) FROM financial_transactions 
                    WHERE transaction_type = 'expense' 
                    AND strftime('%Y-%m', transaction_date) = ?
                ''', (month_str,))
                monthly_expense = self.cursor.fetchone()[0]
                
                net_flow = monthly_income - monthly_expense
                flow_color = '#d5f4e6' if net_flow >= 0 else '#fadbd8'
                
                row_frame = tk.Frame(flow_content, bg=flow_color, relief='solid', bd=1)
                row_frame.pack(fill=tk.X, pady=1)
                
                tk.Label(row_frame, text=month_name, width=15,
                        bg=flow_color).grid(row=0, column=0, padx=5, pady=3)
                tk.Label(row_frame, text=f"GHS {monthly_income:.2f}", width=12,
                        bg=flow_color).grid(row=0, column=1, padx=5, pady=3)
                tk.Label(row_frame, text=f"GHS {monthly_expense:.2f}", width=12,
                        bg=flow_color).grid(row=0, column=2, padx=5, pady=3)
                tk.Label(row_frame, text=f"GHS {net_flow:.2f}", width=12, 
                        font=('Segoe UI', 10, 'bold'),
                        bg=flow_color).grid(row=0, column=3, padx=5, pady=3)
            
        except Exception as e:
            tk.Label(flow_content, text=f"Error loading cash flow: {str(e)}", 
                    fg='red', bg='#ffffff').pack()
    
    def export_report_pdf(self, from_date, to_date, report_type):
        """Export report to PDF format"""
        try:
            if not PDF_AVAILABLE:
                messagebox.showerror("Error", "PDF export requires reportlab library.\nInstall it using: pip install reportlab")
                return
            
            # Ask user for file location
            file_path = filedialog.asksaveasfilename(
                defaultextension='.pdf',
                filetypes=[('PDF files', '*.pdf'), ('All files', '*.*')],
                initialfile=f'{report_type}_Report_{from_date}_to_{to_date}.pdf'
            )
            
            if not file_path:
                return
            
            # Create PDF based on report type
            if report_type == 'income_expense':
                self._export_income_expense_pdf(file_path, from_date, to_date)
            elif report_type == 'income_analysis':
                self._export_income_analysis_pdf(file_path, from_date, to_date)
            elif report_type == 'expense_analysis':
                self._export_expense_analysis_pdf(file_path, from_date, to_date)
            elif report_type == 'category':
                self._export_category_pdf(file_path, from_date, to_date)
            elif report_type == 'cashflow':
                self._export_cashflow_pdf(file_path, from_date, to_date)
            else:
                # Generic export for other report types
                self._export_generic_pdf(file_path, from_date, to_date, report_type)
            
            messagebox.showinfo("Success", f"Report exported successfully to:\n{file_path}")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to export PDF: {str(e)}")
    
    def _export_income_expense_pdf(self, file_path, from_date, to_date):
        """Export Income & Expense report to PDF"""
        doc = SimpleDocTemplate(file_path, pagesize=letter)
        elements = []
        styles = getSampleStyleSheet()
        
        # Title
        title_style = ParagraphStyle(
            'CustomTitle',
            parent=styles['Heading1'],
            fontSize=20,
            textColor=colors.HexColor('#2c3e50'),
            spaceAfter=30,
            alignment=1
        )
        
        elements.append(Paragraph("Income & Expense Report", title_style))
        elements.append(Paragraph(f"Period: {from_date} to {to_date}", styles['Normal']))
        elements.append(Spacer(1, 20))
        
        # Get summary data
        self.cursor.execute('''
            SELECT 
                SUM(CASE WHEN transaction_type = 'income' THEN amount ELSE 0 END) as total_income,
                SUM(CASE WHEN transaction_type = 'expense' THEN amount ELSE 0 END) as total_expense
            FROM financial_transactions 
            WHERE transaction_date BETWEEN ? AND ?
        ''', (from_date, to_date))
        
        totals = self.cursor.fetchone()
        total_income = totals[0] or 0
        total_expense = totals[1] or 0
        net_profit = total_income - total_expense
        
        # Summary table
        summary_data = [
            ['Metric', 'Amount (GHS)'],
            ['Total Income', f'{total_income:,.2f}'],
            ['Total Expenses', f'{total_expense:,.2f}'],
            ['Net Profit/Loss', f'{net_profit:,.2f}']
        ]
        
        summary_table = Table(summary_data, colWidths=[3*inch, 2*inch])
        summary_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#34495e')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('ALIGN', (1, 0), (1, -1), 'RIGHT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('GRID', (0, 0), (-1, -1), 1, colors.grey),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f8f9fa')]),
        ]))
        elements.append(summary_table)
        elements.append(Spacer(1, 30))
        
        # Transaction details
        elements.append(Paragraph("Transaction Details", styles['Heading2']))
        elements.append(Spacer(1, 10))
        
        self.cursor.execute('''
            SELECT ft.transaction_date, ft.transaction_type, fc.category_name, 
                   ft.amount, ft.description
            FROM financial_transactions ft
            JOIN financial_categories fc ON ft.category_id = fc.id
            WHERE ft.transaction_date BETWEEN ? AND ?
            ORDER BY ft.transaction_date DESC
            LIMIT 50
        ''', (from_date, to_date))
        
        transactions = self.cursor.fetchall()
        
        trans_data = [['Date', 'Type', 'Category', 'Amount', 'Description']]
        for trans in transactions:
            trans_data.append([
                trans[0],
                trans[1].title(),
                trans[2],
                f'GHS {trans[3]:,.2f}',
                trans[4][:30] + '...' if len(trans[4]) > 30 else trans[4]
            ])
        
        trans_table = Table(trans_data, colWidths=[1*inch, 0.8*inch, 1.5*inch, 1.2*inch, 2*inch])
        trans_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#3498db')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('ALIGN', (3, 0), (3, -1), 'RIGHT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 10),
            ('FONTSIZE', (0, 1), (-1, -1), 8),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f8f9fa')]),
        ]))
        elements.append(trans_table)
        
        doc.build(elements)
    
    def _export_income_analysis_pdf(self, file_path, from_date, to_date):
        """Export Income Analysis to PDF"""
        doc = SimpleDocTemplate(file_path, pagesize=letter)
        elements = []
        styles = getSampleStyleSheet()
        
        # Title
        title_style = ParagraphStyle('CustomTitle', parent=styles['Heading1'], fontSize=20, 
                                     textColor=colors.HexColor('#27ae60'), spaceAfter=30, alignment=1)
        
        elements.append(Paragraph("Income Analysis Report", title_style))
        elements.append(Paragraph(f"Period: {from_date} to {to_date}", styles['Normal']))
        elements.append(Spacer(1, 20))
        
        # Get income by category
        self.cursor.execute('''
            SELECT fc.category_name, SUM(ft.amount) as total_amount, COUNT(ft.id) as count
            FROM financial_transactions ft
            JOIN financial_categories fc ON ft.category_id = fc.id
            WHERE ft.transaction_type = 'income'
            AND ft.transaction_date BETWEEN ? AND ?
            GROUP BY fc.id, fc.category_name
            ORDER BY total_amount DESC
        ''', (from_date, to_date))
        
        income_categories = self.cursor.fetchall()
        total_income = sum(amount for _, amount, _ in income_categories)
        
        # Category breakdown
        elements.append(Paragraph("Income by Category", styles['Heading2']))
        elements.append(Spacer(1, 10))
        
        cat_data = [['Category', 'Amount (GHS)', 'Transactions', '% of Total']]
        for cat_name, amount, count in income_categories:
            percentage = (amount / total_income * 100) if total_income > 0 else 0
            cat_data.append([cat_name, f'{amount:,.2f}', str(count), f'{percentage:.1f}%'])
        
        cat_data.append(['', '', '', ''])
        cat_data.append(['TOTAL', f'{total_income:,.2f}', '', '100%'])
        
        cat_table = Table(cat_data, colWidths=[2.5*inch, 1.5*inch, 1.2*inch, 1.3*inch])
        cat_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#27ae60')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (0, -1), 'LEFT'),
            ('ALIGN', (1, 0), (-1, -1), 'RIGHT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
            ('BACKGROUND', (0, -1), (-1, -1), colors.HexColor('#d5f4e6')),
            ('GRID', (0, 0), (-1, -1), 1, colors.grey),
            ('ROWBACKGROUNDS', (0, 1), (-1, -2), [colors.white, colors.HexColor('#f8f9fa')]),
        ]))
        elements.append(cat_table)
        
        doc.build(elements)
    
    def _export_expense_analysis_pdf(self, file_path, from_date, to_date):
        """Export Expense Analysis to PDF (using existing implementation)"""
        # This can reuse the expense analysis export logic from export_expense_analysis_pdf
        # For now, create a similar structure
        doc = SimpleDocTemplate(file_path, pagesize=letter)
        elements = []
        styles = getSampleStyleSheet()
        
        title_style = ParagraphStyle('CustomTitle', parent=styles['Heading1'], fontSize=20, 
                                     textColor=colors.HexColor('#e74c3c'), spaceAfter=30, alignment=1)
        
        elements.append(Paragraph("Expense Analysis Report", title_style))
        elements.append(Paragraph(f"Period: {from_date} to {to_date}", styles['Normal']))
        elements.append(Spacer(1, 20))
        
        # Get expense data
        self.cursor.execute('''
            SELECT fc.category_name, SUM(ft.amount) as total_amount, COUNT(ft.id) as count
            FROM financial_transactions ft
            JOIN financial_categories fc ON ft.category_id = fc.id
            WHERE ft.transaction_type = 'expense'
            AND ft.transaction_date BETWEEN ? AND ?
            GROUP BY fc.id, fc.category_name
            ORDER BY total_amount DESC
        ''', (from_date, to_date))
        
        expense_categories = self.cursor.fetchall()
        total_expenses = sum(amount for _, amount, _ in expense_categories)
        
        elements.append(Paragraph("Expense by Category", styles['Heading2']))
        elements.append(Spacer(1, 10))
        
        exp_data = [['Category', 'Amount (GHS)', 'Transactions', '% of Total']]
        for cat_name, amount, count in expense_categories:
            percentage = (amount / total_expenses * 100) if total_expenses > 0 else 0
            exp_data.append([cat_name, f'{amount:,.2f}', str(count), f'{percentage:.1f}%'])
        
        exp_data.append(['', '', '', ''])
        exp_data.append(['TOTAL', f'{total_expenses:,.2f}', '', '100%'])
        
        exp_table = Table(exp_data, colWidths=[2.5*inch, 1.5*inch, 1.2*inch, 1.3*inch])
        exp_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#e74c3c')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (0, -1), 'LEFT'),
            ('ALIGN', (1, 0), (-1, -1), 'RIGHT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
            ('BACKGROUND', (0, -1), (-1, -1), colors.HexColor('#fadbd8')),
            ('GRID', (0, 0), (-1, -1), 1, colors.grey),
            ('ROWBACKGROUNDS', (0, 1), (-1, -2), [colors.white, colors.HexColor('#f8f9fa')]),
        ]))
        elements.append(exp_table)
        
        doc.build(elements)
    
    def _export_category_pdf(self, file_path, from_date, to_date):
        """Export Category Breakdown to PDF"""
        doc = SimpleDocTemplate(file_path, pagesize=letter)
        elements = []
        styles = getSampleStyleSheet()
        
        title_style = ParagraphStyle('CustomTitle', parent=styles['Heading1'], fontSize=20, 
                                     textColor=colors.HexColor('#9b59b6'), spaceAfter=30, alignment=1)
        
        elements.append(Paragraph("Category Breakdown Report", title_style))
        elements.append(Paragraph(f"Period: {from_date} to {to_date}", styles['Normal']))
        elements.append(Spacer(1, 20))
        
        # All categories with both income and expense
        self.cursor.execute('''
            SELECT fc.category_name, fc.category_type,
                   SUM(ft.amount) as total_amount, COUNT(ft.id) as count
            FROM financial_transactions ft
            JOIN financial_categories fc ON ft.category_id = fc.id
            WHERE ft.transaction_date BETWEEN ? AND ?
            GROUP BY fc.id, fc.category_name, fc.category_type
            ORDER BY fc.category_type, total_amount DESC
        ''', (from_date, to_date))
        
        categories = self.cursor.fetchall()
        
        cat_data = [['Category', 'Type', 'Amount (GHS)', 'Transactions']]
        for cat_name, cat_type, amount, count in categories:
            cat_data.append([cat_name, cat_type.title(), f'{amount:,.2f}', str(count)])
        
        cat_table = Table(cat_data, colWidths=[2.5*inch, 1.2*inch, 1.5*inch, 1.3*inch])
        cat_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#9b59b6')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (1, -1), 'LEFT'),
            ('ALIGN', (2, 0), (-1, -1), 'RIGHT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('GRID', (0, 0), (-1, -1), 1, colors.grey),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f8f9fa')]),
        ]))
        elements.append(cat_table)
        
        doc.build(elements)
    
    def _export_cashflow_pdf(self, file_path, from_date, to_date):
        """Export Cash Flow report to PDF"""
        doc = SimpleDocTemplate(file_path, pagesize=letter)
        elements = []
        styles = getSampleStyleSheet()
        
        title_style = ParagraphStyle('CustomTitle', parent=styles['Heading1'], fontSize=20, 
                                     textColor=colors.HexColor('#16a085'), spaceAfter=30, alignment=1)
        
        elements.append(Paragraph("Cash Flow Report", title_style))
        elements.append(Paragraph(f"Period: {from_date} to {to_date}", styles['Normal']))
        elements.append(Spacer(1, 20))
        
        # Monthly cash flow
        self.cursor.execute('''
            SELECT strftime('%Y-%m', transaction_date) as month,
                   SUM(CASE WHEN transaction_type = 'income' THEN amount ELSE 0 END) as income,
                   SUM(CASE WHEN transaction_type = 'expense' THEN amount ELSE 0 END) as expense
            FROM financial_transactions
            WHERE transaction_date BETWEEN ? AND ?
            GROUP BY month
            ORDER BY month
        ''', (from_date, to_date))
        
        monthly_data = self.cursor.fetchall()
        
        flow_data = [['Month', 'Income (GHS)', 'Expense (GHS)', 'Net Flow (GHS)']]
        for month, income, expense in monthly_data:
            net_flow = income - expense
            flow_data.append([month, f'{income:,.2f}', f'{expense:,.2f}', f'{net_flow:,.2f}'])
        
        flow_table = Table(flow_data, colWidths=[1.5*inch, 1.5*inch, 1.5*inch, 1.5*inch])
        flow_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#16a085')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (0, -1), 'LEFT'),
            ('ALIGN', (1, 0), (-1, -1), 'RIGHT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('GRID', (0, 0), (-1, -1), 1, colors.grey),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f8f9fa')]),
        ]))
        elements.append(flow_table)
        
        doc.build(elements)
    
    def _export_generic_pdf(self, file_path, from_date, to_date, report_type):
        """Generic PDF export for other report types"""
        doc = SimpleDocTemplate(file_path, pagesize=letter)
        elements = []
        styles = getSampleStyleSheet()
        
        elements.append(Paragraph(f"{report_type.replace('_', ' ').title()} Report", styles['Title']))
        elements.append(Paragraph(f"Period: {from_date} to {to_date}", styles['Normal']))
        elements.append(Spacer(1, 20))
        elements.append(Paragraph("Report data exported successfully.", styles['Normal']))
        
        doc.build(elements)
    
    def export_report_csv(self, from_date, to_date, report_type):
        """Export report to CSV format"""
        try:
            # Ask user for save location
            file_path = filedialog.asksaveasfilename(
                defaultextension=".csv",
                filetypes=[("CSV files", "*.csv"), ("All files", "*.*")],
                title="Save Financial Report"
            )
            
            if file_path:
                # Get transaction data for the period
                self.cursor.execute('''
                    SELECT ft.transaction_date, ft.transaction_type, fc.category_name, 
                           ft.amount, ft.description, ft.payment_method, ft.reference_number
                    FROM financial_transactions ft
                    JOIN financial_categories fc ON ft.category_id = fc.id
                    WHERE DATE(ft.transaction_date) BETWEEN ? AND ?
                    ORDER BY ft.transaction_date DESC
                ''', (from_date, to_date))
                
                transactions = self.cursor.fetchall()
                
                # Write to CSV file
                import csv
                with open(file_path, 'w', newline='', encoding='utf-8') as csvfile:
                    writer = csv.writer(csvfile)
                    
                    # Write header
                    writer.writerow(['Date', 'Type', 'Category', 'Amount (GHS)', 'Description', 'Payment Method', 'Reference'])
                    
                    # Write data
                    for transaction in transactions:
                        writer.writerow([
                            transaction[0],
                            transaction[1].title(),
                            transaction[2],
                            f"{transaction[3]:.2f}",
                            transaction[4],
                            transaction[5],
                            transaction[6] or ''
                        ])
                
                messagebox.showinfo("Success", f"Report exported successfully to:\n{file_path}")
                
        except Exception as e:
            messagebox.showerror("Error", f"Failed to export report: {str(e)}")
    
    # Dashboard comparison methods (placeholders)
    def show_monthly_comparison(self):
        """Show monthly comparison analysis"""
        messagebox.showinfo("Analysis", "Monthly comparison analysis - Feature coming soon!")
    
    def show_quarterly_comparison(self):
        """Show quarterly comparison analysis"""
        messagebox.showinfo("Analysis", "Quarterly comparison analysis - Feature coming soon!")
    
    def show_yearly_comparison(self):
        """Show yearly comparison analysis"""
        messagebox.showinfo("Analysis", "Yearly comparison analysis - Feature coming soon!")
    
    def show_weekly_trends(self):
        """Show weekly trends analysis"""
        messagebox.showinfo("Analysis", "Weekly trends analysis - Feature coming soon!")
    
    def refresh_dashboard_data(self, dashboard_content):
        """Refresh dashboard data"""
        try:
            # Clear existing content
            for widget in dashboard_content.winfo_children():
                widget.destroy()
            
            # Recreate dashboard header
            header_frame = tk.Frame(dashboard_content, bg='#2c3e50')
            header_frame.pack(fill=tk.X, pady=(0, 20))
            
            header_content = tk.Frame(header_frame, bg='#2c3e50')
            header_content.pack(fill=tk.X, padx=30, pady=20)
            
            # Title and refresh button
            title_row = tk.Frame(header_content, bg='#2c3e50')
            title_row.pack(fill=tk.X)
            
            tk.Label(title_row, text="📊 Financial Dashboard & Analytics", 
                    font=('Segoe UI', 24, 'bold'), fg='white', bg='#2c3e50').pack(side=tk.LEFT)
            
            refresh_dash_btn = tk.Button(title_row, text="🔄 Refresh Data", 
                                       command=lambda: self.refresh_dashboard_data(dashboard_content),
                                       font=('Segoe UI', 10, 'bold'), bg='#3498db', fg='white',
                                       relief='flat', bd=0, padx=15, pady=8, cursor='hand2')
            refresh_dash_btn.pack(side=tk.RIGHT)
            
            tk.Label(header_content, text="Real-time financial insights and comprehensive reporting", 
                    font=('Segoe UI', 12), fg='#bdc3c7', bg='#2c3e50').pack(anchor='w', pady=(8, 0))
            
            # Recreate dashboard sections with fresh data
            self.create_financial_overview_section(dashboard_content)
            self.create_period_comparison_section(dashboard_content)
            self.create_category_analysis_section(dashboard_content)
            self.create_recent_activities_section(dashboard_content)
            
            messagebox.showinfo("Refreshed", "Dashboard data refreshed successfully!")
            
        except Exception as e:
            messagebox.showerror("Error", f"Failed to refresh dashboard: {str(e)}")
    
    def show_settings(self):
        """Admin-only settings panel with tabs for different configurations"""
        self.clear_content_frame()
        
        # Create scrollable main container
        scrollable_frame = ScrollableFrame(self.content_frame, bg='#f8f9fa')
        scrollable_frame.pack(fill='both', expand=True)
        main_frame = scrollable_frame.scrollable_frame
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#34495e', height=120)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        header_content = tk.Frame(header_frame, bg='#34495e')
        header_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        tk.Label(header_content, text="⚙️ System Settings", 
                font=('Segoe UI', 24, 'bold'), fg='white', bg='#34495e').pack(anchor='w')
        tk.Label(header_content, text="Admin Only: Configure system preferences and manage data", 
                font=('Segoe UI', 12), fg='#ecf0f1', bg='#34495e').pack(anchor='w', pady=(5, 0))
        
        # Content area with tabs
        content_area = tk.Frame(main_frame, bg='#f8f9fa')
        content_area.pack(fill=tk.BOTH, expand=True, padx=40, pady=30)
        
        # Create notebook for tabs
        notebook = ttk.Notebook(content_area)
        notebook.pack(fill=tk.BOTH, expand=True)
        
        # Tab 1: Data Management
        data_tab = tk.Frame(notebook, bg='white')
        notebook.add(data_tab, text="🧹 Data Management")
        self.create_data_management_tab(data_tab)
        
        # Tab 2: Currency & Finance
        finance_tab = tk.Frame(notebook, bg='white')
        notebook.add(finance_tab, text="💳 Currency & Finance")
        self.create_currency_finance_tab(finance_tab)
        
        # Tab 3: User Management
        user_tab = tk.Frame(notebook, bg='white')
        notebook.add(user_tab, text="👤 User Management")
        self.create_user_management_tab(user_tab)
        
        # Tab 4: Database Management
        db_tab = tk.Frame(notebook, bg='white')
        notebook.add(db_tab, text="💾 Database")
        self.create_database_management_tab(db_tab)
        
        # Tab 5: Backup & Restore
        backup_tab = tk.Frame(notebook, bg='white')
        notebook.add(backup_tab, text="🔄 Backup & Restore")
        self.create_backup_restore_tab(backup_tab)
    
    def create_data_management_tab(self, parent):
        """Create data management tab content"""
        # Create scrollable frame
        scrollable = ScrollableFrame(parent, bg='white')
        scrollable.pack(fill='both', expand=True, padx=20, pady=20)
        content = scrollable.scrollable_frame
        
        # Warning box
        warning_frame = tk.Frame(content, bg='#fff3cd', relief=tk.SOLID, bd=2)
        warning_frame.pack(fill=tk.X, pady=(0, 20))
        
        warning_content = tk.Frame(warning_frame, bg='#fff3cd')
        warning_content.pack(fill=tk.X, padx=20, pady=15)
        
        tk.Label(warning_content, text="⚠️ WARNING", 
                font=('Segoe UI', 12, 'bold'), fg='#856404', bg='#fff3cd').pack(anchor='w')
        tk.Label(warning_content, text="These operations cannot be undone. Please backup your database before clearing data.", 
                font=('Segoe UI', 10), fg='#856404', bg='#fff3cd').pack(anchor='w', pady=(5, 0))
        
        # Clear options
        clear_frame = tk.LabelFrame(content, text="Clear Data Options", 
                                   font=('Segoe UI', 12, 'bold'), bg='white', fg='#2c3e50')
        clear_frame.pack(fill=tk.X, pady=(0, 20))
        
        clear_content = tk.Frame(clear_frame, bg='white')
        clear_content.pack(fill=tk.X, padx=20, pady=15)
        
        # Option 1: Clear Students
        self.create_clear_option(clear_content, 
            "Clear All Students", 
            "Remove all student records (includes attendance, fees, and grades)",
            self.clear_all_students)
        
        # Option 2: Clear Attendance
        self.create_clear_option(clear_content,
            "Clear All Attendance",
            "Remove all attendance records only",
            self.clear_all_attendance)
        
        # Option 3: Clear Fees
        self.create_clear_option(clear_content,
            "Clear All Fees",
            "Remove all fee records only",
            self.clear_all_fees)
        
        # Option 4: Clear Grades
        self.create_clear_option(clear_content,
            "Clear All Grades",
            "Remove all grade records only",
            self.clear_all_grades)
        
        # Option 5: Clear All Test Data
        danger_frame = tk.Frame(clear_content, bg='#f8d7da', relief=tk.SOLID, bd=2)
        danger_frame.pack(fill=tk.X, pady=(10, 0))
        
        danger_content = tk.Frame(danger_frame, bg='#f8d7da')
        danger_content.pack(fill=tk.X, padx=15, pady=12)
        
        tk.Label(danger_content, text="⚠️ DANGER ZONE", 
                font=('Segoe UI', 11, 'bold'), fg='#721c24', bg='#f8d7da').pack(anchor='w')
        tk.Label(danger_content, text="Clear ALL test data (keeps only users and class structure)", 
                font=('Segoe UI', 10), fg='#721c24', bg='#f8d7da').pack(anchor='w', pady=(3, 8))
        
        tk.Button(danger_content, text="Clear All Test Data", 
                 command=self.clear_all_test_data,
                 bg='#dc3545', fg='white', font=('Segoe UI', 10, 'bold'),
                 relief=tk.FLAT, cursor='hand2', padx=20, pady=8).pack(anchor='w')
    
    def create_clear_option(self, parent, title, description, command):
        """Helper to create a clear data option"""
        option_frame = tk.Frame(parent, bg='white')
        option_frame.pack(fill=tk.X, pady=(0, 10))
        
        tk.Label(option_frame, text=title, 
                font=('Segoe UI', 11, 'bold'), fg='#2c3e50', bg='white').pack(anchor='w')
        tk.Label(option_frame, text=description, 
                font=('Segoe UI', 9), fg='#7f8c8d', bg='white').pack(anchor='w', pady=(2, 5))
        
        tk.Button(option_frame, text=f"Clear {title.split()[-1]}", 
                 command=command,
                 bg='#e67e22', fg='white', font=('Segoe UI', 9, 'bold'),
                 relief=tk.FLAT, cursor='hand2', padx=15, pady=5).pack(anchor='w')
    
    def create_currency_finance_tab(self, parent):
        """Create currency and finance categories management tab"""
        # Create scrollable frame
        scrollable = ScrollableFrame(parent, bg='white')
        scrollable.pack(fill='both', expand=True, padx=20, pady=20)
        content = scrollable.scrollable_frame
        
        # Currency Settings Section
        currency_frame = tk.LabelFrame(content, text="💳 Currency Settings", 
                                      font=('Segoe UI', 12, 'bold'), bg='white', fg='#2c3e50')
        currency_frame.pack(fill=tk.X, pady=(0, 20))
        
        currency_content = tk.Frame(currency_frame, bg='white')
        currency_content.pack(fill=tk.X, padx=20, pady=15)
        
        # Current currency display
        tk.Label(currency_content, text="Default Currency:", 
                font=('Segoe UI', 11, 'bold'), bg='white', fg='#34495e').grid(row=0, column=0, sticky='w', pady=5)
        
        # Get current currency from database
        try:
            self.cursor.execute("SELECT value FROM system_settings WHERE key = 'currency'")
            result = self.cursor.fetchone()
            current_currency = result[0] if result else "GHS"
        except:
            current_currency = "GHS"
        
        self.currency_var = tk.StringVar(value=current_currency)
        
        currency_options = [
            "GHS (Ghanaian Cedi)",
            "USD (US Dollar)",
            "EUR (Euro)",
            "GBP (British Pound)",
            "NGN (Nigerian Naira)",
            "ZAR (South African Rand)",
            "KES (Kenyan Shilling)",
            "UGX (Ugandan Shilling)"
        ]
        
        currency_combo = ttk.Combobox(currency_content, textvariable=self.currency_var, 
                                     values=currency_options, state='readonly', width=30)
        currency_combo.grid(row=0, column=1, sticky='w', padx=(10, 20), pady=5)
        
        tk.Button(currency_content, text="Save Currency", 
                 command=self.save_currency_setting,
                 bg='#27ae60', fg='white', font=('Segoe UI', 10, 'bold'),
                 relief=tk.FLAT, cursor='hand2', padx=20, pady=8).grid(row=0, column=2, sticky='w', pady=5)
        
        # Finance Categories Section
        categories_frame = tk.LabelFrame(content, text="💰 Financial Categories", 
                                        font=('Segoe UI', 12, 'bold'), bg='white', fg='#2c3e50')
        categories_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 10))
        
        categories_content = tk.Frame(categories_frame, bg='white')
        categories_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=15)
        
        # Categories list
        list_frame = tk.Frame(categories_content, bg='white')
        list_frame.pack(fill=tk.BOTH, expand=True, side=tk.LEFT)
        
        tk.Label(list_frame, text="Income Categories:", 
                font=('Segoe UI', 10, 'bold'), bg='white', fg='#27ae60').pack(anchor='w', pady=(0, 5))
        
        income_frame = tk.Frame(list_frame, bg='white')
        income_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 15))
        
        self.income_categories_listbox = tk.Listbox(income_frame, height=6, font=('Segoe UI', 10))
        income_scroll = tk.Scrollbar(income_frame, orient=tk.VERTICAL, command=self.income_categories_listbox.yview)
        self.income_categories_listbox.config(yscrollcommand=income_scroll.set)
        self.income_categories_listbox.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        income_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        
        tk.Label(list_frame, text="Expense Categories:", 
                font=('Segoe UI', 10, 'bold'), bg='white', fg='#e74c3c').pack(anchor='w', pady=(0, 5))
        
        expense_frame = tk.Frame(list_frame, bg='white')
        expense_frame.pack(fill=tk.BOTH, expand=True)
        
        self.expense_categories_listbox = tk.Listbox(expense_frame, height=6, font=('Segoe UI', 10))
        expense_scroll = tk.Scrollbar(expense_frame, orient=tk.VERTICAL, command=self.expense_categories_listbox.yview)
        self.expense_categories_listbox.config(yscrollcommand=expense_scroll.set)
        self.expense_categories_listbox.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        expense_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        
        # Add/Delete categories controls
        controls_frame = tk.Frame(categories_content, bg='white')
        controls_frame.pack(fill=tk.Y, side=tk.RIGHT, padx=(20, 0))
        
        tk.Label(controls_frame, text="Add New Category", 
                font=('Segoe UI', 10, 'bold'), bg='white', fg='#34495e').pack(anchor='w', pady=(0, 10))
        
        tk.Label(controls_frame, text="Category Name:", 
                font=('Segoe UI', 9), bg='white', fg='#34495e').pack(anchor='w')
        self.new_category_name = tk.Entry(controls_frame, width=25, font=('Segoe UI', 10))
        self.new_category_name.pack(anchor='w', pady=(3, 10))
        
        tk.Label(controls_frame, text="Type:", 
                font=('Segoe UI', 9), bg='white', fg='#34495e').pack(anchor='w')
        self.category_type_var = tk.StringVar(value="Income")
        tk.Radiobutton(controls_frame, text="Income", variable=self.category_type_var, 
                      value="Income", bg='white', font=('Segoe UI', 9)).pack(anchor='w')
        tk.Radiobutton(controls_frame, text="Expense", variable=self.category_type_var, 
                      value="Expense", bg='white', font=('Segoe UI', 9)).pack(anchor='w', pady=(0, 10))
        
        tk.Button(controls_frame, text="Add Category", 
                 command=self.add_financial_category,
                 bg='#3498db', fg='white', font=('Segoe UI', 9, 'bold'),
                 relief=tk.FLAT, cursor='hand2', padx=15, pady=6).pack(fill=tk.X, pady=(0, 15))
        
        tk.Button(controls_frame, text="Delete Selected", 
                 command=self.delete_financial_category,
                 bg='#e74c3c', fg='white', font=('Segoe UI', 9, 'bold'),
                 relief=tk.FLAT, cursor='hand2', padx=15, pady=6).pack(fill=tk.X)
        
        # Load categories
        self.load_financial_categories()
    
    def create_user_management_tab(self, parent):
        """Embed the existing user management interface"""
        # Simply call the existing show_user_management but render in this parent
        # We'll create a frame and pack the user management content there
        self.user_management_container = parent
        
        # Create scrollable frame
        scrollable = ScrollableFrame(parent, bg='white')
        scrollable.pack(fill='both', expand=True)
        content = scrollable.scrollable_frame
        
        tk.Label(content, text="Use the 'User Management' section to manage users.", 
                font=('Segoe UI', 11), bg='white', fg='#7f8c8d', 
                wraplength=600).pack(pady=20, padx=20)
        
        tk.Button(content, text="Open User Management", 
                 command=self.show_user_management,
                 bg='#3498db', fg='white', font=('Segoe UI', 11, 'bold'),
                 relief=tk.FLAT, cursor='hand2', padx=30, pady=12).pack(pady=10)
    
    def create_database_management_tab(self, parent):
        """Embed the existing database view"""
        scrollable = ScrollableFrame(parent, bg='white')
        scrollable.pack(fill='both', expand=True)
        content = scrollable.scrollable_frame
        
        tk.Label(content, text="Use the 'Database View' to inspect database tables.", 
                font=('Segoe UI', 11), bg='white', fg='#7f8c8d', 
                wraplength=600).pack(pady=20, padx=20)
        
        tk.Button(content, text="Open Database View", 
                 command=self.show_database_view,
                 bg='#3498db', fg='white', font=('Segoe UI', 11, 'bold'),
                 relief=tk.FLAT, cursor='hand2', padx=30, pady=12).pack(pady=10)
    
    def create_backup_restore_tab(self, parent):
        """Embed the existing backup & restore interface"""
        scrollable = ScrollableFrame(parent, bg='white')
        scrollable.pack(fill='both', expand=True)
        content = scrollable.scrollable_frame
        
        tk.Label(content, text="Use 'Backup & Restore' to manage database backups.", 
                font=('Segoe UI', 11), bg='white', fg='#7f8c8d', 
                wraplength=600).pack(pady=20, padx=20)
        
        tk.Button(content, text="Open Backup & Restore", 
                 command=self.show_backup_restore_menu,
                 bg='#3498db', fg='white', font=('Segoe UI', 11, 'bold'),
                 relief=tk.FLAT, cursor='hand2', padx=30, pady=12).pack(pady=10)
    
    def save_currency_setting(self):
        """Save currency setting to database"""
        try:
            # Extract currency code (first 3 characters before space)
            currency_full = self.currency_var.get()
            currency_code = currency_full.split()[0] if currency_full else "GHS"
            
            # Create system_settings table if not exists
            self.cursor.execute('''
                CREATE TABLE IF NOT EXISTS system_settings (
                    key TEXT PRIMARY KEY,
                    value TEXT,
                    updated_date DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # Insert or update currency setting
            self.cursor.execute('''
                INSERT OR REPLACE INTO system_settings (key, value, updated_date)
                VALUES ('currency', ?, CURRENT_TIMESTAMP)
            ''', (currency_code,))
            
            self.conn.commit()
            messagebox.showinfo("Success", f"Currency set to {currency_code}")
        except Exception as e:
            messagebox.showerror("Error", f"Failed to save currency: {str(e)}")
    
    def load_financial_categories(self):
        """Load financial categories from database"""
        try:
            # Clear existing items
            self.income_categories_listbox.delete(0, tk.END)
            self.expense_categories_listbox.delete(0, tk.END)
            
            # Load income categories
            self.cursor.execute("SELECT category_name FROM financial_categories WHERE category_type = 'Income' ORDER BY category_name")
            for row in self.cursor.fetchall():
                self.income_categories_listbox.insert(tk.END, row[0])
            
            # Load expense categories
            self.cursor.execute("SELECT category_name FROM financial_categories WHERE category_type = 'Expense' ORDER BY category_name")
            for row in self.cursor.fetchall():
                self.expense_categories_listbox.insert(tk.END, row[0])
        except Exception as e:
            print(f"Error loading categories: {e}")
    
    def add_financial_category(self):
        """Add a new financial category"""
        category_name = self.new_category_name.get().strip()
        category_type = self.category_type_var.get()
        
        if not category_name:
            messagebox.showerror("Error", "Please enter a category name")
            return
        
        try:
            self.cursor.execute('''
                INSERT INTO financial_categories (category_name, category_type)
                VALUES (?, ?)
            ''', (category_name, category_type))
            
            self.conn.commit()
            messagebox.showinfo("Success", f"Category '{category_name}' added successfully")
            
            # Clear input and reload
            self.new_category_name.delete(0, tk.END)
            self.load_financial_categories()
        except Exception as e:
            messagebox.showerror("Error", f"Failed to add category: {str(e)}")
    
    def delete_financial_category(self):
        """Delete selected financial category"""
        # Check which listbox has selection
        income_selection = self.income_categories_listbox.curselection()
        expense_selection = self.expense_categories_listbox.curselection()
        
        if income_selection:
            category_name = self.income_categories_listbox.get(income_selection[0])
            category_type = "Income"
        elif expense_selection:
            category_name = self.expense_categories_listbox.get(expense_selection[0])
            category_type = "Expense"
        else:
            messagebox.showerror("Error", "Please select a category to delete")
            return
        
        # Confirm deletion
        if not messagebox.askyesno("Confirm", f"Delete category '{category_name}'?"):
            return
        
        try:
            self.cursor.execute('''
                DELETE FROM financial_categories 
                WHERE category_name = ? AND category_type = ?
            ''', (category_name, category_type))
            
            self.conn.commit()
            messagebox.showinfo("Success", f"Category '{category_name}' deleted successfully")
            
            # Reload categories
            self.load_financial_categories()
        except Exception as e:
            messagebox.showerror("Error", f"Failed to delete category: {str(e)}")
    
    def show_data_management(self):
        """Admin-only data management: clear test data"""
        self.clear_content_frame()
        
        # Create scrollable main container
        scrollable_frame = ScrollableFrame(self.content_frame, bg='#f8f9fa')
        scrollable_frame.pack(fill='both', expand=True)
        main_frame = scrollable_frame.scrollable_frame
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#e74c3c', height=120)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        header_content = tk.Frame(header_frame, bg='#e74c3c')
        header_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        tk.Label(header_content, text="🧹 Data Management", 
                font=('Segoe UI', 24, 'bold'), fg='white', bg='#e74c3c').pack(anchor='w')
        tk.Label(header_content, text="Admin Only: Clear test data and manage database records", 
                font=('Segoe UI', 12), fg='#fff', bg='#e74c3c').pack(anchor='w', pady=(5, 0))
        
        # Content area
        content_area = tk.Frame(main_frame, bg='#f8f9fa')
        content_area.pack(fill=tk.BOTH, expand=True, padx=40, pady=30)
        
        # Warning box
        warning_frame = tk.Frame(content_area, bg='#fff3cd', relief=tk.SOLID, bd=2)
        warning_frame.pack(fill=tk.X, pady=(0, 20))
        
        warning_content = tk.Frame(warning_frame, bg='#fff3cd')
        warning_content.pack(fill=tk.X, padx=20, pady=15)
        
        tk.Label(warning_content, text="⚠️ WARNING", 
                font=('Segoe UI', 12, 'bold'), fg='#856404', bg='#fff3cd').pack(anchor='w')
        tk.Label(warning_content, text="These operations cannot be undone. Please backup your database before clearing data.", 
                font=('Segoe UI', 10), fg='#856404', bg='#fff3cd').pack(anchor='w', pady=(5, 0))
        
        # Clear options
        clear_frame = tk.LabelFrame(content_area, text="Clear Data Options", 
                                   font=('Segoe UI', 12, 'bold'), bg='white', fg='#2c3e50')
        clear_frame.pack(fill=tk.X, pady=(0, 20))
        
        options_content = tk.Frame(clear_frame, bg='white')
        options_content.pack(fill=tk.X, padx=20, pady=20)
        
        # Clear all students
        btn_frame1 = tk.Frame(options_content, bg='white')
        btn_frame1.pack(fill=tk.X, pady=10)
        
        tk.Label(btn_frame1, text="Clear All Students", 
                font=('Segoe UI', 11, 'bold'), bg='white').pack(side=tk.LEFT)
        tk.Button(btn_frame1, text="Clear Students", command=self.clear_all_students,
                 font=('Segoe UI', 10, 'bold'), bg='#e74c3c', fg='white',
                 relief=tk.FLAT, padx=20, pady=8, cursor='hand2').pack(side=tk.RIGHT)
        
        tk.Label(options_content, text="Removes all student records (keeps classes and teachers)", 
                font=('Segoe UI', 9), fg='#6c757d', bg='white').pack(anchor='w', padx=(0, 0))
        
        tk.Frame(options_content, bg='#dee2e6', height=1).pack(fill=tk.X, pady=15)
        
        # Clear all attendance
        btn_frame2 = tk.Frame(options_content, bg='white')
        btn_frame2.pack(fill=tk.X, pady=10)
        
        tk.Label(btn_frame2, text="Clear All Attendance Records", 
                font=('Segoe UI', 11, 'bold'), bg='white').pack(side=tk.LEFT)
        tk.Button(btn_frame2, text="Clear Attendance", command=self.clear_all_attendance,
                 font=('Segoe UI', 10, 'bold'), bg='#e74c3c', fg='white',
                 relief=tk.FLAT, padx=20, pady=8, cursor='hand2').pack(side=tk.RIGHT)
        
        tk.Label(options_content, text="Removes all attendance records", 
                font=('Segoe UI', 9), fg='#6c757d', bg='white').pack(anchor='w')
        
        tk.Frame(options_content, bg='#dee2e6', height=1).pack(fill=tk.X, pady=15)
        
        # Clear all fees
        btn_frame3 = tk.Frame(options_content, bg='white')
        btn_frame3.pack(fill=tk.X, pady=10)
        
        tk.Label(btn_frame3, text="Clear All Fee Records", 
                font=('Segoe UI', 11, 'bold'), bg='white').pack(side=tk.LEFT)
        tk.Button(btn_frame3, text="Clear Fees", command=self.clear_all_fees,
                 font=('Segoe UI', 10, 'bold'), bg='#e74c3c', fg='white',
                 relief=tk.FLAT, padx=20, pady=8, cursor='hand2').pack(side=tk.RIGHT)
        
        tk.Label(options_content, text="Removes all fee payment records", 
                font=('Segoe UI', 9), fg='#6c757d', bg='white').pack(anchor='w')
        
        tk.Frame(options_content, bg='#dee2e6', height=1).pack(fill=tk.X, pady=15)
        
        # Clear all grades
        btn_frame4 = tk.Frame(options_content, bg='white')
        btn_frame4.pack(fill=tk.X, pady=10)
        
        tk.Label(btn_frame4, text="Clear All Grades", 
                font=('Segoe UI', 11, 'bold'), bg='white').pack(side=tk.LEFT)
        tk.Button(btn_frame4, text="Clear Grades", command=self.clear_all_grades,
                 font=('Segoe UI', 10, 'bold'), bg='#e74c3c', fg='white',
                 relief=tk.FLAT, padx=20, pady=8, cursor='hand2').pack(side=tk.RIGHT)
        
        tk.Label(options_content, text="Removes all grade records", 
                font=('Segoe UI', 9), fg='#6c757d', bg='white').pack(anchor='w')
        
        tk.Frame(options_content, bg='#dee2e6', height=1).pack(fill=tk.X, pady=15)
        
        # Clear all test data (nuclear option)
        btn_frame5 = tk.Frame(options_content, bg='white')
        btn_frame5.pack(fill=tk.X, pady=10)
        
        tk.Label(btn_frame5, text="Clear ALL Test Data", 
                font=('Segoe UI', 11, 'bold'), bg='white', fg='#dc3545').pack(side=tk.LEFT)
        tk.Button(btn_frame5, text="Clear Everything", command=self.clear_all_test_data,
                 font=('Segoe UI', 10, 'bold'), bg='#dc3545', fg='white',
                 relief=tk.FLAT, padx=20, pady=8, cursor='hand2').pack(side=tk.RIGHT)
        
        tk.Label(options_content, text="⚠️ DANGER: Removes ALL data except users and classes (keeps structure)", 
                font=('Segoe UI', 9, 'bold'), fg='#dc3545', bg='white').pack(anchor='w')
    
    def clear_all_students(self):
        """Clear all student records"""
        if messagebox.askyesno("Confirm", "Delete all student records?\n\nThis will also delete:\n- All attendance records\n- All fee records\n- All grades\n\nThis cannot be undone!"):
            try:
                self.cursor.execute("DELETE FROM attendance")
                self.cursor.execute("DELETE FROM fees")
                self.cursor.execute("DELETE FROM grades")
                self.cursor.execute("DELETE FROM students")
                self.conn.commit()
                messagebox.showinfo("Success", "All student records cleared successfully!")
                self.show_data_management()  # Refresh view
            except Exception as e:
                messagebox.showerror("Error", f"Failed to clear students: {str(e)}")
    
    def clear_all_attendance(self):
        """Clear all attendance records"""
        if messagebox.askyesno("Confirm", "Delete all attendance records?\n\nThis cannot be undone!"):
            try:
                self.cursor.execute("DELETE FROM attendance")
                self.conn.commit()
                messagebox.showinfo("Success", "All attendance records cleared successfully!")
            except Exception as e:
                messagebox.showerror("Error", f"Failed to clear attendance: {str(e)}")
    
    def clear_all_fees(self):
        """Clear all fee records"""
        if messagebox.askyesno("Confirm", "Delete all fee payment records?\n\nThis cannot be undone!"):
            try:
                self.cursor.execute("DELETE FROM fees")
                self.conn.commit()
                messagebox.showinfo("Success", "All fee records cleared successfully!")
            except Exception as e:
                messagebox.showerror("Error", f"Failed to clear fees: {str(e)}")
    
    def clear_all_grades(self):
        """Clear all grade records"""
        if messagebox.askyesno("Confirm", "Delete all grade records?\n\nThis cannot be undone!"):
            try:
                self.cursor.execute("DELETE FROM grades")
                self.conn.commit()
                messagebox.showinfo("Success", "All grade records cleared successfully!")
            except Exception as e:
                messagebox.showerror("Error", f"Failed to clear grades: {str(e)}")
    
    def clear_all_test_data(self):
        """Clear all test data - keep only user accounts"""
        if messagebox.askyesno("FINAL WARNING", "This will delete ALL DATA:\n- All students\n- All teachers\n- All classes\n- All attendance\n- All fees\n- All grades\n- All financial transactions\n\nOnly user accounts will remain.\n\nARE YOU ABSOLUTELY SURE?"):
            try:
                # Temporarily disable foreign key constraints
                self.cursor.execute("PRAGMA foreign_keys = OFF")
                
                # Delete all data in correct order
                self.cursor.execute("DELETE FROM grades")
                self.cursor.execute("DELETE FROM attendance")
                self.cursor.execute("DELETE FROM fees")
                self.cursor.execute("DELETE FROM students")
                self.cursor.execute("DELETE FROM financial_transactions")
                self.cursor.execute("DELETE FROM teachers")
                self.cursor.execute("DELETE FROM classes")
                
                # Re-enable foreign key constraints
                self.cursor.execute("PRAGMA foreign_keys = ON")
                
                self.conn.commit()
                messagebox.showinfo("Success", "All test data cleared successfully!\n\nAll students, teachers, classes, and records have been deleted.\nOnly user accounts remain.\n\nThe system is now ready for real data.")
                self.show_data_management()  # Refresh view
            except Exception as e:
                self.conn.rollback()
                # Re-enable foreign keys even if error occurs
                self.cursor.execute("PRAGMA foreign_keys = ON")
                messagebox.showerror("Error", f"Failed to clear test data: {str(e)}")
    
    def show_backup_restore_menu(self):
        """Show backup and restore options menu"""
        self.clear_content_frame()
        
        # Create scrollable main container
        scrollable_frame = ScrollableFrame(self.content_frame, bg='#f8f9fa')
        scrollable_frame.pack(fill='both', expand=True)
        main_frame = scrollable_frame.scrollable_frame
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#2c3e50', height=120)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        header_content = tk.Frame(header_frame, bg='#2c3e50')
        header_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        tk.Label(header_content, text="💾 Database Backup & Restore", 
                font=('Segoe UI', 24, 'bold'), fg='white', bg='#2c3e50').pack(anchor='w')
        tk.Label(header_content, text="Protect your data with regular backups", 
                font=('Segoe UI', 12), fg='#bdc3c7', bg='#2c3e50').pack(anchor='w', pady=(5, 0))
        
        # Content area
        content_area = tk.Frame(main_frame, bg='#f8f9fa')
        content_area.pack(fill=tk.BOTH, expand=True, padx=40, pady=30)
        
        # Backup Section
        backup_section = tk.LabelFrame(content_area, text="💾 Backup Database", 
                                      font=('Segoe UI', 14, 'bold'), bg='white', 
                                      fg='#2c3e50', relief=tk.RAISED, bd=2)
        backup_section.pack(fill=tk.X, pady=(0, 20))
        
        backup_content = tk.Frame(backup_section, bg='white')
        backup_content.pack(fill=tk.X, padx=20, pady=20)
        
        tk.Label(backup_content, text="Create a backup copy of your entire database", 
                font=('Segoe UI', 11), bg='white', fg='#555').pack(anchor='w', pady=(0, 15))
        
        # Backup options
        backup_options_frame = tk.Frame(backup_content, bg='white')
        backup_options_frame.pack(fill=tk.X, pady=(0, 15))
        
        tk.Button(backup_options_frame, text="💾 Full Database Backup", 
                 command=self.backup_database,
                 font=('Segoe UI', 11, 'bold'), bg='#27ae60', fg='white',
                 relief='flat', bd=0, padx=20, pady=12, cursor='hand2').pack(side=tk.LEFT, padx=(0, 10))
        
        tk.Button(backup_options_frame, text="🚀 Portable Backup (ZIP)", 
                 command=self.create_portable_backup,
                 font=('Segoe UI', 11, 'bold'), bg='#9b59b6', fg='white',
                 relief='flat', bd=0, padx=20, pady=12, cursor='hand2').pack(side=tk.LEFT, padx=(0, 10))
        
        tk.Button(backup_options_frame, text="📊 Export to CSV", 
                 command=self.export_database_to_csv,
                 font=('Segoe UI', 11, 'bold'), bg='#3498db', fg='white',
                 relief='flat', bd=0, padx=20, pady=12, cursor='hand2').pack(side=tk.LEFT)
        
        # Backup info
        backup_info = tk.Frame(backup_content, bg='#e8f5e9', relief=tk.RAISED, bd=1)
        backup_info.pack(fill=tk.X, pady=(10, 0))
        
        tk.Label(backup_info, text="💡 Tip: Regular backups protect against data loss. Backup before major changes!", 
                font=('Segoe UI', 10), bg='#e8f5e9', fg='#2e7d32', 
                wraplength=600, justify=tk.LEFT).pack(padx=15, pady=10)
        
        # Restore Section
        restore_section = tk.LabelFrame(content_area, text="♻️ Restore Database", 
                                       font=('Segoe UI', 14, 'bold'), bg='white', 
                                       fg='#2c3e50', relief=tk.RAISED, bd=2)
        restore_section.pack(fill=tk.X, pady=(0, 20))
        
        restore_content = tk.Frame(restore_section, bg='white')
        restore_content.pack(fill=tk.X, padx=20, pady=20)
        
        tk.Label(restore_content, text="Restore your database from a previous backup", 
                font=('Segoe UI', 11), bg='white', fg='#555').pack(anchor='w', pady=(0, 15))
        
        tk.Button(restore_content, text="♻️ Restore from Backup File", 
                 command=self.restore_database,
                 font=('Segoe UI', 11, 'bold'), bg='#e67e22', fg='white',
                 relief='flat', bd=0, padx=20, pady=12, cursor='hand2').pack(anchor='w')
        
        # Restore warning
        restore_warning = tk.Frame(restore_content, bg='#fff3e0', relief=tk.RAISED, bd=1)
        restore_warning.pack(fill=tk.X, pady=(15, 0))
        
        tk.Label(restore_warning, text="⚠️ Warning: Restoring will replace all current data with the backup!", 
                font=('Segoe UI', 10, 'bold'), bg='#fff3e0', fg='#e65100', 
                wraplength=600, justify=tk.LEFT).pack(padx=15, pady=10)
        
        # Recent Backups Section
        backups_section = tk.LabelFrame(content_area, text="📋 Recent Backups", 
                                       font=('Segoe UI', 14, 'bold'), bg='white', 
                                       fg='#2c3e50', relief=tk.RAISED, bd=2)
        backups_section.pack(fill=tk.BOTH, expand=True)
        
        backups_content = tk.Frame(backups_section, bg='white')
        backups_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # List recent backups
        self.list_recent_backups(backups_content)
    
    def backup_database(self):
        """Create a full backup of the database"""
        try:
            from datetime import datetime
            import shutil
            import os
            
            # Create backups directory if it doesn't exist
            backup_dir = os.path.join(os.path.dirname(__file__), 'database_backups')
            if not os.path.exists(backup_dir):
                os.makedirs(backup_dir)
            
            # Generate backup filename with timestamp
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            backup_filename = f'school_db_backup_{timestamp}.db'
            backup_path = os.path.join(backup_dir, backup_filename)
            
            # Close current connection temporarily
            self.conn.close()
            
            # Copy database file
            db_path = os.path.join(os.path.dirname(__file__), 'database', 'school.db')
            shutil.copy2(db_path, backup_path)
            
            # Reconnect to database
            self.conn = sqlite3.connect(db_path)
            self.cursor = self.conn.cursor()
            
            # Create a backup metadata file
            import json
            metadata = {
                'backup_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'backup_file': backup_filename,
                'app_version': '2.0.3',
                'database_name': 'school_management.db',
                'user': self.current_user.get('username', 'System')
            }
            
            metadata_path = os.path.join(backup_dir, f'{backup_filename}.meta')
            with open(metadata_path, 'w') as f:
                json.dump(metadata, f, indent=2)
            
            # Get file size
            backup_size_kb = os.path.getsize(backup_path) / 1024
            
            messagebox.showinfo("Backup Successful", 
                              f"✓ Database backed up successfully!\n\n"
                              f"Backup file:\n{backup_filename}\n\n"
                              f"Location:\n{backup_dir}\n\n"
                              f"File size: {backup_size_kb:.2f} KB\n\n"
                              f"Backup can be:\n"
                              f"• Restored via the app\n"
                              f"• Transferred to another device\n"
                              f"• Archived for safekeeping")
            
            # Refresh the backup list if we're on that screen
            self.show_backup_restore_menu()
            
        except Exception as e:
            messagebox.showerror("Backup Failed", f"Failed to create backup:\n{str(e)}")
            # Try to reconnect if connection was closed
            try:
                db_path = os.path.join(os.path.dirname(__file__), 'database', 'school.db')
                self.conn = sqlite3.connect(db_path)
                self.cursor = self.conn.cursor()
            except:
                pass
    
    def create_portable_backup(self):
        """Create a portable backup that can be transferred to another device"""
        try:
            from datetime import datetime
            import shutil
            import os
            import json
            import zipfile
            
            # Create backups directory if it doesn't exist
            backup_dir = os.path.join(os.path.dirname(__file__), 'database_backups')
            if not os.path.exists(backup_dir):
                os.makedirs(backup_dir)
            
            # Generate backup filename with timestamp
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            
            # Create a temporary directory for backup contents
            temp_backup_dir = os.path.join(backup_dir, f'portable_backup_{timestamp}')
            if not os.path.exists(temp_backup_dir):
                os.makedirs(temp_backup_dir)
            
            try:
                # Close connection temporarily
                self.conn.close()
                
                # Copy database file
                db_path = os.path.join(os.path.dirname(__file__), 'database', 'school.db')
                shutil.copy2(db_path, os.path.join(temp_backup_dir, 'school.db'))
                
                # Reconnect to database
                self.conn = sqlite3.connect(db_path)
                self.cursor = self.conn.cursor()
                
                # Create backup metadata
                metadata = {
                    'backup_type': 'Portable',
                    'backup_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                    'app_version': '2.0.3',
                    'database_name': 'school_management.db',
                    'created_by': self.current_user.get('username', 'System'),
                    'instructions': [
                        '1. Extract this backup on the target device',
                        '2. Open the SMS application',
                        '3. Go to Admin → Backup & Restore',
                        '4. Click "Restore Database"',
                        '5. Select the school.db file from this backup',
                        '6. Confirm the restoration'
                    ]
                }
                
                # Save metadata
                with open(os.path.join(temp_backup_dir, 'BACKUP_INFO.json'), 'w') as f:
                    json.dump(metadata, f, indent=2)
                
                # Create a README file
                readme = f"""GAYBECK STARKIDS SMS - PORTABLE DATABASE BACKUP

Backup Date: {metadata['backup_date']}
Created By: {metadata['created_by']}
App Version: {metadata['app_version']}

CONTENTS:
- school.db: Database file (main backup)
- BACKUP_INFO.json: Backup metadata
- README.txt: This file

HOW TO RESTORE ON ANOTHER DEVICE:

Step 1: Copy this backup folder to the Gaybeck Starkids SMS installation directory
        on the target device

Step 2: Open the SMS application on the target device

Step 3: Go to Admin → Backup & Restore

Step 4: Click "Restore Database"

Step 5: Select the 'school.db' file from this backup folder

Step 6: Confirm when prompted

IMPORTANT NOTES:
✓ Make a backup of current data before restoring
✓ All current data will be replaced
✓ The restoration cannot be undone without a backup
✓ Ensure both devices have the same app version

For support, contact: support@gaybeckstarkids.edu.gh
"""
                
                with open(os.path.join(temp_backup_dir, 'README.txt'), 'w') as f:
                    f.write(readme)
                
                # Create ZIP file
                zip_filename = f'gaybeck_sms_backup_{timestamp}.zip'
                zip_path = os.path.join(backup_dir, zip_filename)
                
                with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
                    for root, dirs, files in os.walk(temp_backup_dir):
                        for file in files:
                            file_path = os.path.join(root, file)
                            arcname = os.path.relpath(file_path, temp_backup_dir)
                            zipf.write(file_path, arcname)
                
                # Clean up temporary directory
                shutil.rmtree(temp_backup_dir)
                
                # Get file size
                backup_size_mb = os.path.getsize(zip_path) / (1024 * 1024)
                
                messagebox.showinfo("Portable Backup Created", 
                                  f"✓ Portable backup created successfully!\n\n"
                                  f"Filename: {zip_filename}\n"
                                  f"File size: {backup_size_mb:.2f} MB\n\n"
                                  f"Location:\n{backup_dir}\n\n"
                                  f"This backup can be:\n"
                                  f"• Email to another device\n"
                                  f"• Copy via USB drive\n"
                                  f"• Upload to cloud storage\n"
                                  f"• Archived for long-term backup\n\n"
                                  f"The ZIP file contains:\n"
                                  f"• school.db (database)\n"
                                  f"• BACKUP_INFO.json (metadata)\n"
                                  f"• README.txt (instructions)")
                
                # Refresh the backup list
                self.show_backup_restore_menu()
                
            except Exception as e:
                messagebox.showerror("Portable Backup Failed", f"Failed to create portable backup:\n{str(e)}")
                # Try to reconnect if connection was closed
                try:
                    db_path = os.path.join(os.path.dirname(__file__), 'database', 'school.db')
                    self.conn = sqlite3.connect(db_path)
                    self.cursor = self.conn.cursor()
                except:
                    pass
                
        except Exception as e:
            messagebox.showerror("Error", f"Unexpected error: {str(e)}")
    
    def restore_database(self):
        """Restore database from a backup file (supports both .db and .zip)"""
        try:
            from tkinter import filedialog
            import shutil
            import os
            from datetime import datetime
            import zipfile
            
            # Ask for confirmation
            confirm = messagebox.askyesno("Confirm Restore", 
                                         "⚠️ WARNING: This will replace ALL current data!\n\n"
                                         "Are you sure you want to restore from a backup?\n\n"
                                         "It's recommended to create a backup of your current data first.")
            
            if not confirm:
                return
            
            # Select backup file
            backup_file = filedialog.askopenfilename(
                title="Select Backup File",
                initialdir=os.path.join(os.path.dirname(__file__), 'database_backups'),
                filetypes=[("Database files", "*.db"), ("ZIP Portable Backups", "*.zip"), ("All files", "*.*")]
            )
            
            if not backup_file:
                return
            
            # Create a safety backup first
            db_path = os.path.join(os.path.dirname(__file__), 'database', 'school.db')
            safety_backup = os.path.join(os.path.dirname(__file__), 'database_backups', 
                                        f'auto_backup_before_restore_{datetime.now().strftime("%Y%m%d_%H%M%S")}.db')
            
            # Close connection
            self.conn.close()
            
            # Create safety backup
            shutil.copy2(db_path, safety_backup)
            
            # Handle ZIP file
            if backup_file.lower().endswith('.zip'):
                # Extract ZIP backup
                temp_extract_dir = os.path.join(os.path.dirname(__file__), 'database_backups', 'temp_restore')
                if os.path.exists(temp_extract_dir):
                    shutil.rmtree(temp_extract_dir)
                os.makedirs(temp_extract_dir)
                
                with zipfile.ZipFile(backup_file, 'r') as zip_ref:
                    zip_ref.extractall(temp_extract_dir)
                
                # Find school.db in extracted files
                extracted_db = os.path.join(temp_extract_dir, 'school.db')
                if not os.path.exists(extracted_db):
                    raise FileNotFoundError("school.db not found in ZIP backup")
                
                # Restore from extracted backup
                shutil.copy2(extracted_db, db_path)
                
                # Clean up temp directory
                shutil.rmtree(temp_extract_dir)
                
                restore_source = os.path.basename(backup_file)
            else:
                # Restore from direct .db file
                shutil.copy2(backup_file, db_path)
                restore_source = os.path.basename(backup_file)
            
            # Reconnect
            self.conn = sqlite3.connect(db_path)
            self.cursor = self.conn.cursor()
            
            messagebox.showinfo("Restore Successful", 
                              f"✓ Database restored successfully!\n\n"
                              f"Restored from:\n{restore_source}\n\n"
                              f"Safety backup saved:\n{os.path.basename(safety_backup)}\n\n"
                              f"Location: {os.path.dirname(safety_backup)}\n\n"
                              f"Please restart the application for changes to take full effect.")
            
        except Exception as e:
            messagebox.showerror("Restore Failed", f"Failed to restore database:\n{str(e)}")
            # Try to reconnect
            try:
                db_path = os.path.join(os.path.dirname(__file__), 'database', 'school.db')
                self.conn = sqlite3.connect(db_path)
                self.cursor = self.conn.cursor()
            except:
                pass
    
    def export_database_to_csv(self):
        """Export all database tables to CSV files"""
        try:
            from tkinter import filedialog
            from datetime import datetime
            import csv
            import os
            
            # Select directory for export
            export_dir = filedialog.askdirectory(
                title="Select Export Directory",
                initialdir=os.path.dirname(__file__)
            )
            
            if not export_dir:
                return
            
            # Create timestamped folder
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            export_folder = os.path.join(export_dir, f'database_export_{timestamp}')
            os.makedirs(export_folder, exist_ok=True)
            
            # Get all tables
            self.cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
            tables = [row[0] for row in self.cursor.fetchall()]
            
            exported_count = 0
            for table in tables:
                try:
                    # Get table data
                    self.cursor.execute(f"SELECT * FROM {table}")
                    rows = self.cursor.fetchall()
                    
                    # Get column names
                    column_names = [description[0] for description in self.cursor.description]
                    
                    # Write to CSV
                    csv_path = os.path.join(export_folder, f'{table}.csv')
                    with open(csv_path, 'w', newline='', encoding='utf-8') as csvfile:
                        writer = csv.writer(csvfile)
                        writer.writerow(column_names)
                        writer.writerows(rows)
                    
                    exported_count += 1
                except Exception as e:
                    print(f"Error exporting table {table}: {e}")
            
            # Log the export
            self.cursor.execute('''
                INSERT INTO logs (action, user, timestamp, details)
                VALUES (?, ?, ?, ?)
            ''', ('DATABASE_EXPORT', self.current_user.get('username', 'System'), 
                  datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                  f'Database exported to CSV: {exported_count} tables'))
            self.conn.commit()
            
            messagebox.showinfo("Export Successful", 
                              f"Database exported successfully!\n\n"
                              f"Exported {exported_count} tables to:\n{export_folder}")
            
        except Exception as e:
            messagebox.showerror("Export Failed", f"Failed to export database:\n{str(e)}")
    
    def list_recent_backups(self, parent):
        """List recent backup files"""
        try:
            import os
            from datetime import datetime
            
            backup_dir = os.path.join(os.path.dirname(__file__), 'database_backups')
            
            if not os.path.exists(backup_dir):
                tk.Label(parent, text="No backups found", 
                        font=('Segoe UI', 11), bg='white', fg='#999').pack(pady=20)
                return
            
            # Get all backup files
            backups = []
            for filename in os.listdir(backup_dir):
                if filename.endswith('.db'):
                    filepath = os.path.join(backup_dir, filename)
                    size = os.path.getsize(filepath)
                    modified = datetime.fromtimestamp(os.path.getmtime(filepath))
                    backups.append({
                        'name': filename,
                        'path': filepath,
                        'size': size,
                        'date': modified
                    })
            
            # Sort by date (newest first)
            backups.sort(key=lambda x: x['date'], reverse=True)
            
            if not backups:
                tk.Label(parent, text="No backups found", 
                        font=('Segoe UI', 11), bg='white', fg='#999').pack(pady=20)
                return
            
            # Create treeview for backups
            columns = ('Filename', 'Date', 'Size', 'Actions')
            tree_frame = tk.Frame(parent, bg='white')
            tree_frame.pack(fill=tk.BOTH, expand=True)
            
            tree_scroll = tk.Scrollbar(tree_frame)
            tree_scroll.pack(side=tk.RIGHT, fill=tk.Y)
            
            backup_tree = ttk.Treeview(tree_frame, columns=columns, show='headings', 
                                      yscrollcommand=tree_scroll.set, height=8)
            backup_tree.pack(fill=tk.BOTH, expand=True)
            tree_scroll.config(command=backup_tree.yview)
            
            # Configure columns
            backup_tree.heading('Filename', text='Filename')
            backup_tree.heading('Date', text='Date Created')
            backup_tree.heading('Size', text='Size')
            backup_tree.heading('Actions', text='Actions')
            
            backup_tree.column('Filename', width=300)
            backup_tree.column('Date', width=200)
            backup_tree.column('Size', width=100)
            backup_tree.column('Actions', width=150)
            
            # Add backups to tree (limit to 10 most recent)
            for backup in backups[:10]:
                backup_tree.insert('', tk.END, values=(
                    backup['name'],
                    backup['date'].strftime('%Y-%m-%d %H:%M:%S'),
                    f"{backup['size'] / 1024:.2f} KB",
                    'Double-click to restore'
                ))
            
            # Double-click to restore
            def on_double_click(event):
                selection = backup_tree.selection()
                if selection:
                    item = backup_tree.item(selection[0])
                    filename = item['values'][0]
                    # Find the backup path
                    for backup in backups:
                        if backup['name'] == filename:
                            self.restore_specific_backup(backup['path'])
                            break
            
            backup_tree.bind('<Double-Button-1>', on_double_click)
            
        except Exception as e:
            tk.Label(parent, text=f"Error loading backups: {str(e)}", 
                    font=('Segoe UI', 11), bg='white', fg='#e74c3c').pack(pady=20)
    
    def restore_specific_backup(self, backup_path):
        """Restore from a specific backup file"""
        try:
            import shutil
            import os
            from datetime import datetime
            
            confirm = messagebox.askyesno("Confirm Restore", 
                                         f"⚠️ WARNING: This will replace ALL current data!\n\n"
                                         f"Restore from:\n{os.path.basename(backup_path)}\n\n"
                                         f"Are you sure?")
            
            if not confirm:
                return
            
            db_path = os.path.join(os.path.dirname(__file__), 'database', 'school.db')
            safety_backup = os.path.join(os.path.dirname(__file__), 'database_backups', 
                                        f'auto_backup_before_restore_{datetime.now().strftime("%Y%m%d_%H%M%S")}.db')
            
            # Close connection
            self.conn.close()
            
            # Create safety backup
            shutil.copy2(db_path, safety_backup)
            
            # Restore
            shutil.copy2(backup_path, db_path)
            
            # Reconnect
            self.conn = sqlite3.connect(db_path)
            self.cursor = self.conn.cursor()
            
            # Log
            self.cursor.execute('''
                INSERT INTO logs (action, user, timestamp, details)
                VALUES (?, ?, ?, ?)
            ''', ('DATABASE_RESTORE', self.current_user.get('username', 'System'), 
                  datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                  f'Database restored from: {os.path.basename(backup_path)}'))
            self.conn.commit()
            
            messagebox.showinfo("Restore Successful", 
                              f"Database restored successfully!\n\n"
                              f"Please restart the application.")
            
        except Exception as e:
            messagebox.showerror("Restore Failed", f"Failed to restore:\n{str(e)}")
    
    def show_ai_insights(self):
        """Show AI-powered insights and predictions dashboard"""
        if not AI_AVAILABLE:
            messagebox.showwarning("AI Not Available", 
                                  "AI features require scikit-learn and pandas.\n\n"
                                  "Install with: pip install scikit-learn pandas")
            return
        
        self.clear_content_frame()
        
        # Create scrollable main container
        scrollable_frame = ScrollableFrame(self.content_frame, bg='#f8f9fa')
        scrollable_frame.pack(fill='both', expand=True)
        main_frame = scrollable_frame.scrollable_frame
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#2c3e50', height=120)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        header_content = tk.Frame(header_frame, bg='#2c3e50')
        header_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        title_row = tk.Frame(header_content, bg='#2c3e50')
        title_row.pack(fill=tk.X)
        
        tk.Label(title_row, text="🤖 AI Insights & Predictions", 
                font=('Segoe UI', 24, 'bold'), fg='white', bg='#2c3e50').pack(side=tk.LEFT)
        
        tk.Button(title_row, text="🔄 Refresh", 
                 command=self.show_ai_insights,
                 font=('Segoe UI', 10, 'bold'), bg='#3498db', fg='white',
                 relief='flat', bd=0, padx=15, pady=8, cursor='hand2').pack(side=tk.RIGHT)
        
        tk.Label(header_content, text="Machine Learning powered recommendations and risk analysis", 
                font=('Segoe UI', 12), fg='#bdc3c7', bg='#2c3e50').pack(anchor='w', pady=(5, 0))
        
        # Content area
        content_area = tk.Frame(main_frame, bg='#f8f9fa')
        content_area.pack(fill=tk.BOTH, expand=True, padx=40, pady=30)
        
        # AI Status Card
        status_card = tk.Frame(content_area, bg='#e8f5e9', relief=tk.RAISED, bd=2)
        status_card.pack(fill=tk.X, pady=(0, 20))
        
        status_content = tk.Frame(status_card, bg='#e8f5e9')
        status_content.pack(fill=tk.X, padx=20, pady=15)
        
        tk.Label(status_content, text="✅ AI System Active", 
                font=('Segoe UI', 12, 'bold'), bg='#e8f5e9', fg='#2e7d32').pack(anchor='w')
        tk.Label(status_content, text="Running offline ML models for predictive analytics", 
                font=('Segoe UI', 10), bg='#e8f5e9', fg='#555').pack(anchor='w', pady=(5, 0))
        
        # Create two columns for different prediction types
        predictions_container = tk.Frame(content_area, bg='#f8f9fa')
        predictions_container.pack(fill=tk.BOTH, expand=True)
        
        # Left column - Attendance Risk
        left_col = tk.Frame(predictions_container, bg='#f8f9fa')
        left_col.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 10))
        
        self.create_attendance_risk_section(left_col)
        
        # Right column - Fee Payment Risk
        right_col = tk.Frame(predictions_container, bg='#f8f9fa')
        right_col.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(10, 0))
        
        self.create_fee_payment_risk_section(right_col)
        
        # AI Insights Section (full width)
        insights_frame = tk.Frame(content_area, bg='#f8f9fa')
        insights_frame.pack(fill=tk.X, pady=(20, 0))
        
        self.create_ai_insights_section(insights_frame)
    
    def create_attendance_risk_section(self, parent):
        """Create attendance risk prediction section"""
        section = tk.LabelFrame(parent, text="📊 Attendance Risk Analysis", 
                               font=('Segoe UI', 13, 'bold'), bg='white', 
                               fg='#2c3e50', relief=tk.RAISED, bd=2)
        section.pack(fill=tk.BOTH, expand=True)
        
        content = tk.Frame(section, bg='white')
        content.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
        
        tk.Label(content, text="Students at risk of poor attendance", 
                font=('Segoe UI', 10), bg='white', fg='#666').pack(anchor='w', pady=(0, 10))
        
        # Get predictions
        at_risk = self.ai_predictor.predict_attendance_risk()
        
        if not at_risk:
            tk.Label(content, text="✅ No students at high attendance risk", 
                    font=('Segoe UI', 11), bg='white', fg='#27ae60').pack(pady=20)
            return
        
        # Create treeview
        tree_frame = tk.Frame(content, bg='white')
        tree_frame.pack(fill=tk.BOTH, expand=True)
        
        tree_scroll = tk.Scrollbar(tree_frame)
        tree_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        
        columns = ('Student', 'Attendance %', 'Risk', 'Days')
        tree = ttk.Treeview(tree_frame, columns=columns, show='headings', 
                           yscrollcommand=tree_scroll.set, height=8)
        tree.pack(fill=tk.BOTH, expand=True)
        tree_scroll.config(command=tree.yview)
        
        # Configure columns
        tree.heading('Student', text='Student Name')
        tree.heading('Attendance %', text='Attendance %')
        tree.heading('Risk', text='Risk Level')
        tree.heading('Days', text='Present/Total')
        
        tree.column('Student', width=200)
        tree.column('Attendance %', width=100)
        tree.column('Risk', width=80)
        tree.column('Days', width=100)
        
        # Add data
        for student in at_risk[:10]:  # Show top 10
            tree.insert('', tk.END, values=(
                student['name'],
                f"{student['attendance_rate']}%",
                student['risk_level'],
                f"{student['days_present']}/{student['total_days']}"
            ), tags=(student['risk_level'].lower(),))
        
        # Color coding
        tree.tag_configure('high', background='#ffebee')
        tree.tag_configure('medium', background='#fff3e0')
    
    def create_fee_payment_risk_section(self, parent):
        """Create fee payment risk prediction section"""
        section = tk.LabelFrame(parent, text="💳 Fee Payment Risk Analysis", 
                               font=('Segoe UI', 13, 'bold'), bg='white', 
                               fg='#2c3e50', relief=tk.RAISED, bd=2)
        section.pack(fill=tk.BOTH, expand=True)
        
        content = tk.Frame(section, bg='white')
        content.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
        
        tk.Label(content, text="Students at risk of payment default", 
                font=('Segoe UI', 10), bg='white', fg='#666').pack(anchor='w', pady=(0, 10))
        
        # Get predictions
        at_risk = self.ai_predictor.predict_fee_payment_risk()
        
        if not at_risk:
            tk.Label(content, text="✅ No students at high payment risk", 
                    font=('Segoe UI', 11), bg='white', fg='#27ae60').pack(pady=20)
            return
        
        # Create treeview
        tree_frame = tk.Frame(content, bg='white')
        tree_frame.pack(fill=tk.BOTH, expand=True)
        
        tree_scroll = tk.Scrollbar(tree_frame)
        tree_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        
        columns = ('Student', 'Arrears', 'Payment %', 'Risk')
        tree = ttk.Treeview(tree_frame, columns=columns, show='headings', 
                           yscrollcommand=tree_scroll.set, height=8)
        tree.pack(fill=tk.BOTH, expand=True)
        tree_scroll.config(command=tree.yview)
        
        # Configure columns
        tree.heading('Student', text='Student Name')
        tree.heading('Arrears', text='Total Arrears')
        tree.heading('Payment %', text='Payment Rate')
        tree.heading('Risk', text='Risk Level')
        
        tree.column('Student', width=200)
        tree.column('Arrears', width=100)
        tree.column('Payment %', width=100)
        tree.column('Risk', width=80)
        
        # Add data
        for student in at_risk[:10]:  # Show top 10
            tree.insert('', tk.END, values=(
                student['name'],
                f"GHS {student['arrears']:.2f}",
                f"{student['payment_rate']}%",
                student['risk_level']
            ), tags=(student['risk_level'].lower(),))
        
        # Color coding
        tree.tag_configure('high', background='#ffebee')
        tree.tag_configure('medium', background='#fff3e0')
    
    def create_ai_insights_section(self, parent):
        """Create AI insights and recommendations section"""
        section = tk.LabelFrame(parent, text="💡 AI Recommendations & Insights", 
                               font=('Segoe UI', 13, 'bold'), bg='white', 
                               fg='#2c3e50', relief=tk.RAISED, bd=2)
        section.pack(fill=tk.X)
        
        content = tk.Frame(section, bg='white')
        content.pack(fill=tk.X, padx=15, pady=15)
        
        # Get insights
        insights = self.ai_predictor.generate_insights()
        
        if not insights:
            tk.Label(content, text="✅ All systems running smoothly. No critical insights at this time.", 
                    font=('Segoe UI', 11), bg='white', fg='#27ae60').pack(pady=10)
            return
        
        # Display insights
        for insight in insights[:5]:  # Show top 5
            insight_frame = tk.Frame(content, bg='white', relief=tk.RAISED, bd=1)
            insight_frame.pack(fill=tk.X, pady=5)
            
            # Icon and color based on type
            colors = {
                'warning': ('#fff3e0', '#f57c00', '⚠️'),
                'info': ('#e3f2fd', '#1976d2', 'ℹ️'),
                'success': ('#e8f5e9', '#388e3c', '✅')
            }
            bg_color, text_color, icon = colors.get(insight['type'], colors['info'])
            
            insight_frame.configure(bg=bg_color)
            
            insight_content = tk.Frame(insight_frame, bg=bg_color)
            insight_content.pack(fill=tk.X, padx=15, pady=10)
            
            # Title row
            title_row = tk.Frame(insight_content, bg=bg_color)
            title_row.pack(fill=tk.X)
            
            tk.Label(title_row, text=f"{icon} {insight['title']}", 
                    font=('Segoe UI', 11, 'bold'), bg=bg_color, fg=text_color).pack(side=tk.LEFT)
            
            tk.Label(title_row, text=f"[{insight['category']}]", 
                    font=('Segoe UI', 9), bg=bg_color, fg='#666').pack(side=tk.RIGHT)
            
            # Message
            tk.Label(insight_content, text=insight['message'], 
                    font=('Segoe UI', 10), bg=bg_color, fg='#333',
                    wraplength=800, justify=tk.LEFT).pack(anchor='w', pady=(5, 0))
    
    def show_ai_report_assistant(self):
        """Show AI-powered report generation assistant for teachers"""
        if not AI_AVAILABLE:
            messagebox.showwarning("AI Not Available", 
                                  "AI features require scikit-learn and pandas.\n\n"
                                  "Install with: pip install scikit-learn pandas")
            return
        
        self.clear_content_frame()
        
        # Create scrollable main container
        scrollable_frame = ScrollableFrame(self.content_frame, bg='#f8f9fa')
        scrollable_frame.pack(fill='both', expand=True)
        main_frame = scrollable_frame.scrollable_frame
        
        # Header
        header_frame = tk.Frame(main_frame, bg='#2c3e50', height=120)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        header_content = tk.Frame(header_frame, bg='#2c3e50')
        header_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        tk.Label(header_content, text="📝 AI Report Assistant", 
                font=('Segoe UI', 24, 'bold'), fg='white', bg='#2c3e50').pack(anchor='w')
        tk.Label(header_content, text="Generate comprehensive reports with AI-powered insights and recommendations", 
                font=('Segoe UI', 12), fg='#bdc3c7', bg='#2c3e50').pack(anchor='w', pady=(5, 0))
        
        # Content area
        content_area = tk.Frame(main_frame, bg='#f8f9fa')
        content_area.pack(fill=tk.BOTH, expand=True, padx=40, pady=30)
        
        # Report type selection
        selection_frame = tk.LabelFrame(content_area, text="Select Report Type", 
                                       font=('Segoe UI', 14, 'bold'), bg='white', 
                                       fg='#2c3e50', relief=tk.RAISED, bd=2)
        selection_frame.pack(fill=tk.X, pady=(0, 20))
        
        selection_content = tk.Frame(selection_frame, bg='white')
        selection_content.pack(fill=tk.X, padx=20, pady=20)
        
        # Report buttons
        buttons_frame = tk.Frame(selection_content, bg='white')
        buttons_frame.pack(fill=tk.X)
        
        tk.Button(buttons_frame, text="📊 Class Performance Report", 
                 command=self.generate_class_report_ui,
                 font=('Segoe UI', 12, 'bold'), bg='#3498db', fg='white',
                 relief='flat', bd=0, padx=25, pady=15, cursor='hand2').pack(side=tk.LEFT, padx=(0, 10))
        
        tk.Button(buttons_frame, text="👤 Individual Student Report", 
                 command=self.generate_student_report_ui,
                 font=('Segoe UI', 12, 'bold'), bg='#9b59b6', fg='white',
                 relief='flat', bd=0, padx=25, pady=15, cursor='hand2').pack(side=tk.LEFT, padx=(0, 10))
        
        tk.Button(buttons_frame, text="📈 Progress Summary", 
                 command=self.generate_progress_summary_ui,
                 font=('Segoe UI', 12, 'bold'), bg='#e74c3c', fg='white',
                 relief='flat', bd=0, padx=25, pady=15, cursor='hand2').pack(side=tk.LEFT)
        
        # Quick stats
        stats_frame = tk.LabelFrame(content_area, text="Quick Statistics", 
                                    font=('Segoe UI', 14, 'bold'), bg='white', 
                                    fg='#2c3e50', relief=tk.RAISED, bd=2)
        stats_frame.pack(fill=tk.X, pady=(0, 20))
        
        stats_content = tk.Frame(stats_frame, bg='white')
        stats_content.pack(fill=tk.X, padx=20, pady=20)
        
        # Get teacher's class
        if self.current_user.get('role') == 'teacher':
            teacher_class_id = self.get_teacher_assigned_class()
            if teacher_class_id:
                self.display_teacher_class_stats(stats_content, teacher_class_id)
            else:
                tk.Label(stats_content, text="You are not assigned to any class yet.", 
                        font=('Segoe UI', 11), bg='white', fg='#999').pack(pady=10)
        else:
            tk.Label(stats_content, text="Select a class to view statistics", 
                    font=('Segoe UI', 11), bg='white', fg='#999').pack(pady=10)
        
        # Recent reports (placeholder)
        recent_frame = tk.LabelFrame(content_area, text="Report Features", 
                                     font=('Segoe UI', 14, 'bold'), bg='white', 
                                     fg='#2c3e50', relief=tk.RAISED, bd=2)
        recent_frame.pack(fill=tk.BOTH, expand=True)
        
        recent_content = tk.Frame(recent_frame, bg='white')
        recent_content.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        features = [
            "✅ AI-powered student performance analysis",
            "✅ Attendance pattern recognition",
            "✅ Fee payment tracking and predictions",
            "✅ Personalized recommendations for each student",
            "✅ Class-wide insights and trends",
            "✅ Exportable reports in PDF format"
        ]
        
        for feature in features:
            tk.Label(recent_content, text=feature, 
                    font=('Segoe UI', 11), bg='white', fg='#2c3e50',
                    anchor='w').pack(fill=tk.X, pady=3)
    
    def display_teacher_class_stats(self, parent, class_id):
        """Display quick statistics for teacher's class"""
        try:
            # Get class name
            self.cursor.execute("SELECT class_name FROM classes WHERE id = ?", (class_id,))
            result = self.cursor.fetchone()
            class_name = result[0] if result else "Unknown"
            
            tk.Label(parent, text=f"Your Class: {class_name}", 
                    font=('Segoe UI', 13, 'bold'), bg='white', fg='#2c3e50').pack(anchor='w', pady=(0, 10))
            
            # Stats grid
            stats_grid = tk.Frame(parent, bg='white')
            stats_grid.pack(fill=tk.X)
            
            # Total students
            self.cursor.execute("""
                SELECT COUNT(*) FROM students WHERE class_id = ? AND status = 'Active'
            """, (class_id,))
            total_students = self.cursor.fetchone()[0] or 0
            
            # Average attendance
            self.cursor.execute("""
                SELECT AVG(CASE WHEN present = 1 THEN 100.0 ELSE 0.0 END)
                FROM attendance a
                JOIN students s ON a.student_id = s.id
                WHERE s.class_id = ? AND a.date >= date('now', '-30 days')
            """, (class_id,))
            avg_attendance = self.cursor.fetchone()[0] or 0
            
            # Total arrears
            self.cursor.execute("""
                SELECT SUM(arrears)
                FROM fees f
                JOIN students s ON f.student_id = s.id
                WHERE s.class_id = ?
            """, (class_id,))
            total_arrears = self.cursor.fetchone()[0] or 0
            
            # Create stat cards
            stats_data = [
                ("👥 Total Students", str(total_students), "#3498db"),
                ("📊 Avg Attendance", f"{avg_attendance:.1f}%", "#27ae60"),
                ("💳 Total Arrears", f"GHS {total_arrears:.2f}", "#e74c3c")
            ]
            
            for title, value, color in stats_data:
                card = tk.Frame(stats_grid, bg=color, relief=tk.RAISED, bd=2)
                card.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=5)
                
                tk.Label(card, text=title, font=('Segoe UI', 10), 
                        bg=color, fg='white').pack(pady=(10, 5))
                tk.Label(card, text=value, font=('Segoe UI', 16, 'bold'), 
                        bg=color, fg='white').pack(pady=(0, 10))
        
        except Exception as e:
            print(f"Stats display error: {e}")
    
    def show_comprehensive_reporting_analytics(self):
        """Show comprehensive reporting analytics dashboard"""
        if not AI_AVAILABLE:
            messagebox.showwarning("AI Not Available", 
                                  "AI features require scikit-learn and pandas.\n\n"
                                  "Install with: pip install scikit-learn pandas")
            return
        
        self.clear_content_frame()
        
        # Create scrollable container
        scrollable = ScrollableFrame(self.content_frame, bg='#f8f9fa')
        scrollable.pack(fill='both', expand=True)
        main = scrollable.scrollable_frame
        
        # Header
        header = tk.Frame(main, bg='#1a5490', height=100)
        header.pack(fill=tk.X, padx=0, pady=0)
        header.pack_propagate(False)
        
        header_content = tk.Frame(header, bg='#1a5490')
        header_content.pack(fill=tk.BOTH, expand=True, padx=30, pady=15)
        
        tk.Label(header_content, text="📊 Comprehensive Reporting Analytics", 
                font=('Segoe UI', 22, 'bold'), fg='white', bg='#1a5490').pack(anchor='w')
        tk.Label(header_content, text="Advanced analytics, predictions, and data-driven insights",
                font=('Segoe UI', 11), fg='#b8d4f1', bg='#1a5490').pack(anchor='w', pady=(3, 0))
        
        # Content
        content = tk.Frame(main, bg='#f8f9fa')
        content.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        # Section 1: Student Performance Analytics
        perf_frame = tk.LabelFrame(content, text="📈 Student Performance Analytics", 
                                   font=('Segoe UI', 12, 'bold'), bg='white', 
                                   fg='#2c3e50', relief=tk.RAISED, bd=1)
        perf_frame.pack(fill=tk.X, pady=(0, 15))
        
        perf_content = tk.Frame(perf_frame, bg='white')
        perf_content.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
        
        perf_stats = [
            ('👤 Total Students', str(self._get_total_students()), '#3498db'),
            ('✓ Active Students', str(self._get_active_students()), '#27ae60'),
            ('⚠️ At-Risk Students', str(self._get_at_risk_students()), '#f39c12'),
            ('❌ Inactive Students', str(self._get_inactive_students()), '#e74c3c')
        ]
        
        for label, value, color in perf_stats:
            stat_card = tk.Frame(perf_content, bg=color, relief=tk.RAISED, bd=0)
            stat_card.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=5)
            
            tk.Label(stat_card, text=label, font=('Segoe UI', 10), 
                    bg=color, fg='white').pack(pady=(8, 3))
            tk.Label(stat_card, text=value, font=('Segoe UI', 18, 'bold'), 
                    bg=color, fg='white').pack(pady=(0, 8))
        
        # Section 2: Attendance Analytics
        att_frame = tk.LabelFrame(content, text="📅 Attendance Analytics", 
                                  font=('Segoe UI', 12, 'bold'), bg='white', 
                                  fg='#2c3e50', relief=tk.RAISED, bd=1)
        att_frame.pack(fill=tk.X, pady=(0, 15))
        
        att_content = tk.Frame(att_frame, bg='white')
        att_content.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
        
        avg_attendance = self._calculate_average_attendance()
        
        att_stats = [
            ('📊 Average Attendance Rate', f"{avg_attendance:.1f}%", '#16a085'),
            ('✓ Present Today', str(self._get_present_today()), '#27ae60'),
            ('❌ Absent Today', str(self._get_absent_today()), '#e74c3c'),
            ('❓ Unrecorded', str(self._get_unrecorded_today()), '#95a5a6')
        ]
        
        for label, value, color in att_stats:
            stat_card = tk.Frame(att_content, bg=color, relief=tk.RAISED, bd=0)
            stat_card.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=5)
            
            tk.Label(stat_card, text=label, font=('Segoe UI', 10), 
                    bg=color, fg='white').pack(pady=(8, 3))
            tk.Label(stat_card, text=value, font=('Segoe UI', 18, 'bold'), 
                    bg=color, fg='white').pack(pady=(0, 8))
        
        # Section 3: Financial Analytics
        fin_frame = tk.LabelFrame(content, text="💰 Financial Analytics", 
                                  font=('Segoe UI', 12, 'bold'), bg='white', 
                                  fg='#2c3e50', relief=tk.RAISED, bd=1)
        fin_frame.pack(fill=tk.X, pady=(0, 15))
        
        fin_content = tk.Frame(fin_frame, bg='white')
        fin_content.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
        
        total_fees = self._calculate_total_fees()
        collected_fees = self._calculate_collected_fees()
        outstanding_fees = total_fees - collected_fees
        collection_rate = (collected_fees / total_fees * 100) if total_fees > 0 else 0
        
        fin_stats = [
            ('💳 Total Fees Due', f"₦{total_fees:,.2f}", '#8e44ad'),
            ('✓ Collected', f"₦{collected_fees:,.2f}", '#27ae60'),
            ('⏳ Outstanding', f"₦{outstanding_fees:,.2f}", '#e74c3c'),
            ('📊 Collection Rate', f"{collection_rate:.1f}%", '#3498db')
        ]
        
        for label, value, color in fin_stats:
            stat_card = tk.Frame(fin_content, bg=color, relief=tk.RAISED, bd=0)
            stat_card.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=5)
            
            tk.Label(stat_card, text=label, font=('Segoe UI', 10), 
                    bg=color, fg='white').pack(pady=(8, 3))
            tk.Label(stat_card, text=value, font=('Segoe UI', 14, 'bold'), 
                    bg=color, fg='white').pack(pady=(0, 8))
        
        # Section 4: Insights and Recommendations
        insights_frame = tk.LabelFrame(content, text="💡 System Insights & Recommendations",
                                      font=('Segoe UI', 12, 'bold'), bg='white',
                                      fg='#2c3e50', relief=tk.RAISED, bd=1)
        insights_frame.pack(fill=tk.BOTH, expand=True)
        
        insights_content = tk.Frame(insights_frame, bg='white')
        insights_content.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)
        
        insights_text = tk.Text(insights_content, height=10, width=80,
                               font=('Segoe UI', 10), bg='#f8f9fa',
                               relief=tk.SOLID, bd=1, wrap=tk.WORD)
        insights_text.pack(fill=tk.BOTH, expand=True)
        
        # Generate insights
        insights = self._generate_system_insights(avg_attendance, collection_rate)
        insights_text.insert('1.0', insights)
        insights_text.config(state=tk.DISABLED)
    
    def _get_total_students(self):
        """Get total number of students"""
        try:
            self.cursor.execute("SELECT COUNT(*) FROM students")
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except:
            return 0
    
    def _get_active_students(self):
        """Get number of active students"""
        try:
            self.cursor.execute("SELECT COUNT(*) FROM students WHERE status='Active'")
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except:
            return 0
    
    def _get_inactive_students(self):
        """Get number of inactive students"""
        try:
            self.cursor.execute("SELECT COUNT(*) FROM students WHERE status='Inactive'")
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except:
            return 0
    
    def _get_at_risk_students(self):
        """Get number of at-risk students (low attendance or fee arrears)"""
        try:
            self.cursor.execute("""
                SELECT COUNT(*) FROM students s
                WHERE s.id IN (
                    SELECT DISTINCT student_id FROM attendance 
                    WHERE CAST(status AS TEXT) NOT IN ('Present')
                    GROUP BY student_id HAVING COUNT(*) > 5
                )
            """)
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except:
            return 0
    
    def _calculate_average_attendance(self):
        """Calculate average attendance rate across all students"""
        try:
            self.cursor.execute("""
                SELECT 
                    COUNT(CASE WHEN CAST(status AS TEXT)='Present' THEN 1 END) * 100.0 / 
                    NULLIF(COUNT(*), 0) as attendance_rate
                FROM attendance
            """)
            result = self.cursor.fetchone()
            return result[0] if result and result[0] else 0
        except:
            return 0
    
    def _get_present_today(self):
        """Get number of students present today"""
        try:
            today = date.today().strftime('%Y-%m-%d')
            self.cursor.execute("""
                SELECT COUNT(*) FROM attendance 
                WHERE date=? AND CAST(status AS TEXT)='Present'
            """, (today,))
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except:
            return 0
    
    def _get_absent_today(self):
        """Get number of students absent today"""
        try:
            today = date.today().strftime('%Y-%m-%d')
            self.cursor.execute("""
                SELECT COUNT(*) FROM attendance 
                WHERE date=? AND CAST(status AS TEXT)='Absent'
            """, (today,))
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except:
            return 0
    
    def _get_unrecorded_today(self):
        """Get number of students without attendance record today"""
        try:
            today = date.today().strftime('%Y-%m-%d')
            self.cursor.execute("""
                SELECT COUNT(*) FROM students s
                WHERE s.status='Active'
                AND s.id NOT IN (
                    SELECT DISTINCT student_id FROM attendance WHERE date=?
                )
            """, (today,))
            result = self.cursor.fetchone()
            return result[0] if result else 0
        except:
            return 0
    
    def _calculate_total_fees(self):
        """Calculate total fees owed by all students"""
        try:
            self.cursor.execute("SELECT SUM(monthly_fee) FROM students")
            result = self.cursor.fetchone()
            return result[0] if result[0] else 0
        except:
            return 0
    
    def _calculate_collected_fees(self):
        """Calculate total fees collected"""
        try:
            self.cursor.execute("SELECT SUM(amount_paid) FROM fee_payments WHERE status='Completed'")
            result = self.cursor.fetchone()
            return result[0] if result[0] else 0
        except:
            return 0
    
    def _generate_system_insights(self, attendance_rate, collection_rate):
        """Generate actionable system insights"""
        insights = """
📊 SYSTEM INSIGHTS & RECOMMENDATIONS
{'='*60}

"""
        insights += f"📈 Attendance Performance: {attendance_rate:.1f}%\n"
        if attendance_rate >= 90:
            insights += "   ✓ Excellent! Maintain current attendance standards.\n\n"
        elif attendance_rate >= 75:
            insights += "   → Good. Consider strategies to improve attendance.\n\n"
        else:
            insights += "   ⚠ Low attendance rate. Urgent intervention needed.\n\n"
        
        insights += f"💳 Fee Collection Rate: {collection_rate:.1f}%\n"
        if collection_rate >= 85:
            insights += "   ✓ Excellent! Strong financial position.\n\n"
        elif collection_rate >= 70:
            insights += "   → Acceptable. Follow up on outstanding payments.\n\n"
        else:
            insights += "   ⚠ Low collection rate. Implement payment collection strategy.\n\n"
        
        insights += """📋 RECOMMENDED ACTIONS:
   1. Review low-attendance students and contact parents
   2. Monitor at-risk students for academic support
   3. Send payment reminders for outstanding fees
   4. Schedule parent-teacher meetings for failing students
   5. Plan intervention programs for struggling classes

For more detailed analysis, use individual report generators.
"""
        return insights
    
    def generate_class_report_ui(self):
        """Generate and display class performance report"""
        if not AI_AVAILABLE or not self.ai_predictor:
            messagebox.showwarning("AI Not Available", "AI features are not available")
            return
        
        # Get class ID
        class_id = None
        if self.current_user.get('role') == 'teacher':
            class_id = self.get_teacher_assigned_class()
            if not class_id:
                # Show helpful message with teacher assignment info
                response = messagebox.askokcancel(
                    "No Class Assigned", 
                    f"Teacher '{self.current_user.get('full_name')}' is not assigned to any class.\n\n"
                    "Please contact an administrator to:\n"
                    "1. Create a teacher record with your name\n"
                    "2. Assign you to a class in Teachers tab\n\n"
                    "Would you like to view all classes anyway?"
                )
                if response:
                    # Let teacher select a class to view
                    class_id = self.select_class_dialog()
                    if not class_id:
                        return
                else:
                    return
        else:
            # Admin: let them select a class
            class_id = self.select_class_dialog()
            if not class_id:
                return
        
        # Generate report
        report = self.ai_predictor.generate_class_report(class_id)
        
        if not report:
            messagebox.showerror("Error", "Failed to generate report")
            return
        
        # Display report in new window
        self.display_class_report_window(report)
    
    def generate_student_report_ui(self):
        """Generate and display individual student report"""
        if not AI_AVAILABLE or not self.ai_predictor:
            messagebox.showwarning("AI Not Available", "AI features are not available")
            return
        
        # Select student
        student_id = self.select_student_dialog()
        if not student_id:
            return
        
        # Generate report
        report = self.ai_predictor.generate_student_report(student_id)
        
        if not report:
            messagebox.showerror("Error", "Failed to generate report")
            return
        
        # Display report
        self.display_student_report_window(report)
    
    def generate_progress_summary_ui(self):
        """Generate progress summary report"""
        messagebox.showinfo("Coming Soon", 
                          "Progress Summary Report\n\n"
                          "This feature will provide:\n"
                          "• Term-by-term comparisons\n"
                          "• Individual student growth tracking\n"
                          "• Class-wide progress trends\n\n"
                          "Available in next update!")
    
    def select_class_dialog(self):
        """Dialog to select a class"""
        dialog = tk.Toplevel(self.root)
        dialog.title("Select Class")
        dialog.geometry("400x300")
        dialog.transient(self.root)
        dialog.grab_set()
        
        selected_class = [None]
        
        tk.Label(dialog, text="Select a class for the report:", 
                font=('Segoe UI', 12, 'bold')).pack(pady=20)
        
        # Get classes
        self.cursor.execute("SELECT id, class_name FROM classes ORDER BY class_name")
        classes = self.cursor.fetchall()
        
        listbox = tk.Listbox(dialog, font=('Segoe UI', 11), height=10)
        listbox.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 20))
        
        for class_id, class_name in classes:
            listbox.insert(tk.END, class_name)
        
        def on_select():
            selection = listbox.curselection()
            if selection:
                selected_class[0] = classes[selection[0]][0]
                dialog.destroy()
        
        tk.Button(dialog, text="Select", command=on_select,
                 font=('Segoe UI', 11, 'bold'), bg='#3498db', fg='white',
                 padx=20, pady=10).pack()
        
        dialog.wait_window()
        return selected_class[0]
    
    def select_student_dialog(self):
        """Dialog to select a student"""
        dialog = tk.Toplevel(self.root)
        dialog.title("Select Student")
        dialog.geometry("500x400")
        dialog.transient(self.root)
        dialog.grab_set()
        
        selected_student = [None]
        
        tk.Label(dialog, text="Select a student for the report:", 
                font=('Segoe UI', 12, 'bold')).pack(pady=20)
        
        # Search box
        search_frame = tk.Frame(dialog)
        search_frame.pack(fill=tk.X, padx=20, pady=(0, 10))
        
        search_var = tk.StringVar()
        search_entry = AutocompleteEntry(search_frame, textvariable=search_var, font=('Segoe UI', 11),
                                        suggestions_callback=self.get_student_suggestions)
        search_entry.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        # Get students (filter by teacher's class if applicable)
        if self.current_user.get('role') == 'teacher':
            teacher_class_id = self.get_teacher_assigned_class()
            if teacher_class_id:
                self.cursor.execute("""
                    SELECT s.id, s.name, s.student_id, c.class_name
                    FROM students s
                    LEFT JOIN classes c ON s.class_id = c.id
                    WHERE s.status = 'Active' AND s.class_id = ?
                    ORDER BY s.name
                """, (teacher_class_id,))
            else:
                self.cursor.execute("SELECT id, name, student_id, '' FROM students WHERE 1=0")
        else:
            self.cursor.execute("""
                SELECT s.id, s.name, s.student_id, c.class_name
                FROM students s
                LEFT JOIN classes c ON s.class_id = c.id
                WHERE s.status = 'Active'
                ORDER BY s.name
            """)
        
        students = self.cursor.fetchall()
        
        # Listbox
        listbox = tk.Listbox(dialog, font=('Segoe UI', 11), height=12)
        listbox.pack(fill=tk.BOTH, expand=True, padx=20, pady=(0, 20))
        
        def update_list(search_term=""):
            listbox.delete(0, tk.END)
            for student_id, name, student_num, class_name in students:
                if search_term.lower() in name.lower() or search_term in (student_num or ""):
                    display = f"{name} ({student_num}) - {class_name or 'No Class'}"
                    listbox.insert(tk.END, display)
        
        update_list()
        search_var.trace('w', lambda *args: update_list(search_var.get()))
        
        def on_select():
            selection = listbox.curselection()
            if selection:
                # Find the corresponding student ID
                selected_text = listbox.get(selection[0])
                for student_id, name, student_num, class_name in students:
                    if f"{name} ({student_num})" in selected_text:
                        selected_student[0] = student_id
                        break
                dialog.destroy()
        
        tk.Button(dialog, text="Select", command=on_select,
                 font=('Segoe UI', 11, 'bold'), bg='#3498db', fg='white',
                 padx=20, pady=10).pack()
        
        dialog.wait_window()
        return selected_student[0]
    
    def display_class_report_window(self, report):
        """Display class report in a new window"""
        window = tk.Toplevel(self.root)
        window.title(f"Class Report - {report['class_info']['name']}")
        window.geometry("900x700")
        window.transient(self.root)
        
        # Scrollable frame
        scroll_frame = ScrollableFrame(window, bg='white')
        scroll_frame.pack(fill=tk.BOTH, expand=True)
        content = scroll_frame.scrollable_frame
        
        # Header
        header = tk.Frame(content, bg='#2c3e50')
        header.pack(fill=tk.X, pady=(0, 20))
        
        tk.Label(header, text=f"📊 Class Report: {report['class_info']['name']}", 
                font=('Segoe UI', 20, 'bold'), bg='#2c3e50', fg='white').pack(pady=20)
        
        # Class info section
        info_frame = tk.LabelFrame(content, text="Class Information", 
                                  font=('Segoe UI', 13, 'bold'), bg='white')
        info_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        info_content = tk.Frame(info_frame, bg='white')
        info_content.pack(fill=tk.X, padx=15, pady=15)
        
        info_text = f"""
Teacher: {report['class_info']['teacher']}
Students: {report['class_info']['student_count']} / {report['class_info']['capacity']}
"""
        tk.Label(info_content, text=info_text, font=('Segoe UI', 11), 
                bg='white', justify=tk.LEFT).pack(anchor='w')
        
        # Attendance summary
        if 'attendance_summary' in report:
            att_frame = tk.LabelFrame(content, text="Attendance Summary (Last 30 Days)", 
                                     font=('Segoe UI', 13, 'bold'), bg='white')
            att_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            att_content = tk.Frame(att_frame, bg='white')
            att_content.pack(fill=tk.X, padx=15, pady=15)
            
            att = report['attendance_summary']
            att_text = f"""
Average Attendance Rate: {att['average_rate']}%
Students Tracked: {att['students_tracked']}
Total Present: {att['total_present']} / {att['total_records']}
"""
            tk.Label(att_content, text=att_text, font=('Segoe UI', 11), 
                    bg='white', justify=tk.LEFT).pack(anchor='w')
        
        # Fee summary
        if 'fee_summary' in report:
            fee_frame = tk.LabelFrame(content, text="Fee Collection Summary", 
                                     font=('Segoe UI', 13, 'bold'), bg='white')
            fee_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            fee_content = tk.Frame(fee_frame, bg='white')
            fee_content.pack(fill=tk.X, padx=15, pady=15)
            
            fee = report['fee_summary']
            fee_text = f"""
Total Due: GHS {fee['total_due']:.2f}
Total Paid: GHS {fee['total_paid']:.2f}
Total Arrears: GHS {fee['total_arrears']:.2f}
Collection Rate: {fee['collection_rate']}%
"""
            tk.Label(fee_content, text=fee_text, font=('Segoe UI', 11), 
                    bg='white', justify=tk.LEFT).pack(anchor='w')
        
        # AI Recommendations
        if report['recommendations']:
            rec_frame = tk.LabelFrame(content, text="🤖 AI Recommendations", 
                                     font=('Segoe UI', 13, 'bold'), bg='white')
            rec_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            rec_content = tk.Frame(rec_frame, bg='white')
            rec_content.pack(fill=tk.X, padx=15, pady=15)
            
            for rec in report['recommendations']:
                rec_card = tk.Frame(rec_content, bg='#f8f9fa', relief=tk.RAISED, bd=1)
                rec_card.pack(fill=tk.X, pady=5)
                
                rec_inner = tk.Frame(rec_card, bg='#f8f9fa')
                rec_inner.pack(fill=tk.X, padx=10, pady=10)
                
                priority_colors = {'High': '#e74c3c', 'Medium': '#f39c12', 'Low': '#95a5a6'}
                color = priority_colors.get(rec['priority'], '#95a5a6')
                
                tk.Label(rec_inner, text=f"[{rec['priority']}] {rec['category']}", 
                        font=('Segoe UI', 10, 'bold'), bg='#f8f9fa', fg=color).pack(anchor='w')
                tk.Label(rec_inner, text=f"Issue: {rec['issue']}", 
                        font=('Segoe UI', 10), bg='#f8f9fa').pack(anchor='w', pady=(3, 0))
                tk.Label(rec_inner, text=f"Recommendation: {rec['recommendation']}", 
                        font=('Segoe UI', 10), bg='#f8f9fa', wraplength=800).pack(anchor='w', pady=(3, 0))
        
        # Export button
        btn_frame = tk.Frame(content, bg='white')
        btn_frame.pack(fill=tk.X, padx=20, pady=20)
        
        tk.Button(btn_frame, text="📊 Export to PDF", 
                 command=lambda: self.export_report_to_pdf(report, 'class'),
                 font=('Segoe UI', 11, 'bold'), bg='#27ae60', fg='white',
                 padx=20, pady=10).pack(side=tk.LEFT)
        
        tk.Button(btn_frame, text="Close", 
                 command=window.destroy,
                 font=('Segoe UI', 11, 'bold'), bg='#95a5a6', fg='white',
                 padx=20, pady=10).pack(side=tk.RIGHT)
    
    def display_student_report_window(self, report):
        """Display student report in a new window"""
        window = tk.Toplevel(self.root)
        window.title(f"Student Report - {report['student_info']['name']}")
        window.geometry("800x600")
        window.transient(self.root)
        
        # Scrollable frame
        scroll_frame = ScrollableFrame(window, bg='white')
        scroll_frame.pack(fill=tk.BOTH, expand=True)
        content = scroll_frame.scrollable_frame
        
        # Header
        header = tk.Frame(content, bg='#9b59b6')
        header.pack(fill=tk.X, pady=(0, 20))
        
        tk.Label(header, text=f"👤 Student Report: {report['student_info']['name']}", 
                font=('Segoe UI', 18, 'bold'), bg='#9b59b6', fg='white').pack(pady=20)
        
        # Student info
        info_frame = tk.LabelFrame(content, text="Student Information", 
                                  font=('Segoe UI', 13, 'bold'), bg='white')
        info_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        info_content = tk.Frame(info_frame, bg='white')
        info_content.pack(fill=tk.X, padx=15, pady=15)
        
        info = report['student_info']
        info_text = f"""
Student ID: {info['student_id']}
Class: {info['class']}
Gender: {info['gender']}
Date of Birth: {info['dob'] or 'Not provided'}
Admission Date: {info['admission_date']}
"""
        tk.Label(info_content, text=info_text, font=('Segoe UI', 11), 
                bg='white', justify=tk.LEFT).pack(anchor='w')
        
        # Attendance details
        if 'attendance_details' in report and report['attendance_details']:
            att_frame = tk.LabelFrame(content, text="Attendance Record", 
                                     font=('Segoe UI', 13, 'bold'), bg='white')
            att_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            att_content = tk.Frame(att_frame, bg='white')
            att_content.pack(fill=tk.X, padx=15, pady=15)
            
            att = report['attendance_details']
            att_text = f"""
Attendance Rate: {att['attendance_rate']}%
Days Present: {att['days_present']} / {att['total_days']}
Days Absent: {att['days_absent']}
"""
            tk.Label(att_content, text=att_text, font=('Segoe UI', 11), 
                    bg='white', justify=tk.LEFT).pack(anchor='w')
        
        # Fee details
        if 'fee_details' in report and report['fee_details']:
            fee_frame = tk.LabelFrame(content, text="Fee Payment Record", 
                                     font=('Segoe UI', 13, 'bold'), bg='white')
            fee_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            fee_content = tk.Frame(fee_frame, bg='white')
            fee_content.pack(fill=tk.X, padx=15, pady=15)
            
            fee = report['fee_details']
            fee_text = f"""
Total Due: GHS {fee['total_due']:.2f}
Total Paid: GHS {fee['total_paid']:.2f}
Outstanding Arrears: GHS {fee['total_arrears']:.2f}
"""
            tk.Label(fee_content, text=fee_text, font=('Segoe UI', 11), 
                    bg='white', justify=tk.LEFT).pack(anchor='w')
        
        # Behavior summary
        if report.get('behavior_summary'):
            behavior_frame = tk.LabelFrame(content, text="🤖 AI Behavior Summary", 
                                          font=('Segoe UI', 13, 'bold'), bg='white')
            behavior_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            behavior_content = tk.Frame(behavior_frame, bg='white')
            behavior_content.pack(fill=tk.X, padx=15, pady=15)
            
            tk.Label(behavior_content, text=report['behavior_summary'], 
                    font=('Segoe UI', 11), bg='white', wraplength=700,
                    justify=tk.LEFT).pack(anchor='w')
        
        # Recommendations
        if report['recommendations']:
            rec_frame = tk.LabelFrame(content, text="🤖 AI Recommendations", 
                                     font=('Segoe UI', 13, 'bold'), bg='white')
            rec_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            rec_content = tk.Frame(rec_frame, bg='white')
            rec_content.pack(fill=tk.X, padx=15, pady=15)
            
            for rec in report['recommendations']:
                rec_card = tk.Frame(rec_content, bg='#f8f9fa', relief=tk.RAISED, bd=1)
                rec_card.pack(fill=tk.X, pady=5)
                
                rec_inner = tk.Frame(rec_card, bg='#f8f9fa')
                rec_inner.pack(fill=tk.X, padx=10, pady=10)
                
                priority_colors = {'High': '#e74c3c', 'Medium': '#f39c12', 'Low': '#95a5a6'}
                color = priority_colors.get(rec['priority'], '#95a5a6')
                
                tk.Label(rec_inner, text=f"[{rec['priority']}] {rec['area']}", 
                        font=('Segoe UI', 10, 'bold'), bg='#f8f9fa', fg=color).pack(anchor='w')
                tk.Label(rec_inner, text=rec['recommendation'], 
                        font=('Segoe UI', 10), bg='#f8f9fa', wraplength=700).pack(anchor='w', pady=(3, 0))
        
        # Advanced Analytics Section
        student_id = report['student_info'].get('id')
        if not student_id:
            # Get student ID from database
            self.cursor.execute("SELECT id FROM students WHERE student_id = ?", 
                              (report['student_info']['student_id'],))
            result = self.cursor.fetchone()
            if result:
                student_id = result[0]
        
        if student_id:
            self.add_advanced_analytics_section(content, student_id)
        
        # Buttons
        btn_frame = tk.Frame(content, bg='white')
        btn_frame.pack(fill=tk.X, padx=20, pady=20)
        
        tk.Button(btn_frame, text="📊 Export to PDF", 
                 command=lambda: self.export_report_to_pdf(report, 'student'),
                 font=('Segoe UI', 11, 'bold'), bg='#27ae60', fg='white',
                 padx=20, pady=10).pack(side=tk.LEFT)
        
        tk.Button(btn_frame, text="🔍 View Advanced Analytics", 
                 command=lambda: self.show_advanced_analytics_window(student_id) if student_id else None,
                 font=('Segoe UI', 11, 'bold'), bg='#3498db', fg='white',
                 padx=20, pady=10).pack(side=tk.LEFT, padx=10)
        
        tk.Button(btn_frame, text="Close", 
                 command=window.destroy,
                 font=('Segoe UI', 11, 'bold'), bg='#95a5a6', fg='white',
                 padx=20, pady=10).pack(side=tk.RIGHT)
    
    def add_advanced_analytics_section(self, parent, student_id):
        """Add quick advanced analytics preview to report"""
        if not AI_AVAILABLE or not self.ai_predictor:
            return
        
        try:
            # Get risk score
            risk_score = self.ai_predictor.predict_student_risk_score(student_id)
            
            analytics_frame = tk.LabelFrame(parent, text="📁 AI Risk Assessment", 
                                           font=('Segoe UI', 13, 'bold'), bg='white')
            analytics_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
            
            analytics_content = tk.Frame(analytics_frame, bg='white')
            analytics_content.pack(fill=tk.X, padx=15, pady=15)
            
            # Risk level indicator
            risk_colors = {'High': '#e74c3c', 'Medium': '#f39c12', 'Low': '#27ae60'}
            risk_color = risk_colors.get(risk_score['risk_level'], '#95a5a6')
            
            risk_header = tk.Frame(analytics_content, bg='white')
            risk_header.pack(fill=tk.X, pady=(0, 10))
            
            tk.Label(risk_header, text=f"Risk Level: {risk_score['risk_level']}", 
                    font=('Segoe UI', 12, 'bold'), bg='white', fg=risk_color).pack(side=tk.LEFT)
            tk.Label(risk_header, text=f"Score: {risk_score['overall_score']}/100", 
                    font=('Segoe UI', 11), bg='white', fg='#666').pack(side=tk.RIGHT)
            
            # Risk factors
            if risk_score['risk_factors']:
                tk.Label(analytics_content, text="⚠️ Risk Factors:", 
                        font=('Segoe UI', 10, 'bold'), bg='white', fg='#e74c3c').pack(anchor='w')
                for factor in risk_score['risk_factors'][:3]:
                    tk.Label(analytics_content, text=f"  • {factor}", 
                            font=('Segoe UI', 10), bg='white').pack(anchor='w', padx=(10, 0))
            
            # Protective factors
            if risk_score['protective_factors']:
                tk.Label(analytics_content, text="\n✓ Strengths:", 
                        font=('Segoe UI', 10, 'bold'), bg='white', fg='#27ae60').pack(anchor='w', pady=(5, 0))
                for factor in risk_score['protective_factors'][:2]:
                    tk.Label(analytics_content, text=f"  • {factor}", 
                            font=('Segoe UI', 10), bg='white').pack(anchor='w', padx=(10, 0))
        
        except Exception as e:
            print(f"Advanced analytics section error: {e}")
    
    def show_advanced_analytics_window(self, student_id):
        """Show detailed advanced analytics for a student"""
        if not AI_AVAILABLE or not self.ai_predictor:
            messagebox.showwarning("AI Not Available", "AI features are not available")
            return
        
        # Get student name
        self.cursor.execute("SELECT name FROM students WHERE id = ?", (student_id,))
        result = self.cursor.fetchone()
        student_name = result[0] if result else "Unknown Student"
        
        window = tk.Toplevel(self.root)
        window.title(f"Advanced Analytics - {student_name}")
        window.geometry("1000x700")
        window.transient(self.root)
        
        # Scrollable frame
        scroll_frame = ScrollableFrame(window, bg='#f8f9fa')
        scroll_frame.pack(fill=tk.BOTH, expand=True)
        content = scroll_frame.scrollable_frame
        
        # Header
        header = tk.Frame(content, bg='#8e44ad')
        header.pack(fill=tk.X, pady=(0, 20))
        
        tk.Label(header, text=f"🔍 Advanced AI Analytics: {student_name}", 
                font=('Segoe UI', 20, 'bold'), bg='#8e44ad', fg='white').pack(pady=20)
        
        # Get all analytics data
        risk_score = self.ai_predictor.predict_student_risk_score(student_id)
        trends = self.ai_predictor.analyze_student_trends(student_id)
        comparison = self.ai_predictor.compare_student_to_class(student_id)
        patterns = self.ai_predictor.identify_patterns(student_id)
        
        # Risk Score Section
        risk_frame = tk.LabelFrame(content, text="📁 Comprehensive Risk Assessment", 
                                  font=('Segoe UI', 14, 'bold'), bg='white')
        risk_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        risk_content = tk.Frame(risk_frame, bg='white')
        risk_content.pack(fill=tk.X, padx=15, pady=15)
        
        # Risk gauge visual
        gauge_frame = tk.Frame(risk_content, bg='white')
        gauge_frame.pack(fill=tk.X, pady=(0, 10))
        
        risk_colors = {'High': '#e74c3c', 'Medium': '#f39c12', 'Low': '#27ae60'}
        risk_color = risk_colors.get(risk_score['risk_level'], '#95a5a6')
        
        gauge_label = tk.Frame(gauge_frame, bg=risk_color, height=40)
        gauge_label.pack(fill=tk.X)
        
        tk.Label(gauge_label, text=f"{risk_score['risk_level']} Risk - Score: {risk_score['overall_score']}/100", 
                font=('Segoe UI', 14, 'bold'), bg=risk_color, fg='white').pack(pady=8)
        
        # Risk details
        detail_frame = tk.Frame(risk_content, bg='white')
        detail_frame.pack(fill=tk.X)
        
        left_col = tk.Frame(detail_frame, bg='white')
        left_col.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 10))
        
        tk.Label(left_col, text="⚠️ Risk Factors:", 
                font=('Segoe UI', 11, 'bold'), bg='white', fg='#e74c3c').pack(anchor='w')
        if risk_score['risk_factors']:
            for factor in risk_score['risk_factors']:
                tk.Label(left_col, text=f"  • {factor}", 
                        font=('Segoe UI', 10), bg='white', wraplength=400).pack(anchor='w', padx=(10, 0), pady=2)
        else:
            tk.Label(left_col, text="  None identified", 
                    font=('Segoe UI', 10), bg='white', fg='#666').pack(anchor='w', padx=(10, 0))
        
        right_col = tk.Frame(detail_frame, bg='white')
        right_col.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)
        
        tk.Label(right_col, text="✓ Protective Factors:", 
                font=('Segoe UI', 11, 'bold'), bg='white', fg='#27ae60').pack(anchor='w')
        if risk_score['protective_factors']:
            for factor in risk_score['protective_factors']:
                tk.Label(right_col, text=f"  • {factor}", 
                        font=('Segoe UI', 10), bg='white', wraplength=400).pack(anchor='w', padx=(10, 0), pady=2)
        else:
            tk.Label(right_col, text="  None identified", 
                    font=('Segoe UI', 10), bg='white', fg='#666').pack(anchor='w', padx=(10, 0))
        
        # Recommendation
        rec_box = tk.Frame(risk_content, bg='#e3f2fd', relief=tk.RAISED, bd=1)
        rec_box.pack(fill=tk.X, pady=(10, 0))
        
        tk.Label(rec_box, text=f"💡 Recommendation: {risk_score['recommendation']}", 
                font=('Segoe UI', 10, 'bold'), bg='#e3f2fd', fg='#1976d2',
                wraplength=900, justify=tk.LEFT).pack(padx=15, pady=10)
        
        # Trends Section
        trends_frame = tk.LabelFrame(content, text="📈 Performance Trends", 
                                     font=('Segoe UI', 14, 'bold'), bg='white')
        trends_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        trends_content = tk.Frame(trends_frame, bg='white')
        trends_content.pack(fill=tk.X, padx=15, pady=15)
        
        tk.Label(trends_content, text=trends['trend_analysis'], 
                font=('Segoe UI', 11), bg='white', wraplength=900,
                justify=tk.LEFT).pack(anchor='w', pady=(0, 10))
        
        # Trend details
        trend_grid = tk.Frame(trends_content, bg='white')
        trend_grid.pack(fill=tk.X)
        
        # Attendance trend
        att_trend_frame = tk.Frame(trend_grid, bg='#f8f9fa', relief=tk.RAISED, bd=1)
        att_trend_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 5))
        
        trend_icons = {'improving': '📈', 'declining': '📉', 'stable': '➝'}
        att_icon = trend_icons.get(trends['attendance_trend'], '➝')
        
        tk.Label(att_trend_frame, text="Attendance Trend", 
                font=('Segoe UI', 10, 'bold'), bg='#f8f9fa').pack(pady=(10, 5))
        tk.Label(att_trend_frame, text=f"{att_icon} {trends['attendance_trend'].title()}", 
                font=('Segoe UI', 12), bg='#f8f9fa').pack(pady=(0, 10))
        
        # Fee trend
        fee_trend_frame = tk.Frame(trend_grid, bg='#f8f9fa', relief=tk.RAISED, bd=1)
        fee_trend_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(5, 0))
        
        fee_icon = trend_icons.get(trends['fee_trend'], '➝')
        
        tk.Label(fee_trend_frame, text="Payment Trend", 
                font=('Segoe UI', 10, 'bold'), bg='#f8f9fa').pack(pady=(10, 5))
        tk.Label(fee_trend_frame, text=f"{fee_icon} {trends['fee_trend'].title()}", 
                font=('Segoe UI', 12), bg='#f8f9fa').pack(pady=(0, 10))
        
        # Comparison Section
        comp_frame = tk.LabelFrame(content, text="📊 Class Comparison", 
                                   font=('Segoe UI', 14, 'bold'), bg='white')
        comp_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        comp_content = tk.Frame(comp_frame, bg='white')
        comp_content.pack(fill=tk.X, padx=15, pady=15)
        
        tk.Label(comp_content, text=comparison['comparison_text'], 
                font=('Segoe UI', 11, 'bold'), bg='white', 
                wraplength=900).pack(anchor='w', pady=(0, 10))
        
        comp_stats = tk.Frame(comp_content, bg='white')
        comp_stats.pack(fill=tk.X)
        
        stats_data = [
            ("Student Attendance", f"{comparison['student_attendance']}%", "#3498db"),
            ("Class Average", f"{comparison['class_avg_attendance']}%", "#95a5a6"),
            ("Class Rank", comparison['student_rank'], "#9b59b6"),
            ("Percentile", f"{comparison['percentile']}th", "#27ae60")
        ]
        
        for title, value, color in stats_data:
            stat_card = tk.Frame(comp_stats, bg=color, relief=tk.RAISED, bd=2)
            stat_card.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=3)
            
            tk.Label(stat_card, text=title, font=('Segoe UI', 9), 
                    bg=color, fg='white').pack(pady=(8, 3))
            tk.Label(stat_card, text=value, font=('Segoe UI', 14, 'bold'), 
                    bg=color, fg='white').pack(pady=(0, 8))
        
        # Patterns Section
        patterns_frame = tk.LabelFrame(content, text="🔍 Behavioral Patterns", 
                                      font=('Segoe UI', 14, 'bold'), bg='white')
        patterns_frame.pack(fill=tk.X, padx=20, pady=(0, 15))
        
        patterns_content = tk.Frame(patterns_frame, bg='white')
        patterns_content.pack(fill=tk.X, padx=15, pady=15)
        
        # Absence pattern
        if patterns['absence_pattern']:
            pattern_card = tk.Frame(patterns_content, bg='#fff3e0', relief=tk.RAISED, bd=1)
            pattern_card.pack(fill=tk.X, pady=(0, 8))
            
            tk.Label(pattern_card, text=f"✅ Absence Pattern: {patterns['absence_pattern']}", 
                    font=('Segoe UI', 10, 'bold'), bg='#fff3e0', fg='#f57c00').pack(padx=15, pady=10, anchor='w')
        
        # Payment pattern
        payment_card = tk.Frame(patterns_content, bg='#e8f5e9', relief=tk.RAISED, bd=1)
        payment_card.pack(fill=tk.X, pady=(0, 8))
        
        tk.Label(payment_card, text=f"📊 Payment Pattern: {patterns['payment_pattern']}", 
                font=('Segoe UI', 10, 'bold'), bg='#e8f5e9', fg='#388e3c').pack(padx=15, pady=10, anchor='w')
        
        # Behavioral insights
        if patterns['behavioral_insights']:
            tk.Label(patterns_content, text="💡 Key Insights:", 
                    font=('Segoe UI', 11, 'bold'), bg='white').pack(anchor='w', pady=(10, 5))
            
            for insight in patterns['behavioral_insights']:
                insight_card = tk.Frame(patterns_content, bg='#f8f9fa', relief=tk.RAISED, bd=1)
                insight_card.pack(fill=tk.X, pady=3)
                
                icon = '⚠️' if insight['type'] == 'warning' else 'ℹ️'
                tk.Label(insight_card, text=f"{icon} {insight['insight']}", 
                        font=('Segoe UI', 10), bg='#f8f9fa',
                        wraplength=900, justify=tk.LEFT).pack(padx=15, pady=8, anchor='w')
        
        # Close button
        btn_frame = tk.Frame(content, bg='white')
        btn_frame.pack(fill=tk.X, padx=20, pady=20)
        
        tk.Button(btn_frame, text="Close", 
                 command=window.destroy,
                 font=('Segoe UI', 11, 'bold'), bg='#95a5a6', fg='white',
                 padx=30, pady=10).pack(side=tk.RIGHT)
    
    def export_report_to_pdf(self, report, report_type):
        """Export report to PDF"""
        if not PDF_AVAILABLE:
            messagebox.showwarning("PDF Not Available", 
                                  "PDF export requires reportlab.\n\n"
                                  "Install with: pip install reportlab")
            return
        
        messagebox.showinfo("Export", 
                          f"PDF export feature coming soon!\n\n"
                          f"Report data has been generated and can be exported.")

def start_application():
    """Start the application with login window"""
    root = tk.Tk()
    
    # Initialize the main app but don't show it yet
    app = SchoolManagementSystem(root)
    
    # Create callback for successful login
    def on_login_success(user_info):
        """Callback when login is successful"""
        # Use the app's own on_login_success method instead
        app.on_login_success(user_info)
    
    # Start with login window
    LoginWindow(root, on_login_success)
    
    root.mainloop()

if __name__ == "__main__":
    start_application()
